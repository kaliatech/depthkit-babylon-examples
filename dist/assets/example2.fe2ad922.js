import"./main.1e029260.js";import{T as X,R as xi,a as z,_ as R,b as Vt,I as Wr,c as Zi,W as Kr,O as U,d as it,e as rt,L as ne,f as E,s as T,K as Qr,V as y,C as It,P as Te,g as qr,M as Q,h as Lt,i as Zr,j as Ge,k as rn,l as Ji,m as j,n as In,Q as q,o as H,p as sn,q as Oe,N as Xt,r as Me,t as pt,u as Jr,S as Ne,v as Nt,A as $r,w as he,x as on,y as Pn,z as Ze,B as G,D as cn,F as eo,G as Rt,U as dt,H as xn,J as At,X as $i,Y as ve,Z as Mi,$ as _i,a0 as to,a1 as P,a2 as F,a3 as gi,a4 as ut,a5 as ae,a6 as oe,a7 as w,a8 as Ee,a9 as no,aa as io,ab as Li,ac as Fi,ad as ft,ae as ro,af as er,ag as mt,ah as tr,ai as ln,aj as oo,ak as nr,al as J,am as Di,an as ao,ao as so,ap as co,aq as lo,ar as Bi,as as ir,at as En,au as Ke,av as rr,aw as uo,ax as fo,ay as jt,az as de,aA as or,aB as vi,aC as ar,aD as Pt,aE as Mn,aF as ho,aG as Ei,aH as Ft,aI as N,aJ as Yt,aK as M,aL as Ye,aM as po,aN as Wt,aO as bn,aP as An,aQ as yn,aR as mo,aS as _o,aT as go,aU as wi,aV as vo,aW as Eo,aX as sr,aY as Dt,aZ as bo,a_ as Ao,a$ as yo,b0 as Co,b1 as To,b2 as bi,b3 as So,b4 as Ro,b5 as Oo,b6 as No,b7 as Io,b8 as Po,E as xo}from"./example1.25243be9.js";var Mo="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAQAAAAEACAYAAABccqhmAAAgAElEQVR42u29yY5tWXIlZnbuiSaTbZFUkZRKrCKhElASQA0EoQABgn6hJvoXzfUP+gP9hWb6Bg00IgRoQJaKqUxmZmTEe8/v0uB2u7Fm2T7HIyIrnz88uPvt3f2a2WrMbOvf/u3PvvzP/sUf/N6//i8vf/lv/3v5H//d//Sb//Uq/5u8yf8hV/m/5Cp/L1f5hVzlG7nKJ7mKyJuIXN/hPwqXI/g++zq6rPI5u8z+WqfLre+zy7PrVv9L8brsMiGvk8XLmM/sdfHXal4e3ad6GXPdyu2ij8u/+uv/5cuf/OSLfdtEfvUr+dnf/d0X//t3H/7bf/hP//N/928h/0Yg/4VA/kogfyGQP5Wr/IFAvhbIlwK5CGQTPP+9z5uPeePJSW+yo2+s/GtN30Rnv1E+f5zxof9R/lSXv/nr//mrr3+i+5dfyX7ZZQP07Tffys//8R/l/9TtX7790T/7r/8G8pdy+/8XAvnnAvkzgfwzgfyxQP5AIL8vkJ8K5KsmMVzu1U7p5PA5AXxOAJ8TwPf7sX/51ZeXfcemqnp9w/W77/S7X/6T/vzf/7383RWCX3/z05/9i3/13/0PX//eX/2FyP8tIv+PiPy9iPy/IvIzEfm5iPxCRH4lIt/c/393//9BRD6KyKf7f488fP74/PH544dJAF9cLl98IZfLBZtuqterXr/7Dt9982v95S9+Lv+gF/3i7Spv/8lf/vnf/vGf/dF/JfKnIvLnIvLvReQ/NEngn0TklyLy6/v/34jIt00iGJOBlxAsdvv54/PH5493SQCXy9t2ueh2ueimKorrFbjq9eNH+fDtb+TXv/ol/vHyhX4Fxfbx7euPf/Lnf/PfiPyeiPyhiPxxkwB+fk8AvxzQgJcIrGTwFsiAEXH4/PH54/PHUgLY7whgu2C7bLqpQgHB2xvePn6SDx8+6G9+84384vKF/IPu8iVU9Y/+7C/+jWxffiHytYj8VER+X0T+oEEBvxqQwCMJeIngo5EI3goIwVMIPn98/vj8ESaAbbtu2ybbvl8u2ybbdtluSECA65u8ffqIDx8+6G++/VZ/efkV/sO261dQXP7wT/7kX8vl8qXIFyLylbySwe/dE0CLAr65B/9vGn0gQwRMMqgmhM/J4fPH548eAezbZd/lsm3YtssNAYiqiogAAkCvb5/k46cP8u2HD/rrb7+R/2/b9Wu9yJe//8d/9Ney6S5yEZFdRL68/38khG/uKOCnAwoYkcCoEXwkEgGDDq7CeQfyOTl8/vhd1QCum26ybZtu2yabbrKpQvXue1yvuF6v+vbpTT5+/CDffviAX1++1V9sO77WXb/66R/+4V/dgkbllQi+aBLBV/dE8LWRALwkYCWCNyMZXElkwLTMeMkga/P4/PH547ccAVwuctkvdxSw6bbdtYDbTfSZBN7e8PHTR/3u4wf55vKd/nL7DX6mu3791U9//5+/gkNFZGuSgZUQvnKowKgLWLTAQgRtEniTuEfwaELw0MJvf3LQzynud+53uG+X6y3gN9kul+2y6XVT1U27JCDAFVc8ksAn/e7jR/nN5YP+avtWfq6Xy9f7Vz/9w1dgRYngiyYhfNkkgzYBWHTg44AEMmqQUYQKOmDaiCIa8TmsfmzB+DnZDQjgcpGLbti2y3bZHjRAdRMVvb/dcYU8kcDbPQlsH/CrbddfbF98+RPZfvLFnAQeieCRDC5DMvju/vmD4JkEvjRQgKULeGggowdHkAHTYxihg89vu88I5UeGAPSOAFTlrgPopiqbKPSmCKreUoAAkCcSePukHz590m8vH+WbD9/JP335k6/+tA86KxFchv8jMvhiogE4JQm8XhfKqOAqx5qRPyeGzx8/cgSwbXcUoLJtim27C4Oi93+4v6VxQwKAvl2v+Hj9pB8+fZJvt4/yzfbF9lPdv/wJnsE2BogmyeCRED40tGFvksIXiSbgiYSRRpDNDZ6BDI6ghM+J4fPHeyKAO+zX7cb9t4tedMMNAQju5V+f1uAtBSiu1zsduMrHy5t8ePsk3376KN98sX/xE5FPAnm7/782o0DiUINXMkCXCB7/P94/e87AWUmARQWVvgMuKej9t1RLBp+Tw+ePgwngsutFFdu26WXbbl+rSvdfbnqAiuA23QcBgCugV1zl7e1NPm5v+LC96XfbJ/1W9y++fgXjA3bDYXV+MuhRwSPwL3JLMFYC+HS/LU8HYrGwIhwyNOF12SvgM4SgztdifP85MXz+KGsA2C6X7aJ6bXSAOwrY5OYIqGy3d5uq4P5GhABXuV6veLvRAf10fZMPb2/y3b7vX7+g+9v98/WOBq7GG7RNAlYy+Dgkhhb+Xxp0sE8IAC4SGAP/TbgVJK/PoJPBnAiwPKxsXfbbnRg+i3s/JAK4Q/4b9NfLtomBAqCickMBjy7BuywAUVyv8na94tMjCVzf9KNcLl/0SeA6oAEYb1i9g+FtSALb/bKL8/+t+wxXFMyswqiHoK4ToIgKqslgpg1qUC0QoYbvJZg/B/q5v4szHmPX7YEAsD0CX25OwEUVm9xag1+agKg+nxQArnKjAtDr9U0+Xd/k4/UqH7bL5YsewrcBBiMJZPRAp6TwQgWfjM9vgRbgUYGL8AvLWH2gqhesCokeUmCSwPsnhs8fP2YNYMO2XeSmAWxy2VQaXeDmDIhApf33rD4PTUCuV+DtCn27XuXT5ir8VmCJ2G5BpBM8/r/dEcJb8/0lEQMtJHA5TAlqNuLRhJChhEpSqFabH3di+G1AGj+W1/dyAR4IYJNNnuLf6+tWC9CHHiAtFhAIFLjK2/Uqn65X+SS67aK+3QeTDoy/IG2ogQ7fb/dAtz5vBgrYGqrwNtCHsVfgIvwK07OTQBURVNCBFpKCOjqCHn5L/67TgTN+fpySAC56nwSUi256kXsSuFGAVyLoUIDo8/Pz7fdoErr/v17lk162HbgHvFpIYDfoAJJfW4sGPjkU4VNAF8ZEcLmLhdc7kljdY1y1Dq9yLiI4IiRqcLujb138KIPn80ejATwRwIbtBvn1cqv+2J78/5EI5N4cJA8qIPcmwRsKAHDF9WYP6mV7VmrgLuTpxYTcMEW0LAmoQxFsuvAI8tv/a/C5fV2ZMMiKg++FCM7RDPRu8ebWY7VG6VJi+Bzk35MI2LsAckMAgwvQ0gC5DQjd3ABg2HQLAPpEAlZ1Bu7VV7MGHDFRAbo3VKsTbAY9sPWC/uvx86gBbDK3D1eEQS8pbAeSgSwmhepnJb6uBv/o/PzHLzxWA/X7TH77De5j6AGQi6o0CUGfCOD2X7cXAlCFQABtEsGLDtxuOyQB2UTQBKZe5GUPXgkUYCUAbZJRhBDeuq8xBf+bgwbehDm+BFQi2IJksOocvA8ysIMfxluVcRsY/eB3JzH8GFDAXQO48X/dcIf9jyDHptIigDsFkEe066tBSETQUYF7ElDdYEBytN4+rk9UcBPfrKaZqFHWcw3i4J8/X4ev2//bSXqAhwTay6OEIPLD2Ipt8OtAGzxkwLw9WVFRjTc/qC6H3+YK/b1oAA0KuOizHfieCLaHHiAb5NYTIC9EMEbZrVEQt1xwhVy1UfBh8PUOquMizwaap3tQXfY5B//tea/NZdfhsvbz+PURQTDSGWB87VX/7WSd4KxjUqrIgE0IUkoKGnhIvwvawpGf6eECXJ7tv4qbA7DJgwpsKthEmmYgfaAAffYF3HLxo0vwNjJ0SwRWMG4db4eh1gPNm18vQ+us/0eGmxDemu/fnM/X4evq/8342ksGHgLY5LyT/zg0wM8lcMjgGFXwqIOVFJBQw99eCvF9oZL9Mfl3QwAvIXDsBRC9R+fz8x0FPBLB0xJEpwUobrfAkARgIAF41h3wQgP6QAmX5E/7eI43IxGwwf/moIkRyWRJQIPgt9CA9b39nzt4bYUWjAlCjWDPgv8IEjgLJfzuaAsrv9VdVG4OwOXW/fdoA35qAdL0BDwvf6AAUVHd8LIEu94A3K+Q+2YxaB84MOH62P//qoo38fCRDERE2zf0JfmDa+MieElAjcDPKz+mRKCOtdgGtXaBjgNJ4H2owSpNeAW/rRH4CaHSpMwnBYYycjgSJwfie9CR6mPu20Uv8kABF206AvXlBMiIBPSlB9wjBW1fwEuSb94296VCqgMaGCt/G1BbExi3IG+r3a3J6P48Gv/J0YmEYoiGY7V/SxwFCwGoE/xa0AJ0CEiV9QPCJb1OJ5F1VTjEY2/MO9AEJvj1BJTQpqLfTlGwjABuzT962e4IoKnyrdh3+/6mzDVJ4PHOxj0JqGKoy20+wBMN6D1gLWi9NQHfVP5MEEPzjGYy8BMAOnTAJgEr8HUIejRo5xrA5xkR5AngmiSHs+zDDAmMgWzTg55GSJEmHE8IvWPAoYTfhWak/Wn/bQ0CGLSAjv83SUEfKp5q24LXuQICpzrjrgWoza8xVE00CQCORdhMJuTUT/rjuls0gO4Iby8BIEgK6gS7BsGuTtDrScH/fR68biUHNVGBnxjeNyHEvQe/ve3LZQqgG3rof6cEclsNflG9J4KtaQ8WHcVBHS1BtHE4QP9OBMS98mpbKTeDW7dJwRsnHpMBTFJpV4I+b0kY/NqInVFSyBLANbnMSgBM8F+Fqfxq/h657/Up+GaBnwV9hRqc9bZ/vA6vu+T9E8KPJWns94UfTeCj2QXwCHS9dNL8Xf3Ho/rfewSeFODGDV69AU0y6NFAE1DP3qK++rdB7/1HRxf86gT376zOr99T/h/ioBiXWQkgQgVeIrCC/WomhDmQK+hASI2ARQZKooHMLdCJwGEBBXC3+uERwg+VOHZ9ioAt9H80AI06wGgJ3nQA3BoCut6AhxYwgcPOFnxuFnrphk+NIKIGrWPQtgz3b0i7Y6D5rs1GKqTop0nQX52vmQC4BkjA+r4a7Kx9WLENGeegkhSETBCrNXIMdi/444Rw1n6E96ry7OPuj8UfLxtQ78NA2iSBbg7gIiIbdDLsb5agPhLC3RkYKv8NDbS2YGsatNRAG2oQwf9ZIOydgy1MAzBkAw8UwEEIDzSAqdPQ6za0PkeJAMH3Z0wXniUSZoHvBXU2mcjQgv56TedIKglCpIoQfgwCIjOytd8WgN0bfxoR8Fn9Gx0Aj5Zgq0lIZbsH/ibSJoFnS+C98g9ooHEELI3gliy25yONIiE6pb0NfBlyNEYyENoodkKwgl6I6s8kARgJ4ZoEfuYWHLEJa0LhSBXm7kImGeSfVdoJ1DO2G7WXsehAptupSOoyrCSF904k+6vt98X/ZcM98Hsd4JYIXhQAIg3/f9AAUYhsLQKAtkHVBnzjCKhOoYl2ym+iBtvzDzQ2DLXJ4PUmbJHAVnBQX4jkxfvHhNDqAdHXGQJgv0aSDGItgOseHIU+K9hXnIJzkoGlEKzNHagTdJ6VWEUH4iCKH4fd2AwDPaYBm4Wgng4gQ9V/CoGiuNmD04AQtNGMGzSAAQ2I2pzfogY9LRh7BrbOh4+D30sAencljFu2CUFrwY8UAWRfWwGvVOVfbx2uIILM0pwDv082dUTw8hYs8L+uIWiHGpWgClnAa1lMPJogovvvbePPs/q3Xr++kgCsfgB5oQF9WYKPJqEn6G+OE3i5AqouF59FQOmahQC8rlPLj38kg1c2f30vw+XaoIX24/pMGIgSBoZqoH3wo0sIIGlA9PWcCPrAtpPB8eBf6x1o6cHra+2+tpIFP4PgBfxZtZUJfo4qxELT948D9ucK8Mt9+ccjIQw6QJcEbrD/1g340ATuDgDkFfx6twSf1f9xvuBECYxq/7ythQQGm+5JDx6Brw4CkMGT3wgscCUoQ4sU2t6DR2ciBjTgtcpenQoZVX9NuL4Owc+dVaDursYVkVALX+shjSBKBuvCYDUZjE5BdNkxdHAUBexyHwB6NP7Iyw7sxUDViwge1t+mz8B/LAvVx/c3PeBBCToB8IUGOgqA3iV4yUg6UAOxaUFHDx6CYS8SorMOue0CCJGAf5YfRhoAI+A1CvwxqNkAY5yAIx2EQmkFfeWOXi+nEdSQQA0ZHMEItiagJArQxDXIrj8nCfQi4HZPAttrIahso9oPQ/2/JwV5JQU8zw+7I4D7/sBn4EO6rjw0FR+i3Z9fHtahzsFvJgM0X+tmVH5vaYiNDGAigewAz+gyNLThnjCURQFR1b9d3lZvnVqmj9mEPDKIUIC4KCCjBXywS4N+otp/Hk3QVthOkwEKlV9PQwXjT7s/zwF4Qf9toAAzFdjuaEB6S7D1//U5FIQu2MevO0rQQH8ZmoXE6B/IkgE60XCjVoq8gt2iCG0S8L5GdxkM1cGsfsCMArSCAnrr7dzAZxCEEpepvB8tqHJ/q+bmJGGts/AcAXFOMMeTwC7Pw0B6CtCtA2vWgonqBQJFSwH0JQK29OB2kvgj2HHXAoyeAIsCQO0kMNECAhFMqCBf8mElAkyBbX1tJQP2RJ/ha0gpAfS9l+/5n00CkrQpq0MZbOdAuxmMvHswog62jZj7BnYQe19b14kxNq2D/ehX/p68HEcF+x3yP7z/V/A/q/5DA3i5A/dzA5pdgbKp3v3/wQF4Bb70WkCTHGRAA6+KL0bFl6FJaFw0ImZwm6igSwbbwPn9RMBWf3sN2JgA/BVh/Rg0kQBgePf6HglAHLFQwqQQOwDjbdVxNZjR4iM6Qa3WxwvNxh0JFb3g/WzFQQS8b/ttKcDWoABtUMAd8j9hf0MB2uDXhzX4CHj03L9DBU3Qjz0C0l4mLSLQPicOOwZoVCB6P6dA7nDbGkVuxcNr8PU2JQO4wX5trEqmccZaHU4q8oCDFOpzAnOwqyMIMktNNNAHouDGxO37DgArQZzlmp/14W1QlqHTMaIIx7SCx0+5yza7AKJ3IXBrNAHVDcMZAU/BT/vgv/ULPOA+XiLggAREDF2g0ci6xNDRglegd7P7TWWH5oJfayliEg7bScQRBVgI4Ookg/F6rvpLWP29swREqA3CaG8/FpKqS8DTAV4TiBqIqtxfzaQRLys5I0XEFIFrPbZRQb+16Fgi2LvJv8EFUPW1gGfQv1T/F/d/HBnccP7rAwnIIyHI4ArgWeGbU4eHy6Tx/EeTZIb5bo/BsMBjmjBE08f/RB0PHYBd9eVRAGY7cHRwiBf8WeCPHY1bgBTa9xKTELzEkQX9CPtl0gJiqsAmCT7I8xbjivh3JGFI+D2nBcSJQJ8agDX+O9iBL7UfG4bzAkcaICrbtYHz1ycSmGmAjJfL3CMgT3tQpmrfB7gxSzC1DnvdhQMieG47u75+kTouKNkM8c/+vq/Q7ZYjO/hhVvRq8F/9gGfhP8aqE9EIdR6LTwJ1h0BItyDqB8iFwuNqASscRnYioxOg9ApvnYA35f8e9Ohbfe8J4rknoFkO0lmA2gmAG0YK0DkB4ieEjiLoMD8wBzom27ANZkzIoU8EMHk/uo1mzeVoEoRWKn8L/62EYAX/lsB7D/LXg74uAMr9oGivJ0CNJCGD6i9DhZdQF+gtOp4S+NODRzsDVbhdgv4BqTMNyIL9SCKwL9/FGPp5oQKxIf8A/UX6r231H7YIqLML0Ae2GtrADOvRQH5b/MPE9dt9BGLNG8jVTAQvIaK5TtvvvWQgDvyXIClUA78S9Nfg7VtIBlO7cbsEYkQDMot+ygQ7QwmOawTHnAM2XUSnJvPIYRYMmYPS+sv3J+cfP3d04JYIXsF/EwMbBKB9Q9AY+BiSwFj9mzrSXmcJhFPVHySTbgHJCPvRQ/z7G/SVUETsg0ZF+i3CRoCjhf7y1A9mOiDD7TwdwEoEXjLwAv+avLE2B7Jnb+OqDpBoAchoQJskxKnss0vu7Q2YhcDv4ySeLOg9GsCKiUIihP7yfW7zbTsBh0TQfN0iAWn9f72Z56/Ax9P7j5OAH/Qvv3/QxKfk0DgDuP+R3USg3bzBC7bO/QT9Eeh9QvDPG7glBQzJwK740lAFFgFk8P88CqDGAa223YckWYhr+c0BPdwetl2ocnsfzePAWcVnnAIp6gDVhDLyfV4nqFEDPxHsbWD3k4BDkN+pARqKMLYBPzYEvxp9xmCHQQdgWH/9EtH2TIFpu3AH/cdGydv1j0TQbRrq+D/mLcX3ZACZ15bF378CG0My6Kq/zoGOQwhASDFwFbxyNGBuSxbCEhQ/uEPe/6gAERWQObCVVfjPpQX+rexxYhYFxIkgpgX7Y/vPs+Pvxf9vwt8kAs7i32t3QCP+3SPaTwIytQXP38u0PESm+YER+o9B3vr8mETAUfDrEkPI80ck0FZ0dXh9U+HRbhey0cAc2H7A4y4egoD6y8JfkBiigLdFP8v2W00E8deT2IeAKujZ/QAVKpAtKI20gLWksHedfgPcb+0+NEHefd9vB9rayi8h7J91gBbaw20MsnWAF5xHkyDUCOoXp+yrOwwxcKj0aL6fFppaaKDv6OpHR5sgx5BAlK/+fYhuP1D196o8e7lFBaKqv5YIMnFQpd0FGVR35RJCnCDaABaXBtgbiSwtICMtalKC+1JQ6bx/PLcDPQL91QFodQNKpwOgF/9eqcBxBBqRcKAAVk+ArQOMx1RYGgB6naDhlK+uQQwJYx4meQbxtNnYQwMjt/d4f3M9ZE4UOld1LAh99fbfzOxiEkKFCkTJIUIMUeVnJ/9sDt8/e1NEJOi9oVHDGYhgnSLss9DX2IAqw1zALUncKcDr0FB5NP+0cBQNrEezDiyiADPkt9qGpwoPdL0AGPx/NOKeyf3b9WJNdfcFv6bKd2cLMJVfJ6Y3B6wB9WFUfWWEwKMfGiQL+3bz9XGQz2EHKhF41GCtZyDi/gUCsNhYoAr3UNJ58YidHKqnMb/6AB5J4N73/4L+t7mAkeeP3P+1LNSB/l0SkMEd8DcEuUlguEw6t2AU/PCE/q++Akw6QFf1u6SBrj1ZnnhG50AfkoGIdf7gJv1KcSfgzWWkQ9U33Z3tHXYASKJ9e/YhU90rvD+q9Ej69/wxYJVs506Eg/r3DkMDzEdDBRGgcZay49XihLA30P+l8N+hf1f57/0AoxbQbwYaan/rBMirE9Dk+sBzTkC8JNDEUlv5McB8PP19Y01Gayep+hC/2zvQ/2HGLAurowsNGlA1cnqGGzeH5weiYLZm7h3QQC4O2tXdhvMMk1ZS5ebpgI8eMrPvPGkwaxayk8Yc6PMOBPEdC1XZ+2UfbfOPtxLMQQAG9BcZFoF0gp/RKjxe7+oAw9T7ZPWhgedodgz0gf5KBtrtIZhQAZpAV1Bi36w6t98qVfH7hqGI318lLCjLCUFlxRHwqYEH9a2qb4XjWvDT7kBwfbZA5P0+PNuRuW1yf4yNQH3zzwv6b70QOJ0G9OT/dhoYRUGT15uQH/71MjQLtQlxfDuiCXrtM+SkA+icQdH6sU/xz7Ze7FlubV4TpoTQ2osdpaEjtqADmEU7OkBEFoLeC3IWFFeswJXKXzkboNL+wzcFHU8hTGKIboO7CLi1/P+5F+gydQhuvRbwEgxvtACmANikhLTbj0gCYk8KdlYgmj+4Ymaod7TwahwadICuX0Cm2fE5iNHPK0x/CDV66Kyg1MnqjNFBnhBoLQCgUULfaVe5nq/6EQWY67bXCszUb+7232fVPz51iGB12owK9peyP1T4raMFF/OEYJP792mgXYfZ04GHMAhBkCSmSj+dKqRPgVFGHbpLEGMiGFeQWfSgrY52VxaeDUPSNJI0P7NoisG729HHl78z6hxfs9rV3m4JjgM/lsui2qmThjCfDFSb+I9vwUqG5wwL55U7C+6ot8B+7N2o6r3q37T9trfpjgmTvv7PSQATLLeRAOZhIJHBQfDQQJPBdUwEbVW3+L08EcEE/9G4ANrCeWcnPKRHDupbNynMx5AA9IRYLmrc/YLSiD5EaEBS/s/TgnU9ILcH19n+CpHwegLejx7Mn/d25fdN+e9U/1vgb7bqf08MOtf8EXxaoh+GY8L6gDfhvs4i6HQ7seYI2sv1GchdMsBIG3xlvxcCRzdgCPTn+6q/TW00VE8Q9FaFv+R2VlOM1vm/hhjhDCdgNflVKME5B47I9xT8z0YgPAJ8myb/LqHy36j/Mwqw9AALxuO1JVjiuQAYLcFzIhiEPe05fk8tRjGw7yWQbsfuLAT2VqOId1osnr0F49VM8INACPHDoBz4B5mqqSnUgyh3ArjXxfQH5BbgUS8gP7aU+w0zHD9GGD0CGHf+P1p/DeivlhU4BbxR9a2kYFR58YaDZCUR2P0DMmgED2eg77puegy6PgDphEB0CwlG/i9d+/Hs34pBEQrBn0W51mqGnJAk3ACCHeiqkQ1XFQA5AlKH7Lk8yJKWY3/nym14h2C3JvxeMwD9ZVMz0BPMi1n1RbKl1cYhIVblF3G0ATsRiCMUvoK9//OgcwYMoe+ZKOLlC6/Xk50br9NFz9fanqA8UIYSpCwlBO4kHc4WLLBfBHVaKwKgLQjmP4Un61Vq+3s7Bsyi0WztmLjJwJwFeE0I2vD/1Q6MVwefxfUf32skCPbCnxQqf+QMPEUDHZ7vGeyj020JgkPXXwsldA7SYR1RE3h94NvNtugswcgxXEkIcBPCGZ1rmrgDC0A4K88nm2fn/eTnpQtWyZfybRoK8Dro4zYDIMGsf7saTBzvX0SMbkAD6o9CYbsfMK38cJKD9l2FJt9/VGs0h5Gib33pxMKWNsigFUh3G2un+/N1WUglI/EEx8fq27vUNnwsiOoKecL7kQS8VnWAGCFUgn6dBtQhv40CmIYggwK0uwDHRGAuBXVdfwzHUjZzATLMAoyJ4FmBhzaWBlrHld9CCWpPHRqofBqMReMGTJ78q9rDes1Tv7/0m0v0AFHXNR6P6g30SHivin7V1BOhh3iWPwvps/yE836L2XiwnUT8x2iHgfqhnwn667QHEE8oLQjEvtEW7GYBZDrDVkwNIO4G5GiBDf9fGoFM6n+vbEtzXwP6u9AduaWnGYSLAlVdl/AU+ikrSeEIKgwdaZ4AACAASURBVKj4/wtgHcHtdO2nWKcBkPfxcvnNQvsj2Me9f02r76T8q0IBn9OLKfz1HX8yVXQYGoAB/2UeBQ5/5kCL6+H/OGGoRnLSwdd3oH8r7KkGTbgIxEwVWvnF8KOpHnyzfF9Jod5Px+IF1h8owyitDw/XEgRb5bPqbt1uvn7qBIQ16vtS/u+DP3cR7CH0WWJgd5mTJKYgNzoGjQrfvu99NDBC+bnyW1x/qhTatv2OaMKgJWPvv5kwnMgxHYGFRtJW8VMl3uP+MgoqSZyWFKr7+KIDw1d6+IiOgZI4+d5iYL3imzbgyO+tph9t2oSBxOM3ugHtPoFZ1LM0hF4kXNEBssvVgPdjdXZWK7uKvyS3q1Xb1WQwtVDqSUggq+Vw3t56JA2cz7PXOwGNW1ecwxPhfe3QEUsDsFaAz8jg0nf+iZMAHNg/XSazDuC18Iq1HBRrOsAQ8NLB+16g614jmuSgs3bROxE55D+WDDQNA4ivdMJ9M1b309UqknaDU8ObV9/PwmMPATvTMAxpABLBzugUtV9bLdhNDQA+7B9tQJ06/7QNDHGSwtgZOCIA47InIoDdROQGtt0U1HI3GaoUnCnC/rzBMQJteN17+VaAzYNA7e+PFqHQUyXPUYB7iQYa5ZFjq1Zqpx8Uqu/XT7+6BWC1Xaj0GlBIwMoHu7UzcI/6/Acb8KIq+hzmGWmAYnADrIpvKP7TZeLaf0LAeQkGgebbq9FToI44p654F47tekKkI0L5PQNZPsDwPBpy/ni+wKMN76Vav4+2cFZFf8+JwAraMt0DFB7beA/u4Zz/a+RXx0M/ct4/jwaNAS8G17eSwmta0Fhx0VRxJkHMivso+onMXr+YwdWKbgioy1jp4x4AzIKg5lEA7wvHEYCRmdx11TAuT6lDLVl4KvXkAET9P4RT8H2u+lg9EPQIpw+/NpJ7RwE8HaDv/Mu4f3OdNkq/EfAiEiOANjEALvcWL9gfFV4NZbgbQc6qPky4Pm35QZxtH1f4j+P/jXuaYPcWwIEH/fmEPBoAO4m4LGxV3txOQqDU+dXgey+UwSzuqP++uImO/u/6ogCb7wTc1n61sL+vZi87rxnrNas+giTg6QLzaUCjIp6JfhwtGI7AjBBB9JjDY4ePYVR6ZPgN4owVv6Q2N5hhVHwNeYrM+w6dN6K1sMHZm/Ce7bHe3dzKr1xw1w4JrSQMZtgnoQHlr18fzunAszD4qurNUg/TDqzx/lfCaO6t4tACMUQ6P6htWjDPC1hCoZ8kpODzJ70MUR9AODcgwyqyPhmE+wfHYB/hvSqt6qeXUShhXH+d9SR8DzrDaZZdpSp/HxqLMQuATgDU/qDPRgOIeT8cvz/h/XC6BtE7ACLOWPE0KIS4UUjmZaJ2grBphiWgT41BUVWZfP3AnEIT6OrfoF122l2rMycBoU5i/OXoUZ4/aglsXwLzHNU++FVF3qikOj5HXm2PBitT1WuvJRAB+6O//W0/PY8vQH5IrAsMs/WuVmAdHBrQgrbOxJShXwRSsu08h8JMBpo0+aDTALwV4tbswgzHrftG/dJKIAQb5h9KCssWIMeto+GYqG12/HWGjx8kzqNJaa0noMWOr2KwW01AMwJoNvhMQda2/RKQP/3ecABM3g9uD6BY68Ntz9+nDOMb5iV+hIE+dP/Zs/wwJhJ9mgBnohBuStABUXjugF3hkXF9ZZJAjefKdHZCc389LoStKvIl7QIEb1d9RyciQgFDI9Cjyccc/23Aam7/PZJBhgDgin5CtQvbCzX8ip9YgIFtOAt+w0owp/hOiCWgEGbVHuYjRigPGR/YOnEoqPDoV5z5YqB3mRq2ox5ICmSSgAP1Ne+XV2NE+/vuFbCTRADxtS70VRBCjgBk2OyDUQiUgfl77b7DwaHm2rAZ7osRSOOUoHgKfNBSLI767+oDYrfwZvqChSpGfj3pFwZFsCJg2jeIQQBUiyI4WgD68ww4qO8khuWkkIuDrxWv2nv+UTBpJYiPd0KemTA8qqFiuUF1jWS3BoG6pADJq751JqBI0wvAVPyMQvjcX1zbELltKK+zBiXRFiRxG+b7q3M9xuLdzR8g0gCGNzSM5gNYfqGO9CBT8OHct6oB3KsSDBisUnwsFuISQaRHxDSv0vptt2oeLHMERfRn/FG/Cx01EpgIQG8LP+/i37PKw53xn6sYCM4/JwSRrCnIeB1ZkLsawDhaPKv/njU3wnZ/dBdGE8+YTHSG8+ofGgIjsC19YnwdM/KAnTSsqj6ig7uGgIPw3nYFzhhIIvriAxFP9CQd4HSlnzgxONIdrE7A8ZDPx9fjib8ifgegNIliRgdx95+E1T7+3nQVNNhEzDgGA3T2rEDLduwtPpuuouPcs8swwXFjdTaMKt+jA5gUAQPcf95KJQxYU0cYxEDvsBSmYuukp7AwnqniC9Afa5z8vboI68ImT0t26CvwBzSggkj447r9IojvCn7U92J/Hw0QSdwZKNNjxPCfSxRqnATkdwpOwh88oc4J8KTSm/wdbZjrc+4iFP8YO0/5JJDCfaijK5xVXevqfg6zGRrQf83chvX4aRfAE//6vv5+6490U4ADdO7QgM/5bcHP/n4OtCQhBEFeDWSvos8DPq8/IwzLzjpa8/U6MMSkBklDm8e0mn3QIY7XG1Om8wzN48y7HwhOK3P0/ZwUQHHv4psbdoVeb9VlAjChBCdtDDpOKTh9ZfcagOYq31RFjN4/gwBYzp8lAwYNwBELhZoxECeZxMlAzWGdCRV0fQWGHo8+8Kx+AAxnCIzowAxy9KvNepWfsfp4RR9kUrD88CPVTuXRybhqqTHcnxEGndsgub1Gdug8yz9fHt3Hpl57x/mfCOC29FOSQ7/noAZR5W3Ob24UMpuPYAYiQrQgk1gnFoUIKr4vKFpV15pHUJO3Y5rfH3UFHU4bGkU+NKJ9f2hJyOMxDBDpjAgwiYqvk5TqNl9EH2Arb6fA3yaA4cBtPWewhkEcIQJBlGzYp6zRmr1v+e3Fv27xpzvyI44NGDkCIi7CGNV9Dw0M8NtHC2vUwHINumCGNG8erxOwtQINsW88Tlwdoc+F85nI559ngEDpt2F/Uu3hiXYrkN/pBFS26hYDAkFgErMK67y9mGBA3L5ore5izf8b3n805MOq/t7XU4WHv1DUF/5gugCSOAIW/59uMwl6CHWAib8bvfxWl9/rBGEMTTwDfG+ezEYG4yk6FvRPuPwE+wvc39IRjENWM+/cm5b0W4Pf4WuKUnw/vD6eDbB1ETs5vl77Dhnm/51g6wPWwQAqxnivgQaeS3gy/u/1H4hpTPrIgHAN0mSgXUX13YP5PMIuQAfBr/f70cdeE+QoCX3i8nFMLcAjInBoAIYqt1LhC1WdtvmSab28AYffaeivCB+ohdYQgfUa/WS4ToMsNLHLc9nnvPZLwn1/EefPVf+U/xvnCVSEQEkEQEnEQJO7S7RvYDxNeNYKrG7DKMhtsQ8cMmhgPKKKj+F7CiHYFR5KIIPxOmg5IVAtu3ACQSPh7CzUQOgAej5CWEkIe3vgxz0ROGO//qYfz/dnLT+ZxDr4QW0eNCJBorCFOVC312Ec2TiY5Bk0cAaQmiA1VH1MOwDHQ0kHdEDDf+2UTWhS4Z8diQMicLx8MLBfverLcP/jQzF0P8EJj5+NGK9RCz755S6F/f1+X/gxeP+Wsedv+vF8/54aSPJYFjIQd624MDz/UDLQnr8HU3ztKHRf8Qeno1vyAQJBaLcMtTV3cvgP56COCqd/QP9xLgBkH4BxO13n4hNUDtACC6G1S3zqooZ6Ba4lp/zcAFb7iERKQwQcF39IFJjdXECGADw0IE4gg674pYAnk4HoHPx54tD5daO5vxrugSkMjgiiqc7TVKAT6AT8R4ckbHEQCYR/IZBxJgA+XZjsR7vaoRpIxWqeqfXuGC2CxwudicwePEB1kNkaZCuwyF0DuKv/4sz9mzP/Qxdg3BDkBTMC8Q+loD6UGBzx0Kz6eAX/KArOQTlPHFoI4vVtf4rNuLrca9edRn4xBP7k8w+9AgZCgBfEUZWfEs8iFNZ3UO7TqmkjCO/rWdgco/yIqHcQWaC2EGTzgz5y/iXQAvyx3riyxxV/JeBriaGB9OrTA5g9/eokM+37GszqfA/UZk9iW5UnCtBqBl3XoNN6Ag/+zy6A5evPAp+TIFDn15gQw9rjrOzFX0s2JBVAxa/nP1a6AsNWYGjPNGPLTQgBsNUFvOA3Ht9o/rGDN0tWOCcxJGp+f7++kkP7PxcGv1+GjkaLt/fawpwwerQxBJNW4b+PJsYEgiAYYdEAGIlDNaAbRkIgK3ut0jKByp+8yz23X6GttmBmjwDvChgiYLP5V/zhH6/110sGcKo5CkggCngxnIPoPja0j2B+1BRkiYJiviaLJqghDI63G2nAgAxMCuDdnoD0wIQm+urMB3VuAwbBrFGgGgnhAFqg9+ujKsLxB3qGCQNEEtPinIQlAj4WgIw7/iXc9V/x/yUWFs2KH504bAh4aYWf4TrTLGTy9YbftyLeVOWNfYNyt/ji29mQnqMAltU3ioTtbX343yv/1u0YPUBz6zB702tQucnX0gWaFh6DgPdmhXaapGotw0SFz1qDiTMdd8h45HfcqCPRUhA3+NmKz1l9teCPaMd4urGaewRitNBDdahR5c3AfQmDCFT9vmtQEwqAYXX4XI2n23Z9B/Yb1FL+LWox6wHGbZSo6FR1LzyG+3hriSZvWT6jfXhl2cmQZJDrAbuYAqAHo1GA/EOgD8eGcU7A8eDvH4fQBuAhBL/Zp/vamPTrRENDGLTV/7E1WEPLDlP/PwzU4YhusIMUgfIPAr6Dhv5R4y2r8ldFwiFoYHnmr8TAHbhRQSZOctH598ZYhqt6wP7q/ouqe77RJxvzFYaji/z4vna4v5cUMDXqDAJ5ytktqtBDckyjvJg04hl16LB0xFfyMfD77PZjErGQRRjYIfSvoAXntks0ok8MsUC4KARWnYPlJBeIgLeFrUgDOHYCag0/XNAbWgRwQuLAsaQwIhC1g7+jCNKuT38JfnYSyTi+QQEwwHeT4/dWHYxJPxfOj5oAnRQqgU3YgGZSOaDyK3n/qkDYBKptzR3oD6B4fyRKjp2AzSl80YR/3P+/1vBjX18Jbu+YsrMRgbqPP8zrDLTAaupphfeZtyPs9BPztpLSBZjowF3woYRwBwOWaqbev15b7X4RWsiqYiY6ZkFEIoUwUA2OrkeEQE8HYNyD/rl3m88jCGgO/nPW3xy8x4Q/HBcM1dYg5q8N+B/SBSYhtD0EY1PRGLDoKIBHF3yLz4H/gSYQJRETgqeB2d4vC8L2NVnQn4PoVJJAcP0inahAfdXVI8CFszjRagCTtRdV7Sr895NBpRKXIT64RMFw/iw5eChhEvmmyUIH+k+Qu3cLzOAN6ILlFvgWnx3YWFDz0f38ze9GlfP6UQ3ojEY0gtqRIEbA5/WgQFhsEuIeL75uTzvqHktAWfj/OD6sQXssROcGiRgFn0QVkld7OznMDT7CJKzhMIqxW9B+LCOQdH4uyxIcE49VTSeLj0wKjzcp2oDXQA8YoDEGBLMW0BJw+eAxXejPV/IXd59/tp5rVyYXDw5BlRetSpQAcvgfOwVM8ObzBq/AQ2wX4lwkQV3vNhYFfn2LFgaoDU1ogqsfqGkJYmrj9Tr22KQwBLzbLuzDeA9yzyJjVRfwegWq0H+FThDPA6ZhZwX2M2Kh4waovCzAWJTzD/qY00c+6PM8coz08VNqglzx54LfHuTJK7z2rwX35ABLg1DzsZ7Qv7l/f2yXDlbf4C/irg0MJ0aCuD0wP74MrxfdFlX7tq+vtRdCpvt599EG9Yz3V+P+Oj/n4zLruZHcJ7oMt/MNp9eD6HEeFb6/TMfbWo85Pb79HJo8t3371/PuIAZqMvjPC34nVV6ZB4hEuA7AzA5cfU0y2n6ux89D/35/n2/vWY5Bf0qwf3tPLISO1Tap9qzFB6eap/beqI94NCCbGwgqOItY3CGl446CaQ8i2Q9g0AvmgJOnBoAA0gu17tsKtKS7D4udgCYERy2QIceCX/P7mBW+g/7D9S6Mn50CS0eAoQPDcBjopIA5+EcxEjLweRjXq0UbLIjcBxsGx2IZvlf0ATjz/6qypAmY7bhrk4ahsIis6ccXKHdueAfUgk+RWPCLh42c6zEeKyJpRTdRAOqBbl/Wq/uT+q+Fx3FoTIuCzc6+hN8j4veGjuAnhSE5gKnco3A3XwYlq2sq+lmP4yEOpqEoG0M+mGDYuYT0pKCFHgLHKt3T7T9p8GcWH+n1UwGa8X6kQt2x4CeqPexegT6o/Z4Cr313PHdgrsS2ZReLfpKIf+IMFnmVmwxQ9AhithYT73+p2s+JIVfrjwiHnpAZrSsr9CMstQXP1+1+510N/q8E/YoekMN9OMFvi5LvkRDsy9rgFCOoPdpgaQIWBZjf5KCSQszZJ1ivTvLokpen6tsJAVND0NFqb6GUGg2Im4Dyx9Pn7/0dm4pADAslJzTv+dKNrAPQ0wyySm7bj1RQgbAXsRa4R+mBJzpaQmHLmy0BLoL+Nh2ZRca8uUc6P37k97n451fvTieAE8BdZ2ItqFEK6oOJIYPsiU4woo140Oh+H/UC++gatHYcOFT+2y3AYvD1rM/fpxdUcsAi70c0OxAEP45X/hymE9XeoC0zfYhbcqfbhs09HpwnKMDR6g0mmYyKth/UcLl9ITGQ8N1S6s+gA1HvQCc2pluPvN2Br8SyZyfyxPP/VhCi1L1HWX2CQCuAE8TIq/sBYdANZmTIwqq0sb0HIzhhugBeUpBZLFyA8y+EErsBUYDZHYN9QAAooQwOws+uQlhdESSSqk5Qsh8LSYI6LDS1AbmOvLlRBqQIeITvM36+TP63VfE5hFClCTr9zEyVFwS3STQBy66DMHB+PJWIrfgGnYBx2dTboPa2X49GaBVlePA7CFx4iaGi4ns0aLVjMGvtPTDtmO4XEE8E5Kb/8qYai+NHl60LgAICcUCoJPVeiYG6Pxw/X9VFNVbFn9FNPzXoIRDTyzcpREYB5Fm1EQQn3KRi9wKApR8Tz48SwxnV3qM0q7ZhpdKvr0zfY+gO4oQf+EGPFYW/Xf5hwWsUgxiBbShGoGIx+D2eH1h2EeR3UQMH4zMaUKr4033nzkSkfQADelFbLOQCalxdxvN8mInhPas9bxtGJw29Fx3Y8429MAS0fL33Oeo7qFZeiToCC3B/VSNYuU0fgDnkhxGgMFdxiYEY7MYel+OHPH30IMeVFK1C79l+QdXVpFqHlMAXEf3EYDyfkkGdNvJ8f3RAXU0jpgM7jMNA5yCrtfzOicKG/M9bgEkEjqqPPDEcDfqVwGZv6zcO9avDfOhf4OmLFd9OLBHHdxp51HvOBlnAoQksYjASA1xnIhPsapTCPjbsGB2YevpPpgM73EYeSYIftgPgte6CWesVBB9QEgfnWYMgoeC8ql69bWoRIqYHvSIv/u26bj/jdqZ9KSGk74JRo6QS9PuTiSHm6Z62kLUGH0UO4rwWrhtRETkR4iKRdI8giJ2D2nUCMjsA0TXiVDb98NAf/rCMlajA9wesWHZrAe1dlwRyVI2jx4KkyUHSx7YDe6YD4tOC6XW01puEdAJwaEJzf1uATHi6ZlSCpBQscsh6C1xRcWEG4bCFeKcAVhVlDu54JQIkTT21hptIT/Afk0kMcS9BKfjBJozcDXCrtgbWXxbMAw3INQIxtQJPAGwXmYaBbYh4SCsuKwLOAQ5awKskCMmRg8P3xwlBfbosQaDqyZqBkyQe1CLQACoTgN4qbyHsPwkTiF2pYaj6MAXBmUosQHnUEYCsBL3MW39SNKMJ5PfoBsT33DVJCEbFnBCMOkHfvj6Xq8uw+dgRIhGgAiUqf5QgKDFyhe8nnYrlqn9sG1GoAfirubygX4H+8IM1CmQrMFAJ5ExzKIp54nPoVU2Auh6eBShDlTV4u5c4HE/fVvjFrsII0Ik6QX+Iq68jB19ziLoKC27FYe0gC+j1RSS+BgB7AvAM3m8HLdy5fV60C8RMVuhD1ieQB32MCCq0QPJuvuw5IHF/geMKwOPdpmsxBwVEfGEOgeincJqNmuSFIPhPq/xM81CWIIi+gCFBqDX3QPYd2OcCRo6GZBoA3AM+00aesAOQ7/2Pe/vBCXoguD4OBD1WfPwClzcui12AuH+gC0gEwW72KfjBCQRBr05D0IQc7N8PzOCMehPWK384MPVDJQim7yDdoiRTItzzFV/ZOX9sYFetP0fsQzb6O7wOoFjxk89YoQXv+BmSN+yYHYO+BsDRAXHhuJXsEFbdIEGZQWUkNVNzGA9NZUVBIQL7jASR0AclE4Pb7JN3BO72mG92+o8UG3nybj+mASh0FsLKn9GPxDrEcS2Au35BzHO1BksriIJdpqWjKR1wlpR4fN977rZqI+XbYjYDgVDpcYQalOYKMiuQbB3G6Pu/HlMbi9a0EMkksXtjvvXTfgMKAEZRN/i/O7yD8Da2S2Bdh3ICWfp8yuMkYl5a4df4vVWt4UF0yyqEnaT6swYyWB8/j111Y1ERS9oB0SLMtBGDEBD1PEHwtdjUEAHnqmoHU4wCDAoAS+lHwtu9eQLUAgmxVvAuMB9cELMV3m8EUtcBYYI9nkNIEEJYrQeUHfnzzRyC39j8CgSkir/E0P2odnAmAqDnDIhqrtV9BDNS2POjv/0pwKr6z1h/PMz3uf9ykFYq9TtoAXSwpz0HljdvBCVAPY6t7osv6gFhMpkX13rcfXQMIpuTsfTibkfOPRAC2meLRipI4mDPwMD5x+v3+Ey+qEfACwoUEkKQSMZxYJDz9R68PyP43yvo2aYf881rNQbZgRU/jp80QnW/hdXqJxMvCFxXQSNHpE8QiF4XI+wFfQcw7VL2Md7RRajsKgh2D+6SLAKPF356+/7yXYBTUgFy/38StUjFHweD+iiHh8/LV/i/TSvGk4L5x7F6AsIKbgb4C0YjgdGRIToGUx7cgS3JKP8pRcgak95BJGQbjaJdBYQ1qHYnYHL8F45QgHx2gLMQ2cDxBD/4SeR0LSDi5XzPQNjM4ySE/HGG6g+ugltLNSARn281BPtNO72eJLjdX4ITSEgpQvJYFEUg24f1qAYQNQdxx6Q/RcB85j9f+03zf2QV33IDPHegNgPABTfqFR8cZK9TA7/ll0EQbUUHW8Gr1d+MSadia+LRHwhunv87yWoJ3h/pRDwJAbDNQQFd2P2mH4kP/wDT/ZeN3CK3+ZjvgVpw4r20AMafb58j4N1UMknuj6iCx883PU9g2VHVH5JX2eEcPghSgRBCKPzK0Q3fknwPN0Hk0CyC0zBkz//7duEetgFjVtypASDI4CsknYJgYDhqsBxxy29+eyxrAZX75EEf8f+CkOcijMDDHx4ASYGGu8WHgPwpHJc0qOG8FgFTuVk0cRZVePFwHEIUEu8xSHoL5qWg4I7/HgOKXe2dcnu2SSdCGIDTA+AcxY1zYL6Q6AAFu+/1GvjKPSeEoJV3NiM4Dz9C6oWkEav+NWjPWXNOIkKgNTi2I8LeBgaZHJxqrC4oNXoB9pzzMws/OW3ghSyQJgjbygOVEDhoj4nHLld8HPD6UUMFVLIgKrTL7cFoBRLQgEdXIseZ2/HhFPKbk4d5tYWwwR0nIFQSD2P5gQhs6meVfB+Bkyz2fOIvX/zxqsSODuAGIOLtPNnmIPCrv6Kqvgz3q4tCwNl9lWYfnsdHj2HTgQw5IBHwULmfSu1jEV3gDFSxTBmqSEVqiYK2IkWcRiAkwV/cyW9YhqHXDw9dkNQAcO6HFNJT7oChfrPUYc3KY17zAd+evAwF2w5SCKLV4EuCEKsKfjBVWHu9Q9Arh4CoBqEMWYBsNX7YgKP/69uC3M7/mOOz232QT+ox4iCyJGEFP4oBHd+GVvXBwX35nqp7qeIbV6L6tdZub3ueJ+gBIKgC6S5gOQFxDoGr+Bv2nzqbknd7ph/EmXzO0o+kZdc/wqvQkAOUffVMzKtYgx5Vob1/+HAfCdzHSiXHenX35/2JTr3KZ9Ruj2lYiMhLIFoNyMq9hFroeYMTE0bSLbhb4l3YlFPa6hMd2jk8dmrDgdQCnC4/+ANFlYTB6ATlx2GDGXP1rvL+SnWHw+cJes5/rRWt4H2pw9GklD4uSMpwasIQiaYR92gIyFX5S8dtRZt/nCAH48VXW3hRE/HKOsGquj8EM85Q9cfeAV4XwNGAlmIFIwPYrfLKuxV476RRetzcdeAsRSZhiHizCKEIOHn3EMOWy5X4uIJnXX6sFiBFLaBm/THOQAkVJK9j6TKwiSDTBWpwHkSPQJX7U959uAkoaTUuug6oQCBz1Zlxm0OJSIoIw04M+7zCGuYiznCfHww9AN6Ir+HXA7lfn2oBSJ2FOOh8SzINfmcAyITq8JX/sOMPx6A9LeYtVfwgCBZhdu25OB9/XmWWNPUEPD5dUuJ68wd1AqD2+w1PI9KxE9BW5t3z/igdYGWiL7L+wPv9jgVY8f0ZcbCKCuLAHN+c5wa69Zpr0J9t2KnpAGzyiAIPiFalJ8/xXrrA6Y+/8NoDnWCPNwFJzf5DpVkHte8hx76P+HU1+HEytEeSEIzAsu5r6wPJGu6oLz8VrKofXLce+ywIHhNa/Dmw8LrptWXZ4NKZm4pr/QQ7Qk8ehMrPtAF7PQCD309QgRgRZMKgAbFREAfBBXNalbHA9cEHMo4IgIUuPjjBWEUFEQpYTkhVO43eRiynJw9Jjj8TOUIlJExK+0wA4gWgQvcFBHAc7P4/u78/Ff4CC5ATB3P3oUwFClYgcALcxzp/B9Ez4DUV8RjBbsCBrMH4dLNwIDaCGhA6o3pXksdBvYBsktrXDgNJKAFy1Z+ZGIy5NXgXoBT8a3ZgVSPIUAMV6DjLxhsV8wX4n4ibbONObHNyCr8Z4FinNFjg8ziiF5zSV8A99u7Zdf5OisvVaAAAG3VJREFU/kIPAJLWX3hUIFD6o7MD4WkHIMXBk4IftSrPNBJVk0OoC7ice8HGS8XBKDoz/YFBLaQi392lGpCMJfhD9xVkx5Xbj73P9V4m1j0v73x9FjDDPlYvATkgFAVWcdNvJBamliOjAwRV0EpeRymAe717kMYRyy/j5FwFBX0fP7Dyx8gq8wn2ZXi8GfGYR+lFcGJSxa3Y84WgzBHetlU4cvKY44Ps4iP9fsgsPGEhQTAcHqwwGCj61SoPexKwasXFqtxq8qhD9SixoBBYcJEDNzmIoi3J7QkoJActVHocTVpPBCDhElAvMDK1PT/Sq3DwB/ygmyB9GNhYDH4so4Foy48kkPtZfZEv1PQTxYpyX0EI3Bu+/5krcN8fgwVdwWu2JNVNWAk+PcOOPMNdGFyAZ5Aj6gicgzNfwuHZg0HrLxBWfjSRl88fVCo/apX/IBrIvf65ZxtEoK9Bec4KZIPLe76osQns46NwW0pUPCPAyMc4A/KXOwZzFLGbAqD5xhhbgBcWfoJBAlarcCSQgdQJ+Movnih4gjZQTw51rz588y/ZgxVUEAQ8soCfX8OR26JwujCLGFAMsOjnwGrlPuQw9D/PPv8BYVR7pG/eeFtQpsLzR2KFI8SwKj9KlX++HeLOPuSBKrKeHBi7L4b+Kx184+ptAp4Trcscv69oARVYzWgaK01H1X0K3zNSmARKtxXYHvwJuT+8gLGGWgpHcWOmBeljFB2Ckg6wiAYOqfxEK3GMCAj6kIiTWdCBCXhkjUKMgJcLk271N9uLSbtvvK0S69OXAvoA5z94VsFubbmZvx4QAnXgBnJxENyQjy38wef81uPhxMpPJIQzr5ckuUTKe0wZyN57iFTWga8GvCwlh5UqvYgmaNV9XSxEVWs40kkosFwA70RgNOu8mLZfR6wDiwRa35y7j08NksqPQhcfkRBK/J8R75Iz+9C8gJpqzwiIeZII3QnYOkJWbVEI5jNuA+o2BwK82ifwnpSgHwaC+GNAdmW2VXfC+vPu6wR6lBj84C9WfvivZyUhZMJlJhjSukDlFJ3g4AvGJfC1iEpQJ/CaEd7G9wds7p71+odruKrHip/C7RdsxeVjzIxhoNkFGOW/+sk/YVAGtltfzZAIfzix8gcHhZCXpcGN2u69qWqD9OlRFAy7x2fQBhHUiETB+DocqvArYt98f+AEAXApsEmEcNLC0t2uPHCqPQIXwHYDfI4/9+8LMpchqr5HK39MJSrBXwnutNqjovjHFdq+fcHLp7YLR4mGgduW5hFpAXUoL4cTTuW5HJSkB5PC0S7A+8c+837DyoM1J9iv/po/o3BunlDqPjOSO/YbLFd+FGy9sxKFeT8b+nLNPrkAyD53FtT27yUS32yqUaEGTMBiASGcZ0FmK8nWxbvjC1q6WQC4VdWdAcBY8eFoAzIrC0b7Wt8wlPcIdE1FhUWeKU1Igv8Q/0dl4k/NnYSxdlDon8diUDeuQB4c8XVzcahRgyyZmNC+LAgeCfSVALde8/t1DCYawNoePGT83wlOpFUdOZKwxn89OsMEf0X8CxJCBN/dwKbFwkSMgx0ACJJDJD4iC1JEYh6XcEqVHpx4+J4I4UiAl26r5x64sttvSlAn3LBuQCz6edU8C+J5epBrC4YP52EFDgHrCw1B0eU9bOaTgh3wmYvQV3Oqqcf53XnVNXUBELX1xtSgFrirlII5d3HFulxBCNEfZx0h7K2f34XwdHpuYQcguN189Ow/nPXclaUcqMH5leCXjKOjbv3F0a7i2ZaRHmBe5zwnhA9S736ZC8AH8LHkg/T5znYgmES1dtuzGo92qwHIquiWX+4KgVLd8utv9Ml1BQNhEJW/FOgweiTguCUoQHkEwYhjfQIgm8eAzPKzHqAG5xGiiPyxeGRRaYetUpDVpHVC1T9bHGyaknb/TQTnuG7rDYwYCUT7/cMjtILzA+Go/FPw581F/mWeTkDuBsBCAK8ki+A29nMzPn4Rzjv6QV7xWW4fzQFUxb9jQQ1qc28kMi4mDl1NBr4usIsz5ltZqNm7AeJXfuTHd7nioLEyPBISU+8/tP1AC4Il/n+YGmjg2NiBRdl6yCw//zG5ph7bqaBuz8B4VMU/TqSsNPbwCeZA1cdxyG9SgKzRZPL+GXFOiH1/SFZ9wX8M3zUgvH8a4rMBjZj/h1W9MrwTiN6MlsCKiI4gycBzgV/xUaQGjGDHwHiYi0VIzeEAasCpNuL76AC7BIEl7i4AIxnAfoMxk35eJbZ68wWEUChs8IPz/EEE9BkUoNA4RCWSLJkY1h0Y/dG9bVCtUVPe7QRhtStXG4nOECDfUxc4Uw/Ik8JkA9o9+a83IrfHH11EdFUWc4phNgVFWkPsIHBnCvCCYBSgqEN9qtoXuwHhByYoJJA7BxIkkRwpDGgAHo+vQ3ZGOwCFJCJKUAx4MBpFZWvReeLgtBBkDDQu2OJxXa7SE/P4ZiUPHABjY1DsFIhPAaygWewiXK72hHjow/k8gCL6gKES8qcDZ7A+EhYlWCPGCX1wXIwzkQEKt8cP6iqkC0FEhFj/ZYtvXCtwuBLcDT5wXN+9H6ZEIkTwV/x/s78fXFX3siWHEKrC3tw7EFZ31Ll7ttknQyEMGgAqCaVe1bGk8r8nFWCQQR0h7CY0dsU/mIeIuA1AGCo02Q0YVXxub36sG1Qgfo0CBBUXxap+ECFEycQVyViBEBFPt14TK9rZHB9EwMG7DPXOv0OVHkdtx7OSCXfb3av4CFZGTwQBwT7/hKPHE4PzpJ4L4+FM9r1n8B+B+9R9I4Fu9brYUZgCunZWNxdQgIs8mASBQ4F8hJpEiaf4GPihk8FdAxin/kybjZjTj+mAQy6ihZ9whDvHAWB6BKrBXQr+5SBfqPaINwiz12UIwoTmbPACZY/fshBBBKNlW8ZCHwH/cVKSOZMm4Mxk4OwE9JeB+EFkn1IzcPQoiSB4vGgNeJSoik1A7m0TCmE/HrggB+/1M12C1Z18ACGoIeH1pH2IhAqFWgBq+kDFEWAvA3X8tpW0cnSD5WAOriOHhnYraF1eLTkS8P/QsHUBdtMPnOrMaANJE9AZiaKWII5Ue/8PTHn/UcCSTgIF2xN4zdmAQYIAKeBFl6FiO0aKfq5jcImHfPwTxcEdRmD3LcFoAva1Hdjm9UgGggI9YOoPkOBYLsT8HlG3nucMDGkOOJ8CkNOELdSO7D5qqAeJYBb2GpABgRi2gxLITgrOQ9C937HgB+0i7MeRx3gfPWCXLtgbLJAu/gCFBPzRX8eADJqCvA3FViC/BlOQC4LZyrBq8BdQAOUKoKjqR7v7EFfVFMojPgEoSlJesNIePyLHwW9NRgq7E6HvUN8A0yj0wyWDHRZ3J2A1jHdMyu3hCGwSDwdRir7h9VP7AKLgPoMCgKziOFLtrUm8aIFHlgxYfz8WBYUU55iAXauo+evJaIK/NTgRJM9sUcZRzcCnMdNKMJc7usnAyrpxHYkTRHK+n1HxS01LheAHqRWwKIDqLvQC0+PupHZgBawfVGsiniTVHwZHRqbUI/D4Cd+ftgyLAR1ehkIiqaKFw7MJEwUIuK5zsu4svoFYCFKgBJZACBuppOId2RDkPZas8H9kULcA9a0KTCQDGtpnzT+RMJiOGseHl4BQ1C29AWUXIIf/OIwwqoNEK3SCuA7FRiBrE9B4/PcrGJ1OQNj83F4Xbol/TgVHfMiIZLAdcaVkgh8sLrd+liNQH/FqsNTfj15m1J0X+ffZuq/gTY7QnvIfJz6UzBJLs83ItQpt3RfZz5iuGfNPajpngUm0R8DoA5jDlzsOTAwZjzsC3Jjxg7H914PjlcskGdghgx9HG4OOQH34uwQyzz61/0qiYNQjXxECuWYbGM/DrjtPH/Mw/K+gBLLSA+cEfPr4MroArzcDuybbr8Zc72i2UnzeHnTgzD4Ug78SzIvCoARVOQxaFFR3TzWnkkHUVFShEuqKxZnKz4p4YYcf8ZhYhuu8wFgSHcuuwCJagI4bgchJQK/qe9c/RT6nGcg6KGREJpb+MI0EY/b0jcsni3AJBeCQNsBOFVYoApcM2Aom4VFgIRdHpeIG8D3YaxBD+qCiQ+rBOSVnci8hzkAG1t/pgHA4uwDzmu8xFKkkkIqCfkIRs204r/hiDgutoAAcowBMZ9+KS0CcXVBOHCvJw2jMQSJyeoeExF2DuTuRcuWAo9sefyUQ6/oBaIjPtiRH1KvQKvygAHb171d+vc4GRMDPoxN/kL5pwlVh1mBQ1quQJAJ5j0TgOAis+h8d3mnC8xTKE34+8sDNjyVXE6nFMN+H39TQDmocHScENvN74LoGScGU4f7g6IG3n3C3qnG6JBS+Z5tHOOzRYQx+u7MZmAl0OSsRLAS/VIKfRAWU92+12aaVPksGDBWQuCMvgNy2M2Mt8EwqbjosZAec5xLEAmXmcFTHiOWARWglpNpjdEtBQRxJJU5VL5/7F1X86XntXgUK4q+KggsUoIIK8oA+kgy4+zLaACqQGTVOX6MBWdehL6BxHn+tlyBMDGAqufd7WOX5WTJwKYDfXJJP2GXDPk7Tj5Ed7BOG7DMFaBRAJgI/+H2Ngeb2SKb0zkoGlQBHkefDr7xMA5HZeJPtKIzyApI9gmnPgf1c3mulfhe0gFekDCdNFnrOwi4Gs6eTACNjB+Uegcgojog4V25P8bctRYY6RL8AJklE9ACFAGZdBEahd4d4CmghFhbzcwaXYH5qTlS6DY+KfNH5Avzjo2JJ0poDkSCMxLn73H/eB+ifvgvyIFCWAji7BWC8hd0qj0FziMdrS70BlVbgamIgcmotGZDNPwm0L9l5iHv7WRoAFx57ScFS2r2iwot8oKu8l+TOCOg2mZ2nFdjTgOFQENzKkJ8OjEnsE8f6AzyXwT6MNF3RDRnuj0Lwo6wTlBMDIyqaz6G+RiLJMg/KUrQV/rh9uH0tWduwoxmky0kSMQ+rnXxZsGadgnxfgk1pCnsIsGYltvfdzTOBIclIsN8MLAGcz5gBwj94AE8DuC9Molip/JGwB57nRyJiyD3pyk6q5ij+3TzRLohcqyqCEQBTepF15+WVmW8SEr5jMUUkx3oMIsrH3ndwAQganKzyMpOJNxMQooGBYwcByw7axIhgPRGEr6GSGJhkAELoQ1YRg+dPeD5IIRDIqq5PA2Jh0Rq0YcS8XBi0ghGRFpCtWTdum5+yLOsQf2EuYY8AfnbQZDgCjHxBSKwTGpt8QCIDVH3/4H5OwEvldhliINwAFLsEyyIfGKV+vm3eEehVqKTdNxtDiPoLHCRiuwTJxCECxMDqDjTvZ63KaPKvRgV2i/F3ohm88V8LN8hgJcXD5pVGIPPNn9EBqSQC0I4AMxBUcQNCkarkFgSn/oCs9GCVep4eUG5BRAOcQOCWlGSc3If0IFqRfURQGRrKewPKEJ9sLnIowKCcw+f48N6UHjqYtgInaCCkBbPSj8VEkCr2g8U43wY1xX/BNkwreQrzg+oaJghOCGTU8RBxuIp6VFOGoEXgEsBLIgV6gBgxoLSI5CgiYNT+GBHsU01GthrceiMUtv9KgAYktgVNeGrBbtiOQVi9x8WjiAW7UNUnm4Vet7WtsFgDCDYEwQ/EVL1PnQf/xCDLTowTh4c4HPRDoQaiwhKIAae4B7xgCBydI/CDPOrevK0FR4p6w3VfoXgQiB3T1N8Y1PCD0X19JqcHGfzB5WkQE4p/kdeXBcEVUXEIFqSij82lMyrWq/7c+LFHA7z5/dwOHHg8s/Y8C2CmhbmALtare+4UWLfb25BmXABKABTniC8gRAP2yvDAiUAsElnrxFzITQa/sAFecAOY7zPV/8jMQHSbWAiUPGkQNABhw85xrSCv+mMSzFR8+7mjw01A8f4F8S/td4jnDHYxpT8/OEyV3gz2+GTfdAeAszswfJNGlQhEIjB0Bls0BKn4Iw7WKu9f1gmSagmvqleEwJwnZwjO7npz1HdCJ1hS/mlBcRXyF3i/M7NxqJFoeH27z7nnJaBmpUZKHsTbGUc1ALEoIGsGYl9ixS50gjAT/VhB8IzvGTrBVfWEz1MzAkRFTtecW731VdjNQPukVdhdn0Y8d/a7WYH6i/TBPBzUFwAlHwtGHOQISrgb1AMUgDETTA3+THAdeRJhg59V/Ektofa9I8wxVICkC7QQSAd2O3cftzPzdMK6aA4iZI4ILfYRbb9RgqICt2AxVnYZ4kkBvHOBxT/zN9ybHx/f5Ql2fkGCX6ANm6F8WCfqAS+Eq5AGcHJd2IFHagTMHAAj+mWBnDXuc81CjhsAi5dL2K8QCYI1aJ/PJtSSxEFXASv7C2I3ZB9/a0j/7nDn/j1pHsz9Jr8fNpxPBUAUUYD4wz5GBlmyAiORjtAIGDFwzSUwqiNZ1d1tPiB7/Q9VeI9KeJU16/knkEeQJEALjY4rkp74fCZiMDSA/PgvT/aT2gYgp5E/P29AKBQAo6TRth5T4VesQFb0i4K7RA2MZpgyFXCEQHCOixuYMPgy2L7+45ezSSKt2oUkURlpXkEMOLSiXPuDQZjk63N5bmzOSxQdLHX7AhwUEA0BAeQPJIQzkAuFlOK/GtyLdiGDKEBdllQ7YouxV2Xdwza9So4Kp5Z0yAgUhTlJgFzSFrznIHYIwKcCu2/L3LsCg6UI1b1/CA+ApIV5/32HqOIjdQusE4azip5Wc1b0q/QGIAlaWEJbXP3r/L+AEipw/+BtkQVY9fIM2i/ZhgVEgJO6DZ1ksVtlYdoQAPhVO0oKmYBmnAYco4DRCRB3TwCziptaE0auER9/VzRqKNOEYINOQg2m1l9GpGNQAhh1v6UmxNQh2M4+LmlUzll0OTjYQOaGlZAEMCrdhmBphaMBwBADrSQQc3//He8KgFETT7p6BHnjj2X9EXsDjrgBS6ihoAmcSQVYmE4JgYWFpp1waAQRoqDzxDhU+HxSnZHz/9JEY6Y5MJA+cwoWrt99+U3Mc/9g/NQTFaigAEtwB1yBzwzucZSX7RZEILhR1d5GDCsBLVUdIQvsldZfEJt5i/MHx2hGJZFkVVyK242iFeh58oBUFqIQbkfp2DV2X0CkAYgv1sU+P+I/HmBu8nErugdRnUWhfp+A/ddlbEH3uQlBsNobUEMHasK1HOYn8BEEvCUaiuigXRIKj+sGOPA4KAWz9/s7WxcgB4+a6/fI2osEwv4yOENAiPf+wQhbc/5f0gGisWuQaRFmGoIqguARWsBQgTTocDLMT5OJUQnhqdCEig+/EShKSEgTVV0MBMnz04BcshPnLk/+OaV0/dwKzB4QUt1NB6uTDfGOP+cNm9mEsBAFiM7AQh9AKVEU75vy68jeOxrUC4mDEuYO0oLqoSdHaEF2eXYYSm0V+oEOwpLmYFOF3Z4CmAeBTIGueiIw2xoKPzDBJVBXQ5g5O8/twwA+QguIjJt3+g0NQEcDfUXgO5gsqlTBLkQLdl86K3CWneitQ8sg/5oWAUJP2C3V3RoEyji5n4b9lB4t9pz2CA+cAFn1Z9I/uzYsU/ELtEBOCHYQQqGcFejV+yeuRJX31zsKV5IGjway9z6PLDxKwNEPsBuOEiqw57jGgOtZ1Y++T50AuMFl7hPIbhskiOwsATtRoc7rS7dXrpcgrMCGJca6ELJo+Y0be0BW5ZKGcFz4y8W9BduwcDnK9iO5fagsKpp9ANnvDPxeP8THNyIVFo1AMas8Qk5v2Ytm0LCCYAXqn+wQsPTBh/5Bcnne14Os3uCQt28vsK1WUESJFviBgAW//3u9PLxusXchcCR2WsNzv/ImvgZzzkUByDUAIrjTvmSHAowpJBQE4SUlxMxnARlQbIqkArVAJ6pBBvELCCKlkyCDAP45BYfEPfcUpfMch3Vn4bheYK4E66BxAxHSVd5INgEPgU/NBCDfNQ8Ho1CoINAPQAW/QT8OCIZlNFCB84XhoDChFByHGjx35v9BLgyhmojqHYb5QYXnuAecvua0hZe6BV9f7v4ibvgvamrmAc1TmaEir0LQ9h97eYAYVoM/nWA60i8Q3Ifezha9BqaaL3zvqd6IAuwwLSCCuCLuJWch4h30giPtyiAphKEBcCu9BV5wwzkMxID8rhMwdwMhcSFgrBT3RUTQboAUg3+p+Qe1IGarOioVnazmefV3lHpwA0AcLWCahUiXwePHWJsP+GH1gnp/we5KfOhJAbsj0H/BIEb04TbrTPsAyb2LLu93KwfCvn5PLAwrOXAa72eEQRo1CNdw5IprsAZ3hApy9zlcITG2vpCihsRSYxNS+J4vdBZ6B52eqRcQ/QXmSjAWSfa/5GA5qEg4iJFtm624AqXLrSA2gx8p1Mdqcghv41S0lSp/xAYs9gakQc4Ie2RTUYwYgt748mV+FU1Xgp14eW3XYZ6cdqGTNHwHICTwEeTPl0jEZwIgP9gDEaogeg5IHWCF+1eoAhvEKPB/EAeTRsM/pSAP5wjWEUMM1/NJRhwJbpJSgK7S7zF3EOsI5jBQBK9DV80Z8Y0COzvmWzJXgDl40KEC6cqvqgi4OB5cpgLFYK/1CvDiItXqC6/S87wfAUfPtxqfGNzlYaOjlf1IsHPPvffHgDAoEeEST4ZLZUd/RSo91/BjXY5ggWgQ4In3fyj4mUqPrInHOCLKO3wUwRsfyXpt1nEIRLrqcWeTuk7bigsbid1zD4iDRQtnIdQsyIXnFCn1I9D7ADgxEhOvR5AJosoUbu1FkJyYCi9OhQERoIx+4AX/YqUXQhtYEwKN4Cy1HntLMmtaAQpqfrT/UCoLSxeswjA5UWPPi0mjajUWxMTdVusNvt/ChMdmILK5IRMFu90BMEzFYHdg2GAgeYVHMMJIBTA7EFTx/5fpgTFXz9w/en0ZjD8kCDoKPNGwlB01BmoWQbh+AxR689mBponGJOr9OwmMu3dtJ/ylW1Tik4ElUPmR9RqII+pVhD9ychABMQ51gOIZg+/G+5mGIzLB1JJC5WhzYjhJ7IWmLDpA8jzsAafUPkB2WnFBF4iSxkq1ty7f25rv/+EQLOxs2oUdTSA9HIR9swdBlCcFe9owPC3XWDDC0ISVzsEVbSCF/sWdA5Fu4HJqankp2SeQCYYrImNalfmhpVxYrGkUS4LeSUjg8dD7+D7w/ybIfy7vlB9/HJ978zr7/45Qgajzj+4EjIK/ULHPRAOlKr/aG0AFcqCyu0GcW45Igh6JMJmhA49/U+cEssHNJhtXDC1MOya3j/sAiAGcrEtqtgjBD6wEzSDc7D8o6C8rIqAZyPk+NQoNLAZ1hR64Yl1FBY648smUYKnSg1Xwk/0DyRyArByMUobyByhCcPnOaPyoegREFS4jNfYAw+IHCjdC1J2WDZBke/OyN85J24WiXwDYPoJyYuCD238ulvuzwt6KgHf0shWKsqCFFGjB/w8HU8eeTED9wAAAAABJRU5ErkJggg==",Lo=0,Ai=function(r){if(!r.environmentBRDFTexture){var n=r.useDelayedTextureLoading;r.useDelayedTextureLoading=!1;var e=r._blockEntityCollection;r._blockEntityCollection=!1;var t=X.CreateFromBase64String(Mo,"EnvironmentBRDFTexture"+Lo++,r,!0,!1,X.BILINEAR_SAMPLINGMODE);r._blockEntityCollection=e;var i=r.getEngine().getLoadedTexturesCache(),o=i.indexOf(t.getInternalTexture());o!==-1&&i.splice(o,1),t.isRGBD=!0,t.wrapU=X.CLAMP_ADDRESSMODE,t.wrapV=X.CLAMP_ADDRESSMODE,r.environmentBRDFTexture=t,r.useDelayedTextureLoading=n,xi.ExpandRGBDTexture(t);var a=r.getEngine().onContextRestoredObservable.add(function(){t.isRGBD=!0;var s=function(){t.isReady()?xi.ExpandRGBDTexture(t):z.SetImmediate(s)};s()});r.onDisposeObservable.add(function(){r.getEngine().onContextRestoredObservable.remove(a)})}return r.environmentBRDFTexture},cr=function(){function r(n,e,t,i,o){this.getWidth=n,this.getHeight=e,this.layer=t,this.layerType=i,this.createRenderTargetTextureProvider=o}return Object.defineProperty(r.prototype,"isFixedFoveationSupported",{get:function(){return this.layerType=="XRWebGLLayer"&&typeof this.layer.fixedFoveation=="number"},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"fixedFoveation",{get:function(){return this.isFixedFoveationSupported?this.layer.fixedFoveation:null},set:function(n){if(this.isFixedFoveationSupported){var e=Math.max(0,Math.min(1,n||0));this.layer.fixedFoveation=e}},enumerable:!1,configurable:!0}),r}(),Fo=function(r){R(n,r);function n(e,t){t===void 0&&(t=512);var i=r.call(this,"multiview rtt",t,e,!1,!0,0,!1,void 0,!1,!1,!0,void 0,!0)||this;return i._renderTarget=i.getScene().getEngine().createMultiviewRenderTargetTexture(i.getRenderWidth(),i.getRenderHeight()),i._texture=i._renderTarget.texture,i._texture.isMultiview=!0,i._texture.format=5,i.samples=i._getEngine().getCaps().maxSamples||i.samples,i}return Object.defineProperty(n.prototype,"samples",{set:function(e){this._samples=e},enumerable:!1,configurable:!0}),n.prototype._bindFrameBuffer=function(){!this._renderTarget||this.getScene().getEngine().bindMultiviewFramebuffer(this._renderTarget)},n.prototype.getViewCount=function(){return 2},n}(Vt),lr=function(){function r(n,e){this._scene=n,this.layerWrapper=e,this._renderTargetTextures=new Array,this._engine=n.getEngine()}return r.prototype._createInternalTexture=function(n,e){var t=new Wr(this._engine,Zi.Unknown,!0);return t.width=n.width,t.height=n.height,t._hardwareTexture=new Kr(e,this._engine._gl),t.isReady=!0,t},r.prototype._createRenderTargetTexture=function(n,e,t,i,o,a){if(!this._engine)throw new Error("Engine is disposed");var s={width:n,height:e},c=a?new Fo(this._scene,s):new Vt("XR renderTargetTexture",s,this._scene),l=c.renderTarget;if((t||!i)&&(l._framebuffer=t),i)if(a)l._colorTextureArray=i;else{var u=this._createInternalTexture(s,i);l.setTexture(u,0),c._texture=u}return o&&(a?l._depthStencilTextureArray=o:l._depthStencilTexture=this._createInternalTexture(s,o)),c.disableRescaling(),typeof XRWebGLBinding!="undefined"&&(c.skipInitialClear=!0),this._renderTargetTextures.push(c),c},r.prototype._destroyRenderTargetTexture=function(n){this._renderTargetTextures.splice(this._renderTargetTextures.indexOf(n),1),n.dispose()},r.prototype.getFramebufferDimensions=function(){return this._framebufferDimensions},r.prototype.dispose=function(){this._renderTargetTextures.forEach(function(n){return n.dispose()}),this._renderTargetTextures.length=0},r}(),ur=function(r){R(n,r);function n(e){var t=r.call(this,function(){return e.framebufferWidth},function(){return e.framebufferHeight},e,"XRWebGLLayer",function(i){return new Do(i.scene,t)})||this;return t.layer=e,t}return n}(cr),Do=function(r){R(n,r);function n(e,t){var i=r.call(this,e,t)||this;return i.layerWrapper=t,i._layer=t.layer,i._framebufferDimensions={framebufferWidth:i._layer.framebufferWidth,framebufferHeight:i._layer.framebufferHeight},i}return n.prototype.trySetViewportForView=function(e,t){var i=this._layer.getViewport(t),o=this._framebufferDimensions.framebufferWidth,a=this._framebufferDimensions.framebufferHeight;return e.x=i.x/o,e.y=i.y/a,e.width=i.width/o,e.height=i.height/a,!0},n.prototype.getRenderTargetTextureForEye=function(e){var t=this._layer.framebufferWidth,i=this._layer.framebufferHeight,o=this._layer.framebuffer;return(!this._rtt||t!==this._framebufferDimensions.framebufferWidth||i!==this._framebufferDimensions.framebufferHeight||o!==this._framebuffer)&&(this._rtt=this._createRenderTargetTexture(t,i,o),this._framebufferDimensions.framebufferWidth=t,this._framebufferDimensions.framebufferHeight=i,this._framebuffer=o),this._rtt},n.prototype.getRenderTargetTextureForView=function(e){return this.getRenderTargetTextureForEye(e.eye)},n}(lr),fr=function(){function r(){}return r.GetDefaults=function(n){var e=new r;return e.canvasOptions={antialias:!0,depth:!0,stencil:n?n.isStencilEnable:!0,alpha:!0,multiview:!1,framebufferScaleFactor:1},e.newCanvasCssStyle="position:absolute; bottom:0px;right:0px;z-index:10;width:90%;height:100%;background-color: #000000;",e},r}(),Bo=function(){function r(n,e){e===void 0&&(e=fr.GetDefaults());var t=this;if(this._options=e,this._canvas=null,this._engine=null,this.xrLayer=null,this._xrLayerWrapper=null,this.onXRLayerInitObservable=new U,this._engine=n.scene.getEngine(),this._engine.onDisposeObservable.addOnce(function(){t._engine=null}),e.canvasElement)this._setManagedOutputCanvas(e.canvasElement);else{var i=document.createElement("canvas");i.style.cssText=this._options.newCanvasCssStyle||"position:absolute; bottom:0px;right:0px;",this._setManagedOutputCanvas(i)}n.onXRSessionInit.add(function(){t._addCanvas()}),n.onXRSessionEnded.add(function(){t._removeCanvas()})}return r.prototype.dispose=function(){this._removeCanvas(),this._setManagedOutputCanvas(null)},r.prototype.initializeXRLayerAsync=function(n){return it(this,void 0,void 0,function(){var e,t=this;return rt(this,function(i){return e=function(){return t.xrLayer=new XRWebGLLayer(n,t.canvasContext,t._options.canvasOptions),t._xrLayerWrapper=new ur(t.xrLayer),t.onXRLayerInitObservable.notifyObservers(t.xrLayer),t.xrLayer},this.canvasContext.makeXRCompatible?[2,this.canvasContext.makeXRCompatible().then(function(){},function(){z.Warn("Error executing makeXRCompatible. This does not mean that the session will work incorrectly.")}).then(function(){return e()})]:[2,Promise.resolve(e())]})})},r.prototype._addCanvas=function(){var n=this;this._canvas&&this._engine&&this._canvas!==this._engine.getRenderingCanvas()&&document.body.appendChild(this._canvas),this.xrLayer?this._setCanvasSize(!0):this.onXRLayerInitObservable.addOnce(function(){n._setCanvasSize(!0)})},r.prototype._removeCanvas=function(){this._canvas&&this._engine&&document.body.contains(this._canvas)&&this._canvas!==this._engine.getRenderingCanvas()&&document.body.removeChild(this._canvas),this._setCanvasSize(!1)},r.prototype._setCanvasSize=function(n,e){n===void 0&&(n=!0),e===void 0&&(e=this._xrLayerWrapper),!(!this._canvas||!this._engine)&&(n?e&&(this._canvas!==this._engine.getRenderingCanvas()?(this._canvas.style.width=e.getWidth()+"px",this._canvas.style.height=e.getHeight()+"px"):this._engine.setSize(e.getWidth(),e.getHeight())):this._originalCanvasSize&&(this._canvas!==this._engine.getRenderingCanvas()?(this._canvas.style.width=this._originalCanvasSize.width+"px",this._canvas.style.height=this._originalCanvasSize.height+"px"):this._engine.setSize(this._originalCanvasSize.width,this._originalCanvasSize.height)))},r.prototype._setManagedOutputCanvas=function(n){this._removeCanvas(),n?(this._originalCanvasSize={width:n.offsetWidth,height:n.offsetHeight},this._canvas=n,this.canvasContext=this._canvas.getContext("webgl2"),this.canvasContext||(this.canvasContext=this._canvas.getContext("webgl"))):(this._canvas=null,this.canvasContext=null)},r}(),wo=function(r){R(n,r);function n(e){var t=r.call(this,function(){return e.framebufferWidth},function(){return e.framebufferHeight},e,"XRWebGLLayer",function(i){return new Vo(i,t)})||this;return t.layer=e,t}return n}(cr),Vo=function(r){R(n,r);function n(e,t){var i=r.call(this,e.scene,t)||this;return i.layerWrapper=t,i._nativeRTTProvider=navigator.xr.getNativeRenderTargetProvider(e.session,i._createRenderTargetTexture.bind(i),i._destroyRenderTargetTexture.bind(i)),i._nativeLayer=t.layer,i}return n.prototype.trySetViewportForView=function(e){return e.x=0,e.y=0,e.width=1,e.height=1,!0},n.prototype.getRenderTargetTextureForEye=function(e){return this._nativeRTTProvider.getRenderTargetForEye(e)},n.prototype.getRenderTargetTextureForView=function(e){return this._nativeRTTProvider.getRenderTargetForEye(e.eye)},n.prototype.getFramebufferDimensions=function(){return{framebufferWidth:this._nativeLayer.framebufferWidth,framebufferHeight:this._nativeLayer.framebufferHeight}},n}(lr),Uo=function(){function r(n){this._nativeRenderTarget=navigator.xr.getWebXRRenderTarget(n.scene.getEngine())}return r.prototype.initializeXRLayerAsync=function(n){return it(this,void 0,void 0,function(){return rt(this,function(e){switch(e.label){case 0:return[4,this._nativeRenderTarget.initializeXRLayerAsync(n)];case 1:return e.sent(),this.xrLayer=this._nativeRenderTarget.xrLayer,[2,this.xrLayer]}})})},r.prototype.dispose=function(){},r}(),ko=function(){function r(n){var e=this;this.scene=n,this.currentTimestamp=-1,this.defaultHeightCompensation=1.7,this.onXRFrameObservable=new U,this.onXRReferenceSpaceChanged=new U,this.onXRSessionEnded=new U,this.onXRSessionInit=new U,this.inXRFrameLoop=!1,this.inXRSession=!1,this._engine=n.getEngine(),this._onEngineDisposedObserver=this._engine.onDisposeObservable.addOnce(function(){e._engine=null}),n.onDisposeObservable.addOnce(function(){e.dispose()})}return Object.defineProperty(r.prototype,"referenceSpace",{get:function(){return this._referenceSpace},set:function(n){this._referenceSpace=n,this.onXRReferenceSpaceChanged.notifyObservers(this._referenceSpace)},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"sessionMode",{get:function(){return this._sessionMode},enumerable:!1,configurable:!0}),r.prototype.dispose=function(){var n;this.inXRSession&&this.exitXRAsync(),this.onXRFrameObservable.clear(),this.onXRSessionEnded.clear(),this.onXRReferenceSpaceChanged.clear(),this.onXRSessionInit.clear(),(n=this._engine)===null||n===void 0||n.onDisposeObservable.remove(this._onEngineDisposedObserver),this._engine=null},r.prototype.exitXRAsync=function(){return this.session&&this.inXRSession?(this.inXRSession=!1,this.session.end().catch(function(){ne.Warn("Could not end XR session.")})):Promise.resolve()},r.prototype.trySetViewportForView=function(n,e){var t;return((t=this._baseLayerRTTProvider)===null||t===void 0?void 0:t.trySetViewportForView(n,e))||!1},r.prototype.getRenderTargetTextureForEye=function(n){var e;return((e=this._baseLayerRTTProvider)===null||e===void 0?void 0:e.getRenderTargetTextureForEye(n))||null},r.prototype.getRenderTargetTextureForView=function(n){var e;return((e=this._baseLayerRTTProvider)===null||e===void 0?void 0:e.getRenderTargetTextureForView(n))||null},r.prototype.getWebXRRenderTarget=function(n){var e=this.scene.getEngine();return this._xrNavigator.xr.native?new Uo(this):(n=n||fr.GetDefaults(e),n.canvasElement=n.canvasElement||e.getRenderingCanvas()||void 0,new Bo(this,n))},r.prototype.initializeAsync=function(){return this._xrNavigator=navigator,this._xrNavigator.xr?Promise.resolve():Promise.reject("WebXR not available")},r.prototype.initializeSessionAsync=function(n,e){var t=this;return n===void 0&&(n="immersive-vr"),e===void 0&&(e={}),this._xrNavigator.xr.requestSession(n,e).then(function(i){return t.session=i,t._sessionMode=n,t.onXRSessionInit.notifyObservers(i),t.inXRSession=!0,t.session.addEventListener("end",function(){var o;t.inXRSession=!1,t.onXRSessionEnded.notifyObservers(null),t._engine&&(t._engine.framebufferDimensionsObject=null,t._engine.restoreDefaultFramebuffer(),t._engine.customAnimationFrameRequester=null,t._engine._renderLoop()),t.isNative&&((o=t._baseLayerRTTProvider)===null||o===void 0||o.dispose()),t._baseLayerRTTProvider=null,t._baseLayerWrapper=null},{once:!0}),t.session})},r.prototype.isSessionSupportedAsync=function(n){return r.IsSessionSupportedAsync(n)},r.prototype.resetReferenceSpace=function(){this.referenceSpace=this.baseReferenceSpace},r.prototype.runXRRenderLoop=function(){var n=this,e;!this.inXRSession||!this._engine||(this._engine.customAnimationFrameRequester={requestAnimationFrame:this.session.requestAnimationFrame.bind(this.session),renderFunction:function(t,i){var o;!n.inXRSession||!n._engine||(n.currentFrame=i,n.currentTimestamp=t,i&&(n.inXRFrameLoop=!0,n._engine.framebufferDimensionsObject=((o=n._baseLayerRTTProvider)===null||o===void 0?void 0:o.getFramebufferDimensions())||null,n.onXRFrameObservable.notifyObservers(i),n._engine._renderLoop(),n._engine.framebufferDimensionsObject=null,n.inXRFrameLoop=!1))}},this._engine.framebufferDimensionsObject=((e=this._baseLayerRTTProvider)===null||e===void 0?void 0:e.getFramebufferDimensions())||null,typeof window!="undefined"&&window.cancelAnimationFrame&&window.cancelAnimationFrame(this._engine._frameHandler),this._engine._renderLoop())},r.prototype.setReferenceSpaceTypeAsync=function(n){var e=this;return n===void 0&&(n="local-floor"),this.session.requestReferenceSpace(n).then(function(t){return t},function(t){return ne.Error("XR.requestReferenceSpace failed for the following reason: "),ne.Error(t),ne.Log('Defaulting to universally-supported "viewer" reference space type.'),e.session.requestReferenceSpace("viewer").then(function(i){var o=new XRRigidTransform({x:0,y:-e.defaultHeightCompensation,z:0});return i.getOffsetReferenceSpace(o)},function(i){throw ne.Error(i),'XR initialization failed: required "viewer" reference space type not supported.'})}).then(function(t){return e.session.requestReferenceSpace("viewer").then(function(i){return e.viewerReferenceSpace=i,t})}).then(function(t){return e.referenceSpace=e.baseReferenceSpace=t,e.referenceSpace})},r.prototype.updateRenderStateAsync=function(n){return Promise.resolve(this.session.updateRenderState(n))},r.prototype._setBaseLayerWrapper=function(n){var e,t;this.isNative&&((e=this._baseLayerRTTProvider)===null||e===void 0||e.dispose()),this._baseLayerWrapper=n,this._baseLayerRTTProvider=((t=this._baseLayerWrapper)===null||t===void 0?void 0:t.createRenderTargetTextureProvider(this))||null},r.prototype.updateRenderState=function(n){n.baseLayer&&this._setBaseLayerWrapper(this.isNative?new wo(n.baseLayer):new ur(n.baseLayer)),this.session.updateRenderState(n)},r.IsSessionSupportedAsync=function(n){if(!navigator.xr)return Promise.resolve(!1);var e=navigator.xr.isSessionSupported||navigator.xr.supportsSession;return e?e.call(navigator.xr,n).then(function(t){var i=typeof t=="undefined"?!0:t;return Promise.resolve(i)}).catch(function(t){return ne.Warn(t),Promise.resolve(!1)}):Promise.resolve(!1)},Object.defineProperty(r.prototype,"isNative",{get:function(){var n;return(n=this._xrNavigator.xr.native)!==null&&n!==void 0?n:!1},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"currentFrameRate",{get:function(){var n;return(n=this.session)===null||n===void 0?void 0:n.frameRate},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"supportedFrameRates",{get:function(){var n;return(n=this.session)===null||n===void 0?void 0:n.supportedFrameRates},enumerable:!1,configurable:!0}),r.prototype.updateTargetFrameRate=function(n){return this.session.updateTargetFrameRate(n)},r.prototype.runInXRFrame=function(n,e){e===void 0&&(e=!0),this.inXRFrameLoop?n():(this.inXRSession||!e)&&this.onXRFrameObservable.addOnce(n)},Object.defineProperty(r.prototype,"isFixedFoveationSupported",{get:function(){var n;return((n=this._baseLayerWrapper)===null||n===void 0?void 0:n.isFixedFoveationSupported)||!1},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"fixedFoveation",{get:function(){var n;return((n=this._baseLayerWrapper)===null||n===void 0?void 0:n.fixedFoveation)||null},set:function(n){var e=Math.max(0,Math.min(1,n||0));this._baseLayerWrapper&&(this._baseLayerWrapper.fixedFoveation=e)},enumerable:!1,configurable:!0}),r}(),hr=function(){function r(){this.keysUp=[38],this.keysUpward=[33],this.keysDown=[40],this.keysDownward=[34],this.keysLeft=[37],this.keysRight=[39],this.rotationSpeed=.5,this.keysRotateLeft=[],this.keysRotateRight=[],this._keys=new Array}return r.prototype.attachControl=function(n){var e=this;n=z.BackCompatCameraNoPreventDefault(arguments),!this._onCanvasBlurObserver&&(this._scene=this.camera.getScene(),this._engine=this._scene.getEngine(),this._onCanvasBlurObserver=this._engine.onCanvasBlurObservable.add(function(){e._keys=[]}),this._onKeyboardObserver=this._scene.onKeyboardObservable.add(function(t){var i=t.event;if(!i.metaKey){if(t.type===Qr.KEYDOWN){if(e.keysUp.indexOf(i.keyCode)!==-1||e.keysDown.indexOf(i.keyCode)!==-1||e.keysLeft.indexOf(i.keyCode)!==-1||e.keysRight.indexOf(i.keyCode)!==-1||e.keysUpward.indexOf(i.keyCode)!==-1||e.keysDownward.indexOf(i.keyCode)!==-1||e.keysRotateLeft.indexOf(i.keyCode)!==-1||e.keysRotateRight.indexOf(i.keyCode)!==-1){var o=e._keys.indexOf(i.keyCode);o===-1&&e._keys.push(i.keyCode),n||i.preventDefault()}}else if(e.keysUp.indexOf(i.keyCode)!==-1||e.keysDown.indexOf(i.keyCode)!==-1||e.keysLeft.indexOf(i.keyCode)!==-1||e.keysRight.indexOf(i.keyCode)!==-1||e.keysUpward.indexOf(i.keyCode)!==-1||e.keysDownward.indexOf(i.keyCode)!==-1||e.keysRotateLeft.indexOf(i.keyCode)!==-1||e.keysRotateRight.indexOf(i.keyCode)!==-1){var o=e._keys.indexOf(i.keyCode);o>=0&&e._keys.splice(o,1),n||i.preventDefault()}}}))},r.prototype.detachControl=function(){this._scene&&(this._onKeyboardObserver&&this._scene.onKeyboardObservable.remove(this._onKeyboardObserver),this._onCanvasBlurObserver&&this._engine.onCanvasBlurObservable.remove(this._onCanvasBlurObserver),this._onKeyboardObserver=null,this._onCanvasBlurObserver=null),this._keys=[]},r.prototype.checkInputs=function(){if(this._onKeyboardObserver)for(var n=this.camera,e=0;e<this._keys.length;e++){var t=this._keys[e],i=n._computeLocalCameraSpeed();this.keysLeft.indexOf(t)!==-1?n._localDirection.copyFromFloats(-i,0,0):this.keysUp.indexOf(t)!==-1?n._localDirection.copyFromFloats(0,0,i):this.keysRight.indexOf(t)!==-1?n._localDirection.copyFromFloats(i,0,0):this.keysDown.indexOf(t)!==-1?n._localDirection.copyFromFloats(0,0,-i):this.keysUpward.indexOf(t)!==-1?n._localDirection.copyFromFloats(0,i,0):this.keysDownward.indexOf(t)!==-1?n._localDirection.copyFromFloats(0,-i,0):this.keysRotateLeft.indexOf(t)!==-1?(n._localDirection.copyFromFloats(0,0,0),n.cameraRotation.y-=this._getLocalRotation()):this.keysRotateRight.indexOf(t)!==-1&&(n._localDirection.copyFromFloats(0,0,0),n.cameraRotation.y+=this._getLocalRotation()),n.getScene().useRightHandedSystem&&(n._localDirection.z*=-1),n.getViewMatrix().invertToRef(n._cameraTransformMatrix),y.TransformNormalToRef(n._localDirection,n._cameraTransformMatrix,n._transformedDirection),n.cameraDirection.addInPlace(n._transformedDirection)}},r.prototype.getClassName=function(){return"FreeCameraKeyboardMoveInput"},r.prototype._onLostFocus=function(){this._keys=[]},r.prototype.getSimpleName=function(){return"keyboard"},r.prototype._getLocalRotation=function(){var n=this.rotationSpeed*this._engine.getDeltaTime()/1e3;return this.camera.getScene().useRightHandedSystem&&(n*=-1),this.camera.parent&&this.camera.parent._getWorldMatrixDeterminant()<0&&(n*=-1),n},E([T()],r.prototype,"keysUp",void 0),E([T()],r.prototype,"keysUpward",void 0),E([T()],r.prototype,"keysDown",void 0),E([T()],r.prototype,"keysDownward",void 0),E([T()],r.prototype,"keysLeft",void 0),E([T()],r.prototype,"keysRight",void 0),E([T()],r.prototype,"rotationSpeed",void 0),E([T()],r.prototype,"keysRotateLeft",void 0),E([T()],r.prototype,"keysRotateRight",void 0),r}();It.FreeCameraKeyboardMoveInput=hr;var dr=function(){function r(n){n===void 0&&(n=!0),this.touchEnabled=n,this.buttons=[0,1,2],this.angularSensibility=2e3,this._previousPosition=null,this.onPointerMovedObservable=new U,this._allowCameraRotation=!0,this._currentActiveButton=-1}return r.prototype.attachControl=function(n){var e=this;n=z.BackCompatCameraNoPreventDefault(arguments);var t=this.camera.getEngine(),i=t.getInputElement();this._pointerInput||(this._pointerInput=function(o){var a=o.event,s=a.pointerType==="touch";if(!t.isInVRExclusivePointerMode&&!(!e.touchEnabled&&s)&&!(o.type!==Te.POINTERMOVE&&e.buttons.indexOf(a.button)===-1)){var c=a.srcElement||a.target;if(o.type===Te.POINTERDOWN&&(e._currentActiveButton===-1||s)){try{c==null||c.setPointerCapture(a.pointerId)}catch{}e._currentActiveButton===-1&&(e._currentActiveButton=a.button),e._previousPosition={x:a.clientX,y:a.clientY},n||(a.preventDefault(),i&&i.focus()),t.isPointerLock&&e._onMouseMove&&e._onMouseMove(o.event)}else if(o.type===Te.POINTERUP&&(e._currentActiveButton===a.button||s)){try{c==null||c.releasePointerCapture(a.pointerId)}catch{}e._currentActiveButton=-1,e._previousPosition=null,n||a.preventDefault()}else if(o.type===Te.POINTERMOVE){if(t.isPointerLock&&e._onMouseMove)e._onMouseMove(o.event);else if(e._previousPosition){var l=a.clientX-e._previousPosition.x,u=a.clientY-e._previousPosition.y;e.camera.getScene().useRightHandedSystem&&(l*=-1),e.camera.parent&&e.camera.parent._getWorldMatrixDeterminant()<0&&(l*=-1),e._allowCameraRotation&&(e.camera.cameraRotation.y+=l/e.angularSensibility,e.camera.cameraRotation.x+=u/e.angularSensibility),e.onPointerMovedObservable.notifyObservers({offsetX:l,offsetY:u}),e._previousPosition={x:a.clientX,y:a.clientY},n||a.preventDefault()}}}}),this._onMouseMove=function(o){if(!!t.isPointerLock&&!t.isInVRExclusivePointerMode){var a=o.movementX||o.mozMovementX||o.webkitMovementX||o.msMovementX||0;e.camera.getScene().useRightHandedSystem&&(a*=-1),e.camera.parent&&e.camera.parent._getWorldMatrixDeterminant()<0&&(a*=-1),e.camera.cameraRotation.y+=a/e.angularSensibility;var s=o.movementY||o.mozMovementY||o.webkitMovementY||o.msMovementY||0;e.camera.cameraRotation.x+=s/e.angularSensibility,e._previousPosition=null,n||o.preventDefault()}},this._observer=this.camera.getScene().onPointerObservable.add(this._pointerInput,Te.POINTERDOWN|Te.POINTERUP|Te.POINTERMOVE),i&&(this._contextMenuBind=this.onContextMenu.bind(this),i.addEventListener("contextmenu",this._contextMenuBind,!1))},r.prototype.onContextMenu=function(n){n.preventDefault()},r.prototype.detachControl=function(){if(this._observer){if(this.camera.getScene().onPointerObservable.remove(this._observer),this._contextMenuBind){var n=this.camera.getEngine(),e=n.getInputElement();e&&e.removeEventListener("contextmenu",this._contextMenuBind)}this.onPointerMovedObservable&&this.onPointerMovedObservable.clear(),this._observer=null,this._onMouseMove=null,this._previousPosition=null}this._currentActiveButton=-1},r.prototype.getClassName=function(){return"FreeCameraMouseInput"},r.prototype.getSimpleName=function(){return"mouse"},E([T()],r.prototype,"buttons",void 0),E([T()],r.prototype,"angularSensibility",void 0),r}();It.FreeCameraMouseInput=dr;var Go=function(){function r(){this.wheelPrecisionX=3,this.wheelPrecisionY=3,this.wheelPrecisionZ=3,this.onChangedObservable=new U,this._wheelDeltaX=0,this._wheelDeltaY=0,this._wheelDeltaZ=0,this._ffMultiplier=12,this._normalize=120}return r.prototype.attachControl=function(n){var e=this;n=z.BackCompatCameraNoPreventDefault(arguments),this._wheel=function(t){if(t.type===Te.POINTERWHEEL){var i=t.event,o=i.deltaMode===qr.DOM_DELTA_LINE?e._ffMultiplier:1;i.deltaY!==void 0?(e._wheelDeltaX+=e.wheelPrecisionX*o*i.deltaX/e._normalize,e._wheelDeltaY-=e.wheelPrecisionY*o*i.deltaY/e._normalize,e._wheelDeltaZ+=e.wheelPrecisionZ*o*i.deltaZ/e._normalize):i.wheelDeltaY!==void 0?(e._wheelDeltaX+=e.wheelPrecisionX*o*i.wheelDeltaX/e._normalize,e._wheelDeltaY-=e.wheelPrecisionY*o*i.wheelDeltaY/e._normalize,e._wheelDeltaZ+=e.wheelPrecisionZ*o*i.wheelDeltaZ/e._normalize):i.wheelDelta&&(e._wheelDeltaY-=e.wheelPrecisionY*i.wheelDelta/e._normalize),i.preventDefault&&(n||i.preventDefault())}},this._observer=this.camera.getScene().onPointerObservable.add(this._wheel,Te.POINTERWHEEL)},r.prototype.detachControl=function(){this._observer&&(this.camera.getScene().onPointerObservable.remove(this._observer),this._observer=null,this._wheel=null),this.onChangedObservable&&this.onChangedObservable.clear()},r.prototype.checkInputs=function(){this.onChangedObservable.notifyObservers({wheelDeltaX:this._wheelDeltaX,wheelDeltaY:this._wheelDeltaY,wheelDeltaZ:this._wheelDeltaZ}),this._wheelDeltaX=0,this._wheelDeltaY=0,this._wheelDeltaZ=0},r.prototype.getClassName=function(){return"BaseCameraMouseWheelInput"},r.prototype.getSimpleName=function(){return"mousewheel"},E([T()],r.prototype,"wheelPrecisionX",void 0),E([T()],r.prototype,"wheelPrecisionY",void 0),E([T()],r.prototype,"wheelPrecisionZ",void 0),r}(),se;(function(r){r[r.MoveRelative=0]="MoveRelative",r[r.RotateRelative=1]="RotateRelative",r[r.MoveScene=2]="MoveScene"})(se||(se={}));var pr=function(r){R(n,r);function n(){var e=r!==null&&r.apply(this,arguments)||this;return e._moveRelative=y.Zero(),e._rotateRelative=y.Zero(),e._moveScene=y.Zero(),e._wheelXAction=se.MoveRelative,e._wheelXActionCoordinate=Lt.X,e._wheelYAction=se.MoveRelative,e._wheelYActionCoordinate=Lt.Z,e._wheelZAction=null,e._wheelZActionCoordinate=null,e}return n.prototype.getClassName=function(){return"FreeCameraMouseWheelInput"},Object.defineProperty(n.prototype,"wheelXMoveRelative",{get:function(){return this._wheelXAction!==se.MoveRelative?null:this._wheelXActionCoordinate},set:function(e){e===null&&this._wheelXAction!==se.MoveRelative||(this._wheelXAction=se.MoveRelative,this._wheelXActionCoordinate=e)},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"wheelYMoveRelative",{get:function(){return this._wheelYAction!==se.MoveRelative?null:this._wheelYActionCoordinate},set:function(e){e===null&&this._wheelYAction!==se.MoveRelative||(this._wheelYAction=se.MoveRelative,this._wheelYActionCoordinate=e)},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"wheelZMoveRelative",{get:function(){return this._wheelZAction!==se.MoveRelative?null:this._wheelZActionCoordinate},set:function(e){e===null&&this._wheelZAction!==se.MoveRelative||(this._wheelZAction=se.MoveRelative,this._wheelZActionCoordinate=e)},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"wheelXRotateRelative",{get:function(){return this._wheelXAction!==se.RotateRelative?null:this._wheelXActionCoordinate},set:function(e){e===null&&this._wheelXAction!==se.RotateRelative||(this._wheelXAction=se.RotateRelative,this._wheelXActionCoordinate=e)},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"wheelYRotateRelative",{get:function(){return this._wheelYAction!==se.RotateRelative?null:this._wheelYActionCoordinate},set:function(e){e===null&&this._wheelYAction!==se.RotateRelative||(this._wheelYAction=se.RotateRelative,this._wheelYActionCoordinate=e)},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"wheelZRotateRelative",{get:function(){return this._wheelZAction!==se.RotateRelative?null:this._wheelZActionCoordinate},set:function(e){e===null&&this._wheelZAction!==se.RotateRelative||(this._wheelZAction=se.RotateRelative,this._wheelZActionCoordinate=e)},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"wheelXMoveScene",{get:function(){return this._wheelXAction!==se.MoveScene?null:this._wheelXActionCoordinate},set:function(e){e===null&&this._wheelXAction!==se.MoveScene||(this._wheelXAction=se.MoveScene,this._wheelXActionCoordinate=e)},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"wheelYMoveScene",{get:function(){return this._wheelYAction!==se.MoveScene?null:this._wheelYActionCoordinate},set:function(e){e===null&&this._wheelYAction!==se.MoveScene||(this._wheelYAction=se.MoveScene,this._wheelYActionCoordinate=e)},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"wheelZMoveScene",{get:function(){return this._wheelZAction!==se.MoveScene?null:this._wheelZActionCoordinate},set:function(e){e===null&&this._wheelZAction!==se.MoveScene||(this._wheelZAction=se.MoveScene,this._wheelZActionCoordinate=e)},enumerable:!1,configurable:!0}),n.prototype.checkInputs=function(){if(!(this._wheelDeltaX===0&&this._wheelDeltaY===0&&this._wheelDeltaZ==0)){this._moveRelative.setAll(0),this._rotateRelative.setAll(0),this._moveScene.setAll(0),this._updateCamera(),this.camera.getScene().useRightHandedSystem&&(this._moveRelative.z*=-1);var e=Q.Zero();this.camera.getViewMatrix().invertToRef(e);var t=y.Zero();y.TransformNormalToRef(this._moveRelative,e,t),this.camera.cameraRotation.x+=this._rotateRelative.x/200,this.camera.cameraRotation.y+=this._rotateRelative.y/200,this.camera.cameraDirection.addInPlace(t),this.camera.cameraDirection.addInPlace(this._moveScene),r.prototype.checkInputs.call(this)}},n.prototype._updateCamera=function(){this._updateCameraProperty(this._wheelDeltaX,this._wheelXAction,this._wheelXActionCoordinate),this._updateCameraProperty(this._wheelDeltaY,this._wheelYAction,this._wheelYActionCoordinate),this._updateCameraProperty(this._wheelDeltaZ,this._wheelZAction,this._wheelZActionCoordinate)},n.prototype._updateCameraProperty=function(e,t,i){if(e!==0&&!(t===null||i===null)){var o=null;switch(t){case se.MoveRelative:o=this._moveRelative;break;case se.RotateRelative:o=this._rotateRelative;break;case se.MoveScene:o=this._moveScene;break}switch(i){case Lt.X:o.set(e,0,0);break;case Lt.Y:o.set(0,e,0);break;case Lt.Z:o.set(0,0,e);break}}},E([T()],n.prototype,"wheelXMoveRelative",null),E([T()],n.prototype,"wheelYMoveRelative",null),E([T()],n.prototype,"wheelZMoveRelative",null),E([T()],n.prototype,"wheelXRotateRelative",null),E([T()],n.prototype,"wheelYRotateRelative",null),E([T()],n.prototype,"wheelZRotateRelative",null),E([T()],n.prototype,"wheelXMoveScene",null),E([T()],n.prototype,"wheelYMoveScene",null),E([T()],n.prototype,"wheelZMoveScene",null),n}(Go);It.FreeCameraMouseWheelInput=pr;var mr=function(){function r(n){n===void 0&&(n=!1),this.allowMouse=n,this.touchAngularSensibility=2e5,this.touchMoveSensibility=250,this.singleFingerRotate=!1,this._offsetX=null,this._offsetY=null,this._pointerPressed=new Array}return r.prototype.attachControl=function(n){var e=this;n=z.BackCompatCameraNoPreventDefault(arguments);var t=null;if(this._pointerInput===void 0&&(this._onLostFocus=function(){e._offsetX=null,e._offsetY=null},this._pointerInput=function(a){var s=a.event,c=!e.camera.getEngine().hostInformation.isMobile&&s instanceof MouseEvent;if(!(!e.allowMouse&&(s.pointerType==="mouse"||c))){if(a.type===Te.POINTERDOWN){if(n||s.preventDefault(),e._pointerPressed.push(s.pointerId),e._pointerPressed.length!==1)return;t={x:s.clientX,y:s.clientY}}else if(a.type===Te.POINTERUP){n||s.preventDefault();var l=e._pointerPressed.indexOf(s.pointerId);if(l===-1||(e._pointerPressed.splice(l,1),l!=0))return;t=null,e._offsetX=null,e._offsetY=null}else if(a.type===Te.POINTERMOVE){if(n||s.preventDefault(),!t)return;var l=e._pointerPressed.indexOf(s.pointerId);if(l!=0)return;e._offsetX=s.clientX-t.x,e._offsetY=-(s.clientY-t.y)}}}),this._observer=this.camera.getScene().onPointerObservable.add(this._pointerInput,Te.POINTERDOWN|Te.POINTERUP|Te.POINTERMOVE),this._onLostFocus){var i=this.camera.getEngine(),o=i.getInputElement();o&&o.addEventListener("blur",this._onLostFocus)}},r.prototype.detachControl=function(){if(this._pointerInput){if(this._observer&&(this.camera.getScene().onPointerObservable.remove(this._observer),this._observer=null),this._onLostFocus){var n=this.camera.getEngine(),e=n.getInputElement();e&&e.removeEventListener("blur",this._onLostFocus),this._onLostFocus=null}this._pointerPressed=[],this._offsetX=null,this._offsetY=null}},r.prototype.checkInputs=function(){if(!(this._offsetX===null||this._offsetY===null)&&!(this._offsetX===0&&this._offsetY===0)){var n=this.camera;n.cameraRotation.y=this._offsetX/this.touchAngularSensibility;var e=this.singleFingerRotate&&this._pointerPressed.length===1||!this.singleFingerRotate&&this._pointerPressed.length>1;if(e)n.cameraRotation.x=-this._offsetY/this.touchAngularSensibility;else{var t=n._computeLocalCameraSpeed(),i=new y(0,0,t*this._offsetY/this.touchMoveSensibility);Q.RotationYawPitchRollToRef(n.rotation.y,n.rotation.x,0,n._cameraRotationMatrix),n.cameraDirection.addInPlace(y.TransformCoordinates(i,n._cameraRotationMatrix))}}},r.prototype.getClassName=function(){return"FreeCameraTouchInput"},r.prototype.getSimpleName=function(){return"touch"},E([T()],r.prototype,"touchAngularSensibility",void 0),E([T()],r.prototype,"touchMoveSensibility",void 0),r}();It.FreeCameraTouchInput=mr;var _r=function(r){R(n,r);function n(e){var t=r.call(this,e)||this;return t._mouseInput=null,t._mouseWheelInput=null,t}return n.prototype.addKeyboard=function(){return this.add(new hr),this},n.prototype.addMouse=function(e){return e===void 0&&(e=!0),this._mouseInput||(this._mouseInput=new dr(e),this.add(this._mouseInput)),this},n.prototype.removeMouse=function(){return this._mouseInput&&this.remove(this._mouseInput),this},n.prototype.addMouseWheel=function(){return this._mouseWheelInput||(this._mouseWheelInput=new pr,this.add(this._mouseWheelInput)),this},n.prototype.removeMouseWheel=function(){return this._mouseWheelInput&&this.remove(this._mouseWheelInput),this},n.prototype.addTouch=function(){return this.add(new mr),this},n.prototype.clear=function(){r.prototype.clear.call(this),this._mouseInput=null},n}(Zr),Ut=function(r){R(n,r);function n(e,t,i,o){o===void 0&&(o=!0);var a=r.call(this,e,t,i,o)||this;return a.ellipsoid=new y(.5,1,.5),a.ellipsoidOffset=new y(0,0,0),a.checkCollisions=!1,a.applyGravity=!1,a._needMoveForGravity=!1,a._oldPosition=y.Zero(),a._diffPosition=y.Zero(),a._newPosition=y.Zero(),a._collisionMask=-1,a._onCollisionPositionChange=function(s,c,l){l===void 0&&(l=null);var u=function(f){a._newPosition.copyFrom(f),a._newPosition.subtractToRef(a._oldPosition,a._diffPosition),a._diffPosition.length()>j.CollisionsEpsilon&&(a.position.addInPlace(a._diffPosition),a.onCollide&&l&&a.onCollide(l))};u(c)},a.inputs=new _r(a),a.inputs.addKeyboard().addMouse(),a}return Object.defineProperty(n.prototype,"angularSensibility",{get:function(){var e=this.inputs.attached.mouse;return e?e.angularSensibility:0},set:function(e){var t=this.inputs.attached.mouse;t&&(t.angularSensibility=e)},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"keysUp",{get:function(){var e=this.inputs.attached.keyboard;return e?e.keysUp:[]},set:function(e){var t=this.inputs.attached.keyboard;t&&(t.keysUp=e)},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"keysUpward",{get:function(){var e=this.inputs.attached.keyboard;return e?e.keysUpward:[]},set:function(e){var t=this.inputs.attached.keyboard;t&&(t.keysUpward=e)},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"keysDown",{get:function(){var e=this.inputs.attached.keyboard;return e?e.keysDown:[]},set:function(e){var t=this.inputs.attached.keyboard;t&&(t.keysDown=e)},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"keysDownward",{get:function(){var e=this.inputs.attached.keyboard;return e?e.keysDownward:[]},set:function(e){var t=this.inputs.attached.keyboard;t&&(t.keysDownward=e)},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"keysLeft",{get:function(){var e=this.inputs.attached.keyboard;return e?e.keysLeft:[]},set:function(e){var t=this.inputs.attached.keyboard;t&&(t.keysLeft=e)},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"keysRight",{get:function(){var e=this.inputs.attached.keyboard;return e?e.keysRight:[]},set:function(e){var t=this.inputs.attached.keyboard;t&&(t.keysRight=e)},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"keysRotateLeft",{get:function(){var e=this.inputs.attached.keyboard;return e?e.keysRotateLeft:[]},set:function(e){var t=this.inputs.attached.keyboard;t&&(t.keysRotateLeft=e)},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"keysRotateRight",{get:function(){var e=this.inputs.attached.keyboard;return e?e.keysRotateRight:[]},set:function(e){var t=this.inputs.attached.keyboard;t&&(t.keysRotateRight=e)},enumerable:!1,configurable:!0}),n.prototype.attachControl=function(e,t){t=z.BackCompatCameraNoPreventDefault(arguments),this.inputs.attachElement(t)},n.prototype.detachControl=function(){this.inputs.detachElement(),this.cameraDirection=new y(0,0,0),this.cameraRotation=new Ge(0,0)},Object.defineProperty(n.prototype,"collisionMask",{get:function(){return this._collisionMask},set:function(e){this._collisionMask=isNaN(e)?-1:e},enumerable:!1,configurable:!0}),n.prototype._collideWithWorld=function(e){var t;this.parent?t=y.TransformCoordinates(this.position,this.parent.getWorldMatrix()):t=this.position,t.subtractFromFloatsToRef(0,this.ellipsoid.y,0,this._oldPosition),this._oldPosition.addInPlace(this.ellipsoidOffset);var i=this.getScene().collisionCoordinator;this._collider||(this._collider=i.createCollider()),this._collider._radius=this.ellipsoid,this._collider.collisionMask=this._collisionMask;var o=e;this.applyGravity&&(o=e.add(this.getScene().gravity)),i.getNewPosition(this._oldPosition,o,this._collider,3,null,this._onCollisionPositionChange,this.uniqueId)},n.prototype._checkInputs=function(){this._localDirection||(this._localDirection=y.Zero(),this._transformedDirection=y.Zero()),this.inputs.checkInputs(),r.prototype._checkInputs.call(this)},n.prototype._decideIfNeedsToMove=function(){return this._needMoveForGravity||Math.abs(this.cameraDirection.x)>0||Math.abs(this.cameraDirection.y)>0||Math.abs(this.cameraDirection.z)>0},n.prototype._updatePosition=function(){this.checkCollisions&&this.getScene().collisionsEnabled?this._collideWithWorld(this.cameraDirection):r.prototype._updatePosition.call(this)},n.prototype.dispose=function(){this.inputs.clear(),r.prototype.dispose.call(this)},n.prototype.getClassName=function(){return"FreeCamera"},E([rn()],n.prototype,"ellipsoid",void 0),E([rn()],n.prototype,"ellipsoidOffset",void 0),E([T()],n.prototype,"checkCollisions",void 0),E([T()],n.prototype,"applyGravity",void 0),n}(Ji),Ce;(function(r){r[r.ENTERING_XR=0]="ENTERING_XR",r[r.EXITING_XR=1]="EXITING_XR",r[r.IN_XR=2]="IN_XR",r[r.NOT_IN_XR=3]="NOT_IN_XR"})(Ce||(Ce={}));var yt;(function(r){r[r.NOT_TRACKING=0]="NOT_TRACKING",r[r.TRACKING_LOST=1]="TRACKING_LOST",r[r.TRACKING=2]="TRACKING"})(yt||(yt={}));var Ho=function(r){R(n,r);function n(e,t,i){var o=r.call(this,e,y.Zero(),t)||this;return o._xrSessionManager=i,o._firstFrame=!1,o._referenceQuaternion=q.Identity(),o._referencedPosition=new y,o._trackingState=yt.NOT_TRACKING,o.onBeforeCameraTeleport=new U,o.onAfterCameraTeleport=new U,o.onTrackingStateChanged=new U,o.compensateOnFirstFrame=!0,o._rotate180=new q(0,1,0,0),o.minZ=.1,o.rotationQuaternion=new q,o.cameraRigMode=sn.RIG_MODE_CUSTOM,o.updateUpVectorFromRotation=!0,o._updateNumberOfRigCameras(1),o.freezeProjectionMatrix(),o._xrSessionManager.onXRSessionInit.add(function(){o._referencedPosition.copyFromFloats(0,0,0),o._referenceQuaternion.copyFromFloats(0,0,0,1),o._firstFrame=o.compensateOnFirstFrame}),o._xrSessionManager.onXRFrameObservable.add(function(){o._firstFrame&&o._updateFromXRSession(),o._updateReferenceSpace(),o._updateFromXRSession()},void 0,!0),o}return Object.defineProperty(n.prototype,"trackingState",{get:function(){return this._trackingState},enumerable:!1,configurable:!0}),n.prototype._setTrackingState=function(e){this._trackingState!==e&&(this._trackingState=e,this.onTrackingStateChanged.notifyObservers(e))},Object.defineProperty(n.prototype,"realWorldHeight",{get:function(){var e=this._xrSessionManager.currentFrame&&this._xrSessionManager.currentFrame.getViewerPose(this._xrSessionManager.baseReferenceSpace);return e&&e.transform?e.transform.position.y:0},enumerable:!1,configurable:!0}),n.prototype._updateForDualEyeDebugging=function(){this._updateNumberOfRigCameras(2),this.rigCameras[0].viewport=new In(0,0,.5,1),this.rigCameras[0].outputRenderTarget=null,this.rigCameras[1].viewport=new In(.5,0,.5,1),this.rigCameras[1].outputRenderTarget=null},n.prototype.setTransformationFromNonVRCamera=function(e,t){if(e===void 0&&(e=this.getScene().activeCamera),t===void 0&&(t=!0),!(!e||e===this)){var i=e.computeWorldMatrix();i.decompose(void 0,this.rotationQuaternion,this.position),this.position.y=0,q.FromEulerAnglesToRef(0,this.rotationQuaternion.toEulerAngles().y,0,this.rotationQuaternion),this._firstFrame=!0,t&&this._xrSessionManager.resetReferenceSpace()}},n.prototype.getClassName=function(){return"WebXRCamera"},n.prototype.dispose=function(){r.prototype.dispose.call(this),this._lastXRViewerPose=void 0},n.prototype._updateFromXRSession=function(){var e=this,t=this._xrSessionManager.currentFrame&&this._xrSessionManager.currentFrame.getViewerPose(this._xrSessionManager.referenceSpace);if(this._lastXRViewerPose=t||void 0,!t){this._setTrackingState(yt.NOT_TRACKING);return}var i=t.emulatedPosition?yt.TRACKING_LOST:yt.TRACKING;if(this._setTrackingState(i),t.transform){var o=t.transform.orientation;if(t.transform.orientation.x===void 0)return;var a=t.transform.position;this._referencedPosition.set(a.x,a.y,a.z),this._referenceQuaternion.set(o.x,o.y,o.z,o.w),this._scene.useRightHandedSystem||(this._referencedPosition.z*=-1,this._referenceQuaternion.z*=-1,this._referenceQuaternion.w*=-1),this._firstFrame?(this._firstFrame=!1,this.position.y+=this._referencedPosition.y,this._referenceQuaternion.copyFromFloats(0,0,0,1)):(this.rotationQuaternion.copyFrom(this._referenceQuaternion),this.position.copyFrom(this._referencedPosition))}this.rigCameras.length!==t.views.length&&this._updateNumberOfRigCameras(t.views.length),t.views.forEach(function(s,c){var l,u=e.rigCameras[c];!u.isLeftCamera&&!u.isRightCamera&&(s.eye==="right"?u._isRightCamera=!0:s.eye==="left"&&(u._isLeftCamera=!0));var f=s.transform.position,d=s.transform.orientation;u.parent=e.parent,u.position.set(f.x,f.y,f.z),u.rotationQuaternion.set(d.x,d.y,d.z,d.w),e._scene.useRightHandedSystem?u.rotationQuaternion.multiplyInPlace(e._rotate180):(u.position.z*=-1,u.rotationQuaternion.z*=-1,u.rotationQuaternion.w*=-1),Q.FromFloat32ArrayToRefScaled(s.projectionMatrix,0,1,u._projectionMatrix),e._scene.useRightHandedSystem||u._projectionMatrix.toggleProjectionMatrixHandInPlace(),c===0&&e._projectionMatrix.copyFrom(u._projectionMatrix);var p=e._xrSessionManager.getRenderTargetTextureForView(s);e._renderingMultiview=((l=p==null?void 0:p._texture)===null||l===void 0?void 0:l.isMultiview)||!1,e._renderingMultiview?c==0&&(e._xrSessionManager.trySetViewportForView(e.viewport,s),e.outputRenderTarget=p):(e._xrSessionManager.trySetViewportForView(u.viewport,s),u.outputRenderTarget=p||e._xrSessionManager.getRenderTargetTextureForView(s))})},n.prototype._updateNumberOfRigCameras=function(e){for(e===void 0&&(e=1);this.rigCameras.length<e;){var t=new Ji("XR-RigCamera: "+this.rigCameras.length,y.Zero(),this.getScene());t.minZ=.1,t.rotationQuaternion=new q,t.updateUpVectorFromRotation=!0,t.isRigCamera=!0,t.rigParent=this,t.freezeProjectionMatrix(),this.rigCameras.push(t)}for(;this.rigCameras.length>e;){var i=this.rigCameras.pop();i&&i.dispose()}},n.prototype._updateReferenceSpace=function(){if(!this.position.equals(this._referencedPosition)||!this.rotationQuaternion.equals(this._referenceQuaternion)){var e=H.Matrix[0],t=H.Matrix[1],i=H.Matrix[2];Q.ComposeToRef(n._ScaleReadOnly,this._referenceQuaternion,this._referencedPosition,e),Q.ComposeToRef(n._ScaleReadOnly,this.rotationQuaternion,this.position,t),e.invert().multiplyToRef(t,i),i.invert(),this._scene.useRightHandedSystem||i.toggleModelMatrixHandInPlace(),i.decompose(void 0,this._referenceQuaternion,this._referencedPosition);var o=new XRRigidTransform({x:this._referencedPosition.x,y:this._referencedPosition.y,z:this._referencedPosition.z},{x:this._referenceQuaternion.x,y:this._referenceQuaternion.y,z:this._referenceQuaternion.z,w:this._referenceQuaternion.w});this._xrSessionManager.referenceSpace=this._xrSessionManager.referenceSpace.getOffsetReferenceSpace(o)}},n._ScaleReadOnly=y.One(),n}(Ut),qt,$e=function(){function r(){}return r.ANCHOR_SYSTEM="xr-anchor-system",r.BACKGROUND_REMOVER="xr-background-remover",r.HIT_TEST="xr-hit-test",r.MESH_DETECTION="xr-mesh-detection",r.PHYSICS_CONTROLLERS="xr-physics-controller",r.PLANE_DETECTION="xr-plane-detection",r.POINTER_SELECTION="xr-controller-pointer-selection",r.TELEPORTATION="xr-controller-teleportation",r.FEATURE_POINTS="xr-feature-points",r.HAND_TRACKING="xr-hand-tracking",r.IMAGE_TRACKING="xr-image-tracking",r.NEAR_INTERACTION="xr-near-interaction",r.DOM_OVERLAY="xr-dom-overlay",r.MOVEMENT="xr-controller-movement",r.LIGHT_ESTIMATION="xr-light-estimation",r.EYE_TRACKING="xr-eye-tracking",r.WALKING_LOCOMOTION="xr-walking-locomotion",r.LAYERS="xr-layers",r}(),un=function(){function r(n){var e=this;this._xrSessionManager=n,this._features={},this._xrSessionManager.onXRSessionInit.add(function(){e.getEnabledFeatures().forEach(function(t){var i=e._features[t];i.enabled&&!i.featureImplementation.attached&&!i.featureImplementation.disableAutoAttach&&e.attachFeature(t)})}),this._xrSessionManager.onXRSessionEnded.add(function(){e.getEnabledFeatures().forEach(function(t){var i=e._features[t];i.enabled&&i.featureImplementation.attached&&e.detachFeature(t)})})}return r.AddWebXRFeature=function(n,e,t,i){t===void 0&&(t=1),i===void 0&&(i=!1),this._AvailableFeatures[n]=this._AvailableFeatures[n]||{latest:t},t>this._AvailableFeatures[n].latest&&(this._AvailableFeatures[n].latest=t),i&&(this._AvailableFeatures[n].stable=t),this._AvailableFeatures[n][t]=e},r.ConstructFeature=function(n,e,t,i){e===void 0&&(e=1);var o=this._AvailableFeatures[n][e];if(!o)throw new Error("feature not found");return o(t,i)},r.GetAvailableFeatures=function(){return Object.keys(this._AvailableFeatures)},r.GetAvailableVersions=function(n){return Object.keys(this._AvailableFeatures[n])},r.GetLatestVersionOfFeature=function(n){return this._AvailableFeatures[n]&&this._AvailableFeatures[n].latest||-1},r.GetStableVersionOfFeature=function(n){return this._AvailableFeatures[n]&&this._AvailableFeatures[n].stable||-1},r.prototype.attachFeature=function(n){var e=this._features[n];e&&e.enabled&&!e.featureImplementation.attached&&e.featureImplementation.attach()},r.prototype.detachFeature=function(n){var e=this._features[n];e&&e.featureImplementation.attached&&e.featureImplementation.detach()},r.prototype.disableFeature=function(n){var e=typeof n=="string"?n:n.Name,t=this._features[e];return t&&t.enabled?(t.enabled=!1,this.detachFeature(e),t.featureImplementation.dispose(),delete this._features[e],!0):!1},r.prototype.dispose=function(){var n=this;this.getEnabledFeatures().forEach(function(e){n.disableFeature(e)})},r.prototype.enableFeature=function(n,e,t,i,o){var a=this;e===void 0&&(e="latest"),t===void 0&&(t={}),i===void 0&&(i=!0),o===void 0&&(o=!0);var s=typeof n=="string"?n:n.Name,c=0;if(typeof e=="string"){if(!e)throw new Error("Error in provided version - ".concat(s," (").concat(e,")"));if(e==="stable"?c=r.GetStableVersionOfFeature(s):e==="latest"?c=r.GetLatestVersionOfFeature(s):c=+e,c===-1||isNaN(c))throw new Error("feature not found - ".concat(s," (").concat(e,")"))}else c=e;var l=r._ConflictingFeatures[s];if(l!==void 0&&this.getEnabledFeatures().indexOf(l)!==-1)throw new Error("Feature ".concat(s," cannot be enabled while ").concat(l," is enabled."));var u=this._features[s],f=r.ConstructFeature(s,c,this._xrSessionManager,t);if(!f)throw new Error("feature not found - ".concat(s));u&&this.disableFeature(s);var d=f();if(d.dependsOn){var p=d.dependsOn.every(function(m){return!!a._features[m]});if(!p)throw new Error("Dependant features missing. Make sure the following features are enabled - ".concat(d.dependsOn.join(", ")))}if(d.isCompatible())return this._features[s]={featureImplementation:d,enabled:!0,version:c,required:o},i?this._xrSessionManager.session&&!this._features[s].featureImplementation.attached&&this.attachFeature(s):this._features[s].featureImplementation.disableAutoAttach=!0,this._features[s].featureImplementation;if(o)throw new Error("required feature not compatible");return z.Warn("Feature ".concat(s," not compatible with the current environment/browser and was not enabled.")),d},r.prototype.getEnabledFeature=function(n){return this._features[n]&&this._features[n].featureImplementation},r.prototype.getEnabledFeatures=function(){return Object.keys(this._features)},r.prototype._extendXRSessionInitObject=function(n){return it(this,void 0,void 0,function(){var e,t,i,o,a,s,c;return rt(this,function(l){switch(l.label){case 0:e=this.getEnabledFeatures(),t=0,i=e,l.label=1;case 1:return t<i.length?(o=i[t],a=this._features[o],s=a.featureImplementation.xrNativeFeatureName,s&&(a.required?(n.requiredFeatures=n.requiredFeatures||[],n.requiredFeatures.indexOf(s)===-1&&n.requiredFeatures.push(s)):(n.optionalFeatures=n.optionalFeatures||[],n.optionalFeatures.indexOf(s)===-1&&n.optionalFeatures.push(s))),a.featureImplementation.getXRSessionInitExtension?[4,a.featureImplementation.getXRSessionInitExtension()]:[3,3]):[3,4];case 2:c=l.sent(),n=Oe(Oe({},n),c),l.label=3;case 3:return t++,[3,1];case 4:return[2,n]}})})},r._AvailableFeatures={},r._ConflictingFeatures=(qt={},qt[$e.TELEPORTATION]=$e.MOVEMENT,qt[$e.MOVEMENT]=$e.TELEPORTATION,qt),r}();Xt.AddNodeConstructor("TouchCamera",function(r,n){return function(){return new gr(r,y.Zero(),n)}});var gr=function(r){R(n,r);function n(e,t,i){var o=r.call(this,e,t,i)||this;return o.inputs.addTouch(),o._setupInputs(),o}return Object.defineProperty(n.prototype,"touchAngularSensibility",{get:function(){var e=this.inputs.attached.touch;return e?e.touchAngularSensibility:0},set:function(e){var t=this.inputs.attached.touch;t&&(t.touchAngularSensibility=e)},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"touchMoveSensibility",{get:function(){var e=this.inputs.attached.touch;return e?e.touchMoveSensibility:0},set:function(e){var t=this.inputs.attached.touch;t&&(t.touchMoveSensibility=e)},enumerable:!1,configurable:!0}),n.prototype.getClassName=function(){return"TouchCamera"},n.prototype._setupInputs=function(){var e=this.inputs.attached.touch,t=this.inputs.attached.mouse;t?t.touchEnabled=!1:e.allowMouse=!0},n}(Ut),Le=function(){function r(n,e,t,i,o,a,s){i===void 0&&(i=0),o===void 0&&(o=1),a===void 0&&(a=2),s===void 0&&(s=3),this.id=n,this.index=e,this.browserGamepad=t,this._leftStick={x:0,y:0},this._rightStick={x:0,y:0},this._isConnected=!0,this._invertLeftStickY=!1,this.type=r.GAMEPAD,this._leftStickAxisX=i,this._leftStickAxisY=o,this._rightStickAxisX=a,this._rightStickAxisY=s,this.browserGamepad.axes.length>=2&&(this._leftStick={x:this.browserGamepad.axes[this._leftStickAxisX],y:this.browserGamepad.axes[this._leftStickAxisY]}),this.browserGamepad.axes.length>=4&&(this._rightStick={x:this.browserGamepad.axes[this._rightStickAxisX],y:this.browserGamepad.axes[this._rightStickAxisY]})}return Object.defineProperty(r.prototype,"isConnected",{get:function(){return this._isConnected},enumerable:!1,configurable:!0}),r.prototype.onleftstickchanged=function(n){this._onleftstickchanged=n},r.prototype.onrightstickchanged=function(n){this._onrightstickchanged=n},Object.defineProperty(r.prototype,"leftStick",{get:function(){return this._leftStick},set:function(n){this._onleftstickchanged&&(this._leftStick.x!==n.x||this._leftStick.y!==n.y)&&this._onleftstickchanged(n),this._leftStick=n},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"rightStick",{get:function(){return this._rightStick},set:function(n){this._onrightstickchanged&&(this._rightStick.x!==n.x||this._rightStick.y!==n.y)&&this._onrightstickchanged(n),this._rightStick=n},enumerable:!1,configurable:!0}),r.prototype.update=function(){this._leftStick&&(this.leftStick={x:this.browserGamepad.axes[this._leftStickAxisX],y:this.browserGamepad.axes[this._leftStickAxisY]},this._invertLeftStickY&&(this.leftStick.y*=-1)),this._rightStick&&(this.rightStick={x:this.browserGamepad.axes[this._rightStickAxisX],y:this.browserGamepad.axes[this._rightStickAxisY]})},r.prototype.dispose=function(){},r.GAMEPAD=0,r.GENERIC=1,r.XBOX=2,r.POSE_ENABLED=3,r.DUALSHOCK=4,r}(),zo=function(r){R(n,r);function n(e,t,i){var o=r.call(this,e,t,i)||this;return o.onButtonDownObservable=new U,o.onButtonUpObservable=new U,o.type=Le.GENERIC,o._buttons=new Array(i.buttons.length),o}return n.prototype.onbuttondown=function(e){this._onbuttondown=e},n.prototype.onbuttonup=function(e){this._onbuttonup=e},n.prototype._setButtonValue=function(e,t,i){return e!==t&&(e===1&&(this._onbuttondown&&this._onbuttondown(i),this.onButtonDownObservable.notifyObservers(i)),e===0&&(this._onbuttonup&&this._onbuttonup(i),this.onButtonUpObservable.notifyObservers(i))),e},n.prototype.update=function(){r.prototype.update.call(this);for(var e=0;e<this._buttons.length;e++)this._buttons[e]=this._setButtonValue(this.browserGamepad.buttons[e].value,this._buttons[e],e)},n.prototype.dispose=function(){r.prototype.dispose.call(this),this.onButtonDownObservable.clear(),this.onButtonUpObservable.clear()},n}(Le),Ln;(function(r){r[r.VIVE=0]="VIVE",r[r.OCULUS=1]="OCULUS",r[r.WINDOWS=2]="WINDOWS",r[r.GEAR_VR=3]="GEAR_VR",r[r.DAYDREAM=4]="DAYDREAM",r[r.GENERIC=5]="GENERIC"})(Ln||(Ln={}));var Xo=function(){function r(){}return r.InitiateController=function(n){for(var e=0,t=this._ControllerFactories;e<t.length;e++){var i=t[e];if(i.canCreate(n))return i.create(n)}if(this._DefaultControllerFactory)return this._DefaultControllerFactory(n);throw"The type of gamepad you are trying to load needs to be imported first or is not supported."},r._ControllerFactories=[],r._DefaultControllerFactory=null,r}();(function(r){R(n,r);function n(e){var t=r.call(this,e.id,e.index,e)||this;return t.isXR=!1,t._deviceRoomPosition=y.Zero(),t._deviceRoomRotationQuaternion=new q,t.devicePosition=y.Zero(),t.deviceRotationQuaternion=new q,t.deviceScaleFactor=1,t._trackPosition=!0,t._maxRotationDistFromHeadset=Math.PI/5,t._draggedRoomRotation=0,t._leftHandSystemQuaternion=new q,t._deviceToWorld=Q.Identity(),t._pointingPoseNode=null,t._workingMatrix=Q.Identity(),t._meshAttachedObservable=new U,t.type=Le.POSE_ENABLED,t.controllerType=Ln.GENERIC,t.position=y.Zero(),t.rotationQuaternion=new q,t._calculatedPosition=y.Zero(),t._calculatedRotation=new q,q.RotationYawPitchRollToRef(Math.PI,0,0,t._leftHandSystemQuaternion),t}return n.prototype._disableTrackPosition=function(e){this._trackPosition&&(this._calculatedPosition.copyFrom(e),this._trackPosition=!1)},n.prototype.update=function(){r.prototype.update.call(this),this._updatePoseAndMesh()},n.prototype._updatePoseAndMesh=function(){if(!this.isXR){var e=this.browserGamepad.pose;if(this.updateFromDevice(e),!this._trackPosition&&Me.LastCreatedScene&&Me.LastCreatedScene.activeCamera&&Me.LastCreatedScene.activeCamera.devicePosition){var t=Me.LastCreatedScene.activeCamera;if(t._computeDevicePosition(),this._deviceToWorld.setTranslation(t.devicePosition),t.deviceRotationQuaternion){t._deviceRoomRotationQuaternion.toEulerAnglesToRef(H.Vector3[0]);var i=Math.atan2(Math.sin(H.Vector3[0].y-this._draggedRoomRotation),Math.cos(H.Vector3[0].y-this._draggedRoomRotation));if(Math.abs(i)>this._maxRotationDistFromHeadset){var o=i-(i<0?-this._maxRotationDistFromHeadset:this._maxRotationDistFromHeadset);this._draggedRoomRotation+=o;var a=Math.sin(-o),s=Math.cos(-o);this._calculatedPosition.x=this._calculatedPosition.x*s-this._calculatedPosition.z*a,this._calculatedPosition.z=this._calculatedPosition.x*a+this._calculatedPosition.z*s}}}y.TransformCoordinatesToRef(this._calculatedPosition,this._deviceToWorld,this.devicePosition),this._deviceToWorld.getRotationMatrixToRef(this._workingMatrix),q.FromRotationMatrixToRef(this._workingMatrix,this.deviceRotationQuaternion),this.deviceRotationQuaternion.multiplyInPlace(this._calculatedRotation),this._mesh&&(this._mesh.position.copyFrom(this.devicePosition),this._mesh.rotationQuaternion&&this._mesh.rotationQuaternion.copyFrom(this.deviceRotationQuaternion))}},n.prototype.updateFromDevice=function(e){if(!this.isXR&&e){this.rawPose=e,e.position&&(this._deviceRoomPosition.copyFromFloats(e.position[0],e.position[1],-e.position[2]),this._mesh&&this._mesh.getScene().useRightHandedSystem&&(this._deviceRoomPosition.z*=-1),this._trackPosition&&this._deviceRoomPosition.scaleToRef(this.deviceScaleFactor,this._calculatedPosition),this._calculatedPosition.addInPlace(this.position));var t=this.rawPose;e.orientation&&t.orientation&&t.orientation.length===4&&(this._deviceRoomRotationQuaternion.copyFromFloats(t.orientation[0],t.orientation[1],-t.orientation[2],-t.orientation[3]),this._mesh&&(this._mesh.getScene().useRightHandedSystem?(this._deviceRoomRotationQuaternion.z*=-1,this._deviceRoomRotationQuaternion.w*=-1):this._deviceRoomRotationQuaternion.multiplyToRef(this._leftHandSystemQuaternion,this._deviceRoomRotationQuaternion)),this._deviceRoomRotationQuaternion.multiplyToRef(this.rotationQuaternion,this._calculatedRotation))}},n.prototype.attachToMesh=function(e){if(this._mesh&&(this._mesh.parent=null),this._mesh=e,this._poseControlledCamera&&(this._mesh.parent=this._poseControlledCamera),this._mesh.rotationQuaternion||(this._mesh.rotationQuaternion=new q),!this.isXR&&(this._updatePoseAndMesh(),this._pointingPoseNode)){for(var t=[],i=this._pointingPoseNode;i.parent;)t.push(i.parent),i=i.parent;t.reverse().forEach(function(o){o.computeWorldMatrix(!0)})}this._meshAttachedObservable.notifyObservers(e)},n.prototype.attachToPoseControlledCamera=function(e){this._poseControlledCamera=e,this._mesh&&(this._mesh.parent=this._poseControlledCamera)},n.prototype.dispose=function(){this._mesh&&this._mesh.dispose(),this._mesh=null,r.prototype.dispose.call(this)},Object.defineProperty(n.prototype,"mesh",{get:function(){return this._mesh},enumerable:!1,configurable:!0}),n.prototype.getForwardRay=function(e){if(e===void 0&&(e=100),!this.mesh)return new pt(y.Zero(),new y(0,0,1),e);var t=this._pointingPoseNode?this._pointingPoseNode.getWorldMatrix():this.mesh.getWorldMatrix(),i=t.getTranslation(),o=new y(0,0,-1),a=y.TransformNormal(o,t),s=y.Normalize(a);return new pt(i,s,e)},n.POINTING_POSE="POINTING_POSE",n})(Le);var He;(function(r){r[r.A=0]="A",r[r.B=1]="B",r[r.X=2]="X",r[r.Y=3]="Y",r[r.LB=4]="LB",r[r.RB=5]="RB",r[r.Back=8]="Back",r[r.Start=9]="Start",r[r.LeftStick=10]="LeftStick",r[r.RightStick=11]="RightStick"})(He||(He={}));var Ct;(function(r){r[r.Up=12]="Up",r[r.Down=13]="Down",r[r.Left=14]="Left",r[r.Right=15]="Right"})(Ct||(Ct={}));var jo=function(r){R(n,r);function n(e,t,i,o){o===void 0&&(o=!1);var a=r.call(this,e,t,i,0,1,2,3)||this;return a._leftTrigger=0,a._rightTrigger=0,a.onButtonDownObservable=new U,a.onButtonUpObservable=new U,a.onPadDownObservable=new U,a.onPadUpObservable=new U,a._buttonA=0,a._buttonB=0,a._buttonX=0,a._buttonY=0,a._buttonBack=0,a._buttonStart=0,a._buttonLB=0,a._buttonRB=0,a._buttonLeftStick=0,a._buttonRightStick=0,a._dPadUp=0,a._dPadDown=0,a._dPadLeft=0,a._dPadRight=0,a._isXboxOnePad=!1,a.type=Le.XBOX,a._isXboxOnePad=o,a}return n.prototype.onlefttriggerchanged=function(e){this._onlefttriggerchanged=e},n.prototype.onrighttriggerchanged=function(e){this._onrighttriggerchanged=e},Object.defineProperty(n.prototype,"leftTrigger",{get:function(){return this._leftTrigger},set:function(e){this._onlefttriggerchanged&&this._leftTrigger!==e&&this._onlefttriggerchanged(e),this._leftTrigger=e},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"rightTrigger",{get:function(){return this._rightTrigger},set:function(e){this._onrighttriggerchanged&&this._rightTrigger!==e&&this._onrighttriggerchanged(e),this._rightTrigger=e},enumerable:!1,configurable:!0}),n.prototype.onbuttondown=function(e){this._onbuttondown=e},n.prototype.onbuttonup=function(e){this._onbuttonup=e},n.prototype.ondpaddown=function(e){this._ondpaddown=e},n.prototype.ondpadup=function(e){this._ondpadup=e},n.prototype._setButtonValue=function(e,t,i){return e!==t&&(e===1&&(this._onbuttondown&&this._onbuttondown(i),this.onButtonDownObservable.notifyObservers(i)),e===0&&(this._onbuttonup&&this._onbuttonup(i),this.onButtonUpObservable.notifyObservers(i))),e},n.prototype._setDPadValue=function(e,t,i){return e!==t&&(e===1&&(this._ondpaddown&&this._ondpaddown(i),this.onPadDownObservable.notifyObservers(i)),e===0&&(this._ondpadup&&this._ondpadup(i),this.onPadUpObservable.notifyObservers(i))),e},Object.defineProperty(n.prototype,"buttonA",{get:function(){return this._buttonA},set:function(e){this._buttonA=this._setButtonValue(e,this._buttonA,He.A)},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"buttonB",{get:function(){return this._buttonB},set:function(e){this._buttonB=this._setButtonValue(e,this._buttonB,He.B)},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"buttonX",{get:function(){return this._buttonX},set:function(e){this._buttonX=this._setButtonValue(e,this._buttonX,He.X)},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"buttonY",{get:function(){return this._buttonY},set:function(e){this._buttonY=this._setButtonValue(e,this._buttonY,He.Y)},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"buttonStart",{get:function(){return this._buttonStart},set:function(e){this._buttonStart=this._setButtonValue(e,this._buttonStart,He.Start)},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"buttonBack",{get:function(){return this._buttonBack},set:function(e){this._buttonBack=this._setButtonValue(e,this._buttonBack,He.Back)},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"buttonLB",{get:function(){return this._buttonLB},set:function(e){this._buttonLB=this._setButtonValue(e,this._buttonLB,He.LB)},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"buttonRB",{get:function(){return this._buttonRB},set:function(e){this._buttonRB=this._setButtonValue(e,this._buttonRB,He.RB)},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"buttonLeftStick",{get:function(){return this._buttonLeftStick},set:function(e){this._buttonLeftStick=this._setButtonValue(e,this._buttonLeftStick,He.LeftStick)},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"buttonRightStick",{get:function(){return this._buttonRightStick},set:function(e){this._buttonRightStick=this._setButtonValue(e,this._buttonRightStick,He.RightStick)},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"dPadUp",{get:function(){return this._dPadUp},set:function(e){this._dPadUp=this._setDPadValue(e,this._dPadUp,Ct.Up)},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"dPadDown",{get:function(){return this._dPadDown},set:function(e){this._dPadDown=this._setDPadValue(e,this._dPadDown,Ct.Down)},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"dPadLeft",{get:function(){return this._dPadLeft},set:function(e){this._dPadLeft=this._setDPadValue(e,this._dPadLeft,Ct.Left)},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"dPadRight",{get:function(){return this._dPadRight},set:function(e){this._dPadRight=this._setDPadValue(e,this._dPadRight,Ct.Right)},enumerable:!1,configurable:!0}),n.prototype.update=function(){r.prototype.update.call(this),this._isXboxOnePad?(this.buttonA=this.browserGamepad.buttons[0].value,this.buttonB=this.browserGamepad.buttons[1].value,this.buttonX=this.browserGamepad.buttons[2].value,this.buttonY=this.browserGamepad.buttons[3].value,this.buttonLB=this.browserGamepad.buttons[4].value,this.buttonRB=this.browserGamepad.buttons[5].value,this.leftTrigger=this.browserGamepad.buttons[6].value,this.rightTrigger=this.browserGamepad.buttons[7].value,this.buttonBack=this.browserGamepad.buttons[8].value,this.buttonStart=this.browserGamepad.buttons[9].value,this.buttonLeftStick=this.browserGamepad.buttons[10].value,this.buttonRightStick=this.browserGamepad.buttons[11].value,this.dPadUp=this.browserGamepad.buttons[12].value,this.dPadDown=this.browserGamepad.buttons[13].value,this.dPadLeft=this.browserGamepad.buttons[14].value,this.dPadRight=this.browserGamepad.buttons[15].value):(this.buttonA=this.browserGamepad.buttons[0].value,this.buttonB=this.browserGamepad.buttons[1].value,this.buttonX=this.browserGamepad.buttons[2].value,this.buttonY=this.browserGamepad.buttons[3].value,this.buttonLB=this.browserGamepad.buttons[4].value,this.buttonRB=this.browserGamepad.buttons[5].value,this.leftTrigger=this.browserGamepad.buttons[6].value,this.rightTrigger=this.browserGamepad.buttons[7].value,this.buttonBack=this.browserGamepad.buttons[8].value,this.buttonStart=this.browserGamepad.buttons[9].value,this.buttonLeftStick=this.browserGamepad.buttons[10].value,this.buttonRightStick=this.browserGamepad.buttons[11].value,this.dPadUp=this.browserGamepad.buttons[12].value,this.dPadDown=this.browserGamepad.buttons[13].value,this.dPadLeft=this.browserGamepad.buttons[14].value,this.dPadRight=this.browserGamepad.buttons[15].value)},n.prototype.dispose=function(){r.prototype.dispose.call(this),this.onButtonDownObservable.clear(),this.onButtonUpObservable.clear(),this.onPadDownObservable.clear(),this.onPadUpObservable.clear()},n}(Le),ze;(function(r){r[r.Cross=0]="Cross",r[r.Circle=1]="Circle",r[r.Square=2]="Square",r[r.Triangle=3]="Triangle",r[r.L1=4]="L1",r[r.R1=5]="R1",r[r.Share=8]="Share",r[r.Options=9]="Options",r[r.LeftStick=10]="LeftStick",r[r.RightStick=11]="RightStick"})(ze||(ze={}));var Tt;(function(r){r[r.Up=12]="Up",r[r.Down=13]="Down",r[r.Left=14]="Left",r[r.Right=15]="Right"})(Tt||(Tt={}));var Yo=function(r){R(n,r);function n(e,t,i){var o=r.call(this,e.replace("STANDARD GAMEPAD","SONY PLAYSTATION DUALSHOCK"),t,i,0,1,2,3)||this;return o._leftTrigger=0,o._rightTrigger=0,o.onButtonDownObservable=new U,o.onButtonUpObservable=new U,o.onPadDownObservable=new U,o.onPadUpObservable=new U,o._buttonCross=0,o._buttonCircle=0,o._buttonSquare=0,o._buttonTriangle=0,o._buttonShare=0,o._buttonOptions=0,o._buttonL1=0,o._buttonR1=0,o._buttonLeftStick=0,o._buttonRightStick=0,o._dPadUp=0,o._dPadDown=0,o._dPadLeft=0,o._dPadRight=0,o.type=Le.DUALSHOCK,o}return n.prototype.onlefttriggerchanged=function(e){this._onlefttriggerchanged=e},n.prototype.onrighttriggerchanged=function(e){this._onrighttriggerchanged=e},Object.defineProperty(n.prototype,"leftTrigger",{get:function(){return this._leftTrigger},set:function(e){this._onlefttriggerchanged&&this._leftTrigger!==e&&this._onlefttriggerchanged(e),this._leftTrigger=e},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"rightTrigger",{get:function(){return this._rightTrigger},set:function(e){this._onrighttriggerchanged&&this._rightTrigger!==e&&this._onrighttriggerchanged(e),this._rightTrigger=e},enumerable:!1,configurable:!0}),n.prototype.onbuttondown=function(e){this._onbuttondown=e},n.prototype.onbuttonup=function(e){this._onbuttonup=e},n.prototype.ondpaddown=function(e){this._ondpaddown=e},n.prototype.ondpadup=function(e){this._ondpadup=e},n.prototype._setButtonValue=function(e,t,i){return e!==t&&(e===1&&(this._onbuttondown&&this._onbuttondown(i),this.onButtonDownObservable.notifyObservers(i)),e===0&&(this._onbuttonup&&this._onbuttonup(i),this.onButtonUpObservable.notifyObservers(i))),e},n.prototype._setDPadValue=function(e,t,i){return e!==t&&(e===1&&(this._ondpaddown&&this._ondpaddown(i),this.onPadDownObservable.notifyObservers(i)),e===0&&(this._ondpadup&&this._ondpadup(i),this.onPadUpObservable.notifyObservers(i))),e},Object.defineProperty(n.prototype,"buttonCross",{get:function(){return this._buttonCross},set:function(e){this._buttonCross=this._setButtonValue(e,this._buttonCross,ze.Cross)},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"buttonCircle",{get:function(){return this._buttonCircle},set:function(e){this._buttonCircle=this._setButtonValue(e,this._buttonCircle,ze.Circle)},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"buttonSquare",{get:function(){return this._buttonSquare},set:function(e){this._buttonSquare=this._setButtonValue(e,this._buttonSquare,ze.Square)},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"buttonTriangle",{get:function(){return this._buttonTriangle},set:function(e){this._buttonTriangle=this._setButtonValue(e,this._buttonTriangle,ze.Triangle)},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"buttonOptions",{get:function(){return this._buttonOptions},set:function(e){this._buttonOptions=this._setButtonValue(e,this._buttonOptions,ze.Options)},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"buttonShare",{get:function(){return this._buttonShare},set:function(e){this._buttonShare=this._setButtonValue(e,this._buttonShare,ze.Share)},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"buttonL1",{get:function(){return this._buttonL1},set:function(e){this._buttonL1=this._setButtonValue(e,this._buttonL1,ze.L1)},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"buttonR1",{get:function(){return this._buttonR1},set:function(e){this._buttonR1=this._setButtonValue(e,this._buttonR1,ze.R1)},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"buttonLeftStick",{get:function(){return this._buttonLeftStick},set:function(e){this._buttonLeftStick=this._setButtonValue(e,this._buttonLeftStick,ze.LeftStick)},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"buttonRightStick",{get:function(){return this._buttonRightStick},set:function(e){this._buttonRightStick=this._setButtonValue(e,this._buttonRightStick,ze.RightStick)},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"dPadUp",{get:function(){return this._dPadUp},set:function(e){this._dPadUp=this._setDPadValue(e,this._dPadUp,Tt.Up)},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"dPadDown",{get:function(){return this._dPadDown},set:function(e){this._dPadDown=this._setDPadValue(e,this._dPadDown,Tt.Down)},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"dPadLeft",{get:function(){return this._dPadLeft},set:function(e){this._dPadLeft=this._setDPadValue(e,this._dPadLeft,Tt.Left)},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"dPadRight",{get:function(){return this._dPadRight},set:function(e){this._dPadRight=this._setDPadValue(e,this._dPadRight,Tt.Right)},enumerable:!1,configurable:!0}),n.prototype.update=function(){r.prototype.update.call(this),this.buttonCross=this.browserGamepad.buttons[0].value,this.buttonCircle=this.browserGamepad.buttons[1].value,this.buttonSquare=this.browserGamepad.buttons[2].value,this.buttonTriangle=this.browserGamepad.buttons[3].value,this.buttonL1=this.browserGamepad.buttons[4].value,this.buttonR1=this.browserGamepad.buttons[5].value,this.leftTrigger=this.browserGamepad.buttons[6].value,this.rightTrigger=this.browserGamepad.buttons[7].value,this.buttonShare=this.browserGamepad.buttons[8].value,this.buttonOptions=this.browserGamepad.buttons[9].value,this.buttonLeftStick=this.browserGamepad.buttons[10].value,this.buttonRightStick=this.browserGamepad.buttons[11].value,this.dPadUp=this.browserGamepad.buttons[12].value,this.dPadDown=this.browserGamepad.buttons[13].value,this.dPadLeft=this.browserGamepad.buttons[14].value,this.dPadRight=this.browserGamepad.buttons[15].value},n.prototype.dispose=function(){r.prototype.dispose.call(this),this.onButtonDownObservable.clear(),this.onButtonUpObservable.clear(),this.onPadDownObservable.clear(),this.onPadUpObservable.clear()},n}(Le),Wo=function(){function r(n){var e=this;if(this._scene=n,this._babylonGamepads=[],this._oneGamepadConnected=!1,this._isMonitoring=!1,this.onGamepadDisconnectedObservable=new U,Jr()?(this._gamepadEventSupported="GamepadEvent"in window,this._gamepadSupport=navigator&&(navigator.getGamepads||navigator.webkitGetGamepads||navigator.msGetGamepads||navigator.webkitGamepads)):this._gamepadEventSupported=!1,this.onGamepadConnectedObservable=new U(function(i){for(var o in e._babylonGamepads){var a=e._babylonGamepads[o];a&&a._isConnected&&e.onGamepadConnectedObservable.notifyObserver(i,a)}}),this._onGamepadConnectedEvent=function(i){var o=i.gamepad;if(!(o.index in e._babylonGamepads&&e._babylonGamepads[o.index].isConnected)){var a;e._babylonGamepads[o.index]?(a=e._babylonGamepads[o.index],a.browserGamepad=o,a._isConnected=!0):a=e._addNewGamepad(o),e.onGamepadConnectedObservable.notifyObservers(a),e._startMonitoringGamepads()}},this._onGamepadDisconnectedEvent=function(i){var o=i.gamepad;for(var a in e._babylonGamepads)if(e._babylonGamepads[a].index===o.index){var s=e._babylonGamepads[a];s._isConnected=!1,e.onGamepadDisconnectedObservable.notifyObservers(s),s.dispose&&s.dispose();break}},this._gamepadSupport)if(this._updateGamepadObjects(),this._babylonGamepads.length&&this._startMonitoringGamepads(),this._gamepadEventSupported){var t=this._scene?this._scene.getEngine().getHostWindow():window;t&&(t.addEventListener("gamepadconnected",this._onGamepadConnectedEvent,!1),t.addEventListener("gamepaddisconnected",this._onGamepadDisconnectedEvent,!1))}else this._startMonitoringGamepads()}return Object.defineProperty(r.prototype,"gamepads",{get:function(){return this._babylonGamepads},enumerable:!1,configurable:!0}),r.prototype.getGamepadByType=function(n){n===void 0&&(n=Le.XBOX);for(var e=0,t=this._babylonGamepads;e<t.length;e++){var i=t[e];if(i&&i.type===n)return i}return null},r.prototype.dispose=function(){this._gamepadEventSupported&&(this._onGamepadConnectedEvent&&window.removeEventListener("gamepadconnected",this._onGamepadConnectedEvent),this._onGamepadDisconnectedEvent&&window.removeEventListener("gamepaddisconnected",this._onGamepadDisconnectedEvent),this._onGamepadConnectedEvent=null,this._onGamepadDisconnectedEvent=null),this._babylonGamepads.forEach(function(n){n.dispose()}),this.onGamepadConnectedObservable.clear(),this.onGamepadDisconnectedObservable.clear(),this._oneGamepadConnected=!1,this._stopMonitoringGamepads(),this._babylonGamepads=[]},r.prototype._addNewGamepad=function(n){this._oneGamepadConnected||(this._oneGamepadConnected=!0);var e,t=n.id.search("054c")!==-1&&n.id.search("0ce6")===-1,i=n.id.search("Xbox One")!==-1;return i||n.id.search("Xbox 360")!==-1||n.id.search("xinput")!==-1||n.id.search("045e")!==-1&&n.id.search("Surface Dock")===-1?e=new jo(n.id,n.index,n,i):t?e=new Yo(n.id,n.index,n):n.pose?e=Xo.InitiateController(n):e=new zo(n.id,n.index,n),this._babylonGamepads[e.index]=e,e},r.prototype._startMonitoringGamepads=function(){this._isMonitoring||(this._isMonitoring=!0,this._scene||this._checkGamepadsStatus())},r.prototype._stopMonitoringGamepads=function(){this._isMonitoring=!1},r.prototype._checkGamepadsStatus=function(){var n=this;this._updateGamepadObjects();for(var e in this._babylonGamepads){var t=this._babylonGamepads[e];if(!(!t||!t.isConnected))try{t.update()}catch{this._loggedErrors.indexOf(t.index)===-1&&(z.Warn("Error updating gamepad ".concat(t.id)),this._loggedErrors.push(t.index))}}this._isMonitoring&&!this._scene&&j.QueueNewFrame(function(){n._checkGamepadsStatus()})},r.prototype._updateGamepadObjects=function(){for(var n=navigator.getGamepads?navigator.getGamepads():navigator.webkitGetGamepads?navigator.webkitGetGamepads():[],e=0;e<n.length;e++){var t=n[e];if(t)if(this._babylonGamepads[t.index])this._babylonGamepads[e].browserGamepad=t,this._babylonGamepads[e].isConnected||(this._babylonGamepads[e]._isConnected=!0,this.onGamepadConnectedObservable.notifyObservers(this._babylonGamepads[e]));else{var i=this._addNewGamepad(t);this.onGamepadConnectedObservable.notifyObservers(i)}}},r}(),vr=function(){function r(){this.gamepadAngularSensibility=200,this.gamepadMoveSensibility=40,this.deadzoneDelta=.1,this._yAxisScale=1,this._cameraTransform=Q.Identity(),this._deltaTransform=y.Zero(),this._vector3=y.Zero(),this._vector2=Ge.Zero()}return Object.defineProperty(r.prototype,"invertYAxis",{get:function(){return this._yAxisScale!==1},set:function(n){this._yAxisScale=n?-1:1},enumerable:!1,configurable:!0}),r.prototype.attachControl=function(){var n=this,e=this.camera.getScene().gamepadManager;this._onGamepadConnectedObserver=e.onGamepadConnectedObservable.add(function(t){t.type!==Le.POSE_ENABLED&&(!n.gamepad||t.type===Le.XBOX)&&(n.gamepad=t)}),this._onGamepadDisconnectedObserver=e.onGamepadDisconnectedObservable.add(function(t){n.gamepad===t&&(n.gamepad=null)}),this.gamepad=e.getGamepadByType(Le.XBOX),!this.gamepad&&e.gamepads.length&&(this.gamepad=e.gamepads[0])},r.prototype.detachControl=function(){this.camera.getScene().gamepadManager.onGamepadConnectedObservable.remove(this._onGamepadConnectedObserver),this.camera.getScene().gamepadManager.onGamepadDisconnectedObservable.remove(this._onGamepadDisconnectedObserver),this.gamepad=null},r.prototype.checkInputs=function(){if(this.gamepad&&this.gamepad.leftStick){var n=this.camera,e=this.gamepad.leftStick;this.gamepadMoveSensibility!==0&&(e.x=Math.abs(e.x)>this.deadzoneDelta?e.x/this.gamepadMoveSensibility:0,e.y=Math.abs(e.y)>this.deadzoneDelta?e.y/this.gamepadMoveSensibility:0);var t=this.gamepad.rightStick;t&&this.gamepadAngularSensibility!==0?(t.x=Math.abs(t.x)>this.deadzoneDelta?t.x/this.gamepadAngularSensibility:0,t.y=(Math.abs(t.y)>this.deadzoneDelta?t.y/this.gamepadAngularSensibility:0)*this._yAxisScale):t={x:0,y:0},n.rotationQuaternion?n.rotationQuaternion.toRotationMatrix(this._cameraTransform):Q.RotationYawPitchRollToRef(n.rotation.y,n.rotation.x,0,this._cameraTransform);var i=n._computeLocalCameraSpeed()*50;this._vector3.copyFromFloats(e.x*i,0,-e.y*i),y.TransformCoordinatesToRef(this._vector3,this._cameraTransform,this._deltaTransform),n.cameraDirection.addInPlace(this._deltaTransform),this._vector2.copyFromFloats(t.y,t.x),n.cameraRotation.addInPlace(this._vector2)}},r.prototype.getClassName=function(){return"FreeCameraGamepadInput"},r.prototype.getSimpleName=function(){return"gamepad"},E([T()],r.prototype,"gamepadAngularSensibility",void 0),E([T()],r.prototype,"gamepadMoveSensibility",void 0),r}();It.FreeCameraGamepadInput=vr;var Er=function(){function r(){this.gamepadRotationSensibility=80,this.gamepadMoveSensibility=40,this._yAxisScale=1}return Object.defineProperty(r.prototype,"invertYAxis",{get:function(){return this._yAxisScale!==1},set:function(n){this._yAxisScale=n?-1:1},enumerable:!1,configurable:!0}),r.prototype.attachControl=function(){var n=this,e=this.camera.getScene().gamepadManager;this._onGamepadConnectedObserver=e.onGamepadConnectedObservable.add(function(t){t.type!==Le.POSE_ENABLED&&(!n.gamepad||t.type===Le.XBOX)&&(n.gamepad=t)}),this._onGamepadDisconnectedObserver=e.onGamepadDisconnectedObservable.add(function(t){n.gamepad===t&&(n.gamepad=null)}),this.gamepad=e.getGamepadByType(Le.XBOX)},r.prototype.detachControl=function(){this.camera.getScene().gamepadManager.onGamepadConnectedObservable.remove(this._onGamepadConnectedObserver),this.camera.getScene().gamepadManager.onGamepadDisconnectedObservable.remove(this._onGamepadDisconnectedObserver),this.gamepad=null},r.prototype.checkInputs=function(){if(this.gamepad){var n=this.camera,e=this.gamepad.rightStick;if(e){if(e.x!=0){var t=e.x/this.gamepadRotationSensibility;t!=0&&Math.abs(t)>.005&&(n.inertialAlphaOffset+=t)}if(e.y!=0){var i=e.y/this.gamepadRotationSensibility*this._yAxisScale;i!=0&&Math.abs(i)>.005&&(n.inertialBetaOffset+=i)}}var o=this.gamepad.leftStick;if(o&&o.y!=0){var a=o.y/this.gamepadMoveSensibility;a!=0&&Math.abs(a)>.005&&(this.camera.inertialRadiusOffset-=a)}}},r.prototype.getClassName=function(){return"ArcRotateCameraGamepadInput"},r.prototype.getSimpleName=function(){return"gamepad"},E([T()],r.prototype,"gamepadRotationSensibility",void 0),E([T()],r.prototype,"gamepadMoveSensibility",void 0),r}();It.ArcRotateCameraGamepadInput=Er;Object.defineProperty(Ne.prototype,"gamepadManager",{get:function(){if(!this._gamepadManager){this._gamepadManager=new Wo(this);var r=this._getComponent(Nt.NAME_GAMEPAD);r||(r=new Ko(this),this._addComponent(r))}return this._gamepadManager},enumerable:!0,configurable:!0});_r.prototype.addGamepad=function(){return this.add(new vr),this};$r.prototype.addGamepad=function(){return this.add(new Er),this};var Ko=function(){function r(n){this.name=Nt.NAME_GAMEPAD,this.scene=n}return r.prototype.register=function(){this.scene._beforeCameraUpdateStage.registerStep(Nt.STEP_BEFORECAMERAUPDATE_GAMEPAD,this,this._beforeCameraUpdate)},r.prototype.rebuild=function(){},r.prototype.dispose=function(){var n=this.scene._gamepadManager;n&&(n.dispose(),this.scene._gamepadManager=null)},r.prototype._beforeCameraUpdate=function(){var n=this.scene._gamepadManager;n&&n._isMonitoring&&n._checkGamepadsStatus()},r}();Xt.AddNodeConstructor("FreeCamera",function(r,n){return function(){return new yi(r,y.Zero(),n)}});var yi=function(r){R(n,r);function n(e,t,i){var o=r.call(this,e,t,i)||this;return o.inputs.addGamepad(),o}return Object.defineProperty(n.prototype,"gamepadAngularSensibility",{get:function(){var e=this.inputs.attached.gamepad;return e?e.gamepadAngularSensibility:0},set:function(e){var t=this.inputs.attached.gamepad;t&&(t.gamepadAngularSensibility=e)},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"gamepadMoveSensibility",{get:function(){var e=this.inputs.attached.gamepad;return e?e.gamepadMoveSensibility:0},set:function(e){var t=this.inputs.attached.gamepad;t&&(t.gamepadMoveSensibility=e)},enumerable:!1,configurable:!0}),n.prototype.getClassName=function(){return"UniversalCamera"},n}(gr);sn._CreateDefaultParsedCamera=function(r,n){return new yi(r,y.Zero(),n)};var Qo=function(){function r(n){var e=this;this._scene=n,this._nonVRCamera=null,this._attachedToElement=!1,this._spectatorCamera=null,this._originalSceneAutoClear=!0,this._supported=!1,this._spectatorMode=!1,this.onInitialXRPoseSetObservable=new U,this.onStateChangedObservable=new U,this.state=Ce.NOT_IN_XR,this.sessionManager=new ko(n),this.camera=new Ho("webxr",n,this.sessionManager),this.featuresManager=new un(this.sessionManager),n.onDisposeObservable.addOnce(function(){e.dispose()})}return r.CreateAsync=function(n){var e=new r(n);return e.sessionManager.initializeAsync().then(function(){return e._supported=!0,e}).catch(function(t){throw e._setState(Ce.NOT_IN_XR),e.dispose(),t})},r.prototype.dispose=function(){var n;this.exitXRAsync(),this.camera.dispose(),this.onStateChangedObservable.clear(),this.onInitialXRPoseSetObservable.clear(),this.sessionManager.dispose(),(n=this._spectatorCamera)===null||n===void 0||n.dispose(),this._nonVRCamera&&(this._scene.activeCamera=this._nonVRCamera)},r.prototype.enterXRAsync=function(n,e,t,i){var o,a;return t===void 0&&(t=this.sessionManager.getWebXRRenderTarget()),i===void 0&&(i={}),it(this,void 0,void 0,function(){var s,c,l,u=this;return rt(this,function(f){switch(f.label){case 0:if(!this._supported)throw"WebXR not supported in this browser or environment";return this._setState(Ce.ENTERING_XR),e!=="viewer"&&e!=="local"&&(i.optionalFeatures=i.optionalFeatures||[],i.optionalFeatures.push(e)),[4,this.featuresManager._extendXRSessionInitObject(i)];case 1:i=f.sent(),n==="immersive-ar"&&e!=="unbounded"&&ne.Warn("We recommend using 'unbounded' reference space type when using 'immersive-ar' session mode"),f.label=2;case 2:return f.trys.push([2,6,,7]),[4,this.sessionManager.initializeSessionAsync(n,i)];case 3:return f.sent(),[4,this.sessionManager.setReferenceSpaceTypeAsync(e)];case 4:return f.sent(),[4,t.initializeXRLayerAsync(this.sessionManager.session)];case 5:return s=f.sent(),c={depthFar:this.camera.maxZ,depthNear:this.camera.minZ},this.featuresManager.getEnabledFeature($e.LAYERS)||(c.baseLayer=s),this.sessionManager.updateRenderState(c),this.sessionManager.runXRRenderLoop(),this._originalSceneAutoClear=this._scene.autoClear,this._nonVRCamera=this._scene.activeCamera,this._attachedToElement=!!(!((o=this._nonVRCamera)===null||o===void 0)&&o.inputs.attachedToElement),(a=this._nonVRCamera)===null||a===void 0||a.detachControl(),this._scene.activeCamera=this.camera,n!=="immersive-ar"?this._nonXRToXRCamera():(this._scene.autoClear=!1,this.camera.compensateOnFirstFrame=!1,this.camera.position.set(0,0,0),this.camera.rotationQuaternion.set(0,0,0,1)),this.sessionManager.onXRSessionEnded.addOnce(function(){u.state!==Ce.EXITING_XR&&u._setState(Ce.EXITING_XR),u.camera.rigCameras.forEach(function(d){d.outputRenderTarget=null}),u._scene.autoClear=u._originalSceneAutoClear,u._scene.activeCamera=u._nonVRCamera,u._attachedToElement&&u._nonVRCamera&&u._nonVRCamera.attachControl(!!u._nonVRCamera.inputs.noPreventDefault),n!=="immersive-ar"&&u.camera.compensateOnFirstFrame&&(u._nonVRCamera.setPosition?u._nonVRCamera.setPosition(u.camera.position):u._nonVRCamera.position.copyFrom(u.camera.position)),u._setState(Ce.NOT_IN_XR)}),this.sessionManager.onXRFrameObservable.addOnce(function(){u._setState(Ce.IN_XR)}),[2,this.sessionManager];case 6:throw l=f.sent(),console.log(l),console.log(l.message),this._setState(Ce.NOT_IN_XR),l;case 7:return[2]}})})},r.prototype.exitXRAsync=function(){return this.state!==Ce.IN_XR?Promise.resolve():(this._setState(Ce.EXITING_XR),this.sessionManager.exitXRAsync())},r.prototype.enableSpectatorMode=function(){var n=this;if(!this._spectatorMode){var e=function(){n._spectatorCamera&&(n._spectatorCamera.position.copyFrom(n.camera.rigCameras[0].globalPosition),n._spectatorCamera.rotationQuaternion.copyFrom(n.camera.rigCameras[0].absoluteRotation))},t=function(){n.state===Ce.IN_XR?(n._spectatorCamera=new yi("webxr-spectator",y.Zero(),n._scene),n._spectatorCamera.rotationQuaternion=new q,n._scene.activeCameras=[n.camera,n._spectatorCamera],n.sessionManager.onXRFrameObservable.add(e),n._scene.onAfterRenderCameraObservable.add(function(i){i===n.camera&&(n._scene.getEngine().framebufferDimensionsObject=null)})):n.state===Ce.EXITING_XR&&(n.sessionManager.onXRFrameObservable.removeCallback(e),n._scene.activeCameras=null)};this._spectatorMode=!0,this.onStateChangedObservable.add(t),t()}},r.prototype._nonXRToXRCamera=function(){this.camera.setTransformationFromNonVRCamera(this._nonVRCamera),this.onInitialXRPoseSetObservable.notifyObservers(this.camera)},r.prototype._setState=function(n){this.state!==n&&(this.state=n,this.onStateChangedObservable.notifyObservers(this.state))},r}(),kt=function(){function r(n,e,t,i){t===void 0&&(t=-1),i===void 0&&(i=[]),this.id=n,this.type=e,this._buttonIndex=t,this._axesIndices=i,this._axes={x:0,y:0},this._changes={},this._currentValue=0,this._hasChanges=!1,this._pressed=!1,this._touched=!1,this.onAxisValueChangedObservable=new U,this.onButtonStateChangedObservable=new U}return Object.defineProperty(r.prototype,"axes",{get:function(){return this._axes},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"changes",{get:function(){return this._changes},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"hasChanges",{get:function(){return this._hasChanges},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"pressed",{get:function(){return this._pressed},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"touched",{get:function(){return this._touched},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"value",{get:function(){return this._currentValue},enumerable:!1,configurable:!0}),r.prototype.dispose=function(){this.onAxisValueChangedObservable.clear(),this.onButtonStateChangedObservable.clear()},r.prototype.isAxes=function(){return this._axesIndices.length!==0},r.prototype.isButton=function(){return this._buttonIndex!==-1},r.prototype.update=function(n){var e=!1,t=!1;if(this._hasChanges=!1,this._changes={},this.isButton()){var i=n.buttons[this._buttonIndex];if(!i)return;this._currentValue!==i.value&&(this.changes.value={current:i.value,previous:this._currentValue},e=!0,this._currentValue=i.value),this._touched!==i.touched&&(this.changes.touched={current:i.touched,previous:this._touched},e=!0,this._touched=i.touched),this._pressed!==i.pressed&&(this.changes.pressed={current:i.pressed,previous:this._pressed},e=!0,this._pressed=i.pressed)}this.isAxes()&&(this._axes.x!==n.axes[this._axesIndices[0]]&&(this.changes.axes={current:{x:n.axes[this._axesIndices[0]],y:this._axes.y},previous:{x:this._axes.x,y:this._axes.y}},this._axes.x=n.axes[this._axesIndices[0]],t=!0),this._axes.y!==n.axes[this._axesIndices[1]]&&(this.changes.axes?this.changes.axes.current.y=n.axes[this._axesIndices[1]]:this.changes.axes={current:{x:this._axes.x,y:n.axes[this._axesIndices[1]]},previous:{x:this._axes.x,y:this._axes.y}},this._axes.y=n.axes[this._axesIndices[1]],t=!0)),e&&(this._hasChanges=!0,this.onButtonStateChangedObservable.notifyObservers(this)),t&&(this._hasChanges=!0,this.onAxisValueChangedObservable.notifyObservers(this._axes))},r.BUTTON_TYPE="button",r.SQUEEZE_TYPE="squeeze",r.THUMBSTICK_TYPE="thumbstick",r.TOUCHPAD_TYPE="touchpad",r.TRIGGER_TYPE="trigger",r}(),br=function(){function r(n,e,t,i,o,a){o===void 0&&(o=!1);var s=this;this.scene=n,this.layout=e,this.gamepadObject=t,this.handedness=i,this._doNotLoadControllerMesh=o,this._controllerCache=a,this._initComponent=function(c){if(!!c){var l=s.layout.components[c],u=l.type,f=l.gamepadIndices.button,d=[];l.gamepadIndices.xAxis!==void 0&&l.gamepadIndices.yAxis!==void 0&&d.push(l.gamepadIndices.xAxis,l.gamepadIndices.yAxis),s.components[c]=new kt(c,u,f,d)}},this._modelReady=!1,this.components={},this.disableAnimation=!1,this.onModelLoadedObservable=new U,e.components&&Object.keys(e.components).forEach(this._initComponent)}return r.prototype.dispose=function(){var n=this;this.getComponentIds().forEach(function(e){return n.getComponent(e).dispose()}),this.rootMesh&&(this.rootMesh.getChildren(void 0,!0).forEach(function(e){e.setEnabled(!1)}),this.rootMesh.dispose(!!this._controllerCache,!this._controllerCache))},r.prototype.getAllComponentsOfType=function(n){var e=this;return this.getComponentIds().map(function(t){return e.components[t]}).filter(function(t){return t.type===n})},r.prototype.getComponent=function(n){return this.components[n]},r.prototype.getComponentIds=function(){return Object.keys(this.components)},r.prototype.getComponentOfType=function(n){return this.getAllComponentsOfType(n)[0]||null},r.prototype.getMainComponent=function(){return this.getComponent(this.layout.selectComponentId)},r.prototype.loadModel=function(){return it(this,void 0,void 0,function(){var n,e,t=this;return rt(this,function(i){return n=!this._getModelLoadingConstraints(),e=this._getGenericFilenameAndPath(),n?ne.Warn("Falling back to generic models"):e=this._getFilenameAndPath(),[2,new Promise(function(o,a){var s=function(l){n?t._getGenericParentMesh(l):t._setRootMesh(l),t._processLoadedModel(l),t._modelReady=!0,t.onModelLoadedObservable.notifyObservers(t),o(!0)};if(t._controllerCache){var c=t._controllerCache.filter(function(l){return l.filename===e.filename&&l.path===e.path});if(c[0]){c[0].meshes.forEach(function(l){return l.setEnabled(!0)}),s(c[0].meshes);return}}on.ImportMesh("",e.path,e.filename,t.scene,function(l){t._controllerCache&&t._controllerCache.push(Oe(Oe({},e),{meshes:l})),s(l)},null,function(l,u){ne.Log(u),ne.Warn("Failed to retrieve controller model of type ".concat(t.profileId," from the remote server: ").concat(e.path).concat(e.filename)),a(u)})})]})})},r.prototype.updateFromXRFrame=function(n){var e=this;this.getComponentIds().forEach(function(t){return e.getComponent(t).update(e.gamepadObject)}),this.updateModel(n)},Object.defineProperty(r.prototype,"handness",{get:function(){return this.handedness},enumerable:!1,configurable:!0}),r.prototype.pulse=function(n,e,t){return t===void 0&&(t=0),this.gamepadObject.hapticActuators&&this.gamepadObject.hapticActuators[t]?this.gamepadObject.hapticActuators[t].pulse(n,e):Promise.resolve(!1)},r.prototype._getChildByName=function(n,e){return n.getChildren(function(t){return t.name===e},!1)[0]},r.prototype._getImmediateChildByName=function(n,e){return n.getChildren(function(t){return t.name==e},!0)[0]},r.prototype._lerpTransform=function(n,e,t){if(!(!n.minMesh||!n.maxMesh||!n.valueMesh)&&!(!n.minMesh.rotationQuaternion||!n.maxMesh.rotationQuaternion||!n.valueMesh.rotationQuaternion)){var i=t?e*.5+.5:e;q.SlerpToRef(n.minMesh.rotationQuaternion,n.maxMesh.rotationQuaternion,i,n.valueMesh.rotationQuaternion),y.LerpToRef(n.minMesh.position,n.maxMesh.position,i,n.valueMesh.position)}},r.prototype.updateModel=function(n){!this._modelReady||this._updateModel(n)},r.prototype._getGenericFilenameAndPath=function(){return{filename:"generic.babylon",path:"https://controllers.babylonjs.com/generic/"}},r.prototype._getGenericParentMesh=function(n){var e=this;this.rootMesh=new he(this.profileId+" "+this.handedness,this.scene),n.forEach(function(t){t.parent||(t.isPickable=!1,t.setParent(e.rootMesh))}),this.rootMesh.rotationQuaternion=q.FromEulerAngles(0,Math.PI,0)},r}(),Vi=function(r){R(n,r);function n(e,t,i){var o=r.call(this,e,qo[i],t,i)||this;return o.profileId=n.ProfileId,o}return n.prototype._getFilenameAndPath=function(){return{filename:"generic.babylon",path:"https://controllers.babylonjs.com/generic/"}},n.prototype._getModelLoadingConstraints=function(){return!0},n.prototype._processLoadedModel=function(e){},n.prototype._setRootMesh=function(e){var t=this;this.rootMesh=new he(this.profileId+" "+this.handedness,this.scene),e.forEach(function(i){i.isPickable=!1,i.parent||i.setParent(t.rootMesh)}),this.rootMesh.rotationQuaternion=q.FromEulerAngles(0,Math.PI,0)},n.prototype._updateModel=function(){},n.ProfileId="generic-trigger",n}(br),qo={left:{selectComponentId:"xr-standard-trigger",components:{"xr-standard-trigger":{type:"trigger",gamepadIndices:{button:0},rootNodeName:"xr_standard_trigger",visualResponses:{}}},gamepadMapping:"xr-standard",rootNodeName:"generic-trigger-left",assetPath:"left.glb"},right:{selectComponentId:"xr-standard-trigger",components:{"xr-standard-trigger":{type:"trigger",gamepadIndices:{button:0},rootNodeName:"xr_standard_trigger",visualResponses:{}}},gamepadMapping:"xr-standard",rootNodeName:"generic-trigger-right",assetPath:"right.glb"},none:{selectComponentId:"xr-standard-trigger",components:{"xr-standard-trigger":{type:"trigger",gamepadIndices:{button:0},rootNodeName:"xr_standard_trigger",visualResponses:{}}},gamepadMapping:"xr-standard",rootNodeName:"generic-trigger-none",assetPath:"none.glb"}},Zo=function(r){R(n,r);function n(e,t,i,o,a){var s=r.call(this,e,i.layouts[t.handedness||"none"],t.gamepad,t.handedness,void 0,a)||this;return s._repositoryUrl=o,s.controllerCache=a,s._buttonMeshMapping={},s._touchDots={},s.profileId=i.profileId,s}return n.prototype.dispose=function(){var e=this;r.prototype.dispose.call(this),this.controllerCache||Object.keys(this._touchDots).forEach(function(t){e._touchDots[t].dispose()})},n.prototype._getFilenameAndPath=function(){return{filename:this.layout.assetPath,path:"".concat(this._repositoryUrl,"/profiles/").concat(this.profileId,"/")}},n.prototype._getModelLoadingConstraints=function(){var e=on.IsPluginForExtensionAvailable(".glb");return e||ne.Warn("glTF / glb loader was not registered, using generic controller instead"),e},n.prototype._processLoadedModel=function(e){var t=this;this.getComponentIds().forEach(function(i){var o=t.layout.components[i];t._buttonMeshMapping[i]={mainMesh:t._getChildByName(t.rootMesh,o.rootNodeName),states:{}},Object.keys(o.visualResponses).forEach(function(a){var s=o.visualResponses[a];if(s.valueNodeProperty==="transform")t._buttonMeshMapping[i].states[a]={valueMesh:t._getChildByName(t.rootMesh,s.valueNodeName),minMesh:t._getChildByName(t.rootMesh,s.minNodeName),maxMesh:t._getChildByName(t.rootMesh,s.maxNodeName)};else{var c=o.type===kt.TOUCHPAD_TYPE&&o.touchPointNodeName?o.touchPointNodeName:s.valueNodeName;if(t._buttonMeshMapping[i].states[a]={valueMesh:t._getChildByName(t.rootMesh,c)},o.type===kt.TOUCHPAD_TYPE&&!t._touchDots[a]){var l=Pn(a+"dot",{diameter:.0015,segments:8},t.scene);l.material=new Ze(a+"mat",t.scene),l.material.diffuseColor=G.Red(),l.parent=t._buttonMeshMapping[i].states[a].valueMesh||null,l.isVisible=!1,t._touchDots[a]=l}}})})},n.prototype._setRootMesh=function(e){this.rootMesh=new he(this.profileId+"-"+this.handedness,this.scene),this.rootMesh.isPickable=!1;for(var t,i=0;i<e.length;i++){var o=e[i];o.isPickable=!1,o.parent||(t=o)}t&&t.setParent(this.rootMesh),this.scene.useRightHandedSystem||this.rootMesh.rotate(cn.Y,Math.PI,eo.WORLD)},n.prototype._updateModel=function(e){var t=this;this.disableAnimation||this.getComponentIds().forEach(function(i){var o=t.getComponent(i);if(!!o.hasChanges){var a=t._buttonMeshMapping[i],s=t.layout.components[i];Object.keys(s.visualResponses).forEach(function(c){var l=s.visualResponses[c],u=o.value;if(l.componentProperty==="xAxis"?u=o.axes.x:l.componentProperty==="yAxis"&&(u=o.axes.y),l.valueNodeProperty==="transform")t._lerpTransform(a.states[c],u,l.componentProperty!=="button");else{var f=a.states[c].valueMesh;f&&(f.isVisible=o.touched||o.pressed),t._touchDots[c]&&(t._touchDots[c].isVisible=o.touched||o.pressed)}})}})},n}(br),Cn=[],je=function(){function r(){}return r.ClearProfilesCache=function(){this._ProfilesList=null,this._ProfileLoadingPromises={}},r.DefaultFallbacks=function(){this.RegisterFallbacksForProfileId("google-daydream",["generic-touchpad"]),this.RegisterFallbacksForProfileId("htc-vive-focus",["generic-trigger-touchpad"]),this.RegisterFallbacksForProfileId("htc-vive",["generic-trigger-squeeze-touchpad"]),this.RegisterFallbacksForProfileId("magicleap-one",["generic-trigger-squeeze-touchpad"]),this.RegisterFallbacksForProfileId("windows-mixed-reality",["generic-trigger-squeeze-touchpad-thumbstick"]),this.RegisterFallbacksForProfileId("microsoft-mixed-reality",["windows-mixed-reality","generic-trigger-squeeze-touchpad-thumbstick"]),this.RegisterFallbacksForProfileId("oculus-go",["generic-trigger-touchpad"]),this.RegisterFallbacksForProfileId("oculus-touch-v2",["oculus-touch","generic-trigger-squeeze-thumbstick"]),this.RegisterFallbacksForProfileId("oculus-touch",["generic-trigger-squeeze-thumbstick"]),this.RegisterFallbacksForProfileId("samsung-gearvr",["windows-mixed-reality","generic-trigger-squeeze-touchpad-thumbstick"]),this.RegisterFallbacksForProfileId("samsung-odyssey",["generic-touchpad"]),this.RegisterFallbacksForProfileId("valve-index",["generic-trigger-squeeze-touchpad-thumbstick"]),this.RegisterFallbacksForProfileId("generic-hand-select",["generic-trigger"])},r.FindFallbackWithProfileId=function(n){var e=this._Fallbacks[n]||[];return e.unshift(n),e},r.GetMotionControllerWithXRInput=function(n,e,t){var i=this,o=[];if(t&&o.push(t),o.push.apply(o,n.profiles||[]),o.length&&!o[0]&&o.pop(),n.gamepad&&n.gamepad.id)switch(n.gamepad.id){case(n.gamepad.id.match(/oculus touch/gi)?n.gamepad.id:void 0):o.push("oculus-touch-v2");break}var a=o.indexOf("windows-mixed-reality");if(a!==-1&&o.splice(a,0,"microsoft-mixed-reality"),o.length||o.push("generic-trigger"),this.UseOnlineRepository){var s=this.PrioritizeOnlineRepository?this._LoadProfileFromRepository:this._LoadProfilesFromAvailableControllers,c=this.PrioritizeOnlineRepository?this._LoadProfilesFromAvailableControllers:this._LoadProfileFromRepository;return s.call(this,o,n,e).catch(function(){return c.call(i,o,n,e)})}else return this._LoadProfilesFromAvailableControllers(o,n,e)},r.RegisterController=function(n,e){this._AvailableControllers[n]=e},r.RegisterFallbacksForProfileId=function(n,e){var t;this._Fallbacks[n]?(t=this._Fallbacks[n]).push.apply(t,e):this._Fallbacks[n]=e},r.UpdateProfilesList=function(){return this._ProfilesList=z.LoadFileAsync(this.BaseRepositoryUrl+"/profiles/profilesList.json",!1).then(function(n){return JSON.parse(n.toString())}),this._ProfilesList},r.ClearControllerCache=function(){Cn.forEach(function(n){n.meshes.forEach(function(e){e.dispose(!1,!0)})}),Cn.length=0},r._LoadProfileFromRepository=function(n,e,t){var i=this;return Promise.resolve().then(function(){return i._ProfilesList?i._ProfilesList:i.UpdateProfilesList()}).then(function(o){for(var a=0;a<n.length;++a)if(!!n[a]&&o[n[a]])return n[a];throw new Error("neither controller ".concat(n[0]," nor all fallbacks were found in the repository,"))}).then(function(o){return i._ProfileLoadingPromises[o]||(i._ProfileLoadingPromises[o]=z.LoadFileAsync("".concat(i.BaseRepositoryUrl,"/profiles/").concat(o,"/profile.json"),!1).then(function(a){return JSON.parse(a)})),i._ProfileLoadingPromises[o]}).then(function(o){return new Zo(t,e,o,i.BaseRepositoryUrl,i.DisableControllerCache?void 0:Cn)})},r._LoadProfilesFromAvailableControllers=function(n,e,t){for(var i=0;i<n.length;++i)if(!!n[i])for(var o=this.FindFallbackWithProfileId(n[i]),a=0;a<o.length;++a){var s=this._AvailableControllers[o[a]];if(s)return Promise.resolve(s(e,t))}throw new Error("no controller requested was found in the available controllers list")},r._AvailableControllers={},r._Fallbacks={},r._ProfileLoadingPromises={},r.BaseRepositoryUrl="https://immersive-web.github.io/webxr-input-profiles/packages/viewer/dist",r.PrioritizeOnlineRepository=!0,r.UseOnlineRepository=!0,r.DisableControllerCache=!0,r}();je.RegisterController(Vi.ProfileId,function(r,n){return new Vi(n,r.gamepad,r.handedness)});je.DefaultFallbacks();var Jo=0,$o=function(){function r(n,e,t){t===void 0&&(t={});var i=this;this._scene=n,this.inputSource=e,this._options=t,this._tmpVector=new y,this._disposed=!1,this.onDisposeObservable=new U,this.onMeshLoadedObservable=new U,this.onMotionControllerInitObservable=new U,this._uniqueId="controller-".concat(Jo++,"-").concat(e.targetRayMode,"-").concat(e.handedness),this.pointer=new Rt("".concat(this._uniqueId,"-pointer"),n),this.pointer.rotationQuaternion=new q,this.inputSource.gripSpace&&(this.grip=new Rt("".concat(this._uniqueId,"-grip"),this._scene),this.grip.rotationQuaternion=new q),this._tmpVector.set(0,0,this._scene.useRightHandedSystem?-1:1),this.inputSource.gamepad&&this.inputSource.targetRayMode==="tracked-pointer"&&je.GetMotionControllerWithXRInput(e,n,this._options.forceControllerProfile).then(function(o){i.motionController=o,i.onMotionControllerInitObservable.notifyObservers(o),!i._options.doNotLoadControllerMesh&&!i.motionController._doNotLoadControllerMesh&&i.motionController.loadModel().then(function(a){var s;a&&i.motionController&&i.motionController.rootMesh&&(i._options.renderingGroupId&&(i.motionController.rootMesh.renderingGroupId=i._options.renderingGroupId,i.motionController.rootMesh.getChildMeshes(!1).forEach(function(c){return c.renderingGroupId=i._options.renderingGroupId})),i.onMeshLoadedObservable.notifyObservers(i.motionController.rootMesh),i.motionController.rootMesh.parent=i.grip||i.pointer,i.motionController.disableAnimation=!!i._options.disableMotionControllerAnimation),i._disposed&&((s=i.motionController)===null||s===void 0||s.dispose())})},function(){z.Warn("Could not find a matching motion controller for the registered input source")})}return Object.defineProperty(r.prototype,"uniqueId",{get:function(){return this._uniqueId},enumerable:!1,configurable:!0}),r.prototype.dispose=function(){this.grip&&this.grip.dispose(!0),this.motionController&&this.motionController.dispose(),this.pointer.dispose(!0),this.onMotionControllerInitObservable.clear(),this.onMeshLoadedObservable.clear(),this.onDisposeObservable.notifyObservers(this),this.onDisposeObservable.clear(),this._disposed=!0},r.prototype.getWorldPointerRayToRef=function(n,e){e===void 0&&(e=!1);var t=e&&this.grip?this.grip:this.pointer;y.TransformNormalToRef(this._tmpVector,t.getWorldMatrix(),n.direction),n.direction.normalize(),n.origin.copyFrom(t.absolutePosition),n.length=1e3},r.prototype.updateFromXRFrame=function(n,e,t){var i=n.getPose(this.inputSource.targetRaySpace,e);if(this._lastXRPose=i,i){var o=i.transform.position;this.pointer.position.set(o.x,o.y,o.z);var a=i.transform.orientation;this.pointer.rotationQuaternion.set(a.x,a.y,a.z,a.w),this._scene.useRightHandedSystem||(this.pointer.position.z*=-1,this.pointer.rotationQuaternion.z*=-1,this.pointer.rotationQuaternion.w*=-1),this.pointer.parent=t.parent}if(this.inputSource.gripSpace&&this.grip){var s=n.getPose(this.inputSource.gripSpace,e);if(s){var o=s.transform.position,c=s.transform.orientation;this.grip.position.set(o.x,o.y,o.z),this.grip.rotationQuaternion.set(c.x,c.y,c.z,c.w),this._scene.useRightHandedSystem||(this.grip.position.z*=-1,this.grip.rotationQuaternion.z*=-1,this.grip.rotationQuaternion.w*=-1)}this.grip.parent=t.parent}this.motionController&&this.motionController.updateFromXRFrame(n)},r}(),ea=function(){function r(n,e,t){t===void 0&&(t={});var i=this;if(this.xrSessionManager=n,this.xrCamera=e,this._options=t,this.controllers=[],this.onControllerAddedObservable=new U,this.onControllerRemovedObservable=new U,this._onInputSourcesChange=function(o){i._addAndRemoveControllers(o.added,o.removed)},this._sessionEndedObserver=this.xrSessionManager.onXRSessionEnded.add(function(){i._addAndRemoveControllers([],i.controllers.map(function(o){return o.inputSource}))}),this._sessionInitObserver=this.xrSessionManager.onXRSessionInit.add(function(o){o.addEventListener("inputsourceschange",i._onInputSourcesChange)}),this._frameObserver=this.xrSessionManager.onXRFrameObservable.add(function(o){i.controllers.forEach(function(a){a.updateFromXRFrame(o,i.xrSessionManager.referenceSpace,i.xrCamera)})}),this._options.customControllersRepositoryURL&&(je.BaseRepositoryUrl=this._options.customControllersRepositoryURL),je.UseOnlineRepository=!this._options.disableOnlineControllerRepository,je.UseOnlineRepository)try{je.UpdateProfilesList().catch(function(){je.UseOnlineRepository=!1})}catch{je.UseOnlineRepository=!1}}return r.prototype._addAndRemoveControllers=function(n,e){for(var t=this,i=this.controllers.map(function(f){return f.inputSource}),o=0,a=n;o<a.length;o++){var s=a[o];if(i.indexOf(s)===-1){var c=new $o(this.xrSessionManager.scene,s,Oe(Oe({},this._options.controllerOptions||{}),{forceControllerProfile:this._options.forceInputProfile,doNotLoadControllerMesh:this._options.doNotLoadControllerMeshes,disableMotionControllerAnimation:this._options.disableControllerAnimation}));this.controllers.push(c),this.onControllerAddedObservable.notifyObservers(c)}}var l=[],u=[];this.controllers.forEach(function(f){e.indexOf(f.inputSource)===-1?l.push(f):u.push(f)}),this.controllers=l,u.forEach(function(f){t.onControllerRemovedObservable.notifyObservers(f),f.dispose()})},r.prototype.dispose=function(){this.controllers.forEach(function(n){n.dispose()}),this.xrSessionManager.onXRFrameObservable.remove(this._frameObserver),this.xrSessionManager.onXRSessionInit.remove(this._sessionInitObserver),this.xrSessionManager.onXRSessionEnded.remove(this._sessionEndedObserver),this.onControllerAddedObservable.clear(),this.onControllerRemovedObservable.clear(),je.ClearControllerCache()},r}(),Ci=function(){function r(n){this._xrSessionManager=n,this._attached=!1,this._removeOnDetach=[],this.isDisposed=!1,this.disableAutoAttach=!1,this.xrNativeFeatureName=""}return Object.defineProperty(r.prototype,"attached",{get:function(){return this._attached},enumerable:!1,configurable:!0}),r.prototype.attach=function(n){var e=this;if(this.isDisposed)return!1;if(n)this.attached&&this.detach();else if(this.attached)return!1;return this._attached=!0,this._addNewAttachObserver(this._xrSessionManager.onXRFrameObservable,function(t){return e._onXRFrame(t)}),!0},r.prototype.detach=function(){return this._attached?(this._attached=!1,this._removeOnDetach.forEach(function(n){n.observable.remove(n.observer)}),!0):(this.disableAutoAttach=!0,!1)},r.prototype.dispose=function(){this.detach(),this.isDisposed=!0},r.prototype.isCompatible=function(){return!0},r.prototype._addNewAttachObserver=function(n,e){this._removeOnDetach.push({observable:n,observer:n.add(e)})},r}(),Jt=function(r){R(n,r);function n(e,t){var i=r.call(this,e)||this;return i._options=t,i._attachController=function(o){if(!i._controllers[o.uniqueId]){var a=i._generateNewMeshPair(o.pointer),s=a.laserPointer,c=a.selectionMesh;switch(i._controllers[o.uniqueId]={xrController:o,laserPointer:s,selectionMesh:c,meshUnderPointer:null,pick:null,tmpRay:new pt(new y,new y),disabledByNearInteraction:!1,id:n._IdCounter++},i._attachedController?!i._options.enablePointerSelectionOnAllControllers&&i._options.preferredHandedness&&o.inputSource.handedness===i._options.preferredHandedness&&(i._attachedController=o.uniqueId):i._options.enablePointerSelectionOnAllControllers||(i._attachedController=o.uniqueId),o.inputSource.targetRayMode){case"tracked-pointer":return i._attachTrackedPointerRayMode(o);case"gaze":return i._attachGazeMode(o);case"screen":return i._attachScreenRayMode(o)}}},i._controllers={},i._tmpVectorForPickCompare=new y,i.disablePointerLighting=!0,i.disableSelectionMeshLighting=!0,i.displayLaserPointer=!0,i.displaySelectionMesh=!0,i.laserPointerPickedColor=new G(.9,.9,.9),i.laserPointerDefaultColor=new G(.7,.7,.7),i.selectionMeshDefaultColor=new G(.8,.8,.8),i.selectionMeshPickedColor=new G(.3,.3,1),i._identityMatrix=Q.Identity(),i._screenCoordinatesRef=y.Zero(),i._viewportRef=new In(0,0,0,0),i._scene=i._xrSessionManager.scene,i}return n.prototype.attach=function(){var e=this;if(!r.prototype.attach.call(this))return!1;if(this._options.xrInput.controllers.forEach(this._attachController),this._addNewAttachObserver(this._options.xrInput.onControllerAddedObservable,this._attachController),this._addNewAttachObserver(this._options.xrInput.onControllerRemovedObservable,function(s){e._detachController(s.uniqueId)}),this._scene.constantlyUpdateMeshUnderPointer=!0,this._options.gazeCamera){var t=this._options.gazeCamera,i=this._generateNewMeshPair(t),o=i.laserPointer,a=i.selectionMesh;this._controllers.camera={webXRCamera:t,laserPointer:o,selectionMesh:a,meshUnderPointer:null,pick:null,tmpRay:new pt(new y,new y),disabledByNearInteraction:!1,id:n._IdCounter++},this._attachGazeMode()}return!0},n.prototype.detach=function(){var e=this;return r.prototype.detach.call(this)?(Object.keys(this._controllers).forEach(function(t){e._detachController(t)}),!0):!1},n.prototype.getMeshUnderPointer=function(e){return this._controllers[e]?this._controllers[e].meshUnderPointer:null},n.prototype.getXRControllerByPointerId=function(e){for(var t=Object.keys(this._controllers),i=0;i<t.length;++i)if(this._controllers[t[i]].id===e)return this._controllers[t[i]].xrController||null;return null},n.prototype._getPointerSelectionDisabledByPointerId=function(e){for(var t=Object.keys(this._controllers),i=0;i<t.length;++i)if(this._controllers[t[i]].id===e)return this._controllers[t[i]].disabledByNearInteraction;return!0},n.prototype._setPointerSelectionDisabledByPointerId=function(e,t){for(var i=Object.keys(this._controllers),o=0;o<i.length;++o)if(this._controllers[i[o]].id===e){this._controllers[i[o]].disabledByNearInteraction=t;return}},n.prototype._onXRFrame=function(e){var t=this;Object.keys(this._controllers).forEach(function(i){var o=t._controllers[i];if(!t._options.enablePointerSelectionOnAllControllers&&i!==t._attachedController||o.disabledByNearInteraction){o.selectionMesh.isVisible=!1,o.laserPointer.isVisible=!1,o.pick=null;return}o.laserPointer.isVisible=t.displayLaserPointer;var a;if(o.xrController)a=o.xrController.pointer.position,o.xrController.getWorldPointerRayToRef(o.tmpRay);else if(o.webXRCamera)a=o.webXRCamera.position,o.webXRCamera.getForwardRayToRef(o.tmpRay);else return;if(t._options.maxPointerDistance&&(o.tmpRay.length=t._options.maxPointerDistance),!t._options.disableScenePointerVectorUpdate&&a){var s=t._xrSessionManager.scene,c=t._options.xrInput.xrCamera;c&&(c.viewport.toGlobalToRef(s.getEngine().getRenderWidth(),s.getEngine().getRenderHeight(),t._viewportRef),y.ProjectToRef(a,t._identityMatrix,s.getTransformMatrix(),t._viewportRef,t._screenCoordinatesRef),typeof t._screenCoordinatesRef.x=="number"&&typeof t._screenCoordinatesRef.y=="number"&&!isNaN(t._screenCoordinatesRef.x)&&!isNaN(t._screenCoordinatesRef.y)&&(s.pointerX=t._screenCoordinatesRef.x,s.pointerY=t._screenCoordinatesRef.y,o.screenCoordinates={x:t._screenCoordinatesRef.x,y:t._screenCoordinatesRef.y}))}var l=null;t._utilityLayerScene&&(l=t._utilityLayerScene.pickWithRay(o.tmpRay,t._utilityLayerScene.pointerMovePredicate||t.raySelectionPredicate));var u=t._scene.pickWithRay(o.tmpRay,t._scene.pointerMovePredicate||t.raySelectionPredicate);!l||!l.hit?o.pick=u:!u||!u.hit||l.distance<u.distance?o.pick=l:o.pick=u,o.pick&&o.xrController&&(o.pick.aimTransform=o.xrController.pointer,o.pick.gripTransform=o.xrController.grip||null);var f=o.pick;if(f&&f.pickedPoint&&f.hit){t._updatePointerDistance(o.laserPointer,f.distance),o.selectionMesh.position.copyFrom(f.pickedPoint),o.selectionMesh.scaling.x=Math.sqrt(f.distance),o.selectionMesh.scaling.y=Math.sqrt(f.distance),o.selectionMesh.scaling.z=Math.sqrt(f.distance);var d=t._convertNormalToDirectionOfRay(f.getNormal(!0),o.tmpRay),p=.001;if(o.selectionMesh.position.copyFrom(f.pickedPoint),d){var m=y.Cross(cn.Y,d),_=y.Cross(d,m);y.RotationFromAxisToRef(_,d,m,o.selectionMesh.rotation),o.selectionMesh.position.addInPlace(d.scale(p))}o.selectionMesh.isVisible=t.displaySelectionMesh,o.meshUnderPointer=f.pickedMesh}else o.selectionMesh.isVisible=!1,t._updatePointerDistance(o.laserPointer,1),o.meshUnderPointer=null})},Object.defineProperty(n.prototype,"_utilityLayerScene",{get:function(){return this._options.customUtilityLayerScene||dt.DefaultUtilityLayer.utilityLayerScene},enumerable:!1,configurable:!0}),n.prototype._attachGazeMode=function(e){var t=this,i=this._controllers[e&&e.uniqueId||"camera"],o=this._options.timeToSelect||3e3,a=this._options.useUtilityLayer?this._utilityLayerScene:this._scene,s=new At,c=xn("selection",{diameter:.0035*15,thickness:.0025*6,tessellation:20},a);c.isVisible=!1,c.isPickable=!1,c.parent=i.selectionMesh;var l=0,u=!1,f={pointerId:i.id,pointerType:"xr"};i.onFrameObserver=this._xrSessionManager.onXRFrameObservable.add(function(){if(!!i.pick){if(t._augmentPointerInit(f,i.id,i.screenCoordinates),i.laserPointer.material.alpha=0,c.isVisible=!1,i.pick.hit)if(t._pickingMoved(s,i.pick))u&&(t._options.disablePointerUpOnTouchOut||t._scene.simulatePointerUp(i.pick,f)),u=!1,l=0;else if(l>o/10&&(c.isVisible=!0),l+=t._scene.getEngine().getDeltaTime(),l>=o)t._scene.simulatePointerDown(i.pick,f),u=!0,t._options.disablePointerUpOnTouchOut&&t._scene.simulatePointerUp(i.pick,f),c.isVisible=!1;else{var d=1-l/o;c.scaling.set(d,d,d)}else u=!1,l=0;t._scene.simulatePointerMove(i.pick,f),s=i.pick}}),this._options.renderingGroupId!==void 0&&(c.renderingGroupId=this._options.renderingGroupId),e&&e.onDisposeObservable.addOnce(function(){i.pick&&!t._options.disablePointerUpOnTouchOut&&u&&(t._scene.simulatePointerUp(i.pick,f),i.finalPointerUpTriggered=!0),c.dispose()})},n.prototype._attachScreenRayMode=function(e){var t=this,i=this._controllers[e.uniqueId],o=!1,a={pointerId:i.id,pointerType:"xr"};i.onFrameObserver=this._xrSessionManager.onXRFrameObservable.add(function(){t._augmentPointerInit(a,i.id,i.screenCoordinates),!(!i.pick||t._options.disablePointerUpOnTouchOut&&o)&&(o?t._scene.simulatePointerMove(i.pick,a):(t._scene.simulatePointerDown(i.pick,a),i.pointerDownTriggered=!0,o=!0,t._options.disablePointerUpOnTouchOut&&t._scene.simulatePointerUp(i.pick,a)))}),e.onDisposeObservable.addOnce(function(){t._augmentPointerInit(a,i.id,i.screenCoordinates),t._xrSessionManager.runInXRFrame(function(){i.pick&&!i.finalPointerUpTriggered&&o&&!t._options.disablePointerUpOnTouchOut&&(t._scene.simulatePointerUp(i.pick,a),i.finalPointerUpTriggered=!0)})})},n.prototype._attachTrackedPointerRayMode=function(e){var t=this,i=this._controllers[e.uniqueId];if(this._options.forceGazeMode)return this._attachGazeMode(e);var o={pointerId:i.id,pointerType:"xr"};if(i.onFrameObserver=this._xrSessionManager.onXRFrameObservable.add(function(){i.laserPointer.material.disableLighting=t.disablePointerLighting,i.selectionMesh.material.disableLighting=t.disableSelectionMeshLighting,i.pick&&(t._augmentPointerInit(o,i.id,i.screenCoordinates),t._scene.simulatePointerMove(i.pick,o))}),e.inputSource.gamepad){var a=function(l){t._options.overrideButtonId&&(i.selectionComponent=l.getComponent(t._options.overrideButtonId)),i.selectionComponent||(i.selectionComponent=l.getMainComponent()),i.onButtonChangedObserver=i.selectionComponent.onButtonStateChangedObservable.add(function(u){if(u.changes.pressed){var f=u.changes.pressed.current;i.pick?(t._options.enablePointerSelectionOnAllControllers||e.uniqueId===t._attachedController)&&(t._augmentPointerInit(o,i.id,i.screenCoordinates),f?(t._scene.simulatePointerDown(i.pick,o),i.pointerDownTriggered=!0,i.selectionMesh.material.emissiveColor=t.selectionMeshPickedColor,i.laserPointer.material.emissiveColor=t.laserPointerPickedColor):(t._scene.simulatePointerUp(i.pick,o),i.selectionMesh.material.emissiveColor=t.selectionMeshDefaultColor,i.laserPointer.material.emissiveColor=t.laserPointerDefaultColor)):f&&!t._options.enablePointerSelectionOnAllControllers&&!t._options.disableSwitchOnClick&&(t._attachedController=e.uniqueId)}})};e.motionController?a(e.motionController):e.onMotionControllerInitObservable.add(a)}else{var s=function(l){t._augmentPointerInit(o,i.id,i.screenCoordinates),i.xrController&&l.inputSource===i.xrController.inputSource&&i.pick&&(t._scene.simulatePointerDown(i.pick,o),i.pointerDownTriggered=!0,i.selectionMesh.material.emissiveColor=t.selectionMeshPickedColor,i.laserPointer.material.emissiveColor=t.laserPointerPickedColor)},c=function(l){t._augmentPointerInit(o,i.id,i.screenCoordinates),i.xrController&&l.inputSource===i.xrController.inputSource&&i.pick&&(t._scene.simulatePointerUp(i.pick,o),i.selectionMesh.material.emissiveColor=t.selectionMeshDefaultColor,i.laserPointer.material.emissiveColor=t.laserPointerDefaultColor)};i.eventListeners={selectend:c,selectstart:s},this._xrSessionManager.session.addEventListener("selectstart",s),this._xrSessionManager.session.addEventListener("selectend",c)}},n.prototype._convertNormalToDirectionOfRay=function(e,t){if(e){var i=Math.acos(y.Dot(e,t.direction));i<Math.PI/2&&e.scaleInPlace(-1)}return e},n.prototype._detachController=function(e){var t=this,i=this._controllers[e];if(!!i){if(i.selectionComponent&&i.onButtonChangedObserver&&i.selectionComponent.onButtonStateChangedObservable.remove(i.onButtonChangedObserver),i.onFrameObserver&&this._xrSessionManager.onXRFrameObservable.remove(i.onFrameObserver),i.eventListeners&&Object.keys(i.eventListeners).forEach(function(a){var s=i.eventListeners&&i.eventListeners[a];s&&t._xrSessionManager.session.removeEventListener(a,s)}),!i.finalPointerUpTriggered&&i.pointerDownTriggered){var o={pointerId:i.id,pointerType:"xr"};this._xrSessionManager.runInXRFrame(function(){t._augmentPointerInit(o,i.id,i.screenCoordinates),t._scene.simulatePointerUp(new At,o)})}this._xrSessionManager.scene.onBeforeRenderObservable.addOnce(function(){try{if(i.selectionMesh.dispose(),i.laserPointer.dispose(),delete t._controllers[e],t._attachedController===e){var a=Object.keys(t._controllers);a.length?t._attachedController=a[0]:t._attachedController=""}}catch{z.Warn("controller already detached.")}})}},n.prototype._generateNewMeshPair=function(e){var t=this._options.useUtilityLayer?this._options.customUtilityLayerScene||dt.DefaultUtilityLayer.utilityLayerScene:this._scene,i=this._options.customLasterPointerMeshGenerator?this._options.customLasterPointerMeshGenerator():$i("laserPointer",{height:1,diameterTop:2e-4,diameterBottom:.004,tessellation:20,subdivisions:1},t);i.parent=e;var o=new Ze("laserPointerMat",t);o.emissiveColor=this.laserPointerDefaultColor,o.alpha=.7,i.material=o,i.rotation.x=Math.PI/2,this._updatePointerDistance(i,1),i.isPickable=!1,i.isVisible=!1;var a=this._options.customSelectionMeshGenerator?this._options.customSelectionMeshGenerator():xn("gazeTracker",{diameter:.0035*3,thickness:.0025*3,tessellation:20},t);a.bakeCurrentTransformIntoVertices(),a.isPickable=!1,a.isVisible=!1;var s=new Ze("targetMat",t);return s.specularColor=G.Black(),s.emissiveColor=this.selectionMeshDefaultColor,s.backFaceCulling=!1,a.material=s,this._options.renderingGroupId!==void 0&&(i.renderingGroupId=this._options.renderingGroupId,a.renderingGroupId=this._options.renderingGroupId),{laserPointer:i,selectionMesh:a}},n.prototype._pickingMoved=function(e,t){var i;if(!e.hit||!t.hit||!e.pickedMesh||!e.pickedPoint||!t.pickedMesh||!t.pickedPoint||e.pickedMesh!==t.pickedMesh)return!0;(i=e.pickedPoint)===null||i===void 0||i.subtractToRef(t.pickedPoint,this._tmpVectorForPickCompare),this._tmpVectorForPickCompare.set(Math.abs(this._tmpVectorForPickCompare.x),Math.abs(this._tmpVectorForPickCompare.y),Math.abs(this._tmpVectorForPickCompare.z));var o=(this._options.gazeModePointerMovedFactor||1)*.01*t.distance,a=this._tmpVectorForPickCompare.length();return a>o},n.prototype._updatePointerDistance=function(e,t){t===void 0&&(t=100),e.scaling.y=t,this._scene.useRightHandedSystem&&(t*=-1),e.position.z=t/2+.05},n.prototype._augmentPointerInit=function(e,t,i){e.pointerId=t,e.pointerType="xr",i&&(e.screenX=i.x,e.screenY=i.y)},Object.defineProperty(n.prototype,"lasterPointerDefaultColor",{get:function(){return this.laserPointerDefaultColor},enumerable:!1,configurable:!0}),n._IdCounter=200,n.Name=$e.POINTER_SELECTION,n.Version=1,n}(Ci);un.AddWebXRFeature(Jt.Name,function(r,n){return function(){return new Jt(r,n)}},Jt.Version,!0);var h;(function(r){r[r.Float=1]="Float",r[r.Int=2]="Int",r[r.Vector2=4]="Vector2",r[r.Vector3=8]="Vector3",r[r.Vector4=16]="Vector4",r[r.Color3=32]="Color3",r[r.Color4=64]="Color4",r[r.Matrix=128]="Matrix",r[r.Object=256]="Object",r[r.AutoDetect=1024]="AutoDetect",r[r.BasedOnInput=2048]="BasedOnInput"})(h||(h={}));var g;(function(r){r[r.Vertex=1]="Vertex",r[r.Fragment=2]="Fragment",r[r.Neutral=4]="Neutral",r[r.VertexAndFragment=3]="VertexAndFragment"})(g||(g={}));var Ui=function(){function r(){this.supportUniformBuffers=!1,this.attributes=new Array,this.uniforms=new Array,this.constants=new Array,this.samplers=new Array,this.functions={},this.extensions={},this.counters={},this._attributeDeclaration="",this._uniformDeclaration="",this._constantDeclaration="",this._samplerDeclaration="",this._varyingTransfer="",this._injectAtEnd="",this._repeatableContentAnchorIndex=0,this._builtCompilationString="",this.compilationString=""}return r.prototype.finalize=function(n){var e=n.sharedData.emitComments,t=this.target===g.Fragment;this.compilationString=`\r
`.concat(e?`//Entry point\r
`:"",`void main(void) {\r
`).concat(this.compilationString),this._constantDeclaration&&(this.compilationString=`\r
`.concat(e?`//Constants\r
`:"").concat(this._constantDeclaration,`\r
`).concat(this.compilationString));var i="";for(var o in this.functions)i+=this.functions[o]+`\r
`;this.compilationString=`\r
`.concat(i,`\r
`).concat(this.compilationString),!t&&this._varyingTransfer&&(this.compilationString="".concat(this.compilationString,`\r
`).concat(this._varyingTransfer)),this._injectAtEnd&&(this.compilationString="".concat(this.compilationString,`\r
`).concat(this._injectAtEnd)),this.compilationString="".concat(this.compilationString,`\r
}`),this.sharedData.varyingDeclaration&&(this.compilationString=`\r
`.concat(e?`//Varyings\r
`:"").concat(this.sharedData.varyingDeclaration,`\r
`).concat(this.compilationString)),this._samplerDeclaration&&(this.compilationString=`\r
`.concat(e?`//Samplers\r
`:"").concat(this._samplerDeclaration,`\r
`).concat(this.compilationString)),this._uniformDeclaration&&(this.compilationString=`\r
`.concat(e?`//Uniforms\r
`:"").concat(this._uniformDeclaration,`\r
`).concat(this.compilationString)),this._attributeDeclaration&&!t&&(this.compilationString=`\r
`.concat(e?`//Attributes\r
`:"").concat(this._attributeDeclaration,`\r
`).concat(this.compilationString)),this.compilationString=`precision highp float;\r
`+this.compilationString;for(var a in this.extensions){var s=this.extensions[a];this.compilationString=`\r
`.concat(s,`\r
`).concat(this.compilationString)}this._builtCompilationString=this.compilationString},Object.defineProperty(r.prototype,"_repeatableContentAnchor",{get:function(){return"###___ANCHOR".concat(this._repeatableContentAnchorIndex++,"___###")},enumerable:!1,configurable:!0}),r.prototype._getFreeVariableName=function(n){return n=n.replace(/[^a-zA-Z_]+/g,""),this.sharedData.variableNames[n]===void 0?(this.sharedData.variableNames[n]=0,n==="output"||n==="texture"?n+this.sharedData.variableNames[n]:n):(this.sharedData.variableNames[n]++,n+this.sharedData.variableNames[n])},r.prototype._getFreeDefineName=function(n){return this.sharedData.defineNames[n]===void 0?this.sharedData.defineNames[n]=0:this.sharedData.defineNames[n]++,n+this.sharedData.defineNames[n]},r.prototype._excludeVariableName=function(n){this.sharedData.variableNames[n]=0},r.prototype._emit2DSampler=function(n){this.samplers.indexOf(n)<0&&(this._samplerDeclaration+="uniform sampler2D ".concat(n,`;\r
`),this.samplers.push(n))},r.prototype._getGLType=function(n){switch(n){case h.Float:return"float";case h.Int:return"int";case h.Vector2:return"vec2";case h.Color3:case h.Vector3:return"vec3";case h.Color4:case h.Vector4:return"vec4";case h.Matrix:return"mat4"}return""},r.prototype._emitExtension=function(n,e,t){t===void 0&&(t=""),!this.extensions[n]&&(t&&(e="#if ".concat(t,`\r
`).concat(e,`\r
#endif`)),this.extensions[n]=e)},r.prototype._emitFunction=function(n,e,t){this.functions[n]||(this.sharedData.emitComments&&(e=t+`\r
`+e),this.functions[n]=e)},r.prototype._emitCodeFromInclude=function(n,e,t){if(t&&t.repeatKey)return"#include<".concat(n,">[0..").concat(t.repeatKey,`]\r
`);var i=ve.IncludesShadersStore[n]+`\r
`;if(this.sharedData.emitComments&&(i=e+`\r
`+i),!t)return i;if(t.replaceStrings)for(var o=0;o<t.replaceStrings.length;o++){var a=t.replaceStrings[o];i=i.replace(a.search,a.replace)}return i},r.prototype._emitFunctionFromInclude=function(n,e,t,i){i===void 0&&(i="");var o=n+i;if(!this.functions[o]){if(!t||!t.removeAttributes&&!t.removeUniforms&&!t.removeVaryings&&!t.removeIfDef&&!t.replaceStrings){t&&t.repeatKey?this.functions[o]="#include<".concat(n,">[0..").concat(t.repeatKey,`]\r
`):this.functions[o]="#include<".concat(n,`>\r
`),this.sharedData.emitComments&&(this.functions[o]=e+`\r
`+this.functions[o]);return}if(this.functions[o]=ve.IncludesShadersStore[n],this.sharedData.emitComments&&(this.functions[o]=e+`\r
`+this.functions[o]),t.removeIfDef&&(this.functions[o]=this.functions[o].replace(/^\s*?#ifdef.+$/gm,""),this.functions[o]=this.functions[o].replace(/^\s*?#endif.*$/gm,""),this.functions[o]=this.functions[o].replace(/^\s*?#else.*$/gm,""),this.functions[o]=this.functions[o].replace(/^\s*?#elif.*$/gm,"")),t.removeAttributes&&(this.functions[o]=this.functions[o].replace(/^\s*?attribute.+$/gm,"")),t.removeUniforms&&(this.functions[o]=this.functions[o].replace(/^\s*?uniform.+$/gm,"")),t.removeVaryings&&(this.functions[o]=this.functions[o].replace(/^\s*?varying.+$/gm,"")),t.replaceStrings)for(var a=0;a<t.replaceStrings.length;a++){var s=t.replaceStrings[a];this.functions[o]=this.functions[o].replace(s.search,s.replace)}}},r.prototype._registerTempVariable=function(n){return this.sharedData.temps.indexOf(n)!==-1?!1:(this.sharedData.temps.push(n),!0)},r.prototype._emitVaryingFromString=function(n,e,t,i){return t===void 0&&(t=""),i===void 0&&(i=!1),this.sharedData.varyings.indexOf(n)!==-1?!1:(this.sharedData.varyings.push(n),t&&(Mi(t,"defined(")?this.sharedData.varyingDeclaration+="#if ".concat(t,`\r
`):this.sharedData.varyingDeclaration+="".concat(i?"#ifndef":"#ifdef"," ").concat(t,`\r
`)),this.sharedData.varyingDeclaration+="varying ".concat(e," ").concat(n,`;\r
`),t&&(this.sharedData.varyingDeclaration+=`#endif\r
`),!0)},r.prototype._emitUniformFromString=function(n,e,t,i){t===void 0&&(t=""),i===void 0&&(i=!1),this.uniforms.indexOf(n)===-1&&(this.uniforms.push(n),t&&(Mi(t,"defined(")?this._uniformDeclaration+="#if ".concat(t,`\r
`):this._uniformDeclaration+="".concat(i?"#ifndef":"#ifdef"," ").concat(t,`\r
`)),this._uniformDeclaration+="uniform ".concat(e," ").concat(n,`;\r
`),t&&(this._uniformDeclaration+=`#endif\r
`))},r.prototype._emitFloat=function(n){return n.toString()===n.toFixed(0)?"".concat(n,".0"):n.toString()},r}(),ta=function(){function r(){this.temps=new Array,this.varyings=new Array,this.varyingDeclaration="",this.inputBlocks=new Array,this.textureBlocks=new Array,this.bindableBlocks=new Array,this.forcedBindableBlocks=new Array,this.blocksWithFallbacks=new Array,this.blocksWithDefines=new Array,this.repeatableContentBlocks=new Array,this.dynamicUniformBlocks=new Array,this.blockingBlocks=new Array,this.animatedInputs=new Array,this.variableNames={},this.defineNames={},this.hints={needWorldViewMatrix:!1,needWorldViewProjectionMatrix:!1,needAlphaBlending:!1,needAlphaTesting:!1},this.checks={emitVertex:!1,emitFragment:!1,notConnectedNonOptionalInputs:new Array},this.allowEmptyVertexProgram=!1,this.variableNames.position=0,this.variableNames.normal=0,this.variableNames.tangent=0,this.variableNames.uv=0,this.variableNames.uv2=0,this.variableNames.uv3=0,this.variableNames.uv4=0,this.variableNames.uv5=0,this.variableNames.uv6=0,this.variableNames.color=0,this.variableNames.matricesIndices=0,this.variableNames.matricesWeights=0,this.variableNames.matricesIndicesExtra=0,this.variableNames.matricesWeightsExtra=0,this.variableNames.diffuseBase=0,this.variableNames.specularBase=0,this.variableNames.worldPos=0,this.variableNames.shadow=0,this.variableNames.view=0,this.variableNames.vTBN=0,this.defineNames.MAINUV0=0,this.defineNames.MAINUV1=0,this.defineNames.MAINUV2=0,this.defineNames.MAINUV3=0,this.defineNames.MAINUV4=0,this.defineNames.MAINUV5=0,this.defineNames.MAINUV6=0,this.defineNames.MAINUV7=0}return r.prototype.emitErrors=function(){var n="";!this.checks.emitVertex&&!this.allowEmptyVertexProgram&&(n+=`NodeMaterial does not have a vertex output. You need to at least add a block that generates a glPosition value.\r
`),this.checks.emitFragment||(n+=`NodeMaterial does not have a fragment output. You need to at least add a block that generates a glFragColor value.\r
`);for(var e=0,t=this.checks.notConnectedNonOptionalInputs;e<t.length;e++){var i=t[e];n+="input ".concat(i.name," from block ").concat(i.ownerBlock.name,"[").concat(i.ownerBlock.getClassName(),`] is not connected and is not optional.\r
`)}if(n)throw`Build of NodeMaterial failed:\r
`+n},r}(),ke;(function(r){r[r.Compatible=0]="Compatible",r[r.TypeIncompatible=1]="TypeIncompatible",r[r.TargetIncompatible=2]="TargetIncompatible",r[r.HierarchyIssue=3]="HierarchyIssue"})(ke||(ke={}));var be;(function(r){r[r.Input=0]="Input",r[r.Output=1]="Output"})(be||(be={}));var Fn=function(){function r(n,e,t){this._connectedPoint=null,this._endpoints=new Array,this._typeConnectionSource=null,this._defaultConnectionPointType=null,this._linkedConnectionSource=null,this._acceptedConnectionPointType=null,this._type=h.Float,this._enforceAssociatedVariableName=!1,this.needDualDirectionValidation=!1,this.acceptedConnectionPointTypes=new Array,this.excludedConnectionPointTypes=new Array,this.onConnectionObservable=new U,this.isExposedOnFrame=!1,this.exposedPortPosition=-1,this._prioritizeVertex=!1,this._target=g.VertexAndFragment,this._ownerBlock=e,this.name=n,this._direction=t}return r.AreEquivalentTypes=function(n,e){switch(n){case h.Vector3:{if(e===h.Color3)return!0;break}case h.Vector4:{if(e===h.Color4)return!0;break}case h.Color3:{if(e===h.Vector3)return!0;break}case h.Color4:{if(e===h.Vector4)return!0;break}}return!1},Object.defineProperty(r.prototype,"direction",{get:function(){return this._direction},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"associatedVariableName",{get:function(){return this._ownerBlock.isInput?this._ownerBlock.associatedVariableName:(!this._enforceAssociatedVariableName||!this._associatedVariableName)&&this._connectedPoint?this._connectedPoint.associatedVariableName:this._associatedVariableName},set:function(n){this._associatedVariableName=n},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"innerType",{get:function(){return this._linkedConnectionSource&&this._linkedConnectionSource.isConnected?this.type:this._type},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"type",{get:function(){if(this._type===h.AutoDetect){if(this._ownerBlock.isInput)return this._ownerBlock.type;if(this._connectedPoint)return this._connectedPoint.type;if(this._linkedConnectionSource&&this._linkedConnectionSource.isConnected)return this._linkedConnectionSource.type}if(this._type===h.BasedOnInput){if(this._typeConnectionSource)return!this._typeConnectionSource.isConnected&&this._defaultConnectionPointType?this._defaultConnectionPointType:this._typeConnectionSource.type;if(this._defaultConnectionPointType)return this._defaultConnectionPointType}return this._type},set:function(n){this._type=n},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"target",{get:function(){return!this._prioritizeVertex||!this._ownerBlock?this._target:this._target!==g.VertexAndFragment?this._target:this._ownerBlock.target===g.Fragment?g.Fragment:g.Vertex},set:function(n){this._target=n},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"isConnected",{get:function(){return this.connectedPoint!==null||this.hasEndpoints},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"isConnectedToInputBlock",{get:function(){return this.connectedPoint!==null&&this.connectedPoint.ownerBlock.isInput},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"connectInputBlock",{get:function(){return this.isConnectedToInputBlock?this.connectedPoint.ownerBlock:null},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"connectedPoint",{get:function(){return this._connectedPoint},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"ownerBlock",{get:function(){return this._ownerBlock},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"sourceBlock",{get:function(){return this._connectedPoint?this._connectedPoint.ownerBlock:null},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"connectedBlocks",{get:function(){return this._endpoints.length===0?[]:this._endpoints.map(function(n){return n.ownerBlock})},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"endpoints",{get:function(){return this._endpoints},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"hasEndpoints",{get:function(){return this._endpoints&&this._endpoints.length>0},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"isDirectlyConnectedToVertexOutput",{get:function(){if(!this.hasEndpoints)return!1;for(var n=0,e=this._endpoints;n<e.length;n++){var t=e[n];if(t.ownerBlock.target===g.Vertex||(t.ownerBlock.target===g.Neutral||t.ownerBlock.target===g.VertexAndFragment)&&t.ownerBlock.outputs.some(function(i){return i.isDirectlyConnectedToVertexOutput}))return!0}return!1},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"isConnectedInVertexShader",{get:function(){if(this.target===g.Vertex)return!0;if(!this.hasEndpoints)return!1;for(var n=0,e=this._endpoints;n<e.length;n++){var t=e[n];if(t.ownerBlock.target===g.Vertex||t.target===g.Vertex||(t.ownerBlock.target===g.Neutral||t.ownerBlock.target===g.VertexAndFragment)&&t.ownerBlock.outputs.some(function(i){return i.isConnectedInVertexShader}))return!0}return!1},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"isConnectedInFragmentShader",{get:function(){if(this.target===g.Fragment)return!0;if(!this.hasEndpoints)return!1;for(var n=0,e=this._endpoints;n<e.length;n++){var t=e[n];if(t.ownerBlock.target===g.Fragment||(t.ownerBlock.target===g.Neutral||t.ownerBlock.target===g.VertexAndFragment)&&t.ownerBlock.outputs.some(function(i){return i.isConnectedInFragmentShader}))return!0}return!1},enumerable:!1,configurable:!0}),r.prototype.createCustomInputBlock=function(){return null},r.prototype.getClassName=function(){return"NodeMaterialConnectionPoint"},r.prototype.canConnectTo=function(n){return this.checkCompatibilityState(n)===ke.Compatible},r.prototype.checkCompatibilityState=function(n){var e=this._ownerBlock,t=n.ownerBlock;if(e.target===g.Fragment){if(t.target===g.Vertex)return ke.TargetIncompatible;for(var i=0,o=t.outputs;i<o.length;i++){var a=o[i];if(a.ownerBlock.target!=g.Neutral&&a.isConnectedInVertexShader)return ke.TargetIncompatible}}if(this.type!==n.type&&n.innerType!==h.AutoDetect)return r.AreEquivalentTypes(this.type,n.type)||n.acceptedConnectionPointTypes&&n.acceptedConnectionPointTypes.indexOf(this.type)!==-1||n._acceptedConnectionPointType&&r.AreEquivalentTypes(n._acceptedConnectionPointType.type,this.type)?ke.Compatible:ke.TypeIncompatible;if(n.excludedConnectionPointTypes&&n.excludedConnectionPointTypes.indexOf(this.type)!==-1)return ke.TypeIncompatible;var s=t,c=e;return this.direction===be.Input&&(s=e,c=t),s.isAnAncestorOf(c)?ke.HierarchyIssue:ke.Compatible},r.prototype.connectTo=function(n,e){if(e===void 0&&(e=!1),!e&&!this.canConnectTo(n))throw"Cannot connect these two connectors.";return this._endpoints.push(n),n._connectedPoint=this,this._enforceAssociatedVariableName=!1,this.onConnectionObservable.notifyObservers(n),n.onConnectionObservable.notifyObservers(this),this},r.prototype.disconnectFrom=function(n){var e=this._endpoints.indexOf(n);return e===-1?this:(this._endpoints.splice(e,1),n._connectedPoint=null,this._enforceAssociatedVariableName=!1,n._enforceAssociatedVariableName=!1,this)},r.prototype.serialize=function(n){n===void 0&&(n=!0);var e={};return e.name=this.name,e.displayName=this.displayName,n&&this.connectedPoint&&(e.inputName=this.name,e.targetBlockId=this.connectedPoint.ownerBlock.uniqueId,e.targetConnectionName=this.connectedPoint.name,e.isExposedOnFrame=!0,e.exposedPortPosition=this.exposedPortPosition),(this.isExposedOnFrame||this.exposedPortPosition>=0)&&(e.isExposedOnFrame=!0,e.exposedPortPosition=this.exposedPortPosition),e},r.prototype.dispose=function(){this.onConnectionObservable.clear()},r}(),L=function(){function r(n,e,t,i){e===void 0&&(e=g.Vertex),t===void 0&&(t=!1),i===void 0&&(i=!1),this._isFinalMerger=!1,this._isInput=!1,this._name="",this._isUnique=!1,this.inputsAreExclusive=!1,this._codeVariableName="",this._inputs=new Array,this._outputs=new Array,this.comments="",this.visibleInInspector=!1,this.visibleOnFrame=!1,this._target=e,this._originalTargetIsNeutral=e===g.Neutral,this._isFinalMerger=t,this._isInput=i,this._name=n,this.uniqueId=to.UniqueId}return Object.defineProperty(r.prototype,"name",{get:function(){return this._name},set:function(n){!this.validateBlockName(n)||(this._name=n)},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"isUnique",{get:function(){return this._isUnique},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"isFinalMerger",{get:function(){return this._isFinalMerger},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"isInput",{get:function(){return this._isInput},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"buildId",{get:function(){return this._buildId},set:function(n){this._buildId=n},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"target",{get:function(){return this._target},set:function(n){(this._target&n)===0&&(this._target=n)},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"inputs",{get:function(){return this._inputs},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"outputs",{get:function(){return this._outputs},enumerable:!1,configurable:!0}),r.prototype.getInputByName=function(n){var e=this._inputs.filter(function(t){return t.name===n});return e.length?e[0]:null},r.prototype.getOutputByName=function(n){var e=this._outputs.filter(function(t){return t.name===n});return e.length?e[0]:null},r.prototype.initialize=function(n){},r.prototype.bind=function(n,e,t,i){},r.prototype._declareOutput=function(n,e){return"".concat(e._getGLType(n.type)," ").concat(n.associatedVariableName)},r.prototype._writeVariable=function(n){var e=n.connectedPoint;return e?"".concat(n.associatedVariableName):"0."},r.prototype._writeFloat=function(n){var e=n.toString();return e.indexOf(".")===-1&&(e+=".0"),"".concat(e)},r.prototype.getClassName=function(){return"NodeMaterialBlock"},r.prototype.registerInput=function(n,e,t,i,o){return t===void 0&&(t=!1),o=o!=null?o:new Fn(n,this,be.Input),o.type=e,o.isOptional=t,i&&(o.target=i),this._inputs.push(o),this},r.prototype.registerOutput=function(n,e,t,i){return i=i!=null?i:new Fn(n,this,be.Output),i.type=e,t&&(i.target=t),this._outputs.push(i),this},r.prototype.getFirstAvailableInput=function(n){n===void 0&&(n=null);for(var e=0,t=this._inputs;e<t.length;e++){var i=t[e];if(!i.connectedPoint&&(!n||n.type===i.type||i.type===h.AutoDetect))return i}return null},r.prototype.getFirstAvailableOutput=function(n){n===void 0&&(n=null);for(var e=0,t=this._outputs;e<t.length;e++){var i=t[e];if(!n||!n.target||n.target===g.Neutral||(n.target&i.target)!==0)return i}return null},r.prototype.getSiblingOutput=function(n){var e=this._outputs.indexOf(n);return e===-1||e>=this._outputs.length?null:this._outputs[e+1]},r.prototype.isAnAncestorOf=function(n){for(var e=0,t=this._outputs;e<t.length;e++){var i=t[e];if(!!i.hasEndpoints)for(var o=0,a=i.endpoints;o<a.length;o++){var s=a[o];if(s.ownerBlock===n||s.ownerBlock.isAnAncestorOf(n))return!0}}return!1},r.prototype.connectTo=function(n,e){if(this._outputs.length!==0){for(var t=e&&e.output?this.getOutputByName(e.output):this.getFirstAvailableOutput(n),i=!0;i;){var o=e&&e.input?n.getInputByName(e.input):n.getFirstAvailableInput(t);if(t&&o&&t.canConnectTo(o))t.connectTo(o),i=!1;else if(t)t=this.getSiblingOutput(t);else throw"Unable to find a compatible match"}return this}},r.prototype._buildBlock=function(n){},r.prototype.updateUniformsAndSamples=function(n,e,t,i){},r.prototype.provideFallbacks=function(n,e){},r.prototype.initializeDefines=function(n,e,t,i){},r.prototype.prepareDefines=function(n,e,t,i,o){},r.prototype.autoConfigure=function(n){},r.prototype.replaceRepeatableContent=function(n,e,t,i){},Object.defineProperty(r.prototype,"willBeGeneratedIntoVertexShaderFromFragmentShader",{get:function(){return this.isInput||this.isFinalMerger||this._outputs.some(function(n){return n.isDirectlyConnectedToVertexOutput})||this.target===g.Vertex?!1:!!((this.target===g.VertexAndFragment||this.target===g.Neutral)&&this._outputs.some(function(n){return n.isConnectedInVertexShader}))},enumerable:!1,configurable:!0}),r.prototype.isReady=function(n,e,t,i){return!0},r.prototype._linkConnectionTypes=function(n,e,t){t===void 0&&(t=!1),t?this._inputs[e]._acceptedConnectionPointType=this._inputs[n]:this._inputs[n]._linkedConnectionSource=this._inputs[e],this._inputs[e]._linkedConnectionSource=this._inputs[n]},r.prototype._processBuild=function(n,e,t,i){n.build(e,i);var o=e._vertexState!=null,a=n._buildTarget===g.Vertex&&n.target!==g.VertexAndFragment;if(o&&((n.target&n._buildTarget)===0||(n.target&t.target)===0||this.target!==g.VertexAndFragment&&a)&&(!n.isInput&&e.target!==n._buildTarget||n.isInput&&n.isAttribute&&!n._noContextSwitch)){var s=t.connectedPoint;e._vertexState._emitVaryingFromString("v_"+s.associatedVariableName,e._getGLType(s.type))&&(e._vertexState.compilationString+="".concat("v_"+s.associatedVariableName," = ").concat(s.associatedVariableName,`;\r
`)),t.associatedVariableName="v_"+s.associatedVariableName,t._enforceAssociatedVariableName=!0}},r.prototype.validateBlockName=function(n){for(var e=["position","normal","tangent","particle_positionw","uv","uv2","uv3","uv4","uv5","uv6","position2d","particle_uv","matricesIndices","matricesWeights","world0","world1","world2","world3","particle_color","particle_texturemask"],t=0,i=e;t<i.length;t++){var o=i[t];if(n===o)return!1}return!0},r.prototype.build=function(n,e){if(this._buildId===n.sharedData.buildId)return!0;if(!this.isInput)for(var t=0,i=this._outputs;t<i.length;t++){var o=i[t];o.associatedVariableName||(o.associatedVariableName=n._getFreeVariableName(o.name))}for(var a=0,s=this._inputs;a<s.length;a++){var c=s[a];if(!c.connectedPoint){c.isOptional||n.sharedData.checks.notConnectedNonOptionalInputs.push(c);continue}if(!(this.target!==g.Neutral&&((c.target&this.target)===0||(c.target&n.target)===0))){var l=c.connectedPoint.ownerBlock;l&&l!==this&&this._processBuild(l,n,c,e)}}if(this._buildId===n.sharedData.buildId)return!0;if(n.sharedData.verbose&&console.log("".concat(n.target===g.Vertex?"Vertex shader":"Fragment shader",": Building ").concat(this.name," [").concat(this.getClassName(),"]")),this.isFinalMerger)switch(n.target){case g.Vertex:n.sharedData.checks.emitVertex=!0;break;case g.Fragment:n.sharedData.checks.emitFragment=!0;break}!this.isInput&&n.sharedData.emitComments&&(n.compilationString+=`\r
//`.concat(this.name,`\r
`)),this._buildBlock(n),this._buildId=n.sharedData.buildId,this._buildTarget=n.target;for(var u=0,f=this._outputs;u<f.length;u++){var o=f[u];if((o.target&n.target)!==0)for(var d=0,p=o.endpoints;d<p.length;d++){var m=p[d],l=m.ownerBlock;l&&(l.target&n.target)!==0&&e.indexOf(l)!==-1&&this._processBuild(l,n,m,e)}}return!1},r.prototype._inputRename=function(n){return n},r.prototype._outputRename=function(n){return n},r.prototype._dumpPropertiesCode=function(){var n=this._codeVariableName;return"".concat(n,".visibleInInspector = ").concat(this.visibleInInspector,`;\r
`).concat(n,".visibleOnFrame = ").concat(this.visibleOnFrame,`;\r
`).concat(n,".target = ").concat(this.target,`;\r
`)},r.prototype._dumpCode=function(n,e){e.push(this);var t,i=this.name.replace(/[^A-Za-z_]+/g,"");if(this._codeVariableName=i||"".concat(this.getClassName(),"_").concat(this.uniqueId),n.indexOf(this._codeVariableName)!==-1){var o=0;do o++,this._codeVariableName=i+o;while(n.indexOf(this._codeVariableName)!==-1)}n.push(this._codeVariableName),t=`\r
// `.concat(this.getClassName(),`\r
`),this.comments&&(t+="// ".concat(this.comments,`\r
`)),t+="var ".concat(this._codeVariableName," = new BABYLON.").concat(this.getClassName(),'("').concat(this.name,`");\r
`),t+=this._dumpPropertiesCode();for(var a=0,s=this.inputs;a<s.length;a++){var c=s[a];if(!!c.isConnected){var l=c.connectedPoint,u=l.ownerBlock;e.indexOf(u)===-1&&(t+=u._dumpCode(n,e))}}for(var f=0,d=this.outputs;f<d.length;f++){var p=d[f];if(!!p.hasEndpoints)for(var m=0,_=p.endpoints;m<_.length;m++){var v=_[m],u=v.ownerBlock;u&&e.indexOf(u)===-1&&(t+=u._dumpCode(n,e))}}return t},r.prototype._dumpCodeForOutputConnections=function(n){var e="";if(n.indexOf(this)!==-1)return e;n.push(this);for(var t=0,i=this.inputs;t<i.length;t++){var o=i[t];if(!!o.isConnected){var a=o.connectedPoint,s=a.ownerBlock;e+=s._dumpCodeForOutputConnections(n),e+="".concat(s._codeVariableName,".").concat(s._outputRename(a.name),".connectTo(").concat(this._codeVariableName,".").concat(this._inputRename(o.name),`);\r
`)}}return e},r.prototype.clone=function(n,e){e===void 0&&(e="");var t=this.serialize(),i=_i(t.customType);if(i){var o=new i;return o._deserialize(t,n,e),o}return null},r.prototype.serialize=function(){var n={};n.customType="BABYLON."+this.getClassName(),n.id=this.uniqueId,n.name=this.name,n.comments=this.comments,n.visibleInInspector=this.visibleInInspector,n.visibleOnFrame=this.visibleOnFrame,n.target=this.target,n.inputs=[],n.outputs=[];for(var e=0,t=this.inputs;e<t.length;e++){var i=t[e];n.inputs.push(i.serialize())}for(var o=0,a=this.outputs;o<a.length;o++){var s=a[o];n.outputs.push(s.serialize(!1))}return n},r.prototype._deserialize=function(n,e,t){var i;this.name=n.name,this.comments=n.comments,this.visibleInInspector=!!n.visibleInInspector,this.visibleOnFrame=!!n.visibleOnFrame,this._target=(i=n.target)!==null&&i!==void 0?i:this.target,this._deserializePortDisplayNamesAndExposedOnFrame(n)},r.prototype._deserializePortDisplayNamesAndExposedOnFrame=function(n){var e=this,t=n.inputs,i=n.outputs;t&&t.forEach(function(o,a){o.displayName&&(e.inputs[a].displayName=o.displayName),o.isExposedOnFrame&&(e.inputs[a].isExposedOnFrame=o.isExposedOnFrame,e.inputs[a].exposedPortPosition=o.exposedPortPosition)}),i&&i.forEach(function(o,a){o.displayName&&(e.outputs[a].displayName=o.displayName),o.isExposedOnFrame&&(e.outputs[a].isExposedOnFrame=o.isExposedOnFrame,e.outputs[a].exposedPortPosition=o.exposedPortPosition)})},r.prototype.dispose=function(){for(var n=0,e=this.inputs;n<e.length;n++){var t=e[n];t.dispose()}for(var i=0,o=this.outputs;i<o.length;i++){var a=o[i];a.dispose()}},r}(),Dn=function(r){R(n,r);function n(e){var t=r.call(this,e,g.Neutral)||this;return t.complementW=1,t.complementZ=0,t.target=g.Vertex,t.registerInput("vector",h.AutoDetect),t.registerInput("transform",h.Matrix),t.registerOutput("output",h.Vector4),t.registerOutput("xyz",h.Vector3),t._inputs[0].onConnectionObservable.add(function(i){if(i.ownerBlock.isInput){var o=i.ownerBlock;(o.name==="normal"||o.name==="tangent")&&(t.complementW=0)}}),t}return n.prototype.getClassName=function(){return"TransformBlock"},Object.defineProperty(n.prototype,"vector",{get:function(){return this._inputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"output",{get:function(){return this._outputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"xyz",{get:function(){return this._outputs[1]},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"transform",{get:function(){return this._inputs[1]},enumerable:!1,configurable:!0}),n.prototype._buildBlock=function(e){r.prototype._buildBlock.call(this,e);var t=this.vector,i=this.transform;if(t.connectedPoint){if(this.complementW===0){var o="//".concat(this.name);e._emitFunctionFromInclude("helperFunctions",o),e.sharedData.blocksWithDefines.push(this);var a=e._getFreeVariableName("".concat(i.associatedVariableName,"_NUS"));switch(e.compilationString+="mat3 ".concat(a," = mat3(").concat(i.associatedVariableName,`);\r
`),e.compilationString+=`#ifdef NONUNIFORMSCALING\r
`,e.compilationString+="".concat(a," = transposeMat3(inverseMat3(").concat(a,`));\r
`),e.compilationString+=`#endif\r
`,t.connectedPoint.type){case h.Vector2:e.compilationString+=this._declareOutput(this.output,e)+" = vec4(".concat(a," * vec3(").concat(t.associatedVariableName,", ").concat(this._writeFloat(this.complementZ),"), ").concat(this._writeFloat(this.complementW),`);\r
`);break;case h.Vector3:case h.Color3:e.compilationString+=this._declareOutput(this.output,e)+" = vec4(".concat(a," * ").concat(t.associatedVariableName,", ").concat(this._writeFloat(this.complementW),`);\r
`);break;default:e.compilationString+=this._declareOutput(this.output,e)+" = vec4(".concat(a," * ").concat(t.associatedVariableName,".xyz, ").concat(this._writeFloat(this.complementW),`);\r
`);break}}else{var a=i.associatedVariableName;switch(t.connectedPoint.type){case h.Vector2:e.compilationString+=this._declareOutput(this.output,e)+" = ".concat(a," * vec4(").concat(t.associatedVariableName,", ").concat(this._writeFloat(this.complementZ),", ").concat(this._writeFloat(this.complementW),`);\r
`);break;case h.Vector3:case h.Color3:e.compilationString+=this._declareOutput(this.output,e)+" = ".concat(a," * vec4(").concat(t.associatedVariableName,", ").concat(this._writeFloat(this.complementW),`);\r
`);break;default:e.compilationString+=this._declareOutput(this.output,e)+" = ".concat(a," * ").concat(t.associatedVariableName,`;\r
`);break}}this.xyz.hasEndpoints&&(e.compilationString+=this._declareOutput(this.xyz,e)+" = ".concat(this.output.associatedVariableName,`.xyz;\r
`))}return this},n.prototype.prepareDefines=function(e,t,i){e.nonUniformScaling&&i.setValue("NONUNIFORMSCALING",!0)},n.prototype.serialize=function(){var e=r.prototype.serialize.call(this);return e.complementZ=this.complementZ,e.complementW=this.complementW,e},n.prototype._deserialize=function(e,t,i){r.prototype._deserialize.call(this,e,t,i),this.complementZ=e.complementZ!==void 0?e.complementZ:0,this.complementW=e.complementW!==void 0?e.complementW:1},n.prototype._dumpPropertiesCode=function(){var e=r.prototype._dumpPropertiesCode.call(this)+"".concat(this._codeVariableName,".complementZ = ").concat(this.complementZ,`;\r
`);return e+="".concat(this._codeVariableName,".complementW = ").concat(this.complementW,`;\r
`),e},n}(L);P("BABYLON.TransformBlock",Dn);var $t=function(r){R(n,r);function n(e){var t=r.call(this,e,g.Vertex,!0)||this;return t.registerInput("vector",h.Vector4),t}return n.prototype.getClassName=function(){return"VertexOutputBlock"},Object.defineProperty(n.prototype,"vector",{get:function(){return this._inputs[0]},enumerable:!1,configurable:!0}),n.prototype._isLogarithmicDepthEnabled=function(e){for(var t=0,i=e;t<i.length;t++){var o=i[t];if(o.useLogarithmicDepth)return!0}return!1},n.prototype._buildBlock=function(e){r.prototype._buildBlock.call(this,e);var t=this.vector;return e.compilationString+="gl_Position = ".concat(t.associatedVariableName,`;\r
`),this._isLogarithmicDepthEnabled(e.sharedData.fragmentOutputNodes)&&(e._emitUniformFromString("logarithmicDepthConstant","float"),e._emitVaryingFromString("vFragmentDepth","float"),e.compilationString+=`vFragmentDepth = 1.0 + gl_Position.w;\r
`,e.compilationString+=`gl_Position.z = log2(max(0.000001, vFragmentDepth)) * logarithmicDepthConstant;\r
`),this},n}(L);P("BABYLON.VertexOutputBlock",$t);var ee;(function(r){r[r.Boolean=0]="Boolean",r[r.Float=1]="Float",r[r.Int=2]="Int",r[r.Vector2=3]="Vector2",r[r.List=4]="List"})(ee||(ee={}));function te(r,n,e,t){return n===void 0&&(n=ee.Boolean),e===void 0&&(e="PROPERTIES"),function(i,o){var a=i._propStore;a||(a=[],i._propStore=a),a.push({propertyName:o,displayName:r,type:n,groupName:e,options:t!=null?t:{}})}}var Bt=function(r){R(n,r);function n(e){var t=r.call(this,e,g.Fragment,!0)||this;return t.convertToGammaSpace=!1,t.convertToLinearSpace=!1,t.useLogarithmicDepth=!1,t.registerInput("rgba",h.Color4,!0),t.registerInput("rgb",h.Color3,!0),t.registerInput("a",h.Float,!0),t.rgb.acceptedConnectionPointTypes.push(h.Float),t}return n.prototype.getClassName=function(){return"FragmentOutputBlock"},n.prototype.initialize=function(e){e._excludeVariableName("logarithmicDepthConstant"),e._excludeVariableName("vFragmentDepth")},Object.defineProperty(n.prototype,"rgba",{get:function(){return this._inputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"rgb",{get:function(){return this._inputs[1]},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"a",{get:function(){return this._inputs[2]},enumerable:!1,configurable:!0}),n.prototype.prepareDefines=function(e,t,i){i.setValue(this._linearDefineName,this.convertToLinearSpace,!0),i.setValue(this._gammaDefineName,this.convertToGammaSpace,!0)},n.prototype.bind=function(e,t,i){this.useLogarithmicDepth&&i&&F.BindLogDepth(void 0,e,i.getScene())},n.prototype._buildBlock=function(e){r.prototype._buildBlock.call(this,e);var t=this.rgba,i=this.rgb,o=this.a;e.sharedData.hints.needAlphaBlending=t.isConnected||o.isConnected,e.sharedData.blocksWithDefines.push(this),this.useLogarithmicDepth&&(e._emitUniformFromString("logarithmicDepthConstant","float"),e._emitVaryingFromString("vFragmentDepth","float"),e.sharedData.bindableBlocks.push(this)),this._linearDefineName=e._getFreeDefineName("CONVERTTOLINEAR"),this._gammaDefineName=e._getFreeDefineName("CONVERTTOGAMMA");var a="//".concat(this.name);if(e._emitFunctionFromInclude("helperFunctions",a),t.connectedPoint)o.isConnected?e.compilationString+="gl_FragColor = vec4(".concat(t.associatedVariableName,".rgb, ").concat(o.associatedVariableName,`);\r
`):e.compilationString+="gl_FragColor = ".concat(t.associatedVariableName,`;\r
`);else if(i.connectedPoint){var s="1.0";o.connectedPoint&&(s=o.associatedVariableName),i.connectedPoint.type===h.Float?e.compilationString+="gl_FragColor = vec4(".concat(i.associatedVariableName,", ").concat(i.associatedVariableName,", ").concat(i.associatedVariableName,", ").concat(s,`);\r
`):e.compilationString+="gl_FragColor = vec4(".concat(i.associatedVariableName,", ").concat(s,`);\r
`)}else e.sharedData.checks.notConnectedNonOptionalInputs.push(t);return e.compilationString+="#ifdef ".concat(this._linearDefineName,`\r
`),e.compilationString+=`gl_FragColor = toLinearSpace(gl_FragColor);\r
`,e.compilationString+=`#endif\r
`,e.compilationString+="#ifdef ".concat(this._gammaDefineName,`\r
`),e.compilationString+=`gl_FragColor = toGammaSpace(gl_FragColor);\r
`,e.compilationString+=`#endif\r
`,this.useLogarithmicDepth&&(e.compilationString+=`gl_FragDepthEXT = log2(vFragmentDepth) * logarithmicDepthConstant * 0.5;\r
`),this},n.prototype._dumpPropertiesCode=function(){var e=r.prototype._dumpPropertiesCode.call(this);return e+="".concat(this._codeVariableName,".convertToGammaSpace = ").concat(this.convertToGammaSpace,`;\r
`),e+="".concat(this._codeVariableName,".convertToLinearSpace = ").concat(this.convertToLinearSpace,`;\r
`),e+="".concat(this._codeVariableName,".useLogarithmicDepth = ").concat(this.useLogarithmicDepth,`;\r
`),e},n.prototype.serialize=function(){var e=r.prototype.serialize.call(this);return e.convertToGammaSpace=this.convertToGammaSpace,e.convertToLinearSpace=this.convertToLinearSpace,e.useLogarithmicDepth=this.useLogarithmicDepth,e},n.prototype._deserialize=function(e,t,i){var o;r.prototype._deserialize.call(this,e,t,i),this.convertToGammaSpace=e.convertToGammaSpace,this.convertToLinearSpace=e.convertToLinearSpace,this.useLogarithmicDepth=(o=e.useLogarithmicDepth)!==null&&o!==void 0?o:!1},E([te("Convert to gamma space",ee.Boolean,"PROPERTIES",{notifiers:{update:!0}})],n.prototype,"convertToGammaSpace",void 0),E([te("Convert to linear space",ee.Boolean,"PROPERTIES",{notifiers:{update:!0}})],n.prototype,"convertToLinearSpace",void 0),E([te("Use logarithmic depth",ee.Boolean,"PROPERTIES")],n.prototype,"useLogarithmicDepth",void 0),n}(L);P("BABYLON.FragmentOutputBlock",Bt);var Ae;(function(r){r[r.Uniform=0]="Uniform",r[r.Attribute=1]="Attribute",r[r.Varying=2]="Varying",r[r.Undefined=3]="Undefined"})(Ae||(Ae={}));var Y;(function(r){r[r.World=1]="World",r[r.View=2]="View",r[r.Projection=3]="Projection",r[r.ViewProjection=4]="ViewProjection",r[r.WorldView=5]="WorldView",r[r.WorldViewProjection=6]="WorldViewProjection",r[r.CameraPosition=7]="CameraPosition",r[r.FogColor=8]="FogColor",r[r.DeltaTime=9]="DeltaTime",r[r.CameraParameters=10]="CameraParameters",r[r.MaterialAlpha=11]="MaterialAlpha"})(Y||(Y={}));var ht;(function(r){r[r.None=0]="None",r[r.Time=1]="Time"})(ht||(ht={}));var na={position2d:"position",particle_uv:"vUV",particle_color:"vColor",particle_texturemask:"textureMask",particle_positionw:"vPositionW"},Tn={particle_uv:!0,particle_color:!0,particle_texturemask:!0,particle_positionw:!0},ki={particle_texturemask:!0},K=function(r){R(n,r);function n(e,t,i){t===void 0&&(t=g.Vertex),i===void 0&&(i=h.AutoDetect);var o=r.call(this,e,t,!1,!0)||this;return o._mode=Ae.Undefined,o._animationType=ht.None,o.min=0,o.max=0,o.isBoolean=!1,o.matrixMode=0,o._systemValue=null,o.isConstant=!1,o.groupInInspector="",o.onValueChangedObservable=new U,o.convertToGammaSpace=!1,o.convertToLinearSpace=!1,o._type=i,o.setDefaultValue(),o.registerOutput("output",i),o}return Object.defineProperty(n.prototype,"type",{get:function(){if(this._type===h.AutoDetect){if(this.isUniform&&this.value!=null){if(!isNaN(this.value))return this._type=h.Float,this._type;switch(this.value.getClassName()){case"Vector2":return this._type=h.Vector2,this._type;case"Vector3":return this._type=h.Vector3,this._type;case"Vector4":return this._type=h.Vector4,this._type;case"Color3":return this._type=h.Color3,this._type;case"Color4":return this._type=h.Color4,this._type;case"Matrix":return this._type=h.Matrix,this._type}}if(this.isAttribute)switch(this.name){case"position":case"normal":case"tangent":case"particle_positionw":return this._type=h.Vector3,this._type;case"uv":case"uv2":case"uv3":case"uv4":case"uv5":case"uv6":case"position2d":case"particle_uv":return this._type=h.Vector2,this._type;case"matricesIndices":case"matricesWeights":case"world0":case"world1":case"world2":case"world3":return this._type=h.Vector4,this._type;case"color":case"particle_color":case"particle_texturemask":return this._type=h.Color4,this._type}if(this.isSystemValue)switch(this._systemValue){case Y.World:case Y.WorldView:case Y.WorldViewProjection:case Y.View:case Y.ViewProjection:case Y.Projection:return this._type=h.Matrix,this._type;case Y.CameraPosition:return this._type=h.Vector3,this._type;case Y.FogColor:return this._type=h.Color3,this._type;case Y.DeltaTime:case Y.MaterialAlpha:return this._type=h.Float,this._type;case Y.CameraParameters:return this._type=h.Vector4,this._type}}return this._type},enumerable:!1,configurable:!0}),n.prototype.validateBlockName=function(e){return this.isAttribute?!0:r.prototype.validateBlockName.call(this,e)},Object.defineProperty(n.prototype,"output",{get:function(){return this._outputs[0]},enumerable:!1,configurable:!0}),n.prototype.setAsAttribute=function(e){return this._mode=Ae.Attribute,e&&(this.name=e),this},n.prototype.setAsSystemValue=function(e){return this.systemValue=e,this},Object.defineProperty(n.prototype,"value",{get:function(){return this._storedValue},set:function(e){this.type===h.Float&&(this.isBoolean?e=e?1:0:this.min!==this.max&&(e=Math.max(this.min,e),e=Math.min(this.max,e))),this._storedValue=e,this._mode=Ae.Uniform,this.onValueChangedObservable.notifyObservers(this)},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"valueCallback",{get:function(){return this._valueCallback},set:function(e){this._valueCallback=e,this._mode=Ae.Uniform},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"associatedVariableName",{get:function(){return this._associatedVariableName},set:function(e){this._associatedVariableName=e},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"animationType",{get:function(){return this._animationType},set:function(e){this._animationType=e},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"isUndefined",{get:function(){return this._mode===Ae.Undefined},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"isUniform",{get:function(){return this._mode===Ae.Uniform},set:function(e){this._mode=e?Ae.Uniform:Ae.Undefined,this.associatedVariableName=""},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"isAttribute",{get:function(){return this._mode===Ae.Attribute},set:function(e){this._mode=e?Ae.Attribute:Ae.Undefined,this.associatedVariableName=""},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"isVarying",{get:function(){return this._mode===Ae.Varying},set:function(e){this._mode=e?Ae.Varying:Ae.Undefined,this.associatedVariableName=""},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"isSystemValue",{get:function(){return this._systemValue!=null},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"systemValue",{get:function(){return this._systemValue},set:function(e){this._mode=Ae.Uniform,this.associatedVariableName="",this._systemValue=e},enumerable:!1,configurable:!0}),n.prototype.getClassName=function(){return"InputBlock"},n.prototype.animate=function(e){switch(this._animationType){case ht.Time:{this.type===h.Float&&(this.value+=e.getAnimationRatio()*.01);break}}},n.prototype._emitDefine=function(e){return e[0]==="!"?"#ifndef ".concat(e.substring(1),`\r
`):"#ifdef ".concat(e,`\r
`)},n.prototype.initialize=function(){this.associatedVariableName=""},n.prototype.setDefaultValue=function(){switch(this.type){case h.Float:this.value=0;break;case h.Vector2:this.value=Ge.Zero();break;case h.Vector3:this.value=y.Zero();break;case h.Vector4:this.value=ut.Zero();break;case h.Color3:this.value=G.White();break;case h.Color4:this.value=new gi(1,1,1,1);break;case h.Matrix:this.value=Q.Identity();break}},n.prototype._emitConstant=function(e){switch(this.type){case h.Float:return"".concat(e._emitFloat(this.value));case h.Vector2:return"vec2(".concat(this.value.x,", ").concat(this.value.y,")");case h.Vector3:return"vec3(".concat(this.value.x,", ").concat(this.value.y,", ").concat(this.value.z,")");case h.Vector4:return"vec4(".concat(this.value.x,", ").concat(this.value.y,", ").concat(this.value.z,", ").concat(this.value.w,")");case h.Color3:return ae.Color3[0].set(this.value.r,this.value.g,this.value.b),this.convertToGammaSpace&&ae.Color3[0].toGammaSpaceToRef(ae.Color3[0]),this.convertToLinearSpace&&ae.Color3[0].toLinearSpaceToRef(ae.Color3[0]),"vec3(".concat(ae.Color3[0].r,", ").concat(ae.Color3[0].g,", ").concat(ae.Color3[0].b,")");case h.Color4:return ae.Color4[0].set(this.value.r,this.value.g,this.value.b,this.value.a),this.convertToGammaSpace&&ae.Color4[0].toGammaSpaceToRef(ae.Color4[0]),this.convertToLinearSpace&&ae.Color4[0].toLinearSpaceToRef(ae.Color4[0]),"vec4(".concat(ae.Color4[0].r,", ").concat(ae.Color4[0].g,", ").concat(ae.Color4[0].b,", ").concat(ae.Color4[0].a,")")}return""},Object.defineProperty(n.prototype,"_noContextSwitch",{get:function(){return Tn[this.name]},enumerable:!1,configurable:!0}),n.prototype._emit=function(e,t){var i;if(this.isUniform){if(this.associatedVariableName||(this.associatedVariableName=e._getFreeVariableName("u_"+this.name)),this.isConstant){if(e.constants.indexOf(this.associatedVariableName)!==-1)return;e.constants.push(this.associatedVariableName),e._constantDeclaration+=this._declareOutput(this.output,e)+" = ".concat(this._emitConstant(e),`;\r
`);return}if(e.uniforms.indexOf(this.associatedVariableName)!==-1)return;e.uniforms.push(this.associatedVariableName),t&&(e._uniformDeclaration+=this._emitDefine(t)),e._uniformDeclaration+="uniform ".concat(e._getGLType(this.type)," ").concat(this.associatedVariableName,`;\r
`),t&&(e._uniformDeclaration+=`#endif\r
`);var o=e.sharedData.hints;if(this._systemValue!==null&&this._systemValue!==void 0)switch(this._systemValue){case Y.WorldView:o.needWorldViewMatrix=!0;break;case Y.WorldViewProjection:o.needWorldViewProjectionMatrix=!0;break}else this._animationType!==ht.None&&e.sharedData.animatedInputs.push(this);return}if(this.isAttribute){if(this.associatedVariableName=(i=na[this.name])!==null&&i!==void 0?i:this.name,this.target===g.Vertex&&e._vertexState){Tn[this.name]?ki[this.name]?e._emitUniformFromString(this.associatedVariableName,e._getGLType(this.type),t):e._emitVaryingFromString(this.associatedVariableName,e._getGLType(this.type),t):this._emit(e._vertexState,t);return}if(e.attributes.indexOf(this.associatedVariableName)!==-1)return;e.attributes.push(this.associatedVariableName),Tn[this.name]?ki[this.name]?e._emitUniformFromString(this.associatedVariableName,e._getGLType(this.type),t):e._emitVaryingFromString(this.associatedVariableName,e._getGLType(this.type),t):(t&&(e._attributeDeclaration+=this._emitDefine(t)),e._attributeDeclaration+="attribute ".concat(e._getGLType(this.type)," ").concat(this.associatedVariableName,`;\r
`),t&&(e._attributeDeclaration+=`#endif\r
`))}},n.prototype._transmitWorld=function(e,t,i,o){if(!!this._systemValue){var a=this.associatedVariableName;switch(this._systemValue){case Y.World:e.setMatrix(a,t);break;case Y.WorldView:e.setMatrix(a,i);break;case Y.WorldViewProjection:e.setMatrix(a,o);break}}},n.prototype._transmit=function(e,t,i){if(!this.isAttribute){var o=this.associatedVariableName;if(this._systemValue){switch(this._systemValue){case Y.World:case Y.WorldView:case Y.WorldViewProjection:return;case Y.View:e.setMatrix(o,t.getViewMatrix());break;case Y.Projection:e.setMatrix(o,t.getProjectionMatrix());break;case Y.ViewProjection:e.setMatrix(o,t.getTransformMatrix());break;case Y.CameraPosition:t.bindEyePosition(e,o,!0);break;case Y.FogColor:e.setColor3(o,t.fogColor);break;case Y.DeltaTime:e.setFloat(o,t.deltaTime/1e3);break;case Y.CameraParameters:t.activeCamera&&e.setFloat4(o,t.getEngine().hasOriginBottomLeft?-1:1,t.activeCamera.minZ,t.activeCamera.maxZ,1/t.activeCamera.maxZ);break;case Y.MaterialAlpha:e.setFloat(o,i.alpha);break}return}var a=this._valueCallback?this._valueCallback():this._storedValue;if(a!==null)switch(this.type){case h.Float:e.setFloat(o,a);break;case h.Int:e.setInt(o,a);break;case h.Color3:ae.Color3[0].set(this.value.r,this.value.g,this.value.b),this.convertToGammaSpace&&ae.Color3[0].toGammaSpaceToRef(ae.Color3[0]),this.convertToLinearSpace&&ae.Color3[0].toLinearSpaceToRef(ae.Color3[0]),e.setColor3(o,ae.Color3[0]);break;case h.Color4:ae.Color4[0].set(this.value.r,this.value.g,this.value.b,this.value.a),this.convertToGammaSpace&&ae.Color4[0].toGammaSpaceToRef(ae.Color4[0]),this.convertToLinearSpace&&ae.Color4[0].toLinearSpaceToRef(ae.Color4[0]),e.setDirectColor4(o,ae.Color4[0]);break;case h.Vector2:e.setVector2(o,a);break;case h.Vector3:e.setVector3(o,a);break;case h.Vector4:e.setVector4(o,a);break;case h.Matrix:e.setMatrix(o,a);break}}},n.prototype._buildBlock=function(e){r.prototype._buildBlock.call(this,e),(this.isUniform||this.isSystemValue)&&e.sharedData.inputBlocks.push(this),this._emit(e)},n.prototype._dumpPropertiesCode=function(){var e=this._codeVariableName;if(this.isAttribute)return r.prototype._dumpPropertiesCode.call(this)+"".concat(e,'.setAsAttribute("').concat(this.name,`");\r
`);if(this.isSystemValue)return r.prototype._dumpPropertiesCode.call(this)+"".concat(e,".setAsSystemValue(BABYLON.NodeMaterialSystemValues.").concat(Y[this._systemValue],`);\r
`);if(this.isUniform){var t=[],i="";switch(this.type){case h.Float:i="".concat(this.value);break;case h.Vector2:i="new BABYLON.Vector2(".concat(this.value.x,", ").concat(this.value.y,")");break;case h.Vector3:i="new BABYLON.Vector3(".concat(this.value.x,", ").concat(this.value.y,", ").concat(this.value.z,")");break;case h.Vector4:i="new BABYLON.Vector4(".concat(this.value.x,", ").concat(this.value.y,", ").concat(this.value.z,", ").concat(this.value.w,")");break;case h.Color3:i="new BABYLON.Color3(".concat(this.value.r,", ").concat(this.value.g,", ").concat(this.value.b,")"),this.convertToGammaSpace&&(i+=".toGammaSpace()"),this.convertToLinearSpace&&(i+=".toLinearSpace()");break;case h.Color4:i="new BABYLON.Color4(".concat(this.value.r,", ").concat(this.value.g,", ").concat(this.value.b,", ").concat(this.value.a,")"),this.convertToGammaSpace&&(i+=".toGammaSpace()"),this.convertToLinearSpace&&(i+=".toLinearSpace()");break;case h.Matrix:i="BABYLON.Matrix.FromArray([".concat(this.value.m,"])");break}return t.push("".concat(e,".value = ").concat(i)),this.type===h.Float&&t.push("".concat(e,".min = ").concat(this.min),"".concat(e,".max = ").concat(this.max),"".concat(e,".isBoolean = ").concat(this.isBoolean),"".concat(e,".matrixMode = ").concat(this.matrixMode),"".concat(e,".animationType = BABYLON.AnimatedInputBlockTypes.").concat(ht[this.animationType])),t.push("".concat(e,".isConstant = ").concat(this.isConstant)),t.push(""),r.prototype._dumpPropertiesCode.call(this)+t.join(`;\r
`)}return r.prototype._dumpPropertiesCode.call(this)},n.prototype.dispose=function(){this.onValueChangedObservable.clear(),r.prototype.dispose.call(this)},n.prototype.serialize=function(){var e=r.prototype.serialize.call(this);return e.type=this.type,e.mode=this._mode,e.systemValue=this._systemValue,e.animationType=this._animationType,e.min=this.min,e.max=this.max,e.isBoolean=this.isBoolean,e.matrixMode=this.matrixMode,e.isConstant=this.isConstant,e.groupInInspector=this.groupInInspector,e.convertToGammaSpace=this.convertToGammaSpace,e.convertToLinearSpace=this.convertToLinearSpace,this._storedValue!=null&&this._mode===Ae.Uniform&&(this._storedValue.asArray?(e.valueType="BABYLON."+this._storedValue.getClassName(),e.value=this._storedValue.asArray()):(e.valueType="number",e.value=this._storedValue)),e},n.prototype._deserialize=function(e,t,i){if(this._mode=e.mode,r.prototype._deserialize.call(this,e,t,i),this._type=e.type,this._systemValue=e.systemValue||e.wellKnownValue,this._animationType=e.animationType,this.min=e.min||0,this.max=e.max||0,this.isBoolean=!!e.isBoolean,this.matrixMode=e.matrixMode||0,this.isConstant=!!e.isConstant,this.groupInInspector=e.groupInInspector||"",this.convertToGammaSpace=!!e.convertToGammaSpace,this.convertToLinearSpace=!!e.convertToLinearSpace,!!e.valueType)if(e.valueType==="number")this._storedValue=e.value;else{var o=_i(e.valueType);o&&(this._storedValue=o.FromArray(e.value))}},n}(L);P("BABYLON.InputBlock",K);var Ar=function(r){R(n,r);function n(e){var t=r.call(this,e,g.VertexAndFragment)||this;return t._samplerName="textureSampler",t.convertToGammaSpace=!1,t.convertToLinearSpace=!1,t._isUnique=!1,t.registerInput("uv",h.Vector2,!1,g.VertexAndFragment),t.registerOutput("rgba",h.Color4,g.Neutral),t.registerOutput("rgb",h.Color3,g.Neutral),t.registerOutput("r",h.Float,g.Neutral),t.registerOutput("g",h.Float,g.Neutral),t.registerOutput("b",h.Float,g.Neutral),t.registerOutput("a",h.Float,g.Neutral),t._inputs[0].acceptedConnectionPointTypes.push(h.Vector3),t._inputs[0].acceptedConnectionPointTypes.push(h.Vector4),t._inputs[0]._prioritizeVertex=!1,t}return n.prototype.getClassName=function(){return"CurrentScreenBlock"},Object.defineProperty(n.prototype,"uv",{get:function(){return this._inputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"rgba",{get:function(){return this._outputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"rgb",{get:function(){return this._outputs[1]},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"r",{get:function(){return this._outputs[2]},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"g",{get:function(){return this._outputs[3]},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"b",{get:function(){return this._outputs[4]},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"a",{get:function(){return this._outputs[5]},enumerable:!1,configurable:!0}),n.prototype.initialize=function(e){e._excludeVariableName("textureSampler")},Object.defineProperty(n.prototype,"target",{get:function(){return!this.uv.isConnected||this.uv.sourceBlock.isInput?g.VertexAndFragment:g.Fragment},enumerable:!1,configurable:!0}),n.prototype.prepareDefines=function(e,t,i){i.setValue(this._linearDefineName,this.convertToGammaSpace,!0),i.setValue(this._gammaDefineName,this.convertToLinearSpace,!0)},n.prototype.isReady=function(){return!(this.texture&&!this.texture.isReadyOrNotBlocking())},n.prototype._injectVertexCode=function(e){var t=this.uv;if(t.connectedPoint.ownerBlock.isInput){var i=t.connectedPoint.ownerBlock;i.isAttribute||e._emitUniformFromString(t.associatedVariableName,"vec2")}if(this._mainUVName="vMain"+t.associatedVariableName,e._emitVaryingFromString(this._mainUVName,"vec2"),e.compilationString+="".concat(this._mainUVName," = ").concat(t.associatedVariableName,`.xy;\r
`),!!this._outputs.some(function(c){return c.isConnectedInVertexShader})){this._writeTextureRead(e,!0);for(var o=0,a=this._outputs;o<a.length;o++){var s=a[o];s.hasEndpoints&&this._writeOutput(e,s,s.name,!0)}}},n.prototype._writeTextureRead=function(e,t){t===void 0&&(t=!1);var i=this.uv;if(t){if(e.target===g.Fragment)return;e.compilationString+="vec4 ".concat(this._tempTextureRead," = texture2D(").concat(this._samplerName,", ").concat(i.associatedVariableName,`);\r
`);return}if(this.uv.ownerBlock.target===g.Fragment){e.compilationString+="vec4 ".concat(this._tempTextureRead," = texture2D(").concat(this._samplerName,", ").concat(i.associatedVariableName,`);\r
`);return}e.compilationString+="vec4 ".concat(this._tempTextureRead," = texture2D(").concat(this._samplerName,", ").concat(this._mainUVName,`);\r
`)},n.prototype._writeOutput=function(e,t,i,o){if(o===void 0&&(o=!1),o){if(e.target===g.Fragment)return;e.compilationString+="".concat(this._declareOutput(t,e)," = ").concat(this._tempTextureRead,".").concat(i,`;\r
`);return}if(this.uv.ownerBlock.target===g.Fragment){e.compilationString+="".concat(this._declareOutput(t,e)," = ").concat(this._tempTextureRead,".").concat(i,`;\r
`);return}e.compilationString+="".concat(this._declareOutput(t,e)," = ").concat(this._tempTextureRead,".").concat(i,`;\r
`),e.compilationString+="#ifdef ".concat(this._linearDefineName,`\r
`),e.compilationString+="".concat(t.associatedVariableName," = toGammaSpace(").concat(t.associatedVariableName,`);\r
`),e.compilationString+=`#endif\r
`,e.compilationString+="#ifdef ".concat(this._gammaDefineName,`\r
`),e.compilationString+="".concat(t.associatedVariableName," = toLinearSpace(").concat(t.associatedVariableName,`);\r
`),e.compilationString+=`#endif\r
`},n.prototype._buildBlock=function(e){if(r.prototype._buildBlock.call(this,e),this._tempTextureRead=e._getFreeVariableName("tempTextureRead"),e.sharedData.blockingBlocks.indexOf(this)<0&&e.sharedData.blockingBlocks.push(this),e.sharedData.textureBlocks.indexOf(this)<0&&e.sharedData.textureBlocks.push(this),e.sharedData.blocksWithDefines.indexOf(this)<0&&e.sharedData.blocksWithDefines.push(this),e.target!==g.Fragment){e._emit2DSampler(this._samplerName),this._injectVertexCode(e);return}if(!!this._outputs.some(function(s){return s.isConnectedInFragmentShader})){e._emit2DSampler(this._samplerName),this._linearDefineName=e._getFreeDefineName("ISLINEAR"),this._gammaDefineName=e._getFreeDefineName("ISGAMMA");var t="//".concat(this.name);e._emitFunctionFromInclude("helperFunctions",t),this._writeTextureRead(e);for(var i=0,o=this._outputs;i<o.length;i++){var a=o[i];a.hasEndpoints&&this._writeOutput(e,a,a.name)}return this}},n.prototype.serialize=function(){var e=r.prototype.serialize.call(this);return e.convertToGammaSpace=this.convertToGammaSpace,e.convertToLinearSpace=this.convertToLinearSpace,this.texture&&!this.texture.isRenderTarget&&(e.texture=this.texture.serialize()),e},n.prototype._deserialize=function(e,t,i){r.prototype._deserialize.call(this,e,t,i),this.convertToGammaSpace=e.convertToGammaSpace,this.convertToLinearSpace=!!e.convertToLinearSpace,e.texture&&(i=e.texture.url.indexOf("data:")===0?"":i,this.texture=X.Parse(e.texture,t,i))},n}(L);P("BABYLON.CurrentScreenBlock",Ar);var yr=function(r){R(n,r);function n(e){var t=r.call(this,e,g.Fragment)||this;return t._samplerName="diffuseSampler",t.convertToGammaSpace=!1,t.convertToLinearSpace=!1,t._isUnique=!1,t.registerInput("uv",h.Vector2,!1,g.VertexAndFragment),t.registerOutput("rgba",h.Color4,g.Neutral),t.registerOutput("rgb",h.Color3,g.Neutral),t.registerOutput("r",h.Float,g.Neutral),t.registerOutput("g",h.Float,g.Neutral),t.registerOutput("b",h.Float,g.Neutral),t.registerOutput("a",h.Float,g.Neutral),t._inputs[0].acceptedConnectionPointTypes.push(h.Vector3),t._inputs[0].acceptedConnectionPointTypes.push(h.Vector4),t}return n.prototype.getClassName=function(){return"ParticleTextureBlock"},Object.defineProperty(n.prototype,"uv",{get:function(){return this._inputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"rgba",{get:function(){return this._outputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"rgb",{get:function(){return this._outputs[1]},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"r",{get:function(){return this._outputs[2]},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"g",{get:function(){return this._outputs[3]},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"b",{get:function(){return this._outputs[4]},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"a",{get:function(){return this._outputs[5]},enumerable:!1,configurable:!0}),n.prototype.initialize=function(e){e._excludeVariableName("diffuseSampler")},n.prototype.autoConfigure=function(e){if(!this.uv.isConnected){var t=e.getInputBlockByPredicate(function(i){return i.isAttribute&&i.name==="particle_uv"});t||(t=new K("uv"),t.setAsAttribute("particle_uv")),t.output.connectTo(this.uv)}},n.prototype.prepareDefines=function(e,t,i){i.setValue(this._linearDefineName,this.convertToGammaSpace,!0),i.setValue(this._gammaDefineName,this.convertToLinearSpace,!0)},n.prototype.isReady=function(){return!(this.texture&&!this.texture.isReadyOrNotBlocking())},n.prototype._writeOutput=function(e,t,i){e.compilationString+="".concat(this._declareOutput(t,e)," = ").concat(this._tempTextureRead,".").concat(i,`;\r
`),e.compilationString+="#ifdef ".concat(this._linearDefineName,`\r
`),e.compilationString+="".concat(t.associatedVariableName," = toGammaSpace(").concat(t.associatedVariableName,`);\r
`),e.compilationString+=`#endif\r
`,e.compilationString+="#ifdef ".concat(this._gammaDefineName,`\r
`),e.compilationString+="".concat(t.associatedVariableName," = toLinearSpace(").concat(t.associatedVariableName,`);\r
`),e.compilationString+=`#endif\r
`},n.prototype._buildBlock=function(e){if(r.prototype._buildBlock.call(this,e),e.target!==g.Vertex){this._tempTextureRead=e._getFreeVariableName("tempTextureRead"),e._emit2DSampler(this._samplerName),e.sharedData.blockingBlocks.push(this),e.sharedData.textureBlocks.push(this),e.sharedData.blocksWithDefines.push(this),this._linearDefineName=e._getFreeDefineName("ISLINEAR"),this._gammaDefineName=e._getFreeDefineName("ISGAMMA");var t="//".concat(this.name);e._emitFunctionFromInclude("helperFunctions",t),e.compilationString+="vec4 ".concat(this._tempTextureRead," = texture2D(").concat(this._samplerName,", ").concat(this.uv.associatedVariableName,`);\r
`);for(var i=0,o=this._outputs;i<o.length;i++){var a=o[i];a.hasEndpoints&&this._writeOutput(e,a,a.name)}return this}},n.prototype.serialize=function(){var e=r.prototype.serialize.call(this);return e.convertToGammaSpace=this.convertToGammaSpace,e.convertToLinearSpace=this.convertToLinearSpace,this.texture&&!this.texture.isRenderTarget&&(e.texture=this.texture.serialize()),e},n.prototype._deserialize=function(e,t,i){r.prototype._deserialize.call(this,e,t,i),this.convertToGammaSpace=e.convertToGammaSpace,this.convertToLinearSpace=!!e.convertToLinearSpace,e.texture&&(i=e.texture.url.indexOf("data:")===0?"":i,this.texture=X.Parse(e.texture,t,i))},n}(L);P("BABYLON.ParticleTextureBlock",yr);var Cr=function(r){R(n,r);function n(e){var t=r.call(this,e,g.Fragment)||this;return t._isUnique=!0,t.registerInput("color",h.Color4,!1,g.Fragment),t.registerOutput("rampColor",h.Color4,g.Fragment),t}return n.prototype.getClassName=function(){return"ParticleRampGradientBlock"},Object.defineProperty(n.prototype,"color",{get:function(){return this._inputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"rampColor",{get:function(){return this._outputs[0]},enumerable:!1,configurable:!0}),n.prototype.initialize=function(e){e._excludeVariableName("remapRanges"),e._excludeVariableName("rampSampler"),e._excludeVariableName("baseColor"),e._excludeVariableName("alpha"),e._excludeVariableName("remappedColorIndex"),e._excludeVariableName("rampColor"),e._excludeVariableName("finalAlpha")},n.prototype._buildBlock=function(e){if(r.prototype._buildBlock.call(this,e),e.target!==g.Vertex)return e._emit2DSampler("rampSampler"),e._emitVaryingFromString("remapRanges","vec4","RAMPGRADIENT"),e.compilationString+=`
            #ifdef RAMPGRADIENT
                vec4 baseColor = `.concat(this.color.associatedVariableName,`;
                float alpha = `).concat(this.color.associatedVariableName,`.a;

                float remappedColorIndex = clamp((alpha - remapRanges.x) / remapRanges.y, 0.0, 1.0);

                vec4 rampColor = texture2D(rampSampler, vec2(1.0 - remappedColorIndex, 0.));
                baseColor.rgb *= rampColor.rgb;

                // Remapped alpha
                float finalAlpha = baseColor.a;
                baseColor.a = clamp((alpha * rampColor.a - remapRanges.z) / remapRanges.w, 0.0, 1.0);

                `).concat(this._declareOutput(this.rampColor,e),` = baseColor;
            #else
                `).concat(this._declareOutput(this.rampColor,e)," = ").concat(this.color.associatedVariableName,`;
            #endif
        `),this},n}(L);P("BABYLON.ParticleRampGradientBlock",Cr);var Tr=function(r){R(n,r);function n(e){var t=r.call(this,e,g.Fragment)||this;return t._isUnique=!0,t.registerInput("color",h.Color4,!1,g.Fragment),t.registerInput("alphaTexture",h.Float,!1,g.Fragment),t.registerInput("alphaColor",h.Float,!1,g.Fragment),t.registerOutput("blendColor",h.Color4,g.Fragment),t}return n.prototype.getClassName=function(){return"ParticleBlendMultiplyBlock"},Object.defineProperty(n.prototype,"color",{get:function(){return this._inputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"alphaTexture",{get:function(){return this._inputs[1]},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"alphaColor",{get:function(){return this._inputs[2]},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"blendColor",{get:function(){return this._outputs[0]},enumerable:!1,configurable:!0}),n.prototype.initialize=function(e){e._excludeVariableName("sourceAlpha")},n.prototype._buildBlock=function(e){if(r.prototype._buildBlock.call(this,e),e.target!==g.Vertex)return e.compilationString+=`
            #ifdef BLENDMULTIPLYMODE
                `.concat(this._declareOutput(this.blendColor,e),`;
                float sourceAlpha = `).concat(this.alphaColor.associatedVariableName," * ").concat(this.alphaTexture.associatedVariableName,`;
                `).concat(this.blendColor.associatedVariableName,".rgb = ").concat(this.color.associatedVariableName,`.rgb * sourceAlpha + vec3(1.0) * (1.0 - sourceAlpha);
                `).concat(this.blendColor.associatedVariableName,".a = ").concat(this.color.associatedVariableName,`.a;
            #else
                `).concat(this._declareOutput(this.blendColor,e)," = ").concat(this.color.associatedVariableName,`;
            #endif
        `),this},n}(L);P("BABYLON.ParticleBlendMultiplyBlock",Tr);var en=function(r){R(n,r);function n(e){var t=r.call(this,e,g.Neutral)||this;return t.xSwizzle="x",t.ySwizzle="y",t.zSwizzle="z",t.wSwizzle="w",t.registerInput("xyzw ",h.Vector4,!0),t.registerInput("xyz ",h.Vector3,!0),t.registerInput("xy ",h.Vector2,!0),t.registerInput("zw ",h.Vector2,!0),t.registerInput("x",h.Float,!0),t.registerInput("y",h.Float,!0),t.registerInput("z",h.Float,!0),t.registerInput("w",h.Float,!0),t.registerOutput("xyzw",h.Vector4),t.registerOutput("xyz",h.Vector3),t.registerOutput("xy",h.Vector2),t.registerOutput("zw",h.Vector2),t}return n.prototype.getClassName=function(){return"VectorMergerBlock"},Object.defineProperty(n.prototype,"xyzwIn",{get:function(){return this._inputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"xyzIn",{get:function(){return this._inputs[1]},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"xyIn",{get:function(){return this._inputs[2]},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"zwIn",{get:function(){return this._inputs[3]},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"x",{get:function(){return this._inputs[4]},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"y",{get:function(){return this._inputs[5]},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"z",{get:function(){return this._inputs[6]},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"w",{get:function(){return this._inputs[7]},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"xyzw",{get:function(){return this._outputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"xyzOut",{get:function(){return this._outputs[1]},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"xyOut",{get:function(){return this._outputs[2]},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"zwOut",{get:function(){return this._outputs[3]},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"xy",{get:function(){return this.xyOut},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"xyz",{get:function(){return this.xyzOut},enumerable:!1,configurable:!0}),n.prototype._inputRename=function(e){return e==="xyzw "?"xyzwIn":e==="xyz "?"xyzIn":e==="xy "?"xyIn":e==="zw "?"zwIn":e},n.prototype._buildSwizzle=function(e){var t=this.xSwizzle+this.ySwizzle+this.zSwizzle+this.wSwizzle;return"."+t.substr(0,e)},n.prototype._buildBlock=function(e){r.prototype._buildBlock.call(this,e);var t=this.x,i=this.y,o=this.z,a=this.w,s=this.xyIn,c=this.zwIn,l=this.xyzIn,u=this.xyzwIn,f=this._outputs[0],d=this._outputs[1],p=this._outputs[2],m=this._outputs[3];return u.isConnected?(f.hasEndpoints&&(e.compilationString+=this._declareOutput(f,e)+" = ".concat(u.associatedVariableName).concat(this._buildSwizzle(4),`;\r
`)),d.hasEndpoints&&(e.compilationString+=this._declareOutput(d,e)+" = ".concat(u.associatedVariableName).concat(this._buildSwizzle(3),`;\r
`)),p.hasEndpoints&&(e.compilationString+=this._declareOutput(p,e)+" = ".concat(u.associatedVariableName).concat(this._buildSwizzle(2),`;\r
`))):l.isConnected?(f.hasEndpoints&&(e.compilationString+=this._declareOutput(f,e)+" = vec4(".concat(l.associatedVariableName,", ").concat(a.isConnected?this._writeVariable(a):"0.0",")").concat(this._buildSwizzle(4),`;\r
`)),d.hasEndpoints&&(e.compilationString+=this._declareOutput(d,e)+" = ".concat(l.associatedVariableName).concat(this._buildSwizzle(3),`;\r
`)),p.hasEndpoints&&(e.compilationString+=this._declareOutput(p,e)+" = ".concat(l.associatedVariableName).concat(this._buildSwizzle(2),`;\r
`))):s.isConnected?(f.hasEndpoints&&(c.isConnected?e.compilationString+=this._declareOutput(f,e)+" = vec4(".concat(s.associatedVariableName,", ").concat(c.associatedVariableName,")").concat(this._buildSwizzle(4),`;\r
`):e.compilationString+=this._declareOutput(f,e)+" = vec4(".concat(s.associatedVariableName,", ").concat(o.isConnected?this._writeVariable(o):"0.0",", ").concat(a.isConnected?this._writeVariable(a):"0.0",")").concat(this._buildSwizzle(4),`;\r
`)),d.hasEndpoints&&(e.compilationString+=this._declareOutput(d,e)+" = vec3(".concat(s.associatedVariableName,", ").concat(o.isConnected?this._writeVariable(o):"0.0",")").concat(this._buildSwizzle(3),`;\r
`)),p.hasEndpoints&&(e.compilationString+=this._declareOutput(p,e)+" = ".concat(s.associatedVariableName).concat(this._buildSwizzle(2),`;\r
`)),m.hasEndpoints&&(c.isConnected?e.compilationString+=this._declareOutput(m,e)+" = ".concat(c.associatedVariableName).concat(this._buildSwizzle(2),`;\r
`):e.compilationString+=this._declareOutput(m,e)+" = vec2(".concat(o.isConnected?this._writeVariable(o):"0.0",", ").concat(a.isConnected?this._writeVariable(a):"0.0",")").concat(this._buildSwizzle(2),`;\r
`))):(f.hasEndpoints&&(c.isConnected?e.compilationString+=this._declareOutput(f,e)+" = vec4(".concat(t.isConnected?this._writeVariable(t):"0.0",", ").concat(i.isConnected?this._writeVariable(i):"0.0",", ").concat(c.associatedVariableName,")").concat(this._buildSwizzle(4),`;\r
`):e.compilationString+=this._declareOutput(f,e)+" = vec4(".concat(t.isConnected?this._writeVariable(t):"0.0",", ").concat(i.isConnected?this._writeVariable(i):"0.0",", ").concat(o.isConnected?this._writeVariable(o):"0.0",", ").concat(a.isConnected?this._writeVariable(a):"0.0",")").concat(this._buildSwizzle(4),`;\r
`)),d.hasEndpoints&&(e.compilationString+=this._declareOutput(d,e)+" = vec3(".concat(t.isConnected?this._writeVariable(t):"0.0",", ").concat(i.isConnected?this._writeVariable(i):"0.0",", ").concat(o.isConnected?this._writeVariable(o):"0.0",")").concat(this._buildSwizzle(3),`;\r
`)),p.hasEndpoints&&(e.compilationString+=this._declareOutput(p,e)+" = vec2(".concat(t.isConnected?this._writeVariable(t):"0.0",", ").concat(i.isConnected?this._writeVariable(i):"0.0",")").concat(this._buildSwizzle(2),`;\r
`)),m.hasEndpoints&&(c.isConnected?e.compilationString+=this._declareOutput(m,e)+" = ".concat(c.associatedVariableName).concat(this._buildSwizzle(2),`;\r
`):e.compilationString+=this._declareOutput(m,e)+" = vec2(".concat(o.isConnected?this._writeVariable(o):"0.0",", ").concat(a.isConnected?this._writeVariable(a):"0.0",")").concat(this._buildSwizzle(2),`;\r
`))),this},n.prototype.serialize=function(){var e=r.prototype.serialize.call(this);return e.xSwizzle=this.xSwizzle,e.ySwizzle=this.ySwizzle,e.zSwizzle=this.zSwizzle,e.wSwizzle=this.wSwizzle,e},n.prototype._deserialize=function(e,t,i){var o,a,s,c;r.prototype._deserialize.call(this,e,t,i),this.xSwizzle=(o=e.xSwizzle)!==null&&o!==void 0?o:"x",this.ySwizzle=(a=e.ySwizzle)!==null&&a!==void 0?a:"y",this.zSwizzle=(s=e.zSwizzle)!==null&&s!==void 0?s:"z",this.wSwizzle=(c=e.wSwizzle)!==null&&c!==void 0?c:"w"},n.prototype._dumpPropertiesCode=function(){var e=r.prototype._dumpPropertiesCode.call(this);return e+="".concat(this._codeVariableName,'.xSwizzle = "').concat(this.xSwizzle,`";\r
`),e+="".concat(this._codeVariableName,'.ySwizzle = "').concat(this.ySwizzle,`";\r
`),e+="".concat(this._codeVariableName,'.zSwizzle = "').concat(this.zSwizzle,`";\r
`),e+="".concat(this._codeVariableName,'.wSwizzle = "').concat(this.wSwizzle,`";\r
`),e},n}(L);P("BABYLON.VectorMergerBlock",en);var Sr=function(r){R(n,r);function n(e){var t=r.call(this,e,g.Neutral)||this;return t.sourceRange=new Ge(-1,1),t.targetRange=new Ge(0,1),t.registerInput("input",h.AutoDetect),t.registerInput("sourceMin",h.Float,!0),t.registerInput("sourceMax",h.Float,!0),t.registerInput("targetMin",h.Float,!0),t.registerInput("targetMax",h.Float,!0),t.registerOutput("output",h.BasedOnInput),t._outputs[0]._typeConnectionSource=t._inputs[0],t}return n.prototype.getClassName=function(){return"RemapBlock"},Object.defineProperty(n.prototype,"input",{get:function(){return this._inputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"sourceMin",{get:function(){return this._inputs[1]},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"sourceMax",{get:function(){return this._inputs[2]},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"targetMin",{get:function(){return this._inputs[3]},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"targetMax",{get:function(){return this._inputs[4]},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"output",{get:function(){return this._outputs[0]},enumerable:!1,configurable:!0}),n.prototype._buildBlock=function(e){r.prototype._buildBlock.call(this,e);var t=this._outputs[0],i=this.sourceMin.isConnected?this.sourceMin.associatedVariableName:this._writeFloat(this.sourceRange.x),o=this.sourceMax.isConnected?this.sourceMax.associatedVariableName:this._writeFloat(this.sourceRange.y),a=this.targetMin.isConnected?this.targetMin.associatedVariableName:this._writeFloat(this.targetRange.x),s=this.targetMax.isConnected?this.targetMax.associatedVariableName:this._writeFloat(this.targetRange.y);return e.compilationString+=this._declareOutput(t,e)+" = ".concat(a," + (").concat(this._inputs[0].associatedVariableName," - ").concat(i,") * (").concat(s," - ").concat(a,") / (").concat(o," - ").concat(i,`);\r
`),this},n.prototype._dumpPropertiesCode=function(){var e=r.prototype._dumpPropertiesCode.call(this)+"".concat(this._codeVariableName,".sourceRange = new BABYLON.Vector2(").concat(this.sourceRange.x,", ").concat(this.sourceRange.y,`);\r
`);return e+="".concat(this._codeVariableName,".targetRange = new BABYLON.Vector2(").concat(this.targetRange.x,", ").concat(this.targetRange.y,`);\r
`),e},n.prototype.serialize=function(){var e=r.prototype.serialize.call(this);return e.sourceRange=this.sourceRange.asArray(),e.targetRange=this.targetRange.asArray(),e},n.prototype._deserialize=function(e,t,i){r.prototype._deserialize.call(this,e,t,i),this.sourceRange=Ge.FromArray(e.sourceRange),this.targetRange=Ge.FromArray(e.targetRange)},E([te("From",ee.Vector2)],n.prototype,"sourceRange",void 0),E([te("To",ee.Vector2)],n.prototype,"targetRange",void 0),n}(L);P("BABYLON.RemapBlock",Sr);var Bn=function(r){R(n,r);function n(e){var t=r.call(this,e,g.Neutral)||this;return t.registerInput("left",h.AutoDetect),t.registerInput("right",h.AutoDetect),t.registerOutput("output",h.BasedOnInput),t._outputs[0]._typeConnectionSource=t._inputs[0],t._linkConnectionTypes(0,1),t}return n.prototype.getClassName=function(){return"MultiplyBlock"},Object.defineProperty(n.prototype,"left",{get:function(){return this._inputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"right",{get:function(){return this._inputs[1]},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"output",{get:function(){return this._outputs[0]},enumerable:!1,configurable:!0}),n.prototype._buildBlock=function(e){r.prototype._buildBlock.call(this,e);var t=this._outputs[0];return e.compilationString+=this._declareOutput(t,e)+" = ".concat(this.left.associatedVariableName," * ").concat(this.right.associatedVariableName,`;\r
`),this},n}(L);P("BABYLON.MultiplyBlock",Bn);var Be;(function(r){r[r.Material=0]="Material",r[r.PostProcess=1]="PostProcess",r[r.Particle=2]="Particle",r[r.ProceduralTexture=3]="ProceduralTexture"})(Be||(Be={}));var Rr=function(r){R(n,r);function n(e){var t=r.call(this,e,g.Neutral)||this;return t.registerInput("rgba",h.Color4,!0),t.registerInput("rgb ",h.Color3,!0),t.registerOutput("rgb",h.Color3),t.registerOutput("r",h.Float),t.registerOutput("g",h.Float),t.registerOutput("b",h.Float),t.registerOutput("a",h.Float),t.inputsAreExclusive=!0,t}return n.prototype.getClassName=function(){return"ColorSplitterBlock"},Object.defineProperty(n.prototype,"rgba",{get:function(){return this._inputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"rgbIn",{get:function(){return this._inputs[1]},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"rgbOut",{get:function(){return this._outputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"r",{get:function(){return this._outputs[1]},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"g",{get:function(){return this._outputs[2]},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"b",{get:function(){return this._outputs[3]},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"a",{get:function(){return this._outputs[4]},enumerable:!1,configurable:!0}),n.prototype._inputRename=function(e){return e==="rgb "?"rgbIn":e},n.prototype._outputRename=function(e){return e==="rgb"?"rgbOut":e},n.prototype._buildBlock=function(e){r.prototype._buildBlock.call(this,e);var t=this.rgba.isConnected?this.rgba:this.rgbIn;if(!!t.isConnected){var i=this._outputs[0],o=this._outputs[1],a=this._outputs[2],s=this._outputs[3],c=this._outputs[4];return i.hasEndpoints&&(e.compilationString+=this._declareOutput(i,e)+" = ".concat(t.associatedVariableName,`.rgb;\r
`)),o.hasEndpoints&&(e.compilationString+=this._declareOutput(o,e)+" = ".concat(t.associatedVariableName,`.r;\r
`)),a.hasEndpoints&&(e.compilationString+=this._declareOutput(a,e)+" = ".concat(t.associatedVariableName,`.g;\r
`)),s.hasEndpoints&&(e.compilationString+=this._declareOutput(s,e)+" = ".concat(t.associatedVariableName,`.b;\r
`)),c.hasEndpoints&&(e.compilationString+=this._declareOutput(c,e)+" = ".concat(t.associatedVariableName,`.a;\r
`)),this}},n}(L);P("BABYLON.ColorSplitterBlock",Rr);var ia=function(){function r(n){this.name=Nt.NAME_PROCEDURALTEXTURE,this.scene=n,this.scene.proceduralTextures=new Array}return r.prototype.register=function(){this.scene._beforeClearStage.registerStep(Nt.STEP_BEFORECLEAR_PROCEDURALTEXTURE,this,this._beforeClear)},r.prototype.rebuild=function(){},r.prototype.dispose=function(){},r.prototype._beforeClear=function(){if(this.scene.proceduralTexturesEnabled){z.StartPerformanceCounter("Procedural textures",this.scene.proceduralTextures.length>0);for(var n=0;n<this.scene.proceduralTextures.length;n++){var e=this.scene.proceduralTextures[n];e._shouldRender()&&e.render()}z.EndPerformanceCounter("Procedural textures",this.scene.proceduralTextures.length>0)}},r}(),ra="proceduralVertexShader",oa=`attribute vec2 position;
varying vec2 vPosition;
varying vec2 vUV;
const vec2 madd=vec2(0.5,0.5);
#define CUSTOM_VERTEX_DEFINITIONS
void main(void) {
#define CUSTOM_VERTEX_MAIN_BEGIN
vPosition=position;
vUV=position*madd+madd;
gl_Position=vec4(position,0.0,1.0);
#define CUSTOM_VERTEX_MAIN_END
}`;oe.ShadersStore[ra]=oa;var Or=function(r){R(n,r);function n(e,t,i,o,a,s,c,l){a===void 0&&(a=null),s===void 0&&(s=!0),c===void 0&&(c=!1),l===void 0&&(l=0);var u=r.call(this,null,o,!s)||this;u.isEnabled=!0,u.autoClear=!0,u.onGeneratedObservable=new U,u.onBeforeGenerationObservable=new U,u.nodeMaterialSource=null,u._textures={},u._currentRefreshId=-1,u._frameId=-1,u._refreshRate=1,u._vertexBuffers={},u._uniforms=new Array,u._samplers=new Array,u._floats={},u._ints={},u._floatsArrays={},u._colors3={},u._colors4={},u._vectors2={},u._vectors3={},u._matrices={},u._fallbackTextureUsed=!1,u._cachedDefines=null,u._contentUpdateId=-1,u._rtWrapper=null,o=u.getScene()||Me.LastCreatedScene;var f=o._getComponent(Nt.NAME_PROCEDURALTEXTURE);f||(f=new ia(o),o._addComponent(f)),o.proceduralTextures.push(u),u._fullEngine=o.getEngine(),u.name=e,u.isRenderTarget=!0,u._size=t,u._textureType=l,u._generateMipMaps=s,u._drawWrapper=new no(u._fullEngine),u.setFragment(i),u._fallbackTexture=a;var d=u._createRtWrapper(c,t,s,l);u._texture=d.texture;var p=[];return p.push(1,1),p.push(-1,1),p.push(-1,-1),p.push(1,-1),u._vertexBuffers[w.PositionKind]=new w(u._fullEngine,p,w.PositionKind,!1,!1,2),u._createIndexBuffer(),u}return n.prototype._createRtWrapper=function(e,t,i,o){return e?(this._rtWrapper=this._fullEngine.createRenderTargetCubeTexture(t,{generateMipMaps:i,generateDepthBuffer:!1,generateStencilBuffer:!1,type:o}),this.setFloat("face",0)):this._rtWrapper=this._fullEngine.createRenderTargetTexture(t,{generateMipMaps:i,generateDepthBuffer:!1,generateStencilBuffer:!1,type:o}),this._rtWrapper},n.prototype.getEffect=function(){return this._drawWrapper.effect},n.prototype._setEffect=function(e){this._drawWrapper.effect=e},n.prototype.getContent=function(){var e=this;return this._contentData&&this._frameId===this._contentUpdateId?this._contentData:(this._contentData?this._contentData.then(function(t){e._contentData=e.readPixels(0,0,t),e._contentUpdateId=e._frameId}):(this._contentData=this.readPixels(0,0),this._contentUpdateId=this._frameId),this._contentData)},n.prototype._createIndexBuffer=function(){var e=this._fullEngine,t=[];t.push(0),t.push(1),t.push(2),t.push(0),t.push(2),t.push(3),this._indexBuffer=e.createIndexBuffer(t)},n.prototype._rebuild=function(){var e=this._vertexBuffers[w.PositionKind];e&&e._rebuild(),this._createIndexBuffer(),this.refreshRate===Vt.REFRESHRATE_RENDER_ONCE&&(this.refreshRate=Vt.REFRESHRATE_RENDER_ONCE)},n.prototype.reset=function(){var e;(e=this._drawWrapper.effect)===null||e===void 0||e.dispose()},n.prototype._getDefines=function(){return""},n.prototype.isReady=function(){var e=this,t=this._fullEngine,i;if(this.nodeMaterialSource)return this._drawWrapper.effect.isReady();if(!this._fragment)return!1;if(this._fallbackTextureUsed)return!0;if(!this._texture)return!1;var o=this._getDefines();return this._drawWrapper.effect&&o===this._cachedDefines&&this._drawWrapper.effect.isReady()?!0:(this._fragment.fragmentElement!==void 0?i={vertex:"procedural",fragmentElement:this._fragment.fragmentElement}:i={vertex:"procedural",fragment:this._fragment},this._cachedDefines!==o&&(this._cachedDefines=o,this._drawWrapper.effect=t.createEffect(i,[w.PositionKind],this._uniforms,this._samplers,o,void 0,void 0,function(){var a;(a=e._rtWrapper)===null||a===void 0||a.dispose(),e._rtWrapper=e._texture=null,e._fallbackTexture&&(e._texture=e._fallbackTexture._texture,e._texture&&e._texture.incrementReferences()),e._fallbackTextureUsed=!0})),this._drawWrapper.effect.isReady())},n.prototype.resetRefreshCounter=function(){this._currentRefreshId=-1},n.prototype.setFragment=function(e){this._fragment=e},Object.defineProperty(n.prototype,"refreshRate",{get:function(){return this._refreshRate},set:function(e){this._refreshRate=e,this.resetRefreshCounter()},enumerable:!1,configurable:!0}),n.prototype._shouldRender=function(){return!this.isEnabled||!this.isReady()||!this._texture?(this._texture&&(this._texture.isReady=!1),!1):this._fallbackTextureUsed?!1:this._currentRefreshId===-1?(this._currentRefreshId=1,this._frameId++,!0):this.refreshRate===this._currentRefreshId?(this._currentRefreshId=1,this._frameId++,!0):(this._currentRefreshId++,!1)},n.prototype.getRenderSize=function(){return this._size},n.prototype.resize=function(e,t){if(!(this._fallbackTextureUsed||!this._rtWrapper||!this._texture)){var i=this._texture.isCube;this._rtWrapper.dispose();var o=this._createRtWrapper(i,e,t,this._textureType);this._texture=o.texture,this._size=e,this._generateMipMaps=t}},n.prototype._checkUniform=function(e){this._uniforms.indexOf(e)===-1&&this._uniforms.push(e)},n.prototype.setTexture=function(e,t){return this._samplers.indexOf(e)===-1&&this._samplers.push(e),this._textures[e]=t,this},n.prototype.setFloat=function(e,t){return this._checkUniform(e),this._floats[e]=t,this},n.prototype.setInt=function(e,t){return this._checkUniform(e),this._ints[e]=t,this},n.prototype.setFloats=function(e,t){return this._checkUniform(e),this._floatsArrays[e]=t,this},n.prototype.setColor3=function(e,t){return this._checkUniform(e),this._colors3[e]=t,this},n.prototype.setColor4=function(e,t){return this._checkUniform(e),this._colors4[e]=t,this},n.prototype.setVector2=function(e,t){return this._checkUniform(e),this._vectors2[e]=t,this},n.prototype.setVector3=function(e,t){return this._checkUniform(e),this._vectors3[e]=t,this},n.prototype.setMatrix=function(e,t){return this._checkUniform(e),this._matrices[e]=t,this},n.prototype.render=function(e){var t,i,o=this.getScene();if(!!o){var a=this._fullEngine;if(a.enableEffect(this._drawWrapper),this.onBeforeGenerationObservable.notifyObservers(this),a.setState(!1),!this.nodeMaterialSource){for(var s in this._textures)this._drawWrapper.effect.setTexture(s,this._textures[s]);for(var c in this._ints)this._drawWrapper.effect.setInt(c,this._ints[c]);for(var l in this._floats)this._drawWrapper.effect.setFloat(l,this._floats[l]);for(var u in this._floatsArrays)this._drawWrapper.effect.setArray(u,this._floatsArrays[u]);for(var f in this._colors3)this._drawWrapper.effect.setColor3(f,this._colors3[f]);for(var d in this._colors4){var p=this._colors4[d];this._drawWrapper.effect.setFloat4(d,p.r,p.g,p.b,p.a)}for(var m in this._vectors2)this._drawWrapper.effect.setVector2(m,this._vectors2[m]);for(var _ in this._vectors3)this._drawWrapper.effect.setVector3(_,this._vectors3[_]);for(var v in this._matrices)this._drawWrapper.effect.setMatrix(v,this._matrices[v])}if(!(!this._texture||!this._rtWrapper)){if((t=a._debugPushGroup)===null||t===void 0||t.call(a,"procedural texture generation for ".concat(this.name),1),this.isCube)for(var b=0;b<6;b++)a.bindFramebuffer(this._rtWrapper,b,void 0,void 0,!0),a.bindBuffers(this._vertexBuffers,this._indexBuffer,this._drawWrapper.effect),this._drawWrapper.effect.setFloat("face",b),this.autoClear&&a.clear(o.clearColor,!0,!1,!1),a.drawElementsType(Ee.TriangleFillMode,0,6);else a.bindFramebuffer(this._rtWrapper,0,void 0,void 0,!0),a.bindBuffers(this._vertexBuffers,this._indexBuffer,this._drawWrapper.effect),this.autoClear&&a.clear(o.clearColor,!0,!1,!1),a.drawElementsType(Ee.TriangleFillMode,0,6);a.unBindFramebuffer(this._rtWrapper,this.isCube),this.isCube&&a.generateMipMapsForCubemap(this._texture),(i=a._debugPopGroup)===null||i===void 0||i.call(a,1),this.onGenerated&&this.onGenerated(),this.onGeneratedObservable.notifyObservers(this)}}},n.prototype.clone=function(){var e=this.getSize(),t=new n(this.name,e.width,this._fragment,this.getScene(),this._fallbackTexture,this._generateMipMaps);return t.hasAlpha=this.hasAlpha,t.level=this.level,t.coordinatesMode=this.coordinatesMode,t},n.prototype.dispose=function(){var e=this.getScene();if(!!e){var t=e.proceduralTextures.indexOf(this);t>=0&&e.proceduralTextures.splice(t,1);var i=this._vertexBuffers[w.PositionKind];i&&(i.dispose(),this._vertexBuffers[w.PositionKind]=null),this._indexBuffer&&this._fullEngine._releaseBuffer(this._indexBuffer)&&(this._indexBuffer=null),this.onGeneratedObservable.clear(),this.onBeforeGenerationObservable.clear(),r.prototype.dispose.call(this)}},E([T()],n.prototype,"isEnabled",void 0),E([T()],n.prototype,"autoClear",void 0),E([T()],n.prototype,"_generateMipMaps",void 0),E([T()],n.prototype,"_size",void 0),E([T()],n.prototype,"refreshRate",null),n}(X);P("BABYLON.ProceduralTexture",Or);var pe;(function(r){r[r.Cos=0]="Cos",r[r.Sin=1]="Sin",r[r.Abs=2]="Abs",r[r.Exp=3]="Exp",r[r.Exp2=4]="Exp2",r[r.Round=5]="Round",r[r.Floor=6]="Floor",r[r.Ceiling=7]="Ceiling",r[r.Sqrt=8]="Sqrt",r[r.Log=9]="Log",r[r.Tan=10]="Tan",r[r.ArcTan=11]="ArcTan",r[r.ArcCos=12]="ArcCos",r[r.ArcSin=13]="ArcSin",r[r.Fract=14]="Fract",r[r.Sign=15]="Sign",r[r.Radians=16]="Radians",r[r.Degrees=17]="Degrees"})(pe||(pe={}));var Nr=function(r){R(n,r);function n(e){var t=r.call(this,e,g.Neutral)||this;return t.operation=pe.Cos,t.registerInput("input",h.AutoDetect),t.registerOutput("output",h.BasedOnInput),t._outputs[0]._typeConnectionSource=t._inputs[0],t}return n.prototype.getClassName=function(){return"TrigonometryBlock"},Object.defineProperty(n.prototype,"input",{get:function(){return this._inputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"output",{get:function(){return this._outputs[0]},enumerable:!1,configurable:!0}),n.prototype._buildBlock=function(e){r.prototype._buildBlock.call(this,e);var t=this._outputs[0],i="";switch(this.operation){case pe.Cos:{i="cos";break}case pe.Sin:{i="sin";break}case pe.Abs:{i="abs";break}case pe.Exp:{i="exp";break}case pe.Exp2:{i="exp2";break}case pe.Round:{i="round";break}case pe.Floor:{i="floor";break}case pe.Ceiling:{i="ceil";break}case pe.Sqrt:{i="sqrt";break}case pe.Log:{i="log";break}case pe.Tan:{i="tan";break}case pe.ArcTan:{i="atan";break}case pe.ArcCos:{i="acos";break}case pe.ArcSin:{i="asin";break}case pe.Fract:{i="fract";break}case pe.Sign:{i="sign";break}case pe.Radians:{i="radians";break}case pe.Degrees:{i="degrees";break}}return e.compilationString+=this._declareOutput(t,e)+" = ".concat(i,"(").concat(this.input.associatedVariableName,`);\r
`),this},n.prototype.serialize=function(){var e=r.prototype.serialize.call(this);return e.operation=this.operation,e},n.prototype._deserialize=function(e,t,i){r.prototype._deserialize.call(this,e,t,i),this.operation=e.operation},n.prototype._dumpPropertiesCode=function(){var e=r.prototype._dumpPropertiesCode.call(this)+"".concat(this._codeVariableName,".operation = BABYLON.TrigonometryBlockOperations.").concat(pe[this.operation],`;\r
`);return e},n}(L);P("BABYLON.TrigonometryBlock",Nr);var Sn={effect:null,subMesh:null},Zt=function(r){R(n,r);function n(){var e=r.call(this)||this;return e.NORMAL=!1,e.TANGENT=!1,e.UV1=!1,e.UV2=!1,e.UV3=!1,e.UV4=!1,e.UV5=!1,e.UV6=!1,e.NUM_BONE_INFLUENCERS=0,e.BonesPerMesh=0,e.BONETEXTURE=!1,e.MORPHTARGETS=!1,e.MORPHTARGETS_NORMAL=!1,e.MORPHTARGETS_TANGENT=!1,e.MORPHTARGETS_UV=!1,e.NUM_MORPH_INFLUENCERS=0,e.MORPHTARGETS_TEXTURE=!1,e.IMAGEPROCESSING=!1,e.VIGNETTE=!1,e.VIGNETTEBLENDMODEMULTIPLY=!1,e.VIGNETTEBLENDMODEOPAQUE=!1,e.TONEMAPPING=!1,e.TONEMAPPING_ACES=!1,e.CONTRAST=!1,e.EXPOSURE=!1,e.COLORCURVES=!1,e.COLORGRADING=!1,e.COLORGRADING3D=!1,e.SAMPLER3DGREENDEPTH=!1,e.SAMPLER3DBGRMAP=!1,e.IMAGEPROCESSINGPOSTPROCESS=!1,e.SKIPFINALCOLORCLAMP=!1,e.BUMPDIRECTUV=0,e.rebuild(),e}return n.prototype.setValue=function(e,t,i){i===void 0&&(i=!1),this[e]===void 0&&this._keys.push(e),i&&this[e]!==t&&this.markAsUnprocessed(),this[e]=t},n}(mt),fn=function(r){R(n,r);function n(e,t,i){i===void 0&&(i={});var o=r.call(this,e,t||Me.LastCreatedScene)||this;return o._buildId=n._BuildIdGenerator++,o._buildWasSuccessful=!1,o._cachedWorldViewMatrix=new Q,o._cachedWorldViewProjectionMatrix=new Q,o._optimizers=new Array,o._animationFrame=-1,o.BJSNODEMATERIALEDITOR=o._getGlobalNodeMaterialEditor(),o.editorData=null,o.ignoreAlpha=!1,o.maxSimultaneousLights=4,o.onBuildObservable=new U,o._vertexOutputNodes=new Array,o._fragmentOutputNodes=new Array,o.attachedBlocks=new Array,o._mode=Be.Material,o.forceAlphaBlending=!1,o._options=Oe({emitComments:!1},i),o._attachImageProcessingConfiguration(null),o}return n.prototype._getGlobalNodeMaterialEditor=function(){if(typeof NODEEDITOR!="undefined")return NODEEDITOR;if(typeof BABYLON!="undefined"&&typeof BABYLON.NodeEditor!="undefined")return BABYLON},Object.defineProperty(n.prototype,"options",{get:function(){return this._options},set:function(e){this._options=e},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"imageProcessingConfiguration",{get:function(){return this._imageProcessingConfiguration},set:function(e){this._attachImageProcessingConfiguration(e),this._markAllSubMeshesAsTexturesDirty()},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"mode",{get:function(){return this._mode},set:function(e){this._mode=e},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"buildId",{get:function(){return this._buildId},set:function(e){this._buildId=e},enumerable:!1,configurable:!0}),n.prototype.getClassName=function(){return"NodeMaterial"},n.prototype._attachImageProcessingConfiguration=function(e){var t=this;e!==this._imageProcessingConfiguration&&(this._imageProcessingConfiguration&&this._imageProcessingObserver&&this._imageProcessingConfiguration.onUpdateParameters.remove(this._imageProcessingObserver),e?this._imageProcessingConfiguration=e:this._imageProcessingConfiguration=this.getScene().imageProcessingConfiguration,this._imageProcessingConfiguration&&(this._imageProcessingObserver=this._imageProcessingConfiguration.onUpdateParameters.add(function(){t._markAllSubMeshesAsImageProcessingDirty()})))},n.prototype.getBlockByName=function(e){for(var t=null,i=0,o=this.attachedBlocks;i<o.length;i++){var a=o[i];if(a.name===e)if(!t)t=a;else return z.Warn("More than one block was found with the name `"+e+"`"),t}return t},n.prototype.getBlockByPredicate=function(e){for(var t=0,i=this.attachedBlocks;t<i.length;t++){var o=i[t];if(e(o))return o}return null},n.prototype.getInputBlockByPredicate=function(e){for(var t=0,i=this.attachedBlocks;t<i.length;t++){var o=i[t];if(o.isInput&&e(o))return o}return null},n.prototype.getInputBlocks=function(){for(var e=[],t=0,i=this.attachedBlocks;t<i.length;t++){var o=i[t];o.isInput&&e.push(o)}return e},n.prototype.registerOptimizer=function(e){var t=this._optimizers.indexOf(e);if(!(t>-1))return this._optimizers.push(e),this},n.prototype.unregisterOptimizer=function(e){var t=this._optimizers.indexOf(e);if(t!==-1)return this._optimizers.splice(t,1),this},n.prototype.addOutputNode=function(e){if(e.target===null)throw"This node is not meant to be an output node. You may want to explicitly set its target value.";return(e.target&g.Vertex)!==0&&this._addVertexOutputNode(e),(e.target&g.Fragment)!==0&&this._addFragmentOutputNode(e),this},n.prototype.removeOutputNode=function(e){return e.target===null?this:((e.target&g.Vertex)!==0&&this._removeVertexOutputNode(e),(e.target&g.Fragment)!==0&&this._removeFragmentOutputNode(e),this)},n.prototype._addVertexOutputNode=function(e){if(this._vertexOutputNodes.indexOf(e)===-1)return e.target=g.Vertex,this._vertexOutputNodes.push(e),this},n.prototype._removeVertexOutputNode=function(e){var t=this._vertexOutputNodes.indexOf(e);if(t!==-1)return this._vertexOutputNodes.splice(t,1),this},n.prototype._addFragmentOutputNode=function(e){if(this._fragmentOutputNodes.indexOf(e)===-1)return e.target=g.Fragment,this._fragmentOutputNodes.push(e),this},n.prototype._removeFragmentOutputNode=function(e){var t=this._fragmentOutputNodes.indexOf(e);if(t!==-1)return this._fragmentOutputNodes.splice(t,1),this},n.prototype.needAlphaBlending=function(){return this.ignoreAlpha?!1:this.forceAlphaBlending||this.alpha<1||this._sharedData&&this._sharedData.hints.needAlphaBlending},n.prototype.needAlphaTesting=function(){return this._sharedData&&this._sharedData.hints.needAlphaTesting},n.prototype._initializeBlock=function(e,t,i,o){if(o===void 0&&(o=!0),e.initialize(t),o&&e.autoConfigure(this),e._preparationId=this._buildId,this.attachedBlocks.indexOf(e)===-1){if(e.isUnique)for(var a=e.getClassName(),s=0,c=this.attachedBlocks;s<c.length;s++){var l=c[s];if(l.getClassName()===a)throw"Cannot have multiple blocks of type ".concat(a," in the same NodeMaterial")}this.attachedBlocks.push(e)}for(var u=0,f=e.inputs;u<f.length;u++){var d=f[u];d.associatedVariableName="";var p=d.connectedPoint;if(p){var m=p.ownerBlock;m!==e&&((m.target===g.VertexAndFragment||t.target===g.Fragment&&m.target===g.Vertex&&m._preparationId!==this._buildId)&&i.push(m),this._initializeBlock(m,t,i,o))}}for(var _=0,v=e.outputs;_<v.length;_++){var b=v[_];b.associatedVariableName=""}},n.prototype._resetDualBlocks=function(e,t){e.target===g.VertexAndFragment&&(e.buildId=t);for(var i=0,o=e.inputs;i<o.length;i++){var a=o[i],s=a.connectedPoint;if(s){var c=s.ownerBlock;c!==e&&this._resetDualBlocks(c,t)}}},n.prototype.removeBlock=function(e){var t=this.attachedBlocks.indexOf(e);t>-1&&this.attachedBlocks.splice(t,1),e.isFinalMerger&&this.removeOutputNode(e)},n.prototype.build=function(e,t,i){e===void 0&&(e=!1),t===void 0&&(t=!0),i===void 0&&(i=!0),this._buildWasSuccessful=!1;var o=this.getScene().getEngine(),a=this._mode===Be.Particle;if(this._vertexOutputNodes.length===0&&!a)throw"You must define at least one vertexOutputNode";if(this._fragmentOutputNodes.length===0)throw"You must define at least one fragmentOutputNode";this._vertexCompilationState=new Ui,this._vertexCompilationState.supportUniformBuffers=o.supportsUniformBuffers,this._vertexCompilationState.target=g.Vertex,this._fragmentCompilationState=new Ui,this._fragmentCompilationState.supportUniformBuffers=o.supportsUniformBuffers,this._fragmentCompilationState.target=g.Fragment,this._sharedData=new ta,this._sharedData.fragmentOutputNodes=this._fragmentOutputNodes,this._vertexCompilationState.sharedData=this._sharedData,this._fragmentCompilationState.sharedData=this._sharedData,this._sharedData.buildId=this._buildId,this._sharedData.emitComments=this._options.emitComments,this._sharedData.verbose=e,this._sharedData.scene=this.getScene(),this._sharedData.allowEmptyVertexProgram=a;for(var s=[],c=[],l=0,u=this._vertexOutputNodes;l<u.length;l++){var f=u[l];s.push(f),this._initializeBlock(f,this._vertexCompilationState,c,i)}for(var d=0,p=this._fragmentOutputNodes;d<p.length;d++){var m=p[d];c.push(m),this._initializeBlock(m,this._fragmentCompilationState,s,i)}this.optimize();for(var _=0,v=s;_<v.length;_++){var f=v[_];f.build(this._vertexCompilationState,s)}this._fragmentCompilationState.uniforms=this._vertexCompilationState.uniforms.slice(0),this._fragmentCompilationState._uniformDeclaration=this._vertexCompilationState._uniformDeclaration,this._fragmentCompilationState._constantDeclaration=this._vertexCompilationState._constantDeclaration,this._fragmentCompilationState._vertexState=this._vertexCompilationState;for(var b=0,A=c;b<A.length;b++){var m=A[b];this._resetDualBlocks(m,this._buildId-1)}for(var S=0,C=c;S<C.length;S++){var m=C[S];m.build(this._fragmentCompilationState,c)}this._vertexCompilationState.finalize(this._vertexCompilationState),this._fragmentCompilationState.finalize(this._fragmentCompilationState),t&&(this._buildId=n._BuildIdGenerator++),this._sharedData.emitErrors(),e&&(console.log("Vertex shader:"),console.log(this._vertexCompilationState.compilationString),console.log("Fragment shader:"),console.log(this._fragmentCompilationState.compilationString)),this._buildWasSuccessful=!0,this.onBuildObservable.notifyObservers(this);for(var O=this.getScene().meshes,B=0,k=O;B<k.length;B++){var D=k[B];if(!!D.subMeshes)for(var Z=0,$=D.subMeshes;Z<$.length;Z++){var I=$[Z];if(I.getMaterial()===this&&!!I.materialDefines){var ue=I.materialDefines;ue.markAllAsDirty(),ue.reset()}}}},n.prototype.optimize=function(){for(var e=0,t=this._optimizers;e<t.length;e++){var i=t[e];i.optimize(this._vertexOutputNodes,this._fragmentOutputNodes)}},n.prototype._prepareDefinesForAttributes=function(e,t){var i=t.NORMAL,o=t.TANGENT;t.NORMAL=e.isVerticesDataPresent(w.NormalKind),t.TANGENT=e.isVerticesDataPresent(w.TangentKind);for(var a=!1,s=1;s<=6;++s){var c=t["UV"+s];t["UV"+s]=e.isVerticesDataPresent("uv".concat(s===1?"":s)),a=a||t["UV"+s]!==c}(i!==t.NORMAL||o!==t.TANGENT||a)&&t.markAsAttributesDirty()},n.prototype.createPostProcess=function(e,t,i,o,a,s,c){return t===void 0&&(t=1),i===void 0&&(i=1),s===void 0&&(s=0),c===void 0&&(c=5),this.mode!==Be.PostProcess?(console.log("Incompatible material mode"),null):this._createEffectForPostProcess(null,e,t,i,o,a,s,c)},n.prototype.createEffectForPostProcess=function(e){this._createEffectForPostProcess(e)},n.prototype._createEffectForPostProcess=function(e,t,i,o,a,s,c,l){var u=this;i===void 0&&(i=1),o===void 0&&(o=1),c===void 0&&(c=0),l===void 0&&(l=5);var f=this.name+this._buildId,d=new Zt,p=new Rt(f+"PostProcess",this.getScene()),m=this._buildId;return this._processDefines(p,d),ve.RegisterShader(f,this._fragmentCompilationState._builtCompilationString,this._vertexCompilationState._builtCompilationString),e?e.updateEffect(d.toString(),this._fragmentCompilationState.uniforms,this._fragmentCompilationState.samplers,{maxSimultaneousLights:this.maxSimultaneousLights},void 0,void 0,f,f):e=new io(this.name+"PostProcess",f,this._fragmentCompilationState.uniforms,this._fragmentCompilationState.samplers,i,t,o,a,s,d.toString(),c,f,{maxSimultaneousLights:this.maxSimultaneousLights},!1,l),e.nodeMaterialSource=this,e.onApplyObservable.add(function(_){m!==u._buildId&&(delete ve.ShadersStore[f+"VertexShader"],delete ve.ShadersStore[f+"PixelShader"],f=u.name+u._buildId,d.markAllAsDirty(),m=u._buildId);var v=u._processDefines(p,d);v&&(ve.RegisterShader(f,u._fragmentCompilationState._builtCompilationString,u._vertexCompilationState._builtCompilationString),Li.SetImmediate(function(){return e.updateEffect(d.toString(),u._fragmentCompilationState.uniforms,u._fragmentCompilationState.samplers,{maxSimultaneousLights:u.maxSimultaneousLights},void 0,void 0,f,f)})),u._checkInternals(_)}),e},n.prototype.createProceduralTexture=function(e,t){var i=this;if(this.mode!==Be.ProceduralTexture)return console.log("Incompatible material mode"),null;var o=this.name+this._buildId,a=new Or(o,e,null,t),s=new Rt(o+"Procedural",this.getScene());s.reservedDataStore={hidden:!0};var c=new Zt,l=this._processDefines(s,c);ve.RegisterShader(o,this._fragmentCompilationState._builtCompilationString,this._vertexCompilationState._builtCompilationString);var u=this.getScene().getEngine().createEffect({vertexElement:o,fragmentElement:o},[w.PositionKind],this._fragmentCompilationState.uniforms,this._fragmentCompilationState.samplers,c.toString(),l==null?void 0:l.fallbacks,void 0);a.nodeMaterialSource=this,a._setEffect(u);var f=this._buildId;return a.onBeforeGenerationObservable.add(function(){f!==i._buildId&&(delete ve.ShadersStore[o+"VertexShader"],delete ve.ShadersStore[o+"PixelShader"],o=i.name+i._buildId,c.markAllAsDirty(),f=i._buildId);var d=i._processDefines(s,c);d&&(ve.RegisterShader(o,i._fragmentCompilationState._builtCompilationString,i._vertexCompilationState._builtCompilationString),Li.SetImmediate(function(){u=i.getScene().getEngine().createEffect({vertexElement:o,fragmentElement:o},[w.PositionKind],i._fragmentCompilationState.uniforms,i._fragmentCompilationState.samplers,c.toString(),d==null?void 0:d.fallbacks,void 0),a._setEffect(u)})),i._checkInternals(u)}),a},n.prototype._createEffectForParticles=function(e,t,i,o,a,s,c,l){var u=this;l===void 0&&(l="");var f=this.name+this._buildId+"_"+t;s||(s=new Zt),c||(c=this.getScene().getMeshByName(this.name+"Particle"),c||(c=new Rt(this.name+"Particle",this.getScene()),c.reservedDataStore={hidden:!0}));var d=this._buildId,p=[],m=l;if(!a){var _=this._processDefines(c,s);ve.RegisterShader(f,this._fragmentCompilationState._builtCompilationString),e.fillDefines(p,t),m=p.join(`
`),a=this.getScene().getEngine().createEffectForParticles(f,this._fragmentCompilationState.uniforms,this._fragmentCompilationState.samplers,s.toString()+`
`+m,_==null?void 0:_.fallbacks,i,o,e),e.setCustomEffect(a,t)}a.onBindObservable.add(function(v){d!==u._buildId&&(delete ve.ShadersStore[f+"PixelShader"],f=u.name+u._buildId+"_"+t,s.markAllAsDirty(),d=u._buildId),p.length=0,e.fillDefines(p,t);var b=p.join(`
`);b!==m&&(s.markAllAsDirty(),m=b);var A=u._processDefines(c,s);if(A){ve.RegisterShader(f,u._fragmentCompilationState._builtCompilationString),v=u.getScene().getEngine().createEffectForParticles(f,u._fragmentCompilationState.uniforms,u._fragmentCompilationState.samplers,s.toString()+`
`+m,A==null?void 0:A.fallbacks,i,o,e),e.setCustomEffect(v,t),u._createEffectForParticles(e,t,i,o,v,s,c,l);return}u._checkInternals(v)})},n.prototype._checkInternals=function(e){if(this._sharedData.animatedInputs){var t=this.getScene(),i=t.getFrameId();if(this._animationFrame!==i){for(var o=0,a=this._sharedData.animatedInputs;o<a.length;o++){var s=a[o];s.animate(t)}this._animationFrame=i}}for(var c=0,l=this._sharedData.bindableBlocks;c<l.length;c++){var u=l[c];u.bind(e,this)}for(var f=0,d=this._sharedData.inputBlocks;f<d.length;f++){var p=d[f];p._transmit(e,this.getScene(),this)}},n.prototype.createEffectForParticles=function(e,t,i){if(this.mode!==Be.Particle){console.log("Incompatible material mode");return}this._createEffectForParticles(e,Fi.BLENDMODE_ONEONE,t,i),this._createEffectForParticles(e,Fi.BLENDMODE_MULTIPLY,t,i)},n.prototype._processDefines=function(e,t,i,o){var a=this;i===void 0&&(i=!1);var s=null;if(this._sharedData.blocksWithDefines.forEach(function(p){p.initializeDefines(e,a,t,i)}),this._sharedData.blocksWithDefines.forEach(function(p){p.prepareDefines(e,a,t,i,o)}),t.isDirty){var c=t._areLightsDisposed;t.markAsProcessed(),this._vertexCompilationState.compilationString=this._vertexCompilationState._builtCompilationString,this._fragmentCompilationState.compilationString=this._fragmentCompilationState._builtCompilationString,this._sharedData.repeatableContentBlocks.forEach(function(p){p.replaceRepeatableContent(a._vertexCompilationState,a._fragmentCompilationState,e,t)});var l=[];this._sharedData.dynamicUniformBlocks.forEach(function(p){p.updateUniformsAndSamples(a._vertexCompilationState,a,t,l)});var u=this._vertexCompilationState.uniforms;this._fragmentCompilationState.uniforms.forEach(function(p){var m=u.indexOf(p);m===-1&&u.push(p)});var f=this._vertexCompilationState.samplers;this._fragmentCompilationState.samplers.forEach(function(p){var m=f.indexOf(p);m===-1&&f.push(p)});var d=new tr;this._sharedData.blocksWithFallbacks.forEach(function(p){p.provideFallbacks(e,d)}),s={lightDisposed:c,uniformBuffers:l,mergedUniforms:u,mergedSamplers:f,fallbacks:d}}return s},n.prototype.isReadyForSubMesh=function(e,t,i){var o=this;if(i===void 0&&(i=!1),!this._buildWasSuccessful)return!1;var a=this.getScene();if(this._sharedData.animatedInputs){var s=a.getFrameId();if(this._animationFrame!==s){for(var c=0,l=this._sharedData.animatedInputs;c<l.length;c++){var u=l[c];u.animate(a)}this._animationFrame=s}}if(t.effect&&this.isFrozen&&t.effect._wasPreviouslyReady)return!0;t.materialDefines||(t.materialDefines=new Zt);var f=t.materialDefines;if(this._isReadyForSubMesh(t))return!0;var d=a.getEngine();if(this._prepareDefinesForAttributes(e,f),this._sharedData.blockingBlocks.some(function(b){return!b.isReady(e,o,f,i)}))return!1;var p=this._processDefines(e,f,i,t);if(p){var m=t.effect,_=f.toString(),v=d.createEffect({vertex:"nodeMaterial"+this._buildId,fragment:"nodeMaterial"+this._buildId,vertexSource:this._vertexCompilationState.compilationString,fragmentSource:this._fragmentCompilationState.compilationString},{attributes:this._vertexCompilationState.attributes,uniformsNames:p.mergedUniforms,uniformBuffersNames:p.uniformBuffers,samplers:p.mergedSamplers,defines:_,fallbacks:p.fallbacks,onCompiled:this.onCompiled,onError:this.onError,indexParameters:{maxSimultaneousLights:this.maxSimultaneousLights,maxSimultaneousMorphTargets:f.NUM_MORPH_INFLUENCERS}},d);if(v)if(this._onEffectCreatedObservable&&(Sn.effect=v,Sn.subMesh=t,this._onEffectCreatedObservable.notifyObservers(Sn)),this.allowShaderHotSwapping&&m&&!v.isReady()){if(v=m,f.markAsUnprocessed(),p.lightDisposed)return f._areLightsDisposed=!0,!1}else a.resetCachedMaterial(),t.setEffect(v,f,this._materialContext)}return!t.effect||!t.effect.isReady()?!1:(f._renderId=a.getRenderId(),t.effect._wasPreviouslyReady=!0,!0)},Object.defineProperty(n.prototype,"compiledShaders",{get:function(){return`// Vertex shader\r
`.concat(this._vertexCompilationState.compilationString,`\r
\r
// Fragment shader\r
`).concat(this._fragmentCompilationState.compilationString)},enumerable:!1,configurable:!0}),n.prototype.bindOnlyWorldMatrix=function(e){var t=this.getScene();if(!!this._activeEffect){var i=this._sharedData.hints;i.needWorldViewMatrix&&e.multiplyToRef(t.getViewMatrix(),this._cachedWorldViewMatrix),i.needWorldViewProjectionMatrix&&e.multiplyToRef(t.getTransformMatrix(),this._cachedWorldViewProjectionMatrix);for(var o=0,a=this._sharedData.inputBlocks;o<a.length;o++){var s=a[o];s._transmitWorld(this._activeEffect,e,this._cachedWorldViewMatrix,this._cachedWorldViewProjectionMatrix)}}},n.prototype.bindForSubMesh=function(e,t,i){var o=this.getScene(),a=i.effect;if(!!a){this._activeEffect=a,this.bindOnlyWorldMatrix(e);var s=this._mustRebind(o,a,t.visibility),c=this._sharedData;if(s){for(var l=0,u=c.bindableBlocks;l<u.length;l++){var f=u[l];f.bind(a,this,t,i)}for(var d=0,p=c.forcedBindableBlocks;d<p.length;d++){var f=p[d];f.bind(a,this,t,i)}for(var m=0,_=c.inputBlocks;m<_.length;m++){var v=_[m];v._transmit(a,o,this)}}else if(!this.isFrozen)for(var b=0,A=c.forcedBindableBlocks;b<A.length;b++){var f=A[b];f.bind(a,this,t,i)}this._afterBind(t,this._activeEffect)}},n.prototype.getActiveTextures=function(){var e=r.prototype.getActiveTextures.call(this);return this._sharedData&&e.push.apply(e,this._sharedData.textureBlocks.filter(function(t){return t.texture}).map(function(t){return t.texture})),e},n.prototype.getTextureBlocks=function(){return this._sharedData?this._sharedData.textureBlocks:[]},n.prototype.hasTexture=function(e){if(r.prototype.hasTexture.call(this,e))return!0;if(!this._sharedData)return!1;for(var t=0,i=this._sharedData.textureBlocks;t<i.length;t++){var o=i[t];if(o.texture===e)return!0}return!1},n.prototype.dispose=function(e,t,i){if(t)for(var o=0,a=this.getTextureBlocks().filter(function(f){return f.texture}).map(function(f){return f.texture});o<a.length;o++){var s=a[o];s.dispose()}for(var c=0,l=this.attachedBlocks;c<l.length;c++){var u=l[c];u.dispose()}this.attachedBlocks=[],this._sharedData=null,this._vertexCompilationState=null,this._fragmentCompilationState=null,this.onBuildObservable.clear(),this._imageProcessingObserver&&(this._imageProcessingConfiguration.onUpdateParameters.remove(this._imageProcessingObserver),this._imageProcessingObserver=null),r.prototype.dispose.call(this,e,t,i)},n.prototype._createNodeEditor=function(){this.BJSNODEMATERIALEDITOR.NodeEditor.Show({nodeMaterial:this})},n.prototype.edit=function(e){var t=this;return new Promise(function(i){if(t.BJSNODEMATERIALEDITOR=t.BJSNODEMATERIALEDITOR||t._getGlobalNodeMaterialEditor(),typeof t.BJSNODEMATERIALEDITOR=="undefined"){var o=e&&e.editorURL?e.editorURL:n.EditorURL;z.LoadScript(o,function(){t.BJSNODEMATERIALEDITOR=t.BJSNODEMATERIALEDITOR||t._getGlobalNodeMaterialEditor(),t._createNodeEditor(),i()})}else t._createNodeEditor(),i()})},n.prototype.clear=function(){this._vertexOutputNodes=[],this._fragmentOutputNodes=[],this.attachedBlocks=[]},n.prototype.setToDefault=function(){this.clear(),this.editorData=null;var e=new K("Position");e.setAsAttribute("position");var t=new K("World");t.setAsSystemValue(Y.World);var i=new Dn("WorldPos");e.connectTo(i),t.connectTo(i);var o=new K("ViewProjection");o.setAsSystemValue(Y.ViewProjection);var a=new Dn("WorldPos * ViewProjectionTransform");i.connectTo(a),o.connectTo(a);var s=new $t("VertexOutput");a.connectTo(s);var c=new K("color");c.value=new gi(.8,.8,.8,1);var l=new Bt("FragmentOutput");c.connectTo(l),this.addOutputNode(s),this.addOutputNode(l),this._mode=Be.Material},n.prototype.setToDefaultPostProcess=function(){this.clear(),this.editorData=null;var e=new K("Position");e.setAsAttribute("position2d");var t=new K("Constant1");t.isConstant=!0,t.value=1;var i=new en("Position3D");e.connectTo(i),t.connectTo(i,{input:"w"});var o=new $t("VertexOutput");i.connectTo(o);var a=new K("Scale");a.visibleInInspector=!0,a.value=new Ge(1,1);var s=new Sr("uv0");e.connectTo(s);var c=new Bn("UV scale");s.connectTo(c),a.connectTo(c);var l=new Ar("CurrentScreen");c.connectTo(l),l.texture=new X("https://assets.babylonjs.com/nme/currentScreenPostProcess.png",this.getScene());var u=new Bt("FragmentOutput");l.connectTo(u,{output:"rgba"}),this.addOutputNode(o),this.addOutputNode(u),this._mode=Be.PostProcess},n.prototype.setToDefaultProceduralTexture=function(){this.clear(),this.editorData=null;var e=new K("Position");e.setAsAttribute("position2d");var t=new K("Constant1");t.isConstant=!0,t.value=1;var i=new en("Position3D");e.connectTo(i),t.connectTo(i,{input:"w"});var o=new $t("VertexOutput");i.connectTo(o);var a=new K("Time");a.value=0,a.min=0,a.max=0,a.isBoolean=!1,a.matrixMode=0,a.animationType=ht.Time,a.isConstant=!1;var s=new K("Color3");s.value=new G(1,1,1),s.isConstant=!1;var c=new Bt("FragmentOutput"),l=new en("VectorMerger");l.visibleInInspector=!1;var u=new Nr("Cos");u.operation=pe.Cos,e.connectTo(l),a.output.connectTo(u.input),u.output.connectTo(l.z),l.xyzOut.connectTo(c.rgb),this.addOutputNode(o),this.addOutputNode(c),this._mode=Be.ProceduralTexture},n.prototype.setToDefaultParticle=function(){this.clear(),this.editorData=null;var e=new K("uv");e.setAsAttribute("particle_uv");var t=new yr("ParticleTexture");e.connectTo(t);var i=new K("Color");i.setAsAttribute("particle_color");var o=new Bn("Texture * Color");t.connectTo(o),i.connectTo(o);var a=new Cr("ParticleRampGradient");o.connectTo(a);var s=new Rr("ColorSplitter");i.connectTo(s);var c=new Tr("ParticleBlendMultiply");a.connectTo(c),t.connectTo(c,{output:"a"}),s.connectTo(c,{output:"a"});var l=new Bt("FragmentOutput");c.connectTo(l),this.addOutputNode(l),this._mode=Be.Particle},n.prototype.loadAsync=function(e,t){var i=this;return t===void 0&&(t=""),this.getScene()._loadFileAsync(e).then(function(o){var a=JSON.parse(o);i.loadFromSerialization(a,t)})},n.prototype._gatherBlocks=function(e,t){if(t.indexOf(e)===-1){t.push(e);for(var i=0,o=e.inputs;i<o.length;i++){var a=o[i],s=a.connectedPoint;if(s){var c=s.ownerBlock;c!==e&&this._gatherBlocks(c,t)}}}},n.prototype.generateCode=function(){for(var e=[],t=[],i=["const","var","let"],o=0,a=this._vertexOutputNodes;o<a.length;o++){var s=a[o];this._gatherBlocks(s,t)}for(var c=[],l=0,u=this._fragmentOutputNodes;l<u.length;l++){var s=u[l];this._gatherBlocks(s,c)}for(var f='var nodeMaterial = new BABYLON.NodeMaterial("'.concat(this.name||"node material",`");\r
`),d=0,p=t;d<p.length;d++){var m=p[d];m.isInput&&e.indexOf(m)===-1&&(f+=m._dumpCode(i,e))}for(var _=0,v=c;_<v.length;_++){var m=v[_];m.isInput&&e.indexOf(m)===-1&&(f+=m._dumpCode(i,e))}e=[],f+=`\r
// Connections\r
`;for(var b=0,A=this._vertexOutputNodes;b<A.length;b++){var m=A[b];f+=m._dumpCodeForOutputConnections(e)}for(var S=0,C=this._fragmentOutputNodes;S<C.length;S++){var m=C[S];f+=m._dumpCodeForOutputConnections(e)}f+=`\r
// Output nodes\r
`;for(var O=0,B=this._vertexOutputNodes;O<B.length;O++){var m=B[O];f+="nodeMaterial.addOutputNode(".concat(m._codeVariableName,`);\r
`)}for(var k=0,D=this._fragmentOutputNodes;k<D.length;k++){var m=D[k];f+="nodeMaterial.addOutputNode(".concat(m._codeVariableName,`);\r
`)}return f+=`nodeMaterial.build();\r
`,f},n.prototype.serialize=function(e){var t=e?{}:ft.Serialize(this);t.editorData=JSON.parse(JSON.stringify(this.editorData));var i=[];if(e)i=e;else{t.customType="BABYLON.NodeMaterial",t.outputNodes=[];for(var o=0,a=this._vertexOutputNodes;o<a.length;o++){var s=a[o];this._gatherBlocks(s,i),t.outputNodes.push(s.uniqueId)}for(var c=0,l=this._fragmentOutputNodes;c<l.length;c++){var s=l[c];this._gatherBlocks(s,i),t.outputNodes.indexOf(s.uniqueId)===-1&&t.outputNodes.push(s.uniqueId)}}t.blocks=[];for(var u=0,f=i;u<f.length;u++){var d=f[u];t.blocks.push(d.serialize())}if(!e)for(var p=0,m=this.attachedBlocks;p<m.length;p++){var d=m[p];i.indexOf(d)===-1&&t.blocks.push(d.serialize())}return t},n.prototype._restoreConnections=function(e,t,i){for(var o=0,a=e.outputs;o<a.length;o++)for(var s=a[o],c=0,l=t.blocks;c<l.length;c++){var u=l[c],f=i[u.id];if(!!f)for(var d=0,p=u.inputs;d<p.length;d++){var m=p[d];if(i[m.targetBlockId]===e&&m.targetConnectionName===s.name){var _=f.getInputByName(m.inputName);if(!_||_.isConnected)continue;s.connectTo(_,!0),this._restoreConnections(f,t,i);continue}}}},n.prototype.loadFromSerialization=function(e,t,i){var o;t===void 0&&(t=""),i===void 0&&(i=!1),i||this.clear();for(var a={},s=0,c=e.blocks;s<c.length;s++){var l=c[s],u=_i(l.customType);if(u){var f=new u;f._deserialize(l,this.getScene(),t),a[l.id]=f,this.attachedBlocks.push(f)}}for(var d=0;d<e.blocks.length;d++){var l=e.blocks[d],f=a[l.id];!f||f.inputs.length&&!i||this._restoreConnections(f,e,a)}if(e.outputNodes)for(var p=0,m=e.outputNodes;p<m.length;p++){var _=m[p];this.addOutputNode(a[_])}if(e.locations||e.editorData&&e.editorData.locations){for(var v=e.locations||e.editorData.locations,b=0,A=v;b<A.length;b++){var S=A[b];a[S.blockId]&&(S.blockId=a[S.blockId].uniqueId)}i&&this.editorData&&this.editorData.locations&&v.concat(this.editorData.locations),e.locations?this.editorData={locations:v}:(this.editorData=e.editorData,this.editorData.locations=v);var C=[];for(var O in a)C[O]=a[O].uniqueId;this.editorData.map=C}this.comment=e.comment,e.forceAlphaBlending!==void 0&&(this.forceAlphaBlending=e.forceAlphaBlending),i||(this._mode=(o=e.mode)!==null&&o!==void 0?o:Be.Material)},n.prototype.clone=function(e,t){var i=this;t===void 0&&(t=!1);var o=this.serialize(),a=ft.Clone(function(){return new n(e,i.getScene(),i.options)},this);return a.id=e,a.name=e,a.loadFromSerialization(o),a._buildId=this._buildId,a.build(!1,!t),a},n.Parse=function(e,t,i){i===void 0&&(i="");var o=ft.Parse(function(){return new n(e.name,t)},e,t,i);return o.loadFromSerialization(e,i),o.build(),o},n.ParseFromFileAsync=function(e,t,i,o){o===void 0&&(o="");var a=new n(e,i);return new Promise(function(s,c){return a.loadAsync(t,o).then(function(){a.build(),s(a)}).catch(c)})},n.ParseFromSnippetAsync=function(e,t,i,o){var a=this;return i===void 0&&(i=""),e==="_BLANK"?Promise.resolve(this.CreateDefault("blank",t)):new Promise(function(s,c){var l=new ro;l.addEventListener("readystatechange",function(){if(l.readyState==4)if(l.status==200){var u=JSON.parse(JSON.parse(l.responseText).jsonPayload),f=JSON.parse(u.nodeMaterial);o||(o=ft.Parse(function(){return new n(e,t)},f,t,i),o.uniqueId=t.getUniqueId()),o.loadFromSerialization(f),o.snippetId=e;try{o.build(),s(o)}catch(d){c(d)}}else c("Unable to load the snippet "+e)}),l.open("GET",a.SnippetUrl+"/"+e.replace(/#/g,"/")),l.send()})},n.CreateDefault=function(e,t){var i=new n(e,t);return i.setToDefault(),i.build(),i},n._BuildIdGenerator=0,n.EditorURL="https://unpkg.com/babylonjs-node-editor@".concat(j.Version,"/babylon.nodeEditor.js"),n.SnippetUrl="https://snippet.babylonjs.com",n.IgnoreTexturesAtLoadTime=!1,E([T()],n.prototype,"ignoreAlpha",void 0),E([T()],n.prototype,"maxSimultaneousLights",void 0),E([T("mode")],n.prototype,"_mode",void 0),E([T("comment")],n.prototype,"comment",void 0),E([T()],n.prototype,"forceAlphaBlending",void 0),n}(er);P("BABYLON.NodeMaterial",fn);ln.prototype._projectOnTrianglesToRef=function(r,n,e,t,i,o){for(var a=H.Vector3[0],s=H.Vector3[1],c=1/0,l=this.indexStart;l<this.indexStart+this.indexCount-(3-t);l+=t){var u=e[l],f=e[l+1],d=e[l+2];if(i&&d===4294967295){l+=2;continue}var p=n[u],m=n[f],_=n[d];if(!(!p||!m||!_)){var v=y.ProjectOnTriangleToRef(r,p,m,_,s);v<c&&(a.copyFrom(s),c=v)}}return o.copyFrom(a),c};ln.prototype._projectOnUnIndexedTrianglesToRef=function(r,n,e,t){for(var i=H.Vector3[0],o=H.Vector3[1],a=1/0,s=this.verticesStart;s<this.verticesStart+this.verticesCount;s+=3){var c=n[s],l=n[s+1],u=n[s+2],f=y.ProjectOnTriangleToRef(r,c,l,u,o);f<a&&(i.copyFrom(o),a=f)}return t.copyFrom(i),a};ln.prototype.projectToRef=function(r,n,e,t){var i=this.getMaterial();if(!i)return-1;var o=3,a=!1;switch(i.fillMode){case 3:case 5:case 6:case 8:return-1;case 7:o=1,a=!0;break}return i.fillMode===4?-1:!e.length&&this._mesh._unIndexed?this._projectOnUnIndexedTrianglesToRef(r,n,e,t):this._projectOnTrianglesToRef(r,n,e,o,a,t)};var Fe;(function(r){r[r.DEHYDRATED=0]="DEHYDRATED",r[r.HOVER=1]="HOVER",r[r.TOUCH=2]="TOUCH"})(Fe||(Fe={}));var lt;(function(r){r[r.DISABLED=0]="DISABLED",r[r.CENTERED_ON_CONTROLLER=1]="CENTERED_ON_CONTROLLER",r[r.CENTERED_IN_FRONT=2]="CENTERED_IN_FRONT"})(lt||(lt={}));var tn=function(r){R(n,r);function n(e,t){var i=r.call(this,e)||this;return i._options=t,i._tmpRay=new pt(new y,new y),i._attachController=function(o){if(!i._controllers[o.uniqueId]){var a=i._generateNewTouchPointMesh(),s=a.touchCollisionMesh,c=a.touchCollisionMeshFunction,l=a.hydrateCollisionMeshFunction,u=i._generateVisualCue();switch(i._controllers[o.uniqueId]={xrController:o,meshUnderPointer:null,nearInteractionTargetMesh:null,pick:null,stalePick:null,touchCollisionMesh:s,touchCollisionMeshFunction:c,hydrateCollisionMeshFunction:l,currentAnimationState:Fe.DEHYDRATED,grabRay:new pt(new y,new y),hoverInteraction:!1,nearInteraction:!1,grabInteraction:!1,id:n._IdCounter++,pickedPointVisualCue:u},i._attachedController?!i._options.enableNearInteractionOnAllControllers&&i._options.preferredHandedness&&o.inputSource.handedness===i._options.preferredHandedness&&(i._attachedController=o.uniqueId):i._options.enableNearInteractionOnAllControllers||(i._attachedController=o.uniqueId),o.inputSource.targetRayMode){case"tracked-pointer":return i._attachNearInteractionMode(o);case"gaze":return null;case"screen":return null}}},i._controllers={},i._farInteractionFeature=null,i.selectionMeshDefaultColor=new G(.8,.8,.8),i.selectionMeshPickedColor=new G(.3,.3,1),i._hoverRadius=.1,i._pickRadius=.02,i._controllerPickRadius=.03,i._nearGrabLengthScale=5,i._scene=i._xrSessionManager.scene,i._options.nearInteractionControllerMode===void 0&&(i._options.nearInteractionControllerMode=lt.CENTERED_IN_FRONT),i._options.farInteractionFeature&&(i._farInteractionFeature=i._options.farInteractionFeature),i}return n.prototype.attach=function(){var e=this;return r.prototype.attach.call(this)?(this._options.xrInput.controllers.forEach(this._attachController),this._addNewAttachObserver(this._options.xrInput.onControllerAddedObservable,this._attachController),this._addNewAttachObserver(this._options.xrInput.onControllerRemovedObservable,function(t){e._detachController(t.uniqueId)}),this._scene.constantlyUpdateMeshUnderPointer=!0,!0):!1},n.prototype.detach=function(){var e=this;return r.prototype.detach.call(this)?(Object.keys(this._controllers).forEach(function(t){e._detachController(t)}),!0):!1},n.prototype.getMeshUnderPointer=function(e){return this._controllers[e]?this._controllers[e].meshUnderPointer:null},n.prototype.getXRControllerByPointerId=function(e){for(var t=Object.keys(this._controllers),i=0;i<t.length;++i)if(this._controllers[t[i]].id===e)return this._controllers[t[i]].xrController||null;return null},n.prototype.setFarInteractionFeature=function(e){this._farInteractionFeature=e},n.prototype._nearPickPredicate=function(e){return e.isEnabled()&&e.isVisible&&e.isPickable&&e.isNearPickable},n.prototype._nearGrabPredicate=function(e){return e.isEnabled()&&e.isVisible&&e.isPickable&&e.isNearGrabbable},n.prototype._nearInteractionPredicate=function(e){return e.isEnabled()&&e.isVisible&&e.isPickable&&(e.isNearPickable||e.isNearGrabbable)},n.prototype._controllerAvailablePredicate=function(e,t){for(var i=e;i;){if(i.reservedDataStore&&i.reservedDataStore.nearInteraction&&i.reservedDataStore.nearInteraction.excludedControllerId===t)return!1;i=i.parent}return!0},n.prototype._handleTransitionAnimation=function(e,t){var i;if(!(e.currentAnimationState===t||this._options.nearInteractionControllerMode!==lt.CENTERED_IN_FRONT||!!(!((i=e.xrController)===null||i===void 0)&&i.inputSource.hand))){if(t>e.currentAnimationState)switch(e.currentAnimationState){case Fe.DEHYDRATED:if(e.hydrateCollisionMeshFunction(!0),t===Fe.HOVER)break;case Fe.HOVER:if(e.touchCollisionMeshFunction(!0),t===Fe.TOUCH)break}else switch(e.currentAnimationState){case Fe.TOUCH:if(e.touchCollisionMeshFunction(!1),t===Fe.HOVER)break;case Fe.HOVER:if(e.hydrateCollisionMeshFunction(!1),t===Fe.DEHYDRATED)break}e.currentAnimationState=t}},n.prototype._processTouchPoint=function(e,t,i){var o,a=this._controllers[e];a.grabRay.origin.copyFrom(t),i.toEulerAnglesToRef(H.Vector3[0]),a.grabRay.direction.copyFrom(H.Vector3[0]),this._options.nearInteractionControllerMode===lt.CENTERED_IN_FRONT&&!(!((o=a.xrController)===null||o===void 0)&&o.inputSource.hand)&&(a.xrController.getWorldPointerRayToRef(this._tmpRay),a.grabRay.origin.addInPlace(this._tmpRay.direction.scale(.05))),a.grabRay.length=this._nearGrabLengthScale*this._hoverRadius,a.touchCollisionMesh.position.copyFrom(a.grabRay.origin)},n.prototype._onXRFrame=function(e){var t=this;Object.keys(this._controllers).forEach(function(i){var o,a=t._controllers[i],s=(o=a.xrController)===null||o===void 0?void 0:o.inputSource.hand;if(!t._options.enableNearInteractionOnAllControllers&&i!==t._attachedController||!a.xrController||!s&&(!t._options.nearInteractionControllerMode||!a.xrController.inputSource.gamepad)){a.pick=null;return}if(a.hoverInteraction=!1,a.nearInteraction=!1,a.xrController){if(s){var c=s.get("index-finger-tip");if(c){var l=e.getJointPose(c,t._xrSessionManager.referenceSpace);if(l&&l.transform){var u=t._scene.useRightHandedSystem?1:-1;H.Vector3[0].set(l.transform.position.x,l.transform.position.y,l.transform.position.z*u),H.Quaternion[0].set(l.transform.orientation.x,l.transform.orientation.y,l.transform.orientation.z*u,l.transform.orientation.w*u),t._processTouchPoint(i,H.Vector3[0],H.Quaternion[0])}}}else if(a.xrController.inputSource.gamepad&&t._options.nearInteractionControllerMode!==lt.DISABLED){var f=a.xrController.pointer;a.xrController.grip&&t._options.nearInteractionControllerMode===lt.CENTERED_ON_CONTROLLER&&(f=a.xrController.grip),t._processTouchPoint(i,f.position,f.rotationQuaternion)}}else return;var d=function(D,Z){var $=null;return!Z||!Z.hit?$=D:!D||!D.hit||Z.distance<D.distance?$=Z:$=D,$},p=function(D){var Z=new At,$=!1,I=D&&D.pickedPoint&&D.hit;return D!=null&&D.pickedPoint&&($=D.pickedPoint.x===0&&D.pickedPoint.y===0&&D.pickedPoint.z===0),I&&!$&&(Z=D),Z};if(!a.grabInteraction){var m=null,_=null;t._options.useUtilityLayer&&t._utilityLayerScene&&(_=t._pickWithSphere(a,t._hoverRadius,t._utilityLayerScene,function(D){return t._nearInteractionPredicate(D)}));var v=t._pickWithSphere(a,t._hoverRadius,t._scene,function(D){return t._nearInteractionPredicate(D)}),b=d(v,_);if(b&&b.hit&&(m=p(b),m.hit&&(a.hoverInteraction=!0)),a.hoverInteraction){var A=null,S=s?t._pickRadius:t._controllerPickRadius;t._options.useUtilityLayer&&t._utilityLayerScene&&(A=t._pickWithSphere(a,S,t._utilityLayerScene,function(D){return t._nearPickPredicate(D)}));var C=t._pickWithSphere(a,S,t._scene,function(D){return t._nearPickPredicate(D)}),O=d(C,A),B=p(O);B.hit&&(m=B,a.nearInteraction=!0)}a.stalePick=a.pick,a.pick=m,a.pick&&a.pick.pickedPoint&&a.pick.hit?(a.meshUnderPointer=a.pick.pickedMesh,a.pickedPointVisualCue.position.copyFrom(a.pick.pickedPoint),a.pickedPointVisualCue.isVisible=!0,t._farInteractionFeature&&t._farInteractionFeature.attached&&t._farInteractionFeature._setPointerSelectionDisabledByPointerId(a.id,!0)):(a.meshUnderPointer=null,a.pickedPointVisualCue.isVisible=!1,t._farInteractionFeature&&t._farInteractionFeature.attached&&t._farInteractionFeature._setPointerSelectionDisabledByPointerId(a.id,!1))}var k=Fe.DEHYDRATED;a.grabInteraction||a.nearInteraction?k=Fe.TOUCH:a.hoverInteraction&&(k=Fe.HOVER),t._handleTransitionAnimation(a,k)})},Object.defineProperty(n.prototype,"_utilityLayerScene",{get:function(){return this._options.customUtilityLayerScene||dt.DefaultUtilityLayer.utilityLayerScene},enumerable:!1,configurable:!0}),n.prototype._generateVisualCue=function(){var e=this._options.useUtilityLayer?this._options.customUtilityLayerScene||dt.DefaultUtilityLayer.utilityLayerScene:this._scene,t=Pn("nearInteraction",{diameter:.0035*3},e);t.bakeCurrentTransformIntoVertices(),t.isPickable=!1,t.isVisible=!1,t.rotationQuaternion=q.Identity();var i=new Ze("targetMat",e);return i.specularColor=G.Black(),i.emissiveColor=this.selectionMeshDefaultColor,i.backFaceCulling=!1,t.material=i,t},n.prototype._isControllerReadyForNearInteraction=function(e){return this._farInteractionFeature?this._farInteractionFeature._getPointerSelectionDisabledByPointerId(e):!0},n.prototype._attachNearInteractionMode=function(e){var t=this,i=this._controllers[e.uniqueId],o={pointerId:i.id,pointerType:"xr"};i.onFrameObserver=this._xrSessionManager.onXRFrameObservable.add(function(){!t._options.enableNearInteractionOnAllControllers&&e.uniqueId!==t._attachedController||!i.xrController||!i.xrController.inputSource.hand&&(!t._options.nearInteractionControllerMode||!i.xrController.inputSource.gamepad)||(i.pick&&(i.pick.ray=i.grabRay),i.pick&&t._isControllerReadyForNearInteraction(i.id)&&t._scene.simulatePointerMove(i.pick,o),i.nearInteraction&&i.pick&&i.pick.hit?i.nearInteractionTargetMesh||(t._scene.simulatePointerDown(i.pick,o),i.nearInteractionTargetMesh=i.meshUnderPointer):i.nearInteractionTargetMesh&&i.stalePick&&(t._scene.simulatePointerUp(i.stalePick,o),i.nearInteractionTargetMesh=null))});var a=function(u){t._options.enableNearInteractionOnAllControllers||e.uniqueId===t._attachedController&&t._isControllerReadyForNearInteraction(i.id)?(i.pick&&(i.pick.ray=i.grabRay),u&&i.pick&&i.meshUnderPointer&&t._nearGrabPredicate(i.meshUnderPointer)?(i.grabInteraction=!0,i.pickedPointVisualCue.isVisible=!1,t._scene.simulatePointerDown(i.pick,o)):!u&&i.pick&&i.grabInteraction&&(t._scene.simulatePointerUp(i.pick,o),i.grabInteraction=!1,i.pickedPointVisualCue.isVisible=!0)):u&&!t._options.enableNearInteractionOnAllControllers&&!t._options.disableSwitchOnClick&&(t._attachedController=e.uniqueId)};if(e.inputSource.gamepad){var s=function(u){i.squeezeComponent=u.getComponent("grasp"),i.squeezeComponent?i.onSqueezeButtonChangedObserver=i.squeezeComponent.onButtonStateChangedObservable.add(function(f){if(f.changes.pressed){var d=f.changes.pressed.current;a(d)}}):(i.selectionComponent=u.getMainComponent(),i.onButtonChangedObserver=i.selectionComponent.onButtonStateChangedObservable.add(function(f){if(f.changes.pressed){var d=f.changes.pressed.current;a(d)}}))};e.motionController?s(e.motionController):e.onMotionControllerInitObservable.add(s)}else{var c=function(u){i.xrController&&u.inputSource===i.xrController.inputSource&&i.pick&&t._isControllerReadyForNearInteraction(i.id)&&i.meshUnderPointer&&t._nearGrabPredicate(i.meshUnderPointer)&&(i.grabInteraction=!0,i.pickedPointVisualCue.isVisible=!1,t._scene.simulatePointerDown(i.pick,o))},l=function(u){i.xrController&&u.inputSource===i.xrController.inputSource&&i.pick&&t._isControllerReadyForNearInteraction(i.id)&&(t._scene.simulatePointerUp(i.pick,o),i.grabInteraction=!1,i.pickedPointVisualCue.isVisible=!0)};i.eventListeners={selectend:l,selectstart:c},this._xrSessionManager.session.addEventListener("selectstart",c),this._xrSessionManager.session.addEventListener("selectend",l)}},n.prototype._detachController=function(e){var t=this,i=this._controllers[e];if(!!i&&(i.squeezeComponent&&i.onSqueezeButtonChangedObserver&&i.squeezeComponent.onButtonStateChangedObservable.remove(i.onSqueezeButtonChangedObserver),i.selectionComponent&&i.onButtonChangedObserver&&i.selectionComponent.onButtonStateChangedObservable.remove(i.onButtonChangedObserver),i.onFrameObserver&&this._xrSessionManager.onXRFrameObservable.remove(i.onFrameObserver),i.eventListeners&&Object.keys(i.eventListeners).forEach(function(a){var s=i.eventListeners&&i.eventListeners[a];s&&t._xrSessionManager.session.removeEventListener(a,s)}),i.touchCollisionMesh.dispose(),i.pickedPointVisualCue.dispose(),this._xrSessionManager.runInXRFrame(function(){var a={pointerId:i.id,pointerType:"xr"};t._scene.simulatePointerUp(new At,a)}),delete this._controllers[e],this._attachedController===e)){var o=Object.keys(this._controllers);o.length?this._attachedController=o[0]:this._attachedController=""}},n.prototype._generateNewTouchPointMesh=function(){var e=this._options.useUtilityLayer?this._options.customUtilityLayerScene||dt.DefaultUtilityLayer.utilityLayerScene:this._scene,t=Pn("PickSphere",{diameter:1},e);t.isVisible=!1,this._options.motionControllerOrbMaterial?t.material=this._options.motionControllerOrbMaterial:fn.ParseFromSnippetAsync("8RUNKL#3",e).then(function(D){t.material=D});var i=new oo;i.setEasingMode(nr.EASINGMODE_EASEINOUT);var o=new y(this._controllerPickRadius,this._controllerPickRadius,this._controllerPickRadius),a=this._controllerPickRadius*(4/3),s=new y(a,a,a),c=this._controllerPickRadius*(7/6),l=new y(c,c,c),u=this._controllerPickRadius*(4/5),f=new y(u,u,u),d=this._controllerPickRadius*(3/2),p=new y(d,d,d),m=[{frame:0,value:o},{frame:10,value:p},{frame:18,value:s}],_=[{frame:0,value:s},{frame:10,value:f},{frame:18,value:o}],v=[{frame:0,value:y.ZeroReadOnly},{frame:12,value:l},{frame:15,value:o}],b=[{frame:0,value:o},{frame:10,value:y.ZeroReadOnly},{frame:15,value:y.ZeroReadOnly}],A=new J("touch","scaling",60,J.ANIMATIONTYPE_VECTOR3,J.ANIMATIONLOOPMODE_CONSTANT),S=new J("release","scaling",60,J.ANIMATIONTYPE_VECTOR3,J.ANIMATIONLOOPMODE_CONSTANT),C=new J("hydrate","scaling",60,J.ANIMATIONTYPE_VECTOR3,J.ANIMATIONLOOPMODE_CONSTANT),O=new J("dehydrate","scaling",60,J.ANIMATIONTYPE_VECTOR3,J.ANIMATIONLOOPMODE_CONSTANT);A.setEasingFunction(i),S.setEasingFunction(i),C.setEasingFunction(i),O.setEasingFunction(i),A.setKeys(m),S.setKeys(_),C.setKeys(v),O.setKeys(b);var B=function(D){var Z=D?A:S;e.beginDirectAnimation(t,[Z],0,18,!1,1)},k=function(D){var Z=D?C:O;D&&(t.isVisible=!0),e.beginDirectAnimation(t,[Z],0,15,!1,1,function(){D||(t.isVisible=!1)})};return{touchCollisionMesh:t,touchCollisionMeshFunction:B,hydrateCollisionMeshFunction:k}},n.prototype._pickWithSphere=function(e,t,i,o){var a=new At;if(a.distance=1/0,e.touchCollisionMesh&&e.xrController)for(var s=e.touchCollisionMesh.position,c=Di.CreateFromCenterAndRadius(s,t),l=0;l<i.meshes.length;l++){var u=i.meshes[l];if(!(!o(u)||!this._controllerAvailablePredicate(u,e.xrController.uniqueId))){var f=n.PickMeshWithSphere(u,c);f&&f.hit&&f.distance<a.distance&&(a.hit=f.hit,a.pickedMesh=u,a.pickedPoint=f.pickedPoint,a.aimTransform=e.xrController.pointer,a.gripTransform=e.xrController.grip||null,a.originMesh=e.touchCollisionMesh,a.distance=f.distance)}}return a},n.PickMeshWithSphere=function(e,t,i){i===void 0&&(i=!1);var o=e.subMeshes,a=new At,s=e.getBoundingInfo();if(!e._generatePointsArray()||!e.subMeshes||!s||!i&&!Di.Intersects(s.boundingSphere,t))return a;var c=H.Vector3[0],l=H.Vector3[1],u=1/0,f,d,p,m=H.Vector3[2],_=H.Matrix[0];_.copyFrom(e.getWorldMatrix()),_.invert(),y.TransformCoordinatesToRef(t.center,_,m);for(var v=0;v<o.length;v++){var b=o[v];b.projectToRef(m,e._positions,e.getIndices(),l),y.TransformCoordinatesToRef(l,e.getWorldMatrix(),l),f=y.Distance(l,t.center),p=y.Distance(l,e.getAbsolutePosition()),d=y.Distance(t.center,e.getAbsolutePosition()),d!==-1&&p!==-1&&p>d&&(f=0,l.copyFrom(t.center)),f!==-1&&f<u&&(u=f,c.copyFrom(l))}return u<t.radius&&(a.hit=!0,a.distance=u,a.pickedMesh=e,a.pickedPoint=c.clone()),a},n._IdCounter=200,n.Name=$e.NEAR_INTERACTION,n.Version=1,n}(Ci);un.AddWebXRFeature(tn.Name,function(r,n){return function(){return new tn(r,n)}},tn.Version,!0);var aa=function(){function r(n,e,t){this.element=n,this.sessionMode=e,this.referenceSpaceType=t}return r.prototype.update=function(n){},r}(),sa=function(){function r(n,e){var t=this;if(this._scene=n,this.options=e,this._activeButton=null,this._buttons=[],this.activeButtonChangedObservable=new U,this._onSessionGranted=function(f){t._helper&&t._enterXRWithButtonIndex(0)},this.overlay=document.createElement("div"),this.overlay.classList.add("xr-button-overlay"),this.overlay.style.cssText="z-index:11;position: absolute; right: 20px;bottom: 50px;",!e.ignoreSessionGrantedEvent&&navigator.xr&&navigator.xr.addEventListener("sessiongranted",this._onSessionGranted),typeof window!="undefined"&&window.location&&window.location.protocol==="http:"&&window.location.hostname!=="localhost")throw z.Warn("WebXR can only be served over HTTPS"),new Error("WebXR can only be served over HTTPS");if(e.customButtons)this._buttons=e.customButtons;else{var i=e.sessionMode||"immersive-vr",o=e.referenceSpaceType||"local-floor",a=typeof SVGSVGElement=="undefined"?"https://cdn.babylonjs.com/Assets/vrButton.png":"data:image/svg+xml;charset=UTF-8,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%222048%22%20height%3D%221152%22%20viewBox%3D%220%200%202048%201152%22%20version%3D%221.1%22%3E%3Cpath%20transform%3D%22rotate%28180%201024%2C576.0000000000001%29%22%20d%3D%22m1109%2C896q17%2C0%2030%2C-12t13%2C-30t-12.5%2C-30.5t-30.5%2C-12.5l-170%2C0q-18%2C0%20-30.5%2C12.5t-12.5%2C30.5t13%2C30t30%2C12l170%2C0zm-85%2C256q59%2C0%20132.5%2C-1.5t154.5%2C-5.5t164.5%2C-11.5t163%2C-20t150%2C-30t124.5%2C-41.5q23%2C-11%2042%2C-24t38%2C-30q27%2C-25%2041%2C-61.5t14%2C-72.5l0%2C-257q0%2C-123%20-47%2C-232t-128%2C-190t-190%2C-128t-232%2C-47l-81%2C0q-37%2C0%20-68.5%2C14t-60.5%2C34.5t-55.5%2C45t-53%2C45t-53%2C34.5t-55.5%2C14t-55.5%2C-14t-53%2C-34.5t-53%2C-45t-55.5%2C-45t-60.5%2C-34.5t-68.5%2C-14l-81%2C0q-123%2C0%20-232%2C47t-190%2C128t-128%2C190t-47%2C232l0%2C257q0%2C68%2038%2C115t97%2C73q54%2C24%20124.5%2C41.5t150%2C30t163%2C20t164.5%2C11.5t154.5%2C5.5t132.5%2C1.5zm939%2C-298q0%2C39%20-24.5%2C67t-58.5%2C42q-54%2C23%20-122%2C39.5t-143.5%2C28t-155.5%2C19t-157%2C11t-148.5%2C5t-129.5%2C1.5q-59%2C0%20-130%2C-1.5t-148%2C-5t-157%2C-11t-155.5%2C-19t-143.5%2C-28t-122%2C-39.5q-34%2C-14%20-58.5%2C-42t-24.5%2C-67l0%2C-257q0%2C-106%2040.5%2C-199t110%2C-162.5t162.5%2C-109.5t199%2C-40l81%2C0q27%2C0%2052%2C14t50%2C34.5t51%2C44.5t55.5%2C44.5t63.5%2C34.5t74%2C14t74%2C-14t63.5%2C-34.5t55.5%2C-44.5t51%2C-44.5t50%2C-34.5t52%2C-14l14%2C0q37%2C0%2070%2C0.5t64.5%2C4.5t63.5%2C12t68%2C23q71%2C30%20128.5%2C78.5t98.5%2C110t63.5%2C133.5t22.5%2C149l0%2C257z%22%20fill%3D%22white%22%20/%3E%3C/svg%3E%0A",s=".babylonVRicon { color: #868686; border-color: #868686; border-style: solid; margin-left: 10px; height: 50px; width: 80px; background-color: rgba(51,51,51,0.7); background-image: url("+a+"); background-size: 80%; background-repeat:no-repeat; background-position: center; border: none; outline: none; transition: transform 0.125s ease-out } .babylonVRicon:hover { transform: scale(1.05) } .babylonVRicon:active {background-color: rgba(51,51,51,1) } .babylonVRicon:focus {background-color: rgba(51,51,51,1) }";s+='.babylonVRicon.vrdisplaypresenting { background-image: none;} .vrdisplaypresenting::after { content: "EXIT"} .xr-error::after { content: "ERROR"}';var c=document.createElement("style");c.appendChild(document.createTextNode(s)),document.getElementsByTagName("head")[0].appendChild(c);var l=document.createElement("button");l.className="babylonVRicon",l.title="".concat(i," - ").concat(o),this._buttons.push(new aa(l,i,o)),this._buttons[this._buttons.length-1].update=function(f){this.element.style.display=f===null||f===this?"":"none",l.className="babylonVRicon"+(f===this?" vrdisplaypresenting":"")},this._updateButtons(null)}var u=n.getEngine().getInputElement();u&&u.parentNode&&(u.parentNode.appendChild(this.overlay),n.onDisposeObservable.addOnce(function(){t.dispose()}))}return r.prototype.setHelperAsync=function(n,e){return it(this,void 0,void 0,function(){var t,i,o=this;return rt(this,function(a){switch(a.label){case 0:return this._helper=n,this._renderTarget=e,t=this._buttons.map(function(s){return n.sessionManager.isSessionSupportedAsync(s.sessionMode)}),n.onStateChangedObservable.add(function(s){s==Ce.NOT_IN_XR&&o._updateButtons(null)}),[4,Promise.all(t)];case 1:return i=a.sent(),i.forEach(function(s,c){s?(o.overlay.appendChild(o._buttons[c].element),o._buttons[c].element.onclick=o._enterXRWithButtonIndex.bind(o,c)):z.Warn('Session mode "'.concat(o._buttons[c].sessionMode,'" not supported in browser'))}),[2]}})})},r.CreateAsync=function(n,e,t){return it(this,void 0,void 0,function(){var i;return rt(this,function(o){switch(o.label){case 0:return i=new r(n,t),[4,i.setHelperAsync(e,t.renderTarget||void 0)];case 1:return o.sent(),[2,i]}})})},r.prototype._enterXRWithButtonIndex=function(n){return n===void 0&&(n=0),it(this,void 0,void 0,function(){var e,t,i;return rt(this,function(o){switch(o.label){case 0:return this._helper.state!=Ce.IN_XR?[3,2]:[4,this._helper.exitXRAsync()];case 1:return o.sent(),this._updateButtons(null),[3,6];case 2:if(this._helper.state!=Ce.NOT_IN_XR)return[3,6];o.label=3;case 3:return o.trys.push([3,5,,6]),[4,this._helper.enterXRAsync(this._buttons[n].sessionMode,this._buttons[n].referenceSpaceType,this._renderTarget,{optionalFeatures:this.options.optionalFeatures,requiredFeatures:this.options.requiredFeatures})];case 4:return o.sent(),this._updateButtons(this._buttons[n]),[3,6];case 5:return e=o.sent(),this._updateButtons(null),t=this._buttons[n].element,i=t.title,t.title="Error entering XR session : "+i,t.classList.add("xr-error"),this.options.onError&&this.options.onError(e),[3,6];case 6:return[2]}})})},r.prototype.dispose=function(){var n=this._scene.getEngine().getInputElement();n&&n.parentNode&&n.parentNode.contains(this.overlay)&&n.parentNode.removeChild(this.overlay),this.activeButtonChangedObservable.clear(),navigator.xr.removeEventListener("sessiongranted",this._onSessionGranted)},r.prototype._updateButtons=function(n){var e=this;this._activeButton=n,this._buttons.forEach(function(t){t.update(e._activeButton)}),this.activeButtonChangedObservable.notifyObservers(this._activeButton)},r}(),ca=function(r){R(n,r);function n(e,t,i,o,a,s,c){i===void 0&&(i=null),o===void 0&&(o=!1),a===void 0&&(a=3),s===void 0&&(s=5);var l=r.call(this,null,i,!o,c,a,void 0,void 0,void 0,void 0,s)||this;l.name=e,l.wrapU=X.CLAMP_ADDRESSMODE,l.wrapV=X.CLAMP_ADDRESSMODE,l._generateMipMaps=o;var u=l._getEngine();if(!u)return l;t.getContext?(l._canvas=t,l._texture=u.createDynamicTexture(t.width,t.height,o,a)):(l._canvas=u.createCanvas(1,1),t.width||t.width===0?l._texture=u.createDynamicTexture(t.width,t.height,o,a):l._texture=u.createDynamicTexture(t,t,o,a));var f=l.getSize();return l._canvas.width!==f.width&&(l._canvas.width=f.width),l._canvas.height!==f.height&&(l._canvas.height=f.height),l._context=l._canvas.getContext("2d"),l}return n.prototype.getClassName=function(){return"DynamicTexture"},Object.defineProperty(n.prototype,"canRescale",{get:function(){return!0},enumerable:!1,configurable:!0}),n.prototype._recreate=function(e){this._canvas.width=e.width,this._canvas.height=e.height,this.releaseInternalTexture(),this._texture=this._getEngine().createDynamicTexture(e.width,e.height,this._generateMipMaps,this.samplingMode)},n.prototype.scale=function(e){var t=this.getSize();t.width*=e,t.height*=e,this._recreate(t)},n.prototype.scaleTo=function(e,t){var i=this.getSize();i.width=e,i.height=t,this._recreate(i)},n.prototype.getContext=function(){return this._context},n.prototype.clear=function(){var e=this.getSize();this._context.fillRect(0,0,e.width,e.height)},n.prototype.update=function(e,t,i){t===void 0&&(t=!1),i===void 0&&(i=!1),this._getEngine().updateDynamicTexture(this._texture,this._canvas,e===void 0?!0:e,t,this._format||void 0,void 0,i)},n.prototype.drawText=function(e,t,i,o,a,s,c,l){l===void 0&&(l=!0);var u=this.getSize();if(s&&(this._context.fillStyle=s,this._context.fillRect(0,0,u.width,u.height)),this._context.font=o,t==null){var f=this._context.measureText(e);t=(u.width-f.width)/2}if(i==null){var d=parseInt(o.replace(/\D/g,""));i=u.height/2+d/3.65}this._context.fillStyle=a||"",this._context.fillText(e,t,i),l&&this.update(c)},n.prototype.clone=function(){var e=this.getScene();if(!e)return this;var t=this.getSize(),i=new n(this.name,t,e,this._generateMipMaps);return i.hasAlpha=this.hasAlpha,i.level=this.level,i.wrapU=this.wrapU,i.wrapV=this.wrapV,i},n.prototype.serialize=function(){var e=this.getScene();e&&!e.isReady()&&ne.Warn("The scene must be ready before serializing the dynamic texture");var t=r.prototype.serialize.call(this);return n._IsCanvasElement(this._canvas)&&(t.base64String=this._canvas.toDataURL()),t.invertY=this._invertY,t.samplingMode=this.samplingMode,t},n._IsCanvasElement=function(e){return e.toDataURL!==void 0},n.prototype._rebuild=function(){this.update()},n}(X),nn=function(r){R(n,r);function n(e,t){var i=r.call(this,e)||this;return i._options=t,i._controllers={},i._snappedToPoint=!1,i._tmpRay=new pt(new y,new y),i._tmpVector=new y,i._tmpQuaternion=new q,i.skipNextTeleportation=!1,i.backwardsMovementEnabled=!0,i.backwardsTeleportationDistance=.7,i.parabolicCheckRadius=5,i.parabolicRayEnabled=!0,i.straightRayEnabled=!0,i.rotationAngle=Math.PI/8,i.onTargetMeshPositionUpdatedObservable=new U,i.teleportationEnabled=!0,i._rotationEnabled=!0,i._attachController=function(o){if(!(i._controllers[o.uniqueId]||i._options.forceHandedness&&o.inputSource.handedness!==i._options.forceHandedness)){i._controllers[o.uniqueId]={xrController:o,teleportationState:{forward:!1,backwards:!1,rotating:!1,currentRotation:0,baseRotation:0}};var a=i._controllers[o.uniqueId];if(a.xrController.inputSource.targetRayMode==="tracked-pointer"&&a.xrController.inputSource.gamepad){var s=function(){if(o.motionController){var c=o.motionController.getComponentOfType(kt.THUMBSTICK_TYPE)||o.motionController.getComponentOfType(kt.TOUCHPAD_TYPE);if(!c||i._options.useMainComponentOnly){var l=o.motionController.getMainComponent();if(!l)return;a.teleportationComponent=l,a.onButtonChangedObserver=l.onButtonStateChangedObservable.add(function(){if(!!i.teleportationEnabled&&l.changes.pressed)if(l.changes.pressed.current){a.teleportationState.forward=!0,i._currentTeleportationControllerId=a.xrController.uniqueId,a.teleportationState.baseRotation=i._options.xrInput.xrCamera.rotationQuaternion.toEulerAngles().y,a.teleportationState.currentRotation=0;var u=i._options.timeToTeleport||3e3;Bi({timeout:u,contextObservable:i._xrSessionManager.onXRFrameObservable,breakCondition:function(){return!l.pressed},onEnded:function(){i._currentTeleportationControllerId===a.xrController.uniqueId&&a.teleportationState.forward&&i._teleportForward(o.uniqueId)}})}else a.teleportationState.forward=!1,i._currentTeleportationControllerId=""})}else a.teleportationComponent=c,a.onAxisChangedObserver=c.onAxisValueChangedObservable.add(function(u){if(u.y<=.7&&a.teleportationState.backwards&&(a.teleportationState.backwards=!1),u.y>.7&&!a.teleportationState.forward&&i.backwardsMovementEnabled&&!i.snapPointsOnly&&!a.teleportationState.backwards){a.teleportationState.backwards=!0,i._tmpQuaternion.copyFrom(i._options.xrInput.xrCamera.rotationQuaternion),i._tmpQuaternion.toEulerAnglesToRef(i._tmpVector),i._tmpVector.x=0,i._tmpVector.z=0,q.FromEulerVectorToRef(i._tmpVector,i._tmpQuaternion),i._tmpVector.set(0,0,i.backwardsTeleportationDistance*(i._xrSessionManager.scene.useRightHandedSystem?1:-1)),i._tmpVector.rotateByQuaternionToRef(i._tmpQuaternion,i._tmpVector),i._tmpVector.addInPlace(i._options.xrInput.xrCamera.position),i._tmpRay.origin.copyFrom(i._tmpVector),i._tmpRay.length=i._options.xrInput.xrCamera.realWorldHeight+.1,i._tmpRay.direction.set(0,-1,0);var f=i._xrSessionManager.scene.pickWithRay(i._tmpRay,function(p){return i._floorMeshes.indexOf(p)!==-1});f&&f.pickedPoint&&(i._options.xrInput.xrCamera.position.x=f.pickedPoint.x,i._options.xrInput.xrCamera.position.z=f.pickedPoint.z)}if(u.y<-.7&&!i._currentTeleportationControllerId&&!a.teleportationState.rotating&&i.teleportationEnabled&&(a.teleportationState.forward=!0,i._currentTeleportationControllerId=a.xrController.uniqueId,a.teleportationState.baseRotation=i._options.xrInput.xrCamera.rotationQuaternion.toEulerAngles().y),u.x){if(a.teleportationState.forward)i._currentTeleportationControllerId===a.xrController.uniqueId&&(i.rotationEnabled?setTimeout(function(){a.teleportationState.currentRotation=Math.atan2(u.x,u.y*(i._xrSessionManager.scene.useRightHandedSystem?1:-1))}):a.teleportationState.currentRotation=0);else if(!a.teleportationState.rotating&&Math.abs(u.x)>.7){a.teleportationState.rotating=!0;var d=i.rotationAngle*(u.x>0?1:-1)*(i._xrSessionManager.scene.useRightHandedSystem?-1:1);q.FromEulerAngles(0,d,0).multiplyToRef(i._options.xrInput.xrCamera.rotationQuaternion,i._options.xrInput.xrCamera.rotationQuaternion)}}else a.teleportationState.rotating=!1;u.x===0&&u.y===0&&a.teleportationState.forward&&i._teleportForward(o.uniqueId)})}};o.motionController?s():o.onMotionControllerInitObservable.addOnce(function(){s()})}else i._xrSessionManager.scene.onPointerObservable.add(function(c){if(c.type===Te.POINTERDOWN){a.teleportationState.forward=!0,i._currentTeleportationControllerId=a.xrController.uniqueId,a.teleportationState.baseRotation=i._options.xrInput.xrCamera.rotationQuaternion.toEulerAngles().y,a.teleportationState.currentRotation=0;var l=i._options.timeToTeleport||3e3;Bi({timeout:l,contextObservable:i._xrSessionManager.onXRFrameObservable,onEnded:function(){i._currentTeleportationControllerId===a.xrController.uniqueId&&a.teleportationState.forward&&i._teleportForward(o.uniqueId)}})}else c.type===Te.POINTERUP&&(a.teleportationState.forward=!1,i._currentTeleportationControllerId="")})}},i._options.teleportationTargetMesh||i._createDefaultTargetMesh(),i._floorMeshes=i._options.floorMeshes||[],i._snapToPositions=i._options.snapPositions||[],i._setTargetMeshVisibility(!1),i}return Object.defineProperty(n.prototype,"rotationEnabled",{get:function(){return this._rotationEnabled},set:function(e){if(this._rotationEnabled=e,this._options.teleportationTargetMesh){var t=this._options.teleportationTargetMesh.getChildMeshes(!1,function(i){return i.name==="rotationCone"});t[0]&&t[0].setEnabled(e)}},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"teleportationTargetMesh",{get:function(){return this._options.teleportationTargetMesh||null},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"snapPointsOnly",{get:function(){return!!this._options.snapPointsOnly},set:function(e){this._options.snapPointsOnly=e},enumerable:!1,configurable:!0}),n.prototype.addFloorMesh=function(e){this._floorMeshes.push(e)},n.prototype.addBlockerMesh=function(e){this._options.pickBlockerMeshes=this._options.pickBlockerMeshes||[],this._options.pickBlockerMeshes.push(e)},n.prototype.addSnapPoint=function(e){this._snapToPositions.push(e)},n.prototype.attach=function(){var e=this;return r.prototype.attach.call(this)?(this._currentTeleportationControllerId="",this._options.xrInput.controllers.forEach(this._attachController),this._addNewAttachObserver(this._options.xrInput.onControllerAddedObservable,this._attachController),this._addNewAttachObserver(this._options.xrInput.onControllerRemovedObservable,function(t){e._detachController(t.uniqueId)}),!0):!1},n.prototype.detach=function(){var e=this;return r.prototype.detach.call(this)?(Object.keys(this._controllers).forEach(function(t){e._detachController(t)}),this._setTargetMeshVisibility(!1),this._currentTeleportationControllerId="",this._controllers={},!0):!1},n.prototype.dispose=function(){r.prototype.dispose.call(this),this._options.teleportationTargetMesh&&this._options.teleportationTargetMesh.dispose(!1,!0)},n.prototype.removeFloorMesh=function(e){var t=this._floorMeshes.indexOf(e);t!==-1&&this._floorMeshes.splice(t,1)},n.prototype.removeBlockerMesh=function(e){this._options.pickBlockerMeshes=this._options.pickBlockerMeshes||[];var t=this._options.pickBlockerMeshes.indexOf(e);t!==-1&&this._options.pickBlockerMeshes.splice(t,1)},n.prototype.removeFloorMeshByName=function(e){var t=this._xrSessionManager.scene.getMeshByName(e);t&&this.removeFloorMesh(t)},n.prototype.removeSnapPoint=function(e){var t=this._snapToPositions.indexOf(e);if(t===-1){for(var i=0;i<this._snapToPositions.length;++i)if(this._snapToPositions[i].equals(e)){t=i;break}}return t!==-1?(this._snapToPositions.splice(t,1),!0):!1},n.prototype.setSelectionFeature=function(e){this._selectionFeature=e},n.prototype._onXRFrame=function(e){var t=this,i=this._xrSessionManager.currentFrame,o=this._xrSessionManager.scene;if(!(!this.attach||!i)){var a=this._options.teleportationTargetMesh;if(this._currentTeleportationControllerId){if(!a)return;a.rotationQuaternion=a.rotationQuaternion||new q;var s=this._controllers[this._currentTeleportationControllerId];if(s&&s.teleportationState.forward){q.RotationYawPitchRollToRef(s.teleportationState.currentRotation+s.teleportationState.baseRotation,0,0,a.rotationQuaternion);var c=!1;if(s.xrController.getWorldPointerRayToRef(this._tmpRay),this.straightRayEnabled){var l=o.pickWithRay(this._tmpRay,function(p){if(t._options.pickBlockerMeshes&&t._options.pickBlockerMeshes.indexOf(p)!==-1)return!0;var m=t._floorMeshes.indexOf(p);return m===-1?!1:t._floorMeshes[m].absolutePosition.y<t._options.xrInput.xrCamera.globalPosition.y});if(l&&l.pickedMesh&&this._options.pickBlockerMeshes&&this._options.pickBlockerMeshes.indexOf(l.pickedMesh)!==-1)return;l&&l.pickedPoint&&(c=!0,this._setTargetMeshPosition(l),this._setTargetMeshVisibility(!0),this._showParabolicPath(l))}if(this.parabolicRayEnabled&&!c){var u=s.xrController.pointer.rotationQuaternion.toEulerAngles().x,f=1+(Math.PI/2-Math.abs(u)),d=this.parabolicCheckRadius*f;this._tmpRay.origin.addToRef(this._tmpRay.direction.scale(d*2),this._tmpVector),this._tmpVector.y=this._tmpRay.origin.y,this._tmpRay.origin.addInPlace(this._tmpRay.direction.scale(d)),this._tmpVector.subtractToRef(this._tmpRay.origin,this._tmpRay.direction),this._tmpRay.direction.normalize();var l=o.pickWithRay(this._tmpRay,function(m){return t._options.pickBlockerMeshes&&t._options.pickBlockerMeshes.indexOf(m)!==-1?!0:t._floorMeshes.indexOf(m)!==-1});if(l&&l.pickedMesh&&this._options.pickBlockerMeshes&&this._options.pickBlockerMeshes.indexOf(l.pickedMesh)!==-1)return;l&&l.pickedPoint&&(c=!0,this._setTargetMeshPosition(l),this._setTargetMeshVisibility(!0),this._showParabolicPath(l))}this._setTargetMeshVisibility(c)}else this._setTargetMeshVisibility(!1)}else this._setTargetMeshVisibility(!1)}},n.prototype._createDefaultTargetMesh=function(){this._options.defaultTargetMeshOptions=this._options.defaultTargetMeshOptions||{};var e=this._options.useUtilityLayer?this._options.customUtilityLayerScene||dt.DefaultUtilityLayer.utilityLayerScene:this._xrSessionManager.scene,t=ao("teleportationTarget",{width:2,height:2,subdivisions:2},e);t.isPickable=!1;var i=512,o=new ca("teleportationPlaneDynamicTexture",i,e,!0);o.hasAlpha=!0;var a=o.getContext(),s=i/2,c=i/2,l=200;a.beginPath(),a.arc(s,c,l,0,2*Math.PI,!1),a.fillStyle=this._options.defaultTargetMeshOptions.teleportationFillColor||"#444444",a.fill(),a.lineWidth=10,a.strokeStyle=this._options.defaultTargetMeshOptions.teleportationBorderColor||"#FFFFFF",a.stroke(),a.closePath(),o.update();var u=new Ze("teleportationPlaneMaterial",e);u.diffuseTexture=o,t.material=u;var f=xn("torusTeleportation",{diameter:.75,thickness:.1,tessellation:20},e);if(f.isPickable=!1,f.parent=t,!this._options.defaultTargetMeshOptions.disableAnimation){var d=new J("animationInnerCircle","position.y",30,J.ANIMATIONTYPE_FLOAT,J.ANIMATIONLOOPMODE_CYCLE),p=[];p.push({frame:0,value:0}),p.push({frame:30,value:.4}),p.push({frame:60,value:0}),d.setKeys(p);var m=new so;m.setEasingMode(nr.EASINGMODE_EASEINOUT),d.setEasingFunction(m),f.animations=[],f.animations.push(d),e.beginAnimation(f,0,60,!0)}var _=$i("rotationCone",{diameterTop:0,tessellation:4},e);if(_.isPickable=!1,_.scaling.set(.5,.12,.2),_.rotate(cn.X,Math.PI/2),_.position.z=.6,_.parent=f,this._options.defaultTargetMeshOptions.torusArrowMaterial)f.material=this._options.defaultTargetMeshOptions.torusArrowMaterial,_.material=this._options.defaultTargetMeshOptions.torusArrowMaterial;else{var v=new Ze("torusConsMat",e);v.disableLighting=!!this._options.defaultTargetMeshOptions.disableLighting,v.disableLighting?v.emissiveColor=new G(.3,.3,1):v.diffuseColor=new G(.3,.3,1),v.alpha=.9,f.material=v,_.material=v,this._teleportationRingMaterial=v}this._options.renderingGroupId!==void 0&&(t.renderingGroupId=this._options.renderingGroupId,f.renderingGroupId=this._options.renderingGroupId,_.renderingGroupId=this._options.renderingGroupId),this._options.teleportationTargetMesh=t},n.prototype._detachController=function(e){var t=this._controllers[e];!t||(t.teleportationComponent&&(t.onAxisChangedObserver&&t.teleportationComponent.onAxisValueChangedObservable.remove(t.onAxisChangedObserver),t.onButtonChangedObserver&&t.teleportationComponent.onButtonStateChangedObservable.remove(t.onButtonChangedObserver)),delete this._controllers[e])},n.prototype._findClosestSnapPointWithRadius=function(e,t){t===void 0&&(t=this._options.snapToPositionRadius||.8);var i=null,o=Number.MAX_VALUE;if(this._snapToPositions.length){var a=t*t;this._snapToPositions.forEach(function(s){var c=y.DistanceSquared(s,e);c<=a&&c<o&&(o=c,i=s)})}return i},n.prototype._setTargetMeshPosition=function(e){var t=e.pickedPoint;if(!(!this._options.teleportationTargetMesh||!t)){var i=this._findClosestSnapPointWithRadius(t);this._snappedToPoint=!!i,this.snapPointsOnly&&!this._snappedToPoint&&this._teleportationRingMaterial?this._teleportationRingMaterial.diffuseColor.set(1,.3,.3):this.snapPointsOnly&&this._snappedToPoint&&this._teleportationRingMaterial&&this._teleportationRingMaterial.diffuseColor.set(.3,.3,1),this._options.teleportationTargetMesh.position.copyFrom(i||t),this._options.teleportationTargetMesh.position.y+=.01,this.onTargetMeshPositionUpdatedObservable.notifyObservers(e)}},n.prototype._setTargetMeshVisibility=function(e){!this._options.teleportationTargetMesh||this._options.teleportationTargetMesh.isVisible!==e&&(this._options.teleportationTargetMesh.isVisible=e,this._options.teleportationTargetMesh.getChildren(void 0,!1).forEach(function(t){t.isVisible=e}),e?this._selectionFeature&&this._selectionFeature.detach():(this._quadraticBezierCurve&&(this._quadraticBezierCurve.dispose(),this._quadraticBezierCurve=null),this._selectionFeature&&this._selectionFeature.attach()))},n.prototype._showParabolicPath=function(e){if(!!e.pickedPoint){var t=this._options.useUtilityLayer?this._options.customUtilityLayerScene||dt.DefaultUtilityLayer.utilityLayerScene:this._xrSessionManager.scene,i=this._controllers[this._currentTeleportationControllerId],o=co.CreateQuadraticBezier(i.xrController.pointer.absolutePosition,e.ray.origin,e.pickedPoint,25);this._options.generateRayPathMesh?this._quadraticBezierCurve=this._options.generateRayPathMesh(o.getPoints(),e):this._quadraticBezierCurve=lo("teleportation path line",{points:o.getPoints(),instance:this._quadraticBezierCurve,updatable:!0},t),this._quadraticBezierCurve.isPickable=!1,this._options.renderingGroupId!==void 0&&(this._quadraticBezierCurve.renderingGroupId=this._options.renderingGroupId)}},n.prototype._teleportForward=function(e){var t=this._controllers[e];if(!(!t||!t.teleportationState.forward||!this.teleportationEnabled)&&(t.teleportationState.forward=!1,this._currentTeleportationControllerId="",!(this.snapPointsOnly&&!this._snappedToPoint))){if(this.skipNextTeleportation){this.skipNextTeleportation=!1;return}if(this._options.teleportationTargetMesh&&this._options.teleportationTargetMesh.isVisible){var i=this._options.xrInput.xrCamera.realWorldHeight;this._options.xrInput.xrCamera.onBeforeCameraTeleport.notifyObservers(this._options.xrInput.xrCamera.position),this._options.xrInput.xrCamera.position.copyFrom(this._options.teleportationTargetMesh.position),this._options.xrInput.xrCamera.position.y+=i,q.FromEulerAngles(0,t.teleportationState.currentRotation-(this._xrSessionManager.scene.useRightHandedSystem?Math.PI:0),0).multiplyToRef(this._options.xrInput.xrCamera.rotationQuaternion,this._options.xrInput.xrCamera.rotationQuaternion),this._options.xrInput.xrCamera.onAfterCameraTeleport.notifyObservers(this._options.xrInput.xrCamera.position)}}},n.Name=$e.TELEPORTATION,n.Version=1,n}(Ci);un.AddWebXRFeature(nn.Name,function(r,n){return function(){return new nn(r,n)}},nn.Version,!0);var la=function(){function r(){}return r.CreateAsync=function(n,e){e===void 0&&(e={});var t=new r;if(n.onDisposeObservable.addOnce(function(){t.dispose()}),!e.disableDefaultUI){var i=Oe({renderTarget:t.renderTarget},e.uiOptions||{});e.optionalFeatures&&(typeof e.optionalFeatures=="boolean"?i.optionalFeatures=["hit-test","anchors","plane-detection","hand-tracking"]:i.optionalFeatures=e.optionalFeatures),t.enterExitUI=new sa(n,i)}return Qo.CreateAsync(n).then(function(o){if(t.baseExperience=o,e.ignoreNativeCameraTransformation&&(t.baseExperience.camera.compensateOnFirstFrame=!1),t.input=new ea(o.sessionManager,o.camera,Oe({controllerOptions:{renderingGroupId:e.renderingGroupId}},e.inputOptions||{})),!e.disablePointerSelection){var a=Oe(Oe({},e.pointerSelectionOptions),{xrInput:t.input,renderingGroupId:e.renderingGroupId});t.pointerSelection=t.baseExperience.featuresManager.enableFeature(Jt.Name,e.useStablePlugins?"stable":"latest",a),e.disableTeleportation||(t.teleportation=t.baseExperience.featuresManager.enableFeature(nn.Name,e.useStablePlugins?"stable":"latest",{floorMeshes:e.floorMeshes,xrInput:t.input,renderingGroupId:e.renderingGroupId}),t.teleportation.setSelectionFeature(t.pointerSelection))}if(e.disableNearInteraction||(t.nearInteraction=t.baseExperience.featuresManager.enableFeature(tn.Name,e.useStablePlugins?"stable":"latest",{xrInput:t.input,farInteractionFeature:t.pointerSelection,renderingGroupId:e.renderingGroupId,useUtilityLayer:!0,enableNearInteractionOnAllControllers:!0})),t.renderTarget=t.baseExperience.sessionManager.getWebXRRenderTarget(e.outputCanvasOptions),!e.disableDefaultUI)return t.enterExitUI.setHelperAsync(t.baseExperience,t.renderTarget)}).then(function(){return t}).catch(function(o){return ne.Error("Error initializing XR"),ne.Error(o),t})},r.prototype.dispose=function(){this.baseExperience&&this.baseExperience.dispose(),this.input&&this.input.dispose(),this.enterExitUI&&this.enterExitUI.dispose(),this.renderTarget&&this.renderTarget.dispose()},r}(),ua=function(r){R(n,r);function n(){return r!==null&&r.apply(this,arguments)||this}return n}(ir),fa=function(){function r(){this.rootNodes=[],this.skeletons=[],this.animationGroups=[]}return r}(),ha=function(r){R(n,r);function n(e){var t=r.call(this)||this;return t._wasAddedToScene=!1,e=e||Me.LastCreatedScene,e&&(t.scene=e,t.sounds=[],t.effectLayers=[],t.layers=[],t.lensFlareSystems=[],t.proceduralTextures=[],t.reflectionProbes=[],e.onDisposeObservable.add(function(){t._wasAddedToScene||t.dispose()}),t._onContextRestoredObserver=e.getEngine().onContextRestoredObservable.add(function(){for(var i=0,o=t.geometries;i<o.length;i++){var a=o[i];a._rebuild()}for(var s=0,c=t.meshes;s<c.length;s++){var l=c[s];l._rebuild()}for(var u=0,f=t.particleSystems;u<f.length;u++){var d=f[u];d.rebuild()}for(var p=0,m=t.textures;p<m.length;p++){var _=m[p];_._rebuild()}})),t}return n.prototype.instantiateModelsToScene=function(e,t,i){var o=this;t===void 0&&(t=!1);var a={},s={},c=new fa,l=[],u=[];i||(i={doNotInstantiate:!0});var f=function(d,p){if(a[d.uniqueId]=p.uniqueId,s[p.uniqueId]=p,e&&(p.name=e(d.name)),p instanceof he){var m=p;if(m.morphTargetManager){var _=d.morphTargetManager;m.morphTargetManager=_.clone();for(var v=0;v<_.numTargets;v++){var b=_.getTarget(v),A=m.morphTargetManager.getTarget(v);a[b.uniqueId]=A.uniqueId,s[A.uniqueId]=A}}}};return this.transformNodes.forEach(function(d){if(!d.parent){var p=d.instantiateHierarchy(null,i,function(m,_){f(m,_)});p&&c.rootNodes.push(p)}}),this.meshes.forEach(function(d){if(!d.parent){var p=d.instantiateHierarchy(null,i,function(m,_){if(f(m,_),_.material){var v=_;if(v.material)if(t){var b=m.material;if(u.indexOf(b)===-1){var A=b.clone(e?e(b.name):"Clone of "+b.name);if(u.push(b),a[b.uniqueId]=A.uniqueId,s[A.uniqueId]=A,b.getClassName()==="MultiMaterial"){for(var S=b,C=0,O=S.subMaterials;C<O.length;C++){var B=O[C];!B||(A=B.clone(e?e(B.name):"Clone of "+B.name),u.push(B),a[B.uniqueId]=A.uniqueId,s[A.uniqueId]=A)}S.subMaterials=S.subMaterials.map(function(k){return k&&s[a[k.uniqueId]]})}}v.getClassName()!=="InstancedMesh"&&(v.material=s[a[b.uniqueId]])}else v.material.getClassName()==="MultiMaterial"?o.scene.multiMaterials.indexOf(v.material)===-1&&o.scene.addMultiMaterial(v.material):o.scene.materials.indexOf(v.material)===-1&&o.scene.addMaterial(v.material)}});p&&c.rootNodes.push(p)}}),this.skeletons.forEach(function(d){for(var p=d.clone(e?e(d.name):"Clone of "+d.name),m=0,_=o.meshes;m<_.length;m++){var v=_[m];if(v.skeleton===d&&!v.isAnInstance){var b=s[a[v.uniqueId]];if(b.isAnInstance||(b.skeleton=p,l.indexOf(p)!==-1))continue;l.push(p);for(var A=0,S=p.bones;A<S.length;A++){var C=S[A];C._linkedTransformNode&&(C._linkedTransformNode=s[a[C._linkedTransformNode.uniqueId]])}}}c.skeletons.push(p)}),this.animationGroups.forEach(function(d){var p=d.clone(e?e(d.name):"Clone of "+d.name,function(m){var _=s[a[m.uniqueId]];return _||m});c.animationGroups.push(p)}),c},n.prototype.addAllToScene=function(){var e=this;if(!this._wasAddedToScene){this._wasAddedToScene=!0,this.cameras.forEach(function(a){e.scene.addCamera(a)}),this.lights.forEach(function(a){e.scene.addLight(a)}),this.meshes.forEach(function(a){e.scene.addMesh(a)}),this.skeletons.forEach(function(a){e.scene.addSkeleton(a)}),this.animations.forEach(function(a){e.scene.addAnimation(a)}),this.animationGroups.forEach(function(a){e.scene.addAnimationGroup(a)}),this.multiMaterials.forEach(function(a){e.scene.addMultiMaterial(a)}),this.materials.forEach(function(a){e.scene.addMaterial(a)}),this.morphTargetManagers.forEach(function(a){e.scene.addMorphTargetManager(a)}),this.geometries.forEach(function(a){e.scene.addGeometry(a)}),this.transformNodes.forEach(function(a){e.scene.addTransformNode(a)}),this.actionManagers.forEach(function(a){e.scene.addActionManager(a)}),this.textures.forEach(function(a){e.scene.addTexture(a)}),this.reflectionProbes.forEach(function(a){e.scene.addReflectionProbe(a)}),this.environmentTexture&&(this.scene.environmentTexture=this.environmentTexture);for(var t=0,i=this.scene._serializableComponents;t<i.length;t++){var o=i[t];o.addFromContainer(this)}this.scene.getEngine().onContextRestoredObservable.remove(this._onContextRestoredObserver),this._onContextRestoredObserver=null}},n.prototype.removeAllFromScene=function(){var e=this;this._wasAddedToScene=!1,this.cameras.forEach(function(a){e.scene.removeCamera(a)}),this.lights.forEach(function(a){e.scene.removeLight(a)}),this.meshes.forEach(function(a){e.scene.removeMesh(a)}),this.skeletons.forEach(function(a){e.scene.removeSkeleton(a)}),this.animations.forEach(function(a){e.scene.removeAnimation(a)}),this.animationGroups.forEach(function(a){e.scene.removeAnimationGroup(a)}),this.multiMaterials.forEach(function(a){e.scene.removeMultiMaterial(a)}),this.materials.forEach(function(a){e.scene.removeMaterial(a)}),this.morphTargetManagers.forEach(function(a){e.scene.removeMorphTargetManager(a)}),this.geometries.forEach(function(a){e.scene.removeGeometry(a)}),this.transformNodes.forEach(function(a){e.scene.removeTransformNode(a)}),this.actionManagers.forEach(function(a){e.scene.removeActionManager(a)}),this.textures.forEach(function(a){e.scene.removeTexture(a)}),this.reflectionProbes.forEach(function(a){e.scene.removeReflectionProbe(a)}),this.environmentTexture===this.scene.environmentTexture&&(this.scene.environmentTexture=null);for(var t=0,i=this.scene._serializableComponents;t<i.length;t++){var o=i[t];o.removeFromContainer(this)}},n.prototype.dispose=function(){this.cameras.slice(0).forEach(function(o){o.dispose()}),this.cameras=[],this.lights.slice(0).forEach(function(o){o.dispose()}),this.lights=[],this.meshes.slice(0).forEach(function(o){o.dispose()}),this.meshes=[],this.skeletons.slice(0).forEach(function(o){o.dispose()}),this.skeletons=[],this.animationGroups.slice(0).forEach(function(o){o.dispose()}),this.animationGroups=[],this.multiMaterials.slice(0).forEach(function(o){o.dispose()}),this.multiMaterials=[],this.materials.slice(0).forEach(function(o){o.dispose()}),this.materials=[],this.geometries.slice(0).forEach(function(o){o.dispose()}),this.geometries=[],this.transformNodes.slice(0).forEach(function(o){o.dispose()}),this.transformNodes=[],this.actionManagers.slice(0).forEach(function(o){o.dispose()}),this.actionManagers=[],this.textures.slice(0).forEach(function(o){o.dispose()}),this.textures=[],this.reflectionProbes.slice(0).forEach(function(o){o.dispose()}),this.reflectionProbes=[],this.environmentTexture&&(this.environmentTexture.dispose(),this.environmentTexture=null);for(var e=0,t=this.scene._serializableComponents;e<t.length;e++){var i=t[e];i.removeFromContainer(this,!0)}this._onContextRestoredObserver&&(this.scene.getEngine().onContextRestoredObservable.remove(this._onContextRestoredObserver),this._onContextRestoredObserver=null)},n.prototype._moveAssets=function(e,t,i){if(!!e)for(var o=0,a=e;o<a.length;o++){var s=a[o],c=!0;if(i)for(var l=0,u=i;l<u.length;l++){var f=u[l];if(s===f){c=!1;break}}c&&(t.push(s),s._parentContainer=this)}},n.prototype.moveAllFromScene=function(e){this._wasAddedToScene=!1,e===void 0&&(e=new ua);for(var t in this)Object.prototype.hasOwnProperty.call(this,t)&&(this[t]=this[t]||(t==="environmentTexture"?null:[]),this._moveAssets(this.scene[t],this[t],e[t]));this.environmentTexture=this.scene.environmentTexture,this.removeAllFromScene()},n.prototype.createRootMesh=function(){var e=new he("assetContainerRootMesh",this.scene);return this.meshes.forEach(function(t){t.parent||e.addChild(t)}),this.meshes.unshift(e),e},n.prototype.mergeAnimationsTo=function(e,t,i){if(e===void 0&&(e=Me.LastCreatedScene),i===void 0&&(i=null),!e)return ne.Error("No scene available to merge animations to"),[];var o=i||function(c){var l=null,u=c.animations.length?c.animations[0].targetProperty:"",f=c.name.split(".").join("").split("_primitive")[0];switch(u){case"position":case"rotationQuaternion":l=e.getTransformNodeByName(c.name)||e.getTransformNodeByName(f);break;case"influence":l=e.getMorphTargetByName(c.name)||e.getMorphTargetByName(f);break;default:l=e.getNodeByName(c.name)||e.getNodeByName(f)}return l},a=this.getNodes();a.forEach(function(c){var l=o(c);if(l!==null){for(var u=function(m){for(var _=l.animations.filter(function(C){return C.targetProperty===m.targetProperty}),v=0,b=_;v<b.length;v++){var A=b[v],S=l.animations.indexOf(A,0);S>-1&&l.animations.splice(S,1)}},f=0,d=c.animations;f<d.length;f++){var p=d[f];u(p)}l.animations=l.animations.concat(c.animations)}});var s=new Array;return this.animationGroups.slice().forEach(function(c){s.push(c.clone(c.name,o)),c.animatables.forEach(function(l){l.stop()})}),t.forEach(function(c){var l=o(c.target);l&&(e.beginAnimation(l,c.fromFrame,c.toFrame,c.loopAnimation,c.speedRatio,c.onAnimationEnd?c.onAnimationEnd:void 0,void 0,!0,void 0,c.onAnimationLoop?c.onAnimationLoop:void 0),e.stopAnimation(c.target))}),s},n}(ir);function wn(r,n,e,t){var i={externalResourceFunction:function(o){return t(o).then(function(a){return new Uint8Array(a)})}};return e&&(i.uri=n==="file:"?e:n+e),r instanceof ArrayBuffer?GLTFValidator.validateBytes(new Uint8Array(r),i):GLTFValidator.validateString(r,i)}function da(){var r=[];onmessage=function(n){var e=n.data;switch(e.id){case"init":{importScripts(e.url);break}case"validate":{wn(e.data,e.rootUrl,e.fileName,function(t){return new Promise(function(i,o){var a=r.length;r.push({resolve:i,reject:o}),postMessage({id:"getExternalResource",index:a,uri:t})})}).then(function(t){postMessage({id:"validate.resolve",value:t})},function(t){postMessage({id:"validate.reject",reason:t})});break}case"getExternalResource.resolve":{r[e.index].resolve(e.value);break}case"getExternalResource.reject":{r[e.index].reject(e.reason);break}}}}var pa=function(){function r(){}return r.ValidateAsync=function(n,e,t,i){var o=this;return typeof Worker=="function"?new Promise(function(a,s){var c="".concat(wn,"(").concat(da,")()"),l=URL.createObjectURL(new Blob([c],{type:"application/javascript"})),u=new Worker(l),f=function(p){u.removeEventListener("error",f),u.removeEventListener("message",d),s(p)},d=function(p){var m=p.data;switch(m.id){case"getExternalResource":{i(m.uri).then(function(_){u.postMessage({id:"getExternalResource.resolve",index:m.index,value:_},[_])},function(_){u.postMessage({id:"getExternalResource.reject",index:m.index,reason:_})});break}case"validate.resolve":{u.removeEventListener("error",f),u.removeEventListener("message",d),a(m.value),u.terminate();break}case"validate.reject":u.removeEventListener("error",f),u.removeEventListener("message",d),s(m.reason),u.terminate()}};u.addEventListener("error",f),u.addEventListener("message",d),u.postMessage({id:"init",url:o.Configuration.url}),u.postMessage({id:"validate",data:n,rootUrl:e,fileName:t})}):(this._LoadScriptPromise||(this._LoadScriptPromise=z.LoadScriptAsync(this.Configuration.url)),this._LoadScriptPromise.then(function(){return wn(n,e,t,i)}))},r.Configuration={url:"https://preview.babylonjs.com/gltf_validator.js"},r}();function Gi(r,n,e){try{return Promise.resolve(new Uint8Array(r,n,e))}catch(t){return Promise.reject(t)}}var Gt;(function(r){r[r.AUTO=0]="AUTO",r[r.FORCE_RIGHT_HANDED=1]="FORCE_RIGHT_HANDED"})(Gt||(Gt={}));var Ot;(function(r){r[r.NONE=0]="NONE",r[r.FIRST=1]="FIRST",r[r.ALL=2]="ALL"})(Ot||(Ot={}));var De;(function(r){r[r.LOADING=0]="LOADING",r[r.READY=1]="READY",r[r.COMPLETE=2]="COMPLETE"})(De||(De={}));var et=function(){function r(){this.onParsedObservable=new U,this.coordinateSystemMode=Gt.AUTO,this.animationStartMode=Ot.FIRST,this.compileMaterials=!1,this.useClipPlane=!1,this.compileShadowGenerators=!1,this.transparencyAsCoverage=!1,this.useRangeRequests=!1,this.createInstances=!0,this.alwaysComputeBoundingBox=!1,this.loadAllMaterials=!1,this.loadOnlyMaterials=!1,this.skipMaterials=!1,this.useSRGBBuffers=!0,this.targetFps=60,this.alwaysComputeSkeletonRootNode=!1,this.preprocessUrlAsync=function(n){return Promise.resolve(n)},this.onMeshLoadedObservable=new U,this.onTextureLoadedObservable=new U,this.onMaterialLoadedObservable=new U,this.onCameraLoadedObservable=new U,this.onCompleteObservable=new U,this.onErrorObservable=new U,this.onDisposeObservable=new U,this.onExtensionLoadedObservable=new U,this.validate=!1,this.onValidatedObservable=new U,this._loader=null,this._state=null,this._requests=new Array,this.name="gltf",this.extensions={".gltf":{isBinary:!1},".glb":{isBinary:!0}},this.onLoaderStateChangedObservable=new U,this._logIndentLevel=0,this._loggingEnabled=!1,this._log=this._logDisabled,this._capturePerformanceCounters=!1,this._startPerformanceCounter=this._startPerformanceCounterDisabled,this._endPerformanceCounter=this._endPerformanceCounterDisabled}return Object.defineProperty(r.prototype,"onParsed",{set:function(n){this._onParsedObserver&&this.onParsedObservable.remove(this._onParsedObserver),this._onParsedObserver=this.onParsedObservable.add(n)},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"onMeshLoaded",{set:function(n){this._onMeshLoadedObserver&&this.onMeshLoadedObservable.remove(this._onMeshLoadedObserver),this._onMeshLoadedObserver=this.onMeshLoadedObservable.add(n)},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"onTextureLoaded",{set:function(n){this._onTextureLoadedObserver&&this.onTextureLoadedObservable.remove(this._onTextureLoadedObserver),this._onTextureLoadedObserver=this.onTextureLoadedObservable.add(n)},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"onMaterialLoaded",{set:function(n){this._onMaterialLoadedObserver&&this.onMaterialLoadedObservable.remove(this._onMaterialLoadedObserver),this._onMaterialLoadedObserver=this.onMaterialLoadedObservable.add(n)},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"onCameraLoaded",{set:function(n){this._onCameraLoadedObserver&&this.onCameraLoadedObservable.remove(this._onCameraLoadedObserver),this._onCameraLoadedObserver=this.onCameraLoadedObservable.add(n)},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"onComplete",{set:function(n){this._onCompleteObserver&&this.onCompleteObservable.remove(this._onCompleteObserver),this._onCompleteObserver=this.onCompleteObservable.add(n)},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"onError",{set:function(n){this._onErrorObserver&&this.onErrorObservable.remove(this._onErrorObserver),this._onErrorObserver=this.onErrorObservable.add(n)},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"onDispose",{set:function(n){this._onDisposeObserver&&this.onDisposeObservable.remove(this._onDisposeObserver),this._onDisposeObserver=this.onDisposeObservable.add(n)},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"onExtensionLoaded",{set:function(n){this._onExtensionLoadedObserver&&this.onExtensionLoadedObservable.remove(this._onExtensionLoadedObserver),this._onExtensionLoadedObserver=this.onExtensionLoadedObservable.add(n)},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"loggingEnabled",{get:function(){return this._loggingEnabled},set:function(n){this._loggingEnabled!==n&&(this._loggingEnabled=n,this._loggingEnabled?this._log=this._logEnabled:this._log=this._logDisabled)},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"capturePerformanceCounters",{get:function(){return this._capturePerformanceCounters},set:function(n){this._capturePerformanceCounters!==n&&(this._capturePerformanceCounters=n,this._capturePerformanceCounters?(this._startPerformanceCounter=this._startPerformanceCounterEnabled,this._endPerformanceCounter=this._endPerformanceCounterEnabled):(this._startPerformanceCounter=this._startPerformanceCounterDisabled,this._endPerformanceCounter=this._endPerformanceCounterDisabled))},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"onValidated",{set:function(n){this._onValidatedObserver&&this.onValidatedObservable.remove(this._onValidatedObserver),this._onValidatedObserver=this.onValidatedObservable.add(n)},enumerable:!1,configurable:!0}),r.prototype.dispose=function(){this._loader&&(this._loader.dispose(),this._loader=null);for(var n=0,e=this._requests;n<e.length;n++){var t=e[n];t.abort()}this._requests.length=0,delete this._progressCallback,this.preprocessUrlAsync=function(i){return Promise.resolve(i)},this.onMeshLoadedObservable.clear(),this.onTextureLoadedObservable.clear(),this.onMaterialLoadedObservable.clear(),this.onCameraLoadedObservable.clear(),this.onCompleteObservable.clear(),this.onExtensionLoadedObservable.clear(),this.onDisposeObservable.notifyObservers(void 0),this.onDisposeObservable.clear()},r.prototype.loadFile=function(n,e,t,i,o,a){var s=this;this._progressCallback=i;var c=e.name?"file:":z.GetFolderPath(e),l=e.name||z.GetFilename(e);if(o){if(this.useRangeRequests){this.validate&&ne.Warn("glTF validation is not supported when range requests are enabled");var u={abort:function(){},onCompleteObservable:new U},f={readAsync:function(d,p){return new Promise(function(m,_){s._loadFile(n,e,function(v){m(new Uint8Array(v))},!0,function(v){_(v)},function(v){v.setRequestHeader("Range","bytes=".concat(d,"-").concat(d+p-1))})})},byteLength:0};return this._unpackBinaryAsync(new En(f)).then(function(d){u.onCompleteObservable.notifyObservers(u),t(d)},a?function(d){return a(void 0,d)}:void 0),u}return this._loadFile(n,e,function(d){s._validate(n,d,c,l),s._unpackBinaryAsync(new En({readAsync:function(p,m){return Gi(d,p,m)},byteLength:d.byteLength})).then(function(p){t(p)},a?function(p){return a(void 0,p)}:void 0)},!0,a)}return this._loadFile(n,e,function(d){s._validate(n,d,c,l),t({json:s._parseJson(d)})},o,a)},r.prototype.importMeshAsync=function(n,e,t,i,o,a){var s=this;return Promise.resolve().then(function(){return s.onParsedObservable.notifyObservers(t),s.onParsedObservable.clear(),s._log("Loading ".concat(a||"")),s._loader=s._getLoader(t),s._loader.importMeshAsync(n,e,null,t,i,o,a)})},r.prototype.loadAsync=function(n,e,t,i,o){var a=this;return Promise.resolve().then(function(){return a.onParsedObservable.notifyObservers(e),a.onParsedObservable.clear(),a._log("Loading ".concat(o||"")),a._loader=a._getLoader(e),a._loader.loadAsync(n,e,t,i,o)})},r.prototype.loadAssetContainerAsync=function(n,e,t,i,o){var a=this;return Promise.resolve().then(function(){a.onParsedObservable.notifyObservers(e),a.onParsedObservable.clear(),a._log("Loading ".concat(o||"")),a._loader=a._getLoader(e);var s=new ha(n),c=[];a.onMaterialLoadedObservable.add(function(f){c.push(f)});var l=[];a.onTextureLoadedObservable.add(function(f){l.push(f)});var u=[];return a.onCameraLoadedObservable.add(function(f){u.push(f)}),a._loader.importMeshAsync(null,n,s,e,t,i,o).then(function(f){return Array.prototype.push.apply(s.geometries,f.geometries),Array.prototype.push.apply(s.meshes,f.meshes),Array.prototype.push.apply(s.particleSystems,f.particleSystems),Array.prototype.push.apply(s.skeletons,f.skeletons),Array.prototype.push.apply(s.animationGroups,f.animationGroups),Array.prototype.push.apply(s.materials,c),Array.prototype.push.apply(s.textures,l),Array.prototype.push.apply(s.lights,f.lights),Array.prototype.push.apply(s.transformNodes,f.transformNodes),Array.prototype.push.apply(s.cameras,u),s})})},r.prototype.canDirectLoad=function(n){return n.indexOf("asset")!==-1&&n.indexOf("version")!==-1||Ke.StartsWith(n,"data:base64,"+r._MagicBase64Encoded)||Ke.StartsWith(n,"data:;base64,"+r._MagicBase64Encoded)||Ke.StartsWith(n,"data:application/octet-stream;base64,"+r._MagicBase64Encoded)||Ke.StartsWith(n,"data:model/gltf-binary;base64,"+r._MagicBase64Encoded)},r.prototype.directLoad=function(n,e){if(Ke.StartsWith(e,"base64,"+r._MagicBase64Encoded)||Ke.StartsWith(e,";base64,"+r._MagicBase64Encoded)||Ke.StartsWith(e,"application/octet-stream;base64,"+r._MagicBase64Encoded)||Ke.StartsWith(e,"model/gltf-binary;base64,"+r._MagicBase64Encoded)){var t=rr(e);return this._validate(n,t),this._unpackBinaryAsync(new En({readAsync:function(i,o){return Gi(t,i,o)},byteLength:t.byteLength}))}return this._validate(n,e),Promise.resolve({json:this._parseJson(e)})},r.prototype.createPlugin=function(){return new r},Object.defineProperty(r.prototype,"loaderState",{get:function(){return this._state},enumerable:!1,configurable:!0}),r.prototype.whenCompleteAsync=function(){var n=this;return new Promise(function(e,t){n.onCompleteObservable.addOnce(function(){e()}),n.onErrorObservable.addOnce(function(i){t(i)})})},r.prototype._setState=function(n){this._state!==n&&(this._state=n,this.onLoaderStateChangedObservable.notifyObservers(this._state),this._log(De[this._state]))},r.prototype._loadFile=function(n,e,t,i,o,a){var s=this,c=n._loadFile(e,t,function(l){s._onProgress(l,c)},!0,i,o,a);return c.onCompleteObservable.add(function(l){s._requests.splice(s._requests.indexOf(l),1)}),this._requests.push(c),c},r.prototype._onProgress=function(n,e){if(!!this._progressCallback){e._lengthComputable=n.lengthComputable,e._loaded=n.loaded,e._total=n.total;for(var t=!0,i=0,o=0,a=0,s=this._requests;a<s.length;a++){var c=s[a];if(c._lengthComputable===void 0||c._loaded===void 0||c._total===void 0)return;t=t&&c._lengthComputable,i+=c._loaded,o+=c._total}this._progressCallback({lengthComputable:t,loaded:i,total:t?o:0})}},r.prototype._validate=function(n,e,t,i){var o=this;t===void 0&&(t=""),i===void 0&&(i=""),this.validate&&(this._startPerformanceCounter("Validate JSON"),pa.ValidateAsync(e,t,i,function(a){return o.preprocessUrlAsync(t+a).then(function(s){return n._loadFileAsync(s,void 0,!0,!0)})}).then(function(a){o._endPerformanceCounter("Validate JSON"),o.onValidatedObservable.notifyObservers(a),o.onValidatedObservable.clear()},function(a){o._endPerformanceCounter("Validate JSON"),z.Warn("Failed to validate: ".concat(a.message)),o.onValidatedObservable.clear()}))},r.prototype._getLoader=function(n){var e=n.json.asset||{};this._log("Asset version: ".concat(e.version)),e.minVersion&&this._log("Asset minimum version: ".concat(e.minVersion)),e.generator&&this._log("Asset generator: ".concat(e.generator));var t=r._parseVersion(e.version);if(!t)throw new Error("Invalid version: "+e.version);if(e.minVersion!==void 0){var i=r._parseVersion(e.minVersion);if(!i)throw new Error("Invalid minimum version: "+e.minVersion);if(r._compareVersion(i,{major:2,minor:0})>0)throw new Error("Incompatible minimum version: "+e.minVersion)}var o={1:r._CreateGLTF1Loader,2:r._CreateGLTF2Loader},a=o[t.major];if(!a)throw new Error("Unsupported version: "+e.version);return a(this)},r.prototype._parseJson=function(n){this._startPerformanceCounter("Parse JSON"),this._log("JSON length: ".concat(n.length));var e=JSON.parse(n);return this._endPerformanceCounter("Parse JSON"),e},r.prototype._unpackBinaryAsync=function(n){var e=this;return this._startPerformanceCounter("Unpack Binary"),n.loadAsync(20).then(function(){var t={Magic:1179937895},i=n.readUint32();if(i!==t.Magic)throw new uo("Unexpected magic: "+i,fo.GLTFLoaderUnexpectedMagicError);var o=n.readUint32();e.loggingEnabled&&e._log("Binary version: ".concat(o));var a=n.readUint32();if(n.buffer.byteLength!==0&&a!==n.buffer.byteLength)throw new Error("Length in header does not match actual data length: ".concat(a," != ").concat(n.buffer.byteLength));var s;switch(o){case 1:{s=e._unpackBinaryV1Async(n,a);break}case 2:{s=e._unpackBinaryV2Async(n,a);break}default:throw new Error("Unsupported version: "+o)}return e._endPerformanceCounter("Unpack Binary"),s})},r.prototype._unpackBinaryV1Async=function(n,e){var t={JSON:0},i=n.readUint32(),o=n.readUint32();if(o!==t.JSON)throw new Error("Unexpected content format: ".concat(o));var a=e-n.byteOffset,s={json:this._parseJson(n.readString(i)),bin:null};if(a!==0){var c=n.byteOffset;s.bin={readAsync:function(l,u){return n.buffer.readAsync(c+l,u)},byteLength:a}}return Promise.resolve(s)},r.prototype._unpackBinaryV2Async=function(n,e){var t=this,i={JSON:1313821514,BIN:5130562},o=n.readUint32(),a=n.readUint32();if(a!==i.JSON)throw new Error("First chunk format is not JSON");return n.byteOffset+o===e?n.loadAsync(o).then(function(){return{json:t._parseJson(n.readString(o)),bin:null}}):n.loadAsync(o+8).then(function(){var s={json:t._parseJson(n.readString(o)),bin:null},c=function(){var l=n.readUint32(),u=n.readUint32();switch(u){case i.JSON:throw new Error("Unexpected JSON chunk");case i.BIN:{var f=n.byteOffset;s.bin={readAsync:function(d,p){return n.buffer.readAsync(f+d,p)},byteLength:l},n.skipBytes(l);break}default:{n.skipBytes(l);break}}return n.byteOffset!==e?n.loadAsync(8).then(c):Promise.resolve(s)};return c()})},r._parseVersion=function(n){if(n==="1.0"||n==="1.0.1")return{major:1,minor:0};var e=(n+"").match(/^(\d+)\.(\d+)/);return e?{major:parseInt(e[1]),minor:parseInt(e[2])}:null},r._compareVersion=function(n,e){return n.major>e.major?1:n.major<e.major?-1:n.minor>e.minor?1:n.minor<e.minor?-1:0},r.prototype._logOpen=function(n){this._log(n),this._logIndentLevel++},r.prototype._logClose=function(){--this._logIndentLevel},r.prototype._logEnabled=function(n){var e=r._logSpaces.substr(0,this._logIndentLevel*2);ne.Log("".concat(e).concat(n))},r.prototype._logDisabled=function(n){},r.prototype._startPerformanceCounterEnabled=function(n){z.StartPerformanceCounter(n)},r.prototype._startPerformanceCounterDisabled=function(n){},r.prototype._endPerformanceCounterEnabled=function(n){z.EndPerformanceCounter(n)},r.prototype._endPerformanceCounterDisabled=function(n){},r.IncrementalLoading=!0,r.HomogeneousCoordinates=!1,r._MagicBase64Encoded="Z2xURg",r._logSpaces="                                ",r}();on&&on.RegisterPlugin(new et);var tt;(function(r){r[r.BYTE=5120]="BYTE",r[r.UNSIGNED_BYTE=5121]="UNSIGNED_BYTE",r[r.SHORT=5122]="SHORT",r[r.UNSIGNED_SHORT=5123]="UNSIGNED_SHORT",r[r.FLOAT=5126]="FLOAT"})(tt||(tt={}));var Vn;(function(r){r[r.FRAGMENT=35632]="FRAGMENT",r[r.VERTEX=35633]="VERTEX"})(Vn||(Vn={}));var xe;(function(r){r[r.BYTE=5120]="BYTE",r[r.UNSIGNED_BYTE=5121]="UNSIGNED_BYTE",r[r.SHORT=5122]="SHORT",r[r.UNSIGNED_SHORT=5123]="UNSIGNED_SHORT",r[r.INT=5124]="INT",r[r.UNSIGNED_INT=5125]="UNSIGNED_INT",r[r.FLOAT=5126]="FLOAT",r[r.FLOAT_VEC2=35664]="FLOAT_VEC2",r[r.FLOAT_VEC3=35665]="FLOAT_VEC3",r[r.FLOAT_VEC4=35666]="FLOAT_VEC4",r[r.INT_VEC2=35667]="INT_VEC2",r[r.INT_VEC3=35668]="INT_VEC3",r[r.INT_VEC4=35669]="INT_VEC4",r[r.BOOL=35670]="BOOL",r[r.BOOL_VEC2=35671]="BOOL_VEC2",r[r.BOOL_VEC3=35672]="BOOL_VEC3",r[r.BOOL_VEC4=35673]="BOOL_VEC4",r[r.FLOAT_MAT2=35674]="FLOAT_MAT2",r[r.FLOAT_MAT3=35675]="FLOAT_MAT3",r[r.FLOAT_MAT4=35676]="FLOAT_MAT4",r[r.SAMPLER_2D=35678]="SAMPLER_2D"})(xe||(xe={}));var wt;(function(r){r[r.CLAMP_TO_EDGE=33071]="CLAMP_TO_EDGE",r[r.MIRRORED_REPEAT=33648]="MIRRORED_REPEAT",r[r.REPEAT=10497]="REPEAT"})(wt||(wt={}));var Xe;(function(r){r[r.NEAREST=9728]="NEAREST",r[r.LINEAR=9728]="LINEAR",r[r.NEAREST_MIPMAP_NEAREST=9984]="NEAREST_MIPMAP_NEAREST",r[r.LINEAR_MIPMAP_NEAREST=9985]="LINEAR_MIPMAP_NEAREST",r[r.NEAREST_MIPMAP_LINEAR=9986]="NEAREST_MIPMAP_LINEAR",r[r.LINEAR_MIPMAP_LINEAR=9987]="LINEAR_MIPMAP_LINEAR"})(Xe||(Xe={}));var Hi;(function(r){r[r.ALPHA=6406]="ALPHA",r[r.RGB=6407]="RGB",r[r.RGBA=6408]="RGBA",r[r.LUMINANCE=6409]="LUMINANCE",r[r.LUMINANCE_ALPHA=6410]="LUMINANCE_ALPHA"})(Hi||(Hi={}));var Un;(function(r){r[r.FRONT=1028]="FRONT",r[r.BACK=1029]="BACK",r[r.FRONT_AND_BACK=1032]="FRONT_AND_BACK"})(Un||(Un={}));var fe;(function(r){r[r.ZERO=0]="ZERO",r[r.ONE=1]="ONE",r[r.SRC_COLOR=768]="SRC_COLOR",r[r.ONE_MINUS_SRC_COLOR=769]="ONE_MINUS_SRC_COLOR",r[r.DST_COLOR=774]="DST_COLOR",r[r.ONE_MINUS_DST_COLOR=775]="ONE_MINUS_DST_COLOR",r[r.SRC_ALPHA=770]="SRC_ALPHA",r[r.ONE_MINUS_SRC_ALPHA=771]="ONE_MINUS_SRC_ALPHA",r[r.DST_ALPHA=772]="DST_ALPHA",r[r.ONE_MINUS_DST_ALPHA=773]="ONE_MINUS_DST_ALPHA",r[r.CONSTANT_COLOR=32769]="CONSTANT_COLOR",r[r.ONE_MINUS_CONSTANT_COLOR=32770]="ONE_MINUS_CONSTANT_COLOR",r[r.CONSTANT_ALPHA=32771]="CONSTANT_ALPHA",r[r.ONE_MINUS_CONSTANT_ALPHA=32772]="ONE_MINUS_CONSTANT_ALPHA",r[r.SRC_ALPHA_SATURATE=776]="SRC_ALPHA_SATURATE"})(fe||(fe={}));var Ti=function(r){R(n,r);function n(){var e=r!==null&&r.apply(this,arguments)||this;return e._needProjectionMatrixCompute=!0,e}return n.prototype._setPosition=function(e){this._position=e},Object.defineProperty(n.prototype,"position",{get:function(){return this._position},set:function(e){this._setPosition(e)},enumerable:!1,configurable:!0}),n.prototype._setDirection=function(e){this._direction=e},Object.defineProperty(n.prototype,"direction",{get:function(){return this._direction},set:function(e){this._setDirection(e)},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"shadowMinZ",{get:function(){return this._shadowMinZ},set:function(e){this._shadowMinZ=e,this.forceProjectionMatrixCompute()},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"shadowMaxZ",{get:function(){return this._shadowMaxZ},set:function(e){this._shadowMaxZ=e,this.forceProjectionMatrixCompute()},enumerable:!1,configurable:!0}),n.prototype.computeTransformedInformation=function(){return this.parent&&this.parent.getWorldMatrix?(this.transformedPosition||(this.transformedPosition=y.Zero()),y.TransformCoordinatesToRef(this.position,this.parent.getWorldMatrix(),this.transformedPosition),this.direction&&(this.transformedDirection||(this.transformedDirection=y.Zero()),y.TransformNormalToRef(this.direction,this.parent.getWorldMatrix(),this.transformedDirection)),!0):!1},n.prototype.getDepthScale=function(){return 50},n.prototype.getShadowDirection=function(e){return this.transformedDirection?this.transformedDirection:this.direction},n.prototype.getAbsolutePosition=function(){return this.transformedPosition?this.transformedPosition:this.position},n.prototype.setDirectionToTarget=function(e){return this.direction=y.Normalize(e.subtract(this.position)),this.direction},n.prototype.getRotation=function(){this.direction.normalize();var e=y.Cross(this.direction,cn.Y),t=y.Cross(e,this.direction);return y.RotationFromAxis(e,t,this.direction)},n.prototype.needCube=function(){return!1},n.prototype.needProjectionMatrixCompute=function(){return this._needProjectionMatrixCompute},n.prototype.forceProjectionMatrixCompute=function(){this._needProjectionMatrixCompute=!0},n.prototype._initCache=function(){r.prototype._initCache.call(this),this._cache.position=y.Zero()},n.prototype._isSynchronized=function(){return!!this._cache.position.equals(this.position)},n.prototype.computeWorldMatrix=function(e){return!e&&this.isSynchronized()?(this._currentRenderId=this.getScene().getRenderId(),this._worldMatrix):(this._updateCache(),this._cache.position.copyFrom(this.position),this._worldMatrix||(this._worldMatrix=Q.Identity()),Q.TranslationToRef(this.position.x,this.position.y,this.position.z,this._worldMatrix),this.parent&&this.parent.getWorldMatrix&&(this._worldMatrix.multiplyToRef(this.parent.getWorldMatrix(),this._worldMatrix),this._markSyncedWithParent()),this._worldMatrixDeterminantIsDirty=!0,this._worldMatrix)},n.prototype.getDepthMinZ=function(e){return this.shadowMinZ!==void 0?this.shadowMinZ:e.minZ},n.prototype.getDepthMaxZ=function(e){return this.shadowMaxZ!==void 0?this.shadowMaxZ:e.maxZ},n.prototype.setShadowProjectionMatrix=function(e,t,i){return this.customProjectionMatrixBuilder?this.customProjectionMatrixBuilder(t,i,e):this._setDefaultShadowProjectionMatrix(e,t,i),this},E([rn()],n.prototype,"position",null),E([rn()],n.prototype,"direction",null),E([T()],n.prototype,"shadowMinZ",null),E([T()],n.prototype,"shadowMaxZ",null),n}(jt);Xt.AddNodeConstructor("Light_Type_1",function(r,n){return function(){return new hn(r,y.Zero(),n)}});var hn=function(r){R(n,r);function n(e,t,i){var o=r.call(this,e,i)||this;return o._shadowFrustumSize=0,o._shadowOrthoScale=.1,o.autoUpdateExtends=!0,o.autoCalcShadowZBounds=!1,o._orthoLeft=Number.MAX_VALUE,o._orthoRight=Number.MIN_VALUE,o._orthoTop=Number.MIN_VALUE,o._orthoBottom=Number.MAX_VALUE,o.position=t.scale(-1),o.direction=t,o}return Object.defineProperty(n.prototype,"shadowFrustumSize",{get:function(){return this._shadowFrustumSize},set:function(e){this._shadowFrustumSize=e,this.forceProjectionMatrixCompute()},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"shadowOrthoScale",{get:function(){return this._shadowOrthoScale},set:function(e){this._shadowOrthoScale=e,this.forceProjectionMatrixCompute()},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"orthoLeft",{get:function(){return this._orthoLeft},set:function(e){this._orthoLeft=e},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"orthoRight",{get:function(){return this._orthoRight},set:function(e){this._orthoRight=e},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"orthoTop",{get:function(){return this._orthoTop},set:function(e){this._orthoTop=e},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"orthoBottom",{get:function(){return this._orthoBottom},set:function(e){this._orthoBottom=e},enumerable:!1,configurable:!0}),n.prototype.getClassName=function(){return"DirectionalLight"},n.prototype.getTypeID=function(){return jt.LIGHTTYPEID_DIRECTIONALLIGHT},n.prototype._setDefaultShadowProjectionMatrix=function(e,t,i){this.shadowFrustumSize>0?this._setDefaultFixedFrustumShadowProjectionMatrix(e):this._setDefaultAutoExtendShadowProjectionMatrix(e,t,i)},n.prototype._setDefaultFixedFrustumShadowProjectionMatrix=function(e){var t=this.getScene().activeCamera;!t||Q.OrthoLHToRef(this.shadowFrustumSize,this.shadowFrustumSize,this.shadowMinZ!==void 0?this.shadowMinZ:t.minZ,this.shadowMaxZ!==void 0?this.shadowMaxZ:t.maxZ,e,this.getScene().getEngine().isNDCHalfZRange)},n.prototype._setDefaultAutoExtendShadowProjectionMatrix=function(e,t,i){var o=this.getScene().activeCamera;if(!!o){if(this.autoUpdateExtends||this._orthoLeft===Number.MAX_VALUE){var a=y.Zero();this._orthoLeft=Number.MAX_VALUE,this._orthoRight=Number.MIN_VALUE,this._orthoTop=Number.MIN_VALUE,this._orthoBottom=Number.MAX_VALUE;for(var s=Number.MAX_VALUE,c=Number.MIN_VALUE,l=0;l<i.length;l++){var u=i[l];if(!!u)for(var f=u.getBoundingInfo(),d=f.boundingBox,p=0;p<d.vectorsWorld.length;p++)y.TransformCoordinatesToRef(d.vectorsWorld[p],t,a),a.x<this._orthoLeft&&(this._orthoLeft=a.x),a.y<this._orthoBottom&&(this._orthoBottom=a.y),a.x>this._orthoRight&&(this._orthoRight=a.x),a.y>this._orthoTop&&(this._orthoTop=a.y),this.autoCalcShadowZBounds&&(a.z<s&&(s=a.z),a.z>c&&(c=a.z))}this.autoCalcShadowZBounds&&(this._shadowMinZ=s,this._shadowMaxZ=c)}var m=this._orthoRight-this._orthoLeft,_=this._orthoTop-this._orthoBottom,v=this.shadowMinZ!==void 0?this.shadowMinZ:o.minZ,b=this.shadowMaxZ!==void 0?this.shadowMaxZ:o.maxZ,A=this.getScene().getEngine().useReverseDepthBuffer;Q.OrthoOffCenterLHToRef(this._orthoLeft-m*this.shadowOrthoScale,this._orthoRight+m*this.shadowOrthoScale,this._orthoBottom-_*this.shadowOrthoScale,this._orthoTop+_*this.shadowOrthoScale,A?b:v,A?v:b,e,this.getScene().getEngine().isNDCHalfZRange)}},n.prototype._buildUniformLayout=function(){this._uniformBuffer.addUniform("vLightData",4),this._uniformBuffer.addUniform("vLightDiffuse",4),this._uniformBuffer.addUniform("vLightSpecular",4),this._uniformBuffer.addUniform("shadowsInfo",3),this._uniformBuffer.addUniform("depthValues",2),this._uniformBuffer.create()},n.prototype.transferToEffect=function(e,t){return this.computeTransformedInformation()?(this._uniformBuffer.updateFloat4("vLightData",this.transformedDirection.x,this.transformedDirection.y,this.transformedDirection.z,1,t),this):(this._uniformBuffer.updateFloat4("vLightData",this.direction.x,this.direction.y,this.direction.z,1,t),this)},n.prototype.transferToNodeMaterialEffect=function(e,t){return this.computeTransformedInformation()?(e.setFloat3(t,this.transformedDirection.x,this.transformedDirection.y,this.transformedDirection.z),this):(e.setFloat3(t,this.direction.x,this.direction.y,this.direction.z),this)},n.prototype.getDepthMinZ=function(e){var t=this._scene.getEngine();return!t.useReverseDepthBuffer&&t.isNDCHalfZRange?0:1},n.prototype.getDepthMaxZ=function(e){var t=this._scene.getEngine();return t.useReverseDepthBuffer&&t.isNDCHalfZRange?0:1},n.prototype.prepareLightSpecificDefines=function(e,t){e["DIRLIGHT"+t]=!0},E([T()],n.prototype,"shadowFrustumSize",null),E([T()],n.prototype,"shadowOrthoScale",null),E([T()],n.prototype,"autoUpdateExtends",void 0),E([T()],n.prototype,"autoCalcShadowZBounds",void 0),E([T("orthoLeft")],n.prototype,"_orthoLeft",void 0),E([T("orthoRight")],n.prototype,"_orthoRight",void 0),E([T("orthoTop")],n.prototype,"_orthoTop",void 0),E([T("orthoBottom")],n.prototype,"_orthoBottom",void 0),n}(Ti);Xt.AddNodeConstructor("Light_Type_0",function(r,n){return function(){return new Kt(r,y.Zero(),n)}});var Kt=function(r){R(n,r);function n(e,t,i){var o=r.call(this,e,i)||this;return o._shadowAngle=Math.PI/2,o.position=t,o}return Object.defineProperty(n.prototype,"shadowAngle",{get:function(){return this._shadowAngle},set:function(e){this._shadowAngle=e,this.forceProjectionMatrixCompute()},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"direction",{get:function(){return this._direction},set:function(e){var t=this.needCube();this._direction=e,this.needCube()!==t&&this._shadowGenerator&&this._shadowGenerator.recreateShadowMap()},enumerable:!1,configurable:!0}),n.prototype.getClassName=function(){return"PointLight"},n.prototype.getTypeID=function(){return jt.LIGHTTYPEID_POINTLIGHT},n.prototype.needCube=function(){return!this.direction},n.prototype.getShadowDirection=function(e){if(this.direction)return r.prototype.getShadowDirection.call(this,e);switch(e){case 0:return new y(1,0,0);case 1:return new y(-1,0,0);case 2:return new y(0,-1,0);case 3:return new y(0,1,0);case 4:return new y(0,0,1);case 5:return new y(0,0,-1)}return y.Zero()},n.prototype._setDefaultShadowProjectionMatrix=function(e,t,i){var o=this.getScene().activeCamera;if(!!o){var a=this.shadowMinZ!==void 0?this.shadowMinZ:o.minZ,s=this.shadowMaxZ!==void 0?this.shadowMaxZ:o.maxZ,c=this.getScene().getEngine().useReverseDepthBuffer;Q.PerspectiveFovLHToRef(this.shadowAngle,1,c?s:a,c?a:s,e,!0,this._scene.getEngine().isNDCHalfZRange,void 0,c)}},n.prototype._buildUniformLayout=function(){this._uniformBuffer.addUniform("vLightData",4),this._uniformBuffer.addUniform("vLightDiffuse",4),this._uniformBuffer.addUniform("vLightSpecular",4),this._uniformBuffer.addUniform("vLightFalloff",4),this._uniformBuffer.addUniform("shadowsInfo",3),this._uniformBuffer.addUniform("depthValues",2),this._uniformBuffer.create()},n.prototype.transferToEffect=function(e,t){return this.computeTransformedInformation()?this._uniformBuffer.updateFloat4("vLightData",this.transformedPosition.x,this.transformedPosition.y,this.transformedPosition.z,0,t):this._uniformBuffer.updateFloat4("vLightData",this.position.x,this.position.y,this.position.z,0,t),this._uniformBuffer.updateFloat4("vLightFalloff",this.range,this._inverseSquaredRange,0,0,t),this},n.prototype.transferToNodeMaterialEffect=function(e,t){return this.computeTransformedInformation()?e.setFloat3(t,this.transformedPosition.x,this.transformedPosition.y,this.transformedPosition.z):e.setFloat3(t,this.position.x,this.position.y,this.position.z),this},n.prototype.prepareLightSpecificDefines=function(e,t){e["POINTLIGHT"+t]=!0},E([T()],n.prototype,"shadowAngle",null),n}(Ti);Xt.AddNodeConstructor("Light_Type_2",function(r,n){return function(){return new dn(r,y.Zero(),y.Zero(),0,0,n)}});var dn=function(r){R(n,r);function n(e,t,i,o,a,s){var c=r.call(this,e,s)||this;return c._innerAngle=0,c._projectionTextureMatrix=Q.Zero(),c._projectionTextureLightNear=1e-6,c._projectionTextureLightFar=1e3,c._projectionTextureUpDirection=y.Up(),c._projectionTextureViewLightDirty=!0,c._projectionTextureProjectionLightDirty=!0,c._projectionTextureDirty=!0,c._projectionTextureViewTargetVector=y.Zero(),c._projectionTextureViewLightMatrix=Q.Zero(),c._projectionTextureProjectionLightMatrix=Q.Zero(),c._projectionTextureScalingMatrix=Q.FromValues(.5,0,0,0,0,.5,0,0,0,0,.5,0,.5,.5,.5,1),c.position=t,c.direction=i,c.angle=o,c.exponent=a,c}return Object.defineProperty(n.prototype,"angle",{get:function(){return this._angle},set:function(e){this._angle=e,this._cosHalfAngle=Math.cos(e*.5),this._projectionTextureProjectionLightDirty=!0,this.forceProjectionMatrixCompute(),this._computeAngleValues()},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"innerAngle",{get:function(){return this._innerAngle},set:function(e){this._innerAngle=e,this._computeAngleValues()},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"shadowAngleScale",{get:function(){return this._shadowAngleScale},set:function(e){this._shadowAngleScale=e,this.forceProjectionMatrixCompute()},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"projectionTextureMatrix",{get:function(){return this._projectionTextureMatrix},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"projectionTextureLightNear",{get:function(){return this._projectionTextureLightNear},set:function(e){this._projectionTextureLightNear=e,this._projectionTextureProjectionLightDirty=!0},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"projectionTextureLightFar",{get:function(){return this._projectionTextureLightFar},set:function(e){this._projectionTextureLightFar=e,this._projectionTextureProjectionLightDirty=!0},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"projectionTextureUpDirection",{get:function(){return this._projectionTextureUpDirection},set:function(e){this._projectionTextureUpDirection=e,this._projectionTextureProjectionLightDirty=!0},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"projectionTexture",{get:function(){return this._projectionTexture},set:function(e){var t=this;this._projectionTexture!==e&&(this._projectionTexture=e,this._projectionTextureDirty=!0,this._projectionTexture&&!this._projectionTexture.isReady()&&(n._IsProceduralTexture(this._projectionTexture)?this._projectionTexture.getEffect().executeWhenCompiled(function(){t._markMeshesAsLightDirty()}):n._IsTexture(this._projectionTexture)&&this._projectionTexture.onLoadObservable.addOnce(function(){t._markMeshesAsLightDirty()})))},enumerable:!1,configurable:!0}),n._IsProceduralTexture=function(e){return e.onGeneratedObservable!==void 0},n._IsTexture=function(e){return e.onLoadObservable!==void 0},Object.defineProperty(n.prototype,"projectionTextureProjectionLightMatrix",{get:function(){return this._projectionTextureProjectionLightMatrix},set:function(e){this._projectionTextureProjectionLightMatrix=e,this._projectionTextureProjectionLightDirty=!1,this._projectionTextureDirty=!0},enumerable:!1,configurable:!0}),n.prototype.getClassName=function(){return"SpotLight"},n.prototype.getTypeID=function(){return jt.LIGHTTYPEID_SPOTLIGHT},n.prototype._setDirection=function(e){r.prototype._setDirection.call(this,e),this._projectionTextureViewLightDirty=!0},n.prototype._setPosition=function(e){r.prototype._setPosition.call(this,e),this._projectionTextureViewLightDirty=!0},n.prototype._setDefaultShadowProjectionMatrix=function(e,t,i){var o=this.getScene().activeCamera;if(!!o){this._shadowAngleScale=this._shadowAngleScale||1;var a=this._shadowAngleScale*this._angle,s=this.shadowMinZ!==void 0?this.shadowMinZ:o.minZ,c=this.shadowMaxZ!==void 0?this.shadowMaxZ:o.maxZ,l=this.getScene().getEngine().useReverseDepthBuffer;Q.PerspectiveFovLHToRef(a,1,l?c:s,l?s:c,e,!0,this._scene.getEngine().isNDCHalfZRange,void 0,l)}},n.prototype._computeProjectionTextureViewLightMatrix=function(){this._projectionTextureViewLightDirty=!1,this._projectionTextureDirty=!0,this.position.addToRef(this.direction,this._projectionTextureViewTargetVector),Q.LookAtLHToRef(this.position,this._projectionTextureViewTargetVector,this._projectionTextureUpDirection,this._projectionTextureViewLightMatrix)},n.prototype._computeProjectionTextureProjectionLightMatrix=function(){this._projectionTextureProjectionLightDirty=!1,this._projectionTextureDirty=!0;var e=this.projectionTextureLightFar,t=this.projectionTextureLightNear,i=e/(e-t),o=-i*t,a=1/Math.tan(this._angle/2),s=1;Q.FromValuesToRef(a/s,0,0,0,0,a,0,0,0,0,i,1,0,0,o,0,this._projectionTextureProjectionLightMatrix)},n.prototype._computeProjectionTextureMatrix=function(){if(this._projectionTextureDirty=!1,this._projectionTextureViewLightMatrix.multiplyToRef(this._projectionTextureProjectionLightMatrix,this._projectionTextureMatrix),this._projectionTexture instanceof X){var e=this._projectionTexture.uScale/2,t=this._projectionTexture.vScale/2;Q.FromValuesToRef(e,0,0,0,0,t,0,0,0,0,.5,0,.5,.5,.5,1,this._projectionTextureScalingMatrix)}this._projectionTextureMatrix.multiplyToRef(this._projectionTextureScalingMatrix,this._projectionTextureMatrix)},n.prototype._buildUniformLayout=function(){this._uniformBuffer.addUniform("vLightData",4),this._uniformBuffer.addUniform("vLightDiffuse",4),this._uniformBuffer.addUniform("vLightSpecular",4),this._uniformBuffer.addUniform("vLightDirection",3),this._uniformBuffer.addUniform("vLightFalloff",4),this._uniformBuffer.addUniform("shadowsInfo",3),this._uniformBuffer.addUniform("depthValues",2),this._uniformBuffer.create()},n.prototype._computeAngleValues=function(){this._lightAngleScale=1/Math.max(.001,Math.cos(this._innerAngle*.5)-this._cosHalfAngle),this._lightAngleOffset=-this._cosHalfAngle*this._lightAngleScale},n.prototype.transferTexturesToEffect=function(e,t){return this.projectionTexture&&this.projectionTexture.isReady()&&(this._projectionTextureViewLightDirty&&this._computeProjectionTextureViewLightMatrix(),this._projectionTextureProjectionLightDirty&&this._computeProjectionTextureProjectionLightMatrix(),this._projectionTextureDirty&&this._computeProjectionTextureMatrix(),e.setMatrix("textureProjectionMatrix"+t,this._projectionTextureMatrix),e.setTexture("projectionLightSampler"+t,this.projectionTexture)),this},n.prototype.transferToEffect=function(e,t){var i;return this.computeTransformedInformation()?(this._uniformBuffer.updateFloat4("vLightData",this.transformedPosition.x,this.transformedPosition.y,this.transformedPosition.z,this.exponent,t),i=y.Normalize(this.transformedDirection)):(this._uniformBuffer.updateFloat4("vLightData",this.position.x,this.position.y,this.position.z,this.exponent,t),i=y.Normalize(this.direction)),this._uniformBuffer.updateFloat4("vLightDirection",i.x,i.y,i.z,this._cosHalfAngle,t),this._uniformBuffer.updateFloat4("vLightFalloff",this.range,this._inverseSquaredRange,this._lightAngleScale,this._lightAngleOffset,t),this},n.prototype.transferToNodeMaterialEffect=function(e,t){var i;return this.computeTransformedInformation()?i=y.Normalize(this.transformedDirection):i=y.Normalize(this.direction),this.getScene().useRightHandedSystem?e.setFloat3(t,-i.x,-i.y,-i.z):e.setFloat3(t,i.x,i.y,i.z),this},n.prototype.dispose=function(){r.prototype.dispose.call(this),this._projectionTexture&&this._projectionTexture.dispose()},n.prototype.getDepthMinZ=function(e){var t=this._scene.getEngine(),i=this.shadowMinZ!==void 0?this.shadowMinZ:e.minZ;return t.useReverseDepthBuffer&&t.isNDCHalfZRange?i:this._scene.getEngine().isNDCHalfZRange?0:i},n.prototype.getDepthMaxZ=function(e){var t=this._scene.getEngine(),i=this.shadowMaxZ!==void 0?this.shadowMaxZ:e.maxZ;return t.useReverseDepthBuffer&&t.isNDCHalfZRange?0:i},n.prototype.prepareLightSpecificDefines=function(e,t){e["SPOTLIGHT"+t]=!0,e["PROJECTEDLIGHTTEXTURE"+t]=!!(this.projectionTexture&&this.projectionTexture.isReady())},E([T()],n.prototype,"angle",null),E([T()],n.prototype,"innerAngle",null),E([T()],n.prototype,"shadowAngleScale",null),E([T()],n.prototype,"exponent",void 0),E([T()],n.prototype,"projectionTextureLightNear",null),E([T()],n.prototype,"projectionTextureLightFar",null),E([T()],n.prototype,"projectionTextureUpDirection",null),E([de("projectedLightTexture")],n.prototype,"_projectionTexture",void 0),n}(Ti),Ve=function(){function r(){}return r.SetMatrix=function(n,e,t,i,o){var a=null;if(t.semantic==="MODEL"?a=e.getWorldMatrix():t.semantic==="PROJECTION"?a=n.getProjectionMatrix():t.semantic==="VIEW"?a=n.getViewMatrix():t.semantic==="MODELVIEWINVERSETRANSPOSE"?a=Q.Transpose(e.getWorldMatrix().multiply(n.getViewMatrix()).invert()):t.semantic==="MODELVIEW"?a=e.getWorldMatrix().multiply(n.getViewMatrix()):t.semantic==="MODELVIEWPROJECTION"?a=e.getWorldMatrix().multiply(n.getTransformMatrix()):t.semantic==="MODELINVERSE"?a=e.getWorldMatrix().invert():t.semantic==="VIEWINVERSE"?a=n.getViewMatrix().invert():t.semantic==="PROJECTIONINVERSE"?a=n.getProjectionMatrix().invert():t.semantic==="MODELVIEWINVERSE"?a=e.getWorldMatrix().multiply(n.getViewMatrix()).invert():t.semantic==="MODELVIEWPROJECTIONINVERSE"?a=e.getWorldMatrix().multiply(n.getTransformMatrix()).invert():t.semantic==="MODELINVERSETRANSPOSE"&&(a=Q.Transpose(e.getWorldMatrix().invert())),a)switch(t.type){case xe.FLOAT_MAT2:o.setMatrix2x2(i,Q.GetAsMatrix2x2(a));break;case xe.FLOAT_MAT3:o.setMatrix3x3(i,Q.GetAsMatrix3x3(a));break;case xe.FLOAT_MAT4:o.setMatrix(i,a);break}},r.SetUniform=function(n,e,t,i){switch(i){case xe.FLOAT:return n.setFloat(e,t),!0;case xe.FLOAT_VEC2:return n.setVector2(e,Ge.FromArray(t)),!0;case xe.FLOAT_VEC3:return n.setVector3(e,y.FromArray(t)),!0;case xe.FLOAT_VEC4:return n.setVector4(e,ut.FromArray(t)),!0;default:return!1}},r.GetWrapMode=function(n){switch(n){case wt.CLAMP_TO_EDGE:return X.CLAMP_ADDRESSMODE;case wt.MIRRORED_REPEAT:return X.MIRROR_ADDRESSMODE;case wt.REPEAT:return X.WRAP_ADDRESSMODE;default:return X.WRAP_ADDRESSMODE}},r.GetByteStrideFromType=function(n){var e=n.type;switch(e){case"VEC2":return 2;case"VEC3":return 3;case"VEC4":return 4;case"MAT2":return 4;case"MAT3":return 9;case"MAT4":return 16;default:return 1}},r.GetTextureFilterMode=function(n){switch(n){case Xe.LINEAR:case Xe.LINEAR_MIPMAP_NEAREST:case Xe.LINEAR_MIPMAP_LINEAR:return X.TRILINEAR_SAMPLINGMODE;case Xe.NEAREST:case Xe.NEAREST_MIPMAP_NEAREST:return X.NEAREST_SAMPLINGMODE;default:return X.BILINEAR_SAMPLINGMODE}},r.GetBufferFromBufferView=function(n,e,t,i,o){t=e.byteOffset+t;var a=n.loadedBufferViews[e.buffer];if(t+i>a.byteLength)throw new Error("Buffer access is out of range");var s=a.buffer;switch(t+=a.byteOffset,o){case tt.BYTE:return new Int8Array(s,t,i);case tt.UNSIGNED_BYTE:return new Uint8Array(s,t,i);case tt.SHORT:return new Int16Array(s,t,i);case tt.UNSIGNED_SHORT:return new Uint16Array(s,t,i);default:return new Float32Array(s,t,i)}},r.GetBufferFromAccessor=function(n,e){var t=n.bufferViews[e.bufferView],i=e.count*r.GetByteStrideFromType(e);return r.GetBufferFromBufferView(n,t,e.byteOffset,i,e.componentType)},r.DecodeBufferToText=function(n){for(var e="",t=n.byteLength,i=0;i<t;++i)e+=String.fromCharCode(n[i]);return e},r.GetDefaultMaterial=function(n){if(!r._DefaultMaterial){ve.ShadersStore.GLTFDefaultMaterialVertexShader=["precision highp float;","","uniform mat4 worldView;","uniform mat4 projection;","","attribute vec3 position;","","void main(void)","{","    gl_Position = projection * worldView * vec4(position, 1.0);","}"].join(`
`),ve.ShadersStore.GLTFDefaultMaterialPixelShader=["precision highp float;","","uniform vec4 u_emission;","","void main(void)","{","    gl_FragColor = u_emission;","}"].join(`
`);var e={vertex:"GLTFDefaultMaterial",fragment:"GLTFDefaultMaterial"},t={attributes:["position"],uniforms:["worldView","projection","u_emission"],samplers:new Array,needAlphaBlending:!1};r._DefaultMaterial=new or("GLTFDefaultMaterial",n,e,t),r._DefaultMaterial.setColor4("u_emission",new gi(.5,.5,.5,1))}return r._DefaultMaterial},r._DefaultMaterial=null,r}(),ct=function(){function r(){}return r.ALPHA_DISABLE=0,r.ALPHA_ADD=1,r.ALPHA_COMBINE=2,r.ALPHA_SUBTRACT=3,r.ALPHA_MULTIPLY=4,r.ALPHA_MAXIMIZED=5,r.ALPHA_ONEONE=6,r.ALPHA_PREMULTIPLIED=7,r.ALPHA_PREMULTIPLIED_PORTERDUFF=8,r.ALPHA_INTERPOLATE=9,r.ALPHA_SCREENMODE=10,r.ALPHA_ONEONE_ONEONE=11,r.ALPHA_ALPHATOCOLOR=12,r.ALPHA_REVERSEONEMINUS=13,r.ALPHA_SRC_DSTONEMINUSSRCALPHA=14,r.ALPHA_ONEONE_ONEZERO=15,r.ALPHA_EXCLUSION=16,r.ALPHA_LAYER_ACCUMULATE=17,r.ALPHA_EQUATION_ADD=0,r.ALPHA_EQUATION_SUBSTRACT=1,r.ALPHA_EQUATION_REVERSE_SUBTRACT=2,r.ALPHA_EQUATION_MAX=3,r.ALPHA_EQUATION_MIN=4,r.ALPHA_EQUATION_DARKEN=5,r.DELAYLOADSTATE_NONE=0,r.DELAYLOADSTATE_LOADED=1,r.DELAYLOADSTATE_LOADING=2,r.DELAYLOADSTATE_NOTLOADED=4,r.NEVER=512,r.ALWAYS=519,r.LESS=513,r.EQUAL=514,r.LEQUAL=515,r.GREATER=516,r.GEQUAL=518,r.NOTEQUAL=517,r.KEEP=7680,r.ZERO=0,r.REPLACE=7681,r.INCR=7682,r.DECR=7683,r.INVERT=5386,r.INCR_WRAP=34055,r.DECR_WRAP=34056,r.TEXTURE_CLAMP_ADDRESSMODE=0,r.TEXTURE_WRAP_ADDRESSMODE=1,r.TEXTURE_MIRROR_ADDRESSMODE=2,r.TEXTURE_CREATIONFLAG_STORAGE=1,r.TEXTUREFORMAT_ALPHA=0,r.TEXTUREFORMAT_LUMINANCE=1,r.TEXTUREFORMAT_LUMINANCE_ALPHA=2,r.TEXTUREFORMAT_RGB=4,r.TEXTUREFORMAT_RGBA=5,r.TEXTUREFORMAT_RED=6,r.TEXTUREFORMAT_R=6,r.TEXTUREFORMAT_RG=7,r.TEXTUREFORMAT_RED_INTEGER=8,r.TEXTUREFORMAT_R_INTEGER=8,r.TEXTUREFORMAT_RG_INTEGER=9,r.TEXTUREFORMAT_RGB_INTEGER=10,r.TEXTUREFORMAT_RGBA_INTEGER=11,r.TEXTUREFORMAT_BGRA=12,r.TEXTUREFORMAT_DEPTH24_STENCIL8=13,r.TEXTUREFORMAT_DEPTH32_FLOAT=14,r.TEXTUREFORMAT_DEPTH16=15,r.TEXTUREFORMAT_DEPTH24=16,r.TEXTUREFORMAT_COMPRESSED_RGBA_BPTC_UNORM=36492,r.TEXTUREFORMAT_COMPRESSED_RGB_BPTC_UNSIGNED_FLOAT=36495,r.TEXTUREFORMAT_COMPRESSED_RGB_BPTC_SIGNED_FLOAT=36494,r.TEXTUREFORMAT_COMPRESSED_RGBA_S3TC_DXT5=33779,r.TEXTUREFORMAT_COMPRESSED_RGBA_S3TC_DXT3=33778,r.TEXTUREFORMAT_COMPRESSED_RGBA_S3TC_DXT1=33777,r.TEXTUREFORMAT_COMPRESSED_RGB_S3TC_DXT1=33776,r.TEXTUREFORMAT_COMPRESSED_RGBA_ASTC_4x4=37808,r.TEXTUREFORMAT_COMPRESSED_RGB_ETC1_WEBGL=36196,r.TEXTURETYPE_UNSIGNED_BYTE=0,r.TEXTURETYPE_UNSIGNED_INT=0,r.TEXTURETYPE_FLOAT=1,r.TEXTURETYPE_HALF_FLOAT=2,r.TEXTURETYPE_BYTE=3,r.TEXTURETYPE_SHORT=4,r.TEXTURETYPE_UNSIGNED_SHORT=5,r.TEXTURETYPE_INT=6,r.TEXTURETYPE_UNSIGNED_INTEGER=7,r.TEXTURETYPE_UNSIGNED_SHORT_4_4_4_4=8,r.TEXTURETYPE_UNSIGNED_SHORT_5_5_5_1=9,r.TEXTURETYPE_UNSIGNED_SHORT_5_6_5=10,r.TEXTURETYPE_UNSIGNED_INT_2_10_10_10_REV=11,r.TEXTURETYPE_UNSIGNED_INT_24_8=12,r.TEXTURETYPE_UNSIGNED_INT_10F_11F_11F_REV=13,r.TEXTURETYPE_UNSIGNED_INT_5_9_9_9_REV=14,r.TEXTURETYPE_FLOAT_32_UNSIGNED_INT_24_8_REV=15,r.TEXTURETYPE_UNDEFINED=16,r.TEXTURE_NEAREST_SAMPLINGMODE=1,r.TEXTURE_NEAREST_NEAREST=1,r.TEXTURE_BILINEAR_SAMPLINGMODE=2,r.TEXTURE_LINEAR_LINEAR=2,r.TEXTURE_TRILINEAR_SAMPLINGMODE=3,r.TEXTURE_LINEAR_LINEAR_MIPLINEAR=3,r.TEXTURE_NEAREST_NEAREST_MIPNEAREST=4,r.TEXTURE_NEAREST_LINEAR_MIPNEAREST=5,r.TEXTURE_NEAREST_LINEAR_MIPLINEAR=6,r.TEXTURE_NEAREST_LINEAR=7,r.TEXTURE_NEAREST_NEAREST_MIPLINEAR=8,r.TEXTURE_LINEAR_NEAREST_MIPNEAREST=9,r.TEXTURE_LINEAR_NEAREST_MIPLINEAR=10,r.TEXTURE_LINEAR_LINEAR_MIPNEAREST=11,r.TEXTURE_LINEAR_NEAREST=12,r.TEXTURE_EXPLICIT_MODE=0,r.TEXTURE_SPHERICAL_MODE=1,r.TEXTURE_PLANAR_MODE=2,r.TEXTURE_CUBIC_MODE=3,r.TEXTURE_PROJECTION_MODE=4,r.TEXTURE_SKYBOX_MODE=5,r.TEXTURE_INVCUBIC_MODE=6,r.TEXTURE_EQUIRECTANGULAR_MODE=7,r.TEXTURE_FIXED_EQUIRECTANGULAR_MODE=8,r.TEXTURE_FIXED_EQUIRECTANGULAR_MIRRORED_MODE=9,r.TEXTURE_FILTERING_QUALITY_OFFLINE=4096,r.TEXTURE_FILTERING_QUALITY_HIGH=64,r.TEXTURE_FILTERING_QUALITY_MEDIUM=16,r.TEXTURE_FILTERING_QUALITY_LOW=8,r.SCALEMODE_FLOOR=1,r.SCALEMODE_NEAREST=2,r.SCALEMODE_CEILING=3,r.MATERIAL_TextureDirtyFlag=1,r.MATERIAL_LightDirtyFlag=2,r.MATERIAL_FresnelDirtyFlag=4,r.MATERIAL_AttributesDirtyFlag=8,r.MATERIAL_MiscDirtyFlag=16,r.MATERIAL_PrePassDirtyFlag=32,r.MATERIAL_AllDirtyFlag=63,r.MATERIAL_TriangleFillMode=0,r.MATERIAL_WireFrameFillMode=1,r.MATERIAL_PointFillMode=2,r.MATERIAL_PointListDrawMode=3,r.MATERIAL_LineListDrawMode=4,r.MATERIAL_LineLoopDrawMode=5,r.MATERIAL_LineStripDrawMode=6,r.MATERIAL_TriangleStripDrawMode=7,r.MATERIAL_TriangleFanDrawMode=8,r.MATERIAL_ClockWiseSideOrientation=0,r.MATERIAL_CounterClockWiseSideOrientation=1,r.ACTION_NothingTrigger=0,r.ACTION_OnPickTrigger=1,r.ACTION_OnLeftPickTrigger=2,r.ACTION_OnRightPickTrigger=3,r.ACTION_OnCenterPickTrigger=4,r.ACTION_OnPickDownTrigger=5,r.ACTION_OnDoublePickTrigger=6,r.ACTION_OnPickUpTrigger=7,r.ACTION_OnPickOutTrigger=16,r.ACTION_OnLongPressTrigger=8,r.ACTION_OnPointerOverTrigger=9,r.ACTION_OnPointerOutTrigger=10,r.ACTION_OnEveryFrameTrigger=11,r.ACTION_OnIntersectionEnterTrigger=12,r.ACTION_OnIntersectionExitTrigger=13,r.ACTION_OnKeyDownTrigger=14,r.ACTION_OnKeyUpTrigger=15,r.PARTICLES_BILLBOARDMODE_Y=2,r.PARTICLES_BILLBOARDMODE_ALL=7,r.PARTICLES_BILLBOARDMODE_STRETCHED=8,r.MESHES_CULLINGSTRATEGY_STANDARD=0,r.MESHES_CULLINGSTRATEGY_BOUNDINGSPHERE_ONLY=1,r.MESHES_CULLINGSTRATEGY_OPTIMISTIC_INCLUSION=2,r.MESHES_CULLINGSTRATEGY_OPTIMISTIC_INCLUSION_THEN_BSPHERE_ONLY=3,r.SCENELOADER_NO_LOGGING=0,r.SCENELOADER_MINIMAL_LOGGING=1,r.SCENELOADER_SUMMARY_LOGGING=2,r.SCENELOADER_DETAILED_LOGGING=3,r.PREPASS_IRRADIANCE_TEXTURE_TYPE=0,r.PREPASS_POSITION_TEXTURE_TYPE=1,r.PREPASS_VELOCITY_TEXTURE_TYPE=2,r.PREPASS_REFLECTIVITY_TEXTURE_TYPE=3,r.PREPASS_COLOR_TEXTURE_TYPE=4,r.PREPASS_DEPTH_TEXTURE_TYPE=5,r.PREPASS_NORMAL_TEXTURE_TYPE=6,r.PREPASS_ALBEDO_SQRT_TEXTURE_TYPE=7,r.BUFFER_CREATIONFLAG_READ=1,r.BUFFER_CREATIONFLAG_WRITE=2,r.BUFFER_CREATIONFLAG_READWRITE=3,r.BUFFER_CREATIONFLAG_UNIFORM=4,r.BUFFER_CREATIONFLAG_VERTEX=8,r.BUFFER_CREATIONFLAG_INDEX=16,r.BUFFER_CREATIONFLAG_STORAGE=32,r.RENDERPASS_MAIN=0,r.INPUT_ALT_KEY=18,r.INPUT_CTRL_KEY=17,r.INPUT_META_KEY1=91,r.INPUT_META_KEY2=92,r.INPUT_META_KEY3=93,r.INPUT_SHIFT_KEY=16,r.SNAPSHOTRENDERING_STANDARD=0,r.SNAPSHOTRENDERING_FAST=1,r.PERSPECTIVE_CAMERA=0,r.ORTHOGRAPHIC_CAMERA=1,r.FOVMODE_VERTICAL_FIXED=0,r.FOVMODE_HORIZONTAL_FIXED=1,r.RIG_MODE_NONE=0,r.RIG_MODE_STEREOSCOPIC_ANAGLYPH=10,r.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_PARALLEL=11,r.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_CROSSEYED=12,r.RIG_MODE_STEREOSCOPIC_OVERUNDER=13,r.RIG_MODE_STEREOSCOPIC_INTERLACED=14,r.RIG_MODE_VR=20,r.RIG_MODE_WEBVR=21,r.RIG_MODE_CUSTOM=22,r.MAX_SUPPORTED_UV_SETS=6,r.GL_ALPHA_EQUATION_ADD=32774,r.GL_ALPHA_EQUATION_MIN=32775,r.GL_ALPHA_EQUATION_MAX=32776,r.GL_ALPHA_EQUATION_SUBTRACT=32778,r.GL_ALPHA_EQUATION_REVERSE_SUBTRACT=32779,r.GL_ALPHA_FUNCTION_SRC=768,r.GL_ALPHA_FUNCTION_ONE_MINUS_SRC_COLOR=769,r.GL_ALPHA_FUNCTION_SRC_ALPHA=770,r.GL_ALPHA_FUNCTION_ONE_MINUS_SRC_ALPHA=771,r.GL_ALPHA_FUNCTION_DST_ALPHA=772,r.GL_ALPHA_FUNCTION_ONE_MINUS_DST_ALPHA=773,r.GL_ALPHA_FUNCTION_DST_COLOR=774,r.GL_ALPHA_FUNCTION_ONE_MINUS_DST_COLOR=775,r.GL_ALPHA_FUNCTION_SRC_ALPHA_SATURATED=776,r.GL_ALPHA_FUNCTION_CONSTANT_COLOR=32769,r.GL_ALPHA_FUNCTION_ONE_MINUS_CONSTANT_COLOR=32770,r.GL_ALPHA_FUNCTION_CONSTANT_ALPHA=32771,r.GL_ALPHA_FUNCTION_ONE_MINUS_CONSTANT_ALPHA=32772,r}(),nt;(function(r){r[r.IDENTIFIER=1]="IDENTIFIER",r[r.UNKNOWN=2]="UNKNOWN",r[r.END_OF_INPUT=3]="END_OF_INPUT"})(nt||(nt={}));var zi=function(){function r(n){this._pos=0,this.currentToken=nt.UNKNOWN,this.currentIdentifier="",this.currentString="",this.isLetterOrDigitPattern=/^[a-zA-Z0-9]+$/,this._toParse=n,this._maxPos=n.length}return r.prototype.getNextToken=function(){if(this.isEnd())return nt.END_OF_INPUT;if(this.currentString=this.read(),this.currentToken=nt.UNKNOWN,this.currentString==="_"||this.isLetterOrDigitPattern.test(this.currentString))for(this.currentToken=nt.IDENTIFIER,this.currentIdentifier=this.currentString;!this.isEnd()&&(this.isLetterOrDigitPattern.test(this.currentString=this.peek())||this.currentString==="_");)this.currentIdentifier+=this.currentString,this.forward();return this.currentToken},r.prototype.peek=function(){return this._toParse[this._pos]},r.prototype.read=function(){return this._toParse[this._pos++]},r.prototype.forward=function(){this._pos++},r.prototype.isEnd=function(){return this._pos>=this._maxPos},r}(),Ir=["MODEL","VIEW","PROJECTION","MODELVIEW","MODELVIEWPROJECTION","JOINTMATRIX"],Pr=["world","view","projection","worldView","worldViewProjection","mBones"],ma=["translation","rotation","scale"],_a=["position","rotationQuaternion","scaling"],ga=function(r,n){for(var e in r){var t=r[e];n.buffers[e]=t,n.buffersCount++}},va=function(r,n){for(var e in r){var t=r[e];n.shaders[e]=t,n.shaderscount++}},Re=function(r,n,e){for(var t in r){var i=r[t];e[n][t]=i}},Ea=function(r){if(!!r)for(var n=0;n<r.length/2;n++)r[n*2+1]=1-r[n*2+1]},Xi=function(r){if(r.semantic==="NORMAL")return"normal";if(r.semantic==="POSITION")return"position";if(r.semantic==="JOINT")return"matricesIndices";if(r.semantic==="WEIGHT")return"matricesWeights";if(r.semantic==="COLOR")return"color";if(r.semantic&&r.semantic.indexOf("TEXCOORD_")!==-1){var n=Number(r.semantic.split("_")[1]);return"uv"+(n===0?"":n+1)}return null},ba=function(r){for(var n in r.animations){var e=r.animations[n];if(!(!e.channels||!e.samplers))for(var t=null,i=0;i<e.channels.length;i++){var o=e.channels[i],a=e.samplers[o.sampler];if(!!a){var s=null,c=null;e.parameters?(s=e.parameters[a.input],c=e.parameters[a.output]):(s=a.input,c=a.output);var l=Ve.GetBufferFromAccessor(r,r.accessors[s]),u=Ve.GetBufferFromAccessor(r,r.accessors[c]),f=o.target.id,d=r.scene.getNodeById(f);if(d===null&&(d=r.scene.getNodeByName(f)),d===null){z.Warn("Creating animation named "+n+". But cannot find node named "+f+" to attach to");continue}var p=d instanceof Pt,m=o.target.path,_=ma.indexOf(m);_!==-1&&(m=_a[_]);var v=J.ANIMATIONTYPE_MATRIX;p||(m==="rotationQuaternion"?(v=J.ANIMATIONTYPE_QUATERNION,d.rotationQuaternion=new q):v=J.ANIMATIONTYPE_VECTOR3);var b=null,A=[],S=0,C=!1;p&&t&&t.getKeys().length===l.length&&(b=t,C=!0),C||(r.scene._blockEntityCollection=!!r.assetContainer,b=new J(n,p?"_matrix":m,1,v,J.ANIMATIONLOOPMODE_CYCLE),r.scene._blockEntityCollection=!1);for(var O=0;O<l.length;O++){var B=null;if(m==="rotationQuaternion"?(B=q.FromArray([u[S],u[S+1],u[S+2],u[S+3]]),S+=4):(B=y.FromArray([u[S],u[S+1],u[S+2]]),S+=3),p){var k=d,D=y.Zero(),Z=new q,$=y.Zero(),I=k.getBaseMatrix();C&&t&&(I=t.getKeys()[O].value),I.decompose($,Z,D),m==="position"?D=B:m==="rotationQuaternion"?Z=B:$=B,B=Q.Compose($,Z,D)}C?t&&(t.getKeys()[O].value=B):A.push({frame:l[O],value:B})}!C&&b&&(b.setKeys(A),d.animations.push(b)),t=b,r.scene.stopAnimation(d),r.scene.beginAnimation(d,0,l[l.length-1],!0,1)}}}},Si=function(r){var n=null;if(r.translation||r.rotation||r.scale){var e=y.FromArray(r.scale||[1,1,1]),t=q.FromArray(r.rotation||[0,0,0,1]),i=y.FromArray(r.translation||[0,0,0]);n=Q.Compose(e,t,i)}else n=Q.FromArray(r.matrix);return n},xr=function(r,n,e,t){for(var i=0;i<t.bones.length;i++)if(t.bones[i].name===e)return t.bones[i];var o=r.nodes;for(var a in o){var s=o[a];if(!!s.jointName)for(var c=s.children,i=0;i<c.length;i++){var l=r.nodes[c[i]];if(!!l.jointName&&l.jointName===e){var u=Si(s),f=new Pt(s.name||"",t,xr(r,n,s.jointName,t),u);return f.id=a,f}}}return null},Aa=function(r,n){for(var e=0;e<r.length;e++)for(var t=r[e],i=0;i<t.node.children.length;i++){var o=t.node.children[i];if(o===n)return t.bone}return null},Rn=function(r,n){var e=r.nodes,t=e[n];if(t)return{node:t,id:n};for(var i in e)if(t=e[i],t.jointName===n)return{node:t,id:i};return null},ya=function(r,n){for(var e=0;e<r.jointNames.length;e++)if(r.jointNames[e]===n)return!0;return!1},Ca=function(r,n,e,t){for(var i in r.nodes){var o=r.nodes[i],a=i;if(!(!o.jointName||ya(e,o.jointName))){var s=Si(o),c=new Pt(o.name||"",n,null,s);c.id=a,t.push({bone:c,node:o,id:a})}}for(var l=0;l<t.length;l++)for(var u=t[l],f=u.node.children,d=0;d<f.length;d++){for(var p=null,m=0;m<t.length;m++)if(t[m].id===f[d]){p=t[m];break}p&&(p.bone._parent=u.bone,u.bone.children.push(p.bone))}},Ta=function(r,n,e,t){if(t||(t=new vi(n.name||"","",r.scene)),!n.babylonSkeleton)return t;var i=[],o=[];Ca(r,t,n,i),t.bones=[];for(var a=0;a<n.jointNames.length;a++){var s=Rn(r,n.jointNames[a]);if(!!s){var c=s.node;if(!c){z.Warn("Joint named "+n.jointNames[a]+" does not exist");continue}var l=s.id,u=r.scene.getBoneById(l);if(u){t.bones.push(u);continue}for(var f=!1,d=null,p=0;p<a;p++){var m=Rn(r,n.jointNames[p]);if(!!m){var _=m.node;if(!_){z.Warn("Joint named "+n.jointNames[p]+" does not exist when looking for parent");continue}var v=_.children;if(!!v){f=!1;for(var b=0;b<v.length;b++)if(v[b]===l){d=xr(r,n,n.jointNames[p],t),f=!0;break}if(f)break}}}var A=Si(c);!d&&i.length>0&&(d=Aa(i,l),d&&o.indexOf(d)===-1&&o.push(d));var S=new Pt(c.jointName||"",t,d,A);S.id=l}}var C=t.bones;t.bones=[];for(var a=0;a<n.jointNames.length;a++){var s=Rn(r,n.jointNames[a]);if(!!s){for(var p=0;p<C.length;p++)if(C[p].id===s.id){t.bones.push(C[p]);break}}}t.prepare();for(var a=0;a<o.length;a++)t.bones.push(o[a]);return t},ji=function(r,n,e,t,i){if(i||(r.scene._blockEntityCollection=!!r.assetContainer,i=new he(n.name||"",r.scene),i._parentContainer=r.assetContainer,r.scene._blockEntityCollection=!1,i.id=t),!n.babylonNode)return i;for(var o=[],a=null,s=new Array,c=new Array,l=new Array,u=new Array,f=0;f<e.length;f++){var d=e[f],p=r.meshes[d];if(!!p)for(var m=0;m<p.primitives.length;m++){var _=new Mn,v=p.primitives[m];v.mode;var b=v.attributes,A=null,S=null;for(var C in b)if(A=r.accessors[b[C]],S=Ve.GetBufferFromAccessor(r,A),C==="NORMAL")_.normals=new Float32Array(S.length),_.normals.set(S);else if(C==="POSITION"){if(et.HomogeneousCoordinates){_.positions=new Float32Array(S.length-S.length/4);for(var O=0;O<S.length;O+=4)_.positions[O]=S[O],_.positions[O+1]=S[O+1],_.positions[O+2]=S[O+2]}else _.positions=new Float32Array(S.length),_.positions.set(S);c.push(_.positions.length)}else if(C.indexOf("TEXCOORD_")!==-1){var B=Number(C.split("_")[1]),k=w.UVKind+(B===0?"":B+1),D=new Float32Array(S.length);D.set(S),Ea(D),_.set(D,k)}else C==="JOINT"?(_.matricesIndices=new Float32Array(S.length),_.matricesIndices.set(S)):C==="WEIGHT"?(_.matricesWeights=new Float32Array(S.length),_.matricesWeights.set(S)):C==="COLOR"&&(_.colors=new Float32Array(S.length),_.colors.set(S));if(A=r.accessors[v.indices],A)S=Ve.GetBufferFromAccessor(r,A),_.indices=new Int32Array(S.length),_.indices.set(S),u.push(_.indices.length);else{for(var Z=[],O=0;O<_.positions.length/3;O++)Z.push(O);_.indices=new Int32Array(Z),u.push(_.indices.length)}a?a.merge(_):a=_;var $=r.scene.getMaterialById(v.material);o.push($===null?Ve.GetDefaultMaterial(r.scene):$),s.push(s.length===0?0:s[s.length-1]+c[c.length-2]),l.push(l.length===0?0:l[l.length-1]+u[u.length-2])}}var I;r.scene._blockEntityCollection=!!r.assetContainer,o.length>1?(I=new ho("multimat"+t,r.scene),I.subMaterials=o):I=new Ze("multimat"+t,r.scene),o.length===1&&(I=o[0]),I._parentContainer=r.assetContainer,i.material||(i.material=I),new Ei(t,r.scene,a,!1,i),i.computeWorldMatrix(!0),r.scene._blockEntityCollection=!1,i.subMeshes=[];for(var ue=0,f=0;f<e.length;f++){var d=e[f],p=r.meshes[d];if(!!p)for(var m=0;m<p.primitives.length;m++)p.primitives[m].mode,ln.AddToMesh(ue,s[ue],c[ue],l[ue],u[ue],i,i,!0),ue++}return i},kn=function(r,n,e,t){r.position&&(r.position=n),(r.rotationQuaternion||r.rotation)&&(r.rotationQuaternion=e),r.scaling&&(r.scaling=t)},Sa=function(r,n){if(n.matrix){var e=new y(0,0,0),t=new q,i=new y(0,0,0),o=Q.FromArray(n.matrix);o.decompose(i,t,e),kn(r,e,t,i)}else n.translation&&n.rotation&&n.scale&&kn(r,y.FromArray(n.translation),q.FromArray(n.rotation),y.FromArray(n.scale));r.computeWorldMatrix(!0)},Ra=function(r,n,e){var t=null;if(r.importOnlyMeshes&&(n.skin||n.meshes)&&r.importMeshesNames&&r.importMeshesNames.length>0&&r.importMeshesNames.indexOf(n.name||"")===-1)return null;if(n.skin){if(n.meshes){var i=r.skins[n.skin],o=ji(r,n,n.meshes,e,n.babylonNode);o.skeleton=r.scene.getLastSkeletonById(n.skin),o.skeleton===null&&(o.skeleton=Ta(r,i,o,i.babylonSkeleton),i.babylonSkeleton||(i.babylonSkeleton=o.skeleton)),t=o}}else if(n.meshes){var o=ji(r,n,n.mesh?[n.mesh]:n.meshes,e,n.babylonNode);t=o}else if(n.light&&!n.babylonNode&&!r.importOnlyMeshes){var a=r.lights[n.light];if(a){if(a.type==="ambient"){var s=a[a.type],c=new ar(n.light,y.Zero(),r.scene);c.name=n.name||"",s.color&&(c.diffuse=G.FromArray(s.color)),t=c}else if(a.type==="directional"){var l=a[a.type],u=new hn(n.light,y.Zero(),r.scene);u.name=n.name||"",l.color&&(u.diffuse=G.FromArray(l.color)),t=u}else if(a.type==="point"){var f=a[a.type],d=new Kt(n.light,y.Zero(),r.scene);d.name=n.name||"",f.color&&(d.diffuse=G.FromArray(f.color)),t=d}else if(a.type==="spot"){var p=a[a.type],m=new dn(n.light,y.Zero(),y.Zero(),0,0,r.scene);m.name=n.name||"",p.color&&(m.diffuse=G.FromArray(p.color)),p.fallOfAngle&&(m.angle=p.fallOfAngle),p.fallOffExponent&&(m.exponent=p.fallOffExponent),t=m}}}else if(n.camera&&!n.babylonNode&&!r.importOnlyMeshes){var _=r.cameras[n.camera];if(_){if(r.scene._blockEntityCollection=!!r.assetContainer,_.type==="orthographic"){var v=new Ut(n.camera,y.Zero(),r.scene,!1);v.name=n.name||"",v.mode=sn.ORTHOGRAPHIC_CAMERA,v.attachControl(),t=v,v._parentContainer=r.assetContainer}else if(_.type==="perspective"){var b=_[_.type],A=new Ut(n.camera,y.Zero(),r.scene,!1);A.name=n.name||"",A.attachControl(),b.aspectRatio||(b.aspectRatio=r.scene.getEngine().getRenderWidth()/r.scene.getEngine().getRenderHeight()),b.znear&&b.zfar&&(A.maxZ=b.zfar,A.minZ=b.znear),t=A,A._parentContainer=r.assetContainer}r.scene._blockEntityCollection=!1}}if(!n.jointName){if(n.babylonNode)return n.babylonNode;if(t===null){r.scene._blockEntityCollection=!!r.assetContainer;var S=new he(n.name||"",r.scene);S._parentContainer=r.assetContainer,r.scene._blockEntityCollection=!1,n.babylonNode=S,t=S}}if(t!==null){if(n.matrix&&t instanceof he)Sa(t,n);else{var C=n.translation||[0,0,0],O=n.rotation||[0,0,0,1],B=n.scale||[1,1,1];kn(t,y.FromArray(C),q.FromArray(O),y.FromArray(B))}t.updateCache(!0),n.babylonNode=t}return t},Ht=function(r,n,e,t){t===void 0&&(t=!1);var i=r.nodes[n],o=null;if(r.importOnlyMeshes&&!t&&r.importMeshesNames?r.importMeshesNames.indexOf(i.name||"")!==-1||r.importMeshesNames.length===0?t=!0:t=!1:t=!0,!i.jointName&&t&&(o=Ra(r,i,n),o!==null&&(o.id=n,o.parent=e)),i.children)for(var a=0;a<i.children.length;a++)Ht(r,i.children[a],o,t)},Yi=function(r){var n=r.currentScene;if(n)for(var e=0;e<n.nodes.length;e++)Ht(r,n.nodes[e],null);else for(var t in r.scenes){n=r.scenes[t];for(var e=0;e<n.nodes.length;e++)Ht(r,n.nodes[e],null)}ba(r);for(var e=0;e<r.scene.skeletons.length;e++){var i=r.scene.skeletons[e];r.scene.beginAnimation(i,0,Number.MAX_VALUE,!0,1)}},Oa=function(r,n,e,t,i,o,a){var s=o.values||i.parameters;for(var c in e){var l=e[c],u=l.type;if(u===xe.FLOAT_MAT2||u===xe.FLOAT_MAT3||u===xe.FLOAT_MAT4){if(l.semantic&&!l.source&&!l.node)Ve.SetMatrix(n.scene,r,l,c,t.getEffect());else if(l.semantic&&(l.source||l.node)){var f=n.scene.getNodeByName(l.source||l.node||"");if(f===null&&(f=n.scene.getNodeById(l.source||l.node||"")),f===null)continue;Ve.SetMatrix(n.scene,f,l,c,t.getEffect())}}else{var d=s[i.uniforms[c]];if(!d)continue;if(u===xe.SAMPLER_2D){var p=n.textures[o.values?d:l.value].babylonTexture;if(p==null)continue;t.getEffect().setTexture(c,p)}else Ve.SetUniform(t.getEffect(),c,d,u)}}a(t)},Na=function(r,n,e,t,i){var o=t.values||e.parameters,a=e.uniforms,s=function(l){var u=i[l],f=u.type,d=o[a[l]];if(d===void 0&&(d=u.value),!d)return"continue";var p=function(m){return function(_){u.value&&m&&(n.setTexture(m,_),delete i[m])}};f===xe.SAMPLER_2D?qe.LoadTextureAsync(r,t.values?d:u.value,p(l),function(){return p(null)}):u.value&&Ve.SetUniform(n,l,t.values?d:u.value,f)&&delete i[l]};for(var c in i)s(c)},Ia=function(r,n,e){return function(t,i){n.dispose(!0),e("Cannot compile program named "+r.name+". Error: "+i+". Default material will be applied")}},Pa=function(r,n,e,t,i,o){return function(a){Na(r,n,e,t,i),n.onBind=function(s){Oa(s,r,i,n,e,t,o)}}},Wi=function(r,n,e){for(var t in n.uniforms){var i=n.uniforms[t],o=n.parameters[i];if(r.currentIdentifier===t&&o.semantic&&!o.source&&!o.node){var a=Ir.indexOf(o.semantic);if(a!==-1)return delete e[t],Pr[a]}}return r.currentIdentifier},Ki=function(r){for(var n in r.materials)qe.LoadMaterialAsync(r,n,function(){},function(){})},Qe=function(){function r(){}return r.CreateRuntime=function(n,e,t){var i={extensions:{},accessors:{},buffers:{},bufferViews:{},meshes:{},lights:{},cameras:{},nodes:{},images:{},textures:{},shaders:{},programs:{},samplers:{},techniques:{},materials:{},animations:{},skins:{},extensionsUsed:[],scenes:{},buffersCount:0,shaderscount:0,scene:e,rootUrl:t,loadedBufferCount:0,loadedBufferViews:{},loadedShaderCount:0,importOnlyMeshes:!1,dummyNodes:[],assetContainer:null};return n.extensions&&Re(n.extensions,"extensions",i),n.extensionsUsed&&Re(n.extensionsUsed,"extensionsUsed",i),n.buffers&&ga(n.buffers,i),n.bufferViews&&Re(n.bufferViews,"bufferViews",i),n.accessors&&Re(n.accessors,"accessors",i),n.meshes&&Re(n.meshes,"meshes",i),n.lights&&Re(n.lights,"lights",i),n.cameras&&Re(n.cameras,"cameras",i),n.nodes&&Re(n.nodes,"nodes",i),n.images&&Re(n.images,"images",i),n.textures&&Re(n.textures,"textures",i),n.shaders&&va(n.shaders,i),n.programs&&Re(n.programs,"programs",i),n.samplers&&Re(n.samplers,"samplers",i),n.techniques&&Re(n.techniques,"techniques",i),n.materials&&Re(n.materials,"materials",i),n.animations&&Re(n.animations,"animations",i),n.skins&&Re(n.skins,"skins",i),n.scenes&&(i.scenes=n.scenes),n.scene&&n.scenes&&(i.currentScene=n.scenes[n.scene]),i},r.LoadBufferAsync=function(n,e,t,i,o){var a=n.buffers[e];z.IsBase64(a.uri)?setTimeout(function(){return t(new Uint8Array(z.DecodeBase64(a.uri)))}):z.LoadFile(n.rootUrl+a.uri,function(s){return t(new Uint8Array(s))},o,void 0,!0,function(s){s&&i(s.status+" "+s.statusText)})},r.LoadTextureBufferAsync=function(n,e,t,i){var o=n.textures[e];if(!o||!o.source){i("");return}if(o.babylonTexture){t(null);return}var a=n.images[o.source];z.IsBase64(a.uri)?setTimeout(function(){return t(new Uint8Array(z.DecodeBase64(a.uri)))}):z.LoadFile(n.rootUrl+a.uri,function(s){return t(new Uint8Array(s))},void 0,void 0,!0,function(s){s&&i(s.status+" "+s.statusText)})},r.CreateTextureAsync=function(n,e,t,i){var o=n.textures[e];if(o.babylonTexture){i(o.babylonTexture);return}var a=n.samplers[o.sampler],s=a.minFilter===Xe.NEAREST_MIPMAP_NEAREST||a.minFilter===Xe.NEAREST_MIPMAP_LINEAR||a.minFilter===Xe.LINEAR_MIPMAP_NEAREST||a.minFilter===Xe.LINEAR_MIPMAP_LINEAR,c=X.BILINEAR_SAMPLINGMODE,l=t==null?new Blob:new Blob([t]),u=URL.createObjectURL(l),f=function(){return URL.revokeObjectURL(u)},d=new X(u,n.scene,!s,!0,c,f,f);a.wrapS!==void 0&&(d.wrapU=Ve.GetWrapMode(a.wrapS)),a.wrapT!==void 0&&(d.wrapV=Ve.GetWrapMode(a.wrapT)),d.name=e,o.babylonTexture=d,i(d)},r.LoadShaderStringAsync=function(n,e,t,i){var o=n.shaders[e];if(z.IsBase64(o.uri)){var a=atob(o.uri.split(",")[1]);t&&t(a)}else z.LoadFile(n.rootUrl+o.uri,t,void 0,void 0,!1,function(s){s&&i&&i(s.status+" "+s.statusText)})},r.LoadMaterialAsync=function(n,e,t,i){var o=n.materials[e];if(!o.technique){i&&i("No technique found.");return}var a=n.techniques[o.technique];if(!a){n.scene._blockEntityCollection=!!n.assetContainer;var s=new Ze(e,n.scene);s._parentContainer=n.assetContainer,n.scene._blockEntityCollection=!1,s.diffuseColor=new G(.5,.5,.5),s.sideOrientation=Ee.CounterClockWiseSideOrientation,t(s);return}var c=n.programs[a.program],l=a.states,u=ve.ShadersStore[c.vertexShader+"VertexShader"],f=ve.ShadersStore[c.fragmentShader+"PixelShader"],d="",p="",m=new zi(u),_=new zi(f),v={},b=[],A=[],S=[];for(var C in a.uniforms){var O=a.uniforms[C],B=a.parameters[O];if(v[C]=B,B.semantic&&!B.node&&!B.source){var k=Ir.indexOf(B.semantic);k!==-1?(b.push(Pr[k]),delete v[C]):b.push(C)}else B.type===xe.SAMPLER_2D?S.push(C):b.push(C)}for(var D in a.attributes){var Z=a.attributes[D],$=a.parameters[Z];if($.semantic){var I=Xi($);I&&A.push(I)}}for(;!m.isEnd()&&m.getNextToken();){var ue=m.currentToken;if(ue!==nt.IDENTIFIER){d+=m.currentString;continue}var ge=!1;for(var D in a.attributes){var Z=a.attributes[D],$=a.parameters[Z];if(m.currentIdentifier===D&&$.semantic){d+=Xi($),ge=!0;break}}ge||(d+=Wi(m,a,v))}for(;!_.isEnd()&&_.getNextToken();){var ue=_.currentToken;if(ue!==nt.IDENTIFIER){p+=_.currentString;continue}p+=Wi(_,a,v)}var _e={vertex:c.vertexShader+e,fragment:c.fragmentShader+e},ce={attributes:A,uniforms:b,samplers:S,needAlphaBlending:l&&l.enable&&l.enable.indexOf(3042)!==-1};ve.ShadersStore[c.vertexShader+e+"VertexShader"]=d,ve.ShadersStore[c.fragmentShader+e+"PixelShader"]=p;var ie=new or(e,n.scene,_e,ce);if(ie.onError=Ia(c,ie,i),ie.onCompiled=Pa(n,ie,a,o,v,t),ie.sideOrientation=Ee.CounterClockWiseSideOrientation,l&&l.functions){var Se=l.functions;Se.cullFace&&Se.cullFace[0]!==Un.BACK&&(ie.backFaceCulling=!1);var le=Se.blendFuncSeparate;le&&(le[0]===fe.SRC_ALPHA&&le[1]===fe.ONE_MINUS_SRC_ALPHA&&le[2]===fe.ONE&&le[3]===fe.ONE?ie.alphaMode=ct.ALPHA_COMBINE:le[0]===fe.ONE&&le[1]===fe.ONE&&le[2]===fe.ZERO&&le[3]===fe.ONE?ie.alphaMode=ct.ALPHA_ONEONE:le[0]===fe.SRC_ALPHA&&le[1]===fe.ONE&&le[2]===fe.ZERO&&le[3]===fe.ONE?ie.alphaMode=ct.ALPHA_ADD:le[0]===fe.ZERO&&le[1]===fe.ONE_MINUS_SRC_COLOR&&le[2]===fe.ONE&&le[3]===fe.ONE?ie.alphaMode=ct.ALPHA_SUBTRACT:le[0]===fe.DST_COLOR&&le[1]===fe.ZERO&&le[2]===fe.ONE&&le[3]===fe.ONE?ie.alphaMode=ct.ALPHA_MULTIPLY:le[0]===fe.SRC_ALPHA&&le[1]===fe.ONE_MINUS_SRC_COLOR&&le[2]===fe.ONE&&le[3]===fe.ONE&&(ie.alphaMode=ct.ALPHA_MAXIMIZED))}},r}(),zt=function(){function r(){}return r.RegisterExtension=function(n){if(r.Extensions[n.name]){z.Error('Tool with the same name "'+n.name+'" already exists');return}r.Extensions[n.name]=n},r.prototype.dispose=function(){},r.prototype._importMeshAsync=function(n,e,t,i,o,a,s,c){var l=this;return e.useRightHandedSystem=!0,qe.LoadRuntimeAsync(e,t,i,function(u){u.assetContainer=o,u.importOnlyMeshes=!0,n===""?u.importMeshesNames=[]:typeof n=="string"?u.importMeshesNames=[n]:n&&!(n instanceof Array)?u.importMeshesNames=[n]:(u.importMeshesNames=[],z.Warn("Argument meshesNames must be of type string or string[]")),l._createNodes(u);var f=new Array,d=new Array;for(var p in u.nodes){var m=u.nodes[p];m.babylonNode instanceof Rt&&f.push(m.babylonNode)}for(var _ in u.skins){var v=u.skins[_];v.babylonSkeleton instanceof vi&&d.push(v.babylonSkeleton)}l._loadBuffersAsync(u,function(){l._loadShadersAsync(u,function(){Ki(u),Yi(u),!et.IncrementalLoading&&a&&a(f,d)})}),et.IncrementalLoading&&a&&a(f,d)},c),!0},r.prototype.importMeshAsync=function(n,e,t,i,o,a){var s=this;return new Promise(function(c,l){s._importMeshAsync(n,e,i,o,t,function(u,f){c({meshes:u,particleSystems:[],skeletons:f,animationGroups:[],lights:[],transformNodes:[],geometries:[]})},a,function(u){l(new Error(u))})})},r.prototype._loadAsync=function(n,e,t,i,o,a){var s=this;n.useRightHandedSystem=!0,qe.LoadRuntimeAsync(n,e,t,function(c){qe.LoadRuntimeExtensionsAsync(c,function(){s._createNodes(c),s._loadBuffersAsync(c,function(){s._loadShadersAsync(c,function(){Ki(c),Yi(c),et.IncrementalLoading||i()})}),et.IncrementalLoading&&i()},a)},a)},r.prototype.loadAsync=function(n,e,t,i){var o=this;return new Promise(function(a,s){o._loadAsync(n,e,t,function(){a()},i,function(c){s(new Error(c))})})},r.prototype._loadShadersAsync=function(n,e){var t=!1,i=function(s,c){qe.LoadShaderStringAsync(n,s,function(l){l instanceof ArrayBuffer||(n.loadedShaderCount++,l&&(ve.ShadersStore[s+(c.type===Vn.VERTEX?"VertexShader":"PixelShader")]=l),n.loadedShaderCount===n.shaderscount&&e())},function(){z.Error("Error when loading shader program named "+s+" located at "+c.uri)})};for(var o in n.shaders){t=!0;var a=n.shaders[o];a?i.bind(this,o,a)():z.Error("No shader named: "+o)}t||e()},r.prototype._loadBuffersAsync=function(n,e){var t=!1,i=function(s,c){qe.LoadBufferAsync(n,s,function(l){n.loadedBufferCount++,l&&(l.byteLength!=n.buffers[s].byteLength&&z.Error("Buffer named "+s+" is length "+l.byteLength+". Expected: "+c.byteLength),n.loadedBufferViews[s]=l),n.loadedBufferCount===n.buffersCount&&e()},function(){z.Error("Error when loading buffer named "+s+" located at "+c.uri)})};for(var o in n.buffers){t=!0;var a=n.buffers[o];a?i.bind(this,o,a)():z.Error("No buffer named: "+o)}t||e()},r.prototype._createNodes=function(n){var e=n.currentScene;if(e)for(var t=0;t<e.nodes.length;t++)Ht(n,e.nodes[t],null);else for(var i in n.scenes){e=n.scenes[i];for(var t=0;t<e.nodes.length;t++)Ht(n,e.nodes[t],null)}},r.Extensions={},r}(),qe=function(){function r(n){this._name=n}return Object.defineProperty(r.prototype,"name",{get:function(){return this._name},enumerable:!1,configurable:!0}),r.prototype.loadRuntimeAsync=function(n,e,t,i,o){return!1},r.prototype.loadRuntimeExtensionsAsync=function(n,e,t){return!1},r.prototype.loadBufferAsync=function(n,e,t,i,o){return!1},r.prototype.loadTextureBufferAsync=function(n,e,t,i){return!1},r.prototype.createTextureAsync=function(n,e,t,i,o){return!1},r.prototype.loadShaderStringAsync=function(n,e,t,i){return!1},r.prototype.loadMaterialAsync=function(n,e,t,i){return!1},r.LoadRuntimeAsync=function(n,e,t,i,o){r._ApplyExtensions(function(a){return a.loadRuntimeAsync(n,e,t,i,o)},function(){setTimeout(function(){!i||i(Qe.CreateRuntime(e.json,n,t))})})},r.LoadRuntimeExtensionsAsync=function(n,e,t){r._ApplyExtensions(function(i){return i.loadRuntimeExtensionsAsync(n,e,t)},function(){setTimeout(function(){e()})})},r.LoadBufferAsync=function(n,e,t,i,o){r._ApplyExtensions(function(a){return a.loadBufferAsync(n,e,t,i,o)},function(){Qe.LoadBufferAsync(n,e,t,i,o)})},r.LoadTextureAsync=function(n,e,t,i){r._LoadTextureBufferAsync(n,e,function(o){o&&r._CreateTextureAsync(n,e,o,t,i)},i)},r.LoadShaderStringAsync=function(n,e,t,i){r._ApplyExtensions(function(o){return o.loadShaderStringAsync(n,e,t,i)},function(){Qe.LoadShaderStringAsync(n,e,t,i)})},r.LoadMaterialAsync=function(n,e,t,i){r._ApplyExtensions(function(o){return o.loadMaterialAsync(n,e,t,i)},function(){Qe.LoadMaterialAsync(n,e,t,i)})},r._LoadTextureBufferAsync=function(n,e,t,i){r._ApplyExtensions(function(o){return o.loadTextureBufferAsync(n,e,t,i)},function(){Qe.LoadTextureBufferAsync(n,e,t,i)})},r._CreateTextureAsync=function(n,e,t,i,o){r._ApplyExtensions(function(a){return a.createTextureAsync(n,e,t,i,o)},function(){Qe.CreateTextureAsync(n,e,t,i)})},r._ApplyExtensions=function(n,e){for(var t in zt.Extensions){var i=zt.Extensions[t];if(n(i))return}e()},r}();et._CreateGLTF1Loader=function(){return new zt};var xa="binary_glTF",Ma=function(r){R(n,r);function n(){return r.call(this,"KHR_binary_glTF")||this}return n.prototype.loadRuntimeAsync=function(e,t,i,o){var a=t.json.extensionsUsed;return!a||a.indexOf(this.name)===-1||!t.bin?!1:(this._bin=t.bin,o(Qe.CreateRuntime(t.json,e,i)),!0)},n.prototype.loadBufferAsync=function(e,t,i,o){return e.extensionsUsed.indexOf(this.name)===-1||t!==xa?!1:(this._bin.readAsync(0,this._bin.byteLength).then(i,function(a){return o(a.message)}),!0)},n.prototype.loadTextureBufferAsync=function(e,t,i){var o=e.textures[t],a=e.images[o.source];if(!a.extensions||!(this.name in a.extensions))return!1;var s=a.extensions[this.name],c=e.bufferViews[s.bufferView],l=Ve.GetBufferFromBufferView(e,c,0,c.byteLength,tt.UNSIGNED_BYTE);return i(l),!0},n.prototype.loadShaderStringAsync=function(e,t,i){var o=e.shaders[t];if(!o.extensions||!(this.name in o.extensions))return!1;var a=o.extensions[this.name],s=e.bufferViews[a.bufferView],c=Ve.GetBufferFromBufferView(e,s,0,s.byteLength,tt.UNSIGNED_BYTE);return setTimeout(function(){var l=Ve.DecodeBufferToText(c);i(l)}),!0},n}(qe);zt.RegisterExtension(new Ma);var La=function(r){R(n,r);function n(){return r.call(this,"KHR_materials_common")||this}return n.prototype.loadRuntimeExtensionsAsync=function(e){if(!e.extensions)return!1;var t=e.extensions[this.name];if(!t)return!1;var i=t.lights;if(i)for(var o in i){var a=i[o];switch(a.type){case"ambient":{var s=new ar(a.name,new y(0,1,0),e.scene),c=a.ambient;c&&(s.diffuse=G.FromArray(c.color||[1,1,1]));break}case"point":{var l=new Kt(a.name,new y(10,10,10),e.scene),u=a.point;u&&(l.diffuse=G.FromArray(u.color||[1,1,1]));break}case"directional":{var f=new hn(a.name,new y(0,-1,0),e.scene),d=a.directional;d&&(f.diffuse=G.FromArray(d.color||[1,1,1]));break}case"spot":{var p=a.spot;if(p){var m=new dn(a.name,new y(0,10,0),new y(0,-1,0),p.fallOffAngle||Math.PI,p.fallOffExponent||0,e.scene);m.diffuse=G.FromArray(p.color||[1,1,1])}break}default:z.Warn('GLTF Material Common extension: light type "'+a.type+"\u201D not supported");break}}return!1},n.prototype.loadMaterialAsync=function(e,t,i,o){var a=e.materials[t];if(!a||!a.extensions)return!1;var s=a.extensions[this.name];if(!s)return!1;var c=new Ze(t,e.scene);return c.sideOrientation=Ee.CounterClockWiseSideOrientation,s.technique==="CONSTANT"&&(c.disableLighting=!0),c.backFaceCulling=s.doubleSided===void 0?!1:!s.doubleSided,c.alpha=s.values.transparency===void 0?1:s.values.transparency,c.specularPower=s.values.shininess===void 0?0:s.values.shininess,typeof s.values.ambient=="string"?this._loadTexture(e,s.values.ambient,c,"ambientTexture",o):c.ambientColor=G.FromArray(s.values.ambient||[0,0,0]),typeof s.values.diffuse=="string"?this._loadTexture(e,s.values.diffuse,c,"diffuseTexture",o):c.diffuseColor=G.FromArray(s.values.diffuse||[0,0,0]),typeof s.values.emission=="string"?this._loadTexture(e,s.values.emission,c,"emissiveTexture",o):c.emissiveColor=G.FromArray(s.values.emission||[0,0,0]),typeof s.values.specular=="string"?this._loadTexture(e,s.values.specular,c,"specularTexture",o):c.specularColor=G.FromArray(s.values.specular||[0,0,0]),!0},n.prototype._loadTexture=function(e,t,i,o,a){Qe.LoadTextureBufferAsync(e,t,function(s){Qe.CreateTextureAsync(e,t,s,function(c){return i[o]=c})},a)},n}(qe);zt.RegisterExtension(new La);var Fa=function(){function r(){}return r.prototype.getClassName=function(){return"TargetedAnimation"},r.prototype.serialize=function(){var n={};return n.animation=this.animation.serialize(),n.targetId=this.target.id,n},r}(),Da=function(){function r(n,e){e===void 0&&(e=null),this.name=n,this._targetedAnimations=new Array,this._animatables=new Array,this._from=Number.MAX_VALUE,this._to=-Number.MAX_VALUE,this._speedRatio=1,this._loopAnimation=!1,this._isAdditive=!1,this._parentContainer=null,this.onAnimationEndObservable=new U,this.onAnimationLoopObservable=new U,this.onAnimationGroupLoopObservable=new U,this.onAnimationGroupEndObservable=new U,this.onAnimationGroupPauseObservable=new U,this.onAnimationGroupPlayObservable=new U,this.metadata=null,this._scene=e||Me.LastCreatedScene,this.uniqueId=this._scene.getUniqueId(),this._scene.addAnimationGroup(this)}return Object.defineProperty(r.prototype,"from",{get:function(){return this._from},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"to",{get:function(){return this._to},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"isStarted",{get:function(){return this._isStarted},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"isPlaying",{get:function(){return this._isStarted&&!this._isPaused},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"speedRatio",{get:function(){return this._speedRatio},set:function(n){if(this._speedRatio!==n){this._speedRatio=n;for(var e=0;e<this._animatables.length;e++){var t=this._animatables[e];t.speedRatio=this._speedRatio}}},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"loopAnimation",{get:function(){return this._loopAnimation},set:function(n){if(this._loopAnimation!==n){this._loopAnimation=n;for(var e=0;e<this._animatables.length;e++){var t=this._animatables[e];t.loopAnimation=this._loopAnimation}}},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"isAdditive",{get:function(){return this._isAdditive},set:function(n){if(this._isAdditive!==n){this._isAdditive=n;for(var e=0;e<this._animatables.length;e++){var t=this._animatables[e];t.isAdditive=this._isAdditive}}},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"targetedAnimations",{get:function(){return this._targetedAnimations},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"animatables",{get:function(){return this._animatables},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"children",{get:function(){return this._targetedAnimations},enumerable:!1,configurable:!0}),r.prototype.addTargetedAnimation=function(n,e){var t=new Fa;t.animation=n,t.target=e;var i=n.getKeys();return this._from>i[0].frame&&(this._from=i[0].frame),this._to<i[i.length-1].frame&&(this._to=i[i.length-1].frame),this._targetedAnimations.push(t),t},r.prototype.normalize=function(n,e){n===void 0&&(n=null),e===void 0&&(e=null),n==null&&(n=this._from),e==null&&(e=this._to);for(var t=0;t<this._targetedAnimations.length;t++){var i=this._targetedAnimations[t],o=i.animation.getKeys(),a=o[0],s=o[o.length-1];if(a.frame>n){var c={frame:n,value:a.value,inTangent:a.inTangent,outTangent:a.outTangent,interpolation:a.interpolation};o.splice(0,0,c)}if(s.frame<e){var c={frame:e,value:s.value,inTangent:s.inTangent,outTangent:s.outTangent,interpolation:s.interpolation};o.push(c)}}return this._from=n,this._to=e,this},r.prototype._processLoop=function(n,e,t){var i=this;n.onAnimationLoop=function(){i.onAnimationLoopObservable.notifyObservers(e),!i._animationLoopFlags[t]&&(i._animationLoopFlags[t]=!0,i._animationLoopCount++,i._animationLoopCount===i._targetedAnimations.length&&(i.onAnimationGroupLoopObservable.notifyObservers(i),i._animationLoopCount=0,i._animationLoopFlags=[]))}},r.prototype.start=function(n,e,t,i,o){var a=this;if(n===void 0&&(n=!1),e===void 0&&(e=1),this._isStarted||this._targetedAnimations.length===0)return this;this._loopAnimation=n,this._animationLoopCount=0,this._animationLoopFlags=[];for(var s=function(u){var f=c._targetedAnimations[u],d=c._scene.beginDirectAnimation(f.target,[f.animation],t!==void 0?t:c._from,i!==void 0?i:c._to,n,e,void 0,void 0,o!==void 0?o:c._isAdditive);d.onAnimationEnd=function(){a.onAnimationEndObservable.notifyObservers(f),a._checkAnimationGroupEnded(d)},c._processLoop(d,f,u),c._animatables.push(d)},c=this,l=0;l<this._targetedAnimations.length;l++)s(l);return this._speedRatio=e,this._isStarted=!0,this._isPaused=!1,this.onAnimationGroupPlayObservable.notifyObservers(this),this},r.prototype.pause=function(){if(!this._isStarted)return this;this._isPaused=!0;for(var n=0;n<this._animatables.length;n++){var e=this._animatables[n];e.pause()}return this.onAnimationGroupPauseObservable.notifyObservers(this),this},r.prototype.play=function(n){return this.isStarted&&this._animatables.length===this._targetedAnimations.length?(n!==void 0&&(this.loopAnimation=n),this.restart()):(this.stop(),this.start(n,this._speedRatio)),this._isPaused=!1,this},r.prototype.reset=function(){if(!this._isStarted)return this.play(),this.goToFrame(0),this.stop(),this;for(var n=0;n<this._animatables.length;n++){var e=this._animatables[n];e.reset()}return this},r.prototype.restart=function(){if(!this._isStarted)return this;for(var n=0;n<this._animatables.length;n++){var e=this._animatables[n];e.restart()}return this.onAnimationGroupPlayObservable.notifyObservers(this),this},r.prototype.stop=function(){if(!this._isStarted)return this;for(var n=this._animatables.slice(),e=0;e<n.length;e++)n[e].stop();return this._isStarted=!1,this},r.prototype.setWeightForAllAnimatables=function(n){for(var e=0;e<this._animatables.length;e++){var t=this._animatables[e];t.weight=n}return this},r.prototype.syncAllAnimationsWith=function(n){for(var e=0;e<this._animatables.length;e++){var t=this._animatables[e];t.syncWith(n)}return this},r.prototype.goToFrame=function(n){if(!this._isStarted)return this;for(var e=0;e<this._animatables.length;e++){var t=this._animatables[e];t.goToFrame(n)}return this},r.prototype.dispose=function(){this._targetedAnimations=[],this._animatables=[];var n=this._scene.animationGroups.indexOf(this);if(n>-1&&this._scene.animationGroups.splice(n,1),this._parentContainer){var e=this._parentContainer.animationGroups.indexOf(this);e>-1&&this._parentContainer.animationGroups.splice(e,1),this._parentContainer=null}this.onAnimationEndObservable.clear(),this.onAnimationGroupEndObservable.clear(),this.onAnimationGroupPauseObservable.clear(),this.onAnimationGroupPlayObservable.clear(),this.onAnimationLoopObservable.clear(),this.onAnimationGroupLoopObservable.clear()},r.prototype._checkAnimationGroupEnded=function(n){var e=this._animatables.indexOf(n);e>-1&&this._animatables.splice(e,1),this._animatables.length===0&&(this._isStarted=!1,this.onAnimationGroupEndObservable.notifyObservers(this))},r.prototype.clone=function(n,e,t){t===void 0&&(t=!1);for(var i=new r(n||this.name,this._scene),o=0,a=this._targetedAnimations;o<a.length;o++){var s=a[o];i.addTargetedAnimation(t?s.animation.clone():s.animation,e?e(s.target):s.target)}return i},r.prototype.serialize=function(){var n={};n.name=this.name,n.from=this.from,n.to=this.to,n.targetedAnimations=[];for(var e=0;e<this.targetedAnimations.length;e++){var t=this.targetedAnimations[e];n.targetedAnimations[e]=t.serialize()}return Ft&&Ft.HasTags(this)&&(n.tags=Ft.GetTags(this)),this.metadata&&(n.metadata=this.metadata),n},r.Parse=function(n,e){for(var t=new r(n.name,e),i=0;i<n.targetedAnimations.length;i++){var o=n.targetedAnimations[i],a=J.Parse(o.animation),s=o.targetId;if(o.animation.property==="influence"){var c=e.getMorphTargetById(s);c&&t.addTargetedAnimation(a,c)}else{var l=e.getNodeById(s);l!=null&&t.addTargetedAnimation(a,l)}}return n.from!==null&&n.to!==null&&t.normalize(n.from,n.to),Ft&&Ft.AddTagsTo(t,n.tags),n.metadata!==void 0&&(t.metadata=n.metadata),t},r.MakeAnimationAdditive=function(n,e,t,i,o){e===void 0&&(e=0),i===void 0&&(i=!1);var a=n;i&&(a=n.clone(o||a.name));for(var s=a.targetedAnimations,c=0;c<s.length;c++){var l=s[c];J.MakeAnimationAdditive(l.animation,e,t)}return a.isAdditive=!0,a},r.prototype.getClassName=function(){return"AnimationGroup"},r.prototype.toString=function(n){var e="Name: "+this.name;return e+=", type: "+this.getClassName(),n&&(e+=", from: "+this._from,e+=", to: "+this._to,e+=", isStarted: "+this._isStarted,e+=", speedRatio: "+this._speedRatio,e+=", targetedAnimations length: "+this._targetedAnimations.length,e+=", animatables length: "+this._animatables),e},r}(),Ba=function(r){R(n,r);function n(){var e=r!==null&&r.apply(this,arguments)||this;return e.BRDF_V_HEIGHT_CORRELATED=!1,e.MS_BRDF_ENERGY_CONSERVATION=!1,e.SPHERICAL_HARMONICS=!1,e.SPECULAR_GLOSSINESS_ENERGY_CONSERVATION=!1,e}return n}(mt),wa=function(r){R(n,r);function n(e,t){t===void 0&&(t=!0);var i=r.call(this,e,"PBRBRDF",90,new Ba,t)||this;return i._useEnergyConservation=n.DEFAULT_USE_ENERGY_CONSERVATION,i.useEnergyConservation=n.DEFAULT_USE_ENERGY_CONSERVATION,i._useSmithVisibilityHeightCorrelated=n.DEFAULT_USE_SMITH_VISIBILITY_HEIGHT_CORRELATED,i.useSmithVisibilityHeightCorrelated=n.DEFAULT_USE_SMITH_VISIBILITY_HEIGHT_CORRELATED,i._useSphericalHarmonics=n.DEFAULT_USE_SPHERICAL_HARMONICS,i.useSphericalHarmonics=n.DEFAULT_USE_SPHERICAL_HARMONICS,i._useSpecularGlossinessInputEnergyConservation=n.DEFAULT_USE_SPECULAR_GLOSSINESS_INPUT_ENERGY_CONSERVATION,i.useSpecularGlossinessInputEnergyConservation=n.DEFAULT_USE_SPECULAR_GLOSSINESS_INPUT_ENERGY_CONSERVATION,i._internalMarkAllSubMeshesAsMiscDirty=e._dirtyCallbacks[16],i._enable(!0),i}return n.prototype._markAllSubMeshesAsMiscDirty=function(){this._internalMarkAllSubMeshesAsMiscDirty()},n.prototype.prepareDefines=function(e){e.BRDF_V_HEIGHT_CORRELATED=this._useSmithVisibilityHeightCorrelated,e.MS_BRDF_ENERGY_CONSERVATION=this._useEnergyConservation&&this._useSmithVisibilityHeightCorrelated,e.SPHERICAL_HARMONICS=this._useSphericalHarmonics,e.SPECULAR_GLOSSINESS_ENERGY_CONSERVATION=this._useSpecularGlossinessInputEnergyConservation},n.prototype.getClassName=function(){return"PBRBRDFConfiguration"},n.DEFAULT_USE_ENERGY_CONSERVATION=!0,n.DEFAULT_USE_SMITH_VISIBILITY_HEIGHT_CORRELATED=!0,n.DEFAULT_USE_SPHERICAL_HARMONICS=!0,n.DEFAULT_USE_SPECULAR_GLOSSINESS_INPUT_ENERGY_CONSERVATION=!0,E([T(),N("_markAllSubMeshesAsMiscDirty")],n.prototype,"useEnergyConservation",void 0),E([T(),N("_markAllSubMeshesAsMiscDirty")],n.prototype,"useSmithVisibilityHeightCorrelated",void 0),E([T(),N("_markAllSubMeshesAsMiscDirty")],n.prototype,"useSphericalHarmonics",void 0),E([T(),N("_markAllSubMeshesAsMiscDirty")],n.prototype,"useSpecularGlossinessInputEnergyConservation",void 0),n}(Yt),Va="pbrFragmentDeclaration",Ua=`uniform vec4 vEyePosition;
uniform vec3 vReflectionColor;
uniform vec4 vAlbedoColor;
uniform vec4 vLightingIntensity;
uniform vec4 vReflectivityColor;
uniform vec4 vMetallicReflectanceFactors;
uniform vec3 vEmissiveColor;
uniform float visibility;
uniform vec3 vAmbientColor;
#ifdef ALBEDO
uniform vec2 vAlbedoInfos;
#endif
#ifdef AMBIENT
uniform vec4 vAmbientInfos;
#endif
#ifdef BUMP
uniform vec3 vBumpInfos;
uniform vec2 vTangentSpaceParams;
#endif
#ifdef OPACITY
uniform vec2 vOpacityInfos;
#endif
#ifdef EMISSIVE
uniform vec2 vEmissiveInfos;
#endif
#ifdef LIGHTMAP
uniform vec2 vLightmapInfos;
#endif
#ifdef REFLECTIVITY
uniform vec3 vReflectivityInfos;
#endif
#ifdef MICROSURFACEMAP
uniform vec2 vMicroSurfaceSamplerInfos;
#endif
#if defined(REFLECTIONMAP_SPHERICAL) || defined(REFLECTIONMAP_PROJECTION) || defined(SS_REFRACTION) || defined(PREPASS)
uniform mat4 view;
#endif
#ifdef REFLECTION
uniform vec2 vReflectionInfos;
#ifdef REALTIME_FILTERING
uniform vec2 vReflectionFilteringInfo;
#endif
uniform mat4 reflectionMatrix;
uniform vec3 vReflectionMicrosurfaceInfos;
#if defined(USE_LOCAL_REFLECTIONMAP_CUBIC) && defined(REFLECTIONMAP_CUBIC)
uniform vec3 vReflectionPosition;
uniform vec3 vReflectionSize; 
#endif
#endif
#if defined(SS_REFRACTION) && defined(SS_USE_LOCAL_REFRACTIONMAP_CUBIC)
uniform vec3 vRefractionPosition;
uniform vec3 vRefractionSize; 
#endif
#ifdef CLEARCOAT
uniform vec2 vClearCoatParams;
uniform vec4 vClearCoatRefractionParams;
#if defined(CLEARCOAT_TEXTURE) || defined(CLEARCOAT_TEXTURE_ROUGHNESS)
uniform vec4 vClearCoatInfos;
#endif
#ifdef CLEARCOAT_TEXTURE
uniform mat4 clearCoatMatrix;
#endif
#ifdef CLEARCOAT_TEXTURE_ROUGHNESS
uniform mat4 clearCoatRoughnessMatrix;
#endif
#ifdef CLEARCOAT_BUMP
uniform vec2 vClearCoatBumpInfos;
uniform vec2 vClearCoatTangentSpaceParams;
uniform mat4 clearCoatBumpMatrix;
#endif
#ifdef CLEARCOAT_TINT
uniform vec4 vClearCoatTintParams;
uniform float clearCoatColorAtDistance;
#ifdef CLEARCOAT_TINT_TEXTURE
uniform vec2 vClearCoatTintInfos;
uniform mat4 clearCoatTintMatrix;
#endif
#endif
#endif
#ifdef ANISOTROPIC
uniform vec3 vAnisotropy;
#ifdef ANISOTROPIC_TEXTURE
uniform vec2 vAnisotropyInfos;
uniform mat4 anisotropyMatrix;
#endif
#endif
#ifdef SHEEN
uniform vec4 vSheenColor;
#ifdef SHEEN_ROUGHNESS
uniform float vSheenRoughness;
#endif
#if defined(SHEEN_TEXTURE) || defined(SHEEN_TEXTURE_ROUGHNESS)
uniform vec4 vSheenInfos;
#endif
#ifdef SHEEN_TEXTURE
uniform mat4 sheenMatrix;
#endif
#ifdef SHEEN_TEXTURE_ROUGHNESS
uniform mat4 sheenRoughnessMatrix;
#endif
#endif
#ifdef SUBSURFACE
#ifdef SS_REFRACTION
uniform vec4 vRefractionMicrosurfaceInfos;
uniform vec4 vRefractionInfos;
uniform mat4 refractionMatrix;
#ifdef REALTIME_FILTERING
uniform vec2 vRefractionFilteringInfo;
#endif
#endif
#ifdef SS_THICKNESSANDMASK_TEXTURE
uniform vec2 vThicknessInfos;
uniform mat4 thicknessMatrix;
#endif
#ifdef SS_REFRACTIONINTENSITY_TEXTURE
uniform vec2 vRefractionIntensityInfos;
uniform mat4 refractionIntensityMatrix;
#endif
#ifdef SS_TRANSLUCENCYINTENSITY_TEXTURE
uniform vec2 vTranslucencyIntensityInfos;
uniform mat4 translucencyIntensityMatrix;
#endif
uniform vec2 vThicknessParam;
uniform vec3 vDiffusionDistance;
uniform vec4 vTintColor;
uniform vec3 vSubSurfaceIntensity;
#endif
#ifdef PREPASS
#ifdef SS_SCATTERING
uniform float scatteringDiffusionProfile;
#endif
#endif
#if DEBUGMODE>0
uniform vec2 vDebugMode;
#endif
#ifdef DETAIL
uniform vec4 vDetailInfos;
#endif
#ifdef USESPHERICALFROMREFLECTIONMAP
#ifdef SPHERICAL_HARMONICS
uniform vec3 vSphericalL00;
uniform vec3 vSphericalL1_1;
uniform vec3 vSphericalL10;
uniform vec3 vSphericalL11;
uniform vec3 vSphericalL2_2;
uniform vec3 vSphericalL2_1;
uniform vec3 vSphericalL20;
uniform vec3 vSphericalL21;
uniform vec3 vSphericalL22;
#else
uniform vec3 vSphericalX;
uniform vec3 vSphericalY;
uniform vec3 vSphericalZ;
uniform vec3 vSphericalXX_ZZ;
uniform vec3 vSphericalYY_ZZ;
uniform vec3 vSphericalZZ;
uniform vec3 vSphericalXY;
uniform vec3 vSphericalYZ;
uniform vec3 vSphericalZX;
#endif
#endif
#define ADDITIONAL_FRAGMENT_DECLARATION
`;oe.IncludesShadersStore[Va]=Ua;var ka="pbrUboDeclaration",Ga=`layout(std140,column_major) uniform;
uniform Material {
vec2 vAlbedoInfos;
vec4 vAmbientInfos;
vec2 vOpacityInfos;
vec2 vEmissiveInfos;
vec2 vLightmapInfos;
vec3 vReflectivityInfos;
vec2 vMicroSurfaceSamplerInfos;
vec2 vReflectionInfos;
vec2 vReflectionFilteringInfo;
vec3 vReflectionPosition;
vec3 vReflectionSize;
vec3 vBumpInfos;
mat4 albedoMatrix;
mat4 ambientMatrix;
mat4 opacityMatrix;
mat4 emissiveMatrix;
mat4 lightmapMatrix;
mat4 reflectivityMatrix;
mat4 microSurfaceSamplerMatrix;
mat4 bumpMatrix;
vec2 vTangentSpaceParams;
mat4 reflectionMatrix;
vec3 vReflectionColor;
vec4 vAlbedoColor;
vec4 vLightingIntensity;
vec3 vReflectionMicrosurfaceInfos;
float pointSize;
vec4 vReflectivityColor;
vec3 vEmissiveColor;
vec3 vAmbientColor;
vec2 vDebugMode;
vec4 vMetallicReflectanceFactors;
vec2 vMetallicReflectanceInfos;
mat4 metallicReflectanceMatrix;
vec2 vReflectanceInfos;
mat4 reflectanceMatrix;
vec3 vSphericalL00;
vec3 vSphericalL1_1;
vec3 vSphericalL10;
vec3 vSphericalL11;
vec3 vSphericalL2_2;
vec3 vSphericalL2_1;
vec3 vSphericalL20;
vec3 vSphericalL21;
vec3 vSphericalL22;
vec3 vSphericalX;
vec3 vSphericalY;
vec3 vSphericalZ;
vec3 vSphericalXX_ZZ;
vec3 vSphericalYY_ZZ;
vec3 vSphericalZZ;
vec3 vSphericalXY;
vec3 vSphericalYZ;
vec3 vSphericalZX;
#define ADDITIONAL_UBO_DECLARATION
};
#include<sceneUboDeclaration>
#include<meshUboDeclaration>
`;oe.IncludesShadersStore[ka]=Ga;var Ha="pbrFragmentExtraDeclaration",za=`varying vec3 vPositionW;
#if DEBUGMODE>0
varying vec4 vClipSpacePosition;
#endif
#include<mainUVVaryingDeclaration>[1..7]
#ifdef NORMAL
varying vec3 vNormalW;
#if defined(USESPHERICALFROMREFLECTIONMAP) && defined(USESPHERICALINVERTEX)
varying vec3 vEnvironmentIrradiance;
#endif
#endif
#if defined(VERTEXCOLOR) || defined(INSTANCESCOLOR)
varying vec4 vColor;
#endif
`;oe.IncludesShadersStore[Ha]=za;var Xa="samplerFragmentAlternateDeclaration",ja=`#ifdef _DEFINENAME_
#if _DEFINENAME_DIRECTUV==1
#define v_VARYINGNAME_UV vMainUV1
#elif _DEFINENAME_DIRECTUV==2
#define v_VARYINGNAME_UV vMainUV2
#elif _DEFINENAME_DIRECTUV==3
#define v_VARYINGNAME_UV vMainUV3
#elif _DEFINENAME_DIRECTUV==4
#define v_VARYINGNAME_UV vMainUV4
#elif _DEFINENAME_DIRECTUV==5
#define v_VARYINGNAME_UV vMainUV5
#elif _DEFINENAME_DIRECTUV==6
#define v_VARYINGNAME_UV vMainUV6
#else
varying vec2 v_VARYINGNAME_UV;
#endif
#endif
`;oe.IncludesShadersStore[Xa]=ja;var Ya="pbrFragmentSamplersDeclaration",Wa=`#include<samplerFragmentDeclaration>(_DEFINENAME_,ALBEDO,_VARYINGNAME_,Albedo,_SAMPLERNAME_,albedo)
#include<samplerFragmentDeclaration>(_DEFINENAME_,AMBIENT,_VARYINGNAME_,Ambient,_SAMPLERNAME_,ambient)
#include<samplerFragmentDeclaration>(_DEFINENAME_,OPACITY,_VARYINGNAME_,Opacity,_SAMPLERNAME_,opacity)
#include<samplerFragmentDeclaration>(_DEFINENAME_,EMISSIVE,_VARYINGNAME_,Emissive,_SAMPLERNAME_,emissive)
#include<samplerFragmentDeclaration>(_DEFINENAME_,LIGHTMAP,_VARYINGNAME_,Lightmap,_SAMPLERNAME_,lightmap)
#include<samplerFragmentDeclaration>(_DEFINENAME_,REFLECTIVITY,_VARYINGNAME_,Reflectivity,_SAMPLERNAME_,reflectivity)
#include<samplerFragmentDeclaration>(_DEFINENAME_,MICROSURFACEMAP,_VARYINGNAME_,MicroSurfaceSampler,_SAMPLERNAME_,microSurface)
#include<samplerFragmentDeclaration>(_DEFINENAME_,METALLIC_REFLECTANCE,_VARYINGNAME_,MetallicReflectance,_SAMPLERNAME_,metallicReflectance)
#include<samplerFragmentDeclaration>(_DEFINENAME_,REFLECTANCE,_VARYINGNAME_,Reflectance,_SAMPLERNAME_,reflectance)
#ifdef CLEARCOAT
#include<samplerFragmentDeclaration>(_DEFINENAME_,CLEARCOAT_TEXTURE,_VARYINGNAME_,ClearCoat,_SAMPLERNAME_,clearCoat)
#include<samplerFragmentAlternateDeclaration>(_DEFINENAME_,CLEARCOAT_TEXTURE_ROUGHNESS,_VARYINGNAME_,ClearCoatRoughness)
#if defined(CLEARCOAT_TEXTURE_ROUGHNESS) && !defined(CLEARCOAT_TEXTURE_ROUGHNESS_IDENTICAL)
uniform sampler2D clearCoatRoughnessSampler;
#endif
#include<samplerFragmentDeclaration>(_DEFINENAME_,CLEARCOAT_BUMP,_VARYINGNAME_,ClearCoatBump,_SAMPLERNAME_,clearCoatBump)
#include<samplerFragmentDeclaration>(_DEFINENAME_,CLEARCOAT_TINT_TEXTURE,_VARYINGNAME_,ClearCoatTint,_SAMPLERNAME_,clearCoatTint)
#endif
#ifdef SHEEN
#include<samplerFragmentDeclaration>(_DEFINENAME_,SHEEN_TEXTURE,_VARYINGNAME_,Sheen,_SAMPLERNAME_,sheen)
#include<samplerFragmentAlternateDeclaration>(_DEFINENAME_,SHEEN_TEXTURE_ROUGHNESS,_VARYINGNAME_,SheenRoughness)
#if defined(SHEEN_ROUGHNESS) && defined(SHEEN_TEXTURE_ROUGHNESS) && !defined(SHEEN_TEXTURE_ROUGHNESS_IDENTICAL)
uniform sampler2D sheenRoughnessSampler;
#endif
#endif
#ifdef ANISOTROPIC
#include<samplerFragmentDeclaration>(_DEFINENAME_,ANISOTROPIC_TEXTURE,_VARYINGNAME_,Anisotropy,_SAMPLERNAME_,anisotropy)
#endif
#ifdef REFLECTION
#ifdef REFLECTIONMAP_3D
#define sampleReflection(s,c) textureCube(s,c)
uniform samplerCube reflectionSampler;
#ifdef LODBASEDMICROSFURACE
#define sampleReflectionLod(s,c,l) textureCubeLodEXT(s,c,l)
#else
uniform samplerCube reflectionSamplerLow;
uniform samplerCube reflectionSamplerHigh;
#endif
#ifdef USEIRRADIANCEMAP
uniform samplerCube irradianceSampler;
#endif
#else
#define sampleReflection(s,c) texture2D(s,c)
uniform sampler2D reflectionSampler;
#ifdef LODBASEDMICROSFURACE
#define sampleReflectionLod(s,c,l) texture2DLodEXT(s,c,l)
#else
uniform sampler2D reflectionSamplerLow;
uniform sampler2D reflectionSamplerHigh;
#endif
#ifdef USEIRRADIANCEMAP
uniform sampler2D irradianceSampler;
#endif
#endif
#ifdef REFLECTIONMAP_SKYBOX
varying vec3 vPositionUVW;
#else
#if defined(REFLECTIONMAP_EQUIRECTANGULAR_FIXED) || defined(REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED)
varying vec3 vDirectionW;
#endif
#endif
#endif
#ifdef ENVIRONMENTBRDF
uniform sampler2D environmentBrdfSampler;
#endif
#ifdef SUBSURFACE
#ifdef SS_REFRACTION
#ifdef SS_REFRACTIONMAP_3D
#define sampleRefraction(s,c) textureCube(s,c)
uniform samplerCube refractionSampler;
#ifdef LODBASEDMICROSFURACE
#define sampleRefractionLod(s,c,l) textureCubeLodEXT(s,c,l)
#else
uniform samplerCube refractionSamplerLow;
uniform samplerCube refractionSamplerHigh;
#endif
#else
#define sampleRefraction(s,c) texture2D(s,c)
uniform sampler2D refractionSampler;
#ifdef LODBASEDMICROSFURACE
#define sampleRefractionLod(s,c,l) texture2DLodEXT(s,c,l)
#else
uniform sampler2D refractionSamplerLow;
uniform sampler2D refractionSamplerHigh;
#endif
#endif
#endif
#include<samplerFragmentDeclaration>(_DEFINENAME_,SS_THICKNESSANDMASK_TEXTURE,_VARYINGNAME_,Thickness,_SAMPLERNAME_,thickness)
#include<samplerFragmentDeclaration>(_DEFINENAME_,SS_REFRACTIONINTENSITY_TEXTURE,_VARYINGNAME_,RefractionIntensity,_SAMPLERNAME_,refractionIntensity)
#include<samplerFragmentDeclaration>(_DEFINENAME_,SS_TRANSLUCENCYINTENSITY_TEXTURE,_VARYINGNAME_,TranslucencyIntensity,_SAMPLERNAME_,translucencyIntensity)
#endif
`;oe.IncludesShadersStore[Ya]=Wa;var Ka="subSurfaceScatteringFunctions",Qa=`bool testLightingForSSS(float diffusionProfile)
{
return diffusionProfile<1.;
}`;oe.IncludesShadersStore[Ka]=Qa;var qa="pbrHelperFunctions",Za=`#define RECIPROCAL_PI2 0.15915494
#define RECIPROCAL_PI 0.31830988618
#define MINIMUMVARIANCE 0.0005
float convertRoughnessToAverageSlope(float roughness)
{
return square(roughness)+MINIMUMVARIANCE;
}
float fresnelGrazingReflectance(float reflectance0) {
float reflectance90=saturate(reflectance0*25.0);
return reflectance90;
}
vec2 getAARoughnessFactors(vec3 normalVector) {
#ifdef SPECULARAA
vec3 nDfdx=dFdx(normalVector.xyz);
vec3 nDfdy=dFdy(normalVector.xyz);
float slopeSquare=max(dot(nDfdx,nDfdx),dot(nDfdy,nDfdy));
float geometricRoughnessFactor=pow(saturate(slopeSquare),0.333);
float geometricAlphaGFactor=sqrt(slopeSquare);
geometricAlphaGFactor*=0.75;
return vec2(geometricRoughnessFactor,geometricAlphaGFactor);
#else
return vec2(0.);
#endif
}
#ifdef ANISOTROPIC
vec2 getAnisotropicRoughness(float alphaG,float anisotropy) {
float alphaT=max(alphaG*(1.0+anisotropy),MINIMUMVARIANCE);
float alphaB=max(alphaG*(1.0-anisotropy),MINIMUMVARIANCE);
return vec2(alphaT,alphaB);
}
vec3 getAnisotropicBentNormals(const vec3 T,const vec3 B,const vec3 N,const vec3 V,float anisotropy) {
vec3 anisotropicFrameDirection=anisotropy>=0.0 ? B : T;
vec3 anisotropicFrameTangent=cross(normalize(anisotropicFrameDirection),V);
vec3 anisotropicFrameNormal=cross(anisotropicFrameTangent,anisotropicFrameDirection);
vec3 anisotropicNormal=normalize(mix(N,anisotropicFrameNormal,abs(anisotropy)));
return anisotropicNormal;
}
#endif
#if defined(CLEARCOAT) || defined(SS_REFRACTION)
vec3 cocaLambert(vec3 alpha,float distance) {
return exp(-alpha*distance);
}
vec3 cocaLambert(float NdotVRefract,float NdotLRefract,vec3 alpha,float thickness) {
return cocaLambert(alpha,(thickness*((NdotLRefract+NdotVRefract)/(NdotLRefract*NdotVRefract))));
}
vec3 computeColorAtDistanceInMedia(vec3 color,float distance) {
return -log(color)/distance;
}
vec3 computeClearCoatAbsorption(float NdotVRefract,float NdotLRefract,vec3 clearCoatColor,float clearCoatThickness,float clearCoatIntensity) {
vec3 clearCoatAbsorption=mix(vec3(1.0),
cocaLambert(NdotVRefract,NdotLRefract,clearCoatColor,clearCoatThickness),
clearCoatIntensity);
return clearCoatAbsorption;
}
#endif
#ifdef MICROSURFACEAUTOMATIC
float computeDefaultMicroSurface(float microSurface,vec3 reflectivityColor)
{
const float kReflectivityNoAlphaWorkflow_SmoothnessMax=0.95;
float reflectivityLuminance=getLuminance(reflectivityColor);
float reflectivityLuma=sqrt(reflectivityLuminance);
microSurface=reflectivityLuma*kReflectivityNoAlphaWorkflow_SmoothnessMax;
return microSurface;
}
#endif
`;oe.IncludesShadersStore[qa]=Za;var Ja="harmonicsFunctions",$a=`#ifdef USESPHERICALFROMREFLECTIONMAP
#ifdef SPHERICAL_HARMONICS
vec3 computeEnvironmentIrradiance(vec3 normal) {
return vSphericalL00
+ vSphericalL1_1*(normal.y)
+ vSphericalL10*(normal.z)
+ vSphericalL11*(normal.x)
+ vSphericalL2_2*(normal.y*normal.x)
+ vSphericalL2_1*(normal.y*normal.z)
+ vSphericalL20*((3.0*normal.z*normal.z)-1.0)
+ vSphericalL21*(normal.z*normal.x)
+ vSphericalL22*(normal.x*normal.x-(normal.y*normal.y));
}
#else
vec3 computeEnvironmentIrradiance(vec3 normal) {
float Nx=normal.x;
float Ny=normal.y;
float Nz=normal.z;
vec3 C1=vSphericalZZ.rgb;
vec3 Cx=vSphericalX.rgb;
vec3 Cy=vSphericalY.rgb;
vec3 Cz=vSphericalZ.rgb;
vec3 Cxx_zz=vSphericalXX_ZZ.rgb;
vec3 Cyy_zz=vSphericalYY_ZZ.rgb;
vec3 Cxy=vSphericalXY.rgb;
vec3 Cyz=vSphericalYZ.rgb;
vec3 Czx=vSphericalZX.rgb;
vec3 a1=Cyy_zz*Ny+Cy;
vec3 a2=Cyz*Nz+a1;
vec3 b1=Czx*Nz+Cx;
vec3 b2=Cxy*Ny+b1;
vec3 b3=Cxx_zz*Nx+b2;
vec3 t1=Cz *Nz+C1;
vec3 t2=a2 *Ny+t1;
vec3 t3=b3 *Nx+t2;
return t3;
}
#endif
#endif
`;oe.IncludesShadersStore[Ja]=$a;var es="pbrDirectLightingSetupFunctions",ts=`struct preLightingInfo
{
vec3 lightOffset;
float lightDistanceSquared;
float lightDistance;
float attenuation;
vec3 L;
vec3 H;
float NdotV;
float NdotLUnclamped;
float NdotL;
float VdotH;
float roughness;
};
preLightingInfo computePointAndSpotPreLightingInfo(vec4 lightData,vec3 V,vec3 N) {
preLightingInfo result;
result.lightOffset=lightData.xyz-vPositionW;
result.lightDistanceSquared=dot(result.lightOffset,result.lightOffset);
result.lightDistance=sqrt(result.lightDistanceSquared);
result.L=normalize(result.lightOffset);
result.H=normalize(V+result.L);
result.VdotH=saturate(dot(V,result.H));
result.NdotLUnclamped=dot(N,result.L);
result.NdotL=saturateEps(result.NdotLUnclamped);
return result;
}
preLightingInfo computeDirectionalPreLightingInfo(vec4 lightData,vec3 V,vec3 N) {
preLightingInfo result;
result.lightDistance=length(-lightData.xyz);
result.L=normalize(-lightData.xyz);
result.H=normalize(V+result.L);
result.VdotH=saturate(dot(V,result.H));
result.NdotLUnclamped=dot(N,result.L);
result.NdotL=saturateEps(result.NdotLUnclamped);
return result;
}
preLightingInfo computeHemisphericPreLightingInfo(vec4 lightData,vec3 V,vec3 N) {
preLightingInfo result;
result.NdotL=dot(N,lightData.xyz)*0.5+0.5;
result.NdotL=saturateEps(result.NdotL);
result.NdotLUnclamped=result.NdotL;
#ifdef SPECULARTERM
result.L=normalize(lightData.xyz);
result.H=normalize(V+result.L);
result.VdotH=saturate(dot(V,result.H));
#endif
return result;
}`;oe.IncludesShadersStore[es]=ts;var ns="pbrDirectLightingFalloffFunctions",is=`float computeDistanceLightFalloff_Standard(vec3 lightOffset,float range)
{
return max(0.,1.0-length(lightOffset)/range);
}
float computeDistanceLightFalloff_Physical(float lightDistanceSquared)
{
return 1.0/maxEps(lightDistanceSquared);
}
float computeDistanceLightFalloff_GLTF(float lightDistanceSquared,float inverseSquaredRange)
{
float lightDistanceFalloff=1.0/maxEps(lightDistanceSquared);
float factor=lightDistanceSquared*inverseSquaredRange;
float attenuation=saturate(1.0-factor*factor);
attenuation*=attenuation;
lightDistanceFalloff*=attenuation;
return lightDistanceFalloff;
}
float computeDistanceLightFalloff(vec3 lightOffset,float lightDistanceSquared,float range,float inverseSquaredRange)
{
#ifdef USEPHYSICALLIGHTFALLOFF
return computeDistanceLightFalloff_Physical(lightDistanceSquared);
#elif defined(USEGLTFLIGHTFALLOFF)
return computeDistanceLightFalloff_GLTF(lightDistanceSquared,inverseSquaredRange);
#else
return computeDistanceLightFalloff_Standard(lightOffset,range);
#endif
}
float computeDirectionalLightFalloff_Standard(vec3 lightDirection,vec3 directionToLightCenterW,float cosHalfAngle,float exponent)
{
float falloff=0.0;
float cosAngle=maxEps(dot(-lightDirection,directionToLightCenterW));
if (cosAngle>=cosHalfAngle)
{
falloff=max(0.,pow(cosAngle,exponent));
}
return falloff;
}
float computeDirectionalLightFalloff_Physical(vec3 lightDirection,vec3 directionToLightCenterW,float cosHalfAngle)
{
const float kMinusLog2ConeAngleIntensityRatio=6.64385618977; 
float concentrationKappa=kMinusLog2ConeAngleIntensityRatio/(1.0-cosHalfAngle);
vec4 lightDirectionSpreadSG=vec4(-lightDirection*concentrationKappa,-concentrationKappa);
float falloff=exp2(dot(vec4(directionToLightCenterW,1.0),lightDirectionSpreadSG));
return falloff;
}
float computeDirectionalLightFalloff_GLTF(vec3 lightDirection,vec3 directionToLightCenterW,float lightAngleScale,float lightAngleOffset)
{
float cd=dot(-lightDirection,directionToLightCenterW);
float falloff=saturate(cd*lightAngleScale+lightAngleOffset);
falloff*=falloff;
return falloff;
}
float computeDirectionalLightFalloff(vec3 lightDirection,vec3 directionToLightCenterW,float cosHalfAngle,float exponent,float lightAngleScale,float lightAngleOffset)
{
#ifdef USEPHYSICALLIGHTFALLOFF
return computeDirectionalLightFalloff_Physical(lightDirection,directionToLightCenterW,cosHalfAngle);
#elif defined(USEGLTFLIGHTFALLOFF)
return computeDirectionalLightFalloff_GLTF(lightDirection,directionToLightCenterW,lightAngleScale,lightAngleOffset);
#else
return computeDirectionalLightFalloff_Standard(lightDirection,directionToLightCenterW,cosHalfAngle,exponent);
#endif
}`;oe.IncludesShadersStore[ns]=is;var rs="pbrDirectLightingFunctions",os=`#define CLEARCOATREFLECTANCE90 1.0
struct lightingInfo
{
vec3 diffuse;
#ifdef SPECULARTERM
vec3 specular;
#endif
#ifdef CLEARCOAT
vec4 clearCoat;
#endif
#ifdef SHEEN
vec3 sheen;
#endif
};
float adjustRoughnessFromLightProperties(float roughness,float lightRadius,float lightDistance) {
#if defined(USEPHYSICALLIGHTFALLOFF) || defined(USEGLTFLIGHTFALLOFF)
float lightRoughness=lightRadius/lightDistance;
float totalRoughness=saturate(lightRoughness+roughness);
return totalRoughness;
#else
return roughness;
#endif
}
vec3 computeHemisphericDiffuseLighting(preLightingInfo info,vec3 lightColor,vec3 groundColor) {
return mix(groundColor,lightColor,info.NdotL);
}
vec3 computeDiffuseLighting(preLightingInfo info,vec3 lightColor) {
float diffuseTerm=diffuseBRDF_Burley(info.NdotL,info.NdotV,info.VdotH,info.roughness);
return diffuseTerm*info.attenuation*info.NdotL*lightColor;
}
#define inline
vec3 computeProjectionTextureDiffuseLighting(sampler2D projectionLightSampler,mat4 textureProjectionMatrix){
vec4 strq=textureProjectionMatrix*vec4(vPositionW,1.0);
strq/=strq.w;
vec3 textureColor=texture2D(projectionLightSampler,strq.xy).rgb;
return toLinearSpace(textureColor);
}
#ifdef SS_TRANSLUCENCY
vec3 computeDiffuseAndTransmittedLighting(preLightingInfo info,vec3 lightColor,vec3 transmittance) {
float NdotL=absEps(info.NdotLUnclamped);
float wrapNdotL=computeWrappedDiffuseNdotL(NdotL,0.02);
float trAdapt=step(0.,info.NdotLUnclamped);
vec3 transmittanceNdotL=mix(transmittance*wrapNdotL,vec3(wrapNdotL),trAdapt);
float diffuseTerm=diffuseBRDF_Burley(NdotL,info.NdotV,info.VdotH,info.roughness);
return diffuseTerm*transmittanceNdotL*info.attenuation*lightColor;
}
#endif
#ifdef SPECULARTERM
vec3 computeSpecularLighting(preLightingInfo info,vec3 N,vec3 reflectance0,vec3 reflectance90,float geometricRoughnessFactor,vec3 lightColor) {
float NdotH=saturateEps(dot(N,info.H));
float roughness=max(info.roughness,geometricRoughnessFactor);
float alphaG=convertRoughnessToAverageSlope(roughness);
vec3 fresnel=fresnelSchlickGGX(info.VdotH,reflectance0,reflectance90);
float distribution=normalDistributionFunction_TrowbridgeReitzGGX(NdotH,alphaG);
#ifdef BRDF_V_HEIGHT_CORRELATED
float smithVisibility=smithVisibility_GGXCorrelated(info.NdotL,info.NdotV,alphaG);
#else
float smithVisibility=smithVisibility_TrowbridgeReitzGGXFast(info.NdotL,info.NdotV,alphaG);
#endif
vec3 specTerm=fresnel*distribution*smithVisibility;
return specTerm*info.attenuation*info.NdotL*lightColor;
}
#endif
#ifdef ANISOTROPIC
vec3 computeAnisotropicSpecularLighting(preLightingInfo info,vec3 V,vec3 N,vec3 T,vec3 B,float anisotropy,vec3 reflectance0,vec3 reflectance90,float geometricRoughnessFactor,vec3 lightColor) {
float NdotH=saturateEps(dot(N,info.H));
float TdotH=dot(T,info.H);
float BdotH=dot(B,info.H);
float TdotV=dot(T,V);
float BdotV=dot(B,V);
float TdotL=dot(T,info.L);
float BdotL=dot(B,info.L);
float alphaG=convertRoughnessToAverageSlope(info.roughness);
vec2 alphaTB=getAnisotropicRoughness(alphaG,anisotropy);
alphaTB=max(alphaTB,square(geometricRoughnessFactor));
vec3 fresnel=fresnelSchlickGGX(info.VdotH,reflectance0,reflectance90);
float distribution=normalDistributionFunction_BurleyGGX_Anisotropic(NdotH,TdotH,BdotH,alphaTB);
float smithVisibility=smithVisibility_GGXCorrelated_Anisotropic(info.NdotL,info.NdotV,TdotV,BdotV,TdotL,BdotL,alphaTB);
vec3 specTerm=fresnel*distribution*smithVisibility;
return specTerm*info.attenuation*info.NdotL*lightColor;
}
#endif
#ifdef CLEARCOAT
vec4 computeClearCoatLighting(preLightingInfo info,vec3 Ncc,float geometricRoughnessFactor,float clearCoatIntensity,vec3 lightColor) {
float NccdotL=saturateEps(dot(Ncc,info.L));
float NccdotH=saturateEps(dot(Ncc,info.H));
float clearCoatRoughness=max(info.roughness,geometricRoughnessFactor);
float alphaG=convertRoughnessToAverageSlope(clearCoatRoughness);
float fresnel=fresnelSchlickGGX(info.VdotH,vClearCoatRefractionParams.x,CLEARCOATREFLECTANCE90);
fresnel*=clearCoatIntensity;
float distribution=normalDistributionFunction_TrowbridgeReitzGGX(NccdotH,alphaG);
float kelemenVisibility=visibility_Kelemen(info.VdotH);
float clearCoatTerm=fresnel*distribution*kelemenVisibility;
return vec4(
clearCoatTerm*info.attenuation*NccdotL*lightColor,
1.0-fresnel
);
}
vec3 computeClearCoatLightingAbsorption(float NdotVRefract,vec3 L,vec3 Ncc,vec3 clearCoatColor,float clearCoatThickness,float clearCoatIntensity) {
vec3 LRefract=-refract(L,Ncc,vClearCoatRefractionParams.y);
float NdotLRefract=saturateEps(dot(Ncc,LRefract));
vec3 absorption=computeClearCoatAbsorption(NdotVRefract,NdotLRefract,clearCoatColor,clearCoatThickness,clearCoatIntensity);
return absorption;
}
#endif
#ifdef SHEEN
vec3 computeSheenLighting(preLightingInfo info,vec3 N,vec3 reflectance0,vec3 reflectance90,float geometricRoughnessFactor,vec3 lightColor) {
float NdotH=saturateEps(dot(N,info.H));
float roughness=max(info.roughness,geometricRoughnessFactor);
float alphaG=convertRoughnessToAverageSlope(roughness);
float fresnel=1.;
float distribution=normalDistributionFunction_CharlieSheen(NdotH,alphaG);
/*#ifdef SHEEN_SOFTER
float visibility=visibility_CharlieSheen(info.NdotL,info.NdotV,alphaG);
#else */
float visibility=visibility_Ashikhmin(info.NdotL,info.NdotV);
/* #endif */
float sheenTerm=fresnel*distribution*visibility;
return sheenTerm*info.attenuation*info.NdotL*lightColor;
}
#endif
`;oe.IncludesShadersStore[rs]=os;var as="pbrIBLFunctions",ss=`#if defined(REFLECTION) || defined(SS_REFRACTION)
float getLodFromAlphaG(float cubeMapDimensionPixels,float microsurfaceAverageSlope) {
float microsurfaceAverageSlopeTexels=cubeMapDimensionPixels*microsurfaceAverageSlope;
float lod=log2(microsurfaceAverageSlopeTexels);
return lod;
}
float getLinearLodFromRoughness(float cubeMapDimensionPixels,float roughness) {
float lod=log2(cubeMapDimensionPixels)*roughness;
return lod;
}
#endif
#if defined(ENVIRONMENTBRDF) && defined(RADIANCEOCCLUSION)
float environmentRadianceOcclusion(float ambientOcclusion,float NdotVUnclamped) {
float temp=NdotVUnclamped+ambientOcclusion;
return saturate(square(temp)-1.0+ambientOcclusion);
}
#endif
#if defined(ENVIRONMENTBRDF) && defined(HORIZONOCCLUSION)
float environmentHorizonOcclusion(vec3 view,vec3 normal,vec3 geometricNormal) {
vec3 reflection=reflect(view,normal);
float temp=saturate(1.0+1.1*dot(reflection,geometricNormal));
return square(temp);
}
#endif
#if defined(LODINREFLECTIONALPHA) || defined(SS_LODINREFRACTIONALPHA)
#define UNPACK_LOD(x) (1.0-x)*255.0
float getLodFromAlphaG(float cubeMapDimensionPixels,float alphaG,float NdotV) {
float microsurfaceAverageSlope=alphaG;
microsurfaceAverageSlope*=sqrt(abs(NdotV));
return getLodFromAlphaG(cubeMapDimensionPixels,microsurfaceAverageSlope);
}
#endif
`;oe.IncludesShadersStore[as]=ss;var cs="pbrBlockAlbedoOpacity",ls=`struct albedoOpacityOutParams
{
vec3 surfaceAlbedo;
float alpha;
};
#define pbr_inline
void albedoOpacityBlock(
in vec4 vAlbedoColor,
#ifdef ALBEDO
in vec4 albedoTexture,
in vec2 albedoInfos,
#endif
#ifdef OPACITY
in vec4 opacityMap,
in vec2 vOpacityInfos,
#endif
#ifdef DETAIL
in vec4 detailColor,
in vec4 vDetailInfos,
#endif
out albedoOpacityOutParams outParams
)
{
vec3 surfaceAlbedo=vAlbedoColor.rgb;
float alpha=vAlbedoColor.a;
#ifdef ALBEDO
#if defined(ALPHAFROMALBEDO) || defined(ALPHATEST)
alpha*=albedoTexture.a;
#endif
#ifdef GAMMAALBEDO
surfaceAlbedo*=toLinearSpace(albedoTexture.rgb);
#else
surfaceAlbedo*=albedoTexture.rgb;
#endif
surfaceAlbedo*=albedoInfos.y;
#endif
#if defined(VERTEXCOLOR) || defined(INSTANCESCOLOR)
surfaceAlbedo*=vColor.rgb;
#endif
#ifdef DETAIL
float detailAlbedo=2.0*mix(0.5,detailColor.r,vDetailInfos.y);
surfaceAlbedo.rgb=surfaceAlbedo.rgb*detailAlbedo*detailAlbedo; 
#endif
#define CUSTOM_FRAGMENT_UPDATE_ALBEDO
#ifdef OPACITY
#ifdef OPACITYRGB
alpha=getLuminance(opacityMap.rgb);
#else
alpha*=opacityMap.a;
#endif
alpha*=vOpacityInfos.y;
#endif
#ifdef VERTEXALPHA
alpha*=vColor.a;
#endif
#if !defined(SS_LINKREFRACTIONTOTRANSPARENCY) && !defined(ALPHAFRESNEL)
#ifdef ALPHATEST
if (alpha<ALPHATESTVALUE)
discard;
#ifndef ALPHABLEND
alpha=1.0;
#endif
#endif
#endif
outParams.surfaceAlbedo=surfaceAlbedo;
outParams.alpha=alpha;
}
`;oe.IncludesShadersStore[cs]=ls;var us="pbrBlockReflectivity",fs=`struct reflectivityOutParams
{
float microSurface;
float roughness;
vec3 surfaceReflectivityColor;
#ifdef METALLICWORKFLOW
vec3 surfaceAlbedo;
#endif
#if defined(METALLICWORKFLOW) && defined(REFLECTIVITY) && defined(AOSTOREINMETALMAPRED)
vec3 ambientOcclusionColor;
#endif
#if DEBUGMODE>0
vec4 surfaceMetallicColorMap;
vec4 surfaceReflectivityColorMap;
vec2 metallicRoughness;
vec3 metallicF0;
#endif
};
#define pbr_inline
void reflectivityBlock(
in vec4 vReflectivityColor,
#ifdef METALLICWORKFLOW
in vec3 surfaceAlbedo,
in vec4 metallicReflectanceFactors,
#endif
#ifdef REFLECTIVITY
in vec3 reflectivityInfos,
in vec4 surfaceMetallicOrReflectivityColorMap,
#endif
#if defined(METALLICWORKFLOW) && defined(REFLECTIVITY) && defined(AOSTOREINMETALMAPRED)
in vec3 ambientOcclusionColorIn,
#endif
#ifdef MICROSURFACEMAP
in vec4 microSurfaceTexel,
#endif
#ifdef DETAIL
in vec4 detailColor,
in vec4 vDetailInfos,
#endif
out reflectivityOutParams outParams
)
{
float microSurface=vReflectivityColor.a;
vec3 surfaceReflectivityColor=vReflectivityColor.rgb;
#ifdef METALLICWORKFLOW
vec2 metallicRoughness=surfaceReflectivityColor.rg;
#ifdef REFLECTIVITY
#if DEBUGMODE>0
outParams.surfaceMetallicColorMap=surfaceMetallicOrReflectivityColorMap;
#endif
#ifdef AOSTOREINMETALMAPRED
vec3 aoStoreInMetalMap=vec3(surfaceMetallicOrReflectivityColorMap.r,surfaceMetallicOrReflectivityColorMap.r,surfaceMetallicOrReflectivityColorMap.r);
outParams.ambientOcclusionColor=mix(ambientOcclusionColorIn,aoStoreInMetalMap,reflectivityInfos.z);
#endif
#ifdef METALLNESSSTOREINMETALMAPBLUE
metallicRoughness.r*=surfaceMetallicOrReflectivityColorMap.b;
#else
metallicRoughness.r*=surfaceMetallicOrReflectivityColorMap.r;
#endif
#ifdef ROUGHNESSSTOREINMETALMAPALPHA
metallicRoughness.g*=surfaceMetallicOrReflectivityColorMap.a;
#else
#ifdef ROUGHNESSSTOREINMETALMAPGREEN
metallicRoughness.g*=surfaceMetallicOrReflectivityColorMap.g;
#endif
#endif
#endif
#ifdef DETAIL
float detailRoughness=mix(0.5,detailColor.b,vDetailInfos.w);
float loLerp=mix(0.,metallicRoughness.g,detailRoughness*2.);
float hiLerp=mix(metallicRoughness.g,1.,(detailRoughness-0.5)*2.);
metallicRoughness.g=mix(loLerp,hiLerp,step(detailRoughness,0.5));
#endif
#ifdef MICROSURFACEMAP
metallicRoughness.g*=microSurfaceTexel.r;
#endif
#if DEBUGMODE>0
outParams.metallicRoughness=metallicRoughness;
#endif
#define CUSTOM_FRAGMENT_UPDATE_METALLICROUGHNESS
microSurface=1.0-metallicRoughness.g;
vec3 baseColor=surfaceAlbedo;
#ifdef FROSTBITE_REFLECTANCE
outParams.surfaceAlbedo=baseColor.rgb*(1.0-metallicRoughness.r);
surfaceReflectivityColor=mix(0.16*reflectance*reflectance,baseColor,metallicRoughness.r);
#else
vec3 metallicF0=metallicReflectanceFactors.rgb;
#if DEBUGMODE>0
outParams.metallicF0=metallicF0;
#endif
outParams.surfaceAlbedo=mix(baseColor.rgb*(1.0-metallicF0),vec3(0.,0.,0.),metallicRoughness.r);
surfaceReflectivityColor=mix(metallicF0,baseColor,metallicRoughness.r);
#endif
#else
#ifdef REFLECTIVITY
surfaceReflectivityColor*=surfaceMetallicOrReflectivityColorMap.rgb;
#if DEBUGMODE>0
outParams.surfaceReflectivityColorMap=surfaceMetallicOrReflectivityColorMap;
#endif
#ifdef MICROSURFACEFROMREFLECTIVITYMAP
microSurface*=surfaceMetallicOrReflectivityColorMap.a;
microSurface*=reflectivityInfos.z;
#else
#ifdef MICROSURFACEAUTOMATIC
microSurface*=computeDefaultMicroSurface(microSurface,surfaceReflectivityColor);
#endif
#ifdef MICROSURFACEMAP
microSurface*=microSurfaceTexel.r;
#endif
#define CUSTOM_FRAGMENT_UPDATE_MICROSURFACE
#endif
#endif
#endif
microSurface=saturate(microSurface);
float roughness=1.-microSurface;
outParams.microSurface=microSurface;
outParams.roughness=roughness;
outParams.surfaceReflectivityColor=surfaceReflectivityColor;
}
`;oe.IncludesShadersStore[us]=fs;var hs="pbrBlockAmbientOcclusion",ds=`struct ambientOcclusionOutParams
{
vec3 ambientOcclusionColor;
#if DEBUGMODE>0
vec3 ambientOcclusionColorMap;
#endif
};
#define pbr_inline
void ambientOcclusionBlock(
#ifdef AMBIENT
in vec3 ambientOcclusionColorMap_,
in vec4 vAmbientInfos,
#endif
out ambientOcclusionOutParams outParams
)
{
vec3 ambientOcclusionColor=vec3(1.,1.,1.);
#ifdef AMBIENT
vec3 ambientOcclusionColorMap=ambientOcclusionColorMap_*vAmbientInfos.y;
#ifdef AMBIENTINGRAYSCALE
ambientOcclusionColorMap=vec3(ambientOcclusionColorMap.r,ambientOcclusionColorMap.r,ambientOcclusionColorMap.r);
#endif
ambientOcclusionColor=mix(ambientOcclusionColor,ambientOcclusionColorMap,vAmbientInfos.z);
#if DEBUGMODE>0
outParams.ambientOcclusionColorMap=ambientOcclusionColorMap;
#endif
#endif
outParams.ambientOcclusionColor=ambientOcclusionColor;
}
`;oe.IncludesShadersStore[hs]=ds;var ps="pbrBlockAlphaFresnel",ms=`#ifdef ALPHAFRESNEL
#if defined(ALPHATEST) || defined(ALPHABLEND)
struct alphaFresnelOutParams
{
float alpha;
};
#define pbr_inline
void alphaFresnelBlock(
in vec3 normalW,
in vec3 viewDirectionW,
in float alpha,
in float microSurface,
out alphaFresnelOutParams outParams
)
{
float opacityPerceptual=alpha;
#ifdef LINEARALPHAFRESNEL
float opacity0=opacityPerceptual;
#else
float opacity0=opacityPerceptual*opacityPerceptual;
#endif
float opacity90=fresnelGrazingReflectance(opacity0);
vec3 normalForward=faceforward(normalW,-viewDirectionW,normalW);
outParams.alpha=getReflectanceFromAnalyticalBRDFLookup_Jones(saturate(dot(viewDirectionW,normalForward)),vec3(opacity0),vec3(opacity90),sqrt(microSurface)).x;
#ifdef ALPHATEST
if (outParams.alpha<ALPHATESTVALUE)
discard;
#ifndef ALPHABLEND
outParams.alpha=1.0;
#endif
#endif
}
#endif
#endif
`;oe.IncludesShadersStore[ps]=ms;var _s="pbrBlockAnisotropic",gs=`#ifdef ANISOTROPIC
struct anisotropicOutParams
{
float anisotropy;
vec3 anisotropicTangent;
vec3 anisotropicBitangent;
vec3 anisotropicNormal;
#if DEBUGMODE>0
vec3 anisotropyMapData;
#endif
};
#define pbr_inline
void anisotropicBlock(
in vec3 vAnisotropy,
#ifdef ANISOTROPIC_TEXTURE
in vec3 anisotropyMapData,
#endif
in mat3 TBN,
in vec3 normalW,
in vec3 viewDirectionW,
out anisotropicOutParams outParams
)
{
float anisotropy=vAnisotropy.b;
vec3 anisotropyDirection=vec3(vAnisotropy.xy,0.);
#ifdef ANISOTROPIC_TEXTURE
anisotropy*=anisotropyMapData.b;
anisotropyDirection.rg*=anisotropyMapData.rg*2.0-1.0;
#if DEBUGMODE>0
outParams.anisotropyMapData=anisotropyMapData;
#endif
#endif
mat3 anisoTBN=mat3(normalize(TBN[0]),normalize(TBN[1]),normalize(TBN[2]));
vec3 anisotropicTangent=normalize(anisoTBN*anisotropyDirection);
vec3 anisotropicBitangent=normalize(cross(anisoTBN[2],anisotropicTangent));
outParams.anisotropy=anisotropy;
outParams.anisotropicTangent=anisotropicTangent;
outParams.anisotropicBitangent=anisotropicBitangent;
outParams.anisotropicNormal=getAnisotropicBentNormals(anisotropicTangent,anisotropicBitangent,normalW,viewDirectionW,anisotropy);
}
#endif
`;oe.IncludesShadersStore[_s]=gs;var vs="pbrBlockReflection",Es=`#ifdef REFLECTION
struct reflectionOutParams
{
vec4 environmentRadiance;
vec3 environmentIrradiance;
#ifdef REFLECTIONMAP_3D
vec3 reflectionCoords;
#else
vec2 reflectionCoords;
#endif
#ifdef SS_TRANSLUCENCY
#ifdef USESPHERICALFROMREFLECTIONMAP
#if !defined(NORMAL) || !defined(USESPHERICALINVERTEX)
vec3 irradianceVector;
#endif
#endif
#endif
};
#define pbr_inline
void createReflectionCoords(
in vec3 vPositionW,
in vec3 normalW,
#ifdef ANISOTROPIC
in anisotropicOutParams anisotropicOut,
#endif
#ifdef REFLECTIONMAP_3D
out vec3 reflectionCoords
#else
out vec2 reflectionCoords
#endif
)
{
#ifdef ANISOTROPIC
vec3 reflectionVector=computeReflectionCoords(vec4(vPositionW,1.0),anisotropicOut.anisotropicNormal);
#else
vec3 reflectionVector=computeReflectionCoords(vec4(vPositionW,1.0),normalW);
#endif
#ifdef REFLECTIONMAP_OPPOSITEZ
reflectionVector.z*=-1.0;
#endif
#ifdef REFLECTIONMAP_3D
reflectionCoords=reflectionVector;
#else
reflectionCoords=reflectionVector.xy;
#ifdef REFLECTIONMAP_PROJECTION
reflectionCoords/=reflectionVector.z;
#endif
reflectionCoords.y=1.0-reflectionCoords.y;
#endif
}
#define pbr_inline
#define inline
void sampleReflectionTexture(
in float alphaG,
in vec3 vReflectionMicrosurfaceInfos,
in vec2 vReflectionInfos,
in vec3 vReflectionColor,
#if defined(LODINREFLECTIONALPHA) && !defined(REFLECTIONMAP_SKYBOX)
in float NdotVUnclamped,
#endif
#ifdef LINEARSPECULARREFLECTION
in float roughness,
#endif
#ifdef REFLECTIONMAP_3D
in samplerCube reflectionSampler,
const vec3 reflectionCoords,
#else
in sampler2D reflectionSampler,
const vec2 reflectionCoords,
#endif
#ifndef LODBASEDMICROSFURACE
#ifdef REFLECTIONMAP_3D
in samplerCube reflectionSamplerLow,
in samplerCube reflectionSamplerHigh,
#else
in sampler2D reflectionSamplerLow,
in sampler2D reflectionSamplerHigh,
#endif
#endif
#ifdef REALTIME_FILTERING
in vec2 vReflectionFilteringInfo,
#endif
out vec4 environmentRadiance
)
{
#if defined(LODINREFLECTIONALPHA) && !defined(REFLECTIONMAP_SKYBOX)
float reflectionLOD=getLodFromAlphaG(vReflectionMicrosurfaceInfos.x,alphaG,NdotVUnclamped);
#elif defined(LINEARSPECULARREFLECTION)
float reflectionLOD=getLinearLodFromRoughness(vReflectionMicrosurfaceInfos.x,roughness);
#else
float reflectionLOD=getLodFromAlphaG(vReflectionMicrosurfaceInfos.x,alphaG);
#endif
#ifdef LODBASEDMICROSFURACE
reflectionLOD=reflectionLOD*vReflectionMicrosurfaceInfos.y+vReflectionMicrosurfaceInfos.z;
#ifdef LODINREFLECTIONALPHA
float automaticReflectionLOD=UNPACK_LOD(sampleReflection(reflectionSampler,reflectionCoords).a);
float requestedReflectionLOD=max(automaticReflectionLOD,reflectionLOD);
#else
float requestedReflectionLOD=reflectionLOD;
#endif
#ifdef REALTIME_FILTERING
environmentRadiance=vec4(radiance(alphaG,reflectionSampler,reflectionCoords,vReflectionFilteringInfo),1.0);
#else
environmentRadiance=sampleReflectionLod(reflectionSampler,reflectionCoords,reflectionLOD);
#endif
#else
float lodReflectionNormalized=saturate(reflectionLOD/log2(vReflectionMicrosurfaceInfos.x));
float lodReflectionNormalizedDoubled=lodReflectionNormalized*2.0;
vec4 environmentMid=sampleReflection(reflectionSampler,reflectionCoords);
if (lodReflectionNormalizedDoubled<1.0){
environmentRadiance=mix(
sampleReflection(reflectionSamplerHigh,reflectionCoords),
environmentMid,
lodReflectionNormalizedDoubled
);
} else {
environmentRadiance=mix(
environmentMid,
sampleReflection(reflectionSamplerLow,reflectionCoords),
lodReflectionNormalizedDoubled-1.0
);
}
#endif
#ifdef RGBDREFLECTION
environmentRadiance.rgb=fromRGBD(environmentRadiance);
#endif
#ifdef GAMMAREFLECTION
environmentRadiance.rgb=toLinearSpace(environmentRadiance.rgb);
#endif
environmentRadiance.rgb*=vReflectionInfos.x;
environmentRadiance.rgb*=vReflectionColor.rgb;
}
#define pbr_inline
#define inline
void reflectionBlock(
in vec3 vPositionW,
in vec3 normalW,
in float alphaG,
in vec3 vReflectionMicrosurfaceInfos,
in vec2 vReflectionInfos,
in vec3 vReflectionColor,
#ifdef ANISOTROPIC
in anisotropicOutParams anisotropicOut,
#endif
#if defined(LODINREFLECTIONALPHA) && !defined(REFLECTIONMAP_SKYBOX)
in float NdotVUnclamped,
#endif
#ifdef LINEARSPECULARREFLECTION
in float roughness,
#endif
#ifdef REFLECTIONMAP_3D
in samplerCube reflectionSampler,
#else
in sampler2D reflectionSampler,
#endif
#if defined(NORMAL) && defined(USESPHERICALINVERTEX)
in vec3 vEnvironmentIrradiance,
#endif
#ifdef USESPHERICALFROMREFLECTIONMAP
#if !defined(NORMAL) || !defined(USESPHERICALINVERTEX)
in mat4 reflectionMatrix,
#endif
#endif
#ifdef USEIRRADIANCEMAP
#ifdef REFLECTIONMAP_3D
in samplerCube irradianceSampler,
#else
in sampler2D irradianceSampler,
#endif
#endif
#ifndef LODBASEDMICROSFURACE
#ifdef REFLECTIONMAP_3D
in samplerCube reflectionSamplerLow,
in samplerCube reflectionSamplerHigh,
#else
in sampler2D reflectionSamplerLow,
in sampler2D reflectionSamplerHigh,
#endif
#endif
#ifdef REALTIME_FILTERING
in vec2 vReflectionFilteringInfo,
#endif
out reflectionOutParams outParams
)
{
vec4 environmentRadiance=vec4(0.,0.,0.,0.);
#ifdef REFLECTIONMAP_3D
vec3 reflectionCoords=vec3(0.);
#else
vec2 reflectionCoords=vec2(0.);
#endif
createReflectionCoords(
vPositionW,
normalW,
#ifdef ANISOTROPIC
anisotropicOut,
#endif
reflectionCoords
);
sampleReflectionTexture(
alphaG,
vReflectionMicrosurfaceInfos,
vReflectionInfos,
vReflectionColor,
#if defined(LODINREFLECTIONALPHA) && !defined(REFLECTIONMAP_SKYBOX)
NdotVUnclamped,
#endif
#ifdef LINEARSPECULARREFLECTION
roughness,
#endif
#ifdef REFLECTIONMAP_3D
reflectionSampler,
reflectionCoords,
#else
reflectionSampler,
reflectionCoords,
#endif
#ifndef LODBASEDMICROSFURACE
reflectionSamplerLow,
reflectionSamplerHigh,
#endif
#ifdef REALTIME_FILTERING
vReflectionFilteringInfo,
#endif
environmentRadiance
);
vec3 environmentIrradiance=vec3(0.,0.,0.);
#ifdef USESPHERICALFROMREFLECTIONMAP
#if defined(NORMAL) && defined(USESPHERICALINVERTEX)
environmentIrradiance=vEnvironmentIrradiance;
#else
#ifdef ANISOTROPIC
vec3 irradianceVector=vec3(reflectionMatrix*vec4(anisotropicOut.anisotropicNormal,0)).xyz;
#else
vec3 irradianceVector=vec3(reflectionMatrix*vec4(normalW,0)).xyz;
#endif
#ifdef REFLECTIONMAP_OPPOSITEZ
irradianceVector.z*=-1.0;
#endif
#ifdef INVERTCUBICMAP
irradianceVector.y*=-1.0;
#endif
#if defined(REALTIME_FILTERING)
environmentIrradiance=irradiance(reflectionSampler,irradianceVector,vReflectionFilteringInfo);
#else
environmentIrradiance=computeEnvironmentIrradiance(irradianceVector);
#endif
#ifdef SS_TRANSLUCENCY
outParams.irradianceVector=irradianceVector;
#endif
#endif
#elif defined(USEIRRADIANCEMAP)
vec4 environmentIrradiance4=sampleReflection(irradianceSampler,reflectionCoords);
environmentIrradiance=environmentIrradiance4.rgb;
#ifdef RGBDREFLECTION
environmentIrradiance.rgb=fromRGBD(environmentIrradiance4);
#endif
#ifdef GAMMAREFLECTION
environmentIrradiance.rgb=toLinearSpace(environmentIrradiance.rgb);
#endif
#endif
environmentIrradiance*=vReflectionColor.rgb;
outParams.environmentRadiance=environmentRadiance;
outParams.environmentIrradiance=environmentIrradiance;
outParams.reflectionCoords=reflectionCoords;
}
#endif
`;oe.IncludesShadersStore[vs]=Es;var bs="pbrBlockSheen",As=`#ifdef SHEEN
struct sheenOutParams
{
float sheenIntensity;
vec3 sheenColor;
float sheenRoughness;
#ifdef SHEEN_LINKWITHALBEDO
vec3 surfaceAlbedo;
#endif
#if defined(ENVIRONMENTBRDF) && defined(SHEEN_ALBEDOSCALING)
float sheenAlbedoScaling;
#endif
#if defined(REFLECTION) && defined(ENVIRONMENTBRDF)
vec3 finalSheenRadianceScaled;
#endif
#if DEBUGMODE>0
vec4 sheenMapData;
vec3 sheenEnvironmentReflectance;
#endif
};
#define pbr_inline
#define inline
void sheenBlock(
in vec4 vSheenColor,
#ifdef SHEEN_ROUGHNESS
in float vSheenRoughness,
#if defined(SHEEN_TEXTURE_ROUGHNESS) && !defined(SHEEN_TEXTURE_ROUGHNESS_IDENTICAL) && !defined(SHEEN_USE_ROUGHNESS_FROM_MAINTEXTURE)
in vec4 sheenMapRoughnessData,
#endif
#endif
in float roughness,
#ifdef SHEEN_TEXTURE
in vec4 sheenMapData,
in float sheenMapLevel,
#endif
in float reflectance,
#ifdef SHEEN_LINKWITHALBEDO
in vec3 baseColor,
in vec3 surfaceAlbedo,
#endif
#ifdef ENVIRONMENTBRDF
in float NdotV,
in vec3 environmentBrdf,
#endif
#if defined(REFLECTION) && defined(ENVIRONMENTBRDF)
in vec2 AARoughnessFactors,
in vec3 vReflectionMicrosurfaceInfos,
in vec2 vReflectionInfos,
in vec3 vReflectionColor,
in vec4 vLightingIntensity,
#ifdef REFLECTIONMAP_3D
in samplerCube reflectionSampler,
in vec3 reflectionCoords,
#else
in sampler2D reflectionSampler,
in vec2 reflectionCoords,
#endif
in float NdotVUnclamped,
#ifndef LODBASEDMICROSFURACE
#ifdef REFLECTIONMAP_3D
in samplerCube reflectionSamplerLow,
in samplerCube reflectionSamplerHigh,
#else
in sampler2D reflectionSamplerLow,
in sampler2D reflectionSamplerHigh,
#endif
#endif
#ifdef REALTIME_FILTERING
in vec2 vReflectionFilteringInfo,
#endif
#if !defined(REFLECTIONMAP_SKYBOX) && defined(RADIANCEOCCLUSION)
in float seo,
#endif
#if !defined(REFLECTIONMAP_SKYBOX) && defined(HORIZONOCCLUSION) && defined(BUMP) && defined(REFLECTIONMAP_3D)
in float eho,
#endif
#endif
out sheenOutParams outParams
)
{
float sheenIntensity=vSheenColor.a;
#ifdef SHEEN_TEXTURE
#if DEBUGMODE>0
outParams.sheenMapData=sheenMapData;
#endif
#endif
#ifdef SHEEN_LINKWITHALBEDO
float sheenFactor=pow5(1.0-sheenIntensity);
vec3 sheenColor=baseColor.rgb*(1.0-sheenFactor);
float sheenRoughness=sheenIntensity;
outParams.surfaceAlbedo=surfaceAlbedo*sheenFactor;
#ifdef SHEEN_TEXTURE
sheenIntensity*=sheenMapData.a;
#endif
#else
vec3 sheenColor=vSheenColor.rgb;
#ifdef SHEEN_TEXTURE
#ifdef SHEEN_GAMMATEXTURE
sheenColor.rgb*=toLinearSpace(sheenMapData.rgb);
#else
sheenColor.rgb*=sheenMapData.rgb;
#endif
sheenColor.rgb*=sheenMapLevel;
#endif
#ifdef SHEEN_ROUGHNESS
float sheenRoughness=vSheenRoughness;
#ifdef SHEEN_USE_ROUGHNESS_FROM_MAINTEXTURE
#if defined(SHEEN_TEXTURE)
sheenRoughness*=sheenMapData.a;
#endif
#elif defined(SHEEN_TEXTURE_ROUGHNESS)
#ifdef SHEEN_TEXTURE_ROUGHNESS_IDENTICAL
sheenRoughness*=sheenMapData.a;
#else
sheenRoughness*=sheenMapRoughnessData.a;
#endif
#endif
#else
float sheenRoughness=roughness;
#ifdef SHEEN_TEXTURE
sheenIntensity*=sheenMapData.a;
#endif
#endif
#if !defined(SHEEN_ALBEDOSCALING)
sheenIntensity*=(1.-reflectance);
#endif
sheenColor*=sheenIntensity;
#endif
#ifdef ENVIRONMENTBRDF
/*#ifdef SHEEN_SOFTER
vec3 environmentSheenBrdf=vec3(0.,0.,getBRDFLookupCharlieSheen(NdotV,sheenRoughness));
#else*/
#ifdef SHEEN_ROUGHNESS
vec3 environmentSheenBrdf=getBRDFLookup(NdotV,sheenRoughness);
#else
vec3 environmentSheenBrdf=environmentBrdf;
#endif
/*#endif*/
#endif
#if defined(REFLECTION) && defined(ENVIRONMENTBRDF)
float sheenAlphaG=convertRoughnessToAverageSlope(sheenRoughness);
#ifdef SPECULARAA
sheenAlphaG+=AARoughnessFactors.y;
#endif
vec4 environmentSheenRadiance=vec4(0.,0.,0.,0.);
sampleReflectionTexture(
sheenAlphaG,
vReflectionMicrosurfaceInfos,
vReflectionInfos,
vReflectionColor,
#if defined(LODINREFLECTIONALPHA) && !defined(REFLECTIONMAP_SKYBOX)
NdotVUnclamped,
#endif
#ifdef LINEARSPECULARREFLECTION
sheenRoughness,
#endif
reflectionSampler,
reflectionCoords,
#ifndef LODBASEDMICROSFURACE
reflectionSamplerLow,
reflectionSamplerHigh,
#endif
#ifdef REALTIME_FILTERING
vReflectionFilteringInfo,
#endif
environmentSheenRadiance
);
vec3 sheenEnvironmentReflectance=getSheenReflectanceFromBRDFLookup(sheenColor,environmentSheenBrdf);
#if !defined(REFLECTIONMAP_SKYBOX) && defined(RADIANCEOCCLUSION)
sheenEnvironmentReflectance*=seo;
#endif
#if !defined(REFLECTIONMAP_SKYBOX) && defined(HORIZONOCCLUSION) && defined(BUMP) && defined(REFLECTIONMAP_3D)
sheenEnvironmentReflectance*=eho;
#endif
#if DEBUGMODE>0
outParams.sheenEnvironmentReflectance=sheenEnvironmentReflectance;
#endif
outParams.finalSheenRadianceScaled=
environmentSheenRadiance.rgb *
sheenEnvironmentReflectance *
vLightingIntensity.z;
#endif
#if defined(ENVIRONMENTBRDF) && defined(SHEEN_ALBEDOSCALING)
outParams.sheenAlbedoScaling=1.0-sheenIntensity*max(max(sheenColor.r,sheenColor.g),sheenColor.b)*environmentSheenBrdf.b;
#endif
outParams.sheenIntensity=sheenIntensity;
outParams.sheenColor=sheenColor;
outParams.sheenRoughness=sheenRoughness;
}
#endif
`;oe.IncludesShadersStore[bs]=As;var ys="pbrBlockClearcoat",Cs=`struct clearcoatOutParams
{
vec3 specularEnvironmentR0;
float conservationFactor;
vec3 clearCoatNormalW;
vec2 clearCoatAARoughnessFactors;
float clearCoatIntensity;
float clearCoatRoughness;
#ifdef REFLECTION
vec3 finalClearCoatRadianceScaled;
#endif
#ifdef CLEARCOAT_TINT
vec3 absorption;
float clearCoatNdotVRefract;
vec3 clearCoatColor;
float clearCoatThickness;
#endif
#if defined(ENVIRONMENTBRDF) && defined(MS_BRDF_ENERGY_CONSERVATION)
vec3 energyConservationFactorClearCoat;
#endif
#if DEBUGMODE>0
mat3 TBNClearCoat;
vec2 clearCoatMapData;
vec4 clearCoatTintMapData;
vec4 environmentClearCoatRadiance;
float clearCoatNdotV;
vec3 clearCoatEnvironmentReflectance;
#endif
};
#ifdef CLEARCOAT
#define pbr_inline
#define inline
void clearcoatBlock(
in vec3 vPositionW,
in vec3 geometricNormalW,
in vec3 viewDirectionW,
in vec2 vClearCoatParams,
#if defined(CLEARCOAT_TEXTURE_ROUGHNESS) && !defined(CLEARCOAT_TEXTURE_ROUGHNESS_IDENTICAL) && !defined(CLEARCOAT_USE_ROUGHNESS_FROM_MAINTEXTURE)
in vec4 clearCoatMapRoughnessData,
#endif
in vec3 specularEnvironmentR0,
#ifdef CLEARCOAT_TEXTURE
in vec2 clearCoatMapData,
#endif
#ifdef CLEARCOAT_TINT
in vec4 vClearCoatTintParams,
in float clearCoatColorAtDistance,
in vec4 vClearCoatRefractionParams,
#ifdef CLEARCOAT_TINT_TEXTURE
in vec4 clearCoatTintMapData,
#endif
#endif
#ifdef CLEARCOAT_BUMP
in vec2 vClearCoatBumpInfos,
in vec4 clearCoatBumpMapData,
in vec2 vClearCoatBumpUV,
#if defined(TANGENT) && defined(NORMAL)
in mat3 vTBN,
#else
in vec2 vClearCoatTangentSpaceParams,
#endif
#ifdef OBJECTSPACE_NORMALMAP
in mat4 normalMatrix,
#endif
#endif
#if defined(FORCENORMALFORWARD) && defined(NORMAL)
in vec3 faceNormal,
#endif
#ifdef REFLECTION
in vec3 vReflectionMicrosurfaceInfos,
in vec2 vReflectionInfos,
in vec3 vReflectionColor,
in vec4 vLightingIntensity,
#ifdef REFLECTIONMAP_3D
in samplerCube reflectionSampler,
#else
in sampler2D reflectionSampler,
#endif
#ifndef LODBASEDMICROSFURACE
#ifdef REFLECTIONMAP_3D
in samplerCube reflectionSamplerLow,
in samplerCube reflectionSamplerHigh,
#else
in sampler2D reflectionSamplerLow,
in sampler2D reflectionSamplerHigh,
#endif
#endif
#ifdef REALTIME_FILTERING
in vec2 vReflectionFilteringInfo,
#endif
#endif
#if defined(ENVIRONMENTBRDF) && !defined(REFLECTIONMAP_SKYBOX)
#ifdef RADIANCEOCCLUSION
in float ambientMonochrome,
#endif
#endif
#if defined(CLEARCOAT_BUMP) || defined(TWOSIDEDLIGHTING)
in float frontFacingMultiplier,
#endif
out clearcoatOutParams outParams
)
{
float clearCoatIntensity=vClearCoatParams.x;
float clearCoatRoughness=vClearCoatParams.y;
#ifdef CLEARCOAT_TEXTURE
clearCoatIntensity*=clearCoatMapData.x;
#ifdef CLEARCOAT_USE_ROUGHNESS_FROM_MAINTEXTURE
clearCoatRoughness*=clearCoatMapData.y;
#endif
#if DEBUGMODE>0
outParams.clearCoatMapData=clearCoatMapData;
#endif
#endif
#if defined(CLEARCOAT_TEXTURE_ROUGHNESS) && !defined(CLEARCOAT_USE_ROUGHNESS_FROM_MAINTEXTURE)
#ifdef CLEARCOAT_TEXTURE_ROUGHNESS_IDENTICAL
clearCoatRoughness*=clearCoatMapData.y;
#else
clearCoatRoughness*=clearCoatMapRoughnessData.y;
#endif
#endif
outParams.clearCoatIntensity=clearCoatIntensity;
outParams.clearCoatRoughness=clearCoatRoughness;
#ifdef CLEARCOAT_TINT
vec3 clearCoatColor=vClearCoatTintParams.rgb;
float clearCoatThickness=vClearCoatTintParams.a;
#ifdef CLEARCOAT_TINT_TEXTURE
#ifdef CLEARCOAT_TINT_GAMMATEXTURE
clearCoatColor*=toLinearSpace(clearCoatTintMapData.rgb);
#else
clearCoatColor*=clearCoatTintMapData.rgb;
#endif
clearCoatThickness*=clearCoatTintMapData.a;
#if DEBUGMODE>0
outParams.clearCoatTintMapData=clearCoatTintMapData;
#endif
#endif
outParams.clearCoatColor=computeColorAtDistanceInMedia(clearCoatColor,clearCoatColorAtDistance);
outParams.clearCoatThickness=clearCoatThickness;
#endif
#ifdef CLEARCOAT_REMAP_F0
vec3 specularEnvironmentR0Updated=getR0RemappedForClearCoat(specularEnvironmentR0);
#else
vec3 specularEnvironmentR0Updated=specularEnvironmentR0;
#endif
outParams.specularEnvironmentR0=mix(specularEnvironmentR0,specularEnvironmentR0Updated,clearCoatIntensity);
vec3 clearCoatNormalW=geometricNormalW;
#ifdef CLEARCOAT_BUMP
#ifdef NORMALXYSCALE
float clearCoatNormalScale=1.0;
#else
float clearCoatNormalScale=vClearCoatBumpInfos.y;
#endif
#if defined(TANGENT) && defined(NORMAL)
mat3 TBNClearCoat=vTBN;
#else
vec2 TBNClearCoatUV=vClearCoatBumpUV*frontFacingMultiplier;
mat3 TBNClearCoat=cotangent_frame(clearCoatNormalW*clearCoatNormalScale,vPositionW,TBNClearCoatUV,vClearCoatTangentSpaceParams);
#endif
#if DEBUGMODE>0
outParams.TBNClearCoat=TBNClearCoat;
#endif
#ifdef OBJECTSPACE_NORMALMAP
clearCoatNormalW=normalize(clearCoatBumpMapData.xyz *2.0-1.0);
clearCoatNormalW=normalize(mat3(normalMatrix)*clearCoatNormalW);
#else
clearCoatNormalW=perturbNormal(TBNClearCoat,clearCoatBumpMapData.xyz,vClearCoatBumpInfos.y);
#endif
#endif
#if defined(FORCENORMALFORWARD) && defined(NORMAL)
clearCoatNormalW*=sign(dot(clearCoatNormalW,faceNormal));
#endif
#if defined(TWOSIDEDLIGHTING) && defined(NORMAL)
clearCoatNormalW=clearCoatNormalW*frontFacingMultiplier;
#endif
outParams.clearCoatNormalW=clearCoatNormalW;
outParams.clearCoatAARoughnessFactors=getAARoughnessFactors(clearCoatNormalW.xyz);
float clearCoatNdotVUnclamped=dot(clearCoatNormalW,viewDirectionW);
float clearCoatNdotV=absEps(clearCoatNdotVUnclamped);
#if DEBUGMODE>0
outParams.clearCoatNdotV=clearCoatNdotV;
#endif
#ifdef CLEARCOAT_TINT
vec3 clearCoatVRefract=-refract(vPositionW,clearCoatNormalW,vClearCoatRefractionParams.y);
outParams.clearCoatNdotVRefract=absEps(dot(clearCoatNormalW,clearCoatVRefract));
#endif
#if defined(ENVIRONMENTBRDF) && (!defined(REFLECTIONMAP_SKYBOX) || defined(MS_BRDF_ENERGY_CONSERVATION))
vec3 environmentClearCoatBrdf=getBRDFLookup(clearCoatNdotV,clearCoatRoughness);
#endif
#if defined(REFLECTION)
float clearCoatAlphaG=convertRoughnessToAverageSlope(clearCoatRoughness);
#ifdef SPECULARAA
clearCoatAlphaG+=outParams.clearCoatAARoughnessFactors.y;
#endif
vec4 environmentClearCoatRadiance=vec4(0.,0.,0.,0.);
vec3 clearCoatReflectionVector=computeReflectionCoords(vec4(vPositionW,1.0),clearCoatNormalW);
#ifdef REFLECTIONMAP_OPPOSITEZ
clearCoatReflectionVector.z*=-1.0;
#endif
#ifdef REFLECTIONMAP_3D
vec3 clearCoatReflectionCoords=clearCoatReflectionVector;
#else
vec2 clearCoatReflectionCoords=clearCoatReflectionVector.xy;
#ifdef REFLECTIONMAP_PROJECTION
clearCoatReflectionCoords/=clearCoatReflectionVector.z;
#endif
clearCoatReflectionCoords.y=1.0-clearCoatReflectionCoords.y;
#endif
sampleReflectionTexture(
clearCoatAlphaG,
vReflectionMicrosurfaceInfos,
vReflectionInfos,
vReflectionColor,
#if defined(LODINREFLECTIONALPHA) && !defined(REFLECTIONMAP_SKYBOX)
clearCoatNdotVUnclamped,
#endif
#ifdef LINEARSPECULARREFLECTION
clearCoatRoughness,
#endif
reflectionSampler,
clearCoatReflectionCoords,
#ifndef LODBASEDMICROSFURACE
reflectionSamplerLow,
reflectionSamplerHigh,
#endif
#ifdef REALTIME_FILTERING
vReflectionFilteringInfo,
#endif
environmentClearCoatRadiance
);
#if DEBUGMODE>0
outParams.environmentClearCoatRadiance=environmentClearCoatRadiance;
#endif
#if defined(ENVIRONMENTBRDF) && !defined(REFLECTIONMAP_SKYBOX)
vec3 clearCoatEnvironmentReflectance=getReflectanceFromBRDFLookup(vec3(vClearCoatRefractionParams.x),environmentClearCoatBrdf);
#ifdef RADIANCEOCCLUSION
float clearCoatSeo=environmentRadianceOcclusion(ambientMonochrome,clearCoatNdotVUnclamped);
clearCoatEnvironmentReflectance*=clearCoatSeo;
#endif
#ifdef HORIZONOCCLUSION
#ifdef BUMP
#ifdef REFLECTIONMAP_3D
float clearCoatEho=environmentHorizonOcclusion(-viewDirectionW,clearCoatNormalW,geometricNormalW);
clearCoatEnvironmentReflectance*=clearCoatEho;
#endif
#endif
#endif
#else
vec3 clearCoatEnvironmentReflectance=getReflectanceFromAnalyticalBRDFLookup_Jones(clearCoatNdotV,vec3(1.),vec3(1.),sqrt(1.-clearCoatRoughness));
#endif
clearCoatEnvironmentReflectance*=clearCoatIntensity;
#if DEBUGMODE>0
outParams.clearCoatEnvironmentReflectance=clearCoatEnvironmentReflectance;
#endif
outParams.finalClearCoatRadianceScaled=
environmentClearCoatRadiance.rgb *
clearCoatEnvironmentReflectance *
vLightingIntensity.z;
#endif
#if defined(CLEARCOAT_TINT)
outParams.absorption=computeClearCoatAbsorption(outParams.clearCoatNdotVRefract,outParams.clearCoatNdotVRefract,outParams.clearCoatColor,clearCoatThickness,clearCoatIntensity);
#endif
float fresnelIBLClearCoat=fresnelSchlickGGX(clearCoatNdotV,vClearCoatRefractionParams.x,CLEARCOATREFLECTANCE90);
fresnelIBLClearCoat*=clearCoatIntensity;
outParams.conservationFactor=(1.-fresnelIBLClearCoat);
#if defined(ENVIRONMENTBRDF) && defined(MS_BRDF_ENERGY_CONSERVATION)
outParams.energyConservationFactorClearCoat=getEnergyConservationFactor(outParams.specularEnvironmentR0,environmentClearCoatBrdf);
#endif
}
#endif
`;oe.IncludesShadersStore[ys]=Cs;var Ts="pbrBlockSubSurface",Ss=`struct subSurfaceOutParams
{
vec3 specularEnvironmentReflectance;
#ifdef SS_REFRACTION
vec3 finalRefraction;
vec3 surfaceAlbedo;
#ifdef SS_LINKREFRACTIONTOTRANSPARENCY
float alpha;
#endif
#ifdef REFLECTION
float refractionFactorForIrradiance;
#endif
#endif
#ifdef SS_TRANSLUCENCY
vec3 transmittance;
float translucencyIntensity;
#ifdef REFLECTION
vec3 refractionIrradiance;
#endif
#endif
#if DEBUGMODE>0
vec4 thicknessMap;
vec4 environmentRefraction;
vec3 refractionTransmittance;
#endif
};
#ifdef SUBSURFACE
#define pbr_inline
#define inline
void subSurfaceBlock(
in vec3 vSubSurfaceIntensity,
in vec2 vThicknessParam,
in vec4 vTintColor,
in vec3 normalW,
in vec3 specularEnvironmentReflectance,
#ifdef SS_THICKNESSANDMASK_TEXTURE
in vec4 thicknessMap,
#endif
#ifdef SS_REFRACTIONINTENSITY_TEXTURE
in vec4 refractionIntensityMap,
#endif
#ifdef SS_TRANSLUCENCYINTENSITY_TEXTURE
in vec4 translucencyIntensityMap,
#endif
#ifdef REFLECTION
#ifdef SS_TRANSLUCENCY
in mat4 reflectionMatrix,
#ifdef USESPHERICALFROMREFLECTIONMAP
#if !defined(NORMAL) || !defined(USESPHERICALINVERTEX)
in vec3 irradianceVector_,
#endif
#if defined(REALTIME_FILTERING)
in samplerCube reflectionSampler,
in vec2 vReflectionFilteringInfo,
#endif
#endif
#ifdef USEIRRADIANCEMAP
#ifdef REFLECTIONMAP_3D
in samplerCube irradianceSampler,
#else
in sampler2D irradianceSampler,
#endif
#endif
#endif
#endif
#if defined(SS_REFRACTION) || defined(SS_TRANSLUCENCY)
in vec3 surfaceAlbedo,
#endif
#ifdef SS_REFRACTION
in vec3 vPositionW,
in vec3 viewDirectionW,
in mat4 view,
in vec4 vRefractionInfos,
in mat4 refractionMatrix,
in vec4 vRefractionMicrosurfaceInfos,
in vec4 vLightingIntensity,
#ifdef SS_LINKREFRACTIONTOTRANSPARENCY
in float alpha,
#endif
#ifdef SS_LODINREFRACTIONALPHA
in float NdotVUnclamped,
#endif
#ifdef SS_LINEARSPECULARREFRACTION
in float roughness,
#endif
in float alphaG,
#ifdef SS_REFRACTIONMAP_3D
in samplerCube refractionSampler,
#ifndef LODBASEDMICROSFURACE
in samplerCube refractionSamplerLow,
in samplerCube refractionSamplerHigh,
#endif
#else
in sampler2D refractionSampler,
#ifndef LODBASEDMICROSFURACE
in sampler2D refractionSamplerLow,
in sampler2D refractionSamplerHigh,
#endif
#endif
#ifdef ANISOTROPIC
in anisotropicOutParams anisotropicOut,
#endif
#ifdef REALTIME_FILTERING
in vec2 vRefractionFilteringInfo,
#endif
#ifdef SS_USE_LOCAL_REFRACTIONMAP_CUBIC
in vec3 refractionPosition,
in vec3 refractionSize,
#endif
#endif
#ifdef SS_TRANSLUCENCY
in vec3 vDiffusionDistance,
#endif
out subSurfaceOutParams outParams
)
{
outParams.specularEnvironmentReflectance=specularEnvironmentReflectance;
#ifdef SS_REFRACTION
float refractionIntensity=vSubSurfaceIntensity.x;
#ifdef SS_LINKREFRACTIONTOTRANSPARENCY
refractionIntensity*=(1.0-alpha);
outParams.alpha=1.0;
#endif
#endif
#ifdef SS_TRANSLUCENCY
float translucencyIntensity=vSubSurfaceIntensity.y;
#endif
#ifdef SS_THICKNESSANDMASK_TEXTURE
#if defined(SS_USE_GLTF_TEXTURES)
float thickness=thicknessMap.g*vThicknessParam.y+vThicknessParam.x;
#else
float thickness=thicknessMap.r*vThicknessParam.y+vThicknessParam.x;
#endif
#if DEBUGMODE>0
outParams.thicknessMap=thicknessMap;
#endif
#ifdef SS_MASK_FROM_THICKNESS_TEXTURE
#if defined(SS_REFRACTION) && defined(SS_REFRACTION_USE_INTENSITY_FROM_TEXTURE)
#if defined(SS_USE_GLTF_TEXTURES)
refractionIntensity*=thicknessMap.r;
#else
refractionIntensity*=thicknessMap.g;
#endif
#endif
#if defined(SS_TRANSLUCENCY) && defined(SS_TRANSLUCENCY_USE_INTENSITY_FROM_TEXTURE)
translucencyIntensity*=thicknessMap.b;
#endif
#endif
#else
float thickness=vThicknessParam.y;
#endif
#ifdef SS_REFRACTIONINTENSITY_TEXTURE
#ifdef SS_USE_GLTF_TEXTURES
refractionIntensity*=refractionIntensityMap.r;
#else
refractionIntensity*=refractionIntensityMap.g;
#endif
#endif
#ifdef SS_TRANSLUCENCYINTENSITY_TEXTURE
translucencyIntensity*=translucencyIntensityMap.b;
#endif
#ifdef SS_TRANSLUCENCY
thickness=maxEps(thickness);
vec3 transmittance=transmittanceBRDF_Burley(vTintColor.rgb,vDiffusionDistance,thickness);
transmittance*=translucencyIntensity;
outParams.transmittance=transmittance;
outParams.translucencyIntensity=translucencyIntensity;
#endif
#ifdef SS_REFRACTION
vec4 environmentRefraction=vec4(0.,0.,0.,0.);
#ifdef ANISOTROPIC
vec3 refractionVector=refract(-viewDirectionW,anisotropicOut.anisotropicNormal,vRefractionInfos.y);
#else
vec3 refractionVector=refract(-viewDirectionW,normalW,vRefractionInfos.y);
#endif
#ifdef SS_REFRACTIONMAP_OPPOSITEZ
refractionVector.z*=-1.0;
#endif
#ifdef SS_REFRACTIONMAP_3D
#ifdef SS_USE_LOCAL_REFRACTIONMAP_CUBIC
refractionVector=parallaxCorrectNormal(vPositionW,refractionVector,refractionSize,refractionPosition);
#endif
refractionVector.y=refractionVector.y*vRefractionInfos.w;
vec3 refractionCoords=refractionVector;
refractionCoords=vec3(refractionMatrix*vec4(refractionCoords,0));
#else
#ifdef SS_USE_THICKNESS_AS_DEPTH
vec3 vRefractionUVW=vec3(refractionMatrix*(view*vec4(vPositionW+refractionVector*thickness,1.0)));
#else
vec3 vRefractionUVW=vec3(refractionMatrix*(view*vec4(vPositionW+refractionVector*vRefractionInfos.z,1.0)));
#endif
vec2 refractionCoords=vRefractionUVW.xy/vRefractionUVW.z;
refractionCoords.y=1.0-refractionCoords.y;
#endif
#ifdef SS_HAS_THICKNESS
float ior=vRefractionInfos.y;
#else
float ior=vRefractionMicrosurfaceInfos.w;
#endif
#ifdef SS_LODINREFRACTIONALPHA
float refractionAlphaG=alphaG;
refractionAlphaG=mix(alphaG,0.0,clamp(ior*3.0-2.0,0.0,1.0));
float refractionLOD=getLodFromAlphaG(vRefractionMicrosurfaceInfos.x,refractionAlphaG,NdotVUnclamped);
#elif defined(SS_LINEARSPECULARREFRACTION)
float refractionRoughness=alphaG;
refractionRoughness=mix(alphaG,0.0,clamp(ior*3.0-2.0,0.0,1.0));
float refractionLOD=getLinearLodFromRoughness(vRefractionMicrosurfaceInfos.x,refractionRoughness);
#else
float refractionAlphaG=alphaG;
refractionAlphaG=mix(alphaG,0.0,clamp(ior*3.0-2.0,0.0,1.0));
float refractionLOD=getLodFromAlphaG(vRefractionMicrosurfaceInfos.x,refractionAlphaG);
#endif
#ifdef LODBASEDMICROSFURACE
refractionLOD=refractionLOD*vRefractionMicrosurfaceInfos.y+vRefractionMicrosurfaceInfos.z;
#ifdef SS_LODINREFRACTIONALPHA
float automaticRefractionLOD=UNPACK_LOD(sampleRefraction(refractionSampler,refractionCoords).a);
float requestedRefractionLOD=max(automaticRefractionLOD,refractionLOD);
#else
float requestedRefractionLOD=refractionLOD;
#endif
#ifdef REALTIME_FILTERING
environmentRefraction=vec4(radiance(alphaG,refractionSampler,refractionCoords,vRefractionFilteringInfo),1.0);
#else
environmentRefraction=sampleRefractionLod(refractionSampler,refractionCoords,requestedRefractionLOD);
#endif
#else
float lodRefractionNormalized=saturate(refractionLOD/log2(vRefractionMicrosurfaceInfos.x));
float lodRefractionNormalizedDoubled=lodRefractionNormalized*2.0;
vec4 environmentRefractionMid=sampleRefraction(refractionSampler,refractionCoords);
if (lodRefractionNormalizedDoubled<1.0){
environmentRefraction=mix(
sampleRefraction(refractionSamplerHigh,refractionCoords),
environmentRefractionMid,
lodRefractionNormalizedDoubled
);
} else {
environmentRefraction=mix(
environmentRefractionMid,
sampleRefraction(refractionSamplerLow,refractionCoords),
lodRefractionNormalizedDoubled-1.0
);
}
#endif
#ifdef SS_RGBDREFRACTION
environmentRefraction.rgb=fromRGBD(environmentRefraction);
#endif
#ifdef SS_GAMMAREFRACTION
environmentRefraction.rgb=toLinearSpace(environmentRefraction.rgb);
#endif
environmentRefraction.rgb*=vRefractionInfos.x;
#endif
#ifdef SS_REFRACTION
vec3 refractionTransmittance=vec3(refractionIntensity);
#ifdef SS_THICKNESSANDMASK_TEXTURE
vec3 volumeAlbedo=computeColorAtDistanceInMedia(vTintColor.rgb,vTintColor.w);
refractionTransmittance*=cocaLambert(volumeAlbedo,thickness);
#elif defined(SS_LINKREFRACTIONTOTRANSPARENCY)
float maxChannel=max(max(surfaceAlbedo.r,surfaceAlbedo.g),surfaceAlbedo.b);
vec3 volumeAlbedo=saturate(maxChannel*surfaceAlbedo);
environmentRefraction.rgb*=volumeAlbedo;
#else
vec3 volumeAlbedo=computeColorAtDistanceInMedia(vTintColor.rgb,vTintColor.w);
refractionTransmittance*=cocaLambert(volumeAlbedo,vThicknessParam.y);
#endif
#ifdef SS_ALBEDOFORREFRACTIONTINT
environmentRefraction.rgb*=surfaceAlbedo.rgb;
#endif
outParams.surfaceAlbedo=surfaceAlbedo*(1.-refractionIntensity);
#ifdef REFLECTION
outParams.refractionFactorForIrradiance=(1.-refractionIntensity);
#endif
#ifdef UNUSED_MULTIPLEBOUNCES
vec3 bounceSpecularEnvironmentReflectance=(2.0*specularEnvironmentReflectance)/(1.0+specularEnvironmentReflectance);
outParams.specularEnvironmentReflectance=mix(bounceSpecularEnvironmentReflectance,specularEnvironmentReflectance,refractionIntensity);
#endif
refractionTransmittance*=1.0-outParams.specularEnvironmentReflectance;
#if DEBUGMODE>0
outParams.refractionTransmittance=refractionTransmittance;
#endif
outParams.finalRefraction=environmentRefraction.rgb*refractionTransmittance*vLightingIntensity.z;
#if DEBUGMODE>0
outParams.environmentRefraction=environmentRefraction;
#endif
#endif
#if defined(REFLECTION) && defined(SS_TRANSLUCENCY)
#if defined(NORMAL) && defined(USESPHERICALINVERTEX) || !defined(USESPHERICALFROMREFLECTIONMAP)
vec3 irradianceVector=vec3(reflectionMatrix*vec4(normalW,0)).xyz;
#ifdef REFLECTIONMAP_OPPOSITEZ
irradianceVector.z*=-1.0;
#endif
#ifdef INVERTCUBICMAP
irradianceVector.y*=-1.0;
#endif
#else
vec3 irradianceVector=irradianceVector_;
#endif
#if defined(USESPHERICALFROMREFLECTIONMAP)
#if defined(REALTIME_FILTERING)
vec3 refractionIrradiance=irradiance(reflectionSampler,-irradianceVector,vReflectionFilteringInfo);
#else
vec3 refractionIrradiance=computeEnvironmentIrradiance(-irradianceVector);
#endif
#elif defined(USEIRRADIANCEMAP)
#ifdef REFLECTIONMAP_3D
vec3 irradianceCoords=irradianceVector;
#else
vec2 irradianceCoords=irradianceVector.xy;
#ifdef REFLECTIONMAP_PROJECTION
irradianceCoords/=irradianceVector.z;
#endif
irradianceCoords.y=1.0-irradianceCoords.y;
#endif
vec4 refractionIrradiance=sampleReflection(irradianceSampler,-irradianceCoords);
#ifdef RGBDREFLECTION
refractionIrradiance.rgb=fromRGBD(refractionIrradiance);
#endif
#ifdef GAMMAREFLECTION
refractionIrradiance.rgb=toLinearSpace(refractionIrradiance.rgb);
#endif
#else
vec4 refractionIrradiance=vec4(0.);
#endif
refractionIrradiance.rgb*=transmittance;
#ifdef SS_ALBEDOFORTRANSLUCENCYTINT
refractionIrradiance.rgb*=surfaceAlbedo.rgb;
#endif
outParams.refractionIrradiance=refractionIrradiance.rgb;
#endif
}
#endif
`;oe.IncludesShadersStore[Ts]=Ss;var Rs="pbrBlockNormalGeometric",Os=`vec3 viewDirectionW=normalize(vEyePosition.xyz-vPositionW);
#ifdef NORMAL
vec3 normalW=normalize(vNormalW);
#else
vec3 normalW=normalize(cross(dFdx(vPositionW),dFdy(vPositionW)))*vEyePosition.w;
#endif
vec3 geometricNormalW=normalW;
#if defined(TWOSIDEDLIGHTING) && defined(NORMAL)
geometricNormalW=gl_FrontFacing ? geometricNormalW : -geometricNormalW;
#endif
`;oe.IncludesShadersStore[Rs]=Os;var Ns="pbrBlockNormalFinal",Is=`#if defined(FORCENORMALFORWARD) && defined(NORMAL)
vec3 faceNormal=normalize(cross(dFdx(vPositionW),dFdy(vPositionW)))*vEyePosition.w;
#if defined(TWOSIDEDLIGHTING)
faceNormal=gl_FrontFacing ? faceNormal : -faceNormal;
#endif
normalW*=sign(dot(normalW,faceNormal));
#endif
#if defined(TWOSIDEDLIGHTING) && defined(NORMAL)
normalW=gl_FrontFacing ? normalW : -normalW;
#endif
`;oe.IncludesShadersStore[Ns]=Is;var Ps="pbrBlockLightmapInit",xs=`#ifdef LIGHTMAP
vec4 lightmapColor=texture2D(lightmapSampler,vLightmapUV+uvOffset);
#ifdef RGBDLIGHTMAP
lightmapColor.rgb=fromRGBD(lightmapColor);
#endif
#ifdef GAMMALIGHTMAP
lightmapColor.rgb=toLinearSpace(lightmapColor.rgb);
#endif
lightmapColor.rgb*=vLightmapInfos.y;
#endif
`;oe.IncludesShadersStore[Ps]=xs;var Ms="pbrBlockGeometryInfo",Ls=`float NdotVUnclamped=dot(normalW,viewDirectionW);
float NdotV=absEps(NdotVUnclamped);
float alphaG=convertRoughnessToAverageSlope(roughness);
vec2 AARoughnessFactors=getAARoughnessFactors(normalW.xyz);
#ifdef SPECULARAA
alphaG+=AARoughnessFactors.y;
#endif
#if defined(ENVIRONMENTBRDF)
vec3 environmentBrdf=getBRDFLookup(NdotV,roughness);
#endif
#if defined(ENVIRONMENTBRDF) && !defined(REFLECTIONMAP_SKYBOX)
#ifdef RADIANCEOCCLUSION
#ifdef AMBIENTINGRAYSCALE
float ambientMonochrome=aoOut.ambientOcclusionColor.r;
#else
float ambientMonochrome=getLuminance(aoOut.ambientOcclusionColor);
#endif
float seo=environmentRadianceOcclusion(ambientMonochrome,NdotVUnclamped);
#endif
#ifdef HORIZONOCCLUSION
#ifdef BUMP
#ifdef REFLECTIONMAP_3D
float eho=environmentHorizonOcclusion(-viewDirectionW,normalW,geometricNormalW);
#endif
#endif
#endif
#endif
`;oe.IncludesShadersStore[Ms]=Ls;var Fs="pbrBlockReflectance0",Ds=`float reflectance=max(max(reflectivityOut.surfaceReflectivityColor.r,reflectivityOut.surfaceReflectivityColor.g),reflectivityOut.surfaceReflectivityColor.b);
vec3 specularEnvironmentR0=reflectivityOut.surfaceReflectivityColor.rgb;
#ifdef METALLICWORKFLOW
vec3 specularEnvironmentR90=vec3(metallicReflectanceFactors.a);
#else 
vec3 specularEnvironmentR90=vec3(1.0,1.0,1.0);
#endif
#ifdef ALPHAFRESNEL
float reflectance90=fresnelGrazingReflectance(reflectance);
specularEnvironmentR90=specularEnvironmentR90*reflectance90;
#endif
`;oe.IncludesShadersStore[Fs]=Ds;var Bs="pbrBlockReflectance",ws=`#if defined(ENVIRONMENTBRDF) && !defined(REFLECTIONMAP_SKYBOX)
vec3 specularEnvironmentReflectance=getReflectanceFromBRDFLookup(clearcoatOut.specularEnvironmentR0,specularEnvironmentR90,environmentBrdf);
#ifdef RADIANCEOCCLUSION
specularEnvironmentReflectance*=seo;
#endif
#ifdef HORIZONOCCLUSION
#ifdef BUMP
#ifdef REFLECTIONMAP_3D
specularEnvironmentReflectance*=eho;
#endif
#endif
#endif
#else
vec3 specularEnvironmentReflectance=getReflectanceFromAnalyticalBRDFLookup_Jones(NdotV,clearcoatOut.specularEnvironmentR0,specularEnvironmentR90,sqrt(microSurface));
#endif
#ifdef CLEARCOAT
specularEnvironmentReflectance*=clearcoatOut.conservationFactor;
#if defined(CLEARCOAT_TINT)
specularEnvironmentReflectance*=clearcoatOut.absorption;
#endif
#endif
`;oe.IncludesShadersStore[Bs]=ws;var Vs="pbrBlockDirectLighting",Us=`vec3 diffuseBase=vec3(0.,0.,0.);
#ifdef SPECULARTERM
vec3 specularBase=vec3(0.,0.,0.);
#endif
#ifdef CLEARCOAT
vec3 clearCoatBase=vec3(0.,0.,0.);
#endif
#ifdef SHEEN
vec3 sheenBase=vec3(0.,0.,0.);
#endif
preLightingInfo preInfo;
lightingInfo info;
float shadow=1.; 
#if defined(CLEARCOAT) && defined(CLEARCOAT_TINT)
vec3 absorption=vec3(0.);
#endif
`;oe.IncludesShadersStore[Vs]=Us;var ks="pbrBlockFinalLitComponents",Gs=`#if defined(ENVIRONMENTBRDF)
#ifdef MS_BRDF_ENERGY_CONSERVATION
vec3 energyConservationFactor=getEnergyConservationFactor(clearcoatOut.specularEnvironmentR0,environmentBrdf);
#endif
#endif
#ifndef METALLICWORKFLOW
#ifdef SPECULAR_GLOSSINESS_ENERGY_CONSERVATION
surfaceAlbedo.rgb=(1.-reflectance)*surfaceAlbedo.rgb;
#endif
#endif
#if defined(SHEEN) && defined(SHEEN_ALBEDOSCALING) && defined(ENVIRONMENTBRDF)
surfaceAlbedo.rgb=sheenOut.sheenAlbedoScaling*surfaceAlbedo.rgb;
#endif
#ifdef REFLECTION
vec3 finalIrradiance=reflectionOut.environmentIrradiance;
#if defined(CLEARCOAT)
finalIrradiance*=clearcoatOut.conservationFactor;
#if defined(CLEARCOAT_TINT)
finalIrradiance*=clearcoatOut.absorption;
#endif
#endif
#if defined(SS_REFRACTION)
finalIrradiance*=subSurfaceOut.refractionFactorForIrradiance;
#endif
#if defined(SS_TRANSLUCENCY)
finalIrradiance*=(1.0-subSurfaceOut.translucencyIntensity);
finalIrradiance+=subSurfaceOut.refractionIrradiance;
#endif
finalIrradiance*=surfaceAlbedo.rgb;
finalIrradiance*=vLightingIntensity.z;
finalIrradiance*=aoOut.ambientOcclusionColor;
#endif
#ifdef SPECULARTERM
vec3 finalSpecular=specularBase;
finalSpecular=max(finalSpecular,0.0);
vec3 finalSpecularScaled=finalSpecular*vLightingIntensity.x*vLightingIntensity.w;
#if defined(ENVIRONMENTBRDF) && defined(MS_BRDF_ENERGY_CONSERVATION)
finalSpecularScaled*=energyConservationFactor;
#endif
#if defined(SHEEN) && defined(ENVIRONMENTBRDF) && defined(SHEEN_ALBEDOSCALING)
finalSpecularScaled*=sheenOut.sheenAlbedoScaling;
#endif
#endif
#ifdef REFLECTION
vec3 finalRadiance=reflectionOut.environmentRadiance.rgb;
finalRadiance*=subSurfaceOut.specularEnvironmentReflectance;
vec3 finalRadianceScaled=finalRadiance*vLightingIntensity.z;
#if defined(ENVIRONMENTBRDF) && defined(MS_BRDF_ENERGY_CONSERVATION)
finalRadianceScaled*=energyConservationFactor;
#endif
#if defined(SHEEN) && defined(ENVIRONMENTBRDF) && defined(SHEEN_ALBEDOSCALING)
finalRadianceScaled*=sheenOut.sheenAlbedoScaling;
#endif
#endif
#ifdef SHEEN
vec3 finalSheen=sheenBase*sheenOut.sheenColor;
finalSheen=max(finalSheen,0.0);
vec3 finalSheenScaled=finalSheen*vLightingIntensity.x*vLightingIntensity.w;
#if defined(CLEARCOAT) && defined(REFLECTION) && defined(ENVIRONMENTBRDF)
sheenOut.finalSheenRadianceScaled*=clearcoatOut.conservationFactor;
#if defined(CLEARCOAT_TINT)
sheenOut.finalSheenRadianceScaled*=clearcoatOut.absorption;
#endif
#endif
#endif
#ifdef CLEARCOAT
vec3 finalClearCoat=clearCoatBase;
finalClearCoat=max(finalClearCoat,0.0);
vec3 finalClearCoatScaled=finalClearCoat*vLightingIntensity.x*vLightingIntensity.w;
#if defined(ENVIRONMENTBRDF) && defined(MS_BRDF_ENERGY_CONSERVATION)
finalClearCoatScaled*=clearcoatOut.energyConservationFactorClearCoat;
#endif
#ifdef SS_REFRACTION
subSurfaceOut.finalRefraction*=clearcoatOut.conservationFactor;
#ifdef CLEARCOAT_TINT
subSurfaceOut.finalRefraction*=clearcoatOut.absorption;
#endif
#endif
#endif
#ifdef ALPHABLEND
float luminanceOverAlpha=0.0;
#if defined(REFLECTION) && defined(RADIANCEOVERALPHA)
luminanceOverAlpha+=getLuminance(finalRadianceScaled);
#if defined(CLEARCOAT)
luminanceOverAlpha+=getLuminance(clearcoatOut.finalClearCoatRadianceScaled);
#endif
#endif
#if defined(SPECULARTERM) && defined(SPECULAROVERALPHA)
luminanceOverAlpha+=getLuminance(finalSpecularScaled);
#endif
#if defined(CLEARCOAT) && defined(CLEARCOATOVERALPHA)
luminanceOverAlpha+=getLuminance(finalClearCoatScaled);
#endif
#if defined(RADIANCEOVERALPHA) || defined(SPECULAROVERALPHA) || defined(CLEARCOATOVERALPHA)
alpha=saturate(alpha+luminanceOverAlpha*luminanceOverAlpha);
#endif
#endif
`;oe.IncludesShadersStore[ks]=Gs;var Hs="pbrBlockFinalUnlitComponents",zs=`vec3 finalDiffuse=diffuseBase;
finalDiffuse*=surfaceAlbedo.rgb;
finalDiffuse=max(finalDiffuse,0.0);
finalDiffuse*=vLightingIntensity.x;
vec3 finalAmbient=vAmbientColor;
finalAmbient*=surfaceAlbedo.rgb;
vec3 finalEmissive=vEmissiveColor;
#ifdef EMISSIVE
vec3 emissiveColorTex=texture2D(emissiveSampler,vEmissiveUV+uvOffset).rgb;
#ifdef GAMMAEMISSIVE
finalEmissive*=toLinearSpace(emissiveColorTex.rgb);
#else
finalEmissive*=emissiveColorTex.rgb;
#endif
finalEmissive*= vEmissiveInfos.y;
#endif
finalEmissive*=vLightingIntensity.y;
#ifdef AMBIENT
vec3 ambientOcclusionForDirectDiffuse=mix(vec3(1.),aoOut.ambientOcclusionColor,vAmbientInfos.w);
#else
vec3 ambientOcclusionForDirectDiffuse=aoOut.ambientOcclusionColor;
#endif
finalAmbient*=aoOut.ambientOcclusionColor;
finalDiffuse*=ambientOcclusionForDirectDiffuse;
`;oe.IncludesShadersStore[Hs]=zs;var Xs="pbrBlockFinalColorComposition",js=`vec4 finalColor=vec4(
finalAmbient +
finalDiffuse +
#ifndef UNLIT
#ifdef REFLECTION
finalIrradiance +
#endif
#ifdef SPECULARTERM
finalSpecularScaled +
#endif
#ifdef SHEEN
finalSheenScaled +
#endif
#ifdef CLEARCOAT
finalClearCoatScaled +
#endif
#ifdef REFLECTION
finalRadianceScaled +
#if defined(SHEEN) && defined(ENVIRONMENTBRDF)
sheenOut.finalSheenRadianceScaled +
#endif
#ifdef CLEARCOAT
clearcoatOut.finalClearCoatRadianceScaled +
#endif
#endif
#ifdef SS_REFRACTION
subSurfaceOut.finalRefraction +
#endif
#endif
finalEmissive,
alpha);
#ifdef LIGHTMAP
#ifndef LIGHTMAPEXCLUDED
#ifdef USELIGHTMAPASSHADOWMAP
finalColor.rgb*=lightmapColor.rgb;
#else
finalColor.rgb+=lightmapColor.rgb;
#endif
#endif
#endif
#define CUSTOM_FRAGMENT_BEFORE_FOG
finalColor=max(finalColor,0.0);
`;oe.IncludesShadersStore[Xs]=js;var Ys="pbrBlockImageProcessing",Ws=`#if defined(IMAGEPROCESSINGPOSTPROCESS) || defined(SS_SCATTERING)
#if !defined(SKIPFINALCOLORCLAMP)
finalColor.rgb=clamp(finalColor.rgb,0.,30.0);
#endif
#else
finalColor=applyImageProcessing(finalColor);
#endif
finalColor.a*=visibility;
#ifdef PREMULTIPLYALPHA
finalColor.rgb*=finalColor.a;
#endif
`;oe.IncludesShadersStore[Ys]=Ws;var Ks="pbrDebug",Qs=`#if DEBUGMODE>0
if (vClipSpacePosition.x/vClipSpacePosition.w>=vDebugMode.x) {
#if DEBUGMODE==1
gl_FragColor.rgb=vPositionW.rgb;
#define DEBUGMODE_NORMALIZE
#elif DEBUGMODE==2 && defined(NORMAL)
gl_FragColor.rgb=vNormalW.rgb;
#define DEBUGMODE_NORMALIZE
#elif DEBUGMODE==3 && defined(BUMP) || DEBUGMODE==3 && defined(PARALLAX) || DEBUGMODE==3 && defined(ANISOTROPIC)
gl_FragColor.rgb=TBN[0];
#define DEBUGMODE_NORMALIZE
#elif DEBUGMODE==4 && defined(BUMP) || DEBUGMODE==4 && defined(PARALLAX) || DEBUGMODE==4 && defined(ANISOTROPIC)
gl_FragColor.rgb=TBN[1];
#define DEBUGMODE_NORMALIZE
#elif DEBUGMODE==5
gl_FragColor.rgb=normalW;
#define DEBUGMODE_NORMALIZE
#elif DEBUGMODE==6 && defined(MAINUV1)
gl_FragColor.rgb=vec3(vMainUV1,0.0);
#elif DEBUGMODE==7 && defined(MAINUV2)
gl_FragColor.rgb=vec3(vMainUV2,0.0);
#elif DEBUGMODE==8 && defined(CLEARCOAT) && defined(CLEARCOAT_BUMP)
gl_FragColor.rgb=clearcoatOut.TBNClearCoat[0];
#define DEBUGMODE_NORMALIZE
#elif DEBUGMODE==9 && defined(CLEARCOAT) && defined(CLEARCOAT_BUMP)
gl_FragColor.rgb=clearcoatOut.TBNClearCoat[1];
#define DEBUGMODE_NORMALIZE
#elif DEBUGMODE==10 && defined(CLEARCOAT)
gl_FragColor.rgb=clearcoatOut.clearCoatNormalW;
#define DEBUGMODE_NORMALIZE
#elif DEBUGMODE==11 && defined(ANISOTROPIC)
gl_FragColor.rgb=anisotropicOut.anisotropicNormal;
#define DEBUGMODE_NORMALIZE
#elif DEBUGMODE==12 && defined(ANISOTROPIC)
gl_FragColor.rgb=anisotropicOut.anisotropicTangent;
#define DEBUGMODE_NORMALIZE
#elif DEBUGMODE==13 && defined(ANISOTROPIC)
gl_FragColor.rgb=anisotropicOut.anisotropicBitangent;
#define DEBUGMODE_NORMALIZE
#elif DEBUGMODE==20 && defined(ALBEDO)
gl_FragColor.rgb=albedoTexture.rgb;
#elif DEBUGMODE==21 && defined(AMBIENT)
gl_FragColor.rgb=aoOut.ambientOcclusionColorMap.rgb;
#elif DEBUGMODE==22 && defined(OPACITY)
gl_FragColor.rgb=opacityMap.rgb;
#elif DEBUGMODE==23 && defined(EMISSIVE)
gl_FragColor.rgb=emissiveColorTex.rgb;
#define DEBUGMODE_GAMMA
#elif DEBUGMODE==24 && defined(LIGHTMAP)
gl_FragColor.rgb=lightmapColor.rgb;
#define DEBUGMODE_GAMMA
#elif DEBUGMODE==25 && defined(REFLECTIVITY) && defined(METALLICWORKFLOW)
gl_FragColor.rgb=reflectivityOut.surfaceMetallicColorMap.rgb;
#elif DEBUGMODE==26 && defined(REFLECTIVITY) && !defined(METALLICWORKFLOW)
gl_FragColor.rgb=reflectivityOut.surfaceReflectivityColorMap.rgb;
#define DEBUGMODE_GAMMA
#elif DEBUGMODE==27 && defined(CLEARCOAT) && defined(CLEARCOAT_TEXTURE)
gl_FragColor.rgb=vec3(clearcoatOut.clearCoatMapData.rg,0.0);
#elif DEBUGMODE==28 && defined(CLEARCOAT) && defined(CLEARCOAT_TINT) && defined(CLEARCOAT_TINT_TEXTURE)
gl_FragColor.rgb=clearcoatOut.clearCoatTintMapData.rgb;
#elif DEBUGMODE==29 && defined(SHEEN) && defined(SHEEN_TEXTURE)
gl_FragColor.rgb=sheenOut.sheenMapData.rgb;
#elif DEBUGMODE==30 && defined(ANISOTROPIC) && defined(ANISOTROPIC_TEXTURE)
gl_FragColor.rgb=anisotropicOut.anisotropyMapData.rgb;
#elif DEBUGMODE==31 && defined(SUBSURFACE) && defined(SS_THICKNESSANDMASK_TEXTURE)
gl_FragColor.rgb=subSurfaceOut.thicknessMap.rgb;
#elif DEBUGMODE==40 && defined(SS_REFRACTION)
gl_FragColor.rgb=subSurfaceOut.environmentRefraction.rgb;
#define DEBUGMODE_GAMMA
#elif DEBUGMODE==41 && defined(REFLECTION)
gl_FragColor.rgb=reflectionOut.environmentRadiance.rgb;
#define DEBUGMODE_GAMMA
#elif DEBUGMODE==42 && defined(CLEARCOAT) && defined(REFLECTION)
gl_FragColor.rgb=clearcoatOut.environmentClearCoatRadiance.rgb;
#define DEBUGMODE_GAMMA
#elif DEBUGMODE==50
gl_FragColor.rgb=diffuseBase.rgb;
#define DEBUGMODE_GAMMA
#elif DEBUGMODE==51 && defined(SPECULARTERM)
gl_FragColor.rgb=specularBase.rgb;
#define DEBUGMODE_GAMMA
#elif DEBUGMODE==52 && defined(CLEARCOAT)
gl_FragColor.rgb=clearCoatBase.rgb;
#define DEBUGMODE_GAMMA
#elif DEBUGMODE==53 && defined(SHEEN)
gl_FragColor.rgb=sheenBase.rgb;
#define DEBUGMODE_GAMMA
#elif DEBUGMODE==54 && defined(REFLECTION)
gl_FragColor.rgb=reflectionOut.environmentIrradiance.rgb;
#define DEBUGMODE_GAMMA
#elif DEBUGMODE==60
gl_FragColor.rgb=surfaceAlbedo.rgb;
#define DEBUGMODE_GAMMA
#elif DEBUGMODE==61
gl_FragColor.rgb=clearcoatOut.specularEnvironmentR0;
#define DEBUGMODE_GAMMA
#elif DEBUGMODE==62 && defined(METALLICWORKFLOW)
gl_FragColor.rgb=vec3(reflectivityOut.metallicRoughness.r);
#elif DEBUGMODE==71 && defined(METALLICWORKFLOW)
gl_FragColor.rgb=reflectivityOut.metallicF0;
#elif DEBUGMODE==63
gl_FragColor.rgb=vec3(roughness);
#elif DEBUGMODE==64
gl_FragColor.rgb=vec3(alphaG);
#elif DEBUGMODE==65
gl_FragColor.rgb=vec3(NdotV);
#elif DEBUGMODE==66 && defined(CLEARCOAT) && defined(CLEARCOAT_TINT)
gl_FragColor.rgb=clearcoatOut.clearCoatColor.rgb;
#define DEBUGMODE_GAMMA
#elif DEBUGMODE==67 && defined(CLEARCOAT)
gl_FragColor.rgb=vec3(clearcoatOut.clearCoatRoughness);
#elif DEBUGMODE==68 && defined(CLEARCOAT)
gl_FragColor.rgb=vec3(clearcoatOut.clearCoatNdotV);
#elif DEBUGMODE==69 && defined(SUBSURFACE) && defined(SS_TRANSLUCENCY)
gl_FragColor.rgb=subSurfaceOut.transmittance;
#elif DEBUGMODE==70 && defined(SUBSURFACE) && defined(SS_REFRACTION)
gl_FragColor.rgb=subSurfaceOut.refractionTransmittance;
#elif DEBUGMODE==80 && defined(RADIANCEOCCLUSION)
gl_FragColor.rgb=vec3(seo);
#elif DEBUGMODE==81 && defined(HORIZONOCCLUSION)
gl_FragColor.rgb=vec3(eho);
#elif DEBUGMODE==82 && defined(MS_BRDF_ENERGY_CONSERVATION)
gl_FragColor.rgb=vec3(energyConservationFactor);
#elif DEBUGMODE==83 && defined(ENVIRONMENTBRDF) && !defined(REFLECTIONMAP_SKYBOX)
gl_FragColor.rgb=specularEnvironmentReflectance;
#define DEBUGMODE_GAMMA
#elif DEBUGMODE==84 && defined(CLEARCOAT) && defined(ENVIRONMENTBRDF) && !defined(REFLECTIONMAP_SKYBOX)
gl_FragColor.rgb=clearcoatOut.clearCoatEnvironmentReflectance;
#define DEBUGMODE_GAMMA
#elif DEBUGMODE==85 && defined(SHEEN) && defined(REFLECTION)
gl_FragColor.rgb=sheenOut.sheenEnvironmentReflectance;
#define DEBUGMODE_GAMMA
#elif DEBUGMODE==86 && defined(ALPHABLEND)
gl_FragColor.rgb=vec3(luminanceOverAlpha);
#elif DEBUGMODE==87
gl_FragColor.rgb=vec3(alpha);
#endif
gl_FragColor.rgb*=vDebugMode.y;
#ifdef DEBUGMODE_NORMALIZE
gl_FragColor.rgb=normalize(gl_FragColor.rgb)*0.5+0.5;
#endif
#ifdef DEBUGMODE_GAMMA
gl_FragColor.rgb=toGammaSpace(gl_FragColor.rgb);
#endif
gl_FragColor.a=1.0;
#ifdef PREPASS
gl_FragData[0]=toLinearSpace(gl_FragColor); 
gl_FragData[1]=vec4(0.,0.,0.,0.); 
#endif
return;
}
#endif
`;oe.IncludesShadersStore[Ks]=Qs;var qs="pbrPixelShader",Zs=`#if defined(BUMP) || !defined(NORMAL) || defined(FORCENORMALFORWARD) || defined(SPECULARAA) || defined(CLEARCOAT_BUMP) || defined(ANISOTROPIC)
#extension GL_OES_standard_derivatives : enable
#endif
#ifdef LODBASEDMICROSFURACE
#extension GL_EXT_shader_texture_lod : enable
#endif
#define CUSTOM_FRAGMENT_BEGIN
#ifdef LOGARITHMICDEPTH
#extension GL_EXT_frag_depth : enable
#endif
#include<prePassDeclaration>[SCENE_MRT_COUNT]
precision highp float;
#include<oitDeclaration>
#ifndef FROMLINEARSPACE
#define FROMLINEARSPACE
#endif
#include<__decl__pbrFragment>
#include<pbrFragmentExtraDeclaration>
#include<__decl__lightFragment>[0..maxSimultaneousLights]
#include<pbrFragmentSamplersDeclaration>
#include<imageProcessingDeclaration>
#include<clipPlaneFragmentDeclaration>
#include<logDepthDeclaration>
#include<fogFragmentDeclaration>
#include<helperFunctions>
#include<subSurfaceScatteringFunctions>
#include<importanceSampling>
#include<pbrHelperFunctions>
#include<imageProcessingFunctions>
#include<shadowsFragmentFunctions>
#include<harmonicsFunctions>
#include<pbrDirectLightingSetupFunctions>
#include<pbrDirectLightingFalloffFunctions>
#include<pbrBRDFFunctions>
#include<hdrFilteringFunctions>
#include<pbrDirectLightingFunctions>
#include<pbrIBLFunctions>
#include<bumpFragmentMainFunctions>
#include<bumpFragmentFunctions>
#ifdef REFLECTION
#include<reflectionFunction>
#endif
#define CUSTOM_FRAGMENT_DEFINITIONS
#include<pbrBlockAlbedoOpacity>
#include<pbrBlockReflectivity>
#include<pbrBlockAmbientOcclusion>
#include<pbrBlockAlphaFresnel>
#include<pbrBlockAnisotropic>
#include<pbrBlockReflection>
#include<pbrBlockSheen>
#include<pbrBlockClearcoat>
#include<pbrBlockSubSurface>
void main(void) {
#define CUSTOM_FRAGMENT_MAIN_BEGIN
#include<oitFragment>
#include<clipPlaneFragment>
#include<pbrBlockNormalGeometric>
#include<bumpFragment>
#include<pbrBlockNormalFinal>
albedoOpacityOutParams albedoOpacityOut;
#ifdef ALBEDO
vec4 albedoTexture=texture2D(albedoSampler,vAlbedoUV+uvOffset);
#endif
#ifdef OPACITY
vec4 opacityMap=texture2D(opacitySampler,vOpacityUV+uvOffset);
#endif
albedoOpacityBlock(
vAlbedoColor,
#ifdef ALBEDO
albedoTexture,
vAlbedoInfos,
#endif
#ifdef OPACITY
opacityMap,
vOpacityInfos,
#endif
#ifdef DETAIL
detailColor,
vDetailInfos,
#endif
albedoOpacityOut
);
vec3 surfaceAlbedo=albedoOpacityOut.surfaceAlbedo;
float alpha=albedoOpacityOut.alpha;
#define CUSTOM_FRAGMENT_UPDATE_ALPHA
#include<depthPrePass>
#define CUSTOM_FRAGMENT_BEFORE_LIGHTS
ambientOcclusionOutParams aoOut;
#ifdef AMBIENT
vec3 ambientOcclusionColorMap=texture2D(ambientSampler,vAmbientUV+uvOffset).rgb;
#endif
ambientOcclusionBlock(
#ifdef AMBIENT
ambientOcclusionColorMap,
vAmbientInfos,
#endif
aoOut
);
#include<pbrBlockLightmapInit>
#ifdef UNLIT
vec3 diffuseBase=vec3(1.,1.,1.);
#else
vec3 baseColor=surfaceAlbedo;
reflectivityOutParams reflectivityOut;
#if defined(REFLECTIVITY)
vec4 surfaceMetallicOrReflectivityColorMap=texture2D(reflectivitySampler,vReflectivityUV+uvOffset);
vec4 baseReflectivity=surfaceMetallicOrReflectivityColorMap;
#ifndef METALLICWORKFLOW
#ifdef REFLECTIVITY_GAMMA
surfaceMetallicOrReflectivityColorMap=toLinearSpace(surfaceMetallicOrReflectivityColorMap);
#endif
surfaceMetallicOrReflectivityColorMap.rgb*=vReflectivityInfos.y;
#endif
#endif
#if defined(MICROSURFACEMAP)
vec4 microSurfaceTexel=texture2D(microSurfaceSampler,vMicroSurfaceSamplerUV+uvOffset)*vMicroSurfaceSamplerInfos.y;
#endif
#ifdef METALLICWORKFLOW
vec4 metallicReflectanceFactors=vMetallicReflectanceFactors;
#ifdef REFLECTANCE
vec4 reflectanceFactorsMap=texture2D(reflectanceSampler,vReflectanceUV+uvOffset);
#ifdef REFLECTANCE_GAMMA
reflectanceFactorsMap=toLinearSpace(reflectanceFactorsMap);
#endif
metallicReflectanceFactors.rgb*=reflectanceFactorsMap.rgb;
#endif
#ifdef METALLIC_REFLECTANCE
vec4 metallicReflectanceFactorsMap=texture2D(metallicReflectanceSampler,vMetallicReflectanceUV+uvOffset);
#ifdef METALLIC_REFLECTANCE_GAMMA
metallicReflectanceFactorsMap=toLinearSpace(metallicReflectanceFactorsMap);
#endif
#ifndef METALLIC_REFLECTANCE_USE_ALPHA_ONLY
metallicReflectanceFactors.rgb*=metallicReflectanceFactorsMap.rgb;
#endif
metallicReflectanceFactors*=metallicReflectanceFactorsMap.a;
#endif
#endif
reflectivityBlock(
vReflectivityColor,
#ifdef METALLICWORKFLOW
surfaceAlbedo,
metallicReflectanceFactors,
#endif
#ifdef REFLECTIVITY
vReflectivityInfos,
surfaceMetallicOrReflectivityColorMap,
#endif
#if defined(METALLICWORKFLOW) && defined(REFLECTIVITY) && defined(AOSTOREINMETALMAPRED)
aoOut.ambientOcclusionColor,
#endif
#ifdef MICROSURFACEMAP
microSurfaceTexel,
#endif
#ifdef DETAIL
detailColor,
vDetailInfos,
#endif
reflectivityOut
);
float microSurface=reflectivityOut.microSurface;
float roughness=reflectivityOut.roughness;
#ifdef METALLICWORKFLOW
surfaceAlbedo=reflectivityOut.surfaceAlbedo;
#endif
#if defined(METALLICWORKFLOW) && defined(REFLECTIVITY) && defined(AOSTOREINMETALMAPRED)
aoOut.ambientOcclusionColor=reflectivityOut.ambientOcclusionColor;
#endif
#ifdef ALPHAFRESNEL
#if defined(ALPHATEST) || defined(ALPHABLEND)
alphaFresnelOutParams alphaFresnelOut;
alphaFresnelBlock(
normalW,
viewDirectionW,
alpha,
microSurface,
alphaFresnelOut
);
alpha=alphaFresnelOut.alpha;
#endif
#endif
#include<pbrBlockGeometryInfo>
#ifdef ANISOTROPIC
anisotropicOutParams anisotropicOut;
#ifdef ANISOTROPIC_TEXTURE
vec3 anisotropyMapData=texture2D(anisotropySampler,vAnisotropyUV+uvOffset).rgb*vAnisotropyInfos.y;
#endif
anisotropicBlock(
vAnisotropy,
#ifdef ANISOTROPIC_TEXTURE
anisotropyMapData,
#endif
TBN,
normalW,
viewDirectionW,
anisotropicOut
);
#endif
#ifdef REFLECTION
reflectionOutParams reflectionOut;
#ifndef USE_CUSTOM_REFLECTION
reflectionBlock(
vPositionW,
normalW,
alphaG,
vReflectionMicrosurfaceInfos,
vReflectionInfos,
vReflectionColor,
#ifdef ANISOTROPIC
anisotropicOut,
#endif
#if defined(LODINREFLECTIONALPHA) && !defined(REFLECTIONMAP_SKYBOX)
NdotVUnclamped,
#endif
#ifdef LINEARSPECULARREFLECTION
roughness,
#endif
reflectionSampler,
#if defined(NORMAL) && defined(USESPHERICALINVERTEX)
vEnvironmentIrradiance,
#endif
#ifdef USESPHERICALFROMREFLECTIONMAP
#if !defined(NORMAL) || !defined(USESPHERICALINVERTEX)
reflectionMatrix,
#endif
#endif
#ifdef USEIRRADIANCEMAP
irradianceSampler,
#endif
#ifndef LODBASEDMICROSFURACE
reflectionSamplerLow,
reflectionSamplerHigh,
#endif
#ifdef REALTIME_FILTERING
vReflectionFilteringInfo,
#endif
reflectionOut
);
#else
#define CUSTOM_REFLECTION
#endif
#endif
#include<pbrBlockReflectance0>
#ifdef SHEEN
sheenOutParams sheenOut;
#ifdef SHEEN_TEXTURE
vec4 sheenMapData=texture2D(sheenSampler,vSheenUV+uvOffset);
#endif
#if defined(SHEEN_ROUGHNESS) && defined(SHEEN_TEXTURE_ROUGHNESS) && !defined(SHEEN_TEXTURE_ROUGHNESS_IDENTICAL) && !defined(SHEEN_USE_ROUGHNESS_FROM_MAINTEXTURE)
vec4 sheenMapRoughnessData=texture2D(sheenRoughnessSampler,vSheenRoughnessUV+uvOffset)*vSheenInfos.w;
#endif
sheenBlock(
vSheenColor,
#ifdef SHEEN_ROUGHNESS
vSheenRoughness,
#if defined(SHEEN_TEXTURE_ROUGHNESS) && !defined(SHEEN_TEXTURE_ROUGHNESS_IDENTICAL) && !defined(SHEEN_USE_ROUGHNESS_FROM_MAINTEXTURE)
sheenMapRoughnessData,
#endif
#endif
roughness,
#ifdef SHEEN_TEXTURE
sheenMapData,
vSheenInfos.y,
#endif
reflectance,
#ifdef SHEEN_LINKWITHALBEDO
baseColor,
surfaceAlbedo,
#endif
#ifdef ENVIRONMENTBRDF
NdotV,
environmentBrdf,
#endif
#if defined(REFLECTION) && defined(ENVIRONMENTBRDF)
AARoughnessFactors,
vReflectionMicrosurfaceInfos,
vReflectionInfos,
vReflectionColor,
vLightingIntensity,
reflectionSampler,
reflectionOut.reflectionCoords,
NdotVUnclamped,
#ifndef LODBASEDMICROSFURACE
reflectionSamplerLow,
reflectionSamplerHigh,
#endif
#ifdef REALTIME_FILTERING
vReflectionFilteringInfo,
#endif
#if !defined(REFLECTIONMAP_SKYBOX) && defined(RADIANCEOCCLUSION)
seo,
#endif
#if !defined(REFLECTIONMAP_SKYBOX) && defined(HORIZONOCCLUSION) && defined(BUMP) && defined(REFLECTIONMAP_3D)
eho,
#endif
#endif
sheenOut
);
#ifdef SHEEN_LINKWITHALBEDO
surfaceAlbedo=sheenOut.surfaceAlbedo;
#endif
#endif
clearcoatOutParams clearcoatOut;
#ifdef CLEARCOAT
#ifdef CLEARCOAT_TEXTURE
vec2 clearCoatMapData=texture2D(clearCoatSampler,vClearCoatUV+uvOffset).rg*vClearCoatInfos.y;
#endif
#if defined(CLEARCOAT_TEXTURE_ROUGHNESS) && !defined(CLEARCOAT_TEXTURE_ROUGHNESS_IDENTICAL) && !defined(CLEARCOAT_USE_ROUGHNESS_FROM_MAINTEXTURE)
vec4 clearCoatMapRoughnessData=texture2D(clearCoatRoughnessSampler,vClearCoatRoughnessUV+uvOffset)*vClearCoatInfos.w;
#endif
#if defined(CLEARCOAT_TINT) && defined(CLEARCOAT_TINT_TEXTURE)
vec4 clearCoatTintMapData=texture2D(clearCoatTintSampler,vClearCoatTintUV+uvOffset);
#endif
#ifdef CLEARCOAT_BUMP
vec4 clearCoatBumpMapData=texture2D(clearCoatBumpSampler,vClearCoatBumpUV+uvOffset);
#endif
clearcoatBlock(
vPositionW,
geometricNormalW,
viewDirectionW,
vClearCoatParams,
#if defined(CLEARCOAT_TEXTURE_ROUGHNESS) && !defined(CLEARCOAT_TEXTURE_ROUGHNESS_IDENTICAL) && !defined(CLEARCOAT_USE_ROUGHNESS_FROM_MAINTEXTURE)
clearCoatMapRoughnessData,
#endif
specularEnvironmentR0,
#ifdef CLEARCOAT_TEXTURE
clearCoatMapData,
#endif
#ifdef CLEARCOAT_TINT
vClearCoatTintParams,
clearCoatColorAtDistance,
vClearCoatRefractionParams,
#ifdef CLEARCOAT_TINT_TEXTURE
clearCoatTintMapData,
#endif
#endif
#ifdef CLEARCOAT_BUMP
vClearCoatBumpInfos,
clearCoatBumpMapData,
vClearCoatBumpUV,
#if defined(TANGENT) && defined(NORMAL)
vTBN,
#else
vClearCoatTangentSpaceParams,
#endif
#ifdef OBJECTSPACE_NORMALMAP
normalMatrix,
#endif
#endif
#if defined(FORCENORMALFORWARD) && defined(NORMAL)
faceNormal,
#endif
#ifdef REFLECTION
vReflectionMicrosurfaceInfos,
vReflectionInfos,
vReflectionColor,
vLightingIntensity,
reflectionSampler,
#ifndef LODBASEDMICROSFURACE
reflectionSamplerLow,
reflectionSamplerHigh,
#endif
#ifdef REALTIME_FILTERING
vReflectionFilteringInfo,
#endif
#endif
#if defined(ENVIRONMENTBRDF) && !defined(REFLECTIONMAP_SKYBOX)
#ifdef RADIANCEOCCLUSION
ambientMonochrome,
#endif
#endif
#if defined(CLEARCOAT_BUMP) || defined(TWOSIDEDLIGHTING)
(gl_FrontFacing ? 1. : -1.),
#endif
clearcoatOut
);
#else
clearcoatOut.specularEnvironmentR0=specularEnvironmentR0;
#endif
#include<pbrBlockReflectance>
subSurfaceOutParams subSurfaceOut;
#ifdef SUBSURFACE
#ifdef SS_THICKNESSANDMASK_TEXTURE
vec4 thicknessMap=texture2D(thicknessSampler,vThicknessUV+uvOffset);
#endif
#ifdef SS_REFRACTIONINTENSITY_TEXTURE
vec4 refractionIntensityMap=texture2D(refractionIntensitySampler,vRefractionIntensityUV+uvOffset);
#endif
#ifdef SS_TRANSLUCENCYINTENSITY_TEXTURE
vec4 translucencyIntensityMap=texture2D(translucencyIntensitySampler,vTranslucencyIntensityUV+uvOffset);
#endif
subSurfaceBlock(
vSubSurfaceIntensity,
vThicknessParam,
vTintColor,
normalW,
specularEnvironmentReflectance,
#ifdef SS_THICKNESSANDMASK_TEXTURE
thicknessMap,
#endif
#ifdef SS_REFRACTIONINTENSITY_TEXTURE
refractionIntensityMap,
#endif
#ifdef SS_TRANSLUCENCYINTENSITY_TEXTURE
translucencyIntensityMap,
#endif
#ifdef REFLECTION
#ifdef SS_TRANSLUCENCY
reflectionMatrix,
#ifdef USESPHERICALFROMREFLECTIONMAP
#if !defined(NORMAL) || !defined(USESPHERICALINVERTEX)
reflectionOut.irradianceVector,
#endif
#if defined(REALTIME_FILTERING)
reflectionSampler,
vReflectionFilteringInfo,
#endif
#endif
#ifdef USEIRRADIANCEMAP
irradianceSampler,
#endif
#endif
#endif
#if defined(SS_REFRACTION) || defined(SS_TRANSLUCENCY)
surfaceAlbedo,
#endif
#ifdef SS_REFRACTION
vPositionW,
viewDirectionW,
view,
vRefractionInfos,
refractionMatrix,
vRefractionMicrosurfaceInfos,
vLightingIntensity,
#ifdef SS_LINKREFRACTIONTOTRANSPARENCY
alpha,
#endif
#ifdef SS_LODINREFRACTIONALPHA
NdotVUnclamped,
#endif
#ifdef SS_LINEARSPECULARREFRACTION
roughness,
#endif
alphaG,
refractionSampler,
#ifndef LODBASEDMICROSFURACE
refractionSamplerLow,
refractionSamplerHigh,
#endif
#ifdef ANISOTROPIC
anisotropicOut,
#endif
#ifdef REALTIME_FILTERING
vRefractionFilteringInfo,
#endif
#ifdef SS_USE_LOCAL_REFRACTIONMAP_CUBIC
vRefractionPosition,
vRefractionSize,
#endif
#endif
#ifdef SS_TRANSLUCENCY
vDiffusionDistance,
#endif
subSurfaceOut
);
#ifdef SS_REFRACTION
surfaceAlbedo=subSurfaceOut.surfaceAlbedo;
#ifdef SS_LINKREFRACTIONTOTRANSPARENCY
alpha=subSurfaceOut.alpha;
#endif
#endif
#else
subSurfaceOut.specularEnvironmentReflectance=specularEnvironmentReflectance;
#endif
#include<pbrBlockDirectLighting>
#include<lightFragment>[0..maxSimultaneousLights]
#include<pbrBlockFinalLitComponents>
#endif 
#include<pbrBlockFinalUnlitComponents>
#define CUSTOM_FRAGMENT_BEFORE_FINALCOLORCOMPOSITION
#include<pbrBlockFinalColorComposition>
#include<logDepthFragment>
#include<fogFragment>(color,finalColor)
#include<pbrBlockImageProcessing>
#define CUSTOM_FRAGMENT_BEFORE_FRAGCOLOR
#ifdef PREPASS
float writeGeometryInfo=finalColor.a>0.4 ? 1.0 : 0.0;
#ifdef PREPASS_POSITION
gl_FragData[PREPASS_POSITION_INDEX]=vec4(vPositionW,writeGeometryInfo);
#endif
#ifdef PREPASS_VELOCITY
vec2 a=(vCurrentPosition.xy/vCurrentPosition.w)*0.5+0.5;
vec2 b=(vPreviousPosition.xy/vPreviousPosition.w)*0.5+0.5;
vec2 velocity=abs(a-b);
velocity=vec2(pow(velocity.x,1.0/3.0),pow(velocity.y,1.0/3.0))*sign(a-b)*0.5+0.5;
gl_FragData[PREPASS_VELOCITY_INDEX]=vec4(velocity,0.0,writeGeometryInfo);
#endif
#ifdef PREPASS_ALBEDO_SQRT
vec3 sqAlbedo=sqrt(surfaceAlbedo); 
#endif
#ifdef PREPASS_IRRADIANCE
vec3 irradiance=finalDiffuse;
#ifndef UNLIT
#ifdef REFLECTION
irradiance+=finalIrradiance;
#endif
#endif
#ifdef SS_SCATTERING
gl_FragData[0]=vec4(finalColor.rgb-irradiance,finalColor.a); 
irradiance/=sqAlbedo;
#else
gl_FragData[0]=finalColor; 
float scatteringDiffusionProfile=255.;
#endif
gl_FragData[PREPASS_IRRADIANCE_INDEX]=vec4(clamp(irradiance,vec3(0.),vec3(1.)),writeGeometryInfo*scatteringDiffusionProfile/255.); 
#else
gl_FragData[0]=vec4(finalColor.rgb,finalColor.a);
#endif
#ifdef PREPASS_DEPTH
gl_FragData[PREPASS_DEPTH_INDEX]=vec4(vViewPos.z,0.0,0.0,writeGeometryInfo); 
#endif
#ifdef PREPASS_NORMAL
gl_FragData[PREPASS_NORMAL_INDEX]=vec4((view*vec4(normalW,0.0)).rgb,writeGeometryInfo); 
#endif
#ifdef PREPASS_ALBEDO_SQRT
gl_FragData[PREPASS_ALBEDO_SQRT_INDEX]=vec4(sqAlbedo,writeGeometryInfo); 
#endif
#ifdef PREPASS_REFLECTIVITY
#if defined(REFLECTIVITY)
gl_FragData[PREPASS_REFLECTIVITY_INDEX]=vec4(baseReflectivity.rgb,baseReflectivity.a*writeGeometryInfo);
#else
gl_FragData[PREPASS_REFLECTIVITY_INDEX]=vec4(0.0,0.0,0.0,writeGeometryInfo);
#endif
#endif
#endif
#if !defined(PREPASS) || defined(WEBGL2)
gl_FragColor=finalColor;
#endif
#if ORDER_INDEPENDENT_TRANSPARENCY
if (fragDepth==nearestDepth) {
frontColor.rgb+=finalColor.rgb*finalColor.a*alphaMultiplier;
frontColor.a=1.0-alphaMultiplier*(1.0-finalColor.a);
} else {
backColor+=finalColor;
}
#endif
#include<pbrDebug>
#define CUSTOM_FRAGMENT_MAIN_END
}
`;oe.ShadersStore[qs]=Zs;var Js="pbrVertexDeclaration",$s=`uniform mat4 view;
uniform mat4 viewProjection;
#ifdef ALBEDO
uniform mat4 albedoMatrix;
uniform vec2 vAlbedoInfos;
#endif
#ifdef AMBIENT
uniform mat4 ambientMatrix;
uniform vec4 vAmbientInfos;
#endif
#ifdef OPACITY
uniform mat4 opacityMatrix;
uniform vec2 vOpacityInfos;
#endif
#ifdef EMISSIVE
uniform vec2 vEmissiveInfos;
uniform mat4 emissiveMatrix;
#endif
#ifdef LIGHTMAP
uniform vec2 vLightmapInfos;
uniform mat4 lightmapMatrix;
#endif
#ifdef REFLECTIVITY 
uniform vec3 vReflectivityInfos;
uniform mat4 reflectivityMatrix;
#endif
#ifdef METALLIC_REFLECTANCE
uniform vec2 vMetallicReflectanceInfos;
uniform mat4 metallicReflectanceMatrix;
#endif
#ifdef REFLECTANCE
uniform vec2 vReflectanceInfos;
uniform mat4 reflectanceMatrix;
#endif
#ifdef MICROSURFACEMAP
uniform vec2 vMicroSurfaceSamplerInfos;
uniform mat4 microSurfaceSamplerMatrix;
#endif
#ifdef BUMP
uniform vec3 vBumpInfos;
uniform mat4 bumpMatrix;
#endif
#ifdef POINTSIZE
uniform float pointSize;
#endif
#ifdef REFLECTION
uniform vec2 vReflectionInfos;
uniform mat4 reflectionMatrix;
#endif
#ifdef CLEARCOAT
#if defined(CLEARCOAT_TEXTURE) || defined(CLEARCOAT_TEXTURE_ROUGHNESS)
uniform vec4 vClearCoatInfos;
#endif
#ifdef CLEARCOAT_TEXTURE
uniform mat4 clearCoatMatrix;
#endif
#ifdef CLEARCOAT_TEXTURE_ROUGHNESS
uniform mat4 clearCoatRoughnessMatrix;
#endif
#ifdef CLEARCOAT_BUMP
uniform vec2 vClearCoatBumpInfos;
uniform mat4 clearCoatBumpMatrix;
#endif
#ifdef CLEARCOAT_TINT_TEXTURE
uniform vec2 vClearCoatTintInfos;
uniform mat4 clearCoatTintMatrix;
#endif
#endif
#ifdef ANISOTROPIC
#ifdef ANISOTROPIC_TEXTURE
uniform vec2 vAnisotropyInfos;
uniform mat4 anisotropyMatrix;
#endif
#endif
#ifdef SHEEN
#if defined(SHEEN_TEXTURE) || defined(SHEEN_TEXTURE_ROUGHNESS)
uniform vec4 vSheenInfos;
#endif
#ifdef SHEEN_TEXTURE
uniform mat4 sheenMatrix;
#endif
#ifdef SHEEN_TEXTURE_ROUGHNESS
uniform mat4 sheenRoughnessMatrix;
#endif
#endif
#ifdef SUBSURFACE
#ifdef SS_REFRACTION
uniform vec4 vRefractionInfos;
uniform mat4 refractionMatrix;
#endif
#ifdef SS_THICKNESSANDMASK_TEXTURE
uniform vec2 vThicknessInfos;
uniform mat4 thicknessMatrix;
#endif
#ifdef SS_REFRACTIONINTENSITY_TEXTURE
uniform vec2 vRefractionIntensityInfos;
uniform mat4 refractionIntensityMatrix;
#endif
#ifdef SS_TRANSLUCENCYINTENSITY_TEXTURE
uniform vec2 vTranslucencyIntensityInfos;
uniform mat4 translucencyIntensityMatrix;
#endif
#endif
#ifdef NORMAL
#if defined(USESPHERICALFROMREFLECTIONMAP) && defined(USESPHERICALINVERTEX)
#ifdef USESPHERICALFROMREFLECTIONMAP
#ifdef SPHERICAL_HARMONICS
uniform vec3 vSphericalL00;
uniform vec3 vSphericalL1_1;
uniform vec3 vSphericalL10;
uniform vec3 vSphericalL11;
uniform vec3 vSphericalL2_2;
uniform vec3 vSphericalL2_1;
uniform vec3 vSphericalL20;
uniform vec3 vSphericalL21;
uniform vec3 vSphericalL22;
#else
uniform vec3 vSphericalX;
uniform vec3 vSphericalY;
uniform vec3 vSphericalZ;
uniform vec3 vSphericalXX_ZZ;
uniform vec3 vSphericalYY_ZZ;
uniform vec3 vSphericalZZ;
uniform vec3 vSphericalXY;
uniform vec3 vSphericalYZ;
uniform vec3 vSphericalZX;
#endif
#endif
#endif
#endif
#ifdef DETAIL
uniform vec4 vDetailInfos;
uniform mat4 detailMatrix;
#endif
#define ADDITIONAL_VERTEX_DECLARATION
`;oe.IncludesShadersStore[Js]=$s;var ec="pbrVertexShader",tc=`precision highp float;
#include<__decl__pbrVertex>
#define CUSTOM_VERTEX_BEGIN
attribute vec3 position;
#ifdef NORMAL
attribute vec3 normal;
#endif
#ifdef TANGENT
attribute vec4 tangent;
#endif
#ifdef UV1
attribute vec2 uv;
#endif
#include<uvAttributeDeclaration>[2..7]
#include<mainUVVaryingDeclaration>[1..7]
#ifdef VERTEXCOLOR
attribute vec4 color;
#endif
#include<helperFunctions>
#include<bonesDeclaration>
#include<bakedVertexAnimationDeclaration>
#include<instancesDeclaration>
#include<prePassVertexDeclaration>
#include<samplerVertexDeclaration>(_DEFINENAME_,ALBEDO,_VARYINGNAME_,Albedo)
#include<samplerVertexDeclaration>(_DEFINENAME_,DETAIL,_VARYINGNAME_,Detail)
#include<samplerVertexDeclaration>(_DEFINENAME_,AMBIENT,_VARYINGNAME_,Ambient)
#include<samplerVertexDeclaration>(_DEFINENAME_,OPACITY,_VARYINGNAME_,Opacity)
#include<samplerVertexDeclaration>(_DEFINENAME_,EMISSIVE,_VARYINGNAME_,Emissive)
#include<samplerVertexDeclaration>(_DEFINENAME_,LIGHTMAP,_VARYINGNAME_,Lightmap)
#include<samplerVertexDeclaration>(_DEFINENAME_,REFLECTIVITY,_VARYINGNAME_,Reflectivity)
#include<samplerVertexDeclaration>(_DEFINENAME_,MICROSURFACEMAP,_VARYINGNAME_,MicroSurfaceSampler)
#include<samplerVertexDeclaration>(_DEFINENAME_,METALLIC_REFLECTANCE,_VARYINGNAME_,MetallicReflectance)
#include<samplerVertexDeclaration>(_DEFINENAME_,REFLECTANCE,_VARYINGNAME_,Reflectance)
#include<samplerVertexDeclaration>(_DEFINENAME_,BUMP,_VARYINGNAME_,Bump)
#ifdef CLEARCOAT
#include<samplerVertexDeclaration>(_DEFINENAME_,CLEARCOAT_TEXTURE,_VARYINGNAME_,ClearCoat)
#include<samplerVertexDeclaration>(_DEFINENAME_,CLEARCOAT_TEXTURE_ROUGHNESS,_VARYINGNAME_,ClearCoatRoughness)
#include<samplerVertexDeclaration>(_DEFINENAME_,CLEARCOAT_BUMP,_VARYINGNAME_,ClearCoatBump)
#include<samplerVertexDeclaration>(_DEFINENAME_,CLEARCOAT_TINT_TEXTURE,_VARYINGNAME_,ClearCoatTint)
#endif
#ifdef SHEEN
#include<samplerVertexDeclaration>(_DEFINENAME_,SHEEN_TEXTURE,_VARYINGNAME_,Sheen)
#include<samplerVertexDeclaration>(_DEFINENAME_,SHEEN_TEXTURE_ROUGHNESS,_VARYINGNAME_,SheenRoughness)
#endif
#ifdef ANISOTROPIC
#include<samplerVertexDeclaration>(_DEFINENAME_,ANISOTROPIC_TEXTURE,_VARYINGNAME_,Anisotropy)
#endif
#ifdef SUBSURFACE
#include<samplerVertexDeclaration>(_DEFINENAME_,SS_THICKNESSANDMASK_TEXTURE,_VARYINGNAME_,Thickness)
#include<samplerVertexDeclaration>(_DEFINENAME_,SS_REFRACTIONINTENSITY_TEXTURE,_VARYINGNAME_,RefractionIntensity)
#include<samplerVertexDeclaration>(_DEFINENAME_,SS_TRANSLUCENCYINTENSITY_TEXTURE,_VARYINGNAME_,TranslucencyIntensity)
#endif
varying vec3 vPositionW;
#if DEBUGMODE>0
varying vec4 vClipSpacePosition;
#endif
#ifdef NORMAL
varying vec3 vNormalW;
#if defined(USESPHERICALFROMREFLECTIONMAP) && defined(USESPHERICALINVERTEX)
varying vec3 vEnvironmentIrradiance;
#include<harmonicsFunctions>
#endif
#endif
#if defined(VERTEXCOLOR) || defined(INSTANCESCOLOR)
varying vec4 vColor;
#endif
#include<bumpVertexDeclaration>
#include<clipPlaneVertexDeclaration>
#include<fogVertexDeclaration>
#include<__decl__lightVxFragment>[0..maxSimultaneousLights]
#include<morphTargetsVertexGlobalDeclaration>
#include<morphTargetsVertexDeclaration>[0..maxSimultaneousMorphTargets]
#ifdef REFLECTIONMAP_SKYBOX
varying vec3 vPositionUVW;
#endif
#if defined(REFLECTIONMAP_EQUIRECTANGULAR_FIXED) || defined(REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED)
varying vec3 vDirectionW;
#endif
#include<logDepthDeclaration>
#define CUSTOM_VERTEX_DEFINITIONS
void main(void) {
#define CUSTOM_VERTEX_MAIN_BEGIN
vec3 positionUpdated=position;
#ifdef NORMAL
vec3 normalUpdated=normal;
#endif
#ifdef TANGENT
vec4 tangentUpdated=tangent;
#endif
#ifdef UV1
vec2 uvUpdated=uv;
#endif
#include<morphTargetsVertexGlobal>
#include<morphTargetsVertex>[0..maxSimultaneousMorphTargets]
#ifdef REFLECTIONMAP_SKYBOX
vPositionUVW=positionUpdated;
#endif
#define CUSTOM_VERTEX_UPDATE_POSITION
#define CUSTOM_VERTEX_UPDATE_NORMAL
#include<instancesVertex>
#if defined(PREPASS) && defined(PREPASS_VELOCITY) && !defined(BONES_VELOCITY_ENABLED)
vCurrentPosition=viewProjection*finalWorld*vec4(positionUpdated,1.0);
vPreviousPosition=previousViewProjection*finalPreviousWorld*vec4(positionUpdated,1.0);
#endif
#include<bonesVertex>
#include<bakedVertexAnimation>
vec4 worldPos=finalWorld*vec4(positionUpdated,1.0);
vPositionW=vec3(worldPos);
#include<prePassVertex>
#ifdef NORMAL
mat3 normalWorld=mat3(finalWorld);
#if defined(INSTANCES) && defined(THIN_INSTANCES)
vNormalW=normalUpdated/vec3(dot(normalWorld[0],normalWorld[0]),dot(normalWorld[1],normalWorld[1]),dot(normalWorld[2],normalWorld[2]));
vNormalW=normalize(normalWorld*vNormalW);
#else
#ifdef NONUNIFORMSCALING
normalWorld=transposeMat3(inverseMat3(normalWorld));
#endif
vNormalW=normalize(normalWorld*normalUpdated);
#endif
#if defined(USESPHERICALFROMREFLECTIONMAP) && defined(USESPHERICALINVERTEX)
vec3 reflectionVector=vec3(reflectionMatrix*vec4(vNormalW,0)).xyz;
#ifdef REFLECTIONMAP_OPPOSITEZ
reflectionVector.z*=-1.0;
#endif
vEnvironmentIrradiance=computeEnvironmentIrradiance(reflectionVector);
#endif
#endif
#define CUSTOM_VERTEX_UPDATE_WORLDPOS
#ifdef MULTIVIEW
if (gl_ViewID_OVR==0u) {
gl_Position=viewProjection*worldPos;
} else {
gl_Position=viewProjectionR*worldPos;
}
#else
gl_Position=viewProjection*worldPos;
#endif
#if DEBUGMODE>0
vClipSpacePosition=gl_Position;
#endif
#if defined(REFLECTIONMAP_EQUIRECTANGULAR_FIXED) || defined(REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED)
vDirectionW=normalize(vec3(finalWorld*vec4(positionUpdated,0.0)));
#endif
#ifndef UV1
vec2 uvUpdated=vec2(0.,0.);
#endif
#ifdef MAINUV1
vMainUV1=uvUpdated;
#endif
#include<uvVariableDeclaration>[2..7]
#include<samplerVertexImplementation>(_DEFINENAME_,ALBEDO,_VARYINGNAME_,Albedo,_MATRIXNAME_,albedo,_INFONAME_,AlbedoInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,DETAIL,_VARYINGNAME_,Detail,_MATRIXNAME_,detail,_INFONAME_,DetailInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,AMBIENT,_VARYINGNAME_,Ambient,_MATRIXNAME_,ambient,_INFONAME_,AmbientInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,OPACITY,_VARYINGNAME_,Opacity,_MATRIXNAME_,opacity,_INFONAME_,OpacityInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,EMISSIVE,_VARYINGNAME_,Emissive,_MATRIXNAME_,emissive,_INFONAME_,EmissiveInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,LIGHTMAP,_VARYINGNAME_,Lightmap,_MATRIXNAME_,lightmap,_INFONAME_,LightmapInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,REFLECTIVITY,_VARYINGNAME_,Reflectivity,_MATRIXNAME_,reflectivity,_INFONAME_,ReflectivityInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,MICROSURFACEMAP,_VARYINGNAME_,MicroSurfaceSampler,_MATRIXNAME_,microSurfaceSampler,_INFONAME_,MicroSurfaceSamplerInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,METALLIC_REFLECTANCE,_VARYINGNAME_,MetallicReflectance,_MATRIXNAME_,metallicReflectance,_INFONAME_,MetallicReflectanceInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,REFLECTANCE,_VARYINGNAME_,Reflectance,_MATRIXNAME_,reflectance,_INFONAME_,ReflectanceInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,BUMP,_VARYINGNAME_,Bump,_MATRIXNAME_,bump,_INFONAME_,BumpInfos.x)
#ifdef CLEARCOAT
#include<samplerVertexImplementation>(_DEFINENAME_,CLEARCOAT_TEXTURE,_VARYINGNAME_,ClearCoat,_MATRIXNAME_,clearCoat,_INFONAME_,ClearCoatInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,CLEARCOAT_TEXTURE_ROUGHNESS,_VARYINGNAME_,ClearCoatRoughness,_MATRIXNAME_,clearCoatRoughness,_INFONAME_,ClearCoatInfos.z)
#include<samplerVertexImplementation>(_DEFINENAME_,CLEARCOAT_BUMP,_VARYINGNAME_,ClearCoatBump,_MATRIXNAME_,clearCoatBump,_INFONAME_,ClearCoatBumpInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,CLEARCOAT_TINT_TEXTURE,_VARYINGNAME_,ClearCoatTint,_MATRIXNAME_,clearCoatTint,_INFONAME_,ClearCoatTintInfos.x)
#endif
#ifdef SHEEN
#include<samplerVertexImplementation>(_DEFINENAME_,SHEEN_TEXTURE,_VARYINGNAME_,Sheen,_MATRIXNAME_,sheen,_INFONAME_,SheenInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,SHEEN_TEXTURE_ROUGHNESS,_VARYINGNAME_,SheenRoughness,_MATRIXNAME_,sheen,_INFONAME_,SheenInfos.z)
#endif
#ifdef ANISOTROPIC
#include<samplerVertexImplementation>(_DEFINENAME_,ANISOTROPIC_TEXTURE,_VARYINGNAME_,Anisotropy,_MATRIXNAME_,anisotropy,_INFONAME_,AnisotropyInfos.x)
#endif
#ifdef SUBSURFACE
#include<samplerVertexImplementation>(_DEFINENAME_,SS_THICKNESSANDMASK_TEXTURE,_VARYINGNAME_,Thickness,_MATRIXNAME_,thickness,_INFONAME_,ThicknessInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,SS_REFRACTIONINTENSITY_TEXTURE,_VARYINGNAME_,RefractionIntensity,_MATRIXNAME_,refractionIntensity,_INFONAME_,RefractionIntensityInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,SS_TRANSLUCENCYINTENSITY_TEXTURE,_VARYINGNAME_,TranslucencyIntensity,_MATRIXNAME_,translucencyIntensity,_INFONAME_,TranslucencyIntensityInfos.x)
#endif
#include<bumpVertex>
#include<clipPlaneVertex>
#include<fogVertex>
#include<shadowsVertex>[0..maxSimultaneousLights]
#ifdef VERTEXCOLOR
vColor=color;
#elif INSTANCESCOLOR
vColor=instanceColor;
#endif
#if defined(POINTSIZE) && !defined(WEBGPU)
gl_PointSize=pointSize;
#endif
#include<logDepthVertex>
#define CUSTOM_VERTEX_MAIN_END
}`;oe.ShadersStore[ec]=tc;var nc=function(r){R(n,r);function n(){var e=r!==null&&r.apply(this,arguments)||this;return e.CLEARCOAT=!1,e.CLEARCOAT_DEFAULTIOR=!1,e.CLEARCOAT_TEXTURE=!1,e.CLEARCOAT_TEXTURE_ROUGHNESS=!1,e.CLEARCOAT_TEXTUREDIRECTUV=0,e.CLEARCOAT_TEXTURE_ROUGHNESSDIRECTUV=0,e.CLEARCOAT_BUMP=!1,e.CLEARCOAT_BUMPDIRECTUV=0,e.CLEARCOAT_USE_ROUGHNESS_FROM_MAINTEXTURE=!1,e.CLEARCOAT_TEXTURE_ROUGHNESS_IDENTICAL=!1,e.CLEARCOAT_REMAP_F0=!1,e.CLEARCOAT_TINT=!1,e.CLEARCOAT_TINT_TEXTURE=!1,e.CLEARCOAT_TINT_TEXTUREDIRECTUV=0,e.CLEARCOAT_TINT_GAMMATEXTURE=!1,e}return n}(mt),Gn=function(r){R(n,r);function n(e,t){t===void 0&&(t=!0);var i=r.call(this,e,"PBRClearCoat",100,new nc,t)||this;return i._isEnabled=!1,i.isEnabled=!1,i.intensity=1,i.roughness=0,i._indexOfRefraction=n._DefaultIndexOfRefraction,i.indexOfRefraction=n._DefaultIndexOfRefraction,i._texture=null,i.texture=null,i._useRoughnessFromMainTexture=!0,i.useRoughnessFromMainTexture=!0,i._textureRoughness=null,i.textureRoughness=null,i._remapF0OnInterfaceChange=!0,i.remapF0OnInterfaceChange=!0,i._bumpTexture=null,i.bumpTexture=null,i._isTintEnabled=!1,i.isTintEnabled=!1,i.tintColor=G.White(),i.tintColorAtDistance=1,i.tintThickness=1,i._tintTexture=null,i.tintTexture=null,i._internalMarkAllSubMeshesAsTexturesDirty=e._dirtyCallbacks[1],i}return n.prototype._markAllSubMeshesAsTexturesDirty=function(){this._enable(this._isEnabled),this._internalMarkAllSubMeshesAsTexturesDirty()},n.prototype.isReadyForSubMesh=function(e,t,i){if(!this._isEnabled)return!0;var o=this._material._disableBumpMap;return!(e._areTexturesDirty&&t.texturesEnabled&&(this._texture&&M.ClearCoatTextureEnabled&&!this._texture.isReadyOrNotBlocking()||this._textureRoughness&&M.ClearCoatTextureEnabled&&!this._textureRoughness.isReadyOrNotBlocking()||i.getCaps().standardDerivatives&&this._bumpTexture&&M.ClearCoatBumpTextureEnabled&&!o&&!this._bumpTexture.isReady()||this._isTintEnabled&&this._tintTexture&&M.ClearCoatTintTextureEnabled&&!this._tintTexture.isReadyOrNotBlocking()))},n.prototype.prepareDefines=function(e,t){var i;this._isEnabled?(e.CLEARCOAT=!0,e.CLEARCOAT_USE_ROUGHNESS_FROM_MAINTEXTURE=this._useRoughnessFromMainTexture,e.CLEARCOAT_TEXTURE_ROUGHNESS_IDENTICAL=this._texture!==null&&this._texture._texture===((i=this._textureRoughness)===null||i===void 0?void 0:i._texture)&&this._texture.checkTransformsAreIdentical(this._textureRoughness),e.CLEARCOAT_REMAP_F0=this._remapF0OnInterfaceChange,e._areTexturesDirty&&t.texturesEnabled&&(this._texture&&M.ClearCoatTextureEnabled?F.PrepareDefinesForMergedUV(this._texture,e,"CLEARCOAT_TEXTURE"):e.CLEARCOAT_TEXTURE=!1,this._textureRoughness&&M.ClearCoatTextureEnabled?F.PrepareDefinesForMergedUV(this._textureRoughness,e,"CLEARCOAT_TEXTURE_ROUGHNESS"):e.CLEARCOAT_TEXTURE_ROUGHNESS=!1,this._bumpTexture&&M.ClearCoatBumpTextureEnabled?F.PrepareDefinesForMergedUV(this._bumpTexture,e,"CLEARCOAT_BUMP"):e.CLEARCOAT_BUMP=!1,e.CLEARCOAT_DEFAULTIOR=this._indexOfRefraction===n._DefaultIndexOfRefraction,this._isTintEnabled?(e.CLEARCOAT_TINT=!0,this._tintTexture&&M.ClearCoatTintTextureEnabled?(F.PrepareDefinesForMergedUV(this._tintTexture,e,"CLEARCOAT_TINT_TEXTURE"),e.CLEARCOAT_TINT_GAMMATEXTURE=this._tintTexture.gammaSpace):e.CLEARCOAT_TINT_TEXTURE=!1):(e.CLEARCOAT_TINT=!1,e.CLEARCOAT_TINT_TEXTURE=!1))):(e.CLEARCOAT=!1,e.CLEARCOAT_TEXTURE=!1,e.CLEARCOAT_TEXTURE_ROUGHNESS=!1,e.CLEARCOAT_BUMP=!1,e.CLEARCOAT_TINT=!1,e.CLEARCOAT_TINT_TEXTURE=!1,e.CLEARCOAT_USE_ROUGHNESS_FROM_MAINTEXTURE=!1,e.CLEARCOAT_TEXTURE_ROUGHNESS_IDENTICAL=!1)},n.prototype.bindForSubMesh=function(e,t,i,o){var a,s,c,l,u,f,d,p;if(!!this._isEnabled){var m=o.materialDefines,_=this._material.isFrozen,v=this._material._disableBumpMap,b=this._material._invertNormalMapX,A=this._material._invertNormalMapY,S=m.CLEARCOAT_TEXTURE_ROUGHNESS_IDENTICAL;if(!e.useUbo||!_||!e.isSync){S&&M.ClearCoatTextureEnabled?(e.updateFloat4("vClearCoatInfos",this._texture.coordinatesIndex,this._texture.level,-1,-1),F.BindTextureMatrix(this._texture,e,"clearCoat")):(this._texture||this._textureRoughness)&&M.ClearCoatTextureEnabled&&(e.updateFloat4("vClearCoatInfos",(s=(a=this._texture)===null||a===void 0?void 0:a.coordinatesIndex)!==null&&s!==void 0?s:0,(l=(c=this._texture)===null||c===void 0?void 0:c.level)!==null&&l!==void 0?l:0,(f=(u=this._textureRoughness)===null||u===void 0?void 0:u.coordinatesIndex)!==null&&f!==void 0?f:0,(p=(d=this._textureRoughness)===null||d===void 0?void 0:d.level)!==null&&p!==void 0?p:0),this._texture&&F.BindTextureMatrix(this._texture,e,"clearCoat"),this._textureRoughness&&!S&&!m.CLEARCOAT_USE_ROUGHNESS_FROM_MAINTEXTURE&&F.BindTextureMatrix(this._textureRoughness,e,"clearCoatRoughness")),this._bumpTexture&&i.getCaps().standardDerivatives&&M.ClearCoatTextureEnabled&&!v&&(e.updateFloat2("vClearCoatBumpInfos",this._bumpTexture.coordinatesIndex,this._bumpTexture.level),F.BindTextureMatrix(this._bumpTexture,e,"clearCoatBump"),t._mirroredCameraPosition?e.updateFloat2("vClearCoatTangentSpaceParams",b?1:-1,A?1:-1):e.updateFloat2("vClearCoatTangentSpaceParams",b?-1:1,A?-1:1)),this._tintTexture&&M.ClearCoatTintTextureEnabled&&(e.updateFloat2("vClearCoatTintInfos",this._tintTexture.coordinatesIndex,this._tintTexture.level),F.BindTextureMatrix(this._tintTexture,e,"clearCoatTint")),e.updateFloat2("vClearCoatParams",this.intensity,this.roughness);var C=1-this._indexOfRefraction,O=1+this._indexOfRefraction,B=Math.pow(-C/O,2),k=1/this._indexOfRefraction;e.updateFloat4("vClearCoatRefractionParams",B,k,C,O),this._isTintEnabled&&(e.updateFloat4("vClearCoatTintParams",this.tintColor.r,this.tintColor.g,this.tintColor.b,Math.max(1e-5,this.tintThickness)),e.updateFloat("clearCoatColorAtDistance",Math.max(1e-5,this.tintColorAtDistance)))}t.texturesEnabled&&(this._texture&&M.ClearCoatTextureEnabled&&e.setTexture("clearCoatSampler",this._texture),this._textureRoughness&&!S&&!m.CLEARCOAT_USE_ROUGHNESS_FROM_MAINTEXTURE&&M.ClearCoatTextureEnabled&&e.setTexture("clearCoatRoughnessSampler",this._textureRoughness),this._bumpTexture&&i.getCaps().standardDerivatives&&M.ClearCoatBumpTextureEnabled&&!v&&e.setTexture("clearCoatBumpSampler",this._bumpTexture),this._isTintEnabled&&this._tintTexture&&M.ClearCoatTintTextureEnabled&&e.setTexture("clearCoatTintSampler",this._tintTexture))}},n.prototype.hasTexture=function(e){return this._texture===e||this._textureRoughness===e||this._bumpTexture===e||this._tintTexture===e},n.prototype.getActiveTextures=function(e){this._texture&&e.push(this._texture),this._textureRoughness&&e.push(this._textureRoughness),this._bumpTexture&&e.push(this._bumpTexture),this._tintTexture&&e.push(this._tintTexture)},n.prototype.getAnimatables=function(e){this._texture&&this._texture.animations&&this._texture.animations.length>0&&e.push(this._texture),this._textureRoughness&&this._textureRoughness.animations&&this._textureRoughness.animations.length>0&&e.push(this._textureRoughness),this._bumpTexture&&this._bumpTexture.animations&&this._bumpTexture.animations.length>0&&e.push(this._bumpTexture),this._tintTexture&&this._tintTexture.animations&&this._tintTexture.animations.length>0&&e.push(this._tintTexture)},n.prototype.dispose=function(e){var t,i,o,a;e&&((t=this._texture)===null||t===void 0||t.dispose(),(i=this._textureRoughness)===null||i===void 0||i.dispose(),(o=this._bumpTexture)===null||o===void 0||o.dispose(),(a=this._tintTexture)===null||a===void 0||a.dispose())},n.prototype.getClassName=function(){return"PBRClearCoatConfiguration"},n.prototype.addFallbacks=function(e,t,i){return e.CLEARCOAT_BUMP&&t.addFallback(i++,"CLEARCOAT_BUMP"),e.CLEARCOAT_TINT&&t.addFallback(i++,"CLEARCOAT_TINT"),e.CLEARCOAT&&t.addFallback(i++,"CLEARCOAT"),i},n.prototype.getSamplers=function(e){e.push("clearCoatSampler","clearCoatRoughnessSampler","clearCoatBumpSampler","clearCoatTintSampler")},n.prototype.getUniforms=function(){return{ubo:[{name:"vClearCoatParams",size:2,type:"vec2"},{name:"vClearCoatRefractionParams",size:4,type:"vec4"},{name:"vClearCoatInfos",size:4,type:"vec4"},{name:"clearCoatMatrix",size:16,type:"mat4"},{name:"clearCoatRoughnessMatrix",size:16,type:"mat4"},{name:"vClearCoatBumpInfos",size:2,type:"vec2"},{name:"vClearCoatTangentSpaceParams",size:2,type:"vec2"},{name:"clearCoatBumpMatrix",size:16,type:"mat4"},{name:"vClearCoatTintParams",size:4,type:"vec4"},{name:"clearCoatColorAtDistance",size:1,type:"float"},{name:"vClearCoatTintInfos",size:2,type:"vec2"},{name:"clearCoatTintMatrix",size:16,type:"mat4"}]}},n._DefaultIndexOfRefraction=1.5,E([T(),N("_markAllSubMeshesAsTexturesDirty")],n.prototype,"isEnabled",void 0),E([T()],n.prototype,"intensity",void 0),E([T()],n.prototype,"roughness",void 0),E([T(),N("_markAllSubMeshesAsTexturesDirty")],n.prototype,"indexOfRefraction",void 0),E([de(),N("_markAllSubMeshesAsTexturesDirty")],n.prototype,"texture",void 0),E([T(),N("_markAllSubMeshesAsTexturesDirty")],n.prototype,"useRoughnessFromMainTexture",void 0),E([de(),N("_markAllSubMeshesAsTexturesDirty")],n.prototype,"textureRoughness",void 0),E([T(),N("_markAllSubMeshesAsTexturesDirty")],n.prototype,"remapF0OnInterfaceChange",void 0),E([de(),N("_markAllSubMeshesAsTexturesDirty")],n.prototype,"bumpTexture",void 0),E([T(),N("_markAllSubMeshesAsTexturesDirty")],n.prototype,"isTintEnabled",void 0),E([Ye()],n.prototype,"tintColor",void 0),E([T()],n.prototype,"tintColorAtDistance",void 0),E([T()],n.prototype,"tintThickness",void 0),E([de(),N("_markAllSubMeshesAsTexturesDirty")],n.prototype,"tintTexture",void 0),n}(Yt),ic=function(r){R(n,r);function n(){var e=r!==null&&r.apply(this,arguments)||this;return e.ANISOTROPIC=!1,e.ANISOTROPIC_TEXTURE=!1,e.ANISOTROPIC_TEXTUREDIRECTUV=0,e.MAINUV1=!1,e}return n}(mt),rc=function(r){R(n,r);function n(e,t){t===void 0&&(t=!0);var i=r.call(this,e,"PBRAnisotropic",110,new ic,t)||this;return i._isEnabled=!1,i.isEnabled=!1,i.intensity=1,i.direction=new Ge(1,0),i._texture=null,i.texture=null,i._internalMarkAllSubMeshesAsTexturesDirty=e._dirtyCallbacks[1],i}return n.prototype._markAllSubMeshesAsTexturesDirty=function(){this._enable(this._isEnabled),this._internalMarkAllSubMeshesAsTexturesDirty()},n.prototype.isReadyForSubMesh=function(e,t){return this._isEnabled?!(e._areTexturesDirty&&t.texturesEnabled&&this._texture&&M.AnisotropicTextureEnabled&&!this._texture.isReadyOrNotBlocking()):!0},n.prototype.prepareDefines=function(e,t,i){this._isEnabled?(e.ANISOTROPIC=this._isEnabled,this._isEnabled&&!i.isVerticesDataPresent(w.TangentKind)&&(e._needUVs=!0,e.MAINUV1=!0),e._areTexturesDirty&&t.texturesEnabled&&(this._texture&&M.AnisotropicTextureEnabled?F.PrepareDefinesForMergedUV(this._texture,e,"ANISOTROPIC_TEXTURE"):e.ANISOTROPIC_TEXTURE=!1)):(e.ANISOTROPIC=!1,e.ANISOTROPIC_TEXTURE=!1)},n.prototype.bindForSubMesh=function(e,t){if(!!this._isEnabled){var i=this._material.isFrozen;(!e.useUbo||!i||!e.isSync)&&(this._texture&&M.AnisotropicTextureEnabled&&(e.updateFloat2("vAnisotropyInfos",this._texture.coordinatesIndex,this._texture.level),F.BindTextureMatrix(this._texture,e,"anisotropy")),e.updateFloat3("vAnisotropy",this.direction.x,this.direction.y,this.intensity)),t.texturesEnabled&&this._texture&&M.AnisotropicTextureEnabled&&e.setTexture("anisotropySampler",this._texture)}},n.prototype.hasTexture=function(e){return this._texture===e},n.prototype.getActiveTextures=function(e){this._texture&&e.push(this._texture)},n.prototype.getAnimatables=function(e){this._texture&&this._texture.animations&&this._texture.animations.length>0&&e.push(this._texture)},n.prototype.dispose=function(e){e&&this._texture&&this._texture.dispose()},n.prototype.getClassName=function(){return"PBRAnisotropicConfiguration"},n.prototype.addFallbacks=function(e,t,i){return e.ANISOTROPIC&&t.addFallback(i++,"ANISOTROPIC"),i},n.prototype.getSamplers=function(e){e.push("anisotropySampler")},n.prototype.getUniforms=function(){return{ubo:[{name:"vAnisotropy",size:3,type:"vec3"},{name:"vAnisotropyInfos",size:2,type:"vec2"},{name:"anisotropyMatrix",size:16,type:"mat4"}]}},E([T(),N("_markAllSubMeshesAsTexturesDirty")],n.prototype,"isEnabled",void 0),E([T()],n.prototype,"intensity",void 0),E([po()],n.prototype,"direction",void 0),E([de(),N("_markAllSubMeshesAsTexturesDirty")],n.prototype,"texture",void 0),n}(Yt),oc=function(r){R(n,r);function n(){var e=r!==null&&r.apply(this,arguments)||this;return e.SHEEN=!1,e.SHEEN_TEXTURE=!1,e.SHEEN_GAMMATEXTURE=!1,e.SHEEN_TEXTURE_ROUGHNESS=!1,e.SHEEN_TEXTUREDIRECTUV=0,e.SHEEN_TEXTURE_ROUGHNESSDIRECTUV=0,e.SHEEN_LINKWITHALBEDO=!1,e.SHEEN_ROUGHNESS=!1,e.SHEEN_ALBEDOSCALING=!1,e.SHEEN_USE_ROUGHNESS_FROM_MAINTEXTURE=!1,e.SHEEN_TEXTURE_ROUGHNESS_IDENTICAL=!1,e}return n}(mt),ac=function(r){R(n,r);function n(e,t){t===void 0&&(t=!0);var i=r.call(this,e,"Sheen",120,new oc,t)||this;return i._isEnabled=!1,i.isEnabled=!1,i._linkSheenWithAlbedo=!1,i.linkSheenWithAlbedo=!1,i.intensity=1,i.color=G.White(),i._texture=null,i.texture=null,i._useRoughnessFromMainTexture=!0,i.useRoughnessFromMainTexture=!0,i._roughness=null,i.roughness=null,i._textureRoughness=null,i.textureRoughness=null,i._albedoScaling=!1,i.albedoScaling=!1,i._internalMarkAllSubMeshesAsTexturesDirty=e._dirtyCallbacks[1],i}return n.prototype._markAllSubMeshesAsTexturesDirty=function(){this._enable(this._isEnabled),this._internalMarkAllSubMeshesAsTexturesDirty()},n.prototype.isReadyForSubMesh=function(e,t){return this._isEnabled?!(e._areTexturesDirty&&t.texturesEnabled&&(this._texture&&M.SheenTextureEnabled&&!this._texture.isReadyOrNotBlocking()||this._textureRoughness&&M.SheenTextureEnabled&&!this._textureRoughness.isReadyOrNotBlocking())):!0},n.prototype.prepareDefines=function(e,t){var i;this._isEnabled?(e.SHEEN=!0,e.SHEEN_LINKWITHALBEDO=this._linkSheenWithAlbedo,e.SHEEN_ROUGHNESS=this._roughness!==null,e.SHEEN_ALBEDOSCALING=this._albedoScaling,e.SHEEN_USE_ROUGHNESS_FROM_MAINTEXTURE=this._useRoughnessFromMainTexture,e.SHEEN_TEXTURE_ROUGHNESS_IDENTICAL=this._texture!==null&&this._texture._texture===((i=this._textureRoughness)===null||i===void 0?void 0:i._texture)&&this._texture.checkTransformsAreIdentical(this._textureRoughness),e._areTexturesDirty&&t.texturesEnabled&&(this._texture&&M.SheenTextureEnabled?(F.PrepareDefinesForMergedUV(this._texture,e,"SHEEN_TEXTURE"),e.SHEEN_GAMMATEXTURE=this._texture.gammaSpace):e.SHEEN_TEXTURE=!1,this._textureRoughness&&M.SheenTextureEnabled?F.PrepareDefinesForMergedUV(this._textureRoughness,e,"SHEEN_TEXTURE_ROUGHNESS"):e.SHEEN_TEXTURE_ROUGHNESS=!1)):(e.SHEEN=!1,e.SHEEN_TEXTURE=!1,e.SHEEN_TEXTURE_ROUGHNESS=!1,e.SHEEN_LINKWITHALBEDO=!1,e.SHEEN_ROUGHNESS=!1,e.SHEEN_ALBEDOSCALING=!1,e.SHEEN_USE_ROUGHNESS_FROM_MAINTEXTURE=!1,e.SHEEN_TEXTURE_ROUGHNESS_IDENTICAL=!1)},n.prototype.bindForSubMesh=function(e,t,i,o){var a,s,c,l,u,f,d,p;if(!!this._isEnabled){var m=o.materialDefines,_=this._material.isFrozen,v=m.SHEEN_TEXTURE_ROUGHNESS_IDENTICAL;(!e.useUbo||!_||!e.isSync)&&(v&&M.SheenTextureEnabled?(e.updateFloat4("vSheenInfos",this._texture.coordinatesIndex,this._texture.level,-1,-1),F.BindTextureMatrix(this._texture,e,"sheen")):(this._texture||this._textureRoughness)&&M.SheenTextureEnabled&&(e.updateFloat4("vSheenInfos",(s=(a=this._texture)===null||a===void 0?void 0:a.coordinatesIndex)!==null&&s!==void 0?s:0,(l=(c=this._texture)===null||c===void 0?void 0:c.level)!==null&&l!==void 0?l:0,(f=(u=this._textureRoughness)===null||u===void 0?void 0:u.coordinatesIndex)!==null&&f!==void 0?f:0,(p=(d=this._textureRoughness)===null||d===void 0?void 0:d.level)!==null&&p!==void 0?p:0),this._texture&&F.BindTextureMatrix(this._texture,e,"sheen"),this._textureRoughness&&!v&&!m.SHEEN_USE_ROUGHNESS_FROM_MAINTEXTURE&&F.BindTextureMatrix(this._textureRoughness,e,"sheenRoughness")),e.updateFloat4("vSheenColor",this.color.r,this.color.g,this.color.b,this.intensity),this._roughness!==null&&e.updateFloat("vSheenRoughness",this._roughness)),t.texturesEnabled&&(this._texture&&M.SheenTextureEnabled&&e.setTexture("sheenSampler",this._texture),this._textureRoughness&&!v&&!m.SHEEN_USE_ROUGHNESS_FROM_MAINTEXTURE&&M.SheenTextureEnabled&&e.setTexture("sheenRoughnessSampler",this._textureRoughness))}},n.prototype.hasTexture=function(e){return this._texture===e||this._textureRoughness===e},n.prototype.getActiveTextures=function(e){this._texture&&e.push(this._texture),this._textureRoughness&&e.push(this._textureRoughness)},n.prototype.getAnimatables=function(e){this._texture&&this._texture.animations&&this._texture.animations.length>0&&e.push(this._texture),this._textureRoughness&&this._textureRoughness.animations&&this._textureRoughness.animations.length>0&&e.push(this._textureRoughness)},n.prototype.dispose=function(e){var t,i;e&&((t=this._texture)===null||t===void 0||t.dispose(),(i=this._textureRoughness)===null||i===void 0||i.dispose())},n.prototype.getClassName=function(){return"PBRSheenConfiguration"},n.prototype.addFallbacks=function(e,t,i){return e.SHEEN&&t.addFallback(i++,"SHEEN"),i},n.prototype.getSamplers=function(e){e.push("sheenSampler","sheenRoughnessSampler")},n.prototype.getUniforms=function(){return{ubo:[{name:"vSheenColor",size:4,type:"vec4"},{name:"vSheenRoughness",size:1,type:"float"},{name:"vSheenInfos",size:4,type:"vec4"},{name:"sheenMatrix",size:16,type:"mat4"},{name:"sheenRoughnessMatrix",size:16,type:"mat4"}]}},E([T(),N("_markAllSubMeshesAsTexturesDirty")],n.prototype,"isEnabled",void 0),E([T(),N("_markAllSubMeshesAsTexturesDirty")],n.prototype,"linkSheenWithAlbedo",void 0),E([T()],n.prototype,"intensity",void 0),E([Ye()],n.prototype,"color",void 0),E([de(),N("_markAllSubMeshesAsTexturesDirty")],n.prototype,"texture",void 0),E([T(),N("_markAllSubMeshesAsTexturesDirty")],n.prototype,"useRoughnessFromMainTexture",void 0),E([T(),N("_markAllSubMeshesAsTexturesDirty")],n.prototype,"roughness",void 0),E([de(),N("_markAllSubMeshesAsTexturesDirty")],n.prototype,"textureRoughness",void 0),E([T(),N("_markAllSubMeshesAsTexturesDirty")],n.prototype,"albedoScaling",void 0),n}(Yt),sc=function(r){R(n,r);function n(){var e=r!==null&&r.apply(this,arguments)||this;return e.SUBSURFACE=!1,e.SS_REFRACTION=!1,e.SS_REFRACTION_USE_INTENSITY_FROM_TEXTURE=!1,e.SS_TRANSLUCENCY=!1,e.SS_TRANSLUCENCY_USE_INTENSITY_FROM_TEXTURE=!1,e.SS_SCATTERING=!1,e.SS_THICKNESSANDMASK_TEXTURE=!1,e.SS_THICKNESSANDMASK_TEXTUREDIRECTUV=0,e.SS_HAS_THICKNESS=!1,e.SS_REFRACTIONINTENSITY_TEXTURE=!1,e.SS_REFRACTIONINTENSITY_TEXTUREDIRECTUV=0,e.SS_TRANSLUCENCYINTENSITY_TEXTURE=!1,e.SS_TRANSLUCENCYINTENSITY_TEXTUREDIRECTUV=0,e.SS_REFRACTIONMAP_3D=!1,e.SS_REFRACTIONMAP_OPPOSITEZ=!1,e.SS_LODINREFRACTIONALPHA=!1,e.SS_GAMMAREFRACTION=!1,e.SS_RGBDREFRACTION=!1,e.SS_LINEARSPECULARREFRACTION=!1,e.SS_LINKREFRACTIONTOTRANSPARENCY=!1,e.SS_ALBEDOFORREFRACTIONTINT=!1,e.SS_ALBEDOFORTRANSLUCENCYTINT=!1,e.SS_USE_LOCAL_REFRACTIONMAP_CUBIC=!1,e.SS_USE_THICKNESS_AS_DEPTH=!1,e.SS_MASK_FROM_THICKNESS_TEXTURE=!1,e.SS_USE_GLTF_TEXTURES=!1,e}return n}(mt),cc=function(r){R(n,r);function n(e,t){t===void 0&&(t=!0);var i=r.call(this,e,"PBRSubSurface",130,new sc,t)||this;return i._isRefractionEnabled=!1,i.isRefractionEnabled=!1,i._isTranslucencyEnabled=!1,i.isTranslucencyEnabled=!1,i._isScatteringEnabled=!1,i.isScatteringEnabled=!1,i._scatteringDiffusionProfileIndex=0,i.refractionIntensity=1,i.translucencyIntensity=1,i.useAlbedoToTintRefraction=!1,i.useAlbedoToTintTranslucency=!1,i._thicknessTexture=null,i.thicknessTexture=null,i._refractionTexture=null,i.refractionTexture=null,i._indexOfRefraction=1.5,i.indexOfRefraction=1.5,i._volumeIndexOfRefraction=-1,i._invertRefractionY=!1,i.invertRefractionY=!1,i._linkRefractionWithTransparency=!1,i.linkRefractionWithTransparency=!1,i.minimumThickness=0,i.maximumThickness=1,i.useThicknessAsDepth=!1,i.tintColor=G.White(),i.tintColorAtDistance=1,i.diffusionDistance=G.White(),i._useMaskFromThicknessTexture=!1,i.useMaskFromThicknessTexture=!1,i._refractionIntensityTexture=null,i.refractionIntensityTexture=null,i._translucencyIntensityTexture=null,i.translucencyIntensityTexture=null,i._useGltfStyleTextures=!1,i.useGltfStyleTextures=!1,i._scene=e.getScene(),i.registerForExtraEvents=!0,i._internalMarkAllSubMeshesAsTexturesDirty=e._dirtyCallbacks[1],i._internalMarkScenePrePassDirty=e._dirtyCallbacks[32],i}return Object.defineProperty(n.prototype,"scatteringDiffusionProfile",{get:function(){return this._scene.subSurfaceConfiguration?this._scene.subSurfaceConfiguration.ssDiffusionProfileColors[this._scatteringDiffusionProfileIndex]:null},set:function(e){!this._scene.enableSubSurfaceForPrePass()||e&&(this._scatteringDiffusionProfileIndex=this._scene.subSurfaceConfiguration.addDiffusionProfile(e))},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"volumeIndexOfRefraction",{get:function(){return this._volumeIndexOfRefraction>=1?this._volumeIndexOfRefraction:this._indexOfRefraction},set:function(e){e>=1?this._volumeIndexOfRefraction=e:this._volumeIndexOfRefraction=-1},enumerable:!1,configurable:!0}),n.prototype._markAllSubMeshesAsTexturesDirty=function(){this._enable(this._isRefractionEnabled||this._isTranslucencyEnabled||this._isScatteringEnabled),this._internalMarkAllSubMeshesAsTexturesDirty()},n.prototype._markScenePrePassDirty=function(){this._internalMarkAllSubMeshesAsTexturesDirty(),this._internalMarkScenePrePassDirty()},n.prototype.isReadyForSubMesh=function(e,t){if(!this._isRefractionEnabled&&!this._isTranslucencyEnabled&&!this._isScatteringEnabled)return!0;if(e._areTexturesDirty&&t.texturesEnabled){if(this._thicknessTexture&&M.ThicknessTextureEnabled&&!this._thicknessTexture.isReadyOrNotBlocking())return!1;var i=this._getRefractionTexture(t);if(i&&M.RefractionTextureEnabled&&!i.isReadyOrNotBlocking())return!1}return!0},n.prototype.prepareDefines=function(e,t){if(!this._isRefractionEnabled&&!this._isTranslucencyEnabled&&!this._isScatteringEnabled){e.SUBSURFACE=!1,e.SS_TRANSLUCENCY=!1,e.SS_SCATTERING=!1,e.SS_REFRACTION=!1;return}if(e._areTexturesDirty){e.SUBSURFACE=!0,e.SS_TRANSLUCENCY=this._isTranslucencyEnabled,e.SS_TRANSLUCENCY_USE_INTENSITY_FROM_TEXTURE=!1,e.SS_SCATTERING=this._isScatteringEnabled,e.SS_THICKNESSANDMASK_TEXTURE=!1,e.SS_REFRACTIONINTENSITY_TEXTURE=!1,e.SS_TRANSLUCENCYINTENSITY_TEXTURE=!1,e.SS_HAS_THICKNESS=!1,e.SS_MASK_FROM_THICKNESS_TEXTURE=!1,e.SS_USE_GLTF_TEXTURES=!1,e.SS_REFRACTION=!1,e.SS_REFRACTION_USE_INTENSITY_FROM_TEXTURE=!1,e.SS_REFRACTIONMAP_3D=!1,e.SS_GAMMAREFRACTION=!1,e.SS_RGBDREFRACTION=!1,e.SS_LINEARSPECULARREFRACTION=!1,e.SS_REFRACTIONMAP_OPPOSITEZ=!1,e.SS_LODINREFRACTIONALPHA=!1,e.SS_LINKREFRACTIONTOTRANSPARENCY=!1,e.SS_ALBEDOFORREFRACTIONTINT=!1,e.SS_ALBEDOFORTRANSLUCENCYTINT=!1,e.SS_USE_LOCAL_REFRACTIONMAP_CUBIC=!1,e.SS_USE_THICKNESS_AS_DEPTH=!1;var i=!!this._thicknessTexture&&!!this._refractionIntensityTexture&&this._refractionIntensityTexture.checkTransformsAreIdentical(this._thicknessTexture)&&this._refractionIntensityTexture._texture===this._thicknessTexture._texture,o=!!this._thicknessTexture&&!!this._translucencyIntensityTexture&&this._translucencyIntensityTexture.checkTransformsAreIdentical(this._thicknessTexture)&&this._translucencyIntensityTexture._texture===this._thicknessTexture._texture,a=(i||!this._refractionIntensityTexture)&&(o||!this._translucencyIntensityTexture);if(e._areTexturesDirty&&t.texturesEnabled&&(this._thicknessTexture&&M.ThicknessTextureEnabled&&F.PrepareDefinesForMergedUV(this._thicknessTexture,e,"SS_THICKNESSANDMASK_TEXTURE"),this._refractionIntensityTexture&&M.RefractionIntensityTextureEnabled&&!a&&F.PrepareDefinesForMergedUV(this._refractionIntensityTexture,e,"SS_REFRACTIONINTENSITY_TEXTURE"),this._translucencyIntensityTexture&&M.TranslucencyIntensityTextureEnabled&&!a&&F.PrepareDefinesForMergedUV(this._translucencyIntensityTexture,e,"SS_TRANSLUCENCYINTENSITY_TEXTURE")),e.SS_HAS_THICKNESS=this.maximumThickness-this.minimumThickness!==0,e.SS_MASK_FROM_THICKNESS_TEXTURE=(this._useMaskFromThicknessTexture||!!this._refractionIntensityTexture||!!this._translucencyIntensityTexture)&&a,e.SS_USE_GLTF_TEXTURES=this._useGltfStyleTextures,e.SS_REFRACTION_USE_INTENSITY_FROM_TEXTURE=(this._useMaskFromThicknessTexture||!!this._refractionIntensityTexture)&&a,e.SS_TRANSLUCENCY_USE_INTENSITY_FROM_TEXTURE=(this._useMaskFromThicknessTexture||!!this._translucencyIntensityTexture)&&a,this._isRefractionEnabled&&t.texturesEnabled){var s=this._getRefractionTexture(t);s&&M.RefractionTextureEnabled&&(e.SS_REFRACTION=!0,e.SS_REFRACTIONMAP_3D=s.isCube,e.SS_GAMMAREFRACTION=s.gammaSpace,e.SS_RGBDREFRACTION=s.isRGBD,e.SS_LINEARSPECULARREFRACTION=s.linearSpecularLOD,e.SS_REFRACTIONMAP_OPPOSITEZ=s.invertZ,e.SS_LODINREFRACTIONALPHA=s.lodLevelInAlpha,e.SS_LINKREFRACTIONTOTRANSPARENCY=this._linkRefractionWithTransparency,e.SS_ALBEDOFORREFRACTIONTINT=this.useAlbedoToTintRefraction,e.SS_USE_LOCAL_REFRACTIONMAP_CUBIC=s.isCube&&s.boundingBoxSize,e.SS_USE_THICKNESS_AS_DEPTH=this.useThicknessAsDepth)}this._isTranslucencyEnabled&&(e.SS_ALBEDOFORTRANSLUCENCYTINT=this.useAlbedoToTintTranslucency)}},n.prototype.hardBindForSubMesh=function(e,t,i,o){if(!(!this._isRefractionEnabled&&!this._isTranslucencyEnabled&&!this._isScatteringEnabled)){o.getRenderingMesh().getWorldMatrix().decompose(H.Vector3[0]);var a=Math.max(Math.abs(H.Vector3[0].x),Math.abs(H.Vector3[0].y),Math.abs(H.Vector3[0].z));e.updateFloat2("vThicknessParam",this.minimumThickness*a,(this.maximumThickness-this.minimumThickness)*a)}},n.prototype.bindForSubMesh=function(e,t,i,o){if(!(!this._isRefractionEnabled&&!this._isTranslucencyEnabled&&!this._isScatteringEnabled)){var a=o.materialDefines,s=this._material.isFrozen,c=this._material.realTimeFiltering,l=a.LODBASEDMICROSFURACE,u=this._getRefractionTexture(t);if(!e.useUbo||!s||!e.isSync){if(this._thicknessTexture&&M.ThicknessTextureEnabled&&(e.updateFloat2("vThicknessInfos",this._thicknessTexture.coordinatesIndex,this._thicknessTexture.level),F.BindTextureMatrix(this._thicknessTexture,e,"thickness")),this._refractionIntensityTexture&&M.RefractionIntensityTextureEnabled&&a.SS_REFRACTIONINTENSITY_TEXTURE&&(e.updateFloat2("vRefractionIntensityInfos",this._refractionIntensityTexture.coordinatesIndex,this._refractionIntensityTexture.level),F.BindTextureMatrix(this._refractionIntensityTexture,e,"refractionIntensity")),this._translucencyIntensityTexture&&M.TranslucencyIntensityTextureEnabled&&a.SS_TRANSLUCENCYINTENSITY_TEXTURE&&(e.updateFloat2("vTranslucencyIntensityInfos",this._translucencyIntensityTexture.coordinatesIndex,this._translucencyIntensityTexture.level),F.BindTextureMatrix(this._translucencyIntensityTexture,e,"translucencyIntensity")),u&&M.RefractionTextureEnabled){e.updateMatrix("refractionMatrix",u.getReflectionTextureMatrix());var f=1;u.isCube||u.depth&&(f=u.depth);var d=u.getSize().width,p=this.volumeIndexOfRefraction;if(e.updateFloat4("vRefractionInfos",u.level,1/p,f,this._invertRefractionY?-1:1),e.updateFloat4("vRefractionMicrosurfaceInfos",d,u.lodGenerationScale,u.lodGenerationOffset,1/this.indexOfRefraction),c&&e.updateFloat2("vRefractionFilteringInfo",d,Wt.Log2(d)),u.boundingBoxSize){var m=u;e.updateVector3("vRefractionPosition",m.boundingBoxPosition),e.updateVector3("vRefractionSize",m.boundingBoxSize)}}this._isScatteringEnabled&&e.updateFloat("scatteringDiffusionProfile",this._scatteringDiffusionProfileIndex),e.updateColor3("vDiffusionDistance",this.diffusionDistance),e.updateFloat4("vTintColor",this.tintColor.r,this.tintColor.g,this.tintColor.b,Math.max(1e-5,this.tintColorAtDistance)),e.updateFloat3("vSubSurfaceIntensity",this.refractionIntensity,this.translucencyIntensity,0)}t.texturesEnabled&&(this._thicknessTexture&&M.ThicknessTextureEnabled&&e.setTexture("thicknessSampler",this._thicknessTexture),this._refractionIntensityTexture&&M.RefractionIntensityTextureEnabled&&a.SS_REFRACTIONINTENSITY_TEXTURE&&e.setTexture("refractionIntensitySampler",this._refractionIntensityTexture),this._translucencyIntensityTexture&&M.TranslucencyIntensityTextureEnabled&&a.SS_TRANSLUCENCYINTENSITY_TEXTURE&&e.setTexture("translucencyIntensitySampler",this._translucencyIntensityTexture),u&&M.RefractionTextureEnabled&&(l?e.setTexture("refractionSampler",u):(e.setTexture("refractionSampler",u._lodTextureMid||u),e.setTexture("refractionSamplerLow",u._lodTextureLow||u),e.setTexture("refractionSamplerHigh",u._lodTextureHigh||u))))}},n.prototype._getRefractionTexture=function(e){return this._refractionTexture?this._refractionTexture:this._isRefractionEnabled?e.environmentTexture:null},Object.defineProperty(n.prototype,"disableAlphaBlending",{get:function(){return this._isRefractionEnabled&&this._linkRefractionWithTransparency},enumerable:!1,configurable:!0}),n.prototype.fillRenderTargetTextures=function(e){M.RefractionTextureEnabled&&this._refractionTexture&&this._refractionTexture.isRenderTarget&&e.push(this._refractionTexture)},n.prototype.hasTexture=function(e){return this._thicknessTexture===e||this._refractionTexture===e},n.prototype.hasRenderTargetTextures=function(){return!!(M.RefractionTextureEnabled&&this._refractionTexture&&this._refractionTexture.isRenderTarget)},n.prototype.getActiveTextures=function(e){this._thicknessTexture&&e.push(this._thicknessTexture),this._refractionTexture&&e.push(this._refractionTexture)},n.prototype.getAnimatables=function(e){this._thicknessTexture&&this._thicknessTexture.animations&&this._thicknessTexture.animations.length>0&&e.push(this._thicknessTexture),this._refractionTexture&&this._refractionTexture.animations&&this._refractionTexture.animations.length>0&&e.push(this._refractionTexture)},n.prototype.dispose=function(e){e&&(this._thicknessTexture&&this._thicknessTexture.dispose(),this._refractionTexture&&this._refractionTexture.dispose())},n.prototype.getClassName=function(){return"PBRSubSurfaceConfiguration"},n.prototype.addFallbacks=function(e,t,i){return e.SS_SCATTERING&&t.addFallback(i++,"SS_SCATTERING"),e.SS_TRANSLUCENCY&&t.addFallback(i++,"SS_TRANSLUCENCY"),i},n.prototype.getSamplers=function(e){e.push("thicknessSampler","refractionIntensitySampler","translucencyIntensitySampler","refractionSampler","refractionSamplerLow","refractionSamplerHigh")},n.prototype.getUniforms=function(){return{ubo:[{name:"vRefractionMicrosurfaceInfos",size:4,type:"vec4"},{name:"vRefractionFilteringInfo",size:2,type:"vec2"},{name:"vTranslucencyIntensityInfos",size:2,type:"vec2"},{name:"vRefractionInfos",size:4,type:"vec4"},{name:"refractionMatrix",size:16,type:"mat4"},{name:"vThicknessInfos",size:2,type:"vec2"},{name:"vRefractionIntensityInfos",size:2,type:"vec2"},{name:"thicknessMatrix",size:16,type:"mat4"},{name:"refractionIntensityMatrix",size:16,type:"mat4"},{name:"translucencyIntensityMatrix",size:16,type:"mat4"},{name:"vThicknessParam",size:2,type:"vec2"},{name:"vDiffusionDistance",size:3,type:"vec3"},{name:"vTintColor",size:4,type:"vec4"},{name:"vSubSurfaceIntensity",size:3,type:"vec3"},{name:"vRefractionPosition",size:3,type:"vec3"},{name:"vRefractionSize",size:3,type:"vec3"},{name:"scatteringDiffusionProfile",size:1,type:"float"}]}},E([T(),N("_markAllSubMeshesAsTexturesDirty")],n.prototype,"isRefractionEnabled",void 0),E([T(),N("_markAllSubMeshesAsTexturesDirty")],n.prototype,"isTranslucencyEnabled",void 0),E([T(),N("_markScenePrePassDirty")],n.prototype,"isScatteringEnabled",void 0),E([T()],n.prototype,"_scatteringDiffusionProfileIndex",void 0),E([T()],n.prototype,"refractionIntensity",void 0),E([T()],n.prototype,"translucencyIntensity",void 0),E([T()],n.prototype,"useAlbedoToTintRefraction",void 0),E([T()],n.prototype,"useAlbedoToTintTranslucency",void 0),E([de(),N("_markAllSubMeshesAsTexturesDirty")],n.prototype,"thicknessTexture",void 0),E([de(),N("_markAllSubMeshesAsTexturesDirty")],n.prototype,"refractionTexture",void 0),E([T(),N("_markAllSubMeshesAsTexturesDirty")],n.prototype,"indexOfRefraction",void 0),E([T()],n.prototype,"_volumeIndexOfRefraction",void 0),E([N("_markAllSubMeshesAsTexturesDirty")],n.prototype,"volumeIndexOfRefraction",null),E([T(),N("_markAllSubMeshesAsTexturesDirty")],n.prototype,"invertRefractionY",void 0),E([T(),N("_markAllSubMeshesAsTexturesDirty")],n.prototype,"linkRefractionWithTransparency",void 0),E([T()],n.prototype,"minimumThickness",void 0),E([T()],n.prototype,"maximumThickness",void 0),E([T()],n.prototype,"useThicknessAsDepth",void 0),E([Ye()],n.prototype,"tintColor",void 0),E([T()],n.prototype,"tintColorAtDistance",void 0),E([Ye()],n.prototype,"diffusionDistance",void 0),E([T(),N("_markAllSubMeshesAsTexturesDirty")],n.prototype,"useMaskFromThicknessTexture",void 0),E([de(),N("_markAllSubMeshesAsTexturesDirty")],n.prototype,"refractionIntensityTexture",void 0),E([de(),N("_markAllSubMeshesAsTexturesDirty")],n.prototype,"translucencyIntensityTexture",void 0),E([T(),N("_markAllSubMeshesAsTexturesDirty")],n.prototype,"useGltfStyleTextures",void 0),n}(Yt),bt={effect:null,subMesh:null},Qi=function(r){R(n,r);function n(e){var t=r.call(this,e)||this;return t.PBR=!0,t.NUM_SAMPLES="0",t.REALTIME_FILTERING=!1,t.MAINUV1=!1,t.MAINUV2=!1,t.MAINUV3=!1,t.MAINUV4=!1,t.MAINUV5=!1,t.MAINUV6=!1,t.UV1=!1,t.UV2=!1,t.UV3=!1,t.UV4=!1,t.UV5=!1,t.UV6=!1,t.ALBEDO=!1,t.GAMMAALBEDO=!1,t.ALBEDODIRECTUV=0,t.VERTEXCOLOR=!1,t.BAKED_VERTEX_ANIMATION_TEXTURE=!1,t.AMBIENT=!1,t.AMBIENTDIRECTUV=0,t.AMBIENTINGRAYSCALE=!1,t.OPACITY=!1,t.VERTEXALPHA=!1,t.OPACITYDIRECTUV=0,t.OPACITYRGB=!1,t.ALPHATEST=!1,t.DEPTHPREPASS=!1,t.ALPHABLEND=!1,t.ALPHAFROMALBEDO=!1,t.ALPHATESTVALUE="0.5",t.SPECULAROVERALPHA=!1,t.RADIANCEOVERALPHA=!1,t.ALPHAFRESNEL=!1,t.LINEARALPHAFRESNEL=!1,t.PREMULTIPLYALPHA=!1,t.EMISSIVE=!1,t.EMISSIVEDIRECTUV=0,t.GAMMAEMISSIVE=!1,t.REFLECTIVITY=!1,t.REFLECTIVITY_GAMMA=!1,t.REFLECTIVITYDIRECTUV=0,t.SPECULARTERM=!1,t.MICROSURFACEFROMREFLECTIVITYMAP=!1,t.MICROSURFACEAUTOMATIC=!1,t.LODBASEDMICROSFURACE=!1,t.MICROSURFACEMAP=!1,t.MICROSURFACEMAPDIRECTUV=0,t.METALLICWORKFLOW=!1,t.ROUGHNESSSTOREINMETALMAPALPHA=!1,t.ROUGHNESSSTOREINMETALMAPGREEN=!1,t.METALLNESSSTOREINMETALMAPBLUE=!1,t.AOSTOREINMETALMAPRED=!1,t.METALLIC_REFLECTANCE=!1,t.METALLIC_REFLECTANCE_GAMMA=!1,t.METALLIC_REFLECTANCEDIRECTUV=0,t.METALLIC_REFLECTANCE_USE_ALPHA_ONLY=!1,t.REFLECTANCE=!1,t.REFLECTANCE_GAMMA=!1,t.REFLECTANCEDIRECTUV=0,t.ENVIRONMENTBRDF=!1,t.ENVIRONMENTBRDF_RGBD=!1,t.NORMAL=!1,t.TANGENT=!1,t.BUMP=!1,t.BUMPDIRECTUV=0,t.OBJECTSPACE_NORMALMAP=!1,t.PARALLAX=!1,t.PARALLAXOCCLUSION=!1,t.NORMALXYSCALE=!0,t.LIGHTMAP=!1,t.LIGHTMAPDIRECTUV=0,t.USELIGHTMAPASSHADOWMAP=!1,t.GAMMALIGHTMAP=!1,t.RGBDLIGHTMAP=!1,t.REFLECTION=!1,t.REFLECTIONMAP_3D=!1,t.REFLECTIONMAP_SPHERICAL=!1,t.REFLECTIONMAP_PLANAR=!1,t.REFLECTIONMAP_CUBIC=!1,t.USE_LOCAL_REFLECTIONMAP_CUBIC=!1,t.REFLECTIONMAP_PROJECTION=!1,t.REFLECTIONMAP_SKYBOX=!1,t.REFLECTIONMAP_EXPLICIT=!1,t.REFLECTIONMAP_EQUIRECTANGULAR=!1,t.REFLECTIONMAP_EQUIRECTANGULAR_FIXED=!1,t.REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED=!1,t.INVERTCUBICMAP=!1,t.USESPHERICALFROMREFLECTIONMAP=!1,t.USEIRRADIANCEMAP=!1,t.USESPHERICALINVERTEX=!1,t.REFLECTIONMAP_OPPOSITEZ=!1,t.LODINREFLECTIONALPHA=!1,t.GAMMAREFLECTION=!1,t.RGBDREFLECTION=!1,t.LINEARSPECULARREFLECTION=!1,t.RADIANCEOCCLUSION=!1,t.HORIZONOCCLUSION=!1,t.INSTANCES=!1,t.THIN_INSTANCES=!1,t.INSTANCESCOLOR=!1,t.PREPASS=!1,t.PREPASS_IRRADIANCE=!1,t.PREPASS_IRRADIANCE_INDEX=-1,t.PREPASS_ALBEDO_SQRT=!1,t.PREPASS_ALBEDO_SQRT_INDEX=-1,t.PREPASS_DEPTH=!1,t.PREPASS_DEPTH_INDEX=-1,t.PREPASS_NORMAL=!1,t.PREPASS_NORMAL_INDEX=-1,t.PREPASS_POSITION=!1,t.PREPASS_POSITION_INDEX=-1,t.PREPASS_VELOCITY=!1,t.PREPASS_VELOCITY_INDEX=-1,t.PREPASS_REFLECTIVITY=!1,t.PREPASS_REFLECTIVITY_INDEX=-1,t.SCENE_MRT_COUNT=0,t.NUM_BONE_INFLUENCERS=0,t.BonesPerMesh=0,t.BONETEXTURE=!1,t.BONES_VELOCITY_ENABLED=!1,t.NONUNIFORMSCALING=!1,t.MORPHTARGETS=!1,t.MORPHTARGETS_NORMAL=!1,t.MORPHTARGETS_TANGENT=!1,t.MORPHTARGETS_UV=!1,t.NUM_MORPH_INFLUENCERS=0,t.MORPHTARGETS_TEXTURE=!1,t.IMAGEPROCESSING=!1,t.VIGNETTE=!1,t.VIGNETTEBLENDMODEMULTIPLY=!1,t.VIGNETTEBLENDMODEOPAQUE=!1,t.TONEMAPPING=!1,t.TONEMAPPING_ACES=!1,t.CONTRAST=!1,t.COLORCURVES=!1,t.COLORGRADING=!1,t.COLORGRADING3D=!1,t.SAMPLER3DGREENDEPTH=!1,t.SAMPLER3DBGRMAP=!1,t.IMAGEPROCESSINGPOSTPROCESS=!1,t.SKIPFINALCOLORCLAMP=!1,t.EXPOSURE=!1,t.MULTIVIEW=!1,t.ORDER_INDEPENDENT_TRANSPARENCY=!1,t.ORDER_INDEPENDENT_TRANSPARENCY_16BITS=!1,t.USEPHYSICALLIGHTFALLOFF=!1,t.USEGLTFLIGHTFALLOFF=!1,t.TWOSIDEDLIGHTING=!1,t.SHADOWFLOAT=!1,t.CLIPPLANE=!1,t.CLIPPLANE2=!1,t.CLIPPLANE3=!1,t.CLIPPLANE4=!1,t.CLIPPLANE5=!1,t.CLIPPLANE6=!1,t.POINTSIZE=!1,t.FOG=!1,t.LOGARITHMICDEPTH=!1,t.FORCENORMALFORWARD=!1,t.SPECULARAA=!1,t.UNLIT=!1,t.DEBUGMODE=0,t.rebuild(),t}return n.prototype.reset=function(){r.prototype.reset.call(this),this.ALPHATESTVALUE="0.5",this.PBR=!0,this.NORMALXYSCALE=!0},n}(mt),ye=function(r){R(n,r);function n(e,t){var i=r.call(this,e,t)||this;return i._directIntensity=1,i._emissiveIntensity=1,i._environmentIntensity=1,i._specularIntensity=1,i._lightingInfos=new ut(i._directIntensity,i._emissiveIntensity,i._environmentIntensity,i._specularIntensity),i._disableBumpMap=!1,i._albedoTexture=null,i._ambientTexture=null,i._ambientTextureStrength=1,i._ambientTextureImpactOnAnalyticalLights=n.DEFAULT_AO_ON_ANALYTICAL_LIGHTS,i._opacityTexture=null,i._reflectionTexture=null,i._emissiveTexture=null,i._reflectivityTexture=null,i._metallicTexture=null,i._metallic=null,i._roughness=null,i._metallicF0Factor=1,i._metallicReflectanceColor=G.White(),i._useOnlyMetallicFromMetallicReflectanceTexture=!1,i._metallicReflectanceTexture=null,i._reflectanceTexture=null,i._microSurfaceTexture=null,i._bumpTexture=null,i._lightmapTexture=null,i._ambientColor=new G(0,0,0),i._albedoColor=new G(1,1,1),i._reflectivityColor=new G(1,1,1),i._reflectionColor=new G(1,1,1),i._emissiveColor=new G(0,0,0),i._microSurface=.9,i._useLightmapAsShadowmap=!1,i._useHorizonOcclusion=!0,i._useRadianceOcclusion=!0,i._useAlphaFromAlbedoTexture=!1,i._useSpecularOverAlpha=!0,i._useMicroSurfaceFromReflectivityMapAlpha=!1,i._useRoughnessFromMetallicTextureAlpha=!0,i._useRoughnessFromMetallicTextureGreen=!1,i._useMetallnessFromMetallicTextureBlue=!1,i._useAmbientOcclusionFromMetallicTextureRed=!1,i._useAmbientInGrayScale=!1,i._useAutoMicroSurfaceFromReflectivityMap=!1,i._lightFalloff=n.LIGHTFALLOFF_PHYSICAL,i._useRadianceOverAlpha=!0,i._useObjectSpaceNormalMap=!1,i._useParallax=!1,i._useParallaxOcclusion=!1,i._parallaxScaleBias=.05,i._disableLighting=!1,i._maxSimultaneousLights=4,i._invertNormalMapX=!1,i._invertNormalMapY=!1,i._twoSidedLighting=!1,i._alphaCutOff=.4,i._forceAlphaTest=!1,i._useAlphaFresnel=!1,i._useLinearAlphaFresnel=!1,i._environmentBRDFTexture=null,i._forceIrradianceInFragment=!1,i._realTimeFiltering=!1,i._realTimeFilteringQuality=8,i._forceNormalForward=!1,i._enableSpecularAntiAliasing=!1,i._imageProcessingObserver=null,i._renderTargets=new _o(16),i._globalAmbientColor=new G(0,0,0),i._useLogarithmicDepth=!1,i._unlit=!1,i._debugMode=0,i.debugMode=0,i._debugLimit=-1,i._debugFactor=1,i._cacheHasRenderTargetTextures=!1,i.brdf=new wa(i),i.clearCoat=new Gn(i),i.anisotropy=new rc(i),i.sheen=new ac(i),i.subSurface=new cc(i),i.detailMap=new go(i),i._attachImageProcessingConfiguration(null),i.getRenderTargetTextures=function(){return i._renderTargets.reset(),M.ReflectionTextureEnabled&&i._reflectionTexture&&i._reflectionTexture.isRenderTarget&&i._renderTargets.push(i._reflectionTexture),i._eventInfo.renderTargets=i._renderTargets,i._callbackPluginEventFillRenderTargetTextures(i._eventInfo),i._renderTargets},i._environmentBRDFTexture=Ai(i.getScene()),i.prePassConfiguration=new An,i}return Object.defineProperty(n.prototype,"realTimeFiltering",{get:function(){return this._realTimeFiltering},set:function(e){this._realTimeFiltering=e,this.markAsDirty(1)},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"realTimeFilteringQuality",{get:function(){return this._realTimeFilteringQuality},set:function(e){this._realTimeFilteringQuality=e,this.markAsDirty(1)},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"canRenderToMRT",{get:function(){return!0},enumerable:!1,configurable:!0}),n.prototype._attachImageProcessingConfiguration=function(e){var t=this;e!==this._imageProcessingConfiguration&&(this._imageProcessingConfiguration&&this._imageProcessingObserver&&this._imageProcessingConfiguration.onUpdateParameters.remove(this._imageProcessingObserver),e?this._imageProcessingConfiguration=e:this._imageProcessingConfiguration=this.getScene().imageProcessingConfiguration,this._imageProcessingConfiguration&&(this._imageProcessingObserver=this._imageProcessingConfiguration.onUpdateParameters.add(function(){t._markAllSubMeshesAsImageProcessingDirty()})))},Object.defineProperty(n.prototype,"hasRenderTargetTextures",{get:function(){return M.ReflectionTextureEnabled&&this._reflectionTexture&&this._reflectionTexture.isRenderTarget?!0:this._cacheHasRenderTargetTextures},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"isPrePassCapable",{get:function(){return!this.disableDepthWrite},enumerable:!1,configurable:!0}),n.prototype.getClassName=function(){return"PBRBaseMaterial"},Object.defineProperty(n.prototype,"useLogarithmicDepth",{get:function(){return this._useLogarithmicDepth},set:function(e){this._useLogarithmicDepth=e&&this.getScene().getEngine().getCaps().fragmentDepthSupported},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"_disableAlphaBlending",{get:function(){var e;return this._transparencyMode===n.PBRMATERIAL_OPAQUE||this._transparencyMode===n.PBRMATERIAL_ALPHATEST||((e=this.subSurface)===null||e===void 0?void 0:e.disableAlphaBlending)},enumerable:!1,configurable:!0}),n.prototype.needAlphaBlending=function(){return this._disableAlphaBlending?!1:this.alpha<1||this._opacityTexture!=null||this._shouldUseAlphaFromAlbedoTexture()},n.prototype.needAlphaTesting=function(){var e;return this._forceAlphaTest?!0:!((e=this.subSurface)===null||e===void 0)&&e.disableAlphaBlending?!1:this._hasAlphaChannel()&&(this._transparencyMode==null||this._transparencyMode===n.PBRMATERIAL_ALPHATEST)},n.prototype._shouldUseAlphaFromAlbedoTexture=function(){return this._albedoTexture!=null&&this._albedoTexture.hasAlpha&&this._useAlphaFromAlbedoTexture&&this._transparencyMode!==n.PBRMATERIAL_OPAQUE},n.prototype._hasAlphaChannel=function(){return this._albedoTexture!=null&&this._albedoTexture.hasAlpha||this._opacityTexture!=null},n.prototype.getAlphaTestTexture=function(){return this._albedoTexture},n.prototype.isReadyForSubMesh=function(e,t,i){if(this._uniformBufferLayoutBuilt||this.buildUniformLayout(),t.effect&&this.isFrozen&&t.effect._wasPreviouslyReady)return!0;t.materialDefines||(this._callbackPluginEventGeneric(bn.GetDefineNames,this._eventInfo),t.materialDefines=new Qi(this._eventInfo.defineNames));var o=t.materialDefines;if(this._isReadyForSubMesh(t))return!0;var a=this.getScene(),s=a.getEngine();if(o._areTexturesDirty&&(this._eventInfo.hasRenderTargetTextures=!1,this._callbackPluginEventHasRenderTargetTextures(this._eventInfo),this._cacheHasRenderTargetTextures=this._eventInfo.hasRenderTargetTextures,a.texturesEnabled)){if(this._albedoTexture&&M.DiffuseTextureEnabled&&!this._albedoTexture.isReadyOrNotBlocking()||this._ambientTexture&&M.AmbientTextureEnabled&&!this._ambientTexture.isReadyOrNotBlocking()||this._opacityTexture&&M.OpacityTextureEnabled&&!this._opacityTexture.isReadyOrNotBlocking())return!1;var c=this._getReflectionTexture();if(c&&M.ReflectionTextureEnabled&&(!c.isReadyOrNotBlocking()||c.irradianceTexture&&!c.irradianceTexture.isReadyOrNotBlocking())||this._lightmapTexture&&M.LightmapTextureEnabled&&!this._lightmapTexture.isReadyOrNotBlocking()||this._emissiveTexture&&M.EmissiveTextureEnabled&&!this._emissiveTexture.isReadyOrNotBlocking())return!1;if(M.SpecularTextureEnabled){if(this._metallicTexture){if(!this._metallicTexture.isReadyOrNotBlocking())return!1}else if(this._reflectivityTexture&&!this._reflectivityTexture.isReadyOrNotBlocking())return!1;if(this._metallicReflectanceTexture&&!this._metallicReflectanceTexture.isReadyOrNotBlocking()||this._reflectanceTexture&&!this._reflectanceTexture.isReadyOrNotBlocking()||this._microSurfaceTexture&&!this._microSurfaceTexture.isReadyOrNotBlocking())return!1}if(s.getCaps().standardDerivatives&&this._bumpTexture&&M.BumpTextureEnabled&&!this._disableBumpMap&&!this._bumpTexture.isReady()||this._environmentBRDFTexture&&M.ReflectionTextureEnabled&&!this._environmentBRDFTexture.isReady())return!1}if(this._eventInfo.isReadyForSubMesh=!0,this._eventInfo.defines=o,this._callbackPluginEventIsReadyForSubMesh(this._eventInfo),!this._eventInfo.isReadyForSubMesh||o._areImageProcessingDirty&&this._imageProcessingConfiguration&&!this._imageProcessingConfiguration.isReady())return!1;!s.getCaps().standardDerivatives&&!e.isVerticesDataPresent(w.NormalKind)&&(e.createNormals(!0),ne.Warn("PBRMaterial: Normals have been created for the mesh: "+e.name));var l=t.effect,u=o._areLightsDisposed,f=this._prepareEffect(e,o,this.onCompiled,this.onError,i,null,t.getRenderingMesh().hasThinInstances);if(f)if(this._onEffectCreatedObservable&&(bt.effect=f,bt.subMesh=t,this._onEffectCreatedObservable.notifyObservers(bt)),this.allowShaderHotSwapping&&l&&!f.isReady()){if(f=l,o.markAsUnprocessed(),u)return o._areLightsDisposed=!0,!1}else a.resetCachedMaterial(),t.setEffect(f,o,this._materialContext);return!t.effect||!t.effect.isReady()?!1:(o._renderId=a.getRenderId(),t.effect._wasPreviouslyReady=!0,!0)},n.prototype.isMetallicWorkflow=function(){return!!(this._metallic!=null||this._roughness!=null||this._metallicTexture)},n.prototype._prepareEffect=function(e,t,i,o,a,s,c){if(i===void 0&&(i=null),o===void 0&&(o=null),a===void 0&&(a=null),s===void 0&&(s=null),this._prepareDefines(e,t,a,s,c),!t.isDirty)return null;t.markAsProcessed();var l=this.getScene(),u=l.getEngine(),f=new tr,d=0;t.USESPHERICALINVERTEX&&f.addFallback(d++,"USESPHERICALINVERTEX"),t.FOG&&f.addFallback(d,"FOG"),t.SPECULARAA&&f.addFallback(d,"SPECULARAA"),t.POINTSIZE&&f.addFallback(d,"POINTSIZE"),t.LOGARITHMICDEPTH&&f.addFallback(d,"LOGARITHMICDEPTH"),t.PARALLAX&&f.addFallback(d,"PARALLAX"),t.PARALLAXOCCLUSION&&f.addFallback(d++,"PARALLAXOCCLUSION"),t.ENVIRONMENTBRDF&&f.addFallback(d++,"ENVIRONMENTBRDF"),t.TANGENT&&f.addFallback(d++,"TANGENT"),t.BUMP&&f.addFallback(d++,"BUMP"),d=F.HandleFallbacksForShadows(t,f,this._maxSimultaneousLights,d++),t.SPECULARTERM&&f.addFallback(d++,"SPECULARTERM"),t.USESPHERICALFROMREFLECTIONMAP&&f.addFallback(d++,"USESPHERICALFROMREFLECTIONMAP"),t.USEIRRADIANCEMAP&&f.addFallback(d++,"USEIRRADIANCEMAP"),t.LIGHTMAP&&f.addFallback(d++,"LIGHTMAP"),t.NORMAL&&f.addFallback(d++,"NORMAL"),t.AMBIENT&&f.addFallback(d++,"AMBIENT"),t.EMISSIVE&&f.addFallback(d++,"EMISSIVE"),t.VERTEXCOLOR&&f.addFallback(d++,"VERTEXCOLOR"),t.MORPHTARGETS&&f.addFallback(d++,"MORPHTARGETS"),t.MULTIVIEW&&f.addFallback(0,"MULTIVIEW");var p=[w.PositionKind];t.NORMAL&&p.push(w.NormalKind),t.TANGENT&&p.push(w.TangentKind);for(var m=1;m<=6;++m)t["UV"+m]&&p.push("uv".concat(m===1?"":m));t.VERTEXCOLOR&&p.push(w.ColorKind),t.INSTANCESCOLOR&&p.push(w.ColorInstanceKind),F.PrepareAttributesForBones(p,e,t,f),F.PrepareAttributesForInstances(p,t),F.PrepareAttributesForMorphTargets(p,e,t),F.PrepareAttributesForBakedVertexAnimation(p,e,t);var _="pbr",v=["world","view","viewProjection","vEyePosition","vLightsType","vAmbientColor","vAlbedoColor","vReflectivityColor","vMetallicReflectanceFactors","vEmissiveColor","visibility","vReflectionColor","vFogInfos","vFogColor","pointSize","vAlbedoInfos","vAmbientInfos","vOpacityInfos","vReflectionInfos","vReflectionPosition","vReflectionSize","vEmissiveInfos","vReflectivityInfos","vReflectionFilteringInfo","vMetallicReflectanceInfos","vReflectanceInfos","vMicroSurfaceSamplerInfos","vBumpInfos","vLightmapInfos","mBones","vClipPlane","vClipPlane2","vClipPlane3","vClipPlane4","vClipPlane5","vClipPlane6","albedoMatrix","ambientMatrix","opacityMatrix","reflectionMatrix","emissiveMatrix","reflectivityMatrix","normalMatrix","microSurfaceSamplerMatrix","bumpMatrix","lightmapMatrix","metallicReflectanceMatrix","reflectanceMatrix","vLightingIntensity","logarithmicDepthConstant","vSphericalX","vSphericalY","vSphericalZ","vSphericalXX_ZZ","vSphericalYY_ZZ","vSphericalZZ","vSphericalXY","vSphericalYZ","vSphericalZX","vSphericalL00","vSphericalL1_1","vSphericalL10","vSphericalL11","vSphericalL2_2","vSphericalL2_1","vSphericalL20","vSphericalL21","vSphericalL22","vReflectionMicrosurfaceInfos","vTangentSpaceParams","boneTextureWidth","vDebugMode","morphTargetTextureInfo","morphTargetTextureIndices"],b=["albedoSampler","reflectivitySampler","ambientSampler","emissiveSampler","bumpSampler","lightmapSampler","opacitySampler","reflectionSampler","reflectionSamplerLow","reflectionSamplerHigh","irradianceSampler","microSurfaceSampler","environmentBrdfSampler","boneSampler","metallicReflectanceSampler","reflectanceSampler","morphTargets","oitDepthSampler","oitFrontColorSampler"],A=["Material","Scene","Mesh"];this._eventInfo.fallbacks=f,this._eventInfo.fallbackRank=d,this._eventInfo.defines=t,this._eventInfo.uniforms=v,this._eventInfo.samplers=b,this._eventInfo.uniformBuffersNames=A,this._eventInfo.customCode=void 0,this._callbackPluginEventGeneric(bn.PrepareEffect,this._eventInfo),An.AddUniforms(v),An.AddSamplers(b),yn&&(yn.PrepareUniforms(v,t),yn.PrepareSamplers(b,t)),F.PrepareUniformsAndSamplersList({uniformsNames:v,uniformBuffersNames:A,samplers:b,defines:t,maxSimultaneousLights:this._maxSimultaneousLights});var S={};this.customShaderNameResolve&&(_=this.customShaderNameResolve(_,v,A,b,t,p,S));var C=t.toString();return u.createEffect(_,{attributes:p,uniformsNames:v,uniformBuffersNames:A,samplers:b,defines:C,fallbacks:f,onCompiled:i,onError:o,indexParameters:{maxSimultaneousLights:this._maxSimultaneousLights,maxSimultaneousMorphTargets:t.NUM_MORPH_INFLUENCERS},processFinalCode:S.processFinalCode,processCodeAfterIncludes:this._eventInfo.customCode,multiTarget:t.PREPASS},u)},n.prototype._prepareDefines=function(e,t,i,o,a){var s;i===void 0&&(i=null),o===void 0&&(o=null),a===void 0&&(a=!1);var c=this.getScene(),l=c.getEngine();F.PrepareDefinesForLights(c,e,t,!0,this._maxSimultaneousLights,this._disableLighting),t._needNormals=!0,F.PrepareDefinesForMultiview(c,t);var u=this.needAlphaBlendingForMesh(e)&&this.getScene().useOrderIndependentTransparency;if(F.PrepareDefinesForPrePass(c,t,this.canRenderToMRT&&!u),F.PrepareDefinesForOIT(c,t,u),t.METALLICWORKFLOW=this.isMetallicWorkflow(),t._areTexturesDirty){if(t._needUVs=!1,c.texturesEnabled){c.getEngine().getCaps().textureLOD&&(t.LODBASEDMICROSFURACE=!0),this._albedoTexture&&M.DiffuseTextureEnabled?(F.PrepareDefinesForMergedUV(this._albedoTexture,t,"ALBEDO"),t.GAMMAALBEDO=this._albedoTexture.gammaSpace):t.ALBEDO=!1,this._ambientTexture&&M.AmbientTextureEnabled?(F.PrepareDefinesForMergedUV(this._ambientTexture,t,"AMBIENT"),t.AMBIENTINGRAYSCALE=this._useAmbientInGrayScale):t.AMBIENT=!1,this._opacityTexture&&M.OpacityTextureEnabled?(F.PrepareDefinesForMergedUV(this._opacityTexture,t,"OPACITY"),t.OPACITYRGB=this._opacityTexture.getAlphaFromRGB):t.OPACITY=!1;var f=this._getReflectionTexture();if(f&&M.ReflectionTextureEnabled){switch(t.REFLECTION=!0,t.GAMMAREFLECTION=f.gammaSpace,t.RGBDREFLECTION=f.isRGBD,t.REFLECTIONMAP_OPPOSITEZ=this.getScene().useRightHandedSystem?!f.invertZ:f.invertZ,t.LODINREFLECTIONALPHA=f.lodLevelInAlpha,t.LINEARSPECULARREFLECTION=f.linearSpecularLOD,this.realTimeFiltering&&this.realTimeFilteringQuality>0?(t.NUM_SAMPLES=""+this.realTimeFilteringQuality,l._features.needTypeSuffixInShaderConstants&&(t.NUM_SAMPLES=t.NUM_SAMPLES+"u"),t.REALTIME_FILTERING=!0):t.REALTIME_FILTERING=!1,f.coordinatesMode===X.INVCUBIC_MODE&&(t.INVERTCUBICMAP=!0),t.REFLECTIONMAP_3D=f.isCube,t.REFLECTIONMAP_CUBIC=!1,t.REFLECTIONMAP_EXPLICIT=!1,t.REFLECTIONMAP_PLANAR=!1,t.REFLECTIONMAP_PROJECTION=!1,t.REFLECTIONMAP_SKYBOX=!1,t.REFLECTIONMAP_SPHERICAL=!1,t.REFLECTIONMAP_EQUIRECTANGULAR=!1,t.REFLECTIONMAP_EQUIRECTANGULAR_FIXED=!1,t.REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED=!1,f.coordinatesMode){case X.EXPLICIT_MODE:t.REFLECTIONMAP_EXPLICIT=!0;break;case X.PLANAR_MODE:t.REFLECTIONMAP_PLANAR=!0;break;case X.PROJECTION_MODE:t.REFLECTIONMAP_PROJECTION=!0;break;case X.SKYBOX_MODE:t.REFLECTIONMAP_SKYBOX=!0;break;case X.SPHERICAL_MODE:t.REFLECTIONMAP_SPHERICAL=!0;break;case X.EQUIRECTANGULAR_MODE:t.REFLECTIONMAP_EQUIRECTANGULAR=!0;break;case X.FIXED_EQUIRECTANGULAR_MODE:t.REFLECTIONMAP_EQUIRECTANGULAR_FIXED=!0;break;case X.FIXED_EQUIRECTANGULAR_MIRRORED_MODE:t.REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED=!0;break;case X.CUBIC_MODE:case X.INVCUBIC_MODE:default:t.REFLECTIONMAP_CUBIC=!0,t.USE_LOCAL_REFLECTIONMAP_CUBIC=!!f.boundingBoxSize;break}f.coordinatesMode!==X.SKYBOX_MODE&&(f.irradianceTexture?(t.USEIRRADIANCEMAP=!0,t.USESPHERICALFROMREFLECTIONMAP=!1):f.isCube&&(t.USESPHERICALFROMREFLECTIONMAP=!0,t.USEIRRADIANCEMAP=!1,this._forceIrradianceInFragment||this.realTimeFiltering||c.getEngine().getCaps().maxVaryingVectors<=8?t.USESPHERICALINVERTEX=!1:t.USESPHERICALINVERTEX=!0))}else t.REFLECTION=!1,t.REFLECTIONMAP_3D=!1,t.REFLECTIONMAP_SPHERICAL=!1,t.REFLECTIONMAP_PLANAR=!1,t.REFLECTIONMAP_CUBIC=!1,t.USE_LOCAL_REFLECTIONMAP_CUBIC=!1,t.REFLECTIONMAP_PROJECTION=!1,t.REFLECTIONMAP_SKYBOX=!1,t.REFLECTIONMAP_EXPLICIT=!1,t.REFLECTIONMAP_EQUIRECTANGULAR=!1,t.REFLECTIONMAP_EQUIRECTANGULAR_FIXED=!1,t.REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED=!1,t.INVERTCUBICMAP=!1,t.USESPHERICALFROMREFLECTIONMAP=!1,t.USEIRRADIANCEMAP=!1,t.USESPHERICALINVERTEX=!1,t.REFLECTIONMAP_OPPOSITEZ=!1,t.LODINREFLECTIONALPHA=!1,t.GAMMAREFLECTION=!1,t.RGBDREFLECTION=!1,t.LINEARSPECULARREFLECTION=!1;if(this._lightmapTexture&&M.LightmapTextureEnabled?(F.PrepareDefinesForMergedUV(this._lightmapTexture,t,"LIGHTMAP"),t.USELIGHTMAPASSHADOWMAP=this._useLightmapAsShadowmap,t.GAMMALIGHTMAP=this._lightmapTexture.gammaSpace,t.RGBDLIGHTMAP=this._lightmapTexture.isRGBD):t.LIGHTMAP=!1,this._emissiveTexture&&M.EmissiveTextureEnabled?(F.PrepareDefinesForMergedUV(this._emissiveTexture,t,"EMISSIVE"),t.GAMMAEMISSIVE=this._emissiveTexture.gammaSpace):t.EMISSIVE=!1,M.SpecularTextureEnabled){if(this._metallicTexture?(F.PrepareDefinesForMergedUV(this._metallicTexture,t,"REFLECTIVITY"),t.ROUGHNESSSTOREINMETALMAPALPHA=this._useRoughnessFromMetallicTextureAlpha,t.ROUGHNESSSTOREINMETALMAPGREEN=!this._useRoughnessFromMetallicTextureAlpha&&this._useRoughnessFromMetallicTextureGreen,t.METALLNESSSTOREINMETALMAPBLUE=this._useMetallnessFromMetallicTextureBlue,t.AOSTOREINMETALMAPRED=this._useAmbientOcclusionFromMetallicTextureRed,t.REFLECTIVITY_GAMMA=!1):this._reflectivityTexture?(F.PrepareDefinesForMergedUV(this._reflectivityTexture,t,"REFLECTIVITY"),t.MICROSURFACEFROMREFLECTIVITYMAP=this._useMicroSurfaceFromReflectivityMapAlpha,t.MICROSURFACEAUTOMATIC=this._useAutoMicroSurfaceFromReflectivityMap,t.REFLECTIVITY_GAMMA=this._reflectivityTexture.gammaSpace):t.REFLECTIVITY=!1,this._metallicReflectanceTexture||this._reflectanceTexture){var d=this._metallicReflectanceTexture!==null&&this._metallicReflectanceTexture._texture===((s=this._reflectanceTexture)===null||s===void 0?void 0:s._texture)&&this._metallicReflectanceTexture.checkTransformsAreIdentical(this._reflectanceTexture);t.METALLIC_REFLECTANCE_USE_ALPHA_ONLY=this._useOnlyMetallicFromMetallicReflectanceTexture&&!d,this._metallicReflectanceTexture?(F.PrepareDefinesForMergedUV(this._metallicReflectanceTexture,t,"METALLIC_REFLECTANCE"),t.METALLIC_REFLECTANCE_GAMMA=this._metallicReflectanceTexture.gammaSpace):t.METALLIC_REFLECTANCE=!1,this._reflectanceTexture&&!d&&(!this._metallicReflectanceTexture||this._metallicReflectanceTexture&&this._useOnlyMetallicFromMetallicReflectanceTexture)?(F.PrepareDefinesForMergedUV(this._reflectanceTexture,t,"REFLECTANCE"),t.REFLECTANCE_GAMMA=this._reflectanceTexture.gammaSpace):t.REFLECTANCE=!1}else t.METALLIC_REFLECTANCE=!1,t.REFLECTANCE=!1;this._microSurfaceTexture?F.PrepareDefinesForMergedUV(this._microSurfaceTexture,t,"MICROSURFACEMAP"):t.MICROSURFACEMAP=!1}else t.REFLECTIVITY=!1,t.MICROSURFACEMAP=!1;c.getEngine().getCaps().standardDerivatives&&this._bumpTexture&&M.BumpTextureEnabled&&!this._disableBumpMap?(F.PrepareDefinesForMergedUV(this._bumpTexture,t,"BUMP"),this._useParallax&&this._albedoTexture&&M.DiffuseTextureEnabled?(t.PARALLAX=!0,t.PARALLAXOCCLUSION=!!this._useParallaxOcclusion):t.PARALLAX=!1,t.OBJECTSPACE_NORMALMAP=this._useObjectSpaceNormalMap):t.BUMP=!1,this._environmentBRDFTexture&&M.ReflectionTextureEnabled?(t.ENVIRONMENTBRDF=!0,t.ENVIRONMENTBRDF_RGBD=this._environmentBRDFTexture.isRGBD):(t.ENVIRONMENTBRDF=!1,t.ENVIRONMENTBRDF_RGBD=!1),this._shouldUseAlphaFromAlbedoTexture()?t.ALPHAFROMALBEDO=!0:t.ALPHAFROMALBEDO=!1}t.SPECULAROVERALPHA=this._useSpecularOverAlpha,this._lightFalloff===n.LIGHTFALLOFF_STANDARD?(t.USEPHYSICALLIGHTFALLOFF=!1,t.USEGLTFLIGHTFALLOFF=!1):this._lightFalloff===n.LIGHTFALLOFF_GLTF?(t.USEPHYSICALLIGHTFALLOFF=!1,t.USEGLTFLIGHTFALLOFF=!0):(t.USEPHYSICALLIGHTFALLOFF=!0,t.USEGLTFLIGHTFALLOFF=!1),t.RADIANCEOVERALPHA=this._useRadianceOverAlpha,!this.backFaceCulling&&this._twoSidedLighting?t.TWOSIDEDLIGHTING=!0:t.TWOSIDEDLIGHTING=!1,t.SPECULARAA=c.getEngine().getCaps().standardDerivatives&&this._enableSpecularAntiAliasing}(t._areTexturesDirty||t._areMiscDirty)&&(t.ALPHATESTVALUE="".concat(this._alphaCutOff).concat(this._alphaCutOff%1===0?".":""),t.PREMULTIPLYALPHA=this.alphaMode===7||this.alphaMode===8,t.ALPHABLEND=this.needAlphaBlendingForMesh(e),t.ALPHAFRESNEL=this._useAlphaFresnel||this._useLinearAlphaFresnel,t.LINEARALPHAFRESNEL=this._useLinearAlphaFresnel),t._areImageProcessingDirty&&this._imageProcessingConfiguration&&this._imageProcessingConfiguration.prepareDefines(t),t.FORCENORMALFORWARD=this._forceNormalForward,t.RADIANCEOCCLUSION=this._useRadianceOcclusion,t.HORIZONOCCLUSION=this._useHorizonOcclusion,t._areMiscDirty&&(F.PrepareDefinesForMisc(e,c,this._useLogarithmicDepth,this.pointsCloud,this.fogEnabled,this._shouldTurnAlphaTestOn(e)||this._forceAlphaTest,t),t.UNLIT=this._unlit||(this.pointsCloud||this.wireframe)&&!e.isVerticesDataPresent(w.NormalKind),t.DEBUGMODE=this._debugMode),this._eventInfo.defines=t,this._eventInfo.mesh=e,this._callbackPluginEventPrepareDefines(this._eventInfo),F.PrepareDefinesForFrameBoundValues(c,l,t,!!i,o,a),F.PrepareDefinesForAttributes(e,t,!0,!0,!0,this._transparencyMode!==n.PBRMATERIAL_OPAQUE)},n.prototype.forceCompilation=function(e,t,i){var o=this,a=Oe({clipPlane:!1,useInstances:!1},i);this._uniformBufferLayoutBuilt||this.buildUniformLayout(),this._callbackPluginEventGeneric(bn.GetDefineNames,this._eventInfo);var s=new Qi(this._eventInfo.defineNames),c=this._prepareEffect(e,s,void 0,void 0,a.useInstances,a.clipPlane,e.hasThinInstances);this._onEffectCreatedObservable&&(bt.effect=c,bt.subMesh=null,this._onEffectCreatedObservable.notifyObservers(bt)),c.isReady()?t&&t(this):c.onCompileObservable.add(function(){t&&t(o)})},n.prototype.buildUniformLayout=function(){var e=this._uniformBuffer;e.addUniform("vAlbedoInfos",2),e.addUniform("vAmbientInfos",4),e.addUniform("vOpacityInfos",2),e.addUniform("vEmissiveInfos",2),e.addUniform("vLightmapInfos",2),e.addUniform("vReflectivityInfos",3),e.addUniform("vMicroSurfaceSamplerInfos",2),e.addUniform("vReflectionInfos",2),e.addUniform("vReflectionFilteringInfo",2),e.addUniform("vReflectionPosition",3),e.addUniform("vReflectionSize",3),e.addUniform("vBumpInfos",3),e.addUniform("albedoMatrix",16),e.addUniform("ambientMatrix",16),e.addUniform("opacityMatrix",16),e.addUniform("emissiveMatrix",16),e.addUniform("lightmapMatrix",16),e.addUniform("reflectivityMatrix",16),e.addUniform("microSurfaceSamplerMatrix",16),e.addUniform("bumpMatrix",16),e.addUniform("vTangentSpaceParams",2),e.addUniform("reflectionMatrix",16),e.addUniform("vReflectionColor",3),e.addUniform("vAlbedoColor",4),e.addUniform("vLightingIntensity",4),e.addUniform("vReflectionMicrosurfaceInfos",3),e.addUniform("pointSize",1),e.addUniform("vReflectivityColor",4),e.addUniform("vEmissiveColor",3),e.addUniform("vAmbientColor",3),e.addUniform("vDebugMode",2),e.addUniform("vMetallicReflectanceFactors",4),e.addUniform("vMetallicReflectanceInfos",2),e.addUniform("metallicReflectanceMatrix",16),e.addUniform("vReflectanceInfos",2),e.addUniform("reflectanceMatrix",16),e.addUniform("vSphericalL00",3),e.addUniform("vSphericalL1_1",3),e.addUniform("vSphericalL10",3),e.addUniform("vSphericalL11",3),e.addUniform("vSphericalL2_2",3),e.addUniform("vSphericalL2_1",3),e.addUniform("vSphericalL20",3),e.addUniform("vSphericalL21",3),e.addUniform("vSphericalL22",3),e.addUniform("vSphericalX",3),e.addUniform("vSphericalY",3),e.addUniform("vSphericalZ",3),e.addUniform("vSphericalXX_ZZ",3),e.addUniform("vSphericalYY_ZZ",3),e.addUniform("vSphericalZZ",3),e.addUniform("vSphericalXY",3),e.addUniform("vSphericalYZ",3),e.addUniform("vSphericalZX",3),r.prototype.buildUniformLayout.call(this)},n.prototype.bindForSubMesh=function(e,t,i){var o,a,s,c,l=this.getScene(),u=i.materialDefines;if(!!u){var f=i.effect;if(!!f){this._activeEffect=f,t.getMeshUniformBuffer().bindToEffect(f,"Mesh"),t.transferToEffect(e);var d=l.getEngine();this._uniformBuffer.bindToEffect(f,"Material"),this.prePassConfiguration.bindForSubMesh(this._activeEffect,l,t,e,this.isFrozen),this._eventInfo.subMesh=i,this._callbackPluginEventHardBindForSubMesh(this._eventInfo),u.OBJECTSPACE_NORMALMAP&&(e.toNormalMatrix(this._normalMatrix),this.bindOnlyNormalMatrix(this._normalMatrix));var p=this._mustRebind(l,f,t.visibility);F.BindBonesParameters(t,this._activeEffect,this.prePassConfiguration);var m=null,_=this._uniformBuffer;if(p){if(this.bindViewProjection(f),m=this._getReflectionTexture(),!_.useUbo||!this.isFrozen||!_.isSync){if(l.texturesEnabled){if(this._albedoTexture&&M.DiffuseTextureEnabled&&(_.updateFloat2("vAlbedoInfos",this._albedoTexture.coordinatesIndex,this._albedoTexture.level),F.BindTextureMatrix(this._albedoTexture,_,"albedo")),this._ambientTexture&&M.AmbientTextureEnabled&&(_.updateFloat4("vAmbientInfos",this._ambientTexture.coordinatesIndex,this._ambientTexture.level,this._ambientTextureStrength,this._ambientTextureImpactOnAnalyticalLights),F.BindTextureMatrix(this._ambientTexture,_,"ambient")),this._opacityTexture&&M.OpacityTextureEnabled&&(_.updateFloat2("vOpacityInfos",this._opacityTexture.coordinatesIndex,this._opacityTexture.level),F.BindTextureMatrix(this._opacityTexture,_,"opacity")),m&&M.ReflectionTextureEnabled){if(_.updateMatrix("reflectionMatrix",m.getReflectionTextureMatrix()),_.updateFloat2("vReflectionInfos",m.level,0),m.boundingBoxSize){var v=m;_.updateVector3("vReflectionPosition",v.boundingBoxPosition),_.updateVector3("vReflectionSize",v.boundingBoxSize)}if(this.realTimeFiltering){var b=m.getSize().width;_.updateFloat2("vReflectionFilteringInfo",b,Wt.Log2(b))}if(!u.USEIRRADIANCEMAP){var A=m.sphericalPolynomial;if(u.USESPHERICALFROMREFLECTIONMAP&&A)if(u.SPHERICAL_HARMONICS){var S=A.preScaledHarmonics;_.updateVector3("vSphericalL00",S.l00),_.updateVector3("vSphericalL1_1",S.l1_1),_.updateVector3("vSphericalL10",S.l10),_.updateVector3("vSphericalL11",S.l11),_.updateVector3("vSphericalL2_2",S.l2_2),_.updateVector3("vSphericalL2_1",S.l2_1),_.updateVector3("vSphericalL20",S.l20),_.updateVector3("vSphericalL21",S.l21),_.updateVector3("vSphericalL22",S.l22)}else _.updateFloat3("vSphericalX",A.x.x,A.x.y,A.x.z),_.updateFloat3("vSphericalY",A.y.x,A.y.y,A.y.z),_.updateFloat3("vSphericalZ",A.z.x,A.z.y,A.z.z),_.updateFloat3("vSphericalXX_ZZ",A.xx.x-A.zz.x,A.xx.y-A.zz.y,A.xx.z-A.zz.z),_.updateFloat3("vSphericalYY_ZZ",A.yy.x-A.zz.x,A.yy.y-A.zz.y,A.yy.z-A.zz.z),_.updateFloat3("vSphericalZZ",A.zz.x,A.zz.y,A.zz.z),_.updateFloat3("vSphericalXY",A.xy.x,A.xy.y,A.xy.z),_.updateFloat3("vSphericalYZ",A.yz.x,A.yz.y,A.yz.z),_.updateFloat3("vSphericalZX",A.zx.x,A.zx.y,A.zx.z)}_.updateFloat3("vReflectionMicrosurfaceInfos",m.getSize().width,m.lodGenerationScale,m.lodGenerationOffset)}this._emissiveTexture&&M.EmissiveTextureEnabled&&(_.updateFloat2("vEmissiveInfos",this._emissiveTexture.coordinatesIndex,this._emissiveTexture.level),F.BindTextureMatrix(this._emissiveTexture,_,"emissive")),this._lightmapTexture&&M.LightmapTextureEnabled&&(_.updateFloat2("vLightmapInfos",this._lightmapTexture.coordinatesIndex,this._lightmapTexture.level),F.BindTextureMatrix(this._lightmapTexture,_,"lightmap")),M.SpecularTextureEnabled&&(this._metallicTexture?(_.updateFloat3("vReflectivityInfos",this._metallicTexture.coordinatesIndex,this._metallicTexture.level,this._ambientTextureStrength),F.BindTextureMatrix(this._metallicTexture,_,"reflectivity")):this._reflectivityTexture&&(_.updateFloat3("vReflectivityInfos",this._reflectivityTexture.coordinatesIndex,this._reflectivityTexture.level,1),F.BindTextureMatrix(this._reflectivityTexture,_,"reflectivity")),this._metallicReflectanceTexture&&(_.updateFloat2("vMetallicReflectanceInfos",this._metallicReflectanceTexture.coordinatesIndex,this._metallicReflectanceTexture.level),F.BindTextureMatrix(this._metallicReflectanceTexture,_,"metallicReflectance")),this._reflectanceTexture&&u.REFLECTANCE&&(_.updateFloat2("vReflectanceInfos",this._reflectanceTexture.coordinatesIndex,this._reflectanceTexture.level),F.BindTextureMatrix(this._reflectanceTexture,_,"reflectance")),this._microSurfaceTexture&&(_.updateFloat2("vMicroSurfaceSamplerInfos",this._microSurfaceTexture.coordinatesIndex,this._microSurfaceTexture.level),F.BindTextureMatrix(this._microSurfaceTexture,_,"microSurfaceSampler"))),this._bumpTexture&&d.getCaps().standardDerivatives&&M.BumpTextureEnabled&&!this._disableBumpMap&&(_.updateFloat3("vBumpInfos",this._bumpTexture.coordinatesIndex,this._bumpTexture.level,this._parallaxScaleBias),F.BindTextureMatrix(this._bumpTexture,_,"bump"),l._mirroredCameraPosition?_.updateFloat2("vTangentSpaceParams",this._invertNormalMapX?1:-1,this._invertNormalMapY?1:-1):_.updateFloat2("vTangentSpaceParams",this._invertNormalMapX?-1:1,this._invertNormalMapY?-1:1))}if(this.pointsCloud&&_.updateFloat("pointSize",this.pointSize),u.METALLICWORKFLOW){ae.Color3[0].r=this._metallic===void 0||this._metallic===null?1:this._metallic,ae.Color3[0].g=this._roughness===void 0||this._roughness===null?1:this._roughness,_.updateColor4("vReflectivityColor",ae.Color3[0],1);var C=(a=(o=this.subSurface)===null||o===void 0?void 0:o._indexOfRefraction)!==null&&a!==void 0?a:1.5,O=1,B=Math.pow((C-O)/(C+O),2);this._metallicReflectanceColor.scaleToRef(B*this._metallicF0Factor,ae.Color3[0]);var k=this._metallicF0Factor;_.updateColor4("vMetallicReflectanceFactors",ae.Color3[0],k)}else _.updateColor4("vReflectivityColor",this._reflectivityColor,this._microSurface);_.updateColor3("vEmissiveColor",M.EmissiveTextureEnabled?this._emissiveColor:G.BlackReadOnly),_.updateColor3("vReflectionColor",this._reflectionColor),!u.SS_REFRACTION&&((s=this.subSurface)===null||s===void 0?void 0:s._linkRefractionWithTransparency)?_.updateColor4("vAlbedoColor",this._albedoColor,1):_.updateColor4("vAlbedoColor",this._albedoColor,this.alpha),this._lightingInfos.x=this._directIntensity,this._lightingInfos.y=this._emissiveIntensity,this._lightingInfos.z=this._environmentIntensity*l.environmentIntensity,this._lightingInfos.w=this._specularIntensity,_.updateVector4("vLightingIntensity",this._lightingInfos),l.ambientColor.multiplyToRef(this._ambientColor,this._globalAmbientColor),_.updateColor3("vAmbientColor",this._globalAmbientColor),_.updateFloat2("vDebugMode",this._debugLimit,this._debugFactor)}l.texturesEnabled&&(this._albedoTexture&&M.DiffuseTextureEnabled&&_.setTexture("albedoSampler",this._albedoTexture),this._ambientTexture&&M.AmbientTextureEnabled&&_.setTexture("ambientSampler",this._ambientTexture),this._opacityTexture&&M.OpacityTextureEnabled&&_.setTexture("opacitySampler",this._opacityTexture),m&&M.ReflectionTextureEnabled&&(u.LODBASEDMICROSFURACE?_.setTexture("reflectionSampler",m):(_.setTexture("reflectionSampler",m._lodTextureMid||m),_.setTexture("reflectionSamplerLow",m._lodTextureLow||m),_.setTexture("reflectionSamplerHigh",m._lodTextureHigh||m)),u.USEIRRADIANCEMAP&&_.setTexture("irradianceSampler",m.irradianceTexture)),u.ENVIRONMENTBRDF&&_.setTexture("environmentBrdfSampler",this._environmentBRDFTexture),this._emissiveTexture&&M.EmissiveTextureEnabled&&_.setTexture("emissiveSampler",this._emissiveTexture),this._lightmapTexture&&M.LightmapTextureEnabled&&_.setTexture("lightmapSampler",this._lightmapTexture),M.SpecularTextureEnabled&&(this._metallicTexture?_.setTexture("reflectivitySampler",this._metallicTexture):this._reflectivityTexture&&_.setTexture("reflectivitySampler",this._reflectivityTexture),this._metallicReflectanceTexture&&_.setTexture("metallicReflectanceSampler",this._metallicReflectanceTexture),this._reflectanceTexture&&u.REFLECTANCE&&_.setTexture("reflectanceSampler",this._reflectanceTexture),this._microSurfaceTexture&&_.setTexture("microSurfaceSampler",this._microSurfaceTexture)),this._bumpTexture&&d.getCaps().standardDerivatives&&M.BumpTextureEnabled&&!this._disableBumpMap&&_.setTexture("bumpSampler",this._bumpTexture)),this.getScene().useOrderIndependentTransparency&&this.needAlphaBlendingForMesh(t)&&this.getScene().depthPeelingRenderer.bind(f),this._eventInfo.subMesh=i,this._callbackPluginEventBindForSubMesh(this._eventInfo),F.BindClipPlane(this._activeEffect,l),this.bindEyePosition(f)}else l.getEngine()._features.needToAlwaysBindUniformBuffers&&(this._needToBindSceneUbo=!0);(p||!this.isFrozen)&&(l.lightsEnabled&&!this._disableLighting&&F.BindLights(l,t,this._activeEffect,u,this._maxSimultaneousLights),(l.fogEnabled&&t.applyFog&&l.fogMode!==Ne.FOGMODE_NONE||m||t.receiveShadows)&&this.bindView(f),F.BindFogParameters(l,t,this._activeEffect,!0),u.NUM_MORPH_INFLUENCERS&&F.BindMorphTargetParameters(t,this._activeEffect),u.BAKED_VERTEX_ANIMATION_TEXTURE&&((c=t.bakedVertexAnimationManager)===null||c===void 0||c.bind(f,u.INSTANCES)),this._imageProcessingConfiguration.bind(this._activeEffect),F.BindLogDepth(u,this._activeEffect,l)),this._afterBind(t,this._activeEffect),_.update()}}},n.prototype.getAnimatables=function(){var e=r.prototype.getAnimatables.call(this);return this._albedoTexture&&this._albedoTexture.animations&&this._albedoTexture.animations.length>0&&e.push(this._albedoTexture),this._ambientTexture&&this._ambientTexture.animations&&this._ambientTexture.animations.length>0&&e.push(this._ambientTexture),this._opacityTexture&&this._opacityTexture.animations&&this._opacityTexture.animations.length>0&&e.push(this._opacityTexture),this._reflectionTexture&&this._reflectionTexture.animations&&this._reflectionTexture.animations.length>0&&e.push(this._reflectionTexture),this._emissiveTexture&&this._emissiveTexture.animations&&this._emissiveTexture.animations.length>0&&e.push(this._emissiveTexture),this._metallicTexture&&this._metallicTexture.animations&&this._metallicTexture.animations.length>0?e.push(this._metallicTexture):this._reflectivityTexture&&this._reflectivityTexture.animations&&this._reflectivityTexture.animations.length>0&&e.push(this._reflectivityTexture),this._bumpTexture&&this._bumpTexture.animations&&this._bumpTexture.animations.length>0&&e.push(this._bumpTexture),this._lightmapTexture&&this._lightmapTexture.animations&&this._lightmapTexture.animations.length>0&&e.push(this._lightmapTexture),e},n.prototype._getReflectionTexture=function(){return this._reflectionTexture?this._reflectionTexture:this.getScene().environmentTexture},n.prototype.getActiveTextures=function(){var e=r.prototype.getActiveTextures.call(this);return this._albedoTexture&&e.push(this._albedoTexture),this._ambientTexture&&e.push(this._ambientTexture),this._opacityTexture&&e.push(this._opacityTexture),this._reflectionTexture&&e.push(this._reflectionTexture),this._emissiveTexture&&e.push(this._emissiveTexture),this._reflectivityTexture&&e.push(this._reflectivityTexture),this._metallicTexture&&e.push(this._metallicTexture),this._metallicReflectanceTexture&&e.push(this._metallicReflectanceTexture),this._reflectanceTexture&&e.push(this._reflectanceTexture),this._microSurfaceTexture&&e.push(this._microSurfaceTexture),this._bumpTexture&&e.push(this._bumpTexture),this._lightmapTexture&&e.push(this._lightmapTexture),e},n.prototype.hasTexture=function(e){return!!(r.prototype.hasTexture.call(this,e)||this._albedoTexture===e||this._ambientTexture===e||this._opacityTexture===e||this._reflectionTexture===e||this._reflectivityTexture===e||this._metallicTexture===e||this._metallicReflectanceTexture===e||this._reflectanceTexture===e||this._microSurfaceTexture===e||this._bumpTexture===e||this._lightmapTexture===e)},n.prototype.setPrePassRenderer=function(){var e;if(!((e=this.subSurface)===null||e===void 0)&&e.isScatteringEnabled){var t=this.getScene().enableSubSurfaceForPrePass();return t&&(t.enabled=!0),!0}return!1},n.prototype.dispose=function(e,t){var i,o,a,s,c,l,u,f,d,p,m,_;t&&(this._environmentBRDFTexture&&this.getScene().environmentBRDFTexture!==this._environmentBRDFTexture&&this._environmentBRDFTexture.dispose(),(i=this._albedoTexture)===null||i===void 0||i.dispose(),(o=this._ambientTexture)===null||o===void 0||o.dispose(),(a=this._opacityTexture)===null||a===void 0||a.dispose(),(s=this._reflectionTexture)===null||s===void 0||s.dispose(),(c=this._emissiveTexture)===null||c===void 0||c.dispose(),(l=this._metallicTexture)===null||l===void 0||l.dispose(),(u=this._reflectivityTexture)===null||u===void 0||u.dispose(),(f=this._bumpTexture)===null||f===void 0||f.dispose(),(d=this._lightmapTexture)===null||d===void 0||d.dispose(),(p=this._metallicReflectanceTexture)===null||p===void 0||p.dispose(),(m=this._reflectanceTexture)===null||m===void 0||m.dispose(),(_=this._microSurfaceTexture)===null||_===void 0||_.dispose()),this._renderTargets.dispose(),this._imageProcessingConfiguration&&this._imageProcessingObserver&&this._imageProcessingConfiguration.onUpdateParameters.remove(this._imageProcessingObserver),r.prototype.dispose.call(this,e,t)},n.PBRMATERIAL_OPAQUE=Ee.MATERIAL_OPAQUE,n.PBRMATERIAL_ALPHATEST=Ee.MATERIAL_ALPHATEST,n.PBRMATERIAL_ALPHABLEND=Ee.MATERIAL_ALPHABLEND,n.PBRMATERIAL_ALPHATESTANDBLEND=Ee.MATERIAL_ALPHATESTANDBLEND,n.DEFAULT_AO_ON_ANALYTICAL_LIGHTS=0,n.LIGHTFALLOFF_PHYSICAL=0,n.LIGHTFALLOFF_GLTF=1,n.LIGHTFALLOFF_STANDARD=2,E([mo()],n.prototype,"_imageProcessingConfiguration",void 0),E([N("_markAllSubMeshesAsMiscDirty")],n.prototype,"debugMode",void 0),E([T()],n.prototype,"useLogarithmicDepth",null),n}(er),me=function(r){R(n,r);function n(e,t){var i=r.call(this,e,t)||this;return i.directIntensity=1,i.emissiveIntensity=1,i.environmentIntensity=1,i.specularIntensity=1,i.disableBumpMap=!1,i.ambientTextureStrength=1,i.ambientTextureImpactOnAnalyticalLights=n.DEFAULT_AO_ON_ANALYTICAL_LIGHTS,i.metallicF0Factor=1,i.metallicReflectanceColor=G.White(),i.useOnlyMetallicFromMetallicReflectanceTexture=!1,i.ambientColor=new G(0,0,0),i.albedoColor=new G(1,1,1),i.reflectivityColor=new G(1,1,1),i.reflectionColor=new G(1,1,1),i.emissiveColor=new G(0,0,0),i.microSurface=1,i.useLightmapAsShadowmap=!1,i.useAlphaFromAlbedoTexture=!1,i.forceAlphaTest=!1,i.alphaCutOff=.4,i.useSpecularOverAlpha=!0,i.useMicroSurfaceFromReflectivityMapAlpha=!1,i.useRoughnessFromMetallicTextureAlpha=!0,i.useRoughnessFromMetallicTextureGreen=!1,i.useMetallnessFromMetallicTextureBlue=!1,i.useAmbientOcclusionFromMetallicTextureRed=!1,i.useAmbientInGrayScale=!1,i.useAutoMicroSurfaceFromReflectivityMap=!1,i.useRadianceOverAlpha=!0,i.useObjectSpaceNormalMap=!1,i.useParallax=!1,i.useParallaxOcclusion=!1,i.parallaxScaleBias=.05,i.disableLighting=!1,i.forceIrradianceInFragment=!1,i.maxSimultaneousLights=4,i.invertNormalMapX=!1,i.invertNormalMapY=!1,i.twoSidedLighting=!1,i.useAlphaFresnel=!1,i.useLinearAlphaFresnel=!1,i.environmentBRDFTexture=null,i.forceNormalForward=!1,i.enableSpecularAntiAliasing=!1,i.useHorizonOcclusion=!0,i.useRadianceOcclusion=!0,i.unlit=!1,i._environmentBRDFTexture=Ai(i.getScene()),i}return Object.defineProperty(n.prototype,"refractionTexture",{get:function(){return this.subSurface.refractionTexture},set:function(e){this.subSurface.refractionTexture=e,e?this.subSurface.isRefractionEnabled=!0:this.subSurface.linkRefractionWithTransparency||(this.subSurface.isRefractionEnabled=!1)},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"indexOfRefraction",{get:function(){return this.subSurface.indexOfRefraction},set:function(e){this.subSurface.indexOfRefraction=e},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"invertRefractionY",{get:function(){return this.subSurface.invertRefractionY},set:function(e){this.subSurface.invertRefractionY=e},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"linkRefractionWithTransparency",{get:function(){return this.subSurface.linkRefractionWithTransparency},set:function(e){this.subSurface.linkRefractionWithTransparency=e,e&&(this.subSurface.isRefractionEnabled=!0)},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"usePhysicalLightFalloff",{get:function(){return this._lightFalloff===ye.LIGHTFALLOFF_PHYSICAL},set:function(e){e!==this.usePhysicalLightFalloff&&(this._markAllSubMeshesAsTexturesDirty(),e?this._lightFalloff=ye.LIGHTFALLOFF_PHYSICAL:this._lightFalloff=ye.LIGHTFALLOFF_STANDARD)},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"useGLTFLightFalloff",{get:function(){return this._lightFalloff===ye.LIGHTFALLOFF_GLTF},set:function(e){e!==this.useGLTFLightFalloff&&(this._markAllSubMeshesAsTexturesDirty(),e?this._lightFalloff=ye.LIGHTFALLOFF_GLTF:this._lightFalloff=ye.LIGHTFALLOFF_STANDARD)},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"imageProcessingConfiguration",{get:function(){return this._imageProcessingConfiguration},set:function(e){this._attachImageProcessingConfiguration(e),this._markAllSubMeshesAsTexturesDirty()},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"cameraColorCurvesEnabled",{get:function(){return this.imageProcessingConfiguration.colorCurvesEnabled},set:function(e){this.imageProcessingConfiguration.colorCurvesEnabled=e},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"cameraColorGradingEnabled",{get:function(){return this.imageProcessingConfiguration.colorGradingEnabled},set:function(e){this.imageProcessingConfiguration.colorGradingEnabled=e},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"cameraToneMappingEnabled",{get:function(){return this._imageProcessingConfiguration.toneMappingEnabled},set:function(e){this._imageProcessingConfiguration.toneMappingEnabled=e},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"cameraExposure",{get:function(){return this._imageProcessingConfiguration.exposure},set:function(e){this._imageProcessingConfiguration.exposure=e},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"cameraContrast",{get:function(){return this._imageProcessingConfiguration.contrast},set:function(e){this._imageProcessingConfiguration.contrast=e},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"cameraColorGradingTexture",{get:function(){return this._imageProcessingConfiguration.colorGradingTexture},set:function(e){this._imageProcessingConfiguration.colorGradingTexture=e},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"cameraColorCurves",{get:function(){return this._imageProcessingConfiguration.colorCurves},set:function(e){this._imageProcessingConfiguration.colorCurves=e},enumerable:!1,configurable:!0}),n.prototype.getClassName=function(){return"PBRMaterial"},n.prototype.clone=function(e){var t=this,i=ft.Clone(function(){return new n(e,t.getScene())},this);return i.id=e,i.name=e,this.stencil.copyTo(i.stencil),this.clearCoat.copyTo(i.clearCoat),this.anisotropy.copyTo(i.anisotropy),this.brdf.copyTo(i.brdf),this.sheen.copyTo(i.sheen),this.subSurface.copyTo(i.subSurface),i},n.prototype.serialize=function(){var e=r.prototype.serialize.call(this);return e.customType="BABYLON.PBRMaterial",e.clearCoat=this.clearCoat.serialize(),e.anisotropy=this.anisotropy.serialize(),e.brdf=this.brdf.serialize(),e.sheen=this.sheen.serialize(),e.subSurface=this.subSurface.serialize(),e},n.Parse=function(e,t,i){var o=ft.Parse(function(){return new n(e.name,t)},e,t,i);return e.stencil&&o.stencil.parse(e.stencil,t,i),e.clearCoat&&o.clearCoat.parse(e.clearCoat,t,i),e.anisotropy&&o.anisotropy.parse(e.anisotropy,t,i),e.brdf&&o.brdf.parse(e.brdf,t,i),e.sheen&&o.sheen.parse(e.sheen,t,i),e.subSurface&&o.subSurface.parse(e.subSurface,t,i),o},n.PBRMATERIAL_OPAQUE=ye.PBRMATERIAL_OPAQUE,n.PBRMATERIAL_ALPHATEST=ye.PBRMATERIAL_ALPHATEST,n.PBRMATERIAL_ALPHABLEND=ye.PBRMATERIAL_ALPHABLEND,n.PBRMATERIAL_ALPHATESTANDBLEND=ye.PBRMATERIAL_ALPHATESTANDBLEND,n.DEFAULT_AO_ON_ANALYTICAL_LIGHTS=ye.DEFAULT_AO_ON_ANALYTICAL_LIGHTS,E([T(),N("_markAllSubMeshesAsTexturesDirty")],n.prototype,"directIntensity",void 0),E([T(),N("_markAllSubMeshesAsTexturesDirty")],n.prototype,"emissiveIntensity",void 0),E([T(),N("_markAllSubMeshesAsTexturesDirty")],n.prototype,"environmentIntensity",void 0),E([T(),N("_markAllSubMeshesAsTexturesDirty")],n.prototype,"specularIntensity",void 0),E([T(),N("_markAllSubMeshesAsTexturesDirty")],n.prototype,"disableBumpMap",void 0),E([de(),N("_markAllSubMeshesAsTexturesDirty")],n.prototype,"albedoTexture",void 0),E([de(),N("_markAllSubMeshesAsTexturesDirty")],n.prototype,"ambientTexture",void 0),E([T(),N("_markAllSubMeshesAsTexturesDirty")],n.prototype,"ambientTextureStrength",void 0),E([T(),N("_markAllSubMeshesAsTexturesDirty")],n.prototype,"ambientTextureImpactOnAnalyticalLights",void 0),E([de(),N("_markAllSubMeshesAsTexturesAndMiscDirty")],n.prototype,"opacityTexture",void 0),E([de(),N("_markAllSubMeshesAsTexturesDirty")],n.prototype,"reflectionTexture",void 0),E([de(),N("_markAllSubMeshesAsTexturesDirty")],n.prototype,"emissiveTexture",void 0),E([de(),N("_markAllSubMeshesAsTexturesDirty")],n.prototype,"reflectivityTexture",void 0),E([de(),N("_markAllSubMeshesAsTexturesDirty")],n.prototype,"metallicTexture",void 0),E([T(),N("_markAllSubMeshesAsTexturesDirty")],n.prototype,"metallic",void 0),E([T(),N("_markAllSubMeshesAsTexturesDirty")],n.prototype,"roughness",void 0),E([T(),N("_markAllSubMeshesAsTexturesDirty")],n.prototype,"metallicF0Factor",void 0),E([Ye(),N("_markAllSubMeshesAsTexturesDirty")],n.prototype,"metallicReflectanceColor",void 0),E([T(),N("_markAllSubMeshesAsTexturesDirty")],n.prototype,"useOnlyMetallicFromMetallicReflectanceTexture",void 0),E([de(),N("_markAllSubMeshesAsTexturesDirty")],n.prototype,"metallicReflectanceTexture",void 0),E([de(),N("_markAllSubMeshesAsTexturesDirty")],n.prototype,"reflectanceTexture",void 0),E([de(),N("_markAllSubMeshesAsTexturesDirty")],n.prototype,"microSurfaceTexture",void 0),E([de(),N("_markAllSubMeshesAsTexturesDirty")],n.prototype,"bumpTexture",void 0),E([de(),N("_markAllSubMeshesAsTexturesDirty",null)],n.prototype,"lightmapTexture",void 0),E([Ye("ambient"),N("_markAllSubMeshesAsTexturesDirty")],n.prototype,"ambientColor",void 0),E([Ye("albedo"),N("_markAllSubMeshesAsTexturesDirty")],n.prototype,"albedoColor",void 0),E([Ye("reflectivity"),N("_markAllSubMeshesAsTexturesDirty")],n.prototype,"reflectivityColor",void 0),E([Ye("reflection"),N("_markAllSubMeshesAsTexturesDirty")],n.prototype,"reflectionColor",void 0),E([Ye("emissive"),N("_markAllSubMeshesAsTexturesDirty")],n.prototype,"emissiveColor",void 0),E([T(),N("_markAllSubMeshesAsTexturesDirty")],n.prototype,"microSurface",void 0),E([T(),N("_markAllSubMeshesAsTexturesDirty")],n.prototype,"useLightmapAsShadowmap",void 0),E([T(),N("_markAllSubMeshesAsTexturesAndMiscDirty")],n.prototype,"useAlphaFromAlbedoTexture",void 0),E([T(),N("_markAllSubMeshesAsTexturesAndMiscDirty")],n.prototype,"forceAlphaTest",void 0),E([T(),N("_markAllSubMeshesAsTexturesAndMiscDirty")],n.prototype,"alphaCutOff",void 0),E([T(),N("_markAllSubMeshesAsTexturesDirty")],n.prototype,"useSpecularOverAlpha",void 0),E([T(),N("_markAllSubMeshesAsTexturesDirty")],n.prototype,"useMicroSurfaceFromReflectivityMapAlpha",void 0),E([T(),N("_markAllSubMeshesAsTexturesDirty")],n.prototype,"useRoughnessFromMetallicTextureAlpha",void 0),E([T(),N("_markAllSubMeshesAsTexturesDirty")],n.prototype,"useRoughnessFromMetallicTextureGreen",void 0),E([T(),N("_markAllSubMeshesAsTexturesDirty")],n.prototype,"useMetallnessFromMetallicTextureBlue",void 0),E([T(),N("_markAllSubMeshesAsTexturesDirty")],n.prototype,"useAmbientOcclusionFromMetallicTextureRed",void 0),E([T(),N("_markAllSubMeshesAsTexturesDirty")],n.prototype,"useAmbientInGrayScale",void 0),E([T(),N("_markAllSubMeshesAsTexturesDirty")],n.prototype,"useAutoMicroSurfaceFromReflectivityMap",void 0),E([T()],n.prototype,"usePhysicalLightFalloff",null),E([T()],n.prototype,"useGLTFLightFalloff",null),E([T(),N("_markAllSubMeshesAsTexturesDirty")],n.prototype,"useRadianceOverAlpha",void 0),E([T(),N("_markAllSubMeshesAsTexturesDirty")],n.prototype,"useObjectSpaceNormalMap",void 0),E([T(),N("_markAllSubMeshesAsTexturesDirty")],n.prototype,"useParallax",void 0),E([T(),N("_markAllSubMeshesAsTexturesDirty")],n.prototype,"useParallaxOcclusion",void 0),E([T(),N("_markAllSubMeshesAsTexturesDirty")],n.prototype,"parallaxScaleBias",void 0),E([T(),N("_markAllSubMeshesAsLightsDirty")],n.prototype,"disableLighting",void 0),E([T(),N("_markAllSubMeshesAsTexturesDirty")],n.prototype,"forceIrradianceInFragment",void 0),E([T(),N("_markAllSubMeshesAsLightsDirty")],n.prototype,"maxSimultaneousLights",void 0),E([T(),N("_markAllSubMeshesAsTexturesDirty")],n.prototype,"invertNormalMapX",void 0),E([T(),N("_markAllSubMeshesAsTexturesDirty")],n.prototype,"invertNormalMapY",void 0),E([T(),N("_markAllSubMeshesAsTexturesDirty")],n.prototype,"twoSidedLighting",void 0),E([T(),N("_markAllSubMeshesAsTexturesDirty")],n.prototype,"useAlphaFresnel",void 0),E([T(),N("_markAllSubMeshesAsTexturesDirty")],n.prototype,"useLinearAlphaFresnel",void 0),E([N("_markAllSubMeshesAsTexturesDirty")],n.prototype,"environmentBRDFTexture",void 0),E([T(),N("_markAllSubMeshesAsTexturesDirty")],n.prototype,"forceNormalForward",void 0),E([T(),N("_markAllSubMeshesAsTexturesDirty")],n.prototype,"enableSpecularAntiAliasing",void 0),E([T(),N("_markAllSubMeshesAsTexturesDirty")],n.prototype,"useHorizonOcclusion",void 0),E([T(),N("_markAllSubMeshesAsTexturesDirty")],n.prototype,"useRadianceOcclusion",void 0),E([T(),N("_markAllSubMeshesAsMiscDirty")],n.prototype,"unlit",void 0),n}(ye);P("BABYLON.PBRMaterial",me);var V=function(){function r(){}return r.Get=function(n,e,t){if(!e||t==null||!e[t])throw new Error("".concat(n,": Failed to find index (").concat(t,")"));return e[t]},r.Assign=function(n){if(n)for(var e=0;e<n.length;e++)n[e].index=e},r}(),W=function(){function r(n){this._completePromises=new Array,this._assetContainer=null,this._babylonLights=[],this._disableInstancedMesh=0,this._extensions=new Array,this._disposed=!1,this._rootUrl=null,this._fileName=null,this._uniqueRootUrl=null,this._bin=null,this._rootBabylonMesh=null,this._defaultBabylonMaterialData={},this._postSceneLoadActions=new Array,this._parent=n}return r.RegisterExtension=function(n,e){r.UnregisterExtension(n)&&ne.Warn("Extension with the name '".concat(n,"' already exists")),r._RegisteredExtensions[n]={factory:e}},r.UnregisterExtension=function(n){return r._RegisteredExtensions[n]?(delete r._RegisteredExtensions[n],!0):!1},Object.defineProperty(r.prototype,"gltf",{get:function(){if(!this._gltf)throw new Error("glTF JSON is not available");return this._gltf},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"bin",{get:function(){return this._bin},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"parent",{get:function(){return this._parent},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"babylonScene",{get:function(){if(!this._babylonScene)throw new Error("Scene is not available");return this._babylonScene},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"rootBabylonMesh",{get:function(){return this._rootBabylonMesh},enumerable:!1,configurable:!0}),r.prototype.dispose=function(){this._disposed||(this._disposed=!0,this._completePromises.length=0,this._extensions.forEach(function(n){return n.dispose&&n.dispose()}),this._extensions.length=0,this._gltf=null,this._bin=null,this._babylonScene=null,this._rootBabylonMesh=null,this._defaultBabylonMaterialData={},this._postSceneLoadActions.length=0,this._parent.dispose())},r.prototype.importMeshAsync=function(n,e,t,i,o,a,s){var c=this;return s===void 0&&(s=""),Promise.resolve().then(function(){c._babylonScene=e,c._assetContainer=t,c._loadData(i);var l=null;if(n){var u={};if(c._gltf.nodes)for(var f=0,d=c._gltf.nodes;f<d.length;f++){var p=d[f];p.name&&(u[p.name]=p.index)}var m=n instanceof Array?n:[n];l=m.map(function(_){var v=u[_];if(v===void 0)throw new Error("Failed to find node '".concat(_,"'"));return v})}return c._loadAsync(o,s,l,function(){return{meshes:c._getMeshes(),particleSystems:[],skeletons:c._getSkeletons(),animationGroups:c._getAnimationGroups(),lights:c._babylonLights,transformNodes:c._getTransformNodes(),geometries:c._getGeometries()}})})},r.prototype.loadAsync=function(n,e,t,i,o){var a=this;return o===void 0&&(o=""),Promise.resolve().then(function(){return a._babylonScene=n,a._loadData(e),a._loadAsync(t,o,null,function(){})})},r.prototype._loadAsync=function(n,e,t,i){var o=this;return Promise.resolve().then(function(){o._rootUrl=n,o._uniqueRootUrl=!Ke.StartsWith(n,"file:")&&e?n:"".concat(n).concat(Date.now(),"/"),o._fileName=e,o._loadExtensions(),o._checkExtensions();var a="".concat(De[De.LOADING]," => ").concat(De[De.READY]),s="".concat(De[De.LOADING]," => ").concat(De[De.COMPLETE]);o._parent._startPerformanceCounter(a),o._parent._startPerformanceCounter(s),o._parent._setState(De.LOADING),o._extensionsOnLoading();var c=new Array,l=o._babylonScene.blockMaterialDirtyMechanism;if(o._babylonScene.blockMaterialDirtyMechanism=!0,!o.parent.loadOnlyMaterials){if(t)c.push(o.loadSceneAsync("/nodes",{nodes:t,index:-1}));else if(o._gltf.scene!=null||o._gltf.scenes&&o._gltf.scenes[0]){var u=V.Get("/scene",o._gltf.scenes,o._gltf.scene||0);c.push(o.loadSceneAsync("/scenes/".concat(u.index),u))}}if(!o.parent.skipMaterials&&o.parent.loadAllMaterials&&o._gltf.materials)for(var f=0;f<o._gltf.materials.length;++f){var d=o._gltf.materials[f],p="/materials/"+f,m=Ee.TriangleFillMode;c.push(o._loadMaterialAsync(p,d,null,m,function(){}))}o._babylonScene.blockMaterialDirtyMechanism=l,o._parent.compileMaterials&&c.push(o._compileMaterialsAsync()),o._parent.compileShadowGenerators&&c.push(o._compileShadowGeneratorsAsync());var _=Promise.all(c).then(function(){return o._rootBabylonMesh&&o._rootBabylonMesh.setEnabled(!0),o._extensionsOnReady(),o._parent._setState(De.READY),o._startAnimations(),i()});return _.then(function(v){return o._parent._endPerformanceCounter(a),z.SetImmediate(function(){o._disposed||Promise.all(o._completePromises).then(function(){o._parent._endPerformanceCounter(s),o._parent._setState(De.COMPLETE),o._parent.onCompleteObservable.notifyObservers(void 0),o._parent.onCompleteObservable.clear(),o.dispose()},function(b){o._parent.onErrorObservable.notifyObservers(b),o._parent.onErrorObservable.clear(),o.dispose()})}),v})}).catch(function(a){throw o._disposed||(o._parent.onErrorObservable.notifyObservers(a),o._parent.onErrorObservable.clear(),o.dispose()),a})},r.prototype._loadData=function(n){if(this._gltf=n.json,this._setupData(),n.bin){var e=this._gltf.buffers;if(e&&e[0]&&!e[0].uri){var t=e[0];(t.byteLength<n.bin.byteLength-3||t.byteLength>n.bin.byteLength)&&ne.Warn("Binary buffer length (".concat(t.byteLength,") from JSON does not match chunk length (").concat(n.bin.byteLength,")")),this._bin=n.bin}else ne.Warn("Unexpected BIN chunk")}},r.prototype._setupData=function(){if(V.Assign(this._gltf.accessors),V.Assign(this._gltf.animations),V.Assign(this._gltf.buffers),V.Assign(this._gltf.bufferViews),V.Assign(this._gltf.cameras),V.Assign(this._gltf.images),V.Assign(this._gltf.materials),V.Assign(this._gltf.meshes),V.Assign(this._gltf.nodes),V.Assign(this._gltf.samplers),V.Assign(this._gltf.scenes),V.Assign(this._gltf.skins),V.Assign(this._gltf.textures),this._gltf.nodes){for(var n={},e=0,t=this._gltf.nodes;e<t.length;e++){var i=t[e];if(i.children)for(var o=0,a=i.children;o<a.length;o++){var s=a[o];n[s]=i.index}}for(var c=this._createRootNode(),l=0,u=this._gltf.nodes;l<u.length;l++){var i=u[l],f=n[i.index];i.parent=f===void 0?c:this._gltf.nodes[f]}}},r.prototype._loadExtensions=function(){for(var n in r._RegisteredExtensions){var e=r._RegisteredExtensions[n].factory(this);e.name!==n&&ne.Warn("The name of the glTF loader extension instance does not match the registered name: ".concat(e.name," !== ").concat(n)),this._extensions.push(e),this._parent.onExtensionLoadedObservable.notifyObservers(e)}this._extensions.sort(function(t,i){return(t.order||Number.MAX_VALUE)-(i.order||Number.MAX_VALUE)}),this._parent.onExtensionLoadedObservable.clear()},r.prototype._checkExtensions=function(){if(this._gltf.extensionsRequired)for(var n=function(a){var s=e._extensions.some(function(c){return c.name===a&&c.enabled});if(!s)throw new Error("Require extension ".concat(a," is not available"))},e=this,t=0,i=this._gltf.extensionsRequired;t<i.length;t++){var o=i[t];n(o)}},r.prototype._createRootNode=function(){this._babylonScene._blockEntityCollection=!!this._assetContainer,this._rootBabylonMesh=new he("__root__",this._babylonScene),this._rootBabylonMesh._parentContainer=this._assetContainer,this._babylonScene._blockEntityCollection=!1,this._rootBabylonMesh.setEnabled(!1);var n={_babylonTransformNode:this._rootBabylonMesh,index:-1};switch(this._parent.coordinateSystemMode){case Gt.AUTO:{this._babylonScene.useRightHandedSystem||(n.rotation=[0,1,0,0],n.scale=[1,1,-1],r._LoadTransform(n,this._rootBabylonMesh));break}case Gt.FORCE_RIGHT_HANDED:{this._babylonScene.useRightHandedSystem=!0;break}default:throw new Error("Invalid coordinate system mode (".concat(this._parent.coordinateSystemMode,")"))}return this._parent.onMeshLoadedObservable.notifyObservers(this._rootBabylonMesh),n},r.prototype.loadSceneAsync=function(n,e){var t=this,i=this._extensionsLoadSceneAsync(n,e);if(i)return i;var o=new Array;if(this.logOpen("".concat(n," ").concat(e.name||"")),e.nodes)for(var a=0,s=e.nodes;a<s.length;a++){var c=s[a],l=V.Get("".concat(n,"/nodes/").concat(c),this._gltf.nodes,c);o.push(this.loadNodeAsync("/nodes/".concat(l.index),l,function(p){p.parent=t._rootBabylonMesh}))}for(var u=0,f=this._postSceneLoadActions;u<f.length;u++){var d=f[u];d()}return o.push(this._loadAnimationsAsync()),this.logClose(),Promise.all(o).then(function(){})},r.prototype._forEachPrimitive=function(n,e){if(n._primitiveBabylonMeshes)for(var t=0,i=n._primitiveBabylonMeshes;t<i.length;t++){var o=i[t];e(o)}},r.prototype._getGeometries=function(){var n=new Array,e=this._gltf.nodes;if(e)for(var t=0,i=e;t<i.length;t++){var o=i[t];this._forEachPrimitive(o,function(a){var s=a.geometry;s&&n.indexOf(s)===-1&&n.push(s)})}return n},r.prototype._getMeshes=function(){var n=new Array;this._rootBabylonMesh&&n.push(this._rootBabylonMesh);var e=this._gltf.nodes;if(e)for(var t=0,i=e;t<i.length;t++){var o=i[t];this._forEachPrimitive(o,function(a){n.push(a)})}return n},r.prototype._getTransformNodes=function(){var n=new Array,e=this._gltf.nodes;if(e)for(var t=0,i=e;t<i.length;t++){var o=i[t];o._babylonTransformNode&&o._babylonTransformNode.getClassName()==="TransformNode"&&n.push(o._babylonTransformNode),o._babylonTransformNodeForSkin&&n.push(o._babylonTransformNodeForSkin)}return n},r.prototype._getSkeletons=function(){var n=new Array,e=this._gltf.skins;if(e)for(var t=0,i=e;t<i.length;t++){var o=i[t];o._data&&n.push(o._data.babylonSkeleton)}return n},r.prototype._getAnimationGroups=function(){var n=new Array,e=this._gltf.animations;if(e)for(var t=0,i=e;t<i.length;t++){var o=i[t];o._babylonAnimationGroup&&n.push(o._babylonAnimationGroup)}return n},r.prototype._startAnimations=function(){switch(this._parent.animationStartMode){case Ot.NONE:break;case Ot.FIRST:{var n=this._getAnimationGroups();n.length!==0&&n[0].start(!0);break}case Ot.ALL:{for(var n=this._getAnimationGroups(),e=0,t=n;e<t.length;e++){var i=t[e];i.start(!0)}break}default:{ne.Error("Invalid animation start mode (".concat(this._parent.animationStartMode,")"));return}}},r.prototype.loadNodeAsync=function(n,e,t){var i=this;t===void 0&&(t=function(){});var o=this._extensionsLoadNodeAsync(n,e,t);if(o)return o;if(e._babylonTransformNode)throw new Error("".concat(n,": Invalid recursive node hierarchy"));var a=new Array;this.logOpen("".concat(n," ").concat(e.name||""));var s=function(f){if(r.AddPointerMetadata(f,n),r._LoadTransform(e,f),e.camera!=null){var d=V.Get("".concat(n,"/camera"),i._gltf.cameras,e.camera);a.push(i.loadCameraAsync("/cameras/".concat(d.index),d,function(b){b.parent=f}))}if(e.children)for(var p=0,m=e.children;p<m.length;p++){var _=m[p],v=V.Get("".concat(n,"/children/").concat(_),i._gltf.nodes,_);a.push(i.loadNodeAsync("/nodes/".concat(v.index),v,function(b){b.parent=f}))}t(f)};if(e.mesh==null||e.skin!=null){var c=e.name||"node".concat(e.index);this._babylonScene._blockEntityCollection=!!this._assetContainer;var l=new wi(c,this._babylonScene);l._parentContainer=this._assetContainer,this._babylonScene._blockEntityCollection=!1,e.mesh==null?e._babylonTransformNode=l:e._babylonTransformNodeForSkin=l,s(l)}if(e.mesh!=null)if(e.skin==null){var u=V.Get("".concat(n,"/mesh"),this._gltf.meshes,e.mesh);a.push(this._loadMeshAsync("/meshes/".concat(u.index),e,u,s))}else{var u=V.Get("".concat(n,"/mesh"),this._gltf.meshes,e.mesh);a.push(this._loadMeshAsync("/meshes/".concat(u.index),e,u,function(d){d.metadata=e._babylonTransformNodeForSkin.metadata;var p=V.Get("".concat(n,"/skin"),i._gltf.skins,e.skin);a.push(i._loadSkinAsync("/skins/".concat(p.index),e,p,function(m){i._forEachPrimitive(e,function(_){_.skeleton=m}),i._postSceneLoadActions.push(function(){if(p.skeleton!=null){var _=V.Get("/skins/".concat(p.index,"/skeleton"),i._gltf.nodes,p.skeleton);d.parent=_.parent._babylonTransformNode}else d.parent=i._rootBabylonMesh})}))}))}return this.logClose(),Promise.all(a).then(function(){return i._forEachPrimitive(e,function(f){f.geometry&&f.geometry.useBoundingInfoFromGeometry?f._updateBoundingInfo():f.refreshBoundingInfo(!0)}),e._babylonTransformNode})},r.prototype._loadMeshAsync=function(n,e,t,i){var o=t.primitives;if(!o||!o.length)throw new Error("".concat(n,": Primitives are missing"));o[0].index==null&&V.Assign(o);var a=new Array;this.logOpen("".concat(n," ").concat(t.name||""));var s=e.name||"node".concat(e.index);if(o.length===1){var c=t.primitives[0];a.push(this._loadMeshPrimitiveAsync("".concat(n,"/primitives/").concat(c.index),s,e,t,c,function(f){e._babylonTransformNode=f,e._primitiveBabylonMeshes=[f]}))}else{this._babylonScene._blockEntityCollection=!!this._assetContainer,e._babylonTransformNode=new wi(s,this._babylonScene),e._babylonTransformNode._parentContainer=this._assetContainer,this._babylonScene._blockEntityCollection=!1,e._primitiveBabylonMeshes=[];for(var l=0,u=o;l<u.length;l++){var c=u[l];a.push(this._loadMeshPrimitiveAsync("".concat(n,"/primitives/").concat(c.index),"".concat(s,"_primitive").concat(c.index),e,t,c,function(d){d.parent=e._babylonTransformNode,e._primitiveBabylonMeshes.push(d)}))}}return i(e._babylonTransformNode),this.logClose(),Promise.all(a).then(function(){return e._babylonTransformNode})},r.prototype._loadMeshPrimitiveAsync=function(n,e,t,i,o,a){var s=this,c=this._extensionsLoadMeshPrimitiveAsync(n,e,t,i,o,a);if(c)return c;this.logOpen("".concat(n));var l=this._disableInstancedMesh===0&&this._parent.createInstances&&t.skin==null&&!i.primitives[0].targets,u,f;if(l&&o._instanceData)this._babylonScene._blockEntityCollection=!!this._assetContainer,u=o._instanceData.babylonSourceMesh.createInstance(e),u._parentContainer=this._assetContainer,this._babylonScene._blockEntityCollection=!1,f=o._instanceData.promise;else{var d=new Array;this._babylonScene._blockEntityCollection=!!this._assetContainer;var p=new he(e,this._babylonScene);p._parentContainer=this._assetContainer,this._babylonScene._blockEntityCollection=!1,p.overrideMaterialSideOrientation=this._babylonScene.useRightHandedSystem?Ee.CounterClockWiseSideOrientation:Ee.ClockWiseSideOrientation,this._createMorphTargets(n,t,i,o,p),d.push(this._loadVertexDataAsync(n,o,p).then(function(b){return s._loadMorphTargetsAsync(n,o,p,b).then(function(){s._babylonScene._blockEntityCollection=!!s._assetContainer,b.applyToMesh(p),b._parentContainer=s._assetContainer,s._babylonScene._blockEntityCollection=!1})}));var m=r._GetDrawMode(n,o.mode);if(o.material==null){var _=this._defaultBabylonMaterialData[m];_||(_=this._createDefaultMaterial("__GLTFLoader._default",m),this._parent.onMaterialLoadedObservable.notifyObservers(_),this._defaultBabylonMaterialData[m]=_),p.material=_}else if(!this.parent.skipMaterials){var v=V.Get("".concat(n,"/material"),this._gltf.materials,o.material);d.push(this._loadMaterialAsync("/materials/".concat(v.index),v,p,m,function(b){p.material=b}))}f=Promise.all(d),l&&(o._instanceData={babylonSourceMesh:p,promise:f}),u=p}return r.AddPointerMetadata(u,n),this._parent.onMeshLoadedObservable.notifyObservers(u),a(u),this.logClose(),f.then(function(){return u})},r.prototype._loadVertexDataAsync=function(n,e,t){var i=this,o=this._extensionsLoadVertexDataAsync(n,e,t);if(o)return o;var a=e.attributes;if(!a)throw new Error("".concat(n,": Attributes are missing"));var s=new Array,c=new Ei(t.name,this._babylonScene);if(e.indices==null)t.isUnIndexed=!0;else{var l=V.Get("".concat(n,"/indices"),this._gltf.accessors,e.indices);s.push(this._loadIndicesAccessorAsync("/accessors/".concat(l.index),l).then(function(f){c.setIndices(f)}))}var u=function(f,d,p){if(a[f]!=null){t._delayInfo=t._delayInfo||[],t._delayInfo.indexOf(d)===-1&&t._delayInfo.push(d);var m=V.Get("".concat(n,"/attributes/").concat(f),i._gltf.accessors,a[f]);s.push(i._loadVertexAccessorAsync("/accessors/".concat(m.index),m,d).then(function(_){if(_.getKind()===w.PositionKind&&!i.parent.alwaysComputeBoundingBox&&!t.skeleton){var v=m.min,b=m.max;if(v!==void 0&&b!==void 0){if(m.normalized&&m.componentType!==5126){var A=1;switch(m.componentType){case 5120:A=127;break;case 5121:A=255;break;case 5122:A=32767;break;case 5123:A=65535;break}for(var S=0;S<3;++S)v[S]=Math.max(v[S]/A,-1),b[S]=Math.max(b[S]/A,-1)}var C=H.Vector3[0],O=H.Vector3[1];C.copyFromFloats.apply(C,v),O.copyFromFloats.apply(O,b),c._boundingInfo=new yo(C,O),c.useBoundingInfoFromGeometry=!0}}c.setVerticesBuffer(_,m.count)})),d==w.MatricesIndicesExtraKind&&(t.numBoneInfluencers=8),p&&p(m)}};return u("POSITION",w.PositionKind),u("NORMAL",w.NormalKind),u("TANGENT",w.TangentKind),u("TEXCOORD_0",w.UVKind),u("TEXCOORD_1",w.UV2Kind),u("TEXCOORD_2",w.UV3Kind),u("TEXCOORD_3",w.UV4Kind),u("TEXCOORD_4",w.UV5Kind),u("TEXCOORD_5",w.UV6Kind),u("JOINTS_0",w.MatricesIndicesKind),u("WEIGHTS_0",w.MatricesWeightsKind),u("JOINTS_1",w.MatricesIndicesExtraKind),u("WEIGHTS_1",w.MatricesWeightsExtraKind),u("COLOR_0",w.ColorKind,function(f){f.type==="VEC4"&&(t.hasVertexAlpha=!0)}),Promise.all(s).then(function(){return c})},r.prototype._createMorphTargets=function(n,e,t,i,o){if(!!i.targets){if(e._numMorphTargets==null)e._numMorphTargets=i.targets.length;else if(i.targets.length!==e._numMorphTargets)throw new Error("".concat(n,": Primitives do not have the same number of targets"));var a=t.extras?t.extras.targetNames:null;o.morphTargetManager=new vo(o.getScene()),o.morphTargetManager.areUpdatesFrozen=!0;for(var s=0;s<i.targets.length;s++){var c=e.weights?e.weights[s]:t.weights?t.weights[s]:0,l=a?a[s]:"morphTarget".concat(s);o.morphTargetManager.addTarget(new Eo(l,c,o.getScene()))}}},r.prototype._loadMorphTargetsAsync=function(n,e,t,i){if(!e.targets)return Promise.resolve();for(var o=new Array,a=t.morphTargetManager,s=0;s<a.numTargets;s++){var c=a.getTarget(s);o.push(this._loadMorphTargetVertexDataAsync("".concat(n,"/targets/").concat(s),i,e.targets[s],c))}return Promise.all(o).then(function(){a.areUpdatesFrozen=!1})},r.prototype._loadMorphTargetVertexDataAsync=function(n,e,t,i){var o=this,a=new Array,s=function(c,l,u){if(t[c]!=null){var f=e.getVertexBuffer(l);if(!!f){var d=V.Get("".concat(n,"/").concat(c),o._gltf.accessors,t[c]);a.push(o._loadFloatAccessorAsync("/accessors/".concat(d.index),d).then(function(p){u(f,p)}))}}};return s("POSITION",w.PositionKind,function(c,l){var u=new Float32Array(l.length);c.forEach(l.length,function(f,d){u[d]=l[d]+f}),i.setPositions(u)}),s("NORMAL",w.NormalKind,function(c,l){var u=new Float32Array(l.length);c.forEach(u.length,function(f,d){u[d]=l[d]+f}),i.setNormals(u)}),s("TANGENT",w.TangentKind,function(c,l){var u=new Float32Array(l.length/3*4),f=0;c.forEach(l.length/3*4,function(d,p){(p+1)%4!==0&&(u[f]=l[f]+d,f++)}),i.setTangents(u)}),Promise.all(a).then(function(){})},r._LoadTransform=function(n,e){if(n.skin==null){var t=y.Zero(),i=q.Identity(),o=y.One();if(n.matrix){var a=Q.FromArray(n.matrix);a.decompose(o,i,t)}else n.translation&&(t=y.FromArray(n.translation)),n.rotation&&(i=q.FromArray(n.rotation)),n.scale&&(o=y.FromArray(n.scale));e.position=t,e.rotationQuaternion=i,e.scaling=o}},r.prototype._loadSkinAsync=function(n,e,t,i){var o=this,a=this._extensionsLoadSkinAsync(n,e,t);if(a)return a;if(t._data)return i(t._data.babylonSkeleton),t._data.promise;var s="skeleton".concat(t.index);this._babylonScene._blockEntityCollection=!!this._assetContainer;var c=new vi(t.name||s,s,this._babylonScene);c._parentContainer=this._assetContainer,this._babylonScene._blockEntityCollection=!1,this._loadBones(n,t,c);var l=this._loadSkinInverseBindMatricesDataAsync(n,t).then(function(u){o._updateBoneMatrices(c,u)});return t._data={babylonSkeleton:c,promise:l},i(c),l},r.prototype._loadBones=function(n,e,t){if(e.skeleton==null||this._parent.alwaysComputeSkeletonRootNode){var i=this._findSkeletonRootNode("".concat(n,"/joints"),e.joints);if(i)if(e.skeleton===void 0)e.skeleton=i.index;else{var o=function(d,p){for(;p.parent;p=p.parent)if(p.parent===d)return!0;return!1},a=V.Get("".concat(n,"/skeleton"),this._gltf.nodes,e.skeleton);a!==i&&!o(a,i)&&(ne.Warn("".concat(n,"/skeleton: Overriding with nearest common ancestor as skeleton node is not a common root")),e.skeleton=i.index)}else ne.Warn("".concat(n,": Failed to find common root"))}for(var s={},c=0,l=e.joints;c<l.length;c++){var u=l[c],f=V.Get("".concat(n,"/joints/").concat(u),this._gltf.nodes,u);this._loadBone(f,e,t,s)}},r.prototype._findSkeletonRootNode=function(n,e){if(e.length===0)return null;for(var t={},i=0,o=e;i<o.length;i++){for(var a=o[i],s=new Array,c=V.Get("".concat(n,"/").concat(a),this._gltf.nodes,a);c.index!==-1;)s.unshift(c),c=c.parent;t[a]=s}for(var l=null,u=0;;++u){var s=t[e[0]];if(u>=s.length)return l;for(var c=s[u],f=1;f<e.length;++f)if(s=t[e[f]],u>=s.length||c!==s[u])return l;l=c}},r.prototype._loadBone=function(n,e,t,i){var o=i[n.index];if(o)return o;var a=null;n.index!==e.skeleton&&(n.parent&&n.parent.index!==-1?a=this._loadBone(n.parent,e,t,i):e.skeleton!==void 0&&ne.Warn("/skins/".concat(e.index,"/skeleton: Skeleton node is not a common root")));var s=e.joints.indexOf(n.index);return o=new Pt(n.name||"joint".concat(n.index),t,a,this._getNodeMatrix(n),null,null,s),i[n.index]=o,this._postSceneLoadActions.push(function(){o.linkTransformNode(n._babylonTransformNode)}),o},r.prototype._loadSkinInverseBindMatricesDataAsync=function(n,e){if(e.inverseBindMatrices==null)return Promise.resolve(null);var t=V.Get("".concat(n,"/inverseBindMatrices"),this._gltf.accessors,e.inverseBindMatrices);return this._loadFloatAccessorAsync("/accessors/".concat(t.index),t)},r.prototype._updateBoneMatrices=function(n,e){for(var t=0,i=n.bones;t<i.length;t++){var o=i[t],a=Q.Identity(),s=o._index;e&&s!==-1&&(Q.FromArrayToRef(e,s*16,a),a.invertToRef(a));var c=o.getParent();c&&a.multiplyToRef(c.getInvertedAbsoluteTransform(),a),o.updateMatrix(a,!1,!1),o._updateDifferenceMatrix(void 0,!1)}},r.prototype._getNodeMatrix=function(n){return n.matrix?Q.FromArray(n.matrix):Q.Compose(n.scale?y.FromArray(n.scale):y.One(),n.rotation?q.FromArray(n.rotation):q.Identity(),n.translation?y.FromArray(n.translation):y.Zero())},r.prototype.loadCameraAsync=function(n,e,t){t===void 0&&(t=function(){});var i=this._extensionsLoadCameraAsync(n,e,t);if(i)return i;var o=new Array;this.logOpen("".concat(n," ").concat(e.name||"")),this._babylonScene._blockEntityCollection=!!this._assetContainer;var a=new Ut(e.name||"camera".concat(e.index),y.Zero(),this._babylonScene,!1);switch(a._parentContainer=this._assetContainer,this._babylonScene._blockEntityCollection=!1,a.ignoreParentScaling=!0,a.rotation=new y(0,Math.PI,0),e.type){case"perspective":{var s=e.perspective;if(!s)throw new Error("".concat(n,": Camera perspective properties are missing"));a.fov=s.yfov,a.minZ=s.znear,a.maxZ=s.zfar||0;break}case"orthographic":{if(!e.orthographic)throw new Error("".concat(n,": Camera orthographic properties are missing"));a.mode=sn.ORTHOGRAPHIC_CAMERA,a.orthoLeft=-e.orthographic.xmag,a.orthoRight=e.orthographic.xmag,a.orthoBottom=-e.orthographic.ymag,a.orthoTop=e.orthographic.ymag,a.minZ=e.orthographic.znear,a.maxZ=e.orthographic.zfar;break}default:throw new Error("".concat(n,": Invalid camera type (").concat(e.type,")"))}return r.AddPointerMetadata(a,n),this._parent.onCameraLoadedObservable.notifyObservers(a),t(a),this.logClose(),Promise.all(o).then(function(){return a})},r.prototype._loadAnimationsAsync=function(){var n=this._gltf.animations;if(!n)return Promise.resolve();for(var e=new Array,t=0;t<n.length;t++){var i=n[t];e.push(this.loadAnimationAsync("/animations/".concat(i.index),i).then(function(o){o.targetedAnimations.length===0&&o.dispose()}))}return Promise.all(e).then(function(){})},r.prototype.loadAnimationAsync=function(n,e){var t=this._extensionsLoadAnimationAsync(n,e);if(t)return t;this._babylonScene._blockEntityCollection=!!this._assetContainer;var i=new Da(e.name||"animation".concat(e.index),this._babylonScene);i._parentContainer=this._assetContainer,this._babylonScene._blockEntityCollection=!1,e._babylonAnimationGroup=i;var o=new Array;V.Assign(e.channels),V.Assign(e.samplers);for(var a=0,s=e.channels;a<s.length;a++){var c=s[a];o.push(this._loadAnimationChannelAsync("".concat(n,"/channels/").concat(c.index),n,e,c,i))}return Promise.all(o).then(function(){return i.normalize(0),i})},r.prototype._loadAnimationChannelAsync=function(n,e,t,i,o,a){var s=this;if(a===void 0&&(a=null),i.target.node==null)return Promise.resolve();var c=V.Get("".concat(n,"/target/node"),this._gltf.nodes,i.target.node);if(i.target.path==="weights"&&!c._numMorphTargets||i.target.path!=="weights"&&!c._babylonTransformNode)return Promise.resolve();var l=V.Get("".concat(n,"/sampler"),t.samplers,i.sampler);return this._loadAnimationSamplerAsync("".concat(e,"/samplers/").concat(i.sampler),l).then(function(u){var f,d;switch(i.target.path){case"translation":{f="position",d=J.ANIMATIONTYPE_VECTOR3;break}case"rotation":{f="rotationQuaternion",d=J.ANIMATIONTYPE_QUATERNION;break}case"scale":{f="scaling",d=J.ANIMATIONTYPE_VECTOR3;break}case"weights":{f="influence",d=J.ANIMATIONTYPE_FLOAT;break}default:throw new Error("".concat(n,"/target/path: Invalid value (").concat(i.target.path,")"))}var p=0,m;switch(f){case"position":{m=function(k){var D=y.FromArray(u.output,p).scaleInPlace(k);return p+=3,D};break}case"rotationQuaternion":{m=function(k){var D=q.FromArray(u.output,p).scaleInPlace(k);return p+=4,D};break}case"scaling":{m=function(k){var D=y.FromArray(u.output,p).scaleInPlace(k);return p+=3,D};break}case"influence":{m=function(k){for(var D=new Array(c._numMorphTargets),Z=0;Z<c._numMorphTargets;Z++)D[Z]=u.output[p++]*k;return D};break}}var _;switch(u.interpolation){case"STEP":{_=function(k){return{frame:u.input[k]*s.parent.targetFps,value:m(1),interpolation:Co.STEP}};break}case"LINEAR":{_=function(k){return{frame:u.input[k]*s.parent.targetFps,value:m(1)}};break}case"CUBICSPLINE":{var v=1/s.parent.targetFps;_=function(k){return{frame:u.input[k]*s.parent.targetFps,inTangent:m(v),value:m(1),outTangent:m(v)}};break}}for(var b=new Array(u.input.length),A=0;A<u.input.length;A++)b[A]=_(A);if(f==="influence")for(var S=function(k){var D="".concat(o.name,"_channel").concat(o.targetedAnimations.length),Z=new J(D,f,s.parent.targetFps,d);Z.setKeys(b.map(function($){return{frame:$.frame,inTangent:$.inTangent?$.inTangent[k]:void 0,value:$.value[k],outTangent:$.outTangent?$.outTangent[k]:void 0}})),s._forEachPrimitive(c,function($){var I=$,ue=I.morphTargetManager.getTarget(k),ge=Z.clone();ue.animations.push(ge),o.addTargetedAnimation(ge,ue)})},C=0;C<c._numMorphTargets;C++)S(C);else{var O="".concat(o.name,"_channel").concat(o.targetedAnimations.length),B=new J(O,f,s.parent.targetFps,d);B.setKeys(b),a!=null&&a.animations!=null?(a.animations.push(B),o.addTargetedAnimation(B,a)):(c._babylonTransformNode.animations.push(B),o.addTargetedAnimation(B,c._babylonTransformNode))}})},r.prototype._loadAnimationSamplerAsync=function(n,e){if(e._data)return e._data;var t=e.interpolation||"LINEAR";switch(t){case"STEP":case"LINEAR":case"CUBICSPLINE":break;default:throw new Error("".concat(n,"/interpolation: Invalid value (").concat(e.interpolation,")"))}var i=V.Get("".concat(n,"/input"),this._gltf.accessors,e.input),o=V.Get("".concat(n,"/output"),this._gltf.accessors,e.output);return e._data=Promise.all([this._loadFloatAccessorAsync("/accessors/".concat(i.index),i),this._loadFloatAccessorAsync("/accessors/".concat(o.index),o)]).then(function(a){var s=a[0],c=a[1];return{input:s,interpolation:t,output:c}}),e._data},r.prototype.loadBufferAsync=function(n,e,t,i){var o=this._extensionsLoadBufferAsync(n,e,t,i);if(o)return o;if(!e._data)if(e.uri)e._data=this.loadUriAsync("".concat(n,"/uri"),e,e.uri);else{if(!this._bin)throw new Error("".concat(n,": Uri is missing or the binary glTF is missing its binary chunk"));e._data=this._bin.readAsync(0,e.byteLength)}return e._data.then(function(a){try{return new Uint8Array(a.buffer,a.byteOffset+t,i)}catch(s){throw new Error("".concat(n,": ").concat(s.message))}})},r.prototype.loadBufferViewAsync=function(n,e){var t=this._extensionsLoadBufferViewAsync(n,e);if(t)return t;if(e._data)return e._data;var i=V.Get("".concat(n,"/buffer"),this._gltf.buffers,e.buffer);return e._data=this.loadBufferAsync("/buffers/".concat(i.index),i,e.byteOffset||0,e.byteLength),e._data},r.prototype._loadAccessorAsync=function(n,e,t){var i=this;if(e._data)return e._data;var o=r._GetNumComponents(n,e.type),a=o*w.GetTypeByteLength(e.componentType),s=o*e.count;if(e.bufferView==null)e._data=Promise.resolve(new t(s));else{var c=V.Get("".concat(n,"/bufferView"),this._gltf.bufferViews,e.bufferView);e._data=this.loadBufferViewAsync("/bufferViews/".concat(c.index),c).then(function(u){if(e.componentType===5126&&!e.normalized&&(!c.byteStride||c.byteStride===a))return r._GetTypedArray(n,e.componentType,u,e.byteOffset,s);var f=new t(s);return w.ForEach(u,e.byteOffset||0,c.byteStride||a,o,e.componentType,f.length,e.normalized||!1,function(d,p){f[p]=d}),f})}if(e.sparse){var l=e.sparse;e._data=e._data.then(function(u){var f=u,d=V.Get("".concat(n,"/sparse/indices/bufferView"),i._gltf.bufferViews,l.indices.bufferView),p=V.Get("".concat(n,"/sparse/values/bufferView"),i._gltf.bufferViews,l.values.bufferView);return Promise.all([i.loadBufferViewAsync("/bufferViews/".concat(d.index),d),i.loadBufferViewAsync("/bufferViews/".concat(p.index),p)]).then(function(m){var _=m[0],v=m[1],b=r._GetTypedArray("".concat(n,"/sparse/indices"),l.indices.componentType,_,l.indices.byteOffset,l.count),A=o*l.count,S;if(e.componentType===5126&&!e.normalized)S=r._GetTypedArray("".concat(n,"/sparse/values"),e.componentType,v,l.values.byteOffset,A);else{var C=r._GetTypedArray("".concat(n,"/sparse/values"),e.componentType,v,l.values.byteOffset,A);S=new t(A),w.ForEach(C,0,a,o,e.componentType,S.length,e.normalized||!1,function(Z,$){S[$]=Z})}for(var O=0,B=0;B<b.length;B++)for(var k=b[B]*o,D=0;D<o;D++)f[k++]=S[O++];return f})})}return e._data},r.prototype._loadFloatAccessorAsync=function(n,e){return this._loadAccessorAsync(n,e,Float32Array)},r.prototype._loadIndicesAccessorAsync=function(n,e){if(e.type!=="SCALAR")throw new Error("".concat(n,"/type: Invalid value ").concat(e.type));if(e.componentType!==5121&&e.componentType!==5123&&e.componentType!==5125)throw new Error("".concat(n,"/componentType: Invalid value ").concat(e.componentType));if(e._data)return e._data;if(e.sparse){var t=r._GetTypedArrayConstructor("".concat(n,"/componentType"),e.componentType);e._data=this._loadAccessorAsync(n,e,t)}else{var i=V.Get("".concat(n,"/bufferView"),this._gltf.bufferViews,e.bufferView);e._data=this.loadBufferViewAsync("/bufferViews/".concat(i.index),i).then(function(o){return r._GetTypedArray(n,e.componentType,o,e.byteOffset,e.count)})}return e._data},r.prototype._loadVertexBufferViewAsync=function(n){var e=this;return n._babylonBuffer||(n._babylonBuffer=this.loadBufferViewAsync("/bufferViews/".concat(n.index),n).then(function(t){return new sr(e._babylonScene.getEngine(),t,!1)})),n._babylonBuffer},r.prototype._loadVertexAccessorAsync=function(n,e,t){var i=this,o;if(!((o=e._babylonVertexBuffer)===null||o===void 0)&&o[t])return e._babylonVertexBuffer[t];if(e._babylonVertexBuffer||(e._babylonVertexBuffer={}),e.sparse)e._babylonVertexBuffer[t]=this._loadFloatAccessorAsync(n,e).then(function(s){return new w(i._babylonScene.getEngine(),s,t,!1)});else if(t===w.MatricesIndicesKind||t===w.MatricesIndicesExtraKind)e._babylonVertexBuffer[t]=this._loadFloatAccessorAsync(n,e).then(function(s){return new w(i._babylonScene.getEngine(),s,t,!1)});else{var a=V.Get("".concat(n,"/bufferView"),this._gltf.bufferViews,e.bufferView);e._babylonVertexBuffer[t]=this._loadVertexBufferViewAsync(a).then(function(s){var c=r._GetNumComponents(n,e.type);return new w(i._babylonScene.getEngine(),s,t,!1,!1,a.byteStride,!1,e.byteOffset,c,e.componentType,e.normalized,!0,1,!0)})}return e._babylonVertexBuffer[t]},r.prototype._loadMaterialMetallicRoughnessPropertiesAsync=function(n,e,t){if(!(t instanceof me))throw new Error("".concat(n,": Material type not supported"));var i=new Array;return e&&(e.baseColorFactor?(t.albedoColor=G.FromArray(e.baseColorFactor),t.alpha=e.baseColorFactor[3]):t.albedoColor=G.White(),t.metallic=e.metallicFactor==null?1:e.metallicFactor,t.roughness=e.roughnessFactor==null?1:e.roughnessFactor,e.baseColorTexture&&i.push(this.loadTextureInfoAsync("".concat(n,"/baseColorTexture"),e.baseColorTexture,function(o){o.name="".concat(t.name," (Base Color)"),t.albedoTexture=o})),e.metallicRoughnessTexture&&(e.metallicRoughnessTexture.nonColorData=!0,i.push(this.loadTextureInfoAsync("".concat(n,"/metallicRoughnessTexture"),e.metallicRoughnessTexture,function(o){o.name="".concat(t.name," (Metallic Roughness)"),t.metallicTexture=o})),t.useMetallnessFromMetallicTextureBlue=!0,t.useRoughnessFromMetallicTextureGreen=!0,t.useRoughnessFromMetallicTextureAlpha=!1)),Promise.all(i).then(function(){})},r.prototype._loadMaterialAsync=function(n,e,t,i,o){o===void 0&&(o=function(){});var a=this._extensionsLoadMaterialAsync(n,e,t,i,o);if(a)return a;e._data=e._data||{};var s=e._data[i];if(!s){this.logOpen("".concat(n," ").concat(e.name||""));var c=this.createMaterial(n,e,i);s={babylonMaterial:c,babylonMeshes:[],promise:this.loadMaterialPropertiesAsync(n,e,c)},e._data[i]=s,r.AddPointerMetadata(c,n),this._parent.onMaterialLoadedObservable.notifyObservers(c),this.logClose()}return t&&(s.babylonMeshes.push(t),t.onDisposeObservable.addOnce(function(){var l=s.babylonMeshes.indexOf(t);l!==-1&&s.babylonMeshes.splice(l,1)})),o(s.babylonMaterial),s.promise.then(function(){return s.babylonMaterial})},r.prototype._createDefaultMaterial=function(n,e){this._babylonScene._blockEntityCollection=!!this._assetContainer;var t=new me(n,this._babylonScene);return t._parentContainer=this._assetContainer,this._babylonScene._blockEntityCollection=!1,t.fillMode=e,t.enableSpecularAntiAliasing=!0,t.useRadianceOverAlpha=!this._parent.transparencyAsCoverage,t.useSpecularOverAlpha=!this._parent.transparencyAsCoverage,t.transparencyMode=me.PBRMATERIAL_OPAQUE,t.metallic=1,t.roughness=1,t},r.prototype.createMaterial=function(n,e,t){var i=this._extensionsCreateMaterial(n,e,t);if(i)return i;var o=e.name||"material".concat(e.index),a=this._createDefaultMaterial(o,t);return a},r.prototype.loadMaterialPropertiesAsync=function(n,e,t){var i=this._extensionsLoadMaterialPropertiesAsync(n,e,t);if(i)return i;var o=new Array;return o.push(this.loadMaterialBasePropertiesAsync(n,e,t)),e.pbrMetallicRoughness&&o.push(this._loadMaterialMetallicRoughnessPropertiesAsync("".concat(n,"/pbrMetallicRoughness"),e.pbrMetallicRoughness,t)),this.loadMaterialAlphaProperties(n,e,t),Promise.all(o).then(function(){})},r.prototype.loadMaterialBasePropertiesAsync=function(n,e,t){if(!(t instanceof me))throw new Error("".concat(n,": Material type not supported"));var i=new Array;return t.emissiveColor=e.emissiveFactor?G.FromArray(e.emissiveFactor):new G(0,0,0),e.doubleSided&&(t.backFaceCulling=!1,t.twoSidedLighting=!0),e.normalTexture&&(e.normalTexture.nonColorData=!0,i.push(this.loadTextureInfoAsync("".concat(n,"/normalTexture"),e.normalTexture,function(o){o.name="".concat(t.name," (Normal)"),t.bumpTexture=o})),t.invertNormalMapX=!this._babylonScene.useRightHandedSystem,t.invertNormalMapY=this._babylonScene.useRightHandedSystem,e.normalTexture.scale!=null&&(t.bumpTexture.level=e.normalTexture.scale),t.forceIrradianceInFragment=!0),e.occlusionTexture&&(e.occlusionTexture.nonColorData=!0,i.push(this.loadTextureInfoAsync("".concat(n,"/occlusionTexture"),e.occlusionTexture,function(o){o.name="".concat(t.name," (Occlusion)"),t.ambientTexture=o})),t.useAmbientInGrayScale=!0,e.occlusionTexture.strength!=null&&(t.ambientTextureStrength=e.occlusionTexture.strength)),e.emissiveTexture&&i.push(this.loadTextureInfoAsync("".concat(n,"/emissiveTexture"),e.emissiveTexture,function(o){o.name="".concat(t.name," (Emissive)"),t.emissiveTexture=o})),Promise.all(i).then(function(){})},r.prototype.loadMaterialAlphaProperties=function(n,e,t){if(!(t instanceof me))throw new Error("".concat(n,": Material type not supported"));var i=e.alphaMode||"OPAQUE";switch(i){case"OPAQUE":{t.transparencyMode=me.PBRMATERIAL_OPAQUE;break}case"MASK":{t.transparencyMode=me.PBRMATERIAL_ALPHATEST,t.alphaCutOff=e.alphaCutoff==null?.5:e.alphaCutoff,t.albedoTexture&&(t.albedoTexture.hasAlpha=!0);break}case"BLEND":{t.transparencyMode=me.PBRMATERIAL_ALPHABLEND,t.albedoTexture&&(t.albedoTexture.hasAlpha=!0,t.useAlphaFromAlbedoTexture=!0);break}default:throw new Error("".concat(n,"/alphaMode: Invalid value (").concat(e.alphaMode,")"))}},r.prototype.loadTextureInfoAsync=function(n,e,t){var i=this;t===void 0&&(t=function(){});var o=this._extensionsLoadTextureInfoAsync(n,e,t);if(o)return o;if(this.logOpen("".concat(n)),e.texCoord>=6)throw new Error("".concat(n,"/texCoord: Invalid value (").concat(e.texCoord,")"));var a=V.Get("".concat(n,"/index"),this._gltf.textures,e.index);a._textureInfo=e;var s=this._loadTextureAsync("/textures/".concat(e.index),a,function(c){c.coordinatesIndex=e.texCoord||0,r.AddPointerMetadata(c,n),i._parent.onTextureLoadedObservable.notifyObservers(c),t(c)});return this.logClose(),s},r.prototype._loadTextureAsync=function(n,e,t){t===void 0&&(t=function(){});var i=this._extensionsLoadTextureAsync(n,e,t);if(i)return i;this.logOpen("".concat(n," ").concat(e.name||""));var o=e.sampler==null?r.DefaultSampler:V.Get("".concat(n,"/sampler"),this._gltf.samplers,e.sampler),a=V.Get("".concat(n,"/source"),this._gltf.images,e.source),s=this._createTextureAsync(n,o,a,t,void 0,!e._textureInfo.nonColorData);return this.logClose(),s},r.prototype._createTextureAsync=function(n,e,t,i,o,a){var s=this;i===void 0&&(i=function(){});var c=this._loadSampler("/samplers/".concat(e.index),e),l=new Array,u=new Dt;this._babylonScene._blockEntityCollection=!!this._assetContainer;var f={noMipmap:c.noMipMaps,invertY:!1,samplingMode:c.samplingMode,onLoad:function(){s._disposed||u.resolve()},onError:function(p,m){s._disposed||u.reject(new Error("".concat(n,": ").concat(m&&m.message?m.message:p||"Failed to load texture")))},mimeType:t.mimeType,loaderOptions:o,useSRGBBuffer:!!a&&this._parent.useSRGBBuffers},d=new X(null,this._babylonScene,f);return d._parentContainer=this._assetContainer,this._babylonScene._blockEntityCollection=!1,l.push(u.promise),l.push(this.loadImageAsync("/images/".concat(t.index),t).then(function(p){var m=t.uri||"".concat(s._fileName,"#image").concat(t.index),_="data:".concat(s._uniqueRootUrl).concat(m);d.updateURL(_,p)})),d.wrapU=c.wrapU,d.wrapV=c.wrapV,i(d),Promise.all(l).then(function(){return d})},r.prototype._loadSampler=function(n,e){return e._data||(e._data={noMipMaps:e.minFilter===9728||e.minFilter===9729,samplingMode:r._GetTextureSamplingMode(n,e),wrapU:r._GetTextureWrapMode("".concat(n,"/wrapS"),e.wrapS),wrapV:r._GetTextureWrapMode("".concat(n,"/wrapT"),e.wrapT)}),e._data},r.prototype.loadImageAsync=function(n,e){if(!e._data){if(this.logOpen("".concat(n," ").concat(e.name||"")),e.uri)e._data=this.loadUriAsync("".concat(n,"/uri"),e,e.uri);else{var t=V.Get("".concat(n,"/bufferView"),this._gltf.bufferViews,e.bufferView);e._data=this.loadBufferViewAsync("/bufferViews/".concat(t.index),t)}this.logClose()}return e._data},r.prototype.loadUriAsync=function(n,e,t){var i=this,o=this._extensionsLoadUriAsync(n,e,t);if(o)return o;if(!r._ValidateUri(t))throw new Error("".concat(n,": '").concat(t,"' is invalid"));if(bo(t)){var a=new Uint8Array(rr(t));return this.log("".concat(n,": Decoded ").concat(t.substr(0,64),"... (").concat(a.length," bytes)")),Promise.resolve(a)}return this.log("".concat(n,": Loading ").concat(t)),this._parent.preprocessUrlAsync(this._rootUrl+t).then(function(s){return new Promise(function(c,l){i._parent._loadFile(i._babylonScene,s,function(u){i._disposed||(i.log("".concat(n,": Loaded ").concat(t," (").concat(u.byteLength," bytes)")),c(new Uint8Array(u)))},!0,function(u){l(new Ao("".concat(n,": Failed to load '").concat(t,"'").concat(u?": "+u.status+" "+u.statusText:""),u))})})})},r.AddPointerMetadata=function(n,e){var t=n.metadata=n.metadata||{},i=t.gltf=t.gltf||{},o=i.pointers=i.pointers||[];o.push(e)},r._GetTextureWrapMode=function(n,e){switch(e=e==null?10497:e,e){case 33071:return X.CLAMP_ADDRESSMODE;case 33648:return X.MIRROR_ADDRESSMODE;case 10497:return X.WRAP_ADDRESSMODE;default:return ne.Warn("".concat(n,": Invalid value (").concat(e,")")),X.WRAP_ADDRESSMODE}},r._GetTextureSamplingMode=function(n,e){var t=e.magFilter==null?9729:e.magFilter,i=e.minFilter==null?9987:e.minFilter;if(t===9729)switch(i){case 9728:return X.LINEAR_NEAREST;case 9729:return X.LINEAR_LINEAR;case 9984:return X.LINEAR_NEAREST_MIPNEAREST;case 9985:return X.LINEAR_LINEAR_MIPNEAREST;case 9986:return X.LINEAR_NEAREST_MIPLINEAR;case 9987:return X.LINEAR_LINEAR_MIPLINEAR;default:return ne.Warn("".concat(n,"/minFilter: Invalid value (").concat(i,")")),X.LINEAR_LINEAR_MIPLINEAR}else switch(t!==9728&&ne.Warn("".concat(n,"/magFilter: Invalid value (").concat(t,")")),i){case 9728:return X.NEAREST_NEAREST;case 9729:return X.NEAREST_LINEAR;case 9984:return X.NEAREST_NEAREST_MIPNEAREST;case 9985:return X.NEAREST_LINEAR_MIPNEAREST;case 9986:return X.NEAREST_NEAREST_MIPLINEAR;case 9987:return X.NEAREST_LINEAR_MIPLINEAR;default:return ne.Warn("".concat(n,"/minFilter: Invalid value (").concat(i,")")),X.NEAREST_NEAREST_MIPNEAREST}},r._GetTypedArrayConstructor=function(n,e){switch(e){case 5120:return Int8Array;case 5121:return Uint8Array;case 5122:return Int16Array;case 5123:return Uint16Array;case 5125:return Uint32Array;case 5126:return Float32Array;default:throw new Error("".concat(n,": Invalid component type ").concat(e))}},r._GetTypedArray=function(n,e,t,i,o){var a=t.buffer;i=t.byteOffset+(i||0);var s=r._GetTypedArrayConstructor("".concat(n,"/componentType"),e),c=w.GetTypeByteLength(e);return i%c!==0?(ne.Warn("".concat(n,": Copying buffer as byte offset (").concat(i,") is not a multiple of component type byte length (").concat(c,")")),new s(a.slice(i,i+o*c),0)):new s(a,i,o)},r._GetNumComponents=function(n,e){switch(e){case"SCALAR":return 1;case"VEC2":return 2;case"VEC3":return 3;case"VEC4":return 4;case"MAT2":return 4;case"MAT3":return 9;case"MAT4":return 16}throw new Error("".concat(n,": Invalid type (").concat(e,")"))},r._ValidateUri=function(n){return z.IsBase64(n)||n.indexOf("..")===-1},r._GetDrawMode=function(n,e){switch(e==null&&(e=4),e){case 0:return Ee.PointListDrawMode;case 1:return Ee.LineListDrawMode;case 2:return Ee.LineLoopDrawMode;case 3:return Ee.LineStripDrawMode;case 4:return Ee.TriangleFillMode;case 5:return Ee.TriangleStripDrawMode;case 6:return Ee.TriangleFanDrawMode}throw new Error("".concat(n,": Invalid mesh primitive mode (").concat(e,")"))},r.prototype._compileMaterialsAsync=function(){var n=this;this._parent._startPerformanceCounter("Compile materials");var e=new Array;if(this._gltf.materials)for(var t=0,i=this._gltf.materials;t<i.length;t++){var o=i[t];if(o._data)for(var a in o._data)for(var s=o._data[a],c=0,l=s.babylonMeshes;c<l.length;c++){var u=l[c];u.computeWorldMatrix(!0);var f=s.babylonMaterial;e.push(f.forceCompilationAsync(u)),e.push(f.forceCompilationAsync(u,{useInstances:!0})),this._parent.useClipPlane&&(e.push(f.forceCompilationAsync(u,{clipPlane:!0})),e.push(f.forceCompilationAsync(u,{clipPlane:!0,useInstances:!0})))}}return Promise.all(e).then(function(){n._parent._endPerformanceCounter("Compile materials")})},r.prototype._compileShadowGeneratorsAsync=function(){var n=this;this._parent._startPerformanceCounter("Compile shadow generators");for(var e=new Array,t=this._babylonScene.lights,i=0,o=t;i<o.length;i++){var a=o[i],s=a.getShadowGenerator();s&&e.push(s.forceCompilationAsync())}return Promise.all(e).then(function(){n._parent._endPerformanceCounter("Compile shadow generators")})},r.prototype._forEachExtensions=function(n){for(var e=0,t=this._extensions;e<t.length;e++){var i=t[e];i.enabled&&n(i)}},r.prototype._applyExtensions=function(n,e,t){for(var i=0,o=this._extensions;i<o.length;i++){var a=o[i];if(a.enabled){var s="".concat(a.name,".").concat(e),c=n;c._activeLoaderExtensionFunctions=c._activeLoaderExtensionFunctions||{};var l=c._activeLoaderExtensionFunctions;if(!l[s]){l[s]=!0;try{var u=t(a);if(u)return u}finally{delete l[s]}}}}return null},r.prototype._extensionsOnLoading=function(){this._forEachExtensions(function(n){return n.onLoading&&n.onLoading()})},r.prototype._extensionsOnReady=function(){this._forEachExtensions(function(n){return n.onReady&&n.onReady()})},r.prototype._extensionsLoadSceneAsync=function(n,e){return this._applyExtensions(e,"loadScene",function(t){return t.loadSceneAsync&&t.loadSceneAsync(n,e)})},r.prototype._extensionsLoadNodeAsync=function(n,e,t){return this._applyExtensions(e,"loadNode",function(i){return i.loadNodeAsync&&i.loadNodeAsync(n,e,t)})},r.prototype._extensionsLoadCameraAsync=function(n,e,t){return this._applyExtensions(e,"loadCamera",function(i){return i.loadCameraAsync&&i.loadCameraAsync(n,e,t)})},r.prototype._extensionsLoadVertexDataAsync=function(n,e,t){return this._applyExtensions(e,"loadVertexData",function(i){return i._loadVertexDataAsync&&i._loadVertexDataAsync(n,e,t)})},r.prototype._extensionsLoadMeshPrimitiveAsync=function(n,e,t,i,o,a){return this._applyExtensions(o,"loadMeshPrimitive",function(s){return s._loadMeshPrimitiveAsync&&s._loadMeshPrimitiveAsync(n,e,t,i,o,a)})},r.prototype._extensionsLoadMaterialAsync=function(n,e,t,i,o){return this._applyExtensions(e,"loadMaterial",function(a){return a._loadMaterialAsync&&a._loadMaterialAsync(n,e,t,i,o)})},r.prototype._extensionsCreateMaterial=function(n,e,t){return this._applyExtensions(e,"createMaterial",function(i){return i.createMaterial&&i.createMaterial(n,e,t)})},r.prototype._extensionsLoadMaterialPropertiesAsync=function(n,e,t){return this._applyExtensions(e,"loadMaterialProperties",function(i){return i.loadMaterialPropertiesAsync&&i.loadMaterialPropertiesAsync(n,e,t)})},r.prototype._extensionsLoadTextureInfoAsync=function(n,e,t){return this._applyExtensions(e,"loadTextureInfo",function(i){return i.loadTextureInfoAsync&&i.loadTextureInfoAsync(n,e,t)})},r.prototype._extensionsLoadTextureAsync=function(n,e,t){return this._applyExtensions(e,"loadTexture",function(i){return i._loadTextureAsync&&i._loadTextureAsync(n,e,t)})},r.prototype._extensionsLoadAnimationAsync=function(n,e){return this._applyExtensions(e,"loadAnimation",function(t){return t.loadAnimationAsync&&t.loadAnimationAsync(n,e)})},r.prototype._extensionsLoadSkinAsync=function(n,e,t){return this._applyExtensions(t,"loadSkin",function(i){return i._loadSkinAsync&&i._loadSkinAsync(n,e,t)})},r.prototype._extensionsLoadUriAsync=function(n,e,t){return this._applyExtensions(e,"loadUri",function(i){return i._loadUriAsync&&i._loadUriAsync(n,e,t)})},r.prototype._extensionsLoadBufferViewAsync=function(n,e){return this._applyExtensions(e,"loadBufferView",function(t){return t.loadBufferViewAsync&&t.loadBufferViewAsync(n,e)})},r.prototype._extensionsLoadBufferAsync=function(n,e,t,i){return this._applyExtensions(e,"loadBuffer",function(o){return o.loadBufferAsync&&o.loadBufferAsync(n,e,t,i)})},r.LoadExtensionAsync=function(n,e,t,i){if(!e.extensions)return null;var o=e.extensions,a=o[t];return a?i("".concat(n,"/extensions/").concat(t),a):null},r.LoadExtraAsync=function(n,e,t,i){if(!e.extras)return null;var o=e.extras,a=o[t];return a?i("".concat(n,"/extras/").concat(t),a):null},r.prototype.isExtensionUsed=function(n){return!!this._gltf.extensionsUsed&&this._gltf.extensionsUsed.indexOf(n)!==-1},r.prototype.logOpen=function(n){this._parent._logOpen(n)},r.prototype.logClose=function(){this._parent._logClose()},r.prototype.log=function(n){this._parent._log(n)},r.prototype.startPerformanceCounter=function(n){this._parent._startPerformanceCounter(n)},r.prototype.endPerformanceCounter=function(n){this._parent._endPerformanceCounter(n)},r._RegisteredExtensions={},r.DefaultSampler={index:-1},r}();et._CreateGLTF2Loader=function(r){return new W(r)};var lc=function(r){R(n,r);function n(e,t,i,o,a,s,c,l,u){o===void 0&&(o=5),a===void 0&&(a=0),s===void 0&&(s=!1),c===void 0&&(c=!1),l===void 0&&(l=3),u===void 0&&(u=null);var f=r.call(this,"",e)||this;return f._texture=e.getEngine().createRawCubeTexture(t,i,o,a,s,c,l,u),f}return n.prototype.update=function(e,t,i,o,a){a===void 0&&(a=null),this._texture.getEngine().updateRawCubeTexture(this._texture,e,t,i,o,a)},n.prototype.updateRGBDAsync=function(e,t,i,o){return t===void 0&&(t=null),i===void 0&&(i=.8),o===void 0&&(o=0),To(this._texture,e,t,i,o).then(function(){})},n.prototype.clone=function(){var e=this;return ft.Clone(function(){var t=e.getScene(),i=e._texture,o=new n(t,i._bufferViewArray,i.width,i.format,i.type,i.generateMipMaps,i.invertY,i.samplingMode,i._compression);return i.source===Zi.CubeRawRGBD&&o.updateRGBDAsync(i._bufferViewArrayArray,i._sphericalPolynomial,i._lodGenerationScale,i._lodGenerationOffset),o},this)},n}(bi),Hn="EXT_lights_image_based",uc=function(){function r(n){this.name=Hn,this._loader=n,this.enabled=this._loader.isExtensionUsed(Hn)}return r.prototype.dispose=function(){this._loader=null,delete this._lights},r.prototype.onLoading=function(){var n=this._loader.gltf.extensions;if(n&&n[this.name]){var e=n[this.name];this._lights=e.lights}},r.prototype.loadSceneAsync=function(n,e){var t=this;return W.LoadExtensionAsync(n,e,this.name,function(i,o){var a=new Array;a.push(t._loader.loadSceneAsync(n,e)),t._loader.logOpen("".concat(i));var s=V.Get("".concat(i,"/light"),t._lights,o.light);return a.push(t._loadLightAsync("/extensions/".concat(t.name,"/lights/").concat(o.light),s).then(function(c){t._loader.babylonScene.environmentTexture=c})),t._loader.logClose(),Promise.all(a).then(function(){})})},r.prototype._loadLightAsync=function(n,e){var t=this;if(!e._loaded){var i=new Array;this._loader.logOpen("".concat(n));for(var o=new Array(e.specularImages.length),a=function(l){var u=e.specularImages[l];o[l]=new Array(u.length);for(var f=function(p){var m="".concat(n,"/specularImages/").concat(l,"/").concat(p);s._loader.logOpen("".concat(m));var _=u[p],v=V.Get(m,s._loader.gltf.images,_);i.push(s._loader.loadImageAsync("/images/".concat(_),v).then(function(b){o[l][p]=b})),s._loader.logClose()},d=0;d<u.length;d++)f(d)},s=this,c=0;c<e.specularImages.length;c++)a(c);this._loader.logClose(),e._loaded=Promise.all(i).then(function(){var l=new lc(t._loader.babylonScene,null,e.specularImageSize);if(l.name=e.name||"environment",e._babylonTexture=l,e.intensity!=null&&(l.level=e.intensity),e.rotation){var u=q.FromArray(e.rotation);t._loader.babylonScene.useRightHandedSystem||(u=q.Inverse(u)),Q.FromQuaternionToRef(u,l.getReflectionTextureMatrix())}if(!e.irradianceCoefficients)throw new Error("".concat(n,": Irradiance coefficients are missing"));var f=So.FromArray(e.irradianceCoefficients);f.scaleInPlace(e.intensity),f.convertIrradianceToLambertianRadiance();var d=Ro.FromHarmonics(f),p=(o.length-1)/Wt.Log2(e.specularImageSize);return l.updateRGBDAsync(o,d,p)})}return e._loaded.then(function(){return e._babylonTexture})},r}();W.RegisterExtension(Hn,function(r){return new uc(r)});he.prototype.thinInstanceAdd=function(r,n){n===void 0&&(n=!0),this._thinInstanceUpdateBufferSize("matrix",Array.isArray(r)?r.length:1);var e=this._thinInstanceDataStorage.instancesCount;if(Array.isArray(r))for(var t=0;t<r.length;++t)this.thinInstanceSetMatrixAt(this._thinInstanceDataStorage.instancesCount++,r[t],t===r.length-1&&n);else this.thinInstanceSetMatrixAt(this._thinInstanceDataStorage.instancesCount++,r,n);return e};he.prototype.thinInstanceAddSelf=function(r){return r===void 0&&(r=!0),this.thinInstanceAdd(Q.IdentityReadOnly,r)};he.prototype.thinInstanceRegisterAttribute=function(r,n){this.removeVerticesData(r),this._thinInstanceInitializeUserStorage(),this._userThinInstanceBuffersStorage.strides[r]=n,this._userThinInstanceBuffersStorage.sizes[r]=n*Math.max(32,this._thinInstanceDataStorage.instancesCount),this._userThinInstanceBuffersStorage.data[r]=new Float32Array(this._userThinInstanceBuffersStorage.sizes[r]),this._userThinInstanceBuffersStorage.vertexBuffers[r]=new w(this.getEngine(),this._userThinInstanceBuffersStorage.data[r],r,!0,!1,n,!0),this.setVerticesBuffer(this._userThinInstanceBuffersStorage.vertexBuffers[r])};he.prototype.thinInstanceSetMatrixAt=function(r,n,e){if(e===void 0&&(e=!0),!this._thinInstanceDataStorage.matrixData||r>=this._thinInstanceDataStorage.instancesCount)return!1;var t=this._thinInstanceDataStorage.matrixData;return n.copyToArray(t,r*16),this._thinInstanceDataStorage.worldMatrices&&(this._thinInstanceDataStorage.worldMatrices[r]=n),e&&(this.thinInstanceBufferUpdated("matrix"),this.doNotSyncBoundingInfo||this.thinInstanceRefreshBoundingInfo(!1)),!0};he.prototype.thinInstanceSetAttributeAt=function(r,n,e,t){return t===void 0&&(t=!0),!this._userThinInstanceBuffersStorage||!this._userThinInstanceBuffersStorage.data[r]||n>=this._thinInstanceDataStorage.instancesCount?!1:(this._thinInstanceUpdateBufferSize(r,0),this._userThinInstanceBuffersStorage.data[r].set(e,n*this._userThinInstanceBuffersStorage.strides[r]),t&&this.thinInstanceBufferUpdated(r),!0)};Object.defineProperty(he.prototype,"thinInstanceCount",{get:function(){return this._thinInstanceDataStorage.instancesCount},set:function(r){var n,e,t=((e=(n=this._thinInstanceDataStorage.matrixData)===null||n===void 0?void 0:n.length)!==null&&e!==void 0?e:0)/16;r<=t&&(this._thinInstanceDataStorage.instancesCount=r)},enumerable:!0,configurable:!0});he.prototype._thinInstanceCreateMatrixBuffer=function(r,n,e){e===void 0&&(e=!1);for(var t=new sr(this.getEngine(),n,!e,16,!1,!0),i=0;i<4;i++)this.setVerticesBuffer(t.createVertexBuffer(r+i,i*4,4));return t};he.prototype.thinInstanceSetBuffer=function(r,n,e,t){var i,o,a;e===void 0&&(e=0),t===void 0&&(t=!1),e=e||16,r==="matrix"?((i=this._thinInstanceDataStorage.matrixBuffer)===null||i===void 0||i.dispose(),this._thinInstanceDataStorage.matrixBuffer=null,this._thinInstanceDataStorage.matrixBufferSize=n?n.length:32*e,this._thinInstanceDataStorage.matrixData=n,this._thinInstanceDataStorage.worldMatrices=null,n!==null?(this._thinInstanceDataStorage.instancesCount=n.length/e,this._thinInstanceDataStorage.matrixBuffer=this._thinInstanceCreateMatrixBuffer("world",n,t),this.doNotSyncBoundingInfo||this.thinInstanceRefreshBoundingInfo(!1)):(this._thinInstanceDataStorage.instancesCount=0,this.doNotSyncBoundingInfo||this.refreshBoundingInfo())):r==="previousMatrix"?((o=this._thinInstanceDataStorage.previousMatrixBuffer)===null||o===void 0||o.dispose(),this._thinInstanceDataStorage.previousMatrixBuffer=null,this._thinInstanceDataStorage.previousMatrixData=n,n!==null&&(this._thinInstanceDataStorage.previousMatrixBuffer=this._thinInstanceCreateMatrixBuffer("previousWorld",n,t))):(r===w.ColorKind&&(r=w.ColorInstanceKind),n===null?!((a=this._userThinInstanceBuffersStorage)===null||a===void 0)&&a.data[r]&&(this.removeVerticesData(r),delete this._userThinInstanceBuffersStorage.data[r],delete this._userThinInstanceBuffersStorage.strides[r],delete this._userThinInstanceBuffersStorage.sizes[r],delete this._userThinInstanceBuffersStorage.vertexBuffers[r]):(this._thinInstanceInitializeUserStorage(),this._userThinInstanceBuffersStorage.data[r]=n,this._userThinInstanceBuffersStorage.strides[r]=e,this._userThinInstanceBuffersStorage.sizes[r]=n.length,this._userThinInstanceBuffersStorage.vertexBuffers[r]=new w(this.getEngine(),n,r,!t,!1,e,!0),this.setVerticesBuffer(this._userThinInstanceBuffersStorage.vertexBuffers[r])))};he.prototype.thinInstanceBufferUpdated=function(r){var n,e,t;r==="matrix"?(n=this._thinInstanceDataStorage.matrixBuffer)===null||n===void 0||n.updateDirectly(this._thinInstanceDataStorage.matrixData,0,this._thinInstanceDataStorage.instancesCount):r==="previousMatrix"?(e=this._thinInstanceDataStorage.previousMatrixBuffer)===null||e===void 0||e.updateDirectly(this._thinInstanceDataStorage.previousMatrixData,0,this._thinInstanceDataStorage.instancesCount):!((t=this._userThinInstanceBuffersStorage)===null||t===void 0)&&t.vertexBuffers[r]&&this._userThinInstanceBuffersStorage.vertexBuffers[r].updateDirectly(this._userThinInstanceBuffersStorage.data[r],0)};he.prototype.thinInstancePartialBufferUpdate=function(r,n,e){var t;r==="matrix"?this._thinInstanceDataStorage.matrixBuffer&&this._thinInstanceDataStorage.matrixBuffer.updateDirectly(n,e):!((t=this._userThinInstanceBuffersStorage)===null||t===void 0)&&t.vertexBuffers[r]&&this._userThinInstanceBuffersStorage.vertexBuffers[r].updateDirectly(n,e)};he.prototype.thinInstanceGetWorldMatrices=function(){if(!this._thinInstanceDataStorage.matrixData||!this._thinInstanceDataStorage.matrixBuffer)return[];var r=this._thinInstanceDataStorage.matrixData;if(!this._thinInstanceDataStorage.worldMatrices){this._thinInstanceDataStorage.worldMatrices=new Array;for(var n=0;n<this._thinInstanceDataStorage.instancesCount;++n)this._thinInstanceDataStorage.worldMatrices[n]=Q.FromArray(r,n*16)}return this._thinInstanceDataStorage.worldMatrices};he.prototype.thinInstanceRefreshBoundingInfo=function(r,n,e){if(r===void 0&&(r=!1),n===void 0&&(n=!1),e===void 0&&(e=!1),!(!this._thinInstanceDataStorage.matrixData||!this._thinInstanceDataStorage.matrixBuffer)){var t=this._thinInstanceDataStorage.boundingVectors;r&&(t.length=0,this.refreshBoundingInfo(n,e));var i=this.getBoundingInfo(),o=this._thinInstanceDataStorage.matrixData;if(t.length===0)for(var a=0;a<i.boundingBox.vectors.length;++a)t.push(i.boundingBox.vectors[a].clone());H.Vector3[0].setAll(Number.POSITIVE_INFINITY),H.Vector3[1].setAll(Number.NEGATIVE_INFINITY);for(var s=0;s<this._thinInstanceDataStorage.instancesCount;++s){Q.FromArrayToRef(o,s*16,H.Matrix[0]);for(var a=0;a<t.length;++a)y.TransformCoordinatesToRef(t[a],H.Matrix[0],H.Vector3[2]),H.Vector3[0].minimizeInPlace(H.Vector3[2]),H.Vector3[1].maximizeInPlace(H.Vector3[2])}i.reConstruct(H.Vector3[0],H.Vector3[1]),this._updateBoundingInfo()}};he.prototype._thinInstanceUpdateBufferSize=function(r,n){var e,t,i;n===void 0&&(n=1);var o=r==="matrix";if(!(!o&&(!this._userThinInstanceBuffersStorage||!this._userThinInstanceBuffersStorage.strides[r]))){for(var a=o?16:this._userThinInstanceBuffersStorage.strides[r],s=o?this._thinInstanceDataStorage.matrixBufferSize:this._userThinInstanceBuffersStorage.sizes[r],c=o?this._thinInstanceDataStorage.matrixData:this._userThinInstanceBuffersStorage.data[r],l=(this._thinInstanceDataStorage.instancesCount+n)*a,u=s;u<l;)u*=2;if(!c||s!=u){if(!c)c=new Float32Array(u);else{var f=new Float32Array(u);f.set(c,0),c=f}o?((e=this._thinInstanceDataStorage.matrixBuffer)===null||e===void 0||e.dispose(),this._thinInstanceDataStorage.matrixBuffer=this._thinInstanceCreateMatrixBuffer("world",c,!1),this._thinInstanceDataStorage.matrixData=c,this._thinInstanceDataStorage.matrixBufferSize=u,this._scene.needsPreviousWorldMatrices&&!this._thinInstanceDataStorage.previousMatrixData&&((t=this._thinInstanceDataStorage.previousMatrixBuffer)===null||t===void 0||t.dispose(),this._thinInstanceDataStorage.previousMatrixBuffer=this._thinInstanceCreateMatrixBuffer("previousWorld",c,!1))):((i=this._userThinInstanceBuffersStorage.vertexBuffers[r])===null||i===void 0||i.dispose(),this._userThinInstanceBuffersStorage.data[r]=c,this._userThinInstanceBuffersStorage.sizes[r]=u,this._userThinInstanceBuffersStorage.vertexBuffers[r]=new w(this.getEngine(),c,r,!0,!1,a,!0),this.setVerticesBuffer(this._userThinInstanceBuffersStorage.vertexBuffers[r]))}}};he.prototype._thinInstanceInitializeUserStorage=function(){this._userThinInstanceBuffersStorage||(this._userThinInstanceBuffersStorage={data:{},sizes:{},vertexBuffers:{},strides:{}})};he.prototype._disposeThinInstanceSpecificData=function(){var r;!((r=this._thinInstanceDataStorage)===null||r===void 0)&&r.matrixBuffer&&(this._thinInstanceDataStorage.matrixBuffer.dispose(),this._thinInstanceDataStorage.matrixBuffer=null)};var zn="EXT_mesh_gpu_instancing",fc=function(){function r(n){this.name=zn,this._loader=n,this.enabled=this._loader.isExtensionUsed(zn)}return r.prototype.dispose=function(){this._loader=null},r.prototype.loadNodeAsync=function(n,e,t){var i=this;return W.LoadExtensionAsync(n,e,this.name,function(o,a){i._loader._disableInstancedMesh++;var s=i._loader.loadNodeAsync("/nodes/".concat(e.index),e,t);if(i._loader._disableInstancedMesh--,!e._primitiveBabylonMeshes)return s;var c=new Array,l=0,u=function(f){if(a.attributes[f]==null){c.push(Promise.resolve(null));return}var d=V.Get("".concat(o,"/attributes/").concat(f),i._loader.gltf.accessors,a.attributes[f]);if(c.push(i._loader._loadFloatAccessorAsync("/accessors/".concat(d.bufferView),d)),l===0)l=d.count;else if(l!==d.count)throw new Error("".concat(o,"/attributes: Instance buffer accessors do not have the same count."))};return u("TRANSLATION"),u("ROTATION"),u("SCALE"),s.then(function(f){return Promise.all(c).then(function(d){var p=d[0],m=d[1],_=d[2],v=new Float32Array(l*16);H.Vector3[0].copyFromFloats(0,0,0),H.Quaternion[0].copyFromFloats(0,0,0,1),H.Vector3[1].copyFromFloats(1,1,1);for(var b=0;b<l;++b)p&&y.FromArrayToRef(p,b*3,H.Vector3[0]),m&&q.FromArrayToRef(m,b*4,H.Quaternion[0]),_&&y.FromArrayToRef(_,b*3,H.Vector3[1]),Q.ComposeToRef(H.Vector3[1],H.Quaternion[0],H.Vector3[0],H.Matrix[0]),H.Matrix[0].copyToArray(v,b*16);for(var A=0,S=e._primitiveBabylonMeshes;A<S.length;A++){var C=S[A];C.thinInstanceSetBuffer("matrix",v,16,!0)}return f})})})},r}();W.RegisterExtension(zn,function(r){return new fc(r)});var hc=function(){function r(){var n=r.Configuration.decoder;this._decoderModulePromise=z.LoadScriptAsync(z.GetAbsoluteUrl(n.url)).then(function(){return MeshoptDecoder.ready})}return Object.defineProperty(r,"Default",{get:function(){return r._Default||(r._Default=new r),r._Default},enumerable:!1,configurable:!0}),r.prototype.dispose=function(){delete this._decoderModulePromise},r.prototype.decodeGltfBufferAsync=function(n,e,t,i,o){return this._decoderModulePromise.then(function(){var a=new Uint8Array(e*t);return MeshoptDecoder.decodeGltfBuffer(a,e,t,n,i,o),a})},r.Configuration={decoder:{url:"https://preview.babylonjs.com/meshopt_decoder.js"}},r._Default=null,r}(),Xn="EXT_meshopt_compression",dc=function(){function r(n){this.name=Xn,this.enabled=n.isExtensionUsed(Xn),this._loader=n}return r.prototype.dispose=function(){this._loader=null},r.prototype.loadBufferViewAsync=function(n,e){var t=this;return W.LoadExtensionAsync(n,e,this.name,function(i,o){var a=e;if(a._meshOptData)return a._meshOptData;var s=V.Get("".concat(n,"/buffer"),t._loader.gltf.buffers,o.buffer);return a._meshOptData=t._loader.loadBufferAsync("/buffers/".concat(s.index),s,o.byteOffset||0,o.byteLength).then(function(c){return hc.Default.decodeGltfBufferAsync(c,o.count,o.byteStride,o.mode,o.filter)}),a._meshOptData})},r}();W.RegisterExtension(Xn,function(r){return new dc(r)});var jn="EXT_texture_webp",pc=function(){function r(n){this.name=jn,this._loader=n,this.enabled=n.isExtensionUsed(jn)}return r.prototype.dispose=function(){this._loader=null},r.prototype._loadTextureAsync=function(n,e,t){var i=this;return W.LoadExtensionAsync(n,e,this.name,function(o,a){var s=e.sampler==null?W.DefaultSampler:V.Get("".concat(n,"/sampler"),i._loader.gltf.samplers,e.sampler),c=V.Get("".concat(o,"/source"),i._loader.gltf.images,a.source);return i._loader._createTextureAsync(n,s,c,function(l){t(l)},void 0,!e._textureInfo.nonColorData)})},r}();W.RegisterExtension(jn,function(r){return new pc(r)});function mc(r){return new Promise(function(n){DracoDecoderModule({wasmBinary:r}).then(function(e){n({module:e})})})}function Yn(r,n,e,t,i,o){var a=new r.DecoderBuffer;a.Init(n,n.byteLength);var s=new r.Decoder,c,l;try{var u=s.GetEncodedGeometryType(a);switch(u){case r.TRIANGULAR_MESH:c=new r.Mesh,l=s.DecodeBufferToMesh(a,c);break;case r.POINT_CLOUD:c=new r.PointCloud,l=s.DecodeBufferToPointCloud(a,c);break;default:throw new Error("Invalid geometry type ".concat(u))}if(!l.ok()||!c.ptr)throw new Error(l.error_msg());if(u===r.TRIANGULAR_MESH){var f=c.num_faces(),d=f*3,p=d*4,m=r._malloc(p);try{s.GetTrianglesUInt32Array(c,p,m);var _=new Uint32Array(d);_.set(new Uint32Array(r.HEAPF32.buffer,m,d)),t(_)}finally{r._free(m)}}var v=function(B,k,D){D===void 0&&(D=1);var Z=k.num_components(),$=c.num_points(),I=$*Z,ue=I*Float32Array.BYTES_PER_ELEMENT,ge=r._malloc(ue);try{s.GetAttributeDataArrayForAllPoints(c,k,r.DT_FLOAT32,ue,ge);var _e=new Float32Array(r.HEAPF32.buffer,ge,I);if(B==="color"&&Z===3){for(var ce=new Float32Array($*4),ie=0,Se=0;ie<ce.length;ie+=4,Se+=Z)ce[ie+0]=_e[Se+0],ce[ie+1]=_e[Se+1],ce[ie+2]=_e[Se+2],ce[ie+3]=1;i(B,ce)}else{var ce=new Float32Array(I);if(ce.set(new Float32Array(r.HEAPF32.buffer,ge,I)),D!==1)for(var ie=0;ie<ce.length;ie++)ce[ie]=ce[ie]/D;i(B,ce)}}finally{r._free(ge)}};if(e)for(var b in e){var A=e[b],S=s.GetAttributeByUniqueId(c,A),C=o&&o[b]||1;v(b,S,C)}else{var O={position:"POSITION",normal:"NORMAL",color:"COLOR",uv:"TEX_COORD"};for(var b in O){var A=s.GetAttributeId(c,r[O[b]]);if(A!==-1){var S=s.GetAttribute(c,A);v(b,S)}}}}finally{c&&r.destroy(c),r.destroy(s),r.destroy(a)}}function _c(){var r;onmessage=function(n){var e=n.data;switch(e.id){case"init":{var t=e.decoder;t.url&&(importScripts(t.url),r=DracoDecoderModule({wasmBinary:t.wasmBinary})),postMessage("done");break}case"decodeMesh":{if(!r)throw new Error("Draco decoder module is not available");r.then(function(i){Yn(i,e.dataView,e.attributes,function(o){postMessage({id:"indices",value:o},[o.buffer])},function(o,a){postMessage({id:o,value:a},[a.buffer])}),postMessage("done")});break}}}}var qi=function(){function r(n){n===void 0&&(n=r.DefaultNumWorkers);var e=r.Configuration.decoder,t=e.wasmUrl&&e.wasmBinaryUrl&&typeof WebAssembly=="object"?{url:z.GetAbsoluteUrl(e.wasmUrl),wasmBinaryPromise:z.LoadFileAsync(z.GetAbsoluteUrl(e.wasmBinaryUrl))}:{url:z.GetAbsoluteUrl(e.fallbackUrl),wasmBinaryPromise:Promise.resolve(void 0)};n&&typeof Worker=="function"?this._workerPoolPromise=t.wasmBinaryPromise.then(function(i){var o="".concat(Yn,"(").concat(_c,")()"),a=URL.createObjectURL(new Blob([o],{type:"application/javascript"}));return new Oo(n,function(){return new Promise(function(s,c){var l=new Worker(a),u=function(d){l.removeEventListener("error",u),l.removeEventListener("message",f),c(d)},f=function(d){d.data==="done"&&(l.removeEventListener("error",u),l.removeEventListener("message",f),s(l))};l.addEventListener("error",u),l.addEventListener("message",f),l.postMessage({id:"init",decoder:{url:t.url,wasmBinary:i}})})})}):this._decoderModulePromise=t.wasmBinaryPromise.then(function(i){if(!t.url)throw new Error("Draco decoder module is not available");return z.LoadScriptAsync(t.url).then(function(){return mc(i)})})}return Object.defineProperty(r,"DecoderAvailable",{get:function(){var n=r.Configuration.decoder;return!!(n.wasmUrl&&n.wasmBinaryUrl&&typeof WebAssembly=="object"||n.fallbackUrl)},enumerable:!1,configurable:!0}),r.GetDefaultNumWorkers=function(){return typeof navigator!="object"||!navigator.hardwareConcurrency?1:Math.min(Math.floor(navigator.hardwareConcurrency*.5),4)},Object.defineProperty(r,"Default",{get:function(){return r._Default||(r._Default=new r),r._Default},enumerable:!1,configurable:!0}),r.prototype.dispose=function(){this._workerPoolPromise&&this._workerPoolPromise.then(function(n){n.dispose()}),delete this._workerPoolPromise,delete this._decoderModulePromise},r.prototype.whenReadyAsync=function(){return this._workerPoolPromise?this._workerPoolPromise.then(function(){}):this._decoderModulePromise?this._decoderModulePromise.then(function(){}):Promise.resolve()},r.prototype.decodeMeshAsync=function(n,e,t){var i=n instanceof ArrayBuffer?new Uint8Array(n):n;if(this._workerPoolPromise)return this._workerPoolPromise.then(function(o){return new Promise(function(a,s){o.push(function(c,l){var u=new Mn,f=function(m){c.removeEventListener("error",f),c.removeEventListener("message",d),s(m),l()},d=function(m){if(m.data==="done")c.removeEventListener("error",f),c.removeEventListener("message",d),a(u),l();else if(m.data.id==="indices")u.indices=m.data.value;else{var _=t&&t[m.data.id]?t[m.data.id]:1;if(_!==1)for(var v=0;v<m.data.value.length;v++)m.data.value[v]=m.data.value[v]/_;u.set(m.data.value,m.data.id)}};c.addEventListener("error",f),c.addEventListener("message",d);var p=new Uint8Array(i.byteLength);p.set(new Uint8Array(i.buffer,i.byteOffset,i.byteLength)),c.postMessage({id:"decodeMesh",dataView:p,attributes:e},[p.buffer])})})});if(this._decoderModulePromise)return this._decoderModulePromise.then(function(o){var a=new Mn;return Yn(o.module,i,e,function(s){a.indices=s},function(s,c){a.set(c,s)},t),a});throw new Error("Draco decoder module is not available")},r.Configuration={decoder:{wasmUrl:"https://preview.babylonjs.com/draco_wasm_wrapper_gltf.js",wasmBinaryUrl:"https://preview.babylonjs.com/draco_decoder_gltf.wasm",fallbackUrl:"https://preview.babylonjs.com/draco_decoder_gltf.js"}},r.DefaultNumWorkers=r.GetDefaultNumWorkers(),r._Default=null,r}(),Wn="KHR_draco_mesh_compression",gc=function(){function r(n){this.name=Wn,this._loader=n,this.enabled=qi.DecoderAvailable&&this._loader.isExtensionUsed(Wn)}return r.prototype.dispose=function(){delete this.dracoCompression,this._loader=null},r.prototype._loadVertexDataAsync=function(n,e,t){var i=this;return W.LoadExtensionAsync(n,e,this.name,function(o,a){if(e.mode!=null){if(e.mode!==5&&e.mode!==4)throw new Error("".concat(n,": Unsupported mode ").concat(e.mode));if(e.mode===5)throw new Error("".concat(n,": Mode ").concat(e.mode," is not currently supported"))}var s={},c={},l=function(f,d){var p=a.attributes[f];if(!(p===void 0||e.attributes[f]===void 0)){s[d]=p;var m=V.Get("".concat(n,"/attributes/").concat(f),i._loader.gltf.accessors,e.attributes[f]);if(m.normalized&&m.componentType!==5126){var _=1;switch(m.componentType){case 5120:_=127;break;case 5121:_=255;break;case 5122:_=32767;break;case 5123:_=65535;break}c[d]=_}t._delayInfo=t._delayInfo||[],t._delayInfo.indexOf(d)===-1&&t._delayInfo.push(d)}};l("POSITION",w.PositionKind),l("NORMAL",w.NormalKind),l("TANGENT",w.TangentKind),l("TEXCOORD_0",w.UVKind),l("TEXCOORD_1",w.UV2Kind),l("TEXCOORD_2",w.UV3Kind),l("TEXCOORD_3",w.UV4Kind),l("TEXCOORD_4",w.UV5Kind),l("TEXCOORD_5",w.UV6Kind),l("JOINTS_0",w.MatricesIndicesKind),l("WEIGHTS_0",w.MatricesWeightsKind),l("COLOR_0",w.ColorKind);var u=V.Get(o,i._loader.gltf.bufferViews,a.bufferView);return u._dracoBabylonGeometry||(u._dracoBabylonGeometry=i._loader.loadBufferViewAsync("/bufferViews/".concat(u.index),u).then(function(f){var d=i.dracoCompression||qi.Default;return d.decodeMeshAsync(f,s,c).then(function(p){var m=new Ei(t.name,i._loader.babylonScene);return p.applyToGeometry(m),m}).catch(function(p){throw new Error("".concat(n,": ").concat(p.message))})})),u._dracoBabylonGeometry})},r}();W.RegisterExtension(Wn,function(r){return new gc(r)});var Kn="KHR_lights_punctual",vc=function(){function r(n){this.name=Kn,this._loader=n,this.enabled=this._loader.isExtensionUsed(Kn)}return r.prototype.dispose=function(){this._loader=null,delete this._lights},r.prototype.onLoading=function(){var n=this._loader.gltf.extensions;if(n&&n[this.name]){var e=n[this.name];this._lights=e.lights}},r.prototype.loadNodeAsync=function(n,e,t){var i=this;return W.LoadExtensionAsync(n,e,this.name,function(o,a){return i._loader.loadNodeAsync(n,e,function(s){var c,l=V.Get(o,i._lights,a.light),u=l.name||s.name;switch(i._loader.babylonScene._blockEntityCollection=!!i._loader._assetContainer,l.type){case"directional":{c=new hn(u,y.Backward(),i._loader.babylonScene);break}case"point":{c=new Kt(u,y.Zero(),i._loader.babylonScene);break}case"spot":{var f=new dn(u,y.Zero(),y.Backward(),0,1,i._loader.babylonScene);f.angle=(l.spot&&l.spot.outerConeAngle||Math.PI/4)*2,f.innerAngle=(l.spot&&l.spot.innerConeAngle||0)*2,c=f;break}default:throw i._loader.babylonScene._blockEntityCollection=!1,new Error("".concat(o,": Invalid light type (").concat(l.type,")"))}c._parentContainer=i._loader._assetContainer,i._loader.babylonScene._blockEntityCollection=!1,c.falloffType=jt.FALLOFF_GLTF,c.diffuse=l.color?G.FromArray(l.color):G.White(),c.intensity=l.intensity==null?1:l.intensity,c.range=l.range==null?Number.MAX_VALUE:l.range,c.parent=s,i._loader._babylonLights.push(c),W.AddPointerMetadata(c,o),t(s)})})},r}();W.RegisterExtension(Kn,function(r){return new vc(r)});var Qn="KHR_materials_pbrSpecularGlossiness",Ec=function(){function r(n){this.name=Qn,this.order=200,this._loader=n,this.enabled=this._loader.isExtensionUsed(Qn)}return r.prototype.dispose=function(){this._loader=null},r.prototype.loadMaterialPropertiesAsync=function(n,e,t){var i=this;return W.LoadExtensionAsync(n,e,this.name,function(o,a){var s=new Array;return s.push(i._loader.loadMaterialBasePropertiesAsync(n,e,t)),s.push(i._loadSpecularGlossinessPropertiesAsync(o,e,a,t)),i._loader.loadMaterialAlphaProperties(n,e,t),Promise.all(s).then(function(){})})},r.prototype._loadSpecularGlossinessPropertiesAsync=function(n,e,t,i){if(!(i instanceof me))throw new Error("".concat(n,": Material type not supported"));var o=new Array;return i.metallic=null,i.roughness=null,t.diffuseFactor?(i.albedoColor=G.FromArray(t.diffuseFactor),i.alpha=t.diffuseFactor[3]):i.albedoColor=G.White(),i.reflectivityColor=t.specularFactor?G.FromArray(t.specularFactor):G.White(),i.microSurface=t.glossinessFactor==null?1:t.glossinessFactor,t.diffuseTexture&&o.push(this._loader.loadTextureInfoAsync("".concat(n,"/diffuseTexture"),t.diffuseTexture,function(a){a.name="".concat(i.name," (Diffuse)"),i.albedoTexture=a})),t.specularGlossinessTexture&&(o.push(this._loader.loadTextureInfoAsync("".concat(n,"/specularGlossinessTexture"),t.specularGlossinessTexture,function(a){a.name="".concat(i.name," (Specular Glossiness)"),i.reflectivityTexture=a})),i.reflectivityTexture.hasAlpha=!0,i.useMicroSurfaceFromReflectivityMapAlpha=!0),Promise.all(o).then(function(){})},r}();W.RegisterExtension(Qn,function(r){return new Ec(r)});var qn="KHR_materials_unlit",bc=function(){function r(n){this.name=qn,this.order=210,this._loader=n,this.enabled=this._loader.isExtensionUsed(qn)}return r.prototype.dispose=function(){this._loader=null},r.prototype.loadMaterialPropertiesAsync=function(n,e,t){var i=this;return W.LoadExtensionAsync(n,e,this.name,function(){return i._loadUnlitPropertiesAsync(n,e,t)})},r.prototype._loadUnlitPropertiesAsync=function(n,e,t){if(!(t instanceof me))throw new Error("".concat(n,": Material type not supported"));var i=new Array;t.unlit=!0;var o=e.pbrMetallicRoughness;return o&&(o.baseColorFactor?(t.albedoColor=G.FromArray(o.baseColorFactor),t.alpha=o.baseColorFactor[3]):t.albedoColor=G.White(),o.baseColorTexture&&i.push(this._loader.loadTextureInfoAsync("".concat(n,"/baseColorTexture"),o.baseColorTexture,function(a){a.name="".concat(t.name," (Base Color)"),t.albedoTexture=a}))),e.doubleSided&&(t.backFaceCulling=!1,t.twoSidedLighting=!0),this._loader.loadMaterialAlphaProperties(n,e,t),Promise.all(i).then(function(){})},r}();W.RegisterExtension(qn,function(r){return new bc(r)});var Zn="KHR_materials_clearcoat",Ac=function(){function r(n){this.name=Zn,this.order=190,this._loader=n,this.enabled=this._loader.isExtensionUsed(Zn)}return r.prototype.dispose=function(){this._loader=null},r.prototype.loadMaterialPropertiesAsync=function(n,e,t){var i=this;return W.LoadExtensionAsync(n,e,this.name,function(o,a){var s=new Array;return s.push(i._loader.loadMaterialPropertiesAsync(n,e,t)),s.push(i._loadClearCoatPropertiesAsync(o,a,t)),Promise.all(s).then(function(){})})},r.prototype._loadClearCoatPropertiesAsync=function(n,e,t){if(!(t instanceof me))throw new Error("".concat(n,": Material type not supported"));var i=new Array;return t.clearCoat.isEnabled=!0,t.clearCoat.useRoughnessFromMainTexture=!1,t.clearCoat.remapF0OnInterfaceChange=!1,e.clearcoatFactor!=null?t.clearCoat.intensity=e.clearcoatFactor:t.clearCoat.intensity=0,e.clearcoatTexture&&i.push(this._loader.loadTextureInfoAsync("".concat(n,"/clearcoatTexture"),e.clearcoatTexture,function(o){o.name="".concat(t.name," (ClearCoat Intensity)"),t.clearCoat.texture=o})),e.clearcoatRoughnessFactor!=null?t.clearCoat.roughness=e.clearcoatRoughnessFactor:t.clearCoat.roughness=0,e.clearcoatRoughnessTexture&&(e.clearcoatRoughnessTexture.nonColorData=!0,i.push(this._loader.loadTextureInfoAsync("".concat(n,"/clearcoatRoughnessTexture"),e.clearcoatRoughnessTexture,function(o){o.name="".concat(t.name," (ClearCoat Roughness)"),t.clearCoat.textureRoughness=o}))),e.clearcoatNormalTexture&&(e.clearcoatNormalTexture.nonColorData=!0,i.push(this._loader.loadTextureInfoAsync("".concat(n,"/clearcoatNormalTexture"),e.clearcoatNormalTexture,function(o){o.name="".concat(t.name," (ClearCoat Normal)"),t.clearCoat.bumpTexture=o})),t.invertNormalMapX=!t.getScene().useRightHandedSystem,t.invertNormalMapY=t.getScene().useRightHandedSystem,e.clearcoatNormalTexture.scale!=null&&(t.clearCoat.bumpTexture.level=e.clearcoatNormalTexture.scale)),Promise.all(i).then(function(){})},r}();W.RegisterExtension(Zn,function(r){return new Ac(r)});var Jn="KHR_materials_emissive_strength",yc=function(){function r(n){this.name=Jn,this.order=170,this._loader=n,this.enabled=this._loader.isExtensionUsed(Jn)}return r.prototype.dispose=function(){this._loader=null},r.prototype.loadMaterialPropertiesAsync=function(n,e,t){var i=this;return W.LoadExtensionAsync(n,e,this.name,function(o,a){return i._loader.loadMaterialPropertiesAsync(n,e,t).then(function(){i._loadEmissiveProperties(o,a,t)})})},r.prototype._loadEmissiveProperties=function(n,e,t){if(!(t instanceof me))throw new Error("".concat(n,": Material type not supported"));e.emissiveStrength!==void 0&&t.emissiveColor.scaleToRef(e.emissiveStrength,t.emissiveColor)},r}();W.RegisterExtension(Jn,function(r){return new yc(r)});var $n="KHR_materials_sheen",Cc=function(){function r(n){this.name=$n,this.order=190,this._loader=n,this.enabled=this._loader.isExtensionUsed($n)}return r.prototype.dispose=function(){this._loader=null},r.prototype.loadMaterialPropertiesAsync=function(n,e,t){var i=this;return W.LoadExtensionAsync(n,e,this.name,function(o,a){var s=new Array;return s.push(i._loader.loadMaterialPropertiesAsync(n,e,t)),s.push(i._loadSheenPropertiesAsync(o,a,t)),Promise.all(s).then(function(){})})},r.prototype._loadSheenPropertiesAsync=function(n,e,t){if(!(t instanceof me))throw new Error("".concat(n,": Material type not supported"));var i=new Array;return t.sheen.isEnabled=!0,t.sheen.intensity=1,e.sheenColorFactor!=null?t.sheen.color=G.FromArray(e.sheenColorFactor):t.sheen.color=G.Black(),e.sheenColorTexture&&i.push(this._loader.loadTextureInfoAsync("".concat(n,"/sheenColorTexture"),e.sheenColorTexture,function(o){o.name="".concat(t.name," (Sheen Color)"),t.sheen.texture=o})),e.sheenRoughnessFactor!==void 0?t.sheen.roughness=e.sheenRoughnessFactor:t.sheen.roughness=0,e.sheenRoughnessTexture&&(e.sheenRoughnessTexture.nonColorData=!0,i.push(this._loader.loadTextureInfoAsync("".concat(n,"/sheenRoughnessTexture"),e.sheenRoughnessTexture,function(o){o.name="".concat(t.name," (Sheen Roughness)"),t.sheen.textureRoughness=o}))),t.sheen.albedoScaling=!0,t.sheen.useRoughnessFromMainTexture=!1,Promise.all(i).then(function(){})},r}();W.RegisterExtension($n,function(r){return new Cc(r)});var ei="KHR_materials_specular",Tc=function(){function r(n){this.name=ei,this.order=190,this._loader=n,this.enabled=this._loader.isExtensionUsed(ei)}return r.prototype.dispose=function(){this._loader=null},r.prototype.loadMaterialPropertiesAsync=function(n,e,t){var i=this;return W.LoadExtensionAsync(n,e,this.name,function(o,a){var s=new Array;return s.push(i._loader.loadMaterialPropertiesAsync(n,e,t)),s.push(i._loadSpecularPropertiesAsync(o,a,t)),Promise.all(s).then(function(){})})},r.prototype._loadSpecularPropertiesAsync=function(n,e,t){if(!(t instanceof me))throw new Error("".concat(n,": Material type not supported"));var i=new Array;return e.specularFactor!==void 0&&(t.metallicF0Factor=e.specularFactor),e.specularColorFactor!==void 0&&(t.metallicReflectanceColor=G.FromArray(e.specularColorFactor)),e.specularTexture&&(e.specularTexture.nonColorData=!0,i.push(this._loader.loadTextureInfoAsync("".concat(n,"/specularTexture"),e.specularTexture,function(o){o.name="".concat(t.name," (Specular F0 Strength)"),t.metallicReflectanceTexture=o,t.useOnlyMetallicFromMetallicReflectanceTexture=!0}))),e.specularColorTexture&&i.push(this._loader.loadTextureInfoAsync("".concat(n,"/specularColorTexture"),e.specularColorTexture,function(o){o.name="".concat(t.name," (Specular F0 Color)"),t.reflectanceTexture=o})),Promise.all(i).then(function(){})},r}();W.RegisterExtension(ei,function(r){return new Tc(r)});var ti="KHR_materials_ior",Sc=function(){function r(n){this.name=ti,this.order=180,this._loader=n,this.enabled=this._loader.isExtensionUsed(ti)}return r.prototype.dispose=function(){this._loader=null},r.prototype.loadMaterialPropertiesAsync=function(n,e,t){var i=this;return W.LoadExtensionAsync(n,e,this.name,function(o,a){var s=new Array;return s.push(i._loader.loadMaterialPropertiesAsync(n,e,t)),s.push(i._loadIorPropertiesAsync(o,a,t)),Promise.all(s).then(function(){})})},r.prototype._loadIorPropertiesAsync=function(n,e,t){if(!(t instanceof me))throw new Error("".concat(n,": Material type not supported"));return e.ior!==void 0?t.indexOfRefraction=e.ior:t.indexOfRefraction=r._DEFAULT_IOR,Promise.resolve()},r._DEFAULT_IOR=1.5,r}();W.RegisterExtension(ti,function(r){return new Sc(r)});var Pe="KHR_materials_variants",Rc=function(){function r(n){this.name=Pe,this._loader=n,this.enabled=this._loader.isExtensionUsed(Pe)}return r.prototype.dispose=function(){this._loader=null},r.GetAvailableVariants=function(n){var e=this._GetExtensionMetadata(n);return e?Object.keys(e.variants):[]},r.prototype.getAvailableVariants=function(n){return r.GetAvailableVariants(n)},r.SelectVariant=function(n,e){var t=this._GetExtensionMetadata(n);if(!t)throw new Error("Cannot select variant on a glTF mesh that does not have the ".concat(Pe," extension"));var i=function(c){var l=t.variants[c];if(l)for(var u=0,f=l;u<f.length;u++){var d=f[u];d.mesh.material=d.material}};if(e instanceof Array)for(var o=0,a=e;o<a.length;o++){var s=a[o];i(s)}else i(e);t.lastSelected=e},r.prototype.selectVariant=function(n,e){return r.SelectVariant(n,e)},r.Reset=function(n){var e=this._GetExtensionMetadata(n);if(!e)throw new Error("Cannot reset on a glTF mesh that does not have the ".concat(Pe," extension"));for(var t=0,i=e.original;t<i.length;t++){var o=i[t];o.mesh.material=o.material}e.lastSelected=null},r.prototype.reset=function(n){return r.Reset(n)},r.GetLastSelectedVariant=function(n){var e=this._GetExtensionMetadata(n);if(!e)throw new Error("Cannot get the last selected variant on a glTF mesh that does not have the ".concat(Pe," extension"));return e.lastSelected},r.prototype.getLastSelectedVariant=function(n){return r.GetLastSelectedVariant(n)},r._GetExtensionMetadata=function(n){var e,t;return((t=(e=n==null?void 0:n.metadata)===null||e===void 0?void 0:e.gltf)===null||t===void 0?void 0:t[Pe])||null},r.prototype.onLoading=function(){var n=this._loader.gltf.extensions;if(n&&n[this.name]){var e=n[this.name];this._variants=e.variants}},r.prototype._loadMeshPrimitiveAsync=function(n,e,t,i,o,a){var s=this;return W.LoadExtensionAsync(n,o,this.name,function(c,l){var u=new Array;return u.push(s._loader._loadMeshPrimitiveAsync(n,e,t,i,o,function(f){if(a(f),f instanceof he){var d=W._GetDrawMode(n,o.mode),p=s._loader.rootBabylonMesh,m=p?p.metadata=p.metadata||{}:{},_=m.gltf=m.gltf||{},v=_[Pe]=_[Pe]||{lastSelected:null,original:[],variants:{}};v.original.push({mesh:f,material:f.material});for(var b=function(S){var C=l.mappings[S],O=V.Get("".concat(c,"/mappings/").concat(S,"/material"),s._loader.gltf.materials,C.material);u.push(s._loader._loadMaterialAsync("#/materials/".concat(C.material),O,f,d,function(B){for(var k=function(Z){var $=C.variants[Z],I=V.Get("/extensions/".concat(Pe,"/variants/").concat($),s._variants,$);v.variants[I.name]=v.variants[I.name]||[],v.variants[I.name].push({mesh:f,material:B}),f.onClonedObservable.add(function(ue){var ge=ue,_e=null,ce=ge;do{if(ce=ce.parent,!ce)return;_e=r._GetExtensionMetadata(ce)}while(_e===null);if(p&&_e===r._GetExtensionMetadata(p)){ce.metadata={};for(var ie in p.metadata)ce.metadata[ie]=p.metadata[ie];ce.metadata.gltf=[];for(var ie in p.metadata.gltf)ce.metadata.gltf[ie]=p.metadata.gltf[ie];ce.metadata.gltf[Pe]={lastSelected:null,original:[],variants:{}};for(var Se=0,le=_e.original;Se<le.length;Se++){var _t=le[Se];ce.metadata.gltf[Pe].original.push({mesh:_t.mesh,material:_t.material})}for(var ie in _e.variants)if(Object.prototype.hasOwnProperty.call(_e.variants,ie)){ce.metadata.gltf[Pe].variants[ie]=[];for(var ot=0,gt=_e.variants[ie];ot<gt.length;ot++){var vt=gt[ot];ce.metadata.gltf[Pe].variants[ie].push({mesh:vt.mesh,material:vt.material})}}_e=ce.metadata.gltf[Pe]}for(var at=0,Et=_e.original;at<Et.length;at++){var We=Et[at];We.mesh===f&&(We.mesh=ge)}for(var st=0,x=_e.variants[I.name];st<x.length;st++){var We=x[st];We.mesh===f&&(We.mesh=ge)}})},D=0;D<C.variants.length;++D)k(D)}))},A=0;A<l.mappings.length;++A)b(A)}})),Promise.all(u).then(function(f){var d=f[0];return d})})},r}();W.RegisterExtension(Pe,function(r){return new Rc(r)});var Oc=function(){function r(n,e){var t=this;this._opaqueRenderTarget=null,this._opaqueMeshesCache=[],this._transparentMeshesCache=[],this._materialObservers={},this._options=Oe(Oe({},r._GetDefaultOptions()),n),this._scene=e,this._scene._transmissionHelper=this,this.onErrorObservable=new U,this._scene.onDisposeObservable.addOnce(function(){t.dispose()}),this._parseScene(),this._setupRenderTargets()}return r._GetDefaultOptions=function(){return{renderSize:1024,samples:4,lodGenerationScale:1,lodGenerationOffset:-4,renderTargetTextureType:ct.TEXTURETYPE_HALF_FLOAT,generateMipmaps:!0}},r.prototype.updateOptions=function(n){var e=this,t=Object.keys(n).filter(function(a){return e._options[a]!==n[a]});if(!!t.length){var i=Oe(Oe({},this._options),n),o=this._options;this._options=i,i.renderSize!==o.renderSize||i.renderTargetTextureType!==o.renderTargetTextureType||i.generateMipmaps!==o.generateMipmaps||!this._opaqueRenderTarget?this._setupRenderTargets():(this._opaqueRenderTarget.samples=i.samples,this._opaqueRenderTarget.lodGenerationScale=i.lodGenerationScale,this._opaqueRenderTarget.lodGenerationOffset=i.lodGenerationOffset)}},r.prototype.getOpaqueTarget=function(){return this._opaqueRenderTarget},r.prototype._shouldRenderAsTransmission=function(n){return n?!!(n instanceof me&&n.subSurface.isRefractionEnabled):!1},r.prototype._addMesh=function(n){var e=this;this._materialObservers[n.uniqueId]=n.onMaterialChangedObservable.add(this._onMeshMaterialChanged.bind(this)),z.SetImmediate(function(){e._shouldRenderAsTransmission(n.material)?(n.material.refractionTexture=e._opaqueRenderTarget,e._transparentMeshesCache.push(n)):e._opaqueMeshesCache.push(n)})},r.prototype._removeMesh=function(n){n.onMaterialChangedObservable.remove(this._materialObservers[n.uniqueId]),delete this._materialObservers[n.uniqueId];var e=this._transparentMeshesCache.indexOf(n);e!==-1&&this._transparentMeshesCache.splice(e,1),e=this._opaqueMeshesCache.indexOf(n),e!==-1&&this._opaqueMeshesCache.splice(e,1)},r.prototype._parseScene=function(){this._scene.meshes.forEach(this._addMesh.bind(this)),this._scene.onNewMeshAddedObservable.add(this._addMesh.bind(this)),this._scene.onMeshRemovedObservable.add(this._removeMesh.bind(this))},r.prototype._onMeshMaterialChanged=function(n){var e=this._transparentMeshesCache.indexOf(n),t=this._opaqueMeshesCache.indexOf(n),i=this._shouldRenderAsTransmission(n.material);i?(n.material instanceof me&&(n.material.subSurface.refractionTexture=this._opaqueRenderTarget),t!==-1?(this._opaqueMeshesCache.splice(t,1),this._transparentMeshesCache.push(n)):e===-1&&this._transparentMeshesCache.push(n)):e!==-1?(this._transparentMeshesCache.splice(e,1),this._opaqueMeshesCache.push(n)):t===-1&&this._opaqueMeshesCache.push(n)},r.prototype._setupRenderTargets=function(){var n=this,e,t;this._opaqueRenderTarget&&this._opaqueRenderTarget.dispose(),this._opaqueRenderTarget=new Vt("opaqueSceneTexture",this._options.renderSize,this._scene,this._options.generateMipmaps,void 0,this._options.renderTargetTextureType),this._opaqueRenderTarget.ignoreCameraViewport=!0,this._opaqueRenderTarget.renderList=this._opaqueMeshesCache,this._opaqueRenderTarget.clearColor=(t=(e=this._options.clearColor)===null||e===void 0?void 0:e.clone())!==null&&t!==void 0?t:this._scene.clearColor.clone(),this._opaqueRenderTarget.gammaSpace=!1,this._opaqueRenderTarget.lodGenerationScale=this._options.lodGenerationScale,this._opaqueRenderTarget.lodGenerationOffset=this._options.lodGenerationOffset,this._opaqueRenderTarget.samples=this._options.samples;var i,o;this._opaqueRenderTarget.onBeforeBindObservable.add(function(a){o=n._scene.environmentIntensity,n._scene.environmentIntensity=1,i=n._scene.imageProcessingConfiguration.applyByPostProcess,n._options.clearColor?a.clearColor.copyFrom(n._options.clearColor):n._scene.clearColor.toLinearSpaceToRef(a.clearColor),n._scene.imageProcessingConfiguration._applyByPostProcess=!0}),this._opaqueRenderTarget.onAfterUnbindObservable.add(function(){n._scene.environmentIntensity=o,n._scene.imageProcessingConfiguration._applyByPostProcess=i}),this._transparentMeshesCache.forEach(function(a){n._shouldRenderAsTransmission(a.material)&&(a.material.refractionTexture=n._opaqueRenderTarget)})},r.prototype.dispose=function(){this._scene._transmissionHelper=void 0,this._opaqueRenderTarget&&(this._opaqueRenderTarget.dispose(),this._opaqueRenderTarget=null),this._transparentMeshesCache=[],this._opaqueMeshesCache=[]},r}(),ni="KHR_materials_transmission",Nc=function(){function r(n){this.name=ni,this.order=175,this._loader=n,this.enabled=this._loader.isExtensionUsed(ni),this.enabled&&(n.parent.transparencyAsCoverage=!0)}return r.prototype.dispose=function(){this._loader=null},r.prototype.loadMaterialPropertiesAsync=function(n,e,t){var i=this;return W.LoadExtensionAsync(n,e,this.name,function(o,a){var s=new Array;return s.push(i._loader.loadMaterialBasePropertiesAsync(n,e,t)),s.push(i._loader.loadMaterialPropertiesAsync(n,e,t)),s.push(i._loadTransparentPropertiesAsync(o,e,t,a)),Promise.all(s).then(function(){})})},r.prototype._loadTransparentPropertiesAsync=function(n,e,t,i){if(!(t instanceof me))throw new Error("".concat(n,": Material type not supported"));var o=t;if(o.subSurface.isRefractionEnabled=!0,o.subSurface.volumeIndexOfRefraction=1,o.subSurface.useAlbedoToTintRefraction=!0,i.transmissionFactor!==void 0){o.subSurface.refractionIntensity=i.transmissionFactor;var a=o.getScene();o.subSurface.refractionIntensity&&!a._transmissionHelper&&new Oc({},o.getScene())}else return o.subSurface.refractionIntensity=0,o.subSurface.isRefractionEnabled=!1,Promise.resolve();return o.subSurface.minimumThickness=0,o.subSurface.maximumThickness=0,i.transmissionTexture?(i.transmissionTexture.nonColorData=!0,this._loader.loadTextureInfoAsync("".concat(n,"/transmissionTexture"),i.transmissionTexture,void 0).then(function(s){o.subSurface.refractionIntensityTexture=s,o.subSurface.useGltfStyleTextures=!0})):Promise.resolve()},r}();W.RegisterExtension(ni,function(r){return new Nc(r)});var ii="KHR_materials_translucency",Ic=function(){function r(n){this.name=ii,this.order=174,this._loader=n,this.enabled=this._loader.isExtensionUsed(ii),this.enabled&&(n.parent.transparencyAsCoverage=!0)}return r.prototype.dispose=function(){this._loader=null},r.prototype.loadMaterialPropertiesAsync=function(n,e,t){var i=this;return W.LoadExtensionAsync(n,e,this.name,function(o,a){var s=new Array;return s.push(i._loader.loadMaterialBasePropertiesAsync(n,e,t)),s.push(i._loader.loadMaterialPropertiesAsync(n,e,t)),s.push(i._loadTranslucentPropertiesAsync(o,e,t,a)),Promise.all(s).then(function(){})})},r.prototype._loadTranslucentPropertiesAsync=function(n,e,t,i){if(!(t instanceof me))throw new Error("".concat(n,": Material type not supported"));var o=t;if(o.subSurface.isTranslucencyEnabled=!0,o.subSurface.volumeIndexOfRefraction=1,o.subSurface.minimumThickness=0,o.subSurface.maximumThickness=0,o.subSurface.useAlbedoToTintTranslucency=!0,i.translucencyFactor!==void 0)o.subSurface.translucencyIntensity=i.translucencyFactor;else return o.subSurface.translucencyIntensity=0,o.subSurface.isTranslucencyEnabled=!1,Promise.resolve();return i.translucencyTexture?(i.translucencyTexture.nonColorData=!0,this._loader.loadTextureInfoAsync("".concat(n,"/translucencyTexture"),i.translucencyTexture).then(function(a){o.subSurface.translucencyIntensityTexture=a})):Promise.resolve()},r}();W.RegisterExtension(ii,function(r){return new Ic(r)});var ri="KHR_materials_volume",Pc=function(){function r(n){this.name=ri,this.order=173,this._loader=n,this.enabled=this._loader.isExtensionUsed(ri),this.enabled&&this._loader._disableInstancedMesh++}return r.prototype.dispose=function(){this.enabled&&this._loader._disableInstancedMesh--,this._loader=null},r.prototype.loadMaterialPropertiesAsync=function(n,e,t){var i=this;return W.LoadExtensionAsync(n,e,this.name,function(o,a){var s=new Array;return s.push(i._loader.loadMaterialBasePropertiesAsync(n,e,t)),s.push(i._loader.loadMaterialPropertiesAsync(n,e,t)),s.push(i._loadVolumePropertiesAsync(o,e,t,a)),Promise.all(s).then(function(){})})},r.prototype._loadVolumePropertiesAsync=function(n,e,t,i){if(!(t instanceof me))throw new Error("".concat(n,": Material type not supported"));if(!t.subSurface.isRefractionEnabled&&!t.subSurface.isTranslucencyEnabled||!i.thicknessFactor)return Promise.resolve();t.subSurface.volumeIndexOfRefraction=t.indexOfRefraction;var o=i.attenuationDistance!==void 0?i.attenuationDistance:Number.MAX_VALUE;return t.subSurface.tintColorAtDistance=o,i.attenuationColor!==void 0&&i.attenuationColor.length==3&&t.subSurface.tintColor.copyFromFloats(i.attenuationColor[0],i.attenuationColor[1],i.attenuationColor[2]),t.subSurface.minimumThickness=0,t.subSurface.maximumThickness=i.thicknessFactor,t.subSurface.useThicknessAsDepth=!0,i.thicknessTexture?(i.thicknessTexture.nonColorData=!0,this._loader.loadTextureInfoAsync("".concat(n,"/thicknessTexture"),i.thicknessTexture).then(function(a){t.subSurface.thicknessTexture=a,t.subSurface.useGltfStyleTextures=!0})):Promise.resolve()},r}();W.RegisterExtension(ri,function(r){return new Pc(r)});var oi="KHR_mesh_quantization",xc=function(){function r(n){this.name=oi,this.enabled=n.isExtensionUsed(oi)}return r.prototype.dispose=function(){},r}();W.RegisterExtension(oi,function(r){return new xc(r)});var ai="KHR_texture_basisu",Mc=function(){function r(n){this.name=ai,this._loader=n,this.enabled=n.isExtensionUsed(ai)}return r.prototype.dispose=function(){this._loader=null},r.prototype._loadTextureAsync=function(n,e,t){var i=this;return W.LoadExtensionAsync(n,e,this.name,function(o,a){var s=e.sampler==null?W.DefaultSampler:V.Get("".concat(n,"/sampler"),i._loader.gltf.samplers,e.sampler),c=V.Get("".concat(o,"/source"),i._loader.gltf.images,a.source);return i._loader._createTextureAsync(n,s,c,function(l){t(l)},e._textureInfo.nonColorData?{useRGBAIfASTCBC7NotAvailableWhenUASTC:!0}:void 0,!e._textureInfo.nonColorData)})},r}();W.RegisterExtension(ai,function(r){return new Mc(r)});var si="KHR_texture_transform",Lc=function(){function r(n){this.name=si,this._loader=n,this.enabled=this._loader.isExtensionUsed(si)}return r.prototype.dispose=function(){this._loader=null},r.prototype.loadTextureInfoAsync=function(n,e,t){var i=this;return W.LoadExtensionAsync(n,e,this.name,function(o,a){return i._loader.loadTextureInfoAsync(n,e,function(s){if(!(s instanceof X))throw new Error("".concat(o,": Texture type not supported"));a.offset&&(s.uOffset=a.offset[0],s.vOffset=a.offset[1]),s.uRotationCenter=0,s.vRotationCenter=0,a.rotation&&(s.wAng=-a.rotation),a.scale&&(s.uScale=a.scale[0],s.vScale=a.scale[1]),a.texCoord!=null&&(s.coordinatesIndex=a.texCoord),t(s)})})},r}();W.RegisterExtension(si,function(r){return new Lc(r)});var ci="KHR_xmp_json_ld",Fc=function(){function r(n){this.name=ci,this.order=100,this._loader=n,this.enabled=this._loader.isExtensionUsed(ci)}return r.prototype.dispose=function(){this._loader=null},r.prototype.onLoading=function(){var n,e,t;if(this._loader.rootBabylonMesh!==null){var i=(n=this._loader.gltf.extensions)===null||n===void 0?void 0:n.KHR_xmp_json_ld,o=(t=(e=this._loader.gltf.asset)===null||e===void 0?void 0:e.extensions)===null||t===void 0?void 0:t.KHR_xmp_json_ld;if(i&&o){var a=+o.packet;i.packets&&a<i.packets.length&&(this._loader.rootBabylonMesh.metadata=this._loader.rootBabylonMesh.metadata||{},this._loader.rootBabylonMesh.metadata.xmp=i.packets[a])}}},r}();W.RegisterExtension(ci,function(r){return new Fc(r)});var Dc=function(){function r(n,e,t){this.frame=n,this.action=e,this.onlyOnce=t,this.isDone=!1}return r.prototype._clone=function(){return new r(this.frame,this.action,this.onlyOnce)},r}(),Bc=function(){function r(n,e,t,i,o){i===void 0&&(i=null);var a=this,s,c,l,u,f;if(this.autoplay=!1,this._loop=!1,this.useCustomAttenuation=!1,this.isPlaying=!1,this.isPaused=!1,this.refDistance=1,this.rolloffFactor=1,this.maxDistance=100,this.distanceModel="linear",this.metadata=null,this.onEndedObservable=new U,this._spatialSound=!1,this._panningModel="equalpower",this._playbackRate=1,this._streaming=!1,this._startTime=0,this._startOffset=0,this._position=y.Zero(),this._localDirection=new y(1,0,0),this._volume=1,this._isReadyToPlay=!1,this._isDirectional=!1,this._coneInnerAngle=360,this._coneOuterAngle=360,this._coneOuterGain=0,this._isOutputConnected=!1,this._urlType="Unknown",this.name=n,t=t||Me.LastCreatedScene,!!t)if(this._scene=t,r._SceneComponentInitialization(t),this._readyToPlayCallback=i,this._customAttenuationFunction=function(S,C,O,B,k){return C<O?S*(1-C/O):0},o&&(this.autoplay=o.autoplay||!1,this._loop=o.loop||!1,o.volume!==void 0&&(this._volume=o.volume),this._spatialSound=(s=o.spatialSound)!==null&&s!==void 0?s:!1,this.maxDistance=(c=o.maxDistance)!==null&&c!==void 0?c:100,this.useCustomAttenuation=(l=o.useCustomAttenuation)!==null&&l!==void 0?l:!1,this.rolloffFactor=o.rolloffFactor||1,this.refDistance=o.refDistance||1,this.distanceModel=o.distanceModel||"linear",this._playbackRate=o.playbackRate||1,this._streaming=(u=o.streaming)!==null&&u!==void 0?u:!1,this._length=o.length,this._offset=o.offset),((f=j.audioEngine)===null||f===void 0?void 0:f.canUseWebAudio)&&j.audioEngine.audioContext){this._soundGain=j.audioEngine.audioContext.createGain(),this._soundGain.gain.value=this._volume,this._inputAudioNode=this._soundGain,this._outputAudioNode=this._soundGain,this._spatialSound&&this._createSpatialParameters(),this._scene.mainSoundTrack.addSound(this);var d=!0;if(e)try{typeof e=="string"?this._urlType="String":e instanceof ArrayBuffer?this._urlType="ArrayBuffer":e instanceof HTMLMediaElement?this._urlType="MediaElement":e instanceof MediaStream?this._urlType="MediaStream":Array.isArray(e)&&(this._urlType="Array");var p=[],m=!1;switch(this._urlType){case"MediaElement":this._streaming=!0,this._isReadyToPlay=!0,this._streamingSource=j.audioEngine.audioContext.createMediaElementSource(e),this.autoplay&&this.play(0,this._offset,this._length),this._readyToPlayCallback&&this._readyToPlayCallback();break;case"MediaStream":this._streaming=!0,this._isReadyToPlay=!0,this._streamingSource=j.audioEngine.audioContext.createMediaStreamSource(e),this.autoplay&&this.play(0,this._offset,this._length),this._readyToPlayCallback&&this._readyToPlayCallback();break;case"ArrayBuffer":e.byteLength>0&&(m=!0,this._soundLoaded(e));break;case"String":p.push(e);case"Array":p.length===0&&(p=e);for(var _=function(S){var C=p[S];if(m=o&&o.skipCodecCheck||C.indexOf(".mp3",C.length-4)!==-1&&j.audioEngine.isMP3supported||C.indexOf(".ogg",C.length-4)!==-1&&j.audioEngine.isOGGsupported||C.indexOf(".wav",C.length-4)!==-1||C.indexOf(".m4a",C.length-4)!==-1||C.indexOf(".mp4",C.length-4)!==-1||C.indexOf("blob:")!==-1,m)return v._streaming?(v._htmlAudioElement=new Audio(C),v._htmlAudioElement.controls=!1,v._htmlAudioElement.loop=v.loop,z.SetCorsBehavior(C,v._htmlAudioElement),v._htmlAudioElement.preload="auto",v._htmlAudioElement.addEventListener("canplaythrough",function(){a._isReadyToPlay=!0,a.autoplay&&a.play(0,a._offset,a._length),a._readyToPlayCallback&&a._readyToPlayCallback()}),document.body.appendChild(v._htmlAudioElement),v._htmlAudioElement.load()):v._scene._loadFile(C,function(O){a._soundLoaded(O)},void 0,!0,!0,function(O){O&&ne.Error("XHR "+O.status+" error on: "+C+"."),ne.Error("Sound creation aborted."),a._scene.mainSoundTrack.removeSound(a)}),"break"},v=this,b=0;b<p.length;b++){var A=_(b);if(A==="break")break}break;default:d=!1;break}d?m||(this._isReadyToPlay=!0,this._readyToPlayCallback&&window.setTimeout(function(){a._readyToPlayCallback&&a._readyToPlayCallback()},1e3)):ne.Error("Parameter must be a URL to the sound, an Array of URLs (.mp3 & .ogg) or an ArrayBuffer of the sound.")}catch{ne.Error("Unexpected error. Sound creation aborted."),this._scene.mainSoundTrack.removeSound(this)}}else this._scene.mainSoundTrack.addSound(this),j.audioEngine&&!j.audioEngine.WarnedWebAudioUnsupported&&(ne.Error("Web Audio is not supported by your browser."),j.audioEngine.WarnedWebAudioUnsupported=!0),this._readyToPlayCallback&&window.setTimeout(function(){a._readyToPlayCallback&&a._readyToPlayCallback()},1e3)}return Object.defineProperty(r.prototype,"loop",{get:function(){return this._loop},set:function(n){n!==this._loop&&(this._loop=n,this.updateOptions({loop:n}))},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"currentTime",{get:function(){var n;if(this._htmlAudioElement)return this._htmlAudioElement.currentTime;var e=this._startOffset;return this.isPlaying&&((n=j.audioEngine)===null||n===void 0?void 0:n.audioContext)&&(e+=j.audioEngine.audioContext.currentTime-this._startTime),e},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"spatialSound",{get:function(){return this._spatialSound},set:function(n){var e;this._spatialSound=n,this._spatialSound&&((e=j.audioEngine)===null||e===void 0?void 0:e.canUseWebAudio)&&j.audioEngine.audioContext&&this._createSpatialParameters()},enumerable:!1,configurable:!0}),r.prototype.dispose=function(){var n;!((n=j.audioEngine)===null||n===void 0)&&n.canUseWebAudio&&(this.isPlaying&&this.stop(),this._isReadyToPlay=!1,this.soundTrackId===-1?this._scene.mainSoundTrack.removeSound(this):this._scene.soundTracks&&this._scene.soundTracks[this.soundTrackId].removeSound(this),this._soundGain&&(this._soundGain.disconnect(),this._soundGain=null),this._soundPanner&&(this._soundPanner.disconnect(),this._soundPanner=null),this._soundSource&&(this._soundSource.disconnect(),this._soundSource=null),this._audioBuffer=null,this._htmlAudioElement&&(this._htmlAudioElement.pause(),this._htmlAudioElement.src="",document.body.removeChild(this._htmlAudioElement)),this._streamingSource&&this._streamingSource.disconnect(),this._connectedTransformNode&&this._registerFunc&&(this._connectedTransformNode.unregisterAfterWorldMatrixUpdate(this._registerFunc),this._connectedTransformNode=null))},r.prototype.isReady=function(){return this._isReadyToPlay},r.prototype.getClassName=function(){return"Sound"},r.prototype._soundLoaded=function(n){var e=this,t;!(!((t=j.audioEngine)===null||t===void 0)&&t.audioContext)||j.audioEngine.audioContext.decodeAudioData(n,function(i){e._audioBuffer=i,e._isReadyToPlay=!0,e.autoplay&&e.play(0,e._offset,e._length),e._readyToPlayCallback&&e._readyToPlayCallback()},function(i){ne.Error("Error while decoding audio data for: "+e.name+" / Error: "+i)})},r.prototype.setAudioBuffer=function(n){var e;!((e=j.audioEngine)===null||e===void 0)&&e.canUseWebAudio&&(this._audioBuffer=n,this._isReadyToPlay=!0)},r.prototype.updateOptions=function(n){var e,t,i,o,a,s,c,l,u,f;n&&(this.loop=(e=n.loop)!==null&&e!==void 0?e:this.loop,this.maxDistance=(t=n.maxDistance)!==null&&t!==void 0?t:this.maxDistance,this.useCustomAttenuation=(i=n.useCustomAttenuation)!==null&&i!==void 0?i:this.useCustomAttenuation,this.rolloffFactor=(o=n.rolloffFactor)!==null&&o!==void 0?o:this.rolloffFactor,this.refDistance=(a=n.refDistance)!==null&&a!==void 0?a:this.refDistance,this.distanceModel=(s=n.distanceModel)!==null&&s!==void 0?s:this.distanceModel,this._playbackRate=(c=n.playbackRate)!==null&&c!==void 0?c:this._playbackRate,this._length=(l=n.length)!==null&&l!==void 0?l:void 0,this._offset=(u=n.offset)!==null&&u!==void 0?u:void 0,this.setVolume((f=n.volume)!==null&&f!==void 0?f:this._volume),this._updateSpatialParameters(),this.isPlaying&&(this._streaming&&this._htmlAudioElement?(this._htmlAudioElement.playbackRate=this._playbackRate,this._htmlAudioElement.loop!==this.loop&&(this._htmlAudioElement.loop=this.loop)):this._soundSource&&(this._soundSource.playbackRate.value=this._playbackRate,this._soundSource.loop!==this.loop&&(this._soundSource.loop=this.loop),this._offset!==void 0&&this._soundSource.loopStart!==this._offset&&(this._soundSource.loopStart=this._offset),this._length!==void 0&&this._length!==this._soundSource.loopEnd&&(this._soundSource.loopEnd=(this._offset|0)+this._length))))},r.prototype._createSpatialParameters=function(){var n,e;((n=j.audioEngine)===null||n===void 0?void 0:n.canUseWebAudio)&&j.audioEngine.audioContext&&(this._scene.headphone&&(this._panningModel="HRTF"),this._soundPanner=(e=this._soundPanner)!==null&&e!==void 0?e:j.audioEngine.audioContext.createPanner(),this._soundPanner&&this._outputAudioNode&&(this._updateSpatialParameters(),this._soundPanner.connect(this._outputAudioNode),this._inputAudioNode=this._soundPanner))},r.prototype._updateSpatialParameters=function(){this._spatialSound&&this._soundPanner&&(this.useCustomAttenuation?(this._soundPanner.distanceModel="linear",this._soundPanner.maxDistance=Number.MAX_VALUE,this._soundPanner.refDistance=1,this._soundPanner.rolloffFactor=1,this._soundPanner.panningModel=this._panningModel):(this._soundPanner.distanceModel=this.distanceModel,this._soundPanner.maxDistance=this.maxDistance,this._soundPanner.refDistance=this.refDistance,this._soundPanner.rolloffFactor=this.rolloffFactor,this._soundPanner.panningModel=this._panningModel))},r.prototype.switchPanningModelToHRTF=function(){this._panningModel="HRTF",this._switchPanningModel()},r.prototype.switchPanningModelToEqualPower=function(){this._panningModel="equalpower",this._switchPanningModel()},r.prototype._switchPanningModel=function(){var n;((n=j.audioEngine)===null||n===void 0?void 0:n.canUseWebAudio)&&this._spatialSound&&this._soundPanner&&(this._soundPanner.panningModel=this._panningModel)},r.prototype.connectToSoundTrackAudioNode=function(n){var e;((e=j.audioEngine)===null||e===void 0?void 0:e.canUseWebAudio)&&this._outputAudioNode&&(this._isOutputConnected&&this._outputAudioNode.disconnect(),this._outputAudioNode.connect(n),this._isOutputConnected=!0)},r.prototype.setDirectionalCone=function(n,e,t){if(e<n){ne.Error("setDirectionalCone(): outer angle of the cone must be superior or equal to the inner angle.");return}this._coneInnerAngle=n,this._coneOuterAngle=e,this._coneOuterGain=t,this._isDirectional=!0,this.isPlaying&&this.loop&&(this.stop(),this.play(0,this._offset,this._length))},Object.defineProperty(r.prototype,"directionalConeInnerAngle",{get:function(){return this._coneInnerAngle},set:function(n){var e;if(n!=this._coneInnerAngle){if(this._coneOuterAngle<n){ne.Error("directionalConeInnerAngle: outer angle of the cone must be superior or equal to the inner angle.");return}this._coneInnerAngle=n,((e=j.audioEngine)===null||e===void 0?void 0:e.canUseWebAudio)&&this._spatialSound&&this._soundPanner&&(this._soundPanner.coneInnerAngle=this._coneInnerAngle)}},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"directionalConeOuterAngle",{get:function(){return this._coneOuterAngle},set:function(n){var e;if(n!=this._coneOuterAngle){if(n<this._coneInnerAngle){ne.Error("directionalConeOuterAngle: outer angle of the cone must be superior or equal to the inner angle.");return}this._coneOuterAngle=n,((e=j.audioEngine)===null||e===void 0?void 0:e.canUseWebAudio)&&this._spatialSound&&this._soundPanner&&(this._soundPanner.coneOuterAngle=this._coneOuterAngle)}},enumerable:!1,configurable:!0}),r.prototype.setPosition=function(n){var e;n.equals(this._position)||(this._position.copyFrom(n),((e=j.audioEngine)===null||e===void 0?void 0:e.canUseWebAudio)&&this._spatialSound&&this._soundPanner&&!isNaN(this._position.x)&&!isNaN(this._position.y)&&!isNaN(this._position.z)&&(this._soundPanner.positionX.value=this._position.x,this._soundPanner.positionY.value=this._position.y,this._soundPanner.positionZ.value=this._position.z))},r.prototype.setLocalDirectionToMesh=function(n){var e;this._localDirection=n,((e=j.audioEngine)===null||e===void 0?void 0:e.canUseWebAudio)&&this._connectedTransformNode&&this.isPlaying&&this._updateDirection()},r.prototype._updateDirection=function(){if(!(!this._connectedTransformNode||!this._soundPanner)){var n=this._connectedTransformNode.getWorldMatrix(),e=y.TransformNormal(this._localDirection,n);e.normalize(),this._soundPanner.orientationX.value=e.x,this._soundPanner.orientationY.value=e.y,this._soundPanner.orientationZ.value=e.z}},r.prototype.updateDistanceFromListener=function(){var n;if(((n=j.audioEngine)===null||n===void 0?void 0:n.canUseWebAudio)&&this._connectedTransformNode&&this.useCustomAttenuation&&this._soundGain&&this._scene.activeCamera){var e=this._connectedTransformNode.getDistanceToCamera(this._scene.activeCamera);this._soundGain.gain.value=this._customAttenuationFunction(this._volume,e,this.maxDistance,this.refDistance,this.rolloffFactor)}},r.prototype.setAttenuationFunction=function(n){this._customAttenuationFunction=n},r.prototype.play=function(n,e,t){var i=this,o,a,s,c;if(this._isReadyToPlay&&this._scene.audioEnabled&&((o=j.audioEngine)===null||o===void 0?void 0:o.audioContext))try{this._startOffset<0&&(n=-this._startOffset,this._startOffset=0);var l=n?((a=j.audioEngine)===null||a===void 0?void 0:a.audioContext.currentTime)+n:(s=j.audioEngine)===null||s===void 0?void 0:s.audioContext.currentTime;if((!this._soundSource||!this._streamingSource)&&this._spatialSound&&this._soundPanner&&(!isNaN(this._position.x)&&!isNaN(this._position.y)&&!isNaN(this._position.z)&&(this._soundPanner.positionX.value=this._position.x,this._soundPanner.positionY.value=this._position.y,this._soundPanner.positionZ.value=this._position.z),this._isDirectional&&(this._soundPanner.coneInnerAngle=this._coneInnerAngle,this._soundPanner.coneOuterAngle=this._coneOuterAngle,this._soundPanner.coneOuterGain=this._coneOuterGain,this._connectedTransformNode?this._updateDirection():this._soundPanner.setOrientation(this._localDirection.x,this._localDirection.y,this._localDirection.z))),this._streaming){if(this._streamingSource||(this._streamingSource=j.audioEngine.audioContext.createMediaElementSource(this._htmlAudioElement),this._htmlAudioElement.onended=function(){i._onended()},this._htmlAudioElement.playbackRate=this._playbackRate),this._streamingSource.disconnect(),this._inputAudioNode&&this._streamingSource.connect(this._inputAudioNode),this._htmlAudioElement){var u=function(){var d,p;if(!((d=j.audioEngine)===null||d===void 0)&&d.unlocked){var m=i._htmlAudioElement.play();m!==void 0&&m.catch(function(){var _,v;(_=j.audioEngine)===null||_===void 0||_.lock(),(i.loop||i.autoplay)&&((v=j.audioEngine)===null||v===void 0||v.onAudioUnlockedObservable.addOnce(function(){u()}))})}else(i.loop||i.autoplay)&&((p=j.audioEngine)===null||p===void 0||p.onAudioUnlockedObservable.addOnce(function(){u()}))};u()}}else{var f=function(){var d,p,m;if(!((d=j.audioEngine)===null||d===void 0)&&d.audioContext){if(t=t||i._length,e=e||i._offset,i._soundSource){var _=i._soundSource;_.onended=function(){_.disconnect()}}if(i._soundSource=(p=j.audioEngine)===null||p===void 0?void 0:p.audioContext.createBufferSource(),i._soundSource&&i._inputAudioNode){i._soundSource.buffer=i._audioBuffer,i._soundSource.connect(i._inputAudioNode),i._soundSource.loop=i.loop,e!==void 0&&(i._soundSource.loopStart=e),t!==void 0&&(i._soundSource.loopEnd=(e|0)+t),i._soundSource.playbackRate.value=i._playbackRate,i._soundSource.onended=function(){i._onended()},l=n?((m=j.audioEngine)===null||m===void 0?void 0:m.audioContext.currentTime)+n:j.audioEngine.audioContext.currentTime;var v=i.isPaused?i._startOffset%i._soundSource.buffer.duration:e||0;i._soundSource.start(l,v,i.loop?void 0:t)}}};((c=j.audioEngine)===null||c===void 0?void 0:c.audioContext.state)==="suspended"?setTimeout(function(){var d;((d=j.audioEngine)===null||d===void 0?void 0:d.audioContext.state)==="suspended"?(j.audioEngine.lock(),(i.loop||i.autoplay)&&j.audioEngine.onAudioUnlockedObservable.addOnce(function(){f()})):f()},500):f()}this._startTime=l,this.isPlaying=!0,this.isPaused=!1}catch(d){ne.Error("Error while trying to play audio: "+this.name+", "+d.message)}},r.prototype._onended=function(){this.isPlaying=!1,this._startOffset=0,this.onended&&this.onended(),this.onEndedObservable.notifyObservers(this)},r.prototype.stop=function(n){var e=this,t;if(this.isPlaying){if(this._streaming)this._htmlAudioElement?(this._htmlAudioElement.pause(),this._htmlAudioElement.currentTime>0&&(this._htmlAudioElement.currentTime=0)):this._streamingSource.disconnect(),this.isPlaying=!1;else if(((t=j.audioEngine)===null||t===void 0?void 0:t.audioContext)&&this._soundSource){var i=n?j.audioEngine.audioContext.currentTime+n:void 0;this._soundSource.stop(i),i===void 0?(this.isPlaying=!1,this._soundSource.onended=function(){}):this._soundSource.onended=function(){e.isPlaying=!1},this.isPaused||(this._startOffset=0)}}},r.prototype.pause=function(){var n;this.isPlaying&&(this.isPaused=!0,this._streaming?(this._htmlAudioElement?this._htmlAudioElement.pause():this._streamingSource.disconnect(),this.isPlaying=!1):!((n=j.audioEngine)===null||n===void 0)&&n.audioContext&&(this.stop(0),this._startOffset+=j.audioEngine.audioContext.currentTime-this._startTime))},r.prototype.setVolume=function(n,e){var t;((t=j.audioEngine)===null||t===void 0?void 0:t.canUseWebAudio)&&this._soundGain&&(e&&j.audioEngine.audioContext?(this._soundGain.gain.cancelScheduledValues(j.audioEngine.audioContext.currentTime),this._soundGain.gain.setValueAtTime(this._soundGain.gain.value,j.audioEngine.audioContext.currentTime),this._soundGain.gain.linearRampToValueAtTime(n,j.audioEngine.audioContext.currentTime+e)):this._soundGain.gain.value=n),this._volume=n},r.prototype.setPlaybackRate=function(n){this._playbackRate=n,this.isPlaying&&(this._streaming&&this._htmlAudioElement?this._htmlAudioElement.playbackRate=this._playbackRate:this._soundSource&&(this._soundSource.playbackRate.value=this._playbackRate))},r.prototype.getVolume=function(){return this._volume},r.prototype.attachToMesh=function(n){var e=this;this._connectedTransformNode&&this._registerFunc&&(this._connectedTransformNode.unregisterAfterWorldMatrixUpdate(this._registerFunc),this._registerFunc=null),this._connectedTransformNode=n,this._spatialSound||(this._spatialSound=!0,this._createSpatialParameters(),this.isPlaying&&this.loop&&(this.stop(),this.play(0,this._offset,this._length))),this._onRegisterAfterWorldMatrixUpdate(this._connectedTransformNode),this._registerFunc=function(t){return e._onRegisterAfterWorldMatrixUpdate(t)},this._connectedTransformNode.registerAfterWorldMatrixUpdate(this._registerFunc)},r.prototype.detachFromMesh=function(){this._connectedTransformNode&&this._registerFunc&&(this._connectedTransformNode.unregisterAfterWorldMatrixUpdate(this._registerFunc),this._registerFunc=null,this._connectedTransformNode=null)},r.prototype._onRegisterAfterWorldMatrixUpdate=function(n){var e;if(!n.getBoundingInfo)this.setPosition(n.absolutePosition);else{var t=n,i=t.getBoundingInfo();this.setPosition(i.boundingSphere.centerWorld)}((e=j.audioEngine)===null||e===void 0?void 0:e.canUseWebAudio)&&this._isDirectional&&this.isPlaying&&this._updateDirection()},r.prototype.clone=function(){var n=this;if(this._streaming)return null;var e=function(){n._isReadyToPlay?(i._audioBuffer=n.getAudioBuffer(),i._isReadyToPlay=!0,i.autoplay&&i.play(0,n._offset,n._length)):window.setTimeout(e,300)},t={autoplay:this.autoplay,loop:this.loop,volume:this._volume,spatialSound:this._spatialSound,maxDistance:this.maxDistance,useCustomAttenuation:this.useCustomAttenuation,rolloffFactor:this.rolloffFactor,refDistance:this.refDistance,distanceModel:this.distanceModel},i=new r(this.name+"_cloned",new ArrayBuffer(0),this._scene,null,t);return this.useCustomAttenuation&&i.setAttenuationFunction(this._customAttenuationFunction),i.setPosition(this._position),i.setPlaybackRate(this._playbackRate),e(),i},r.prototype.getAudioBuffer=function(){return this._audioBuffer},r.prototype.getSoundSource=function(){return this._soundSource},r.prototype.getSoundGain=function(){return this._soundGain},r.prototype.serialize=function(){var n={name:this.name,url:this.name,autoplay:this.autoplay,loop:this.loop,volume:this._volume,spatialSound:this._spatialSound,maxDistance:this.maxDistance,rolloffFactor:this.rolloffFactor,refDistance:this.refDistance,distanceModel:this.distanceModel,playbackRate:this._playbackRate,panningModel:this._panningModel,soundTrackId:this.soundTrackId,metadata:this.metadata};return this._spatialSound&&(this._connectedTransformNode&&(n.connectedMeshId=this._connectedTransformNode.id),n.position=this._position.asArray(),n.refDistance=this.refDistance,n.distanceModel=this.distanceModel,n.isDirectional=this._isDirectional,n.localDirectionToMesh=this._localDirection.asArray(),n.coneInnerAngle=this._coneInnerAngle,n.coneOuterAngle=this._coneOuterAngle,n.coneOuterGain=this._coneOuterGain),n},r.Parse=function(n,e,t,i){var o=n.name,a;n.url?a=t+n.url:a=t+o;var s={autoplay:n.autoplay,loop:n.loop,volume:n.volume,spatialSound:n.spatialSound,maxDistance:n.maxDistance,rolloffFactor:n.rolloffFactor,refDistance:n.refDistance,distanceModel:n.distanceModel,playbackRate:n.playbackRate},c;if(!i)c=new r(o,a,e,function(){e._removePendingData(c)},s),e._addPendingData(c);else{var l=function(){i._isReadyToPlay?(c._audioBuffer=i.getAudioBuffer(),c._isReadyToPlay=!0,c.autoplay&&c.play(0,c._offset,c._length)):window.setTimeout(l,300)};c=new r(o,new ArrayBuffer(0),e,null,s),l()}if(n.position){var u=y.FromArray(n.position);c.setPosition(u)}if(n.isDirectional&&(c.setDirectionalCone(n.coneInnerAngle||360,n.coneOuterAngle||360,n.coneOuterGain||0),n.localDirectionToMesh)){var f=y.FromArray(n.localDirectionToMesh);c.setLocalDirectionToMesh(f)}if(n.connectedMeshId){var d=e.getMeshById(n.connectedMeshId);d&&c.attachToMesh(d)}return n.metadata&&(c.metadata=n.metadata),c},r._SceneComponentInitialization=function(n){throw No("AudioSceneComponent")},r}(),wc=function(){function r(n,e,t){var i=this;if(this.loop=!1,this._coneInnerAngle=360,this._coneOuterAngle=360,this._volume=1,this.isPlaying=!1,this.isPaused=!1,this._sounds=[],this._weights=[],e.length!==t.length)throw new Error("Sounds length does not equal weights length");this.loop=n,this._weights=t;for(var o=0,a=0,s=t;a<s.length;a++){var c=s[a];o+=c}for(var l=o>0?1/o:0,u=0;u<this._weights.length;u++)this._weights[u]*=l;this._sounds=e;for(var f=0,d=this._sounds;f<d.length;f++){var p=d[f];p.onEndedObservable.add(function(){i._onended()})}}return Object.defineProperty(r.prototype,"directionalConeInnerAngle",{get:function(){return this._coneInnerAngle},set:function(n){if(n!==this._coneInnerAngle){if(this._coneOuterAngle<n){ne.Error("directionalConeInnerAngle: outer angle of the cone must be superior or equal to the inner angle.");return}this._coneInnerAngle=n;for(var e=0,t=this._sounds;e<t.length;e++){var i=t[e];i.directionalConeInnerAngle=n}}},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"directionalConeOuterAngle",{get:function(){return this._coneOuterAngle},set:function(n){if(n!==this._coneOuterAngle){if(n<this._coneInnerAngle){ne.Error("directionalConeOuterAngle: outer angle of the cone must be superior or equal to the inner angle.");return}this._coneOuterAngle=n;for(var e=0,t=this._sounds;e<t.length;e++){var i=t[e];i.directionalConeOuterAngle=n}}},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"volume",{get:function(){return this._volume},set:function(n){if(n!==this._volume)for(var e=0,t=this._sounds;e<t.length;e++){var i=t[e];i.setVolume(n)}},enumerable:!1,configurable:!0}),r.prototype._onended=function(){this._currentIndex!==void 0&&(this._sounds[this._currentIndex].autoplay=!1),this.loop&&this.isPlaying?this.play():this.isPlaying=!1},r.prototype.pause=function(){this.isPaused=!0,this._currentIndex!==void 0&&this._sounds[this._currentIndex].pause()},r.prototype.stop=function(){this.isPlaying=!1,this._currentIndex!==void 0&&this._sounds[this._currentIndex].stop()},r.prototype.play=function(n){if(!this.isPaused){this.stop();for(var e=Math.random(),t=0,i=0;i<this._weights.length;i++)if(t+=this._weights[i],e<=t){this._currentIndex=i;break}}var o=this._sounds[this._currentIndex];o.isReady()?o.play(0,this.isPaused?void 0:n):o.autoplay=!0,this.isPlaying=!0,this.isPaused=!1},r}(),li="MSFT_audio_emitter",Vc=function(){function r(n){this.name=li,this._loader=n,this.enabled=this._loader.isExtensionUsed(li)}return r.prototype.dispose=function(){this._loader=null,this._clips=null,this._emitters=null},r.prototype.onLoading=function(){var n=this._loader.gltf.extensions;if(n&&n[this.name]){var e=n[this.name];this._clips=e.clips,this._emitters=e.emitters,V.Assign(this._clips),V.Assign(this._emitters)}},r.prototype.loadSceneAsync=function(n,e){var t=this;return W.LoadExtensionAsync(n,e,this.name,function(i,o){var a=new Array;a.push(t._loader.loadSceneAsync(n,e));for(var s=0,c=o.emitters;s<c.length;s++){var l=c[s],u=V.Get("".concat(i,"/emitters"),t._emitters,l);if(u.refDistance!=null||u.maxDistance!=null||u.rolloffFactor!=null||u.distanceModel!=null||u.innerAngle!=null||u.outerAngle!=null)throw new Error("".concat(i,": Direction or Distance properties are not allowed on emitters attached to a scene"));a.push(t._loadEmitterAsync("".concat(i,"/emitters/").concat(u.index),u))}return Promise.all(a).then(function(){})})},r.prototype.loadNodeAsync=function(n,e,t){var i=this;return W.LoadExtensionAsync(n,e,this.name,function(o,a){var s=new Array;return i._loader.loadNodeAsync(o,e,function(c){for(var l=function(p){var m=V.Get("".concat(o,"/emitters"),i._emitters,p);s.push(i._loadEmitterAsync("".concat(o,"/emitters/").concat(m.index),m).then(function(){for(var _=0,v=m._babylonSounds;_<v.length;_++){var b=v[_];b.attachToMesh(c),(m.innerAngle!=null||m.outerAngle!=null)&&(b.setLocalDirectionToMesh(y.Forward()),b.setDirectionalCone(2*z.ToDegrees(m.innerAngle==null?Math.PI:m.innerAngle),2*z.ToDegrees(m.outerAngle==null?Math.PI:m.outerAngle),0))}}))},u=0,f=a.emitters;u<f.length;u++){var d=f[u];l(d)}t(c)}).then(function(c){return Promise.all(s).then(function(){return c})})})},r.prototype.loadAnimationAsync=function(n,e){var t=this;return W.LoadExtensionAsync(n,e,this.name,function(i,o){return t._loader.loadAnimationAsync(n,e).then(function(a){var s=new Array;V.Assign(o.events);for(var c=0,l=o.events;c<l.length;c++){var u=l[c];s.push(t._loadAnimationEventAsync("".concat(i,"/events/").concat(u.index),n,e,u,a))}return Promise.all(s).then(function(){return a})})})},r.prototype._loadClipAsync=function(n,e){if(e._objectURL)return e._objectURL;var t;if(e.uri)t=this._loader.loadUriAsync(n,e,e.uri);else{var i=V.Get("".concat(n,"/bufferView"),this._loader.gltf.bufferViews,e.bufferView);t=this._loader.loadBufferViewAsync("/bufferViews/".concat(i.index),i)}return e._objectURL=t.then(function(o){return URL.createObjectURL(new Blob([o],{type:e.mimeType}))}),e._objectURL},r.prototype._loadEmitterAsync=function(n,e){var t=this;if(e._babylonSounds=e._babylonSounds||[],!e._babylonData){for(var i=new Array,o=e.name||"emitter".concat(e.index),a={loop:!1,autoplay:!1,volume:e.volume==null?1:e.volume},s=function(f){var d="/extensions/".concat(c.name,"/clips"),p=V.Get(d,c._clips,e.clips[f].clip);i.push(c._loadClipAsync("".concat(d,"/").concat(e.clips[f].clip),p).then(function(m){var _=e._babylonSounds[f]=new Bc(o,m,t._loader.babylonScene,null,a);_.refDistance=e.refDistance||1,_.maxDistance=e.maxDistance||256,_.rolloffFactor=e.rolloffFactor||1,_.distanceModel=e.distanceModel||"exponential"}))},c=this,l=0;l<e.clips.length;l++)s(l);var u=Promise.all(i).then(function(){var f=e.clips.map(function(p){return p.weight||1}),d=new wc(e.loop||!1,e._babylonSounds,f);e.innerAngle&&(d.directionalConeInnerAngle=2*z.ToDegrees(e.innerAngle)),e.outerAngle&&(d.directionalConeOuterAngle=2*z.ToDegrees(e.outerAngle)),e.volume&&(d.volume=e.volume),e._babylonData.sound=d});e._babylonData={loaded:u}}return e._babylonData.loaded},r.prototype._getEventAction=function(n,e,t,i,o){switch(t){case"play":return function(a){var s=(o||0)+(a-i);e.play(s)};case"stop":return function(){e.stop()};case"pause":return function(){e.pause()};default:throw new Error("".concat(n,": Unsupported action ").concat(t))}},r.prototype._loadAnimationEventAsync=function(n,e,t,i,o){var a=this;if(o.targetedAnimations.length==0)return Promise.resolve();var s=o.targetedAnimations[0],c=i.emitter,l=V.Get("/extensions/".concat(this.name,"/emitters"),this._emitters,c);return this._loadEmitterAsync(n,l).then(function(){var u=l._babylonData.sound;if(u){var f=new Dc(i.time,a._getEventAction(n,u,i.action,i.time,i.startOffset));s.animation.addEvent(f),o.onAnimationGroupEndObservable.add(function(){u.stop()}),o.onAnimationGroupPauseObservable.add(function(){u.pause()})}})},r}();W.RegisterExtension(li,function(r){return new Vc(r)});var ui="MSFT_lod",Uc=function(){function r(n){this.name=ui,this.order=100,this.maxLODsToLoad=10,this.onNodeLODsLoadedObservable=new U,this.onMaterialLODsLoadedObservable=new U,this._bufferLODs=new Array,this._nodeIndexLOD=null,this._nodeSignalLODs=new Array,this._nodePromiseLODs=new Array,this._nodeBufferLODs=new Array,this._materialIndexLOD=null,this._materialSignalLODs=new Array,this._materialPromiseLODs=new Array,this._materialBufferLODs=new Array,this._loader=n,this.enabled=this._loader.isExtensionUsed(ui)}return r.prototype.dispose=function(){this._loader=null,this._nodeIndexLOD=null,this._nodeSignalLODs.length=0,this._nodePromiseLODs.length=0,this._nodeBufferLODs.length=0,this._materialIndexLOD=null,this._materialSignalLODs.length=0,this._materialPromiseLODs.length=0,this._materialBufferLODs.length=0,this.onMaterialLODsLoadedObservable.clear(),this.onNodeLODsLoadedObservable.clear()},r.prototype.onReady=function(){for(var n=this,e=function(s){var c=Promise.all(t._nodePromiseLODs[s]).then(function(){s!==0&&(n._loader.endPerformanceCounter("Node LOD ".concat(s)),n._loader.log("Loaded node LOD ".concat(s))),n.onNodeLODsLoadedObservable.notifyObservers(s),s!==n._nodePromiseLODs.length-1&&(n._loader.startPerformanceCounter("Node LOD ".concat(s+1)),n._loadBufferLOD(n._nodeBufferLODs,s+1),n._nodeSignalLODs[s]&&n._nodeSignalLODs[s].resolve())});t._loader._completePromises.push(c)},t=this,i=0;i<this._nodePromiseLODs.length;i++)e(i);for(var o=function(s){var c=Promise.all(a._materialPromiseLODs[s]).then(function(){s!==0&&(n._loader.endPerformanceCounter("Material LOD ".concat(s)),n._loader.log("Loaded material LOD ".concat(s))),n.onMaterialLODsLoadedObservable.notifyObservers(s),s!==n._materialPromiseLODs.length-1&&(n._loader.startPerformanceCounter("Material LOD ".concat(s+1)),n._loadBufferLOD(n._materialBufferLODs,s+1),n._materialSignalLODs[s]&&n._materialSignalLODs[s].resolve())});a._loader._completePromises.push(c)},a=this,i=0;i<this._materialPromiseLODs.length;i++)o(i)},r.prototype.loadSceneAsync=function(n,e){var t=this._loader.loadSceneAsync(n,e);return this._loadBufferLOD(this._bufferLODs,0),t},r.prototype.loadNodeAsync=function(n,e,t){var i=this;return W.LoadExtensionAsync(n,e,this.name,function(o,a){var s,c=i._getLODs(o,e,i._loader.gltf.nodes,a.ids);i._loader.logOpen("".concat(o));for(var l=function(f){var d=c[f];f!==0&&(i._nodeIndexLOD=f,i._nodeSignalLODs[f]=i._nodeSignalLODs[f]||new Dt);var p=function(_){t(_),_.setEnabled(!1)},m=i._loader.loadNodeAsync("/nodes/".concat(d.index),d,p).then(function(_){if(f!==0){var v=c[f-1];v._babylonTransformNode&&(i._disposeTransformNode(v._babylonTransformNode),delete v._babylonTransformNode)}return _.setEnabled(!0),_});i._nodePromiseLODs[f]=i._nodePromiseLODs[f]||[],f===0?s=m:(i._nodeIndexLOD=null,i._nodePromiseLODs[f].push(m))},u=0;u<c.length;u++)l(u);return i._loader.logClose(),s})},r.prototype._loadMaterialAsync=function(n,e,t,i,o){var a=this;return this._nodeIndexLOD?null:W.LoadExtensionAsync(n,e,this.name,function(s,c){var l,u=a._getLODs(s,e,a._loader.gltf.materials,c.ids);a._loader.logOpen("".concat(s));for(var f=function(p){var m=u[p];p!==0&&(a._materialIndexLOD=p);var _=a._loader._loadMaterialAsync("/materials/".concat(m.index),m,t,i,function(v){p===0&&o(v)}).then(function(v){if(p!==0){o(v);var b=u[p-1]._data;b[i]&&(a._disposeMaterials([b[i].babylonMaterial]),delete b[i])}return v});a._materialPromiseLODs[p]=a._materialPromiseLODs[p]||[],p===0?l=_:(a._materialIndexLOD=null,a._materialPromiseLODs[p].push(_))},d=0;d<u.length;d++)f(d);return a._loader.logClose(),l})},r.prototype._loadUriAsync=function(n,e,t){var i=this;if(this._nodeIndexLOD!==null){this._loader.log("deferred");var o=this._nodeIndexLOD-1;return this._nodeSignalLODs[o]=this._nodeSignalLODs[o]||new Dt,this._nodeSignalLODs[this._nodeIndexLOD-1].promise.then(function(){return i._loader.loadUriAsync(n,e,t)})}else if(this._materialIndexLOD!==null){this._loader.log("deferred");var o=this._materialIndexLOD-1;return this._materialSignalLODs[o]=this._materialSignalLODs[o]||new Dt,this._materialSignalLODs[o].promise.then(function(){return i._loader.loadUriAsync(n,e,t)})}return null},r.prototype.loadBufferAsync=function(n,e,t,i){if(this._loader.parent.useRangeRequests&&!e.uri){if(!this._loader.bin)throw new Error("".concat(n,": Uri is missing or the binary glTF is missing its binary chunk"));var o=function(a,s){var c=t,l=c+i-1,u=a[s];return u?(u.start=Math.min(u.start,c),u.end=Math.max(u.end,l)):(u={start:c,end:l,loaded:new Dt},a[s]=u),u.loaded.promise.then(function(f){return new Uint8Array(f.buffer,f.byteOffset+t-u.start,i)})};return this._loader.log("deferred"),this._nodeIndexLOD!==null?o(this._nodeBufferLODs,this._nodeIndexLOD):this._materialIndexLOD!==null?o(this._materialBufferLODs,this._materialIndexLOD):o(this._bufferLODs,0)}return null},r.prototype._loadBufferLOD=function(n,e){var t=n[e];t&&(this._loader.log("Loading buffer range [".concat(t.start,"-").concat(t.end,"]")),this._loader.bin.readAsync(t.start,t.end-t.start+1).then(function(i){t.loaded.resolve(i)},function(i){t.loaded.reject(i)}))},r.prototype._getLODs=function(n,e,t,i){if(this.maxLODsToLoad<=0)throw new Error("maxLODsToLoad must be greater than zero");for(var o=new Array,a=i.length-1;a>=0;a--)if(o.push(V.Get("".concat(n,"/ids/").concat(i[a]),t,i[a])),o.length===this.maxLODsToLoad)return o;return o.push(e),o},r.prototype._disposeTransformNode=function(n){var e=this,t=new Array,i=n.material;i&&t.push(i);for(var o=0,a=n.getChildMeshes();o<a.length;o++){var s=a[o];s.material&&t.push(s.material)}n.dispose();var c=t.filter(function(l){return e._loader.babylonScene.meshes.every(function(u){return u.material!=l})});this._disposeMaterials(c)},r.prototype._disposeMaterials=function(n){for(var e={},t=0,i=n;t<i.length;t++){for(var o=i[t],a=0,s=o.getActiveTextures();a<s.length;a++){var c=s[a];e[c.uniqueId]=c}o.dispose()}for(var l in e)for(var u=0,f=this._loader.babylonScene.materials;u<f.length;u++){var o=f[u];o.hasTexture(e[l])&&delete e[l]}for(var l in e)e[l].dispose()},r}();W.RegisterExtension(ui,function(r){return new Uc(r)});var fi="MSFT_minecraftMesh",kc=function(){function r(n){this.name=fi,this._loader=n,this.enabled=this._loader.isExtensionUsed(fi)}return r.prototype.dispose=function(){this._loader=null},r.prototype.loadMaterialPropertiesAsync=function(n,e,t){var i=this;return W.LoadExtraAsync(n,e,this.name,function(o,a){if(a){if(!(t instanceof me))throw new Error("".concat(o,": Material type not supported"));var s=i._loader.loadMaterialPropertiesAsync(n,e,t);return t.needAlphaBlending()&&(t.forceDepthWrite=!0,t.separateCullingPass=!0),t.backFaceCulling=t.forceDepthWrite,t.twoSidedLighting=!0,s}return null})},r}();W.RegisterExtension(fi,function(r){return new kc(r)});var hi="MSFT_sRGBFactors",Gc=function(){function r(n){this.name=hi,this._loader=n,this.enabled=this._loader.isExtensionUsed(hi)}return r.prototype.dispose=function(){this._loader=null},r.prototype.loadMaterialPropertiesAsync=function(n,e,t){var i=this;return W.LoadExtraAsync(n,e,this.name,function(o,a){if(a){if(!(t instanceof me))throw new Error("".concat(o,": Material type not supported"));var s=i._loader.loadMaterialPropertiesAsync(n,e,t);return t.albedoTexture||t.albedoColor.toLinearSpaceToRef(t.albedoColor),t.reflectivityTexture||t.reflectivityColor.toLinearSpaceToRef(t.reflectivityColor),s}return null})},r}();W.RegisterExtension(hi,function(r){return new Gc(r)});var Mr="ExtrasAsMetadata",Hc=function(){function r(n){this.name=Mr,this.enabled=!0,this._loader=n}return r.prototype._assignExtras=function(n,e){if(e.extras&&Object.keys(e.extras).length>0){var t=n.metadata=n.metadata||{},i=t.gltf=t.gltf||{};i.extras=e.extras}},r.prototype.dispose=function(){this._loader=null},r.prototype.loadNodeAsync=function(n,e,t){var i=this;return this._loader.loadNodeAsync(n,e,function(o){i._assignExtras(o,e),t(o)})},r.prototype.loadCameraAsync=function(n,e,t){var i=this;return this._loader.loadCameraAsync(n,e,function(o){i._assignExtras(o,e),t(o)})},r.prototype.createMaterial=function(n,e,t){var i=this._loader.createMaterial(n,e,t);return this._assignExtras(i,e),i},r}();W.RegisterExtension(Mr,function(r){return new Hc(r)});var zc=function(r){R(n,r);function n(e){var t=r.call(this,e,g.Vertex)||this;return t.registerInput("matricesIndices",h.Vector4),t.registerInput("matricesWeights",h.Vector4),t.registerInput("matricesIndicesExtra",h.Vector4,!0),t.registerInput("matricesWeightsExtra",h.Vector4,!0),t.registerInput("world",h.Matrix),t.registerOutput("output",h.Matrix),t}return n.prototype.initialize=function(e){e._excludeVariableName("boneSampler"),e._excludeVariableName("boneTextureWidth"),e._excludeVariableName("mBones"),e._excludeVariableName("BonesPerMesh")},n.prototype.getClassName=function(){return"BonesBlock"},Object.defineProperty(n.prototype,"matricesIndices",{get:function(){return this._inputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"matricesWeights",{get:function(){return this._inputs[1]},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"matricesIndicesExtra",{get:function(){return this._inputs[2]},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"matricesWeightsExtra",{get:function(){return this._inputs[3]},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"world",{get:function(){return this._inputs[4]},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"output",{get:function(){return this._outputs[0]},enumerable:!1,configurable:!0}),n.prototype.autoConfigure=function(e){if(!this.matricesIndices.isConnected){var t=e.getInputBlockByPredicate(function(a){return a.isAttribute&&a.name==="matricesIndices"});t||(t=new K("matricesIndices"),t.setAsAttribute("matricesIndices")),t.output.connectTo(this.matricesIndices)}if(!this.matricesWeights.isConnected){var i=e.getInputBlockByPredicate(function(a){return a.isAttribute&&a.name==="matricesWeights"});i||(i=new K("matricesWeights"),i.setAsAttribute("matricesWeights")),i.output.connectTo(this.matricesWeights)}if(!this.world.isConnected){var o=e.getInputBlockByPredicate(function(a){return a.systemValue===Y.World});o||(o=new K("world"),o.setAsSystemValue(Y.World)),o.output.connectTo(this.world)}},n.prototype.provideFallbacks=function(e,t){e&&e.useBones&&e.computeBonesUsingShaders&&e.skeleton&&t.addCPUSkinningFallback(0,e)},n.prototype.bind=function(e,t,i){F.BindBonesParameters(i,e)},n.prototype.prepareDefines=function(e,t,i){!i._areAttributesDirty||F.PrepareDefinesForBones(e,i)},n.prototype._buildBlock=function(e){r.prototype._buildBlock.call(this,e),e.sharedData.blocksWithFallbacks.push(this),e.sharedData.forcedBindableBlocks.push(this),e.sharedData.blocksWithDefines.push(this),e.uniforms.push("boneTextureWidth"),e.uniforms.push("mBones"),e.samplers.push("boneSampler");var t="//".concat(this.name);e._emitFunctionFromInclude("bonesDeclaration",t,{removeAttributes:!0,removeUniforms:!1,removeVaryings:!0,removeIfDef:!1});var i=e._getFreeVariableName("influence");e.compilationString+=e._emitCodeFromInclude("bonesVertex",t,{replaceStrings:[{search:/finalWorld=finalWorld\*influence;/,replace:""},{search:/influence/gm,replace:i}]});var o=this._outputs[0],a=this.world;return e.compilationString+=`#if NUM_BONE_INFLUENCERS>0\r
`,e.compilationString+=this._declareOutput(o,e)+" = ".concat(a.associatedVariableName," * ").concat(i,`;\r
`),e.compilationString+=`#else\r
`,e.compilationString+=this._declareOutput(o,e)+" = ".concat(a.associatedVariableName,`;\r
`),e.compilationString+=`#endif\r
`,this},n}(L);P("BABYLON.BonesBlock",zc);var Xc=function(r){R(n,r);function n(e){var t=r.call(this,e,g.Vertex)||this;return t.registerInput("world0",h.Vector4),t.registerInput("world1",h.Vector4),t.registerInput("world2",h.Vector4),t.registerInput("world3",h.Vector4),t.registerInput("world",h.Matrix,!0),t.registerOutput("output",h.Matrix),t.registerOutput("instanceID",h.Float),t}return n.prototype.getClassName=function(){return"InstancesBlock"},Object.defineProperty(n.prototype,"world0",{get:function(){return this._inputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"world1",{get:function(){return this._inputs[1]},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"world2",{get:function(){return this._inputs[2]},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"world3",{get:function(){return this._inputs[3]},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"world",{get:function(){return this._inputs[4]},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"output",{get:function(){return this._outputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"instanceID",{get:function(){return this._outputs[1]},enumerable:!1,configurable:!0}),n.prototype.autoConfigure=function(e){if(!this.world0.connectedPoint){var t=e.getInputBlockByPredicate(function(c){return c.isAttribute&&c.name==="world0"});t||(t=new K("world0"),t.setAsAttribute("world0")),t.output.connectTo(this.world0)}if(!this.world1.connectedPoint){var i=e.getInputBlockByPredicate(function(c){return c.isAttribute&&c.name==="world1"});i||(i=new K("world1"),i.setAsAttribute("world1")),i.output.connectTo(this.world1)}if(!this.world2.connectedPoint){var o=e.getInputBlockByPredicate(function(c){return c.isAttribute&&c.name==="world2"});o||(o=new K("world2"),o.setAsAttribute("world2")),o.output.connectTo(this.world2)}if(!this.world3.connectedPoint){var a=e.getInputBlockByPredicate(function(c){return c.isAttribute&&c.name==="world3"});a||(a=new K("world3"),a.setAsAttribute("world3")),a.output.connectTo(this.world3)}if(!this.world.connectedPoint){var s=e.getInputBlockByPredicate(function(c){return c.isAttribute&&c.name==="world"});s||(s=new K("world"),s.setAsSystemValue(Y.World)),s.output.connectTo(this.world)}this.world.define="!INSTANCES || THIN_INSTANCES"},n.prototype.prepareDefines=function(e,t,i,o,a){o===void 0&&(o=!1);var s=!1;i.INSTANCES!==o&&(i.setValue("INSTANCES",o),s=!0),a&&i.THIN_INSTANCES!==!!(a!=null&&a.getRenderingMesh().hasThinInstances)&&(i.setValue("THIN_INSTANCES",!!(a!=null&&a.getRenderingMesh().hasThinInstances)),s=!0),s&&i.markAsUnprocessed()},n.prototype._buildBlock=function(e){r.prototype._buildBlock.call(this,e);var t=e.sharedData.scene.getEngine();e.sharedData.blocksWithDefines.push(this);var i=this._outputs[0],o=this._outputs[1],a=this.world0,s=this.world1,c=this.world2,l=this.world3;return e.compilationString+=`#ifdef INSTANCES\r
`,e.compilationString+=this._declareOutput(i,e)+" = mat4(".concat(a.associatedVariableName,", ").concat(s.associatedVariableName,", ").concat(c.associatedVariableName,", ").concat(l.associatedVariableName,`);\r
`),e.compilationString+=`#ifdef THIN_INSTANCES\r
`,e.compilationString+="".concat(i.associatedVariableName," = ").concat(this.world.associatedVariableName," * ").concat(i.associatedVariableName,`;\r
`),e.compilationString+=`#endif\r
`,t._caps.canUseGLInstanceID?e.compilationString+=this._declareOutput(o,e)+` = float(gl_InstanceID);\r
`:e.compilationString+=this._declareOutput(o,e)+` = 0.0;\r
`,e.compilationString+=`#else\r
`,e.compilationString+=this._declareOutput(i,e)+" = ".concat(this.world.associatedVariableName,`;\r
`),e.compilationString+=this._declareOutput(o,e)+` = 0.0;\r
`,e.compilationString+=`#endif\r
`,this},n}(L);P("BABYLON.InstancesBlock",Xc);var jc=function(r){R(n,r);function n(e){var t=r.call(this,e,g.Vertex)||this;return t.registerInput("position",h.Vector3),t.registerInput("normal",h.Vector3),t.registerInput("tangent",h.Vector3),t.registerInput("uv",h.Vector2),t.registerOutput("positionOutput",h.Vector3),t.registerOutput("normalOutput",h.Vector3),t.registerOutput("tangentOutput",h.Vector3),t.registerOutput("uvOutput",h.Vector2),t}return n.prototype.getClassName=function(){return"MorphTargetsBlock"},Object.defineProperty(n.prototype,"position",{get:function(){return this._inputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"normal",{get:function(){return this._inputs[1]},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"tangent",{get:function(){return this._inputs[2]},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"uv",{get:function(){return this._inputs[3]},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"positionOutput",{get:function(){return this._outputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"normalOutput",{get:function(){return this._outputs[1]},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"tangentOutput",{get:function(){return this._outputs[2]},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"uvOutput",{get:function(){return this._outputs[3]},enumerable:!1,configurable:!0}),n.prototype.initialize=function(e){e._excludeVariableName("morphTargetInfluences")},n.prototype.autoConfigure=function(e){if(!this.position.isConnected){var t=e.getInputBlockByPredicate(function(s){return s.isAttribute&&s.name==="position"});t||(t=new K("position"),t.setAsAttribute()),t.output.connectTo(this.position)}if(!this.normal.isConnected){var i=e.getInputBlockByPredicate(function(s){return s.isAttribute&&s.name==="normal"});i||(i=new K("normal"),i.setAsAttribute("normal")),i.output.connectTo(this.normal)}if(!this.tangent.isConnected){var o=e.getInputBlockByPredicate(function(s){return s.isAttribute&&s.name==="tangent"});o||(o=new K("tangent"),o.setAsAttribute("tangent")),o.output.connectTo(this.tangent)}if(!this.uv.isConnected){var a=e.getInputBlockByPredicate(function(s){return s.isAttribute&&s.name==="uv"});a||(a=new K("uv"),a.setAsAttribute("uv")),a.output.connectTo(this.uv)}},n.prototype.prepareDefines=function(e,t,i){if(e.morphTargetManager){var o=e.morphTargetManager;(o==null?void 0:o.isUsingTextureForTargets)&&o.numInfluencers!==i.NUM_MORPH_INFLUENCERS&&i.markAsAttributesDirty()}!i._areAttributesDirty||F.PrepareDefinesForMorphTargets(e,i)},n.prototype.bind=function(e,t,i){i&&i.morphTargetManager&&i.morphTargetManager.numInfluencers>0&&(F.BindMorphTargetParameters(i,e),i.morphTargetManager.isUsingTextureForTargets&&i.morphTargetManager._bind(e))},n.prototype.replaceRepeatableContent=function(e,t,i,o){var a=this.position,s=this.normal,c=this.tangent,l=this.uv,u=this.positionOutput,f=this.normalOutput,d=this.tangentOutput,p=this.uvOutput,m=e,_=o.NUM_MORPH_INFLUENCERS,v=i.morphTargetManager,b=v&&v.supportsNormals&&o.NORMAL,A=v&&v.supportsTangents&&o.TANGENT,S=v&&v.supportsUVs&&o.UV1,C="";(v==null?void 0:v.isUsingTextureForTargets)&&_>0&&(C+=`float vertexID;\r
`);for(var O=0;O<_;O++)C+=`#ifdef MORPHTARGETS\r
`,v!=null&&v.isUsingTextureForTargets?(C+=`vertexID = float(gl_VertexID) * morphTargetTextureInfo.x;\r
`,C+="".concat(u.associatedVariableName," += (readVector3FromRawSampler(").concat(O,", vertexID) - ").concat(a.associatedVariableName,") * morphTargetInfluences[").concat(O,`];\r
`),C+=`vertexID += 1.0;\r
`):C+="".concat(u.associatedVariableName," += (position").concat(O," - ").concat(a.associatedVariableName,") * morphTargetInfluences[").concat(O,`];\r
`),b&&(C+=`#ifdef MORPHTARGETS_NORMAL\r
`,v!=null&&v.isUsingTextureForTargets?(C+="".concat(f.associatedVariableName," += (readVector3FromRawSampler(").concat(O,", vertexID) - ").concat(s.associatedVariableName,") * morphTargetInfluences[").concat(O,`];\r
`),C+=`vertexID += 1.0;\r
`):C+="".concat(f.associatedVariableName," += (normal").concat(O," - ").concat(s.associatedVariableName,") * morphTargetInfluences[").concat(O,`];\r
`),C+=`#endif\r
`),S&&(C+=`#ifdef MORPHTARGETS_UV\r
`,v!=null&&v.isUsingTextureForTargets?(C+="".concat(p.associatedVariableName," += (readVector3FromRawSampler(").concat(O,", vertexID).xy - ").concat(l.associatedVariableName,") * morphTargetInfluences[").concat(O,`];\r
`),C+=`vertexID += 1.0;\r
`):C+="".concat(p.associatedVariableName,".xy += (uv_").concat(O," - ").concat(l.associatedVariableName,".xy) * morphTargetInfluences[").concat(O,`];\r
`),C+=`#endif\r
`),A&&(C+=`#ifdef MORPHTARGETS_TANGENT\r
`,v!=null&&v.isUsingTextureForTargets?C+="".concat(d.associatedVariableName," += (readVector3FromRawSampler(").concat(O,", vertexID) - ").concat(c.associatedVariableName,") * morphTargetInfluences[").concat(O,`];\r
`):C+="".concat(d.associatedVariableName,".xyz += (tangent").concat(O," - ").concat(c.associatedVariableName,".xyz) * morphTargetInfluences[").concat(O,`];\r
`),C+=`#endif\r
`),C+=`#endif\r
`;if(m.compilationString=m.compilationString.replace(this._repeatableContentAnchor,C),_>0)for(var O=0;O<_;O++)m.attributes.push(w.PositionKind+O),b&&m.attributes.push(w.NormalKind+O),A&&m.attributes.push(w.TangentKind+O),S&&m.attributes.push(w.UVKind+"_"+O)},n.prototype._buildBlock=function(e){r.prototype._buildBlock.call(this,e),e.sharedData.blocksWithDefines.push(this),e.sharedData.bindableBlocks.push(this),e.sharedData.repeatableContentBlocks.push(this);var t=this.position,i=this.normal,o=this.tangent,a=this.uv,s=this.positionOutput,c=this.normalOutput,l=this.tangentOutput,u=this.uvOutput,f="//".concat(this.name);return e.uniforms.push("morphTargetInfluences"),e.uniforms.push("morphTargetTextureInfo"),e.uniforms.push("morphTargetTextureIndices"),e.samplers.push("morphTargets"),e._emitFunctionFromInclude("morphTargetsVertexGlobalDeclaration",f),e._emitFunctionFromInclude("morphTargetsVertexDeclaration",f,{repeatKey:"maxSimultaneousMorphTargets"}),e.compilationString+="".concat(this._declareOutput(s,e)," = ").concat(t.associatedVariableName,`;\r
`),e.compilationString+=`#ifdef NORMAL\r
`,e.compilationString+="".concat(this._declareOutput(c,e)," = ").concat(i.associatedVariableName,`;\r
`),e.compilationString+=`#else\r
`,e.compilationString+="".concat(this._declareOutput(c,e),` = vec3(0., 0., 0.);\r
`),e.compilationString+=`#endif\r
`,e.compilationString+=`#ifdef TANGENT\r
`,e.compilationString+="".concat(this._declareOutput(l,e)," = ").concat(o.associatedVariableName,`;\r
`),e.compilationString+=`#else\r
`,e.compilationString+="".concat(this._declareOutput(l,e),` = vec3(0., 0., 0.);\r
`),e.compilationString+=`#endif\r
`,e.compilationString+=`#ifdef UV1\r
`,e.compilationString+="".concat(this._declareOutput(u,e)," = ").concat(a.associatedVariableName,`;\r
`),e.compilationString+=`#else\r
`,e.compilationString+="".concat(this._declareOutput(u,e),` = vec2(0., 0.);\r
`),e.compilationString+=`#endif\r
`,this._repeatableContentAnchor=e._repeatableContentAnchor,e.compilationString+=this._repeatableContentAnchor,this},n}(L);P("BABYLON.MorphTargetsBlock",jc);var Yc=function(r){R(n,r);function n(e){var t=r.call(this,e,g.Vertex)||this;return t.registerInput("worldPosition",h.Vector4,!1,g.Vertex),t.registerOutput("direction",h.Vector3),t.registerOutput("color",h.Color3),t.registerOutput("intensity",h.Float),t}return n.prototype.getClassName=function(){return"LightInformationBlock"},Object.defineProperty(n.prototype,"worldPosition",{get:function(){return this._inputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"direction",{get:function(){return this._outputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"color",{get:function(){return this._outputs[1]},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"intensity",{get:function(){return this._outputs[2]},enumerable:!1,configurable:!0}),n.prototype.bind=function(e,t,i){if(!!i){this.light&&this.light.isDisposed&&(this.light=null);var o=this.light,a=t.getScene();if(!o&&a.lights.length&&(o=this.light=a.lights[0],this._forcePrepareDefines=!0),!o||!o.isEnabled){e.setFloat3(this._lightDataUniformName,0,0,0),e.setFloat4(this._lightColorUniformName,0,0,0,0);return}o.transferToNodeMaterialEffect(e,this._lightDataUniformName),e.setColor4(this._lightColorUniformName,o.diffuse,o.intensity)}},n.prototype.prepareDefines=function(e,t,i){if(!(!i._areLightsDirty&&!this._forcePrepareDefines)){this._forcePrepareDefines=!1;var o=this.light;i.setValue(this._lightTypeDefineName,!!(o&&o instanceof Kt),!0)}},n.prototype._buildBlock=function(e){r.prototype._buildBlock.call(this,e),e.sharedData.bindableBlocks.push(this),e.sharedData.blocksWithDefines.push(this);var t=this.direction,i=this.color,o=this.intensity;return this._lightDataUniformName=e._getFreeVariableName("lightData"),this._lightColorUniformName=e._getFreeVariableName("lightColor"),this._lightTypeDefineName=e._getFreeDefineName("LIGHTPOINTTYPE"),e._emitUniformFromString(this._lightDataUniformName,"vec3"),e._emitUniformFromString(this._lightColorUniformName,"vec4"),e.compilationString+="#ifdef ".concat(this._lightTypeDefineName,`\r
`),e.compilationString+=this._declareOutput(t,e)+" = normalize(".concat(this.worldPosition.associatedVariableName,".xyz - ").concat(this._lightDataUniformName,`);\r
`),e.compilationString+=`#else\r
`,e.compilationString+=this._declareOutput(t,e)+" = ".concat(this._lightDataUniformName,`;\r
`),e.compilationString+=`#endif\r
`,e.compilationString+=this._declareOutput(i,e)+" = ".concat(this._lightColorUniformName,`.rgb;\r
`),e.compilationString+=this._declareOutput(o,e)+" = ".concat(this._lightColorUniformName,`.a;\r
`),this},n.prototype.serialize=function(){var e=r.prototype.serialize.call(this);return this.light&&(e.lightId=this.light.id),e},n.prototype._deserialize=function(e,t,i){r.prototype._deserialize.call(this,e,t,i),e.lightId&&(this.light=t.getLightById(e.lightId))},n}(L);P("BABYLON.LightInformationBlock",Yc);var Wc=function(r){R(n,r);function n(e){var t=r.call(this,e,g.Fragment)||this;return t.convertInputToLinearSpace=!0,t.registerInput("color",h.Color4),t.registerOutput("output",h.Color4),t._inputs[0].acceptedConnectionPointTypes.push(h.Color3),t}return n.prototype.getClassName=function(){return"ImageProcessingBlock"},Object.defineProperty(n.prototype,"color",{get:function(){return this._inputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"output",{get:function(){return this._outputs[0]},enumerable:!1,configurable:!0}),n.prototype.initialize=function(e){e._excludeVariableName("exposureLinear"),e._excludeVariableName("contrast"),e._excludeVariableName("vInverseScreenSize"),e._excludeVariableName("vignetteSettings1"),e._excludeVariableName("vignetteSettings2"),e._excludeVariableName("vCameraColorCurveNegative"),e._excludeVariableName("vCameraColorCurveNeutral"),e._excludeVariableName("vCameraColorCurvePositive"),e._excludeVariableName("txColorTransform"),e._excludeVariableName("colorTransformSettings")},n.prototype.isReady=function(e,t,i){return!(i._areImageProcessingDirty&&t.imageProcessingConfiguration&&!t.imageProcessingConfiguration.isReady())},n.prototype.prepareDefines=function(e,t,i){i._areImageProcessingDirty&&t.imageProcessingConfiguration&&t.imageProcessingConfiguration.prepareDefines(i)},n.prototype.bind=function(e,t,i){!i||!t.imageProcessingConfiguration||t.imageProcessingConfiguration.bind(e)},n.prototype._buildBlock=function(e){r.prototype._buildBlock.call(this,e),e.sharedData.blocksWithDefines.push(this),e.sharedData.blockingBlocks.push(this),e.sharedData.bindableBlocks.push(this),e.uniforms.push("exposureLinear"),e.uniforms.push("contrast"),e.uniforms.push("vInverseScreenSize"),e.uniforms.push("vignetteSettings1"),e.uniforms.push("vignetteSettings2"),e.uniforms.push("vCameraColorCurveNegative"),e.uniforms.push("vCameraColorCurveNeutral"),e.uniforms.push("vCameraColorCurvePositive"),e.uniforms.push("txColorTransform"),e.uniforms.push("colorTransformSettings");var t=this.color,i=this._outputs[0],o="//".concat(this.name);return e._emitFunctionFromInclude("helperFunctions",o),e._emitFunctionFromInclude("imageProcessingDeclaration",o),e._emitFunctionFromInclude("imageProcessingFunctions",o),t.connectedPoint.type===h.Color4||t.connectedPoint.type===h.Vector4?e.compilationString+="".concat(this._declareOutput(i,e)," = ").concat(t.associatedVariableName,`;\r
`):e.compilationString+="".concat(this._declareOutput(i,e)," = vec4(").concat(t.associatedVariableName,`, 1.0);\r
`),e.compilationString+=`#ifdef IMAGEPROCESSINGPOSTPROCESS\r
`,this.convertInputToLinearSpace&&(e.compilationString+="".concat(i.associatedVariableName,".rgb = toLinearSpace(").concat(t.associatedVariableName,`.rgb);\r
`)),e.compilationString+=`#else\r
`,e.compilationString+=`#ifdef IMAGEPROCESSING\r
`,this.convertInputToLinearSpace&&(e.compilationString+="".concat(i.associatedVariableName,".rgb = toLinearSpace(").concat(t.associatedVariableName,`.rgb);\r
`)),e.compilationString+="".concat(i.associatedVariableName," = applyImageProcessing(").concat(i.associatedVariableName,`);\r
`),e.compilationString+=`#endif\r
`,e.compilationString+=`#endif\r
`,this},n.prototype._dumpPropertiesCode=function(){var e=r.prototype._dumpPropertiesCode.call(this);return e+="".concat(this._codeVariableName,".convertInputToLinearSpace = ").concat(this.convertInputToLinearSpace,`;\r
`),e},n.prototype.serialize=function(){var e=r.prototype.serialize.call(this);return e.convertInputToLinearSpace=this.convertInputToLinearSpace,e},n.prototype._deserialize=function(e,t,i){var o;r.prototype._deserialize.call(this,e,t,i),this.convertInputToLinearSpace=(o=e.convertInputToLinearSpace)!==null&&o!==void 0?o:!0},E([te("Convert input to linear space",ee.Boolean,"ADVANCED")],n.prototype,"convertInputToLinearSpace",void 0),n}(L);P("BABYLON.ImageProcessingBlock",Wc);var Kc=function(r){R(n,r);function n(e){var t=r.call(this,e,g.Fragment)||this;return t._tangentSpaceParameterName="",t.invertX=!1,t.invertY=!1,t.useParallaxOcclusion=!1,t._isUnique=!0,t.registerInput("worldPosition",h.Vector4,!1),t.registerInput("worldNormal",h.Vector4,!1),t.registerInput("worldTangent",h.Vector4,!0),t.registerInput("uv",h.Vector2,!1),t.registerInput("normalMapColor",h.Color3,!1),t.registerInput("strength",h.Float,!1),t.registerInput("viewDirection",h.Vector3,!0),t.registerInput("parallaxScale",h.Float,!0),t.registerInput("parallaxHeight",h.Float,!0),t.registerOutput("output",h.Vector4),t.registerOutput("uvOffset",h.Vector2),t}return n.prototype.getClassName=function(){return"PerturbNormalBlock"},Object.defineProperty(n.prototype,"worldPosition",{get:function(){return this._inputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"worldNormal",{get:function(){return this._inputs[1]},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"worldTangent",{get:function(){return this._inputs[2]},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"uv",{get:function(){return this._inputs[3]},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"normalMapColor",{get:function(){return this._inputs[4]},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"strength",{get:function(){return this._inputs[5]},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"viewDirection",{get:function(){return this._inputs[6]},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"parallaxScale",{get:function(){return this._inputs[7]},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"parallaxHeight",{get:function(){return this._inputs[8]},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"output",{get:function(){return this._outputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"uvOffset",{get:function(){return this._outputs[1]},enumerable:!1,configurable:!0}),n.prototype.prepareDefines=function(e,t,i){var o=this.normalMapColor.connectedPoint._ownerBlock.samplerName,a=this.viewDirection.isConnected&&(this.useParallaxOcclusion&&o||!this.useParallaxOcclusion&&this.parallaxHeight.isConnected);i.setValue("BUMP",!0),i.setValue("PARALLAX",a,!0),i.setValue("PARALLAXOCCLUSION",this.useParallaxOcclusion,!0)},n.prototype.bind=function(e,t){t.getScene()._mirroredCameraPosition?e.setFloat2(this._tangentSpaceParameterName,this.invertX?1:-1,this.invertY?1:-1):e.setFloat2(this._tangentSpaceParameterName,this.invertX?-1:1,this.invertY?-1:1)},n.prototype.autoConfigure=function(e){if(!this.uv.isConnected){var t=e.getInputBlockByPredicate(function(o){return o.isAttribute&&o.name==="uv"});t||(t=new K("uv"),t.setAsAttribute()),t.output.connectTo(this.uv)}if(!this.strength.isConnected){var i=new K("strength");i.value=1,i.output.connectTo(this.strength)}},n.prototype._buildBlock=function(e){r.prototype._buildBlock.call(this,e);var t="//".concat(this.name),i=this.uv,o=this.worldPosition,a=this.worldNormal,s=this.worldTangent;e.sharedData.blocksWithDefines.push(this),e.sharedData.bindableBlocks.push(this),this._tangentSpaceParameterName=e._getFreeDefineName("tangentSpaceParameter"),e._emitUniformFromString(this._tangentSpaceParameterName,"vec2");var c=this.normalMapColor.connectedPoint._ownerBlock.samplerName,l=this.viewDirection.isConnected&&(this.useParallaxOcclusion&&c||!this.useParallaxOcclusion&&this.parallaxHeight.isConnected),u=this.parallaxScale.isConnectedToInputBlock?this.parallaxScale.connectInputBlock.isConstant?e._emitFloat(this.parallaxScale.connectInputBlock.value):this.parallaxScale.associatedVariableName:"0.05",f=this.strength.isConnectedToInputBlock&&this.strength.connectInputBlock.isConstant?`\r
#if !defined(NORMALXYSCALE)\r
1.0/\r
#endif\r
`.concat(e._emitFloat(this.strength.connectInputBlock.value)):`\r
#if !defined(NORMALXYSCALE)\r
1.0/\r
#endif\r
`.concat(this.strength.associatedVariableName);e._emitExtension("derivatives","#extension GL_OES_standard_derivatives : enable");var d={search:/defined\(TANGENT\)/g,replace:s.isConnected?"defined(TANGENT)":"defined(IGNORE)"},p={search:/varying mat3 vTBN/g,replace:""};s.isConnected&&(e.compilationString+="vec3 tbnNormal = normalize(".concat(a.associatedVariableName,`.xyz);\r
`),e.compilationString+="vec3 tbnTangent = normalize(".concat(s.associatedVariableName,`.xyz);\r
`),e.compilationString+=`vec3 tbnBitangent = cross(tbnNormal, tbnTangent);\r
`,e.compilationString+=`mat3 vTBN = mat3(tbnTangent, tbnBitangent, tbnNormal);\r
`),e._emitFunctionFromInclude("bumpFragmentMainFunctions",t,{replaceStrings:[d,p]}),e._emitFunctionFromInclude("bumpFragmentFunctions",t,{replaceStrings:[{search:/#include<samplerFragmentDeclaration>\(_DEFINENAME_,BUMP,_VARYINGNAME_,Bump,_SAMPLERNAME_,bump\)/g,replace:""},{search:/uniform sampler2D bumpSampler;/g,replace:""},{search:/vec2 parallaxOcclusion\(vec3 vViewDirCoT,vec3 vNormalCoT,vec2 texCoord,float parallaxScale\)/g,replace:`#define inline\r
vec2 parallaxOcclusion(vec3 vViewDirCoT, vec3 vNormalCoT, vec2 texCoord, float parallaxScale, sampler2D bumpSampler)`},{search:/vec2 parallaxOffset\(vec3 viewDir,float heightScale\)/g,replace:"vec2 parallaxOffset(vec3 viewDir, float heightScale, float height_)"},{search:/texture2D\(bumpSampler,vBumpUV\)\.w/g,replace:"height_"}]});var m=!l||!c?this.normalMapColor.associatedVariableName:"texture2D(".concat(c,", ").concat(i.associatedVariableName," + uvOffset).xyz");return e.compilationString+=this._declareOutput(this.output,e)+` = vec4(0.);\r
`,e.compilationString+=e._emitCodeFromInclude("bumpFragment",t,{replaceStrings:[{search:/perturbNormal\(TBN,texture2D\(bumpSampler,vBumpUV\+uvOffset\).xyz,vBumpInfos.y\)/g,replace:"perturbNormal(TBN, ".concat(m,", vBumpInfos.y)")},{search:/parallaxOcclusion\(invTBN\*-viewDirectionW,invTBN\*normalW,vBumpUV,vBumpInfos.z\)/g,replace:"parallaxOcclusion((invTBN * -viewDirectionW), (invTBN * normalW), vBumpUV, vBumpInfos.z, ".concat(l&&this.useParallaxOcclusion?c:"bumpSampler",")")},{search:/parallaxOffset\(invTBN\*viewDirectionW,vBumpInfos\.z\)/g,replace:"parallaxOffset(invTBN * viewDirectionW, vBumpInfos.z, ".concat(l?this.parallaxHeight.associatedVariableName:"0.",")")},{search:/vTangentSpaceParams/g,replace:this._tangentSpaceParameterName},{search:/vBumpInfos.y/g,replace:f},{search:/vBumpInfos.z/g,replace:u},{search:/vBumpUV/g,replace:i.associatedVariableName},{search:/vPositionW/g,replace:o.associatedVariableName+".xyz"},{search:/normalW=/g,replace:this.output.associatedVariableName+".xyz = "},{search:/mat3\(normalMatrix\)\*normalW/g,replace:"mat3(normalMatrix) * "+this.output.associatedVariableName+".xyz"},{search:/normalW/g,replace:a.associatedVariableName+".xyz"},{search:/viewDirectionW/g,replace:l?this.viewDirection.associatedVariableName:"vec3(0.)"},d]}),this},n.prototype._dumpPropertiesCode=function(){var e=r.prototype._dumpPropertiesCode.call(this)+"".concat(this._codeVariableName,".invertX = ").concat(this.invertX,`;\r
`);return e+="".concat(this._codeVariableName,".invertY = ").concat(this.invertY,`;\r
`),e+="".concat(this._codeVariableName,".useParallaxOcclusion = ").concat(this.useParallaxOcclusion,`;\r
`),e},n.prototype.serialize=function(){var e=r.prototype.serialize.call(this);return e.invertX=this.invertX,e.invertY=this.invertY,e.useParallaxOcclusion=this.useParallaxOcclusion,e},n.prototype._deserialize=function(e,t,i){r.prototype._deserialize.call(this,e,t,i),this.invertX=e.invertX,this.invertY=e.invertY,this.useParallaxOcclusion=!!e.useParallaxOcclusion},E([te("Invert X axis",ee.Boolean,"PROPERTIES",{notifiers:{update:!1}})],n.prototype,"invertX",void 0),E([te("Invert Y axis",ee.Boolean,"PROPERTIES",{notifiers:{update:!1}})],n.prototype,"invertY",void 0),E([te("Use parallax occlusion",ee.Boolean)],n.prototype,"useParallaxOcclusion",void 0),n}(L);P("BABYLON.PerturbNormalBlock",Kc);var Qc=function(r){R(n,r);function n(e){var t=r.call(this,e,g.Fragment,!0)||this;return t.registerInput("value",h.Float,!0),t.registerInput("cutoff",h.Float,!0),t}return n.prototype.getClassName=function(){return"DiscardBlock"},Object.defineProperty(n.prototype,"value",{get:function(){return this._inputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"cutoff",{get:function(){return this._inputs[1]},enumerable:!1,configurable:!0}),n.prototype._buildBlock=function(e){if(r.prototype._buildBlock.call(this,e),e.sharedData.hints.needAlphaTesting=!0,!(!this.cutoff.isConnected||!this.value.isConnected))return e.compilationString+="if (".concat(this.value.associatedVariableName," < ").concat(this.cutoff.associatedVariableName,`) discard;\r
`),this},n}(L);P("BABYLON.DiscardBlock",Qc);var qc=function(r){R(n,r);function n(e){var t=r.call(this,e,g.Fragment)||this;return t.registerOutput("output",h.Float,g.Fragment),t}return n.prototype.getClassName=function(){return"FrontFacingBlock"},Object.defineProperty(n.prototype,"output",{get:function(){return this._outputs[0]},enumerable:!1,configurable:!0}),n.prototype._buildBlock=function(e){if(r.prototype._buildBlock.call(this,e),e.target===g.Vertex)throw"FrontFacingBlock must only be used in a fragment shader";var t=this._outputs[0];return e.compilationString+=this._declareOutput(t,e)+` = gl_FrontFacing ? 1.0 : 0.0;\r
`,this},n}(L);P("BABYLON.FrontFacingBlock",qc);var Zc=function(r){R(n,r);function n(e){var t=r.call(this,e,g.Fragment)||this;return t.registerInput("input",h.AutoDetect,!1),t.registerOutput("dx",h.BasedOnInput),t.registerOutput("dy",h.BasedOnInput),t._outputs[0]._typeConnectionSource=t._inputs[0],t._outputs[1]._typeConnectionSource=t._inputs[0],t}return n.prototype.getClassName=function(){return"DerivativeBlock"},Object.defineProperty(n.prototype,"input",{get:function(){return this._inputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"dx",{get:function(){return this._outputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"dy",{get:function(){return this._outputs[1]},enumerable:!1,configurable:!0}),n.prototype._buildBlock=function(e){r.prototype._buildBlock.call(this,e);var t=this._outputs[0],i=this._outputs[1];return e._emitExtension("derivatives","#extension GL_OES_standard_derivatives : enable"),t.hasEndpoints&&(e.compilationString+=this._declareOutput(t,e)+" = dFdx(".concat(this.input.associatedVariableName,`);\r
`)),i.hasEndpoints&&(e.compilationString+=this._declareOutput(i,e)+" = dFdy(".concat(this.input.associatedVariableName,`);\r
`)),this},n}(L);P("BABYLON.DerivativeBlock",Zc);var Jc=function(r){R(n,r);function n(e){var t=r.call(this,e,g.Fragment)||this;return t.registerOutput("xy",h.Vector2,g.Fragment),t.registerOutput("xyz",h.Vector3,g.Fragment),t.registerOutput("xyzw",h.Vector4,g.Fragment),t.registerOutput("x",h.Float,g.Fragment),t.registerOutput("y",h.Float,g.Fragment),t.registerOutput("z",h.Float,g.Fragment),t.registerOutput("w",h.Float,g.Fragment),t}return n.prototype.getClassName=function(){return"FragCoordBlock"},Object.defineProperty(n.prototype,"xy",{get:function(){return this._outputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"xyz",{get:function(){return this._outputs[1]},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"xyzw",{get:function(){return this._outputs[2]},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"x",{get:function(){return this._outputs[3]},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"y",{get:function(){return this._outputs[4]},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"z",{get:function(){return this._outputs[5]},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"output",{get:function(){return this._outputs[6]},enumerable:!1,configurable:!0}),n.prototype.writeOutputs=function(e){for(var t="",i=0,o=this._outputs;i<o.length;i++){var a=o[i];a.hasEndpoints&&(t+="".concat(this._declareOutput(a,e)," = gl_FragCoord.").concat(a.name,`;\r
`))}return t},n.prototype._buildBlock=function(e){if(r.prototype._buildBlock.call(this,e),e.target===g.Vertex)throw"FragCoordBlock must only be used in a fragment shader";return e.compilationString+=this.writeOutputs(e),this},n}(L);P("BABYLON.FragCoordBlock",Jc);var $c=function(r){R(n,r);function n(e){var t=r.call(this,e,g.Fragment)||this;return t.registerOutput("xy",h.Vector2,g.Fragment),t.registerOutput("x",h.Float,g.Fragment),t.registerOutput("y",h.Float,g.Fragment),t}return n.prototype.getClassName=function(){return"ScreenSizeBlock"},Object.defineProperty(n.prototype,"xy",{get:function(){return this._outputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"x",{get:function(){return this._outputs[1]},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"y",{get:function(){return this._outputs[2]},enumerable:!1,configurable:!0}),n.prototype.bind=function(e){var t=this._scene.getEngine();e.setFloat2(this._varName,t.getRenderWidth(),t.getRenderHeight())},n.prototype.writeOutputs=function(e,t){for(var i="",o=0,a=this._outputs;o<a.length;o++){var s=a[o];s.hasEndpoints&&(i+="".concat(this._declareOutput(s,e)," = ").concat(t,".").concat(s.name,`;\r
`))}return i},n.prototype._buildBlock=function(e){if(r.prototype._buildBlock.call(this,e),this._scene=e.sharedData.scene,e.target===g.Vertex)throw"ScreenSizeBlock must only be used in a fragment shader";return e.sharedData.bindableBlocks.push(this),this._varName=e._getFreeVariableName("screenSize"),e._emitUniformFromString(this._varName,"vec2"),e.compilationString+=this.writeOutputs(e,this._varName),this},n}(L);P("BABYLON.ScreenSizeBlock",$c);var el=function(r){R(n,r);function n(e){var t=r.call(this,e,g.Fragment)||this;return t.registerInput("vector",h.Vector3),t.registerInput("worldViewProjection",h.Matrix),t.registerOutput("output",h.Vector2),t.registerOutput("x",h.Float),t.registerOutput("y",h.Float),t.inputs[0].acceptedConnectionPointTypes.push(h.Vector4),t}return n.prototype.getClassName=function(){return"ScreenSpaceBlock"},Object.defineProperty(n.prototype,"vector",{get:function(){return this._inputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"worldViewProjection",{get:function(){return this._inputs[1]},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"output",{get:function(){return this._outputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"x",{get:function(){return this._outputs[1]},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"y",{get:function(){return this._outputs[2]},enumerable:!1,configurable:!0}),n.prototype.autoConfigure=function(e){if(!this.worldViewProjection.isConnected){var t=e.getInputBlockByPredicate(function(i){return i.systemValue===Y.WorldViewProjection});t||(t=new K("worldViewProjection"),t.setAsSystemValue(Y.WorldViewProjection)),t.output.connectTo(this.worldViewProjection)}},n.prototype._buildBlock=function(e){r.prototype._buildBlock.call(this,e);var t=this.vector,i=this.worldViewProjection;if(!!t.connectedPoint){var o=i.associatedVariableName,a=e._getFreeVariableName("screenSpaceTemp");switch(t.connectedPoint.type){case h.Vector3:e.compilationString+="vec4 ".concat(a," = ").concat(o," * vec4(").concat(t.associatedVariableName,`, 1.0);\r
`);break;case h.Vector4:e.compilationString+="vec4 ".concat(a," = ").concat(o," * ").concat(t.associatedVariableName,`;\r
`);break}return e.compilationString+="".concat(a,".xy /= ").concat(a,".w;"),e.compilationString+="".concat(a,".xy = ").concat(a,".xy * 0.5 + vec2(0.5, 0.5);"),this.output.hasEndpoints&&(e.compilationString+=this._declareOutput(this.output,e)+" = ".concat(a,`.xy;\r
`)),this.x.hasEndpoints&&(e.compilationString+=this._declareOutput(this.x,e)+" = ".concat(a,`.x;\r
`)),this.y.hasEndpoints&&(e.compilationString+=this._declareOutput(this.y,e)+" = ".concat(a,`.y;\r
`)),this}},n}(L);P("BABYLON.ScreenSpaceBlock",el);var tl=function(r){R(n,r);function n(e){var t=r.call(this,e,g.Fragment)||this;return t.registerInput("input",h.Vector2),t.registerInput("strength",h.Float),t.registerInput("center",h.Vector2),t.registerInput("offset",h.Vector2),t.registerOutput("output",h.Vector2),t.registerOutput("x",h.Float),t.registerOutput("y",h.Float),t}return n.prototype.getClassName=function(){return"TwirlBlock"},Object.defineProperty(n.prototype,"input",{get:function(){return this._inputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"strength",{get:function(){return this._inputs[1]},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"center",{get:function(){return this._inputs[2]},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"offset",{get:function(){return this._inputs[3]},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"output",{get:function(){return this._outputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"x",{get:function(){return this._outputs[1]},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"y",{get:function(){return this._outputs[2]},enumerable:!1,configurable:!0}),n.prototype.autoConfigure=function(){if(!this.center.isConnected){var e=new K("center");e.value=new Ge(.5,.5),e.output.connectTo(this.center)}if(!this.strength.isConnected){var t=new K("strength");t.value=1,t.output.connectTo(this.strength)}if(!this.offset.isConnected){var i=new K("offset");i.value=new Ge(0,0),i.output.connectTo(this.offset)}},n.prototype._buildBlock=function(e){r.prototype._buildBlock.call(this,e);var t=e._getFreeVariableName("delta"),i=e._getFreeVariableName("angle"),o=e._getFreeVariableName("x"),a=e._getFreeVariableName("y"),s=e._getFreeVariableName("result");return e.compilationString+=`
            vec2 `.concat(t," = ").concat(this.input.associatedVariableName," - ").concat(this.center.associatedVariableName,`;
            float `).concat(i," = ").concat(this.strength.associatedVariableName," * length(").concat(t,`);
            float `).concat(o," = cos(").concat(i,") * ").concat(t,".x - sin(").concat(i,") * ").concat(t,`.y;
            float `).concat(a," = sin(").concat(i,") * ").concat(t,".x + cos(").concat(i,") * ").concat(t,`.y;
            vec2 `).concat(s," = vec2(").concat(o," + ").concat(this.center.associatedVariableName,".x + ").concat(this.offset.associatedVariableName,".x, ").concat(a," + ").concat(this.center.associatedVariableName,".y + ").concat(this.offset.associatedVariableName,`.y);
        `),this.output.hasEndpoints&&(e.compilationString+=this._declareOutput(this.output,e)+" = ".concat(s,`;\r
`)),this.x.hasEndpoints&&(e.compilationString+=this._declareOutput(this.x,e)+" = ".concat(s,`.x;\r
`)),this.y.hasEndpoints&&(e.compilationString+=this._declareOutput(this.y,e)+" = ".concat(s,`.y;\r
`)),this},n}(L);P("BABYLON.TwirlBlock",tl);var nl=function(r){R(n,r);function n(e){var t=r.call(this,e,g.VertexAndFragment,!1)||this;return t.registerInput("worldPosition",h.Vector4,!1,g.Vertex),t.registerInput("view",h.Matrix,!1,g.Vertex),t.registerInput("input",h.Color3,!1,g.Fragment),t.registerInput("fogColor",h.Color3,!1,g.Fragment),t.registerOutput("output",h.Color3,g.Fragment),t.input.acceptedConnectionPointTypes.push(h.Color4),t.fogColor.acceptedConnectionPointTypes.push(h.Color4),t}return n.prototype.getClassName=function(){return"FogBlock"},Object.defineProperty(n.prototype,"worldPosition",{get:function(){return this._inputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"view",{get:function(){return this._inputs[1]},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"input",{get:function(){return this._inputs[2]},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"fogColor",{get:function(){return this._inputs[3]},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"output",{get:function(){return this._outputs[0]},enumerable:!1,configurable:!0}),n.prototype.autoConfigure=function(e){if(!this.view.isConnected){var t=e.getInputBlockByPredicate(function(o){return o.systemValue===Y.View});t||(t=new K("view"),t.setAsSystemValue(Y.View)),t.output.connectTo(this.view)}if(!this.fogColor.isConnected){var i=e.getInputBlockByPredicate(function(o){return o.systemValue===Y.FogColor});i||(i=new K("fogColor",void 0,h.Color3),i.setAsSystemValue(Y.FogColor)),i.output.connectTo(this.fogColor)}},n.prototype.prepareDefines=function(e,t,i){var o=e.getScene();i.setValue("FOG",t.fogEnabled&&F.GetFogState(e,o))},n.prototype.bind=function(e,t,i){if(!!i){var o=i.getScene();e.setFloat4(this._fogParameters,o.fogMode,o.fogStart,o.fogEnd,o.fogDensity)}},n.prototype._buildBlock=function(e){if(r.prototype._buildBlock.call(this,e),e.target===g.Fragment){e.sharedData.blocksWithDefines.push(this),e.sharedData.bindableBlocks.push(this),e._emitFunctionFromInclude("fogFragmentDeclaration","//".concat(this.name),{removeUniforms:!0,removeVaryings:!0,removeIfDef:!1,replaceStrings:[{search:/float CalcFogFactor\(\)/,replace:"float CalcFogFactor(vec3 vFogDistance, vec4 vFogInfos)"}]});var t=e._getFreeVariableName("fog"),i=this.input,o=this.fogColor;this._fogParameters=e._getFreeVariableName("fogParameters");var a=this._outputs[0];e._emitUniformFromString(this._fogParameters,"vec4"),e.compilationString+=`#ifdef FOG\r
`,e.compilationString+="float ".concat(t," = CalcFogFactor(").concat(this._fogDistanceName,", ").concat(this._fogParameters,`);\r
`),e.compilationString+=this._declareOutput(a,e)+" = ".concat(t," * ").concat(i.associatedVariableName,".rgb + (1.0 - ").concat(t,") * ").concat(o.associatedVariableName,`.rgb;\r
`),e.compilationString+=`#else\r
`.concat(this._declareOutput(a,e)," =  ").concat(i.associatedVariableName,`.rgb;\r
`),e.compilationString+=`#endif\r
`}else{var s=this.worldPosition,c=this.view;this._fogDistanceName=e._getFreeVariableName("vFogDistance"),e._emitVaryingFromString(this._fogDistanceName,"vec3"),e.compilationString+="".concat(this._fogDistanceName," = (").concat(c.associatedVariableName," * ").concat(s.associatedVariableName,`).xyz;\r
`)}return this},n}(L);P("BABYLON.FogBlock",nl);var il=function(r){R(n,r);function n(e){var t=r.call(this,e,g.VertexAndFragment)||this;return t._isUnique=!0,t.registerInput("worldPosition",h.Vector4,!1,g.Vertex),t.registerInput("worldNormal",h.Vector4,!1,g.Fragment),t.registerInput("cameraPosition",h.Vector3,!1,g.Fragment),t.registerInput("glossiness",h.Float,!0,g.Fragment),t.registerInput("glossPower",h.Float,!0,g.Fragment),t.registerInput("diffuseColor",h.Color3,!0,g.Fragment),t.registerInput("specularColor",h.Color3,!0,g.Fragment),t.registerInput("view",h.Matrix,!0),t.registerOutput("diffuseOutput",h.Color3,g.Fragment),t.registerOutput("specularOutput",h.Color3,g.Fragment),t.registerOutput("shadow",h.Float,g.Fragment),t}return n.prototype.getClassName=function(){return"LightBlock"},Object.defineProperty(n.prototype,"worldPosition",{get:function(){return this._inputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"worldNormal",{get:function(){return this._inputs[1]},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"cameraPosition",{get:function(){return this._inputs[2]},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"glossiness",{get:function(){return this._inputs[3]},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"glossPower",{get:function(){return this._inputs[4]},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"diffuseColor",{get:function(){return this._inputs[5]},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"specularColor",{get:function(){return this._inputs[6]},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"view",{get:function(){return this._inputs[7]},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"diffuseOutput",{get:function(){return this._outputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"specularOutput",{get:function(){return this._outputs[1]},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"shadow",{get:function(){return this._outputs[2]},enumerable:!1,configurable:!0}),n.prototype.autoConfigure=function(e){if(!this.cameraPosition.isConnected){var t=e.getInputBlockByPredicate(function(i){return i.systemValue===Y.CameraPosition});t||(t=new K("cameraPosition"),t.setAsSystemValue(Y.CameraPosition)),t.output.connectTo(this.cameraPosition)}},n.prototype.prepareDefines=function(e,t,i){if(!!i._areLightsDirty){var o=e.getScene();if(!this.light)F.PrepareDefinesForLights(o,e,i,!0,t.maxSimultaneousLights);else{var a={needNormals:!1,needRebuild:!1,lightmapMode:!1,shadowEnabled:!1,specularEnabled:!1};F.PrepareDefinesForLight(o,e,this.light,this._lightId,i,!0,a),a.needRebuild&&i.rebuild()}}},n.prototype.updateUniformsAndSamples=function(e,t,i,o){for(var a=0;a<t.maxSimultaneousLights&&i["LIGHT"+a];a++){var s=e.uniforms.indexOf("vLightData"+a)>=0;F.PrepareUniformsAndSamplersForLight(a,e.uniforms,e.samplers,i["PROJECTEDLIGHTTEXTURE"+a],o,s)}},n.prototype.bind=function(e,t,i){if(!!i){var o=i.getScene();this.light?F.BindLight(this.light,this._lightId,o,e,!0):F.BindLights(o,i,e,!0,t.maxSimultaneousLights)}},n.prototype._injectVertexCode=function(e){var t=this.worldPosition,i="//".concat(this.name);this.light?(this._lightId=(e.counters.lightCounter!==void 0?e.counters.lightCounter:-1)+1,e.counters.lightCounter=this._lightId,e._emitFunctionFromInclude(e.supportUniformBuffers?"lightVxUboDeclaration":"lightVxFragmentDeclaration",i,{replaceStrings:[{search:/{X}/g,replace:this._lightId.toString()}]},this._lightId.toString())):(e._emitFunctionFromInclude(e.supportUniformBuffers?"lightVxUboDeclaration":"lightVxFragmentDeclaration",i,{repeatKey:"maxSimultaneousLights"}),this._lightId=0,e.sharedData.dynamicUniformBlocks.push(this));var o="v_"+t.associatedVariableName;e._emitVaryingFromString(o,"vec4")&&(e.compilationString+="".concat(o," = ").concat(t.associatedVariableName,`;\r
`)),this.light?e.compilationString+=e._emitCodeFromInclude("shadowsVertex",i,{replaceStrings:[{search:/{X}/g,replace:this._lightId.toString()},{search:/worldPos/g,replace:t.associatedVariableName}]}):(e.compilationString+="vec4 worldPos = ".concat(t.associatedVariableName,`;\r
`),this.view.isConnected&&(e.compilationString+="mat4 view = ".concat(this.view.associatedVariableName,`;\r
`)),e.compilationString+=e._emitCodeFromInclude("shadowsVertex",i,{repeatKey:"maxSimultaneousLights"}))},n.prototype._buildBlock=function(e){if(r.prototype._buildBlock.call(this,e),e.target!==g.Fragment){this._injectVertexCode(e);return}e.sharedData.forcedBindableBlocks.push(this),e.sharedData.blocksWithDefines.push(this);var t="//".concat(this.name),i=this.worldPosition;e._emitFunctionFromInclude("helperFunctions",t),e._emitFunctionFromInclude("lightsFragmentFunctions",t,{replaceStrings:[{search:/vPositionW/g,replace:"v_"+i.associatedVariableName+".xyz"}]}),e._emitFunctionFromInclude("shadowsFragmentFunctions",t,{replaceStrings:[{search:/vPositionW/g,replace:"v_"+i.associatedVariableName+".xyz"}]}),this.light?e._emitFunctionFromInclude(e.supportUniformBuffers?"lightUboDeclaration":"lightFragmentDeclaration",t,{replaceStrings:[{search:/{X}/g,replace:this._lightId.toString()}]},this._lightId.toString()):e._emitFunctionFromInclude(e.supportUniformBuffers?"lightUboDeclaration":"lightFragmentDeclaration",t,{repeatKey:"maxSimultaneousLights"}),this._lightId===0&&(e._registerTempVariable("viewDirectionW")&&(e.compilationString+="vec3 viewDirectionW = normalize(".concat(this.cameraPosition.associatedVariableName," - ").concat("v_"+i.associatedVariableName,`.xyz);\r
`)),e.compilationString+=`lightingInfo info;\r
`,e.compilationString+=`float shadow = 1.;\r
`,e.compilationString+="float glossiness = ".concat(this.glossiness.isConnected?this.glossiness.associatedVariableName:"1.0"," * ").concat(this.glossPower.isConnected?this.glossPower.associatedVariableName:"1024.0",`;\r
`),e.compilationString+=`vec3 diffuseBase = vec3(0., 0., 0.);\r
`,e.compilationString+=`vec3 specularBase = vec3(0., 0., 0.);\r
`,e.compilationString+="vec3 normalW = ".concat(this.worldNormal.associatedVariableName,`.xyz;\r
`)),this.light?e.compilationString+=e._emitCodeFromInclude("lightFragment",t,{replaceStrings:[{search:/{X}/g,replace:this._lightId.toString()}]}):e.compilationString+=e._emitCodeFromInclude("lightFragment",t,{repeatKey:"maxSimultaneousLights"});var o=this.diffuseOutput,a=this.specularOutput;return e.compilationString+=this._declareOutput(o,e)+" = diffuseBase".concat(this.diffuseColor.isConnected?" * "+this.diffuseColor.associatedVariableName:"",`;\r
`),a.hasEndpoints&&(e.compilationString+=this._declareOutput(a,e)+" = specularBase".concat(this.specularColor.isConnected?" * "+this.specularColor.associatedVariableName:"",`;\r
`)),this.shadow.hasEndpoints&&(e.compilationString+=this._declareOutput(this.shadow,e)+` = shadow;\r
`),this},n.prototype.serialize=function(){var e=r.prototype.serialize.call(this);return this.light&&(e.lightId=this.light.id),e},n.prototype._deserialize=function(e,t,i){r.prototype._deserialize.call(this,e,t,i),e.lightId&&(this.light=t.getLightById(e.lightId))},n}(L);P("BABYLON.LightBlock",il);var we=function(r){R(n,r);function n(e,t,i,o,a,s){var c=r.call(this,e,t,i)||this;return c._blockType=o,c._blockName=a,c._nameForCheking=s,c._nameForCheking||(c._nameForCheking=e),c.needDualDirectionValidation=!0,c}return n.prototype.checkCompatibilityState=function(e){return e instanceof n&&e.name===this._nameForCheking?ke.Compatible:ke.TypeIncompatible},n.prototype.createCustomInputBlock=function(){return[new this._blockType(this._blockName),this.name]},n}(Fn),Lr=function(r){R(n,r);function n(e){var t=r.call(this,e,g.VertexAndFragment)||this;return t.registerOutput("source",h.Object,g.VertexAndFragment,new we("source",t,be.Output,n,"ImageSourceBlock")),t}return Object.defineProperty(n.prototype,"texture",{get:function(){return this._texture},set:function(e){var t=this,i;if(this._texture!==e){var o=(i=e==null?void 0:e.getScene())!==null&&i!==void 0?i:Me.LastCreatedScene;!e&&o&&o.markAllMaterialsAsDirty(1,function(a){return a.hasTexture(t._texture)}),this._texture=e,e&&o&&o.markAllMaterialsAsDirty(1,function(a){return a.hasTexture(e)})}},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"samplerName",{get:function(){return this._samplerName},enumerable:!1,configurable:!0}),n.prototype.bind=function(e){!this.texture||e.setTexture(this._samplerName,this.texture)},n.prototype.isReady=function(){return!(this.texture&&!this.texture.isReadyOrNotBlocking())},n.prototype.getClassName=function(){return"ImageSourceBlock"},Object.defineProperty(n.prototype,"source",{get:function(){return this._outputs[0]},enumerable:!1,configurable:!0}),n.prototype._buildBlock=function(e){return r.prototype._buildBlock.call(this,e),e.target===g.Vertex&&(this._samplerName=e._getFreeVariableName(this.name+"Sampler"),e.sharedData.blockingBlocks.push(this),e.sharedData.textureBlocks.push(this),e.sharedData.bindableBlocks.push(this)),e._emit2DSampler(this._samplerName),this},n.prototype._dumpPropertiesCode=function(){var e=r.prototype._dumpPropertiesCode.call(this);return this.texture&&(e+="".concat(this._codeVariableName,'.texture = new BABYLON.Texture("').concat(this.texture.name,'", null, ').concat(this.texture.noMipmap,", ").concat(this.texture.invertY,", ").concat(this.texture.samplingMode,`);\r
`),e+="".concat(this._codeVariableName,".texture.wrapU = ").concat(this.texture.wrapU,`;\r
`),e+="".concat(this._codeVariableName,".texture.wrapV = ").concat(this.texture.wrapV,`;\r
`),e+="".concat(this._codeVariableName,".texture.uAng = ").concat(this.texture.uAng,`;\r
`),e+="".concat(this._codeVariableName,".texture.vAng = ").concat(this.texture.vAng,`;\r
`),e+="".concat(this._codeVariableName,".texture.wAng = ").concat(this.texture.wAng,`;\r
`),e+="".concat(this._codeVariableName,".texture.uOffset = ").concat(this.texture.uOffset,`;\r
`),e+="".concat(this._codeVariableName,".texture.vOffset = ").concat(this.texture.vOffset,`;\r
`),e+="".concat(this._codeVariableName,".texture.uScale = ").concat(this.texture.uScale,`;\r
`),e+="".concat(this._codeVariableName,".texture.vScale = ").concat(this.texture.vScale,`;\r
`),e+="".concat(this._codeVariableName,".texture.coordinatesMode = ").concat(this.texture.coordinatesMode,`;\r
`)),e},n.prototype.serialize=function(){var e=r.prototype.serialize.call(this);return this.texture&&!this.texture.isRenderTarget&&this.texture.getClassName()!=="VideoTexture"&&(e.texture=this.texture.serialize()),e},n.prototype._deserialize=function(e,t,i){r.prototype._deserialize.call(this,e,t,i),e.texture&&!fn.IgnoreTexturesAtLoadTime&&e.texture.url!==void 0&&(i=e.texture.url.indexOf("data:")===0?"":i,this.texture=X.Parse(e.texture,t,i))},n}(L);P("BABYLON.ImageSourceBlock",Lr);var rl=function(r){R(n,r);function n(e,t){t===void 0&&(t=!1);var i=r.call(this,e,t?g.Fragment:g.VertexAndFragment)||this;return i._convertToGammaSpace=!1,i._convertToLinearSpace=!1,i.disableLevelMultiplication=!1,i._fragmentOnly=t,i.registerInput("uv",h.Vector2,!1,g.VertexAndFragment),i.registerInput("source",h.Object,!0,g.VertexAndFragment,new we("source",i,be.Input,Lr,"ImageSourceBlock")),i.registerOutput("rgba",h.Color4,g.Neutral),i.registerOutput("rgb",h.Color3,g.Neutral),i.registerOutput("r",h.Float,g.Neutral),i.registerOutput("g",h.Float,g.Neutral),i.registerOutput("b",h.Float,g.Neutral),i.registerOutput("a",h.Float,g.Neutral),i.registerOutput("level",h.Float,g.Neutral),i._inputs[0].acceptedConnectionPointTypes.push(h.Vector3),i._inputs[0].acceptedConnectionPointTypes.push(h.Vector4),i._inputs[0]._prioritizeVertex=!t,i}return Object.defineProperty(n.prototype,"texture",{get:function(){var e;return this.source.isConnected?((e=this.source.connectedPoint)===null||e===void 0?void 0:e.ownerBlock).texture:this._texture},set:function(e){var t=this,i;if(this._texture!==e){var o=(i=e==null?void 0:e.getScene())!==null&&i!==void 0?i:Me.LastCreatedScene;!e&&o&&o.markAllMaterialsAsDirty(1,function(a){return a.hasTexture(t._texture)}),this._texture=e,e&&o&&o.markAllMaterialsAsDirty(1,function(a){return a.hasTexture(e)})}},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"samplerName",{get:function(){return this._imageSource?this._imageSource.samplerName:this._samplerName},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"hasImageSource",{get:function(){return!!this._imageSource},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"convertToGammaSpace",{get:function(){return this._convertToGammaSpace},set:function(e){var t=this,i;if(e!==this._convertToGammaSpace&&(this._convertToGammaSpace=e,this.texture)){var o=(i=this.texture.getScene())!==null&&i!==void 0?i:Me.LastCreatedScene;o==null||o.markAllMaterialsAsDirty(1,function(a){return a.hasTexture(t.texture)})}},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"convertToLinearSpace",{get:function(){return this._convertToLinearSpace},set:function(e){var t=this,i;if(e!==this._convertToLinearSpace&&(this._convertToLinearSpace=e,this.texture)){var o=(i=this.texture.getScene())!==null&&i!==void 0?i:Me.LastCreatedScene;o==null||o.markAllMaterialsAsDirty(1,function(a){return a.hasTexture(t.texture)})}},enumerable:!1,configurable:!0}),n.prototype.getClassName=function(){return"TextureBlock"},Object.defineProperty(n.prototype,"uv",{get:function(){return this._inputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"source",{get:function(){return this._inputs[1]},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"rgba",{get:function(){return this._outputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"rgb",{get:function(){return this._outputs[1]},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"r",{get:function(){return this._outputs[2]},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"g",{get:function(){return this._outputs[3]},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"b",{get:function(){return this._outputs[4]},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"a",{get:function(){return this._outputs[5]},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"level",{get:function(){return this._outputs[6]},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"target",{get:function(){if(this._fragmentOnly)return g.Fragment;if(!this.uv.isConnected||this.uv.sourceBlock.isInput)return g.VertexAndFragment;for(var e=this.uv.connectedPoint;e;){if(e.target===g.Fragment)return g.Fragment;if(e.target===g.Vertex)return g.VertexAndFragment;if(e.target===g.Neutral||e.target===g.VertexAndFragment){var t=e.ownerBlock;if(t.target===g.Fragment)return g.Fragment;e=null;for(var i=0,o=t.inputs;i<o.length;i++){var a=o[i];if(a.connectedPoint){e=a.connectedPoint;break}}}}return g.VertexAndFragment},set:function(e){},enumerable:!1,configurable:!0}),n.prototype.autoConfigure=function(e){if(!this.uv.isConnected)if(e.mode===Be.PostProcess){var t=e.getBlockByPredicate(function(o){return o.name==="uv"});t&&t.connectTo(this)}else{var i=e.mode===Be.Particle?"particle_uv":"uv",t=e.getInputBlockByPredicate(function(a){return a.isAttribute&&a.name===i});t||(t=new K("uv"),t.setAsAttribute(i)),t.output.connectTo(this.uv)}},n.prototype.initializeDefines=function(e,t,i){!i._areTexturesDirty||this._mainUVDefineName!==void 0&&i.setValue(this._mainUVDefineName,!1,!0)},n.prototype.prepareDefines=function(e,t,i){if(!!i._areTexturesDirty){if(!this.texture||!this.texture.getTextureMatrix){this._isMixed&&(i.setValue(this._defineName,!1,!0),i.setValue(this._mainUVDefineName,!0,!0));return}var o=this.convertToGammaSpace&&this.texture&&!this.texture.gammaSpace,a=this.convertToLinearSpace&&this.texture&&this.texture.gammaSpace;i.setValue(this._linearDefineName,o,!0),i.setValue(this._gammaDefineName,a,!0),this._isMixed&&(this.texture.getTextureMatrix().isIdentityAs3x2()?(i.setValue(this._defineName,!1,!0),i.setValue(this._mainUVDefineName,!0,!0)):(i.setValue(this._defineName,!0),i[this._mainUVDefineName]==null&&i.setValue(this._mainUVDefineName,!1,!0)))}},n.prototype.isReady=function(){return!(this.texture&&!this.texture.isReadyOrNotBlocking())},n.prototype.bind=function(e){!this.texture||(this._isMixed&&(e.setFloat(this._textureInfoName,this.texture.level),e.setMatrix(this._textureTransformName,this.texture.getTextureMatrix())),this._imageSource||e.setTexture(this._samplerName,this.texture))},Object.defineProperty(n.prototype,"_isMixed",{get:function(){return this.target!==g.Fragment},enumerable:!1,configurable:!0}),n.prototype._injectVertexCode=function(e){var t=this.uv;if(this._defineName=e._getFreeDefineName("UVTRANSFORM"),this._mainUVDefineName="VMAIN"+t.associatedVariableName.toUpperCase(),this._mainUVName="vMain"+t.associatedVariableName,this._transformedUVName=e._getFreeVariableName("transformedUV"),this._textureTransformName=e._getFreeVariableName("textureTransform"),this._textureInfoName=e._getFreeVariableName("textureInfoName"),this.level.associatedVariableName=this._textureInfoName,e._emitVaryingFromString(this._transformedUVName,"vec2",this._defineName),e._emitVaryingFromString(this._mainUVName,"vec2",this._mainUVDefineName),e._emitUniformFromString(this._textureTransformName,"mat4",this._defineName),e.compilationString+="#ifdef ".concat(this._defineName,`\r
`),e.compilationString+="".concat(this._transformedUVName," = vec2(").concat(this._textureTransformName," * vec4(").concat(t.associatedVariableName,`.xy, 1.0, 0.0));\r
`),e.compilationString+="#elif defined(".concat(this._mainUVDefineName,`)\r
`),e.compilationString+="".concat(this._mainUVName," = ").concat(t.associatedVariableName,`.xy;\r
`),e.compilationString+=`#endif\r
`,!!this._outputs.some(function(s){return s.isConnectedInVertexShader})){this._writeTextureRead(e,!0);for(var i=0,o=this._outputs;i<o.length;i++){var a=o[i];a.hasEndpoints&&a.name!=="level"&&this._writeOutput(e,a,a.name,!0)}}},n.prototype._generateTextureLookup=function(e){var t=this.samplerName;e.compilationString+="#ifdef ".concat(this._defineName,`\r
`),e.compilationString+="vec4 ".concat(this._tempTextureRead," = texture2D(").concat(t,", ").concat(this._transformedUVName,`);\r
`),e.compilationString+="#elif defined(".concat(this._mainUVDefineName,`)\r
`),e.compilationString+="vec4 ".concat(this._tempTextureRead," = texture2D(").concat(t,", ").concat(this._mainUVName?this._mainUVName:this.uv.associatedVariableName,`);\r
`),e.compilationString+=`#endif\r
`},n.prototype._writeTextureRead=function(e,t){t===void 0&&(t=!1);var i=this.uv;if(t){if(e.target===g.Fragment)return;this._generateTextureLookup(e);return}if(this.uv.ownerBlock.target===g.Fragment){e.compilationString+="vec4 ".concat(this._tempTextureRead," = texture2D(").concat(this.samplerName,", ").concat(i.associatedVariableName,`);\r
`);return}this._generateTextureLookup(e)},n.prototype._generateConversionCode=function(e,t,i){i!=="a"&&((!this.texture||!this.texture.gammaSpace)&&(e.compilationString+="#ifdef ".concat(this._linearDefineName,`
                    `).concat(t.associatedVariableName," = toGammaSpace(").concat(t.associatedVariableName,`);
                    #endif
                `)),e.compilationString+="#ifdef ".concat(this._gammaDefineName,`
                `).concat(t.associatedVariableName," = toLinearSpace(").concat(t.associatedVariableName,`);
                #endif
            `))},n.prototype._writeOutput=function(e,t,i,o){if(o===void 0&&(o=!1),o){if(e.target===g.Fragment)return;e.compilationString+="".concat(this._declareOutput(t,e)," = ").concat(this._tempTextureRead,".").concat(i,`;\r
`),this._generateConversionCode(e,t,i);return}if(this.uv.ownerBlock.target===g.Fragment){e.compilationString+="".concat(this._declareOutput(t,e)," = ").concat(this._tempTextureRead,".").concat(i,`;\r
`),this._generateConversionCode(e,t,i);return}var a="";this.disableLevelMultiplication||(a=" * ".concat(this._textureInfoName)),e.compilationString+="".concat(this._declareOutput(t,e)," = ").concat(this._tempTextureRead,".").concat(i).concat(a,`;\r
`),this._generateConversionCode(e,t,i)},n.prototype._buildBlock=function(e){if(r.prototype._buildBlock.call(this,e),this.source.isConnected?this._imageSource=this.source.connectedPoint.ownerBlock:this._imageSource=null,(e.target===g.Vertex||this._fragmentOnly||e.target===g.Fragment&&this._tempTextureRead===void 0)&&(this._tempTextureRead=e._getFreeVariableName("tempTextureRead"),this._linearDefineName=e._getFreeDefineName("ISLINEAR"),this._gammaDefineName=e._getFreeDefineName("ISGAMMA")),(!this._isMixed&&e.target===g.Fragment||this._isMixed&&e.target===g.Vertex)&&(this._imageSource||(this._samplerName=e._getFreeVariableName(this.name+"Sampler"),e._emit2DSampler(this._samplerName)),e.sharedData.blockingBlocks.push(this),e.sharedData.textureBlocks.push(this),e.sharedData.blocksWithDefines.push(this),e.sharedData.bindableBlocks.push(this)),e.target!==g.Fragment){this._injectVertexCode(e);return}if(!!this._outputs.some(function(s){return s.isConnectedInFragmentShader})){this._isMixed&&!this._imageSource&&e._emit2DSampler(this._samplerName);var t="//".concat(this.name);e._emitFunctionFromInclude("helperFunctions",t),this._isMixed&&e._emitUniformFromString(this._textureInfoName,"float"),this._writeTextureRead(e);for(var i=0,o=this._outputs;i<o.length;i++){var a=o[i];a.hasEndpoints&&a.name!=="level"&&this._writeOutput(e,a,a.name)}return this}},n.prototype._dumpPropertiesCode=function(){var e=r.prototype._dumpPropertiesCode.call(this);return e+="".concat(this._codeVariableName,".convertToGammaSpace = ").concat(this.convertToGammaSpace,`;\r
`),e+="".concat(this._codeVariableName,".convertToLinearSpace = ").concat(this.convertToLinearSpace,`;\r
`),e+="".concat(this._codeVariableName,".disableLevelMultiplication = ").concat(this.disableLevelMultiplication,`;\r
`),this.texture&&(e+="".concat(this._codeVariableName,'.texture = new BABYLON.Texture("').concat(this.texture.name,'", null, ').concat(this.texture.noMipmap,", ").concat(this.texture.invertY,", ").concat(this.texture.samplingMode,`);\r
`),e+="".concat(this._codeVariableName,".texture.wrapU = ").concat(this.texture.wrapU,`;\r
`),e+="".concat(this._codeVariableName,".texture.wrapV = ").concat(this.texture.wrapV,`;\r
`),e+="".concat(this._codeVariableName,".texture.uAng = ").concat(this.texture.uAng,`;\r
`),e+="".concat(this._codeVariableName,".texture.vAng = ").concat(this.texture.vAng,`;\r
`),e+="".concat(this._codeVariableName,".texture.wAng = ").concat(this.texture.wAng,`;\r
`),e+="".concat(this._codeVariableName,".texture.uOffset = ").concat(this.texture.uOffset,`;\r
`),e+="".concat(this._codeVariableName,".texture.vOffset = ").concat(this.texture.vOffset,`;\r
`),e+="".concat(this._codeVariableName,".texture.uScale = ").concat(this.texture.uScale,`;\r
`),e+="".concat(this._codeVariableName,".texture.vScale = ").concat(this.texture.vScale,`;\r
`),e+="".concat(this._codeVariableName,".texture.coordinatesMode = ").concat(this.texture.coordinatesMode,`;\r
`)),e},n.prototype.serialize=function(){var e=r.prototype.serialize.call(this);return e.convertToGammaSpace=this.convertToGammaSpace,e.convertToLinearSpace=this.convertToLinearSpace,e.fragmentOnly=this._fragmentOnly,e.disableLevelMultiplication=this.disableLevelMultiplication,!this.hasImageSource&&this.texture&&!this.texture.isRenderTarget&&this.texture.getClassName()!=="VideoTexture"&&(e.texture=this.texture.serialize()),e},n.prototype._deserialize=function(e,t,i){r.prototype._deserialize.call(this,e,t,i),this.convertToGammaSpace=e.convertToGammaSpace,this.convertToLinearSpace=!!e.convertToLinearSpace,this._fragmentOnly=!!e.fragmentOnly,this.disableLevelMultiplication=!!e.disableLevelMultiplication,e.texture&&!fn.IgnoreTexturesAtLoadTime&&e.texture.url!==void 0&&(i=e.texture.url.indexOf("data:")===0?"":i,this.texture=X.Parse(e.texture,t,i))},n}(L);P("BABYLON.TextureBlock",rl);var Ri=function(r){R(n,r);function n(e){return r.call(this,e,g.VertexAndFragment)||this}return Object.defineProperty(n.prototype,"texture",{get:function(){return this._texture},set:function(e){var t=this,i;if(this._texture!==e){var o=(i=e==null?void 0:e.getScene())!==null&&i!==void 0?i:Me.LastCreatedScene;!e&&o&&o.markAllMaterialsAsDirty(1,function(a){return a.hasTexture(t._texture)}),this._texture=e,e&&o&&o.markAllMaterialsAsDirty(1,function(a){return a.hasTexture(e)})}},enumerable:!1,configurable:!0}),n.prototype.getClassName=function(){return"ReflectionTextureBaseBlock"},n.prototype._getTexture=function(){return this.texture},n.prototype.autoConfigure=function(e){if(!this.position.isConnected){var t=e.getInputBlockByPredicate(function(a){return a.isAttribute&&a.name==="position"});t||(t=new K("position"),t.setAsAttribute()),t.output.connectTo(this.position)}if(!this.world.isConnected){var i=e.getInputBlockByPredicate(function(a){return a.systemValue===Y.World});i||(i=new K("world"),i.setAsSystemValue(Y.World)),i.output.connectTo(this.world)}if(this.view&&!this.view.isConnected){var o=e.getInputBlockByPredicate(function(a){return a.systemValue===Y.View});o||(o=new K("view"),o.setAsSystemValue(Y.View)),o.output.connectTo(this.view)}},n.prototype.prepareDefines=function(e,t,i){if(!!i._areTexturesDirty){var o=this._getTexture();!o||!o.getTextureMatrix||(i.setValue(this._define3DName,o.isCube,!0),i.setValue(this._defineLocalCubicName,!!o.boundingBoxSize,!0),i.setValue(this._defineExplicitName,o.coordinatesMode===0,!0),i.setValue(this._defineSkyboxName,o.coordinatesMode===5,!0),i.setValue(this._defineCubicName,o.coordinatesMode===3||o.coordinatesMode===6,!0),i.setValue("INVERTCUBICMAP",o.coordinatesMode===6,!0),i.setValue(this._defineSphericalName,o.coordinatesMode===1,!0),i.setValue(this._definePlanarName,o.coordinatesMode===2,!0),i.setValue(this._defineProjectionName,o.coordinatesMode===4,!0),i.setValue(this._defineEquirectangularName,o.coordinatesMode===7,!0),i.setValue(this._defineEquirectangularFixedName,o.coordinatesMode===8,!0),i.setValue(this._defineMirroredEquirectangularFixedName,o.coordinatesMode===9,!0))}},n.prototype.isReady=function(){var e=this._getTexture();return!(e&&!e.isReadyOrNotBlocking())},n.prototype.bind=function(e,t,i){var o=this._getTexture();if(!(!i||!o)&&(e.setMatrix(this._reflectionMatrixName,o.getReflectionTextureMatrix()),o.isCube?e.setTexture(this._cubeSamplerName,o):e.setTexture(this._2DSamplerName,o),o.boundingBoxSize)){var a=o;e.setVector3(this._reflectionPositionName,a.boundingBoxPosition),e.setVector3(this._reflectionSizeName,a.boundingBoxSize)}},n.prototype.handleVertexSide=function(e){this._define3DName=e._getFreeDefineName("REFLECTIONMAP_3D"),this._defineCubicName=e._getFreeDefineName("REFLECTIONMAP_CUBIC"),this._defineSphericalName=e._getFreeDefineName("REFLECTIONMAP_SPHERICAL"),this._definePlanarName=e._getFreeDefineName("REFLECTIONMAP_PLANAR"),this._defineProjectionName=e._getFreeDefineName("REFLECTIONMAP_PROJECTION"),this._defineExplicitName=e._getFreeDefineName("REFLECTIONMAP_EXPLICIT"),this._defineEquirectangularName=e._getFreeDefineName("REFLECTIONMAP_EQUIRECTANGULAR"),this._defineLocalCubicName=e._getFreeDefineName("USE_LOCAL_REFLECTIONMAP_CUBIC"),this._defineMirroredEquirectangularFixedName=e._getFreeDefineName("REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED"),this._defineEquirectangularFixedName=e._getFreeDefineName("REFLECTIONMAP_EQUIRECTANGULAR_FIXED"),this._defineSkyboxName=e._getFreeDefineName("REFLECTIONMAP_SKYBOX"),this._defineOppositeZ=e._getFreeDefineName("REFLECTIONMAP_OPPOSITEZ"),this._reflectionMatrixName=e._getFreeVariableName("reflectionMatrix"),e._emitUniformFromString(this._reflectionMatrixName,"mat4");var t="",i="v_"+this.worldPosition.associatedVariableName;return e._emitVaryingFromString(i,"vec4")&&(t+="".concat(i," = ").concat(this.worldPosition.associatedVariableName,`;\r
`)),this._positionUVWName=e._getFreeVariableName("positionUVW"),this._directionWName=e._getFreeVariableName("directionW"),e._emitVaryingFromString(this._positionUVWName,"vec3",this._defineSkyboxName)&&(t+="#ifdef ".concat(this._defineSkyboxName,`\r
`),t+="".concat(this._positionUVWName," = ").concat(this.position.associatedVariableName,`.xyz;\r
`),t+=`#endif\r
`),e._emitVaryingFromString(this._directionWName,"vec3","defined(".concat(this._defineEquirectangularFixedName,") || defined(").concat(this._defineMirroredEquirectangularFixedName,")"))&&(t+="#if defined(".concat(this._defineEquirectangularFixedName,") || defined(").concat(this._defineMirroredEquirectangularFixedName,`)\r
`),t+="".concat(this._directionWName," = normalize(vec3(").concat(this.world.associatedVariableName," * vec4(").concat(this.position.associatedVariableName,`.xyz, 0.0)));\r
`),t+=`#endif\r
`),t},n.prototype.handleFragmentSideInits=function(e){e.sharedData.blockingBlocks.push(this),e.sharedData.textureBlocks.push(this),this._cubeSamplerName=e._getFreeVariableName(this.name+"CubeSampler"),e.samplers.push(this._cubeSamplerName),this._2DSamplerName=e._getFreeVariableName(this.name+"2DSampler"),e.samplers.push(this._2DSamplerName),e._samplerDeclaration+="#ifdef ".concat(this._define3DName,`\r
`),e._samplerDeclaration+="uniform samplerCube ".concat(this._cubeSamplerName,`;\r
`),e._samplerDeclaration+=`#else\r
`,e._samplerDeclaration+="uniform sampler2D ".concat(this._2DSamplerName,`;\r
`),e._samplerDeclaration+=`#endif\r
`,e.sharedData.blocksWithDefines.push(this),e.sharedData.bindableBlocks.push(this);var t="//".concat(this.name);e._emitFunction("ReciprocalPI","#define RECIPROCAL_PI2 0.15915494",""),e._emitFunctionFromInclude("helperFunctions",t),e._emitFunctionFromInclude("reflectionFunction",t,{replaceStrings:[{search:/vec3 computeReflectionCoords/g,replace:"void DUMMYFUNC"}]}),this._reflectionColorName=e._getFreeVariableName("reflectionColor"),this._reflectionVectorName=e._getFreeVariableName("reflectionUVW"),this._reflectionCoordsName=e._getFreeVariableName("reflectionCoords"),this._reflectionPositionName=e._getFreeVariableName("vReflectionPosition"),e._emitUniformFromString(this._reflectionPositionName,"vec3"),this._reflectionSizeName=e._getFreeVariableName("vReflectionPosition"),e._emitUniformFromString(this._reflectionSizeName,"vec3")},n.prototype.handleFragmentSideCodeReflectionCoords=function(e,t,i,o){i===void 0&&(i=!1),o===void 0&&(o=!1),t||(t="v_".concat(this.worldPosition.associatedVariableName));var a=this._reflectionMatrixName,s="normalize(".concat(this._directionWName,")"),c="".concat(this._positionUVWName),l="".concat(this.cameraPosition.associatedVariableName),u="".concat(this.view.associatedVariableName);e+=".xyz";var f=`
            #ifdef `.concat(this._defineMirroredEquirectangularFixedName,`
                vec3 `).concat(this._reflectionVectorName," = computeMirroredFixedEquirectangularCoords(").concat(t,", ").concat(e,", ").concat(s,`);
            #endif

            #ifdef `).concat(this._defineEquirectangularFixedName,`
                vec3 `).concat(this._reflectionVectorName," = computeFixedEquirectangularCoords(").concat(t,", ").concat(e,", ").concat(s,`);
            #endif

            #ifdef `).concat(this._defineEquirectangularName,`
                vec3 `).concat(this._reflectionVectorName," = computeEquirectangularCoords(").concat(t,", ").concat(e,", ").concat(l,".xyz, ").concat(a,`);
            #endif

            #ifdef `).concat(this._defineSphericalName,`
                vec3 `).concat(this._reflectionVectorName," = computeSphericalCoords(").concat(t,", ").concat(e,", ").concat(u,", ").concat(a,`);
            #endif

            #ifdef `).concat(this._definePlanarName,`
                vec3 `).concat(this._reflectionVectorName," = computePlanarCoords(").concat(t,", ").concat(e,", ").concat(l,".xyz, ").concat(a,`);
            #endif

            #ifdef `).concat(this._defineCubicName,`
                #ifdef `).concat(this._defineLocalCubicName,`
                    vec3 `).concat(this._reflectionVectorName," = computeCubicLocalCoords(").concat(t,", ").concat(e,", ").concat(l,".xyz, ").concat(a,", ").concat(this._reflectionSizeName,", ").concat(this._reflectionPositionName,`);
                #else
                vec3 `).concat(this._reflectionVectorName," = computeCubicCoords(").concat(t,", ").concat(e,", ").concat(l,".xyz, ").concat(a,`);
                #endif
            #endif

            #ifdef `).concat(this._defineProjectionName,`
                vec3 `).concat(this._reflectionVectorName," = computeProjectionCoords(").concat(t,", ").concat(u,", ").concat(a,`);
            #endif

            #ifdef `).concat(this._defineSkyboxName,`
                vec3 `).concat(this._reflectionVectorName," = computeSkyBoxCoords(").concat(c,", ").concat(a,`);
            #endif

            #ifdef `).concat(this._defineExplicitName,`
                vec3 `).concat(this._reflectionVectorName,` = vec3(0, 0, 0);
            #endif\r
`);return o||(f+="#ifdef ".concat(this._defineOppositeZ,`
                `).concat(this._reflectionVectorName,`.z *= -1.0;
            #endif\r
`)),i||(f+=`
                #ifdef `.concat(this._define3DName,`
                    vec3 `).concat(this._reflectionCoordsName," = ").concat(this._reflectionVectorName,`;
                #else
                    vec2 `).concat(this._reflectionCoordsName," = ").concat(this._reflectionVectorName,`.xy;
                    #ifdef `).concat(this._defineProjectionName,`
                        `).concat(this._reflectionCoordsName," /= ").concat(this._reflectionVectorName,`.z;
                    #endif
                    `).concat(this._reflectionCoordsName,".y = 1.0 - ").concat(this._reflectionCoordsName,`.y;
                #endif\r
`)),f},n.prototype.handleFragmentSideCodeReflectionColor=function(e,t){t===void 0&&(t=".rgb");var i="vec"+(t.length===0?"4":t.length-1),o="".concat(i," ").concat(this._reflectionColorName,`;
            #ifdef `).concat(this._define3DName,`\r
`);return e?o+="".concat(this._reflectionColorName," = textureCubeLodEXT(").concat(this._cubeSamplerName,", ").concat(this._reflectionVectorName,", ").concat(e,")").concat(t,`;\r
`):o+="".concat(this._reflectionColorName," = textureCube(").concat(this._cubeSamplerName,", ").concat(this._reflectionVectorName,")").concat(t,`;\r
`),o+=`
            #else\r
`,e?o+="".concat(this._reflectionColorName," = texture2DLodEXT(").concat(this._2DSamplerName,", ").concat(this._reflectionCoordsName,", ").concat(e,")").concat(t,`;\r
`):o+="".concat(this._reflectionColorName," = texture2D(").concat(this._2DSamplerName,", ").concat(this._reflectionCoordsName,")").concat(t,`;\r
`),o+=`#endif\r
`,o},n.prototype.writeOutputs=function(e,t){var i="";if(e.target===g.Fragment)for(var o=0,a=this._outputs;o<a.length;o++){var s=a[o];s.hasEndpoints&&(i+="".concat(this._declareOutput(s,e)," = ").concat(t,".").concat(s.name,`;\r
`))}return i},n.prototype._buildBlock=function(e){return r.prototype._buildBlock.call(this,e),this},n.prototype._dumpPropertiesCode=function(){var e=r.prototype._dumpPropertiesCode.call(this);if(!this.texture)return e;if(this.texture.isCube){var t=this.texture.forcedExtension;e+="".concat(this._codeVariableName,'.texture = new BABYLON.CubeTexture("').concat(this.texture.name,'", undefined, undefined, ').concat(this.texture.noMipmap,", null, undefined, undefined, undefined, ").concat(this.texture._prefiltered,", ").concat(t?'"'+t+'"':"null",`);\r
`)}else e+="".concat(this._codeVariableName,'.texture = new BABYLON.Texture("').concat(this.texture.name,`", null);\r
`);return e+="".concat(this._codeVariableName,".texture.coordinatesMode = ").concat(this.texture.coordinatesMode,`;\r
`),e},n.prototype.serialize=function(){var e=r.prototype.serialize.call(this);return this.texture&&!this.texture.isRenderTarget&&(e.texture=this.texture.serialize()),e},n.prototype._deserialize=function(e,t,i){r.prototype._deserialize.call(this,e,t,i),e.texture&&(i=e.texture.url.indexOf("data:")===0?"":i,e.texture.isCube?this.texture=bi.Parse(e.texture,t,i):this.texture=X.Parse(e.texture,t,i))},n}(L);P("BABYLON.ReflectionTextureBaseBlock",Ri);var ol=function(r){R(n,r);function n(e){var t=r.call(this,e)||this;return t.registerInput("position",h.Vector3,!1,g.Vertex),t.registerInput("worldPosition",h.Vector4,!1,g.Vertex),t.registerInput("worldNormal",h.Vector4,!1,g.Fragment),t.registerInput("world",h.Matrix,!1,g.Vertex),t.registerInput("cameraPosition",h.Vector3,!1,g.Fragment),t.registerInput("view",h.Matrix,!1,g.Fragment),t.registerOutput("rgb",h.Color3,g.Fragment),t.registerOutput("rgba",h.Color4,g.Fragment),t.registerOutput("r",h.Float,g.Fragment),t.registerOutput("g",h.Float,g.Fragment),t.registerOutput("b",h.Float,g.Fragment),t.registerOutput("a",h.Float,g.Fragment),t._inputs[0].acceptedConnectionPointTypes.push(h.Vector4),t}return n.prototype.getClassName=function(){return"ReflectionTextureBlock"},Object.defineProperty(n.prototype,"position",{get:function(){return this._inputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"worldPosition",{get:function(){return this._inputs[1]},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"worldNormal",{get:function(){return this._inputs[2]},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"world",{get:function(){return this._inputs[3]},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"cameraPosition",{get:function(){return this._inputs[4]},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"view",{get:function(){return this._inputs[5]},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"rgb",{get:function(){return this._outputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"rgba",{get:function(){return this._outputs[1]},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"r",{get:function(){return this._outputs[2]},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"g",{get:function(){return this._outputs[3]},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"b",{get:function(){return this._outputs[4]},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"a",{get:function(){return this._outputs[5]},enumerable:!1,configurable:!0}),n.prototype.autoConfigure=function(e){if(r.prototype.autoConfigure.call(this,e),!this.cameraPosition.isConnected){var t=e.getInputBlockByPredicate(function(i){return i.systemValue===Y.CameraPosition});t||(t=new K("cameraPosition"),t.setAsSystemValue(Y.CameraPosition)),t.output.connectTo(this.cameraPosition)}},n.prototype._buildBlock=function(e){if(r.prototype._buildBlock.call(this,e),!this.texture)return e.compilationString+=this.writeOutputs(e,"vec3(0.)"),this;if(e.target!==g.Fragment)return e.compilationString+=this.handleVertexSide(e),this;this.handleFragmentSideInits(e);var t=e._getFreeVariableName("normalWUnit");return e.compilationString+="vec4 ".concat(t," = normalize(").concat(this.worldNormal.associatedVariableName,`);\r
`),e.compilationString+=this.handleFragmentSideCodeReflectionCoords(t),e.compilationString+=this.handleFragmentSideCodeReflectionColor(void 0,""),e.compilationString+=this.writeOutputs(e,this._reflectionColorName),this},n}(Ri);P("BABYLON.ReflectionTextureBlock",ol);var al=function(r){R(n,r);function n(e){var t=r.call(this,e,g.VertexAndFragment)||this;return t._samplerName="textureSampler",t.useNonLinearDepth=!1,t.force32itsFloat=!1,t._isUnique=!0,t.registerInput("uv",h.Vector2,!1,g.VertexAndFragment),t.registerOutput("depth",h.Float,g.Neutral),t._inputs[0].acceptedConnectionPointTypes.push(h.Vector3),t._inputs[0].acceptedConnectionPointTypes.push(h.Vector4),t._inputs[0]._prioritizeVertex=!1,t}return n.prototype.getClassName=function(){return"SceneDepthBlock"},Object.defineProperty(n.prototype,"uv",{get:function(){return this._inputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"depth",{get:function(){return this._outputs[0]},enumerable:!1,configurable:!0}),n.prototype.initialize=function(e){e._excludeVariableName("textureSampler")},Object.defineProperty(n.prototype,"target",{get:function(){return!this.uv.isConnected||this.uv.sourceBlock.isInput?g.VertexAndFragment:g.Fragment},enumerable:!1,configurable:!0}),n.prototype._getTexture=function(e){var t=e.enableDepthRenderer(void 0,this.useNonLinearDepth,this.force32itsFloat);return t.getDepthMap()},n.prototype.bind=function(e,t){var i=this._getTexture(t.getScene());e.setTexture(this._samplerName,i)},n.prototype._injectVertexCode=function(e){var t=this.uv;if(t.connectedPoint.ownerBlock.isInput){var i=t.connectedPoint.ownerBlock;i.isAttribute||e._emitUniformFromString(t.associatedVariableName,"vec"+(t.type===h.Vector3?"3":t.type===h.Vector4?"4":"2"))}if(this._mainUVName="vMain"+t.associatedVariableName,e._emitVaryingFromString(this._mainUVName,"vec2"),e.compilationString+="".concat(this._mainUVName," = ").concat(t.associatedVariableName,`.xy;\r
`),!!this._outputs.some(function(c){return c.isConnectedInVertexShader})){this._writeTextureRead(e,!0);for(var o=0,a=this._outputs;o<a.length;o++){var s=a[o];s.hasEndpoints&&this._writeOutput(e,s,"r",!0)}}},n.prototype._writeTextureRead=function(e,t){t===void 0&&(t=!1);var i=this.uv;if(t){if(e.target===g.Fragment)return;e.compilationString+="vec4 ".concat(this._tempTextureRead," = texture2D(").concat(this._samplerName,", ").concat(i.associatedVariableName,`.xy);\r
`);return}if(this.uv.ownerBlock.target===g.Fragment){e.compilationString+="vec4 ".concat(this._tempTextureRead," = texture2D(").concat(this._samplerName,", ").concat(i.associatedVariableName,`.xy);\r
`);return}e.compilationString+="vec4 ".concat(this._tempTextureRead," = texture2D(").concat(this._samplerName,", ").concat(this._mainUVName,`);\r
`)},n.prototype._writeOutput=function(e,t,i,o){if(o===void 0&&(o=!1),o){if(e.target===g.Fragment)return;e.compilationString+="".concat(this._declareOutput(t,e)," = ").concat(this._tempTextureRead,".").concat(i,`;\r
`);return}if(this.uv.ownerBlock.target===g.Fragment){e.compilationString+="".concat(this._declareOutput(t,e)," = ").concat(this._tempTextureRead,".").concat(i,`;\r
`);return}e.compilationString+="".concat(this._declareOutput(t,e)," = ").concat(this._tempTextureRead,".").concat(i,`;\r
`)},n.prototype._buildBlock=function(e){if(r.prototype._buildBlock.call(this,e),this._tempTextureRead=e._getFreeVariableName("tempTextureRead"),e.sharedData.bindableBlocks.indexOf(this)<0&&e.sharedData.bindableBlocks.push(this),e.target!==g.Fragment){e._emit2DSampler(this._samplerName),this._injectVertexCode(e);return}if(!!this._outputs.some(function(a){return a.isConnectedInFragmentShader})){e._emit2DSampler(this._samplerName),this._writeTextureRead(e);for(var t=0,i=this._outputs;t<i.length;t++){var o=i[t];o.hasEndpoints&&this._writeOutput(e,o,"r")}return this}},n.prototype.serialize=function(){var e=r.prototype.serialize.call(this);return e.useNonLinearDepth=this.useNonLinearDepth,e.force32itsFloat=this.force32itsFloat,e},n.prototype._deserialize=function(e,t,i){r.prototype._deserialize.call(this,e,t,i),this.useNonLinearDepth=e.useNonLinearDepth,this.force32itsFloat=e.force32itsFloat},E([te("Use non linear depth",ee.Boolean,"ADVANCED",{notifiers:{activatePreviewCommand:!0,callback:function(e){return e.disableDepthRenderer()}}})],n.prototype,"useNonLinearDepth",void 0),E([te("Force 32 bits float",ee.Boolean,"ADVANCED",{notifiers:{activatePreviewCommand:!0,callback:function(e){return e.disableDepthRenderer()}}})],n.prototype,"force32itsFloat",void 0),n}(L);P("BABYLON.SceneDepthBlock",al);var sl=function(r){R(n,r);function n(e){var t=r.call(this,e,g.VertexAndFragment,!0)||this;return t.registerInput("worldPosition",h.Vector4,!1),t}return n.prototype.getClassName=function(){return"ClipPlanesBlock"},n.prototype.initialize=function(e){e._excludeVariableName("vClipPlane"),e._excludeVariableName("fClipDistance"),e._excludeVariableName("vClipPlane2"),e._excludeVariableName("fClipDistance2"),e._excludeVariableName("vClipPlane3"),e._excludeVariableName("fClipDistance3"),e._excludeVariableName("vClipPlane4"),e._excludeVariableName("fClipDistance4"),e._excludeVariableName("vClipPlane5"),e._excludeVariableName("fClipDistance5"),e._excludeVariableName("vClipPlane6"),e._excludeVariableName("fClipDistance6")},Object.defineProperty(n.prototype,"worldPosition",{get:function(){return this._inputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"target",{get:function(){return g.VertexAndFragment},set:function(e){},enumerable:!1,configurable:!0}),n.prototype.prepareDefines=function(e,t,i){var o=e.getScene(),a=o.clipPlane!==void 0&&o.clipPlane!==null,s=o.clipPlane2!==void 0&&o.clipPlane2!==null,c=o.clipPlane3!==void 0&&o.clipPlane3!==null,l=o.clipPlane4!==void 0&&o.clipPlane4!==null,u=o.clipPlane5!==void 0&&o.clipPlane5!==null,f=o.clipPlane6!==void 0&&o.clipPlane6!==null;i.setValue("CLIPPLANE",a,!0),i.setValue("CLIPPLANE2",s,!0),i.setValue("CLIPPLANE3",c,!0),i.setValue("CLIPPLANE4",l,!0),i.setValue("CLIPPLANE5",u,!0),i.setValue("CLIPPLANE6",f,!0)},n.prototype.bind=function(e,t,i){if(!!i){var o=i.getScene();F.BindClipPlane(e,o)}},n.prototype._buildBlock=function(e){r.prototype._buildBlock.call(this,e);var t="//".concat(this.name);if(e.target!==g.Fragment){var i=this.worldPosition;e._emitFunctionFromInclude("clipPlaneVertexDeclaration",t,{replaceStrings:[{search:/uniform vec4 vClipPlane\d*;/g,replace:""}]}),e.compilationString+=e._emitCodeFromInclude("clipPlaneVertex",t,{replaceStrings:[{search:/worldPos/g,replace:i.associatedVariableName}]}),e._emitUniformFromString("vClipPlane","vec4"),e._emitUniformFromString("vClipPlane2","vec4"),e._emitUniformFromString("vClipPlane3","vec4"),e._emitUniformFromString("vClipPlane4","vec4"),e._emitUniformFromString("vClipPlane5","vec4"),e._emitUniformFromString("vClipPlane6","vec4");return}return e.sharedData.bindableBlocks.push(this),e.sharedData.blocksWithDefines.push(this),e._emitFunctionFromInclude("clipPlaneFragmentDeclaration",t),e.compilationString+=e._emitCodeFromInclude("clipPlaneFragment",t),this},n}(L);P("BABYLON.ClipPlanesBlock",sl);var cl=function(r){R(n,r);function n(e){var t=r.call(this,e,g.Neutral)||this;return t.registerInput("left",h.AutoDetect),t.registerInput("right",h.AutoDetect),t.registerOutput("output",h.BasedOnInput),t._outputs[0]._typeConnectionSource=t._inputs[0],t._linkConnectionTypes(0,1),t}return n.prototype.getClassName=function(){return"AddBlock"},Object.defineProperty(n.prototype,"left",{get:function(){return this._inputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"right",{get:function(){return this._inputs[1]},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"output",{get:function(){return this._outputs[0]},enumerable:!1,configurable:!0}),n.prototype._buildBlock=function(e){r.prototype._buildBlock.call(this,e);var t=this._outputs[0];return e.compilationString+=this._declareOutput(t,e)+" = ".concat(this.left.associatedVariableName," + ").concat(this.right.associatedVariableName,`;\r
`),this},n}(L);P("BABYLON.AddBlock",cl);var ll=function(r){R(n,r);function n(e){var t=r.call(this,e,g.Neutral)||this;return t.registerInput("input",h.AutoDetect),t.registerInput("factor",h.Float),t.registerOutput("output",h.BasedOnInput),t._outputs[0]._typeConnectionSource=t._inputs[0],t}return n.prototype.getClassName=function(){return"ScaleBlock"},Object.defineProperty(n.prototype,"input",{get:function(){return this._inputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"factor",{get:function(){return this._inputs[1]},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"output",{get:function(){return this._outputs[0]},enumerable:!1,configurable:!0}),n.prototype._buildBlock=function(e){r.prototype._buildBlock.call(this,e);var t=this._outputs[0];return e.compilationString+=this._declareOutput(t,e)+" = ".concat(this.input.associatedVariableName," * ").concat(this.factor.associatedVariableName,`;\r
`),this},n}(L);P("BABYLON.ScaleBlock",ll);var ul=function(r){R(n,r);function n(e){var t=r.call(this,e,g.Neutral)||this;return t.minimum=0,t.maximum=1,t.registerInput("value",h.AutoDetect),t.registerOutput("output",h.BasedOnInput),t._outputs[0]._typeConnectionSource=t._inputs[0],t}return n.prototype.getClassName=function(){return"ClampBlock"},Object.defineProperty(n.prototype,"value",{get:function(){return this._inputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"output",{get:function(){return this._outputs[0]},enumerable:!1,configurable:!0}),n.prototype._buildBlock=function(e){r.prototype._buildBlock.call(this,e);var t=this._outputs[0];return e.compilationString+=this._declareOutput(t,e)+" = clamp(".concat(this.value.associatedVariableName,", ").concat(this._writeFloat(this.minimum),", ").concat(this._writeFloat(this.maximum),`);\r
`),this},n.prototype._dumpPropertiesCode=function(){var e=r.prototype._dumpPropertiesCode.call(this)+"".concat(this._codeVariableName,".minimum = ").concat(this.minimum,`;\r
`);return e+="".concat(this._codeVariableName,".maximum = ").concat(this.maximum,`;\r
`),e},n.prototype.serialize=function(){var e=r.prototype.serialize.call(this);return e.minimum=this.minimum,e.maximum=this.maximum,e},n.prototype._deserialize=function(e,t,i){r.prototype._deserialize.call(this,e,t,i),this.minimum=e.minimum,this.maximum=e.maximum},E([te("Minimum",ee.Float)],n.prototype,"minimum",void 0),E([te("Maximum",ee.Float)],n.prototype,"maximum",void 0),n}(L);P("BABYLON.ClampBlock",ul);var fl=function(r){R(n,r);function n(e){var t=r.call(this,e,g.Neutral)||this;return t.registerInput("left",h.AutoDetect),t.registerInput("right",h.AutoDetect),t.registerOutput("output",h.Vector3),t._linkConnectionTypes(0,1),t._inputs[0].excludedConnectionPointTypes.push(h.Float),t._inputs[0].excludedConnectionPointTypes.push(h.Matrix),t._inputs[0].excludedConnectionPointTypes.push(h.Vector2),t._inputs[1].excludedConnectionPointTypes.push(h.Float),t._inputs[1].excludedConnectionPointTypes.push(h.Matrix),t._inputs[1].excludedConnectionPointTypes.push(h.Vector2),t}return n.prototype.getClassName=function(){return"CrossBlock"},Object.defineProperty(n.prototype,"left",{get:function(){return this._inputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"right",{get:function(){return this._inputs[1]},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"output",{get:function(){return this._outputs[0]},enumerable:!1,configurable:!0}),n.prototype._buildBlock=function(e){r.prototype._buildBlock.call(this,e);var t=this._outputs[0];return e.compilationString+=this._declareOutput(t,e)+" = cross(".concat(this.left.associatedVariableName,".xyz, ").concat(this.right.associatedVariableName,`.xyz);\r
`),this},n}(L);P("BABYLON.CrossBlock",fl);var hl=function(r){R(n,r);function n(e){return r.call(this,e)||this}return Object.defineProperty(n.prototype,"options",{get:function(){return this._options},set:function(e){this._deserializeOptions(e)},enumerable:!1,configurable:!0}),n.prototype.getClassName=function(){return"CustomBlock"},n.prototype._buildBlock=function(e){var t=this;r.prototype._buildBlock.call(this,e);var i=this._code,o=this._options.functionName;this._inputs.forEach(function(s){var c=new RegExp("\\{TYPE_"+s.name+"\\}","gm"),l=e._getGLType(s.type);i=i.replace(c,l),o=o.replace(c,l)}),this._outputs.forEach(function(s){var c=new RegExp("\\{TYPE_"+s.name+"\\}","gm"),l=e._getGLType(s.type);i=i.replace(c,l),o=o.replace(c,l)}),e._emitFunction(o,i,""),this._outputs.forEach(function(s){e.compilationString+=t._declareOutput(s,e)+`;\r
`}),e.compilationString+=o+"(";var a=!1;return this._inputs.forEach(function(s,c){c>0&&(e.compilationString+=", "),e.compilationString+=s.associatedVariableName,a=!0}),this._outputs.forEach(function(s,c){(c>0||a)&&(e.compilationString+=", "),e.compilationString+=s.associatedVariableName}),e.compilationString+=`);\r
`,this},n.prototype._dumpPropertiesCode=function(){var e=r.prototype._dumpPropertiesCode.call(this);return e+="".concat(this._codeVariableName,".options = ").concat(JSON.stringify(this._options),`;\r
`),e},n.prototype.serialize=function(){var e=r.prototype.serialize.call(this);return e.options=this._options,e},n.prototype._deserialize=function(e,t,i){this._deserializeOptions(e.options),r.prototype._deserialize.call(this,e,t,i)},n.prototype._deserializeOptions=function(e){var t=this,i,o,a;this._options=e,this._code=e.code.join(`\r
`)+`\r
`,this.name=this.name||e.name,this.target=g[e.target],(i=e.inParameters)===null||i===void 0||i.forEach(function(s,c){var l=h[s.type];t.registerInput(s.name,l),Object.defineProperty(t,s.name,{get:function(){return this._inputs[c]},enumerable:!0,configurable:!0})}),(o=e.outParameters)===null||o===void 0||o.forEach(function(s,c){t.registerOutput(s.name,h[s.type]),Object.defineProperty(t,s.name,{get:function(){return this._outputs[c]},enumerable:!0,configurable:!0}),s.type==="BasedOnInput"&&(t._outputs[c]._typeConnectionSource=t._findInputByName(s.typeFromInput)[0])}),(a=e.inLinkedConnectionTypes)===null||a===void 0||a.forEach(function(s){t._linkConnectionTypes(t._findInputByName(s.input1)[1],t._findInputByName(s.input2)[1])})},n.prototype._findInputByName=function(e){if(!e)return null;for(var t=0;t<this._inputs.length;t++)if(this._inputs[t].name===e)return[this._inputs[t],t];return null},n}(L);P("BABYLON.CustomBlock",hl);var dl=function(r){R(n,r);function n(e){var t=r.call(this,e,g.Neutral)||this;return t.registerInput("left",h.AutoDetect),t.registerInput("right",h.AutoDetect),t.registerOutput("output",h.Float),t._linkConnectionTypes(0,1),t._inputs[0].excludedConnectionPointTypes.push(h.Float),t._inputs[0].excludedConnectionPointTypes.push(h.Matrix),t._inputs[1].excludedConnectionPointTypes.push(h.Float),t._inputs[1].excludedConnectionPointTypes.push(h.Matrix),t}return n.prototype.getClassName=function(){return"DotBlock"},Object.defineProperty(n.prototype,"left",{get:function(){return this._inputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"right",{get:function(){return this._inputs[1]},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"output",{get:function(){return this._outputs[0]},enumerable:!1,configurable:!0}),n.prototype._buildBlock=function(e){r.prototype._buildBlock.call(this,e);var t=this._outputs[0];return e.compilationString+=this._declareOutput(t,e)+" = dot(".concat(this.left.associatedVariableName,", ").concat(this.right.associatedVariableName,`);\r
`),this},n}(L);P("BABYLON.DotBlock",dl);var pl=function(r){R(n,r);function n(e){var t=r.call(this,e,g.Neutral)||this;return t.registerInput("input",h.AutoDetect),t.registerOutput("output",h.BasedOnInput),t._outputs[0]._typeConnectionSource=t._inputs[0],t._inputs[0].excludedConnectionPointTypes.push(h.Float),t._inputs[0].excludedConnectionPointTypes.push(h.Matrix),t}return n.prototype.getClassName=function(){return"NormalizeBlock"},Object.defineProperty(n.prototype,"input",{get:function(){return this._inputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"output",{get:function(){return this._outputs[0]},enumerable:!1,configurable:!0}),n.prototype._buildBlock=function(e){r.prototype._buildBlock.call(this,e);var t=this._outputs[0],i=this._inputs[0];return e.compilationString+=this._declareOutput(t,e)+" = normalize(".concat(i.associatedVariableName,`);\r
`),this},n}(L);P("BABYLON.NormalizeBlock",pl);var ml=function(r){R(n,r);function n(e){var t=r.call(this,e,g.Neutral)||this;return t.rSwizzle="r",t.gSwizzle="g",t.bSwizzle="b",t.aSwizzle="a",t.registerInput("rgb ",h.Color3,!0),t.registerInput("r",h.Float,!0),t.registerInput("g",h.Float,!0),t.registerInput("b",h.Float,!0),t.registerInput("a",h.Float,!0),t.registerOutput("rgba",h.Color4),t.registerOutput("rgb",h.Color3),t}return n.prototype.getClassName=function(){return"ColorMergerBlock"},Object.defineProperty(n.prototype,"rgbIn",{get:function(){return this._inputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"r",{get:function(){return this._inputs[1]},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"g",{get:function(){return this._inputs[2]},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"b",{get:function(){return this._inputs[3]},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"a",{get:function(){return this._inputs[4]},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"rgba",{get:function(){return this._outputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"rgbOut",{get:function(){return this._outputs[1]},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"rgb",{get:function(){return this.rgbOut},enumerable:!1,configurable:!0}),n.prototype._inputRename=function(e){return e==="rgb "?"rgbIn":e},n.prototype._buildSwizzle=function(e){var t=this.rSwizzle+this.gSwizzle+this.bSwizzle+this.aSwizzle;return"."+t.substr(0,e)},n.prototype._buildBlock=function(e){r.prototype._buildBlock.call(this,e);var t=this.r,i=this.g,o=this.b,a=this.a,s=this.rgbIn,c=this._outputs[0],l=this._outputs[1];return s.isConnected?(c.hasEndpoints&&(e.compilationString+=this._declareOutput(c,e)+" = vec4(".concat(s.associatedVariableName,", ").concat(a.isConnected?this._writeVariable(a):"0.0",")").concat(this._buildSwizzle(4),`;\r
`)),l.hasEndpoints&&(e.compilationString+=this._declareOutput(l,e)+" = ".concat(s.associatedVariableName).concat(this._buildSwizzle(3),`;\r
`))):(c.hasEndpoints&&(e.compilationString+=this._declareOutput(c,e)+" = vec4(".concat(t.isConnected?this._writeVariable(t):"0.0",", ").concat(i.isConnected?this._writeVariable(i):"0.0",", ").concat(o.isConnected?this._writeVariable(o):"0.0",", ").concat(a.isConnected?this._writeVariable(a):"0.0",")").concat(this._buildSwizzle(4),`;\r
`)),l.hasEndpoints&&(e.compilationString+=this._declareOutput(l,e)+" = vec3(".concat(t.isConnected?this._writeVariable(t):"0.0",", ").concat(i.isConnected?this._writeVariable(i):"0.0",", ").concat(o.isConnected?this._writeVariable(o):"0.0",")").concat(this._buildSwizzle(3),`;\r
`))),this},n.prototype.serialize=function(){var e=r.prototype.serialize.call(this);return e.rSwizzle=this.rSwizzle,e.gSwizzle=this.gSwizzle,e.bSwizzle=this.bSwizzle,e.aSwizzle=this.aSwizzle,e},n.prototype._deserialize=function(e,t,i){var o,a,s,c;r.prototype._deserialize.call(this,e,t,i),this.rSwizzle=(o=e.rSwizzle)!==null&&o!==void 0?o:"r",this.gSwizzle=(a=e.gSwizzle)!==null&&a!==void 0?a:"g",this.bSwizzle=(s=e.bSwizzle)!==null&&s!==void 0?s:"b",this.aSwizzle=(c=e.aSwizzle)!==null&&c!==void 0?c:"a"},n.prototype._dumpPropertiesCode=function(){var e=r.prototype._dumpPropertiesCode.call(this);return e+="".concat(this._codeVariableName,".rSwizzle = ").concat(this.rSwizzle,`};\r
`),e+="".concat(this._codeVariableName,".gSwizzle = ").concat(this.gSwizzle,`};\r
`),e+="".concat(this._codeVariableName,".bSwizzle = ").concat(this.bSwizzle,`};\r
`),e+="".concat(this._codeVariableName,".aSwizzle = ").concat(this.aSwizzle,`};\r
`),e},n}(L);P("BABYLON.ColorMergerBlock",ml);var _l=function(r){R(n,r);function n(e){var t=r.call(this,e,g.Neutral)||this;return t.registerInput("xyzw",h.Vector4,!0),t.registerInput("xyz ",h.Vector3,!0),t.registerInput("xy ",h.Vector2,!0),t.registerOutput("xyz",h.Vector3),t.registerOutput("xy",h.Vector2),t.registerOutput("zw",h.Vector2),t.registerOutput("x",h.Float),t.registerOutput("y",h.Float),t.registerOutput("z",h.Float),t.registerOutput("w",h.Float),t.inputsAreExclusive=!0,t}return n.prototype.getClassName=function(){return"VectorSplitterBlock"},Object.defineProperty(n.prototype,"xyzw",{get:function(){return this._inputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"xyzIn",{get:function(){return this._inputs[1]},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"xyIn",{get:function(){return this._inputs[2]},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"xyzOut",{get:function(){return this._outputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"xyOut",{get:function(){return this._outputs[1]},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"zw",{get:function(){return this._outputs[2]},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"x",{get:function(){return this._outputs[3]},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"y",{get:function(){return this._outputs[4]},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"z",{get:function(){return this._outputs[5]},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"w",{get:function(){return this._outputs[6]},enumerable:!1,configurable:!0}),n.prototype._inputRename=function(e){switch(e){case"xy ":return"xyIn";case"xyz ":return"xyzIn";default:return e}},n.prototype._outputRename=function(e){switch(e){case"xy":return"xyOut";case"xyz":return"xyzOut";default:return e}},n.prototype._buildBlock=function(e){r.prototype._buildBlock.call(this,e);var t=this.xyzw.isConnected?this.xyzw:this.xyzIn.isConnected?this.xyzIn:this.xyIn,i=this._outputs[0],o=this._outputs[1],a=this._outputs[2],s=this._outputs[3],c=this._outputs[4],l=this._outputs[5],u=this._outputs[6];return i.hasEndpoints&&(t===this.xyIn?e.compilationString+=this._declareOutput(i,e)+" = vec3(".concat(t.associatedVariableName,`, 0.0);\r
`):e.compilationString+=this._declareOutput(i,e)+" = ".concat(t.associatedVariableName,`.xyz;\r
`)),a.hasEndpoints&&this.xyzw.isConnected&&(e.compilationString+=this._declareOutput(a,e)+" = ".concat(this.xyzw.associatedVariableName,`.zw;\r
`)),o.hasEndpoints&&(e.compilationString+=this._declareOutput(o,e)+" = ".concat(t.associatedVariableName,`.xy;\r
`)),s.hasEndpoints&&(e.compilationString+=this._declareOutput(s,e)+" = ".concat(t.associatedVariableName,`.x;\r
`)),c.hasEndpoints&&(e.compilationString+=this._declareOutput(c,e)+" = ".concat(t.associatedVariableName,`.y;\r
`)),l.hasEndpoints&&(e.compilationString+=this._declareOutput(l,e)+" = ".concat(t.associatedVariableName,`.z;\r
`)),u.hasEndpoints&&(e.compilationString+=this._declareOutput(u,e)+" = ".concat(t.associatedVariableName,`.w;\r
`)),this},n}(L);P("BABYLON.VectorSplitterBlock",_l);var gl=function(r){R(n,r);function n(e){var t=r.call(this,e,g.Neutral)||this;return t.registerInput("left",h.AutoDetect),t.registerInput("right",h.AutoDetect),t.registerInput("gradient",h.AutoDetect),t.registerOutput("output",h.BasedOnInput),t._outputs[0]._typeConnectionSource=t._inputs[0],t._linkConnectionTypes(0,1),t._linkConnectionTypes(1,2,!0),t._inputs[2].acceptedConnectionPointTypes.push(h.Float),t}return n.prototype.getClassName=function(){return"LerpBlock"},Object.defineProperty(n.prototype,"left",{get:function(){return this._inputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"right",{get:function(){return this._inputs[1]},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"gradient",{get:function(){return this._inputs[2]},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"output",{get:function(){return this._outputs[0]},enumerable:!1,configurable:!0}),n.prototype._buildBlock=function(e){r.prototype._buildBlock.call(this,e);var t=this._outputs[0];return e.compilationString+=this._declareOutput(t,e)+" = mix(".concat(this.left.associatedVariableName," , ").concat(this.right.associatedVariableName,", ").concat(this.gradient.associatedVariableName,`);\r
`),this},n}(L);P("BABYLON.LerpBlock",gl);var vl=function(r){R(n,r);function n(e){var t=r.call(this,e,g.Neutral)||this;return t.registerInput("left",h.AutoDetect),t.registerInput("right",h.AutoDetect),t.registerOutput("output",h.BasedOnInput),t._outputs[0]._typeConnectionSource=t._inputs[0],t._linkConnectionTypes(0,1),t}return n.prototype.getClassName=function(){return"DivideBlock"},Object.defineProperty(n.prototype,"left",{get:function(){return this._inputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"right",{get:function(){return this._inputs[1]},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"output",{get:function(){return this._outputs[0]},enumerable:!1,configurable:!0}),n.prototype._buildBlock=function(e){r.prototype._buildBlock.call(this,e);var t=this._outputs[0];return e.compilationString+=this._declareOutput(t,e)+" = ".concat(this.left.associatedVariableName," / ").concat(this.right.associatedVariableName,`;\r
`),this},n}(L);P("BABYLON.DivideBlock",vl);var El=function(r){R(n,r);function n(e){var t=r.call(this,e,g.Neutral)||this;return t.registerInput("left",h.AutoDetect),t.registerInput("right",h.AutoDetect),t.registerOutput("output",h.BasedOnInput),t._outputs[0]._typeConnectionSource=t._inputs[0],t._linkConnectionTypes(0,1),t}return n.prototype.getClassName=function(){return"SubtractBlock"},Object.defineProperty(n.prototype,"left",{get:function(){return this._inputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"right",{get:function(){return this._inputs[1]},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"output",{get:function(){return this._outputs[0]},enumerable:!1,configurable:!0}),n.prototype._buildBlock=function(e){r.prototype._buildBlock.call(this,e);var t=this._outputs[0];return e.compilationString+=this._declareOutput(t,e)+" = ".concat(this.left.associatedVariableName," - ").concat(this.right.associatedVariableName,`;\r
`),this},n}(L);P("BABYLON.SubtractBlock",El);var bl=function(r){R(n,r);function n(e){var t=r.call(this,e,g.Neutral)||this;return t.registerInput("value",h.Float),t.registerInput("edge",h.Float),t.registerOutput("output",h.Float),t}return n.prototype.getClassName=function(){return"StepBlock"},Object.defineProperty(n.prototype,"value",{get:function(){return this._inputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"edge",{get:function(){return this._inputs[1]},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"output",{get:function(){return this._outputs[0]},enumerable:!1,configurable:!0}),n.prototype._buildBlock=function(e){r.prototype._buildBlock.call(this,e);var t=this._outputs[0];return e.compilationString+=this._declareOutput(t,e)+" = step(".concat(this.edge.associatedVariableName,", ").concat(this.value.associatedVariableName,`);\r
`),this},n}(L);P("BABYLON.StepBlock",bl);var Fr=function(r){R(n,r);function n(e){var t=r.call(this,e,g.Neutral)||this;return t.registerInput("input",h.AutoDetect),t.registerOutput("output",h.BasedOnInput),t._outputs[0]._typeConnectionSource=t._inputs[0],t._outputs[0].excludedConnectionPointTypes.push(h.Matrix),t}return n.prototype.getClassName=function(){return"OneMinusBlock"},Object.defineProperty(n.prototype,"input",{get:function(){return this._inputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"output",{get:function(){return this._outputs[0]},enumerable:!1,configurable:!0}),n.prototype._buildBlock=function(e){r.prototype._buildBlock.call(this,e);var t=this._outputs[0];return e.compilationString+=this._declareOutput(t,e)+" = 1. - ".concat(this.input.associatedVariableName,`;\r
`),this},n}(L);P("BABYLON.OneMinusBlock",Fr);P("BABYLON.OppositeBlock",Fr);var Dr=function(r){R(n,r);function n(e){var t=r.call(this,e,g.Neutral)||this;return t.registerInput("worldPosition",h.Vector4),t.registerInput("cameraPosition",h.Vector3),t.registerOutput("output",h.Vector3),t}return n.prototype.getClassName=function(){return"ViewDirectionBlock"},Object.defineProperty(n.prototype,"worldPosition",{get:function(){return this._inputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"cameraPosition",{get:function(){return this._inputs[1]},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"output",{get:function(){return this._outputs[0]},enumerable:!1,configurable:!0}),n.prototype.autoConfigure=function(e){if(!this.cameraPosition.isConnected){var t=e.getInputBlockByPredicate(function(i){return i.systemValue===Y.CameraPosition});t||(t=new K("cameraPosition"),t.setAsSystemValue(Y.CameraPosition)),t.output.connectTo(this.cameraPosition)}},n.prototype._buildBlock=function(e){r.prototype._buildBlock.call(this,e);var t=this._outputs[0];return e.compilationString+=this._declareOutput(t,e)+" = normalize(".concat(this.cameraPosition.associatedVariableName," - ").concat(this.worldPosition.associatedVariableName,`.xyz);\r
`),this},n}(L);P("BABYLON.ViewDirectionBlock",Dr);var Al=function(r){R(n,r);function n(e){var t=r.call(this,e,g.Neutral)||this;return t.registerInput("worldNormal",h.Vector4),t.registerInput("viewDirection",h.Vector3),t.registerInput("bias",h.Float),t.registerInput("power",h.Float),t.registerOutput("fresnel",h.Float),t}return n.prototype.getClassName=function(){return"FresnelBlock"},Object.defineProperty(n.prototype,"worldNormal",{get:function(){return this._inputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"viewDirection",{get:function(){return this._inputs[1]},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"bias",{get:function(){return this._inputs[2]},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"power",{get:function(){return this._inputs[3]},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"fresnel",{get:function(){return this._outputs[0]},enumerable:!1,configurable:!0}),n.prototype.autoConfigure=function(e){if(!this.viewDirection.isConnected){var t=new Dr("View direction");t.output.connectTo(this.viewDirection),t.autoConfigure(e)}if(!this.bias.isConnected){var i=new K("bias");i.value=0,i.output.connectTo(this.bias)}if(!this.power.isConnected){var o=new K("power");o.value=1,o.output.connectTo(this.power)}},n.prototype._buildBlock=function(e){r.prototype._buildBlock.call(this,e);var t="//".concat(this.name);return e._emitFunctionFromInclude("fresnelFunction",t,{removeIfDef:!0}),e.compilationString+=this._declareOutput(this.fresnel,e)+" = computeFresnelTerm(".concat(this.viewDirection.associatedVariableName,".xyz, ").concat(this.worldNormal.associatedVariableName,".xyz, ").concat(this.bias.associatedVariableName,", ").concat(this.power.associatedVariableName,`);\r
`),this},n}(L);P("BABYLON.FresnelBlock",Al);var yl=function(r){R(n,r);function n(e){var t=r.call(this,e,g.Neutral)||this;return t.registerInput("left",h.AutoDetect),t.registerInput("right",h.AutoDetect),t.registerOutput("output",h.BasedOnInput),t._outputs[0]._typeConnectionSource=t._inputs[0],t._linkConnectionTypes(0,1),t}return n.prototype.getClassName=function(){return"MaxBlock"},Object.defineProperty(n.prototype,"left",{get:function(){return this._inputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"right",{get:function(){return this._inputs[1]},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"output",{get:function(){return this._outputs[0]},enumerable:!1,configurable:!0}),n.prototype._buildBlock=function(e){r.prototype._buildBlock.call(this,e);var t=this._outputs[0];return e.compilationString+=this._declareOutput(t,e)+" = max(".concat(this.left.associatedVariableName,", ").concat(this.right.associatedVariableName,`);\r
`),this},n}(L);P("BABYLON.MaxBlock",yl);var Cl=function(r){R(n,r);function n(e){var t=r.call(this,e,g.Neutral)||this;return t.registerInput("left",h.AutoDetect),t.registerInput("right",h.AutoDetect),t.registerOutput("output",h.BasedOnInput),t._outputs[0]._typeConnectionSource=t._inputs[0],t._linkConnectionTypes(0,1),t}return n.prototype.getClassName=function(){return"MinBlock"},Object.defineProperty(n.prototype,"left",{get:function(){return this._inputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"right",{get:function(){return this._inputs[1]},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"output",{get:function(){return this._outputs[0]},enumerable:!1,configurable:!0}),n.prototype._buildBlock=function(e){r.prototype._buildBlock.call(this,e);var t=this._outputs[0];return e.compilationString+=this._declareOutput(t,e)+" = min(".concat(this.left.associatedVariableName,", ").concat(this.right.associatedVariableName,`);\r
`),this},n}(L);P("BABYLON.MinBlock",Cl);var Tl=function(r){R(n,r);function n(e){var t=r.call(this,e,g.Neutral)||this;return t.registerInput("left",h.AutoDetect),t.registerInput("right",h.AutoDetect),t.registerOutput("output",h.Float),t._linkConnectionTypes(0,1),t._inputs[0].excludedConnectionPointTypes.push(h.Float),t._inputs[0].excludedConnectionPointTypes.push(h.Matrix),t._inputs[1].excludedConnectionPointTypes.push(h.Float),t._inputs[1].excludedConnectionPointTypes.push(h.Matrix),t}return n.prototype.getClassName=function(){return"DistanceBlock"},Object.defineProperty(n.prototype,"left",{get:function(){return this._inputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"right",{get:function(){return this._inputs[1]},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"output",{get:function(){return this._outputs[0]},enumerable:!1,configurable:!0}),n.prototype._buildBlock=function(e){r.prototype._buildBlock.call(this,e);var t=this._outputs[0];return e.compilationString+=this._declareOutput(t,e)+" = length(".concat(this.left.associatedVariableName," - ").concat(this.right.associatedVariableName,`);\r
`),this},n}(L);P("BABYLON.DistanceBlock",Tl);var Sl=function(r){R(n,r);function n(e){var t=r.call(this,e,g.Neutral)||this;return t.registerInput("value",h.AutoDetect),t.registerOutput("output",h.Float),t._inputs[0].excludedConnectionPointTypes.push(h.Float),t._inputs[0].excludedConnectionPointTypes.push(h.Matrix),t}return n.prototype.getClassName=function(){return"LengthBlock"},Object.defineProperty(n.prototype,"value",{get:function(){return this._inputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"output",{get:function(){return this._outputs[0]},enumerable:!1,configurable:!0}),n.prototype._buildBlock=function(e){r.prototype._buildBlock.call(this,e);var t=this._outputs[0];return e.compilationString+=this._declareOutput(t,e)+" = length(".concat(this.value.associatedVariableName,`);\r
`),this},n}(L);P("BABYLON.LengthBlock",Sl);var Rl=function(r){R(n,r);function n(e){var t=r.call(this,e,g.Neutral)||this;return t.registerInput("value",h.AutoDetect),t.registerOutput("output",h.BasedOnInput),t._outputs[0]._typeConnectionSource=t._inputs[0],t}return n.prototype.getClassName=function(){return"NegateBlock"},Object.defineProperty(n.prototype,"value",{get:function(){return this._inputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"output",{get:function(){return this._outputs[0]},enumerable:!1,configurable:!0}),n.prototype._buildBlock=function(e){r.prototype._buildBlock.call(this,e);var t=this._outputs[0];return e.compilationString+=this._declareOutput(t,e)+" = -1.0 * ".concat(this.value.associatedVariableName,`;\r
`),this},n}(L);P("BABYLON.NegateBlock",Rl);var Ol=function(r){R(n,r);function n(e){var t=r.call(this,e,g.Neutral)||this;return t.registerInput("value",h.AutoDetect),t.registerInput("power",h.AutoDetect),t.registerOutput("output",h.BasedOnInput),t._outputs[0]._typeConnectionSource=t._inputs[0],t._linkConnectionTypes(0,1),t}return n.prototype.getClassName=function(){return"PowBlock"},Object.defineProperty(n.prototype,"value",{get:function(){return this._inputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"power",{get:function(){return this._inputs[1]},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"output",{get:function(){return this._outputs[0]},enumerable:!1,configurable:!0}),n.prototype._buildBlock=function(e){r.prototype._buildBlock.call(this,e);var t=this._outputs[0];return e.compilationString+=this._declareOutput(t,e)+" = pow(".concat(this.value.associatedVariableName,", ").concat(this.power.associatedVariableName,`);\r
`),this},n}(L);P("BABYLON.PowBlock",Ol);var Nl=function(r){R(n,r);function n(e){var t=r.call(this,e,g.Neutral)||this;return t.registerInput("seed",h.Vector2),t.registerOutput("output",h.Float),t._inputs[0].acceptedConnectionPointTypes.push(h.Vector3),t._inputs[0].acceptedConnectionPointTypes.push(h.Vector4),t._inputs[0].acceptedConnectionPointTypes.push(h.Color3),t._inputs[0].acceptedConnectionPointTypes.push(h.Color4),t}return n.prototype.getClassName=function(){return"RandomNumberBlock"},Object.defineProperty(n.prototype,"seed",{get:function(){return this._inputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"output",{get:function(){return this._outputs[0]},enumerable:!1,configurable:!0}),n.prototype._buildBlock=function(e){r.prototype._buildBlock.call(this,e);var t=this._outputs[0],i="//".concat(this.name);return e._emitFunctionFromInclude("helperFunctions",i),e.compilationString+=this._declareOutput(t,e)+" = getRand(".concat(this.seed.associatedVariableName,`.xy);\r
`),this},n}(L);P("BABYLON.RandomNumberBlock",Nl);var Il=function(r){R(n,r);function n(e){var t=r.call(this,e,g.Neutral)||this;return t.registerInput("x",h.Float),t.registerInput("y",h.Float),t.registerOutput("output",h.Float),t}return n.prototype.getClassName=function(){return"ArcTan2Block"},Object.defineProperty(n.prototype,"x",{get:function(){return this._inputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"y",{get:function(){return this._inputs[1]},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"output",{get:function(){return this._outputs[0]},enumerable:!1,configurable:!0}),n.prototype._buildBlock=function(e){r.prototype._buildBlock.call(this,e);var t=this._outputs[0];return e.compilationString+=this._declareOutput(t,e)+" = atan(".concat(this.x.associatedVariableName,", ").concat(this.y.associatedVariableName,`);\r
`),this},n}(L);P("BABYLON.ArcTan2Block",Il);var Pl=function(r){R(n,r);function n(e){var t=r.call(this,e,g.Neutral)||this;return t.registerInput("value",h.AutoDetect),t.registerInput("edge0",h.Float),t.registerInput("edge1",h.Float),t.registerOutput("output",h.BasedOnInput),t._outputs[0]._typeConnectionSource=t._inputs[0],t}return n.prototype.getClassName=function(){return"SmoothStepBlock"},Object.defineProperty(n.prototype,"value",{get:function(){return this._inputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"edge0",{get:function(){return this._inputs[1]},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"edge1",{get:function(){return this._inputs[2]},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"output",{get:function(){return this._outputs[0]},enumerable:!1,configurable:!0}),n.prototype._buildBlock=function(e){r.prototype._buildBlock.call(this,e);var t=this._outputs[0];return e.compilationString+=this._declareOutput(t,e)+" = smoothstep(".concat(this.edge0.associatedVariableName,", ").concat(this.edge1.associatedVariableName,", ").concat(this.value.associatedVariableName,`);\r
`),this},n}(L);P("BABYLON.SmoothStepBlock",Pl);var xl=function(r){R(n,r);function n(e){var t=r.call(this,e,g.Neutral)||this;return t.registerInput("input",h.AutoDetect),t.registerOutput("output",h.BasedOnInput),t._outputs[0]._typeConnectionSource=t._inputs[0],t._outputs[0].excludedConnectionPointTypes.push(h.Matrix),t}return n.prototype.getClassName=function(){return"ReciprocalBlock"},Object.defineProperty(n.prototype,"input",{get:function(){return this._inputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"output",{get:function(){return this._outputs[0]},enumerable:!1,configurable:!0}),n.prototype._buildBlock=function(e){r.prototype._buildBlock.call(this,e);var t=this._outputs[0];return e.compilationString+=this._declareOutput(t,e)+" = 1. / ".concat(this.input.associatedVariableName,`;\r
`),this},n}(L);P("BABYLON.ReciprocalBlock",xl);var Ml=function(r){R(n,r);function n(e){var t=r.call(this,e,g.Neutral)||this;return t.registerInput("value",h.AutoDetect),t.registerInput("reference",h.AutoDetect),t.registerInput("distance",h.Float),t.registerInput("replacement",h.AutoDetect),t.registerOutput("output",h.BasedOnInput),t._outputs[0]._typeConnectionSource=t._inputs[0],t._linkConnectionTypes(0,1),t._linkConnectionTypes(0,3),t._inputs[0].excludedConnectionPointTypes.push(h.Float),t._inputs[0].excludedConnectionPointTypes.push(h.Matrix),t._inputs[1].excludedConnectionPointTypes.push(h.Float),t._inputs[1].excludedConnectionPointTypes.push(h.Matrix),t._inputs[3].excludedConnectionPointTypes.push(h.Float),t._inputs[3].excludedConnectionPointTypes.push(h.Matrix),t}return n.prototype.getClassName=function(){return"ReplaceColorBlock"},Object.defineProperty(n.prototype,"value",{get:function(){return this._inputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"reference",{get:function(){return this._inputs[1]},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"distance",{get:function(){return this._inputs[2]},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"replacement",{get:function(){return this._inputs[3]},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"output",{get:function(){return this._outputs[0]},enumerable:!1,configurable:!0}),n.prototype._buildBlock=function(e){r.prototype._buildBlock.call(this,e);var t=this._outputs[0];return e.compilationString+=this._declareOutput(t,e)+`;\r
`,e.compilationString+="if (length(".concat(this.value.associatedVariableName," - ").concat(this.reference.associatedVariableName,") < ").concat(this.distance.associatedVariableName,`) {\r
`),e.compilationString+="".concat(t.associatedVariableName," = ").concat(this.replacement.associatedVariableName,`;\r
`),e.compilationString+=`} else {\r
`,e.compilationString+="".concat(t.associatedVariableName," = ").concat(this.value.associatedVariableName,`;\r
`),e.compilationString+=`}\r
`,this},n}(L);P("BABYLON.ReplaceColorBlock",Ml);var Ll=function(r){R(n,r);function n(e){var t=r.call(this,e,g.Neutral)||this;return t.registerInput("value",h.AutoDetect),t.registerInput("steps",h.AutoDetect),t.registerOutput("output",h.BasedOnInput),t._outputs[0]._typeConnectionSource=t._inputs[0],t._linkConnectionTypes(0,1),t._inputs[0].excludedConnectionPointTypes.push(h.Matrix),t._inputs[1].excludedConnectionPointTypes.push(h.Matrix),t}return n.prototype.getClassName=function(){return"PosterizeBlock"},Object.defineProperty(n.prototype,"value",{get:function(){return this._inputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"steps",{get:function(){return this._inputs[1]},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"output",{get:function(){return this._outputs[0]},enumerable:!1,configurable:!0}),n.prototype._buildBlock=function(e){r.prototype._buildBlock.call(this,e);var t=this._outputs[0];return e.compilationString+=this._declareOutput(t,e)+" = floor(".concat(this.value.associatedVariableName," / (1.0 / ").concat(this.steps.associatedVariableName,")) * (1.0 / ").concat(this.steps.associatedVariableName,`);\r
`),this},n}(L);P("BABYLON.PosterizeBlock",Ll);var St;(function(r){r[r.SawTooth=0]="SawTooth",r[r.Square=1]="Square",r[r.Triangle=2]="Triangle"})(St||(St={}));var Fl=function(r){R(n,r);function n(e){var t=r.call(this,e,g.Neutral)||this;return t.kind=St.SawTooth,t.registerInput("input",h.AutoDetect),t.registerOutput("output",h.BasedOnInput),t._outputs[0]._typeConnectionSource=t._inputs[0],t._inputs[0].excludedConnectionPointTypes.push(h.Matrix),t}return n.prototype.getClassName=function(){return"WaveBlock"},Object.defineProperty(n.prototype,"input",{get:function(){return this._inputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"output",{get:function(){return this._outputs[0]},enumerable:!1,configurable:!0}),n.prototype._buildBlock=function(e){r.prototype._buildBlock.call(this,e);var t=this._outputs[0];switch(this.kind){case St.SawTooth:{e.compilationString+=this._declareOutput(t,e)+" = ".concat(this.input.associatedVariableName," - floor(0.5 + ").concat(this.input.associatedVariableName,`);\r
`);break}case St.Square:{e.compilationString+=this._declareOutput(t,e)+" = 1.0 - 2.0 * round(fract(".concat(this.input.associatedVariableName,`));\r
`);break}case St.Triangle:{e.compilationString+=this._declareOutput(t,e)+" = 2.0 * abs(2.0 * (".concat(this.input.associatedVariableName," - floor(0.5 + ").concat(this.input.associatedVariableName,`))) - 1.0;\r
`);break}}return this},n.prototype.serialize=function(){var e=r.prototype.serialize.call(this);return e.kind=this.kind,e},n.prototype._deserialize=function(e,t,i){r.prototype._deserialize.call(this,e,t,i),this.kind=e.kind},n}(L);P("BABYLON.WaveBlock",Fl);var On=function(){function r(n,e){this.step=n,this.color=e}return Object.defineProperty(r.prototype,"step",{get:function(){return this._step},set:function(n){this._step=n},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"color",{get:function(){return this._color},set:function(n){this._color=n},enumerable:!1,configurable:!0}),r}(),Dl=function(r){R(n,r);function n(e){var t=r.call(this,e,g.Neutral)||this;return t.colorSteps=[new On(0,G.Black()),new On(1,G.White())],t.onValueChangedObservable=new U,t.registerInput("gradient",h.Float),t.registerOutput("output",h.Color3),t._inputs[0].acceptedConnectionPointTypes.push(h.Vector2),t._inputs[0].acceptedConnectionPointTypes.push(h.Vector3),t._inputs[0].acceptedConnectionPointTypes.push(h.Vector4),t._inputs[0].acceptedConnectionPointTypes.push(h.Color3),t._inputs[0].acceptedConnectionPointTypes.push(h.Color4),t}return n.prototype.colorStepsUpdated=function(){this.onValueChangedObservable.notifyObservers(this)},n.prototype.getClassName=function(){return"GradientBlock"},Object.defineProperty(n.prototype,"gradient",{get:function(){return this._inputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"output",{get:function(){return this._outputs[0]},enumerable:!1,configurable:!0}),n.prototype._writeColorConstant=function(e){var t=this.colorSteps[e];return"vec3(".concat(t.color.r,", ").concat(t.color.g,", ").concat(t.color.b,")")},n.prototype._buildBlock=function(e){r.prototype._buildBlock.call(this,e);var t=this._outputs[0];if(!this.colorSteps.length||!this.gradient.connectedPoint){e.compilationString+=this._declareOutput(t,e)+` = vec3(0., 0., 0.);\r
`;return}var i=e._getFreeVariableName("gradientTempColor"),o=e._getFreeVariableName("gradientTempPosition");e.compilationString+="vec3 ".concat(i," = ").concat(this._writeColorConstant(0),`;\r
`),e.compilationString+="float ".concat(o,`;\r
`);var a=this.gradient.associatedVariableName;this.gradient.connectedPoint.type!==h.Float&&(a+=".x");for(var s=1;s<this.colorSteps.length;s++){var c=this.colorSteps[s],l=this.colorSteps[s-1];e.compilationString+="".concat(o," = clamp((").concat(a," - ").concat(e._emitFloat(l.step),") / (").concat(e._emitFloat(c.step)," -  ").concat(e._emitFloat(l.step),"), 0.0, 1.0) * step(").concat(e._emitFloat(s),", ").concat(e._emitFloat(this.colorSteps.length-1),`);\r
`),e.compilationString+="".concat(i," = mix(").concat(i,", ").concat(this._writeColorConstant(s),", ").concat(o,`);\r
`)}return e.compilationString+=this._declareOutput(t,e)+" = ".concat(i,`;\r
`),this},n.prototype.serialize=function(){var e=r.prototype.serialize.call(this);e.colorSteps=[];for(var t=0,i=this.colorSteps;t<i.length;t++){var o=i[t];e.colorSteps.push({step:o.step,color:{r:o.color.r,g:o.color.g,b:o.color.b}})}return e},n.prototype._deserialize=function(e,t,i){r.prototype._deserialize.call(this,e,t,i),this.colorSteps=[];for(var o=0,a=e.colorSteps;o<a.length;o++){var s=a[o];this.colorSteps.push(new On(s.step,new G(s.color.r,s.color.g,s.color.b)))}},n.prototype._dumpPropertiesCode=function(){var e=r.prototype._dumpPropertiesCode.call(this);e+="".concat(this._codeVariableName,`.colorSteps = [];\r
`);for(var t=0,i=this.colorSteps;t<i.length;t++){var o=i[t];e+="".concat(this._codeVariableName,".colorSteps.push(new BABYLON.GradientBlockColorStep(").concat(o.step,", new BABYLON.Color3(").concat(o.color.r,", ").concat(o.color.g,", ").concat(o.color.b,`)));\r
`)}return e},n}(L);P("BABYLON.GradientBlock",Dl);var Bl=function(r){R(n,r);function n(e){var t=r.call(this,e,g.Neutral)||this;return t.registerInput("left",h.AutoDetect),t.registerInput("right",h.AutoDetect),t.registerInput("gradient",h.AutoDetect),t.registerOutput("output",h.BasedOnInput),t._outputs[0]._typeConnectionSource=t._inputs[0],t._linkConnectionTypes(0,1),t._linkConnectionTypes(1,2,!0),t._inputs[2].acceptedConnectionPointTypes.push(h.Float),t}return n.prototype.getClassName=function(){return"NLerpBlock"},Object.defineProperty(n.prototype,"left",{get:function(){return this._inputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"right",{get:function(){return this._inputs[1]},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"gradient",{get:function(){return this._inputs[2]},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"output",{get:function(){return this._outputs[0]},enumerable:!1,configurable:!0}),n.prototype._buildBlock=function(e){r.prototype._buildBlock.call(this,e);var t=this._outputs[0];return e.compilationString+=this._declareOutput(t,e)+" = normalize(mix(".concat(this.left.associatedVariableName," , ").concat(this.right.associatedVariableName,", ").concat(this.gradient.associatedVariableName,`));\r
`),this},n}(L);P("BABYLON.NLerpBlock",Bl);var wl=function(r){R(n,r);function n(e){var t=r.call(this,e,g.Neutral)||this;return t.manhattanDistance=!1,t.registerInput("seed",h.Vector3),t.registerInput("jitter",h.Float),t.registerOutput("output",h.Vector2),t.registerOutput("x",h.Float),t.registerOutput("y",h.Float),t}return n.prototype.getClassName=function(){return"WorleyNoise3DBlock"},Object.defineProperty(n.prototype,"seed",{get:function(){return this._inputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"jitter",{get:function(){return this._inputs[1]},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"output",{get:function(){return this._outputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"x",{get:function(){return this._outputs[1]},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"y",{get:function(){return this._outputs[2]},enumerable:!1,configurable:!0}),n.prototype._buildBlock=function(e){if(r.prototype._buildBlock.call(this,e),!!this.seed.isConnected&&!(!this.output.hasEndpoints&&!this.x.hasEndpoints&&!this.y.hasEndpoints)){var t=`vec3 permute(vec3 x){\r
`;t+=`    return mod((34.0 * x + 1.0) * x, 289.0);\r
`,t+=`}\r
\r
`,t+=`vec3 dist(vec3 x, vec3 y, vec3 z,  bool manhattanDistance){\r
`,t+=`    return manhattanDistance ?  abs(x) + abs(y) + abs(z) :  (x * x + y * y + z * z);\r
`,t+=`}\r
\r
`,t+=`vec2 worley(vec3 P, float jitter, bool manhattanDistance){\r
`,t+=`    float K = 0.142857142857; // 1/7\r
`,t+=`    float Ko = 0.428571428571; // 1/2-K/2\r
`,t+=`    float  K2 = 0.020408163265306; // 1/(7*7)\r
`,t+=`    float Kz = 0.166666666667; // 1/6\r
`,t+=`    float Kzo = 0.416666666667; // 1/2-1/6*2\r
`,t+=`\r
`,t+=`    vec3 Pi = mod(floor(P), 289.0);\r
`,t+=`    vec3 Pf = fract(P) - 0.5;\r
`,t+=`\r
`,t+=`    vec3 Pfx = Pf.x + vec3(1.0, 0.0, -1.0);\r
`,t+=`    vec3 Pfy = Pf.y + vec3(1.0, 0.0, -1.0);\r
`,t+=`    vec3 Pfz = Pf.z + vec3(1.0, 0.0, -1.0);\r
`,t+=`\r
`,t+=`    vec3 p = permute(Pi.x + vec3(-1.0, 0.0, 1.0));\r
`,t+=`    vec3 p1 = permute(p + Pi.y - 1.0);\r
`,t+=`    vec3 p2 = permute(p + Pi.y);\r
`,t+=`    vec3 p3 = permute(p + Pi.y + 1.0);\r
`,t+=`\r
`,t+=`    vec3 p11 = permute(p1 + Pi.z - 1.0);\r
`,t+=`    vec3 p12 = permute(p1 + Pi.z);\r
`,t+=`    vec3 p13 = permute(p1 + Pi.z + 1.0);\r
`,t+=`\r
`,t+=`    vec3 p21 = permute(p2 + Pi.z - 1.0);\r
`,t+=`    vec3 p22 = permute(p2 + Pi.z);\r
`,t+=`    vec3 p23 = permute(p2 + Pi.z + 1.0);\r
`,t+=`\r
`,t+=`    vec3 p31 = permute(p3 + Pi.z - 1.0);\r
`,t+=`    vec3 p32 = permute(p3 + Pi.z);\r
`,t+=`    vec3 p33 = permute(p3 + Pi.z + 1.0);\r
`,t+=`\r
`,t+=`    vec3 ox11 = fract(p11*K) - Ko;\r
`,t+=`    vec3 oy11 = mod(floor(p11*K), 7.0)*K - Ko;\r
`,t+=`    vec3 oz11 = floor(p11*K2)*Kz - Kzo; // p11 < 289 guaranteed\r
`,t+=`\r
`,t+=`    vec3 ox12 = fract(p12*K) - Ko;\r
`,t+=`    vec3 oy12 = mod(floor(p12*K), 7.0)*K - Ko;\r
`,t+=`    vec3 oz12 = floor(p12*K2)*Kz - Kzo;\r
`,t+=`\r
`,t+=`    vec3 ox13 = fract(p13*K) - Ko;\r
`,t+=`    vec3 oy13 = mod(floor(p13*K), 7.0)*K - Ko;\r
`,t+=`    vec3 oz13 = floor(p13*K2)*Kz - Kzo;\r
`,t+=`\r
`,t+=`    vec3 ox21 = fract(p21*K) - Ko;\r
`,t+=`    vec3 oy21 = mod(floor(p21*K), 7.0)*K - Ko;\r
`,t+=`    vec3 oz21 = floor(p21*K2)*Kz - Kzo;\r
`,t+=`\r
`,t+=`    vec3 ox22 = fract(p22*K) - Ko;\r
`,t+=`    vec3 oy22 = mod(floor(p22*K), 7.0)*K - Ko;\r
`,t+=`    vec3 oz22 = floor(p22*K2)*Kz - Kzo;\r
`,t+=`\r
`,t+=`    vec3 ox23 = fract(p23*K) - Ko;\r
`,t+=`    vec3 oy23 = mod(floor(p23*K), 7.0)*K - Ko;\r
`,t+=`    vec3 oz23 = floor(p23*K2)*Kz - Kzo;\r
`,t+=`\r
`,t+=`    vec3 ox31 = fract(p31*K) - Ko;\r
`,t+=`    vec3 oy31 = mod(floor(p31*K), 7.0)*K - Ko;\r
`,t+=`    vec3 oz31 = floor(p31*K2)*Kz - Kzo;\r
`,t+=`\r
`,t+=`    vec3 ox32 = fract(p32*K) - Ko;\r
`,t+=`    vec3 oy32 = mod(floor(p32*K), 7.0)*K - Ko;\r
`,t+=`    vec3 oz32 = floor(p32*K2)*Kz - Kzo;\r
`,t+=`\r
`,t+=`    vec3 ox33 = fract(p33*K) - Ko;\r
`,t+=`    vec3 oy33 = mod(floor(p33*K), 7.0)*K - Ko;\r
`,t+=`    vec3 oz33 = floor(p33*K2)*Kz - Kzo;\r
`,t+=`\r
`,t+=`    vec3 dx11 = Pfx + jitter*ox11;\r
`,t+=`    vec3 dy11 = Pfy.x + jitter*oy11;\r
`,t+=`    vec3 dz11 = Pfz.x + jitter*oz11;\r
`,t+=`\r
`,t+=`    vec3 dx12 = Pfx + jitter*ox12;\r
`,t+=`    vec3 dy12 = Pfy.x + jitter*oy12;\r
`,t+=`    vec3 dz12 = Pfz.y + jitter*oz12;\r
`,t+=`\r
`,t+=`    vec3 dx13 = Pfx + jitter*ox13;\r
`,t+=`    vec3 dy13 = Pfy.x + jitter*oy13;\r
`,t+=`    vec3 dz13 = Pfz.z + jitter*oz13;\r
`,t+=`\r
`,t+=`    vec3 dx21 = Pfx + jitter*ox21;\r
`,t+=`    vec3 dy21 = Pfy.y + jitter*oy21;\r
`,t+=`    vec3 dz21 = Pfz.x + jitter*oz21;\r
`,t+=`\r
`,t+=`    vec3 dx22 = Pfx + jitter*ox22;\r
`,t+=`    vec3 dy22 = Pfy.y + jitter*oy22;\r
`,t+=`    vec3 dz22 = Pfz.y + jitter*oz22;\r
`,t+=`\r
`,t+=`    vec3 dx23 = Pfx + jitter*ox23;\r
`,t+=`    vec3 dy23 = Pfy.y + jitter*oy23;\r
`,t+=`    vec3 dz23 = Pfz.z + jitter*oz23;\r
`,t+=`\r
`,t+=`    vec3 dx31 = Pfx + jitter*ox31;\r
`,t+=`    vec3 dy31 = Pfy.z + jitter*oy31;\r
`,t+=`    vec3 dz31 = Pfz.x + jitter*oz31;\r
`,t+=`\r
`,t+=`    vec3 dx32 = Pfx + jitter*ox32;\r
`,t+=`    vec3 dy32 = Pfy.z + jitter*oy32;\r
`,t+=`    vec3 dz32 = Pfz.y + jitter*oz32;\r
`,t+=`\r
`,t+=`    vec3 dx33 = Pfx + jitter*ox33;\r
`,t+=`    vec3 dy33 = Pfy.z + jitter*oy33;\r
`,t+=`    vec3 dz33 = Pfz.z + jitter*oz33;\r
`,t+=`\r
`,t+=`    vec3 d11 = dist(dx11, dy11, dz11, manhattanDistance);\r
`,t+=`    vec3 d12 =dist(dx12, dy12, dz12, manhattanDistance);\r
`,t+=`    vec3 d13 = dist(dx13, dy13, dz13, manhattanDistance);\r
`,t+=`    vec3 d21 = dist(dx21, dy21, dz21, manhattanDistance);\r
`,t+=`    vec3 d22 = dist(dx22, dy22, dz22, manhattanDistance);\r
`,t+=`    vec3 d23 = dist(dx23, dy23, dz23, manhattanDistance);\r
`,t+=`    vec3 d31 = dist(dx31, dy31, dz31, manhattanDistance);\r
`,t+=`    vec3 d32 = dist(dx32, dy32, dz32, manhattanDistance);\r
`,t+=`    vec3 d33 = dist(dx33, dy33, dz33, manhattanDistance);\r
`,t+=`\r
`,t+=`    vec3 d1a = min(d11, d12);\r
`,t+=`    d12 = max(d11, d12);\r
`,t+=`    d11 = min(d1a, d13); // Smallest now not in d12 or d13\r
`,t+=`    d13 = max(d1a, d13);\r
`,t+=`    d12 = min(d12, d13); // 2nd smallest now not in d13\r
`,t+=`    vec3 d2a = min(d21, d22);\r
`,t+=`    d22 = max(d21, d22);\r
`,t+=`    d21 = min(d2a, d23); // Smallest now not in d22 or d23\r
`,t+=`    d23 = max(d2a, d23);\r
`,t+=`    d22 = min(d22, d23); // 2nd smallest now not in d23\r
`,t+=`    vec3 d3a = min(d31, d32);\r
`,t+=`    d32 = max(d31, d32);\r
`,t+=`    d31 = min(d3a, d33); // Smallest now not in d32 or d33\r
`,t+=`    d33 = max(d3a, d33);\r
`,t+=`    d32 = min(d32, d33); // 2nd smallest now not in d33\r
`,t+=`    vec3 da = min(d11, d21);\r
`,t+=`    d21 = max(d11, d21);\r
`,t+=`    d11 = min(da, d31); // Smallest now in d11\r
`,t+=`    d31 = max(da, d31); // 2nd smallest now not in d31\r
`,t+=`    d11.xy = (d11.x < d11.y) ? d11.xy : d11.yx;\r
`,t+=`    d11.xz = (d11.x < d11.z) ? d11.xz : d11.zx; // d11.x now smallest\r
`,t+=`    d12 = min(d12, d21); // 2nd smallest now not in d21\r
`,t+=`    d12 = min(d12, d22); // nor in d22\r
`,t+=`    d12 = min(d12, d31); // nor in d31\r
`,t+=`    d12 = min(d12, d32); // nor in d32\r
`,t+=`    d11.yz = min(d11.yz,d12.xy); // nor in d12.yz\r
`,t+=`    d11.y = min(d11.y,d12.z); // Only two more to go\r
`,t+=`    d11.y = min(d11.y,d11.z); // Done! (Phew!)\r
`,t+=`    return sqrt(d11.xy); // F1, F2\r
`,t+=`}\r
\r
`,e._emitFunction("worley3D",t,"// Worley3D");var i=e._getFreeVariableName("worleyTemp");return e.compilationString+="vec2 ".concat(i," = worley(").concat(this.seed.associatedVariableName,", ").concat(this.jitter.associatedVariableName,", ").concat(this.manhattanDistance,`);\r
`),this.output.hasEndpoints&&(e.compilationString+=this._declareOutput(this.output,e)+" = ".concat(i,`;\r
`)),this.x.hasEndpoints&&(e.compilationString+=this._declareOutput(this.x,e)+" = ".concat(i,`.x;\r
`)),this.y.hasEndpoints&&(e.compilationString+=this._declareOutput(this.y,e)+" = ".concat(i,`.y;\r
`)),this}},n.prototype._dumpPropertiesCode=function(){var e=r.prototype._dumpPropertiesCode.call(this)+"".concat(this._codeVariableName,".manhattanDistance = ").concat(this.manhattanDistance,`;\r
`);return e},n.prototype.serialize=function(){var e=r.prototype.serialize.call(this);return e.manhattanDistance=this.manhattanDistance,e},n.prototype._deserialize=function(e,t,i){r.prototype._deserialize.call(this,e,t,i),this.manhattanDistance=e.manhattanDistance},E([te("Use Manhattan Distance",ee.Boolean,"PROPERTIES",{notifiers:{update:!1}})],n.prototype,"manhattanDistance",void 0),n}(L);P("BABYLON.WorleyNoise3DBlock",wl);var Vl=function(r){R(n,r);function n(e){var t=r.call(this,e,g.Neutral)||this;return t.registerInput("seed",h.Vector3),t.registerOutput("output",h.Float),t}return n.prototype.getClassName=function(){return"SimplexPerlin3DBlock"},Object.defineProperty(n.prototype,"seed",{get:function(){return this._inputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"output",{get:function(){return this._outputs[0]},enumerable:!1,configurable:!0}),n.prototype._buildBlock=function(e){if(r.prototype._buildBlock.call(this,e),!!this.seed.isConnected&&!!this._outputs[0].hasEndpoints){var t=`const float SKEWFACTOR = 1.0/3.0;\r
`;return t+=`const float UNSKEWFACTOR = 1.0/6.0;\r
`,t+=`const float SIMPLEX_CORNER_POS = 0.5;\r
`,t+=`const float SIMPLEX_TETRAHADRON_HEIGHT = 0.70710678118654752440084436210485;\r
`,t+=`float SimplexPerlin3D( vec3 P ){\r
`,t+=`    P.x = P == vec3(0., 0., 0.) ? 0.00001 : P.x;\r
`,t+=`    P *= SIMPLEX_TETRAHADRON_HEIGHT;\r
`,t+="    vec3 Pi = floor( P + dot( P, vec3( SKEWFACTOR) ) );",t+=`    vec3 x0 = P - Pi + dot(Pi, vec3( UNSKEWFACTOR ) );\r
`,t+=`    vec3 g = step(x0.yzx, x0.xyz);\r
`,t+=`    vec3 l = 1.0 - g;\r
`,t+=`    vec3 Pi_1 = min( g.xyz, l.zxy );\r
`,t+=`    vec3 Pi_2 = max( g.xyz, l.zxy );\r
`,t+=`    vec3 x1 = x0 - Pi_1 + UNSKEWFACTOR;\r
`,t+=`    vec3 x2 = x0 - Pi_2 + SKEWFACTOR;\r
`,t+=`    vec3 x3 = x0 - SIMPLEX_CORNER_POS;\r
`,t+=`    vec4 v1234_x = vec4( x0.x, x1.x, x2.x, x3.x );\r
`,t+=`    vec4 v1234_y = vec4( x0.y, x1.y, x2.y, x3.y );\r
`,t+=`    vec4 v1234_z = vec4( x0.z, x1.z, x2.z, x3.z );\r
`,t+=`    Pi.xyz = Pi.xyz - floor(Pi.xyz * ( 1.0 / 69.0 )) * 69.0;\r
`,t+=`    vec3 Pi_inc1 = step( Pi, vec3( 69.0 - 1.5 ) ) * ( Pi + 1.0 );\r
`,t+=`    vec4 Pt = vec4( Pi.xy, Pi_inc1.xy ) + vec2( 50.0, 161.0 ).xyxy;\r
`,t+=`    Pt *= Pt;\r
`,t+=`    vec4 V1xy_V2xy = mix( Pt.xyxy, Pt.zwzw, vec4( Pi_1.xy, Pi_2.xy ) );\r
`,t+=`    Pt = vec4( Pt.x, V1xy_V2xy.xz, Pt.z ) * vec4( Pt.y, V1xy_V2xy.yw, Pt.w );\r
`,t+=`    const vec3 SOMELARGEFLOATS = vec3( 635.298681, 682.357502, 668.926525 );\r
`,t+=`    const vec3 ZINC = vec3( 48.500388, 65.294118, 63.934599 );\r
`,t+=`    vec3 lowz_mods = vec3( 1.0 / ( SOMELARGEFLOATS.xyz + Pi.zzz * ZINC.xyz ) );\r
`,t+=`    vec3 highz_mods = vec3( 1.0 / ( SOMELARGEFLOATS.xyz + Pi_inc1.zzz * ZINC.xyz ) );\r
`,t+=`    Pi_1 = ( Pi_1.z < 0.5 ) ? lowz_mods : highz_mods;\r
`,t+=`    Pi_2 = ( Pi_2.z < 0.5 ) ? lowz_mods : highz_mods;\r
`,t+=`    vec4 hash_0 = fract( Pt * vec4( lowz_mods.x, Pi_1.x, Pi_2.x, highz_mods.x ) ) - 0.49999;\r
`,t+=`    vec4 hash_1 = fract( Pt * vec4( lowz_mods.y, Pi_1.y, Pi_2.y, highz_mods.y ) ) - 0.49999;\r
`,t+=`    vec4 hash_2 = fract( Pt * vec4( lowz_mods.z, Pi_1.z, Pi_2.z, highz_mods.z ) ) - 0.49999;\r
`,t+=`    vec4 grad_results = inversesqrt( hash_0 * hash_0 + hash_1 * hash_1 + hash_2 * hash_2 ) * ( hash_0 * v1234_x + hash_1 * v1234_y + hash_2 * v1234_z );\r
`,t+=`    const float FINAL_NORMALIZATION = 37.837227241611314102871574478976;\r
`,t+=`    vec4 kernel_weights = v1234_x * v1234_x + v1234_y * v1234_y + v1234_z * v1234_z;\r
`,t+=`    kernel_weights = max(0.5 - kernel_weights, 0.0);\r
`,t+=`    kernel_weights = kernel_weights*kernel_weights*kernel_weights;\r
`,t+=`    return dot( kernel_weights, grad_results ) * FINAL_NORMALIZATION;\r
`,t+=`}\r
`,e._emitFunction("SimplexPerlin3D",t,"// SimplexPerlin3D"),e.compilationString+=this._declareOutput(this._outputs[0],e)+" = SimplexPerlin3D(".concat(this.seed.associatedVariableName,`);\r
`),this}},n}(L);P("BABYLON.SimplexPerlin3DBlock",Vl);var Ul=function(r){R(n,r);function n(e){var t=r.call(this,e,g.Neutral)||this;return t.registerInput("normalMap0",h.Vector3),t.registerInput("normalMap1",h.Vector3),t.registerOutput("output",h.Vector3),t._inputs[0].acceptedConnectionPointTypes.push(h.Color3),t._inputs[0].acceptedConnectionPointTypes.push(h.Color4),t._inputs[0].acceptedConnectionPointTypes.push(h.Vector4),t._inputs[1].acceptedConnectionPointTypes.push(h.Color3),t._inputs[1].acceptedConnectionPointTypes.push(h.Color4),t._inputs[1].acceptedConnectionPointTypes.push(h.Vector4),t}return n.prototype.getClassName=function(){return"NormalBlendBlock"},Object.defineProperty(n.prototype,"normalMap0",{get:function(){return this._inputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"normalMap1",{get:function(){return this._inputs[1]},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"output",{get:function(){return this._outputs[0]},enumerable:!1,configurable:!0}),n.prototype._buildBlock=function(e){r.prototype._buildBlock.call(this,e);var t=this._outputs[0],i=this._inputs[0],o=this._inputs[1],a=e._getFreeVariableName("stepR"),s=e._getFreeVariableName("stepG");return e.compilationString+="float ".concat(a," = step(0.5, ").concat(i.associatedVariableName,`.r);\r
`),e.compilationString+="float ".concat(s," = step(0.5, ").concat(i.associatedVariableName,`.g);\r
`),e.compilationString+=this._declareOutput(t,e)+`;\r
`,e.compilationString+="".concat(t.associatedVariableName,".r = (1.0 - ").concat(a,") * ").concat(i.associatedVariableName,".r * ").concat(o.associatedVariableName,".r * 2.0 + ").concat(a," * (1.0 - (1.0 - ").concat(i.associatedVariableName,".r) * (1.0 - ").concat(o.associatedVariableName,`.r) * 2.0);\r
`),e.compilationString+="".concat(t.associatedVariableName,".g = (1.0 - ").concat(s,") * ").concat(i.associatedVariableName,".g * ").concat(o.associatedVariableName,".g * 2.0 + ").concat(s," * (1.0 - (1.0 - ").concat(i.associatedVariableName,".g) * (1.0 - ").concat(o.associatedVariableName,`.g) * 2.0);\r
`),e.compilationString+="".concat(t.associatedVariableName,".b = ").concat(i.associatedVariableName,".b * ").concat(o.associatedVariableName,`.b;\r
`),this},n}(L);P("BABYLON.NormalBlendBlock",Ul);var kl=function(r){R(n,r);function n(e){var t=r.call(this,e,g.Neutral)||this;return t.registerInput("input",h.Vector2),t.registerInput("angle",h.Float),t.registerOutput("output",h.Vector2),t}return n.prototype.getClassName=function(){return"Rotate2dBlock"},Object.defineProperty(n.prototype,"input",{get:function(){return this._inputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"angle",{get:function(){return this._inputs[1]},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"output",{get:function(){return this._outputs[0]},enumerable:!1,configurable:!0}),n.prototype.autoConfigure=function(){if(!this.angle.isConnected){var e=new K("angle");e.value=0,e.output.connectTo(this.angle)}},n.prototype._buildBlock=function(e){r.prototype._buildBlock.call(this,e);var t=this._outputs[0],i=this.angle,o=this.input;return e.compilationString+=this._declareOutput(t,e)+" = vec2(cos(".concat(i.associatedVariableName,") * ").concat(o.associatedVariableName,".x - sin(").concat(i.associatedVariableName,") * ").concat(o.associatedVariableName,".y, sin(").concat(i.associatedVariableName,") * ").concat(o.associatedVariableName,".x + cos(").concat(i.associatedVariableName,") * ").concat(o.associatedVariableName,`.y);\r
`),this},n}(L);P("BABYLON.Rotate2dBlock",kl);var Gl=function(r){R(n,r);function n(e){var t=r.call(this,e,g.Neutral)||this;return t.registerInput("incident",h.Vector3),t.registerInput("normal",h.Vector3),t.registerOutput("output",h.Vector3),t._inputs[0].acceptedConnectionPointTypes.push(h.Vector4),t._inputs[0].acceptedConnectionPointTypes.push(h.Color3),t._inputs[0].acceptedConnectionPointTypes.push(h.Color4),t._inputs[1].acceptedConnectionPointTypes.push(h.Vector4),t._inputs[1].acceptedConnectionPointTypes.push(h.Color3),t._inputs[1].acceptedConnectionPointTypes.push(h.Color4),t}return n.prototype.getClassName=function(){return"ReflectBlock"},Object.defineProperty(n.prototype,"incident",{get:function(){return this._inputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"normal",{get:function(){return this._inputs[1]},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"output",{get:function(){return this._outputs[0]},enumerable:!1,configurable:!0}),n.prototype._buildBlock=function(e){r.prototype._buildBlock.call(this,e);var t=this._outputs[0];return e.compilationString+=this._declareOutput(t,e)+" = reflect(".concat(this.incident.associatedVariableName,".xyz, ").concat(this.normal.associatedVariableName,`.xyz);\r
`),this},n}(L);P("BABYLON.ReflectBlock",Gl);var Hl=function(r){R(n,r);function n(e){var t=r.call(this,e,g.Neutral)||this;return t.registerInput("incident",h.Vector3),t.registerInput("normal",h.Vector3),t.registerInput("ior",h.Float),t.registerOutput("output",h.Vector3),t._inputs[0].acceptedConnectionPointTypes.push(h.Vector4),t._inputs[0].acceptedConnectionPointTypes.push(h.Color3),t._inputs[0].acceptedConnectionPointTypes.push(h.Color4),t._inputs[1].acceptedConnectionPointTypes.push(h.Vector4),t._inputs[1].acceptedConnectionPointTypes.push(h.Color3),t._inputs[1].acceptedConnectionPointTypes.push(h.Color4),t}return n.prototype.getClassName=function(){return"RefractBlock"},Object.defineProperty(n.prototype,"incident",{get:function(){return this._inputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"normal",{get:function(){return this._inputs[1]},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"ior",{get:function(){return this._inputs[2]},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"output",{get:function(){return this._outputs[0]},enumerable:!1,configurable:!0}),n.prototype._buildBlock=function(e){r.prototype._buildBlock.call(this,e);var t=this._outputs[0];return e.compilationString+=this._declareOutput(t,e)+" = refract(".concat(this.incident.associatedVariableName,".xyz, ").concat(this.normal.associatedVariableName,".xyz, ").concat(this.ior.associatedVariableName,`);\r
`),this},n}(L);P("BABYLON.RefractBlock",Hl);var zl=function(r){R(n,r);function n(e){var t=r.call(this,e,g.Neutral)||this;return t.registerInput("color",h.Color3),t.registerInput("level",h.Float),t.registerOutput("output",h.Color3),t}return n.prototype.getClassName=function(){return"DesaturateBlock"},Object.defineProperty(n.prototype,"color",{get:function(){return this._inputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"level",{get:function(){return this._inputs[1]},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"output",{get:function(){return this._outputs[0]},enumerable:!1,configurable:!0}),n.prototype._buildBlock=function(e){r.prototype._buildBlock.call(this,e);var t=this._outputs[0],i=this.color,o=i.associatedVariableName,a=e._getFreeVariableName("colorMin"),s=e._getFreeVariableName("colorMax"),c=e._getFreeVariableName("colorMerge");return e.compilationString+="float ".concat(a," = min(min(").concat(o,".x, ").concat(o,".y), ").concat(o,`.z);\r
`),e.compilationString+="float ".concat(s," = max(max(").concat(o,".x, ").concat(o,".y), ").concat(o,`.z);\r
`),e.compilationString+="float ".concat(c," = 0.5 * (").concat(a," + ").concat(s,`);\r
`),e.compilationString+=this._declareOutput(t,e)+" = mix(".concat(o,", vec3(").concat(c,", ").concat(c,", ").concat(c,"), ").concat(this.level.associatedVariableName,`);\r
`),this},n}(L);P("BABYLON.DesaturateBlock",zl);var Br=function(r){R(n,r);function n(e){var t=r.call(this,e,g.Fragment)||this;return t.albedoScaling=!1,t.linkSheenWithAlbedo=!1,t._isUnique=!0,t.registerInput("intensity",h.Float,!0,g.Fragment),t.registerInput("color",h.Color3,!0,g.Fragment),t.registerInput("roughness",h.Float,!0,g.Fragment),t.registerOutput("sheen",h.Object,g.Fragment,new we("sheen",t,be.Output,n,"SheenBlock")),t}return n.prototype.initialize=function(e){e._excludeVariableName("sheenOut"),e._excludeVariableName("sheenMapData"),e._excludeVariableName("vSheenColor"),e._excludeVariableName("vSheenRoughness")},n.prototype.getClassName=function(){return"SheenBlock"},Object.defineProperty(n.prototype,"intensity",{get:function(){return this._inputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"color",{get:function(){return this._inputs[1]},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"roughness",{get:function(){return this._inputs[2]},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"sheen",{get:function(){return this._outputs[0]},enumerable:!1,configurable:!0}),n.prototype.prepareDefines=function(e,t,i){r.prototype.prepareDefines.call(this,e,t,i),i.setValue("SHEEN",!0),i.setValue("SHEEN_USE_ROUGHNESS_FROM_MAINTEXTURE",!0,!0),i.setValue("SHEEN_LINKWITHALBEDO",this.linkSheenWithAlbedo,!0),i.setValue("SHEEN_ROUGHNESS",this.roughness.isConnected,!0),i.setValue("SHEEN_ALBEDOSCALING",this.albedoScaling,!0)},n.prototype.getCode=function(e){var t="",i=this.color.isConnected?this.color.associatedVariableName:"vec3(1.)",o=this.intensity.isConnected?this.intensity.associatedVariableName:"1.",a=this.roughness.isConnected?this.roughness.associatedVariableName:"0.",s="vec4(0.)";return t=`#ifdef SHEEN
            sheenOutParams sheenOut;

            vec4 vSheenColor = vec4(`.concat(i,", ").concat(o,`);

            sheenBlock(
                vSheenColor,
            #ifdef SHEEN_ROUGHNESS
                `).concat(a,`,
            #endif
                roughness,
            #ifdef SHEEN_TEXTURE
                `).concat(s,`,
                1.0,
            #endif
                reflectance,
            #ifdef SHEEN_LINKWITHALBEDO
                baseColor,
                surfaceAlbedo,
            #endif
            #ifdef ENVIRONMENTBRDF
                NdotV,
                environmentBrdf,
            #endif
            #if defined(REFLECTION) && defined(ENVIRONMENTBRDF)
                AARoughnessFactors,
                `).concat(e==null?void 0:e._vReflectionMicrosurfaceInfosName,`,
                `).concat(e==null?void 0:e._vReflectionInfosName,`,
                `).concat(e==null?void 0:e.reflectionColor,`,
                vLightingIntensity,
                #ifdef `).concat(e==null?void 0:e._define3DName,`
                    `).concat(e==null?void 0:e._cubeSamplerName,`,
                #else
                    `).concat(e==null?void 0:e._2DSamplerName,`,
                #endif
                reflectionOut.reflectionCoords,
                NdotVUnclamped,
                #ifndef LODBASEDMICROSFURACE
                    #ifdef `).concat(e==null?void 0:e._define3DName,`
                        `).concat(e==null?void 0:e._cubeSamplerName,`,
                        `).concat(e==null?void 0:e._cubeSamplerName,`,
                    #else
                        `).concat(e==null?void 0:e._2DSamplerName,`,
                        `).concat(e==null?void 0:e._2DSamplerName,`,
                    #endif
                #endif
                #if !defined(`).concat(e==null?void 0:e._defineSkyboxName,`) && defined(RADIANCEOCCLUSION)
                    seo,
                #endif
                #if !defined(`).concat(e==null?void 0:e._defineSkyboxName,") && defined(HORIZONOCCLUSION) && defined(BUMP) && defined(").concat(e==null?void 0:e._define3DName,`)
                    eho,
                #endif
            #endif
                sheenOut
            );

            #ifdef SHEEN_LINKWITHALBEDO
                surfaceAlbedo = sheenOut.surfaceAlbedo;
            #endif
        #endif\r
`),t},n.prototype._buildBlock=function(e){return e.target===g.Fragment&&e.sharedData.blocksWithDefines.push(this),this},n.prototype._dumpPropertiesCode=function(){var e=r.prototype._dumpPropertiesCode.call(this);return e+="".concat(this._codeVariableName,".albedoScaling = ").concat(this.albedoScaling,`;\r
`),e+="".concat(this._codeVariableName,".linkSheenWithAlbedo = ").concat(this.linkSheenWithAlbedo,`;\r
`),e},n.prototype.serialize=function(){var e=r.prototype.serialize.call(this);return e.albedoScaling=this.albedoScaling,e.linkSheenWithAlbedo=this.linkSheenWithAlbedo,e},n.prototype._deserialize=function(e,t,i){r.prototype._deserialize.call(this,e,t,i),this.albedoScaling=e.albedoScaling,this.linkSheenWithAlbedo=e.linkSheenWithAlbedo},E([te("Albedo scaling",ee.Boolean,"PROPERTIES",{notifiers:{update:!0}})],n.prototype,"albedoScaling",void 0),E([te("Link sheen with albedo",ee.Boolean,"PROPERTIES",{notifiers:{update:!0}})],n.prototype,"linkSheenWithAlbedo",void 0),n}(L);P("BABYLON.SheenBlock",Br);var wr=function(r){R(n,r);function n(e){var t=r.call(this,e,g.Fragment)||this;return t._isUnique=!0,t.registerInput("intensity",h.Float,!0,g.Fragment),t.registerInput("direction",h.Vector2,!0,g.Fragment),t.registerInput("uv",h.Vector2,!0),t.registerInput("worldTangent",h.Vector4,!0),t.registerOutput("anisotropy",h.Object,g.Fragment,new we("anisotropy",t,be.Output,n,"AnisotropyBlock")),t}return n.prototype.initialize=function(e){e._excludeVariableName("anisotropicOut"),e._excludeVariableName("TBN")},n.prototype.getClassName=function(){return"AnisotropyBlock"},Object.defineProperty(n.prototype,"intensity",{get:function(){return this._inputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"direction",{get:function(){return this._inputs[1]},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"uv",{get:function(){return this._inputs[2]},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"worldTangent",{get:function(){return this._inputs[3]},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"anisotropy",{get:function(){return this._outputs[0]},enumerable:!1,configurable:!0}),n.prototype._generateTBNSpace=function(e){var t="",i="//".concat(this.name),o=this.uv,a=this.worldPositionConnectionPoint,s=this.worldNormalConnectionPoint,c=this.worldTangent;o.isConnected||console.error("You must connect the 'uv' input of the Anisotropy block!"),e._emitExtension("derivatives","#extension GL_OES_standard_derivatives : enable");var l={search:/defined\(TANGENT\)/g,replace:c.isConnected?"defined(TANGENT)":"defined(IGNORE)"};return c.isConnected&&(t+="vec3 tbnNormal = normalize(".concat(s.associatedVariableName,`.xyz);\r
`),t+="vec3 tbnTangent = normalize(".concat(c.associatedVariableName,`.xyz);\r
`),t+=`vec3 tbnBitangent = cross(tbnNormal, tbnTangent);\r
`,t+=`mat3 vTBN = mat3(tbnTangent, tbnBitangent, tbnNormal);\r
`),t+=`
            #if defined(`.concat(c.isConnected?"TANGENT":"IGNORE",`) && defined(NORMAL)
                mat3 TBN = vTBN;
            #else
                mat3 TBN = cotangent_frame(`).concat(s.associatedVariableName+".xyz",", ").concat("v_"+a.associatedVariableName+".xyz",", ").concat(o.isConnected?o.associatedVariableName:"vec2(0.)",`, vec2(1., 1.));
            #endif\r
`),e._emitFunctionFromInclude("bumpFragmentMainFunctions",i,{replaceStrings:[l]}),t},n.prototype.getCode=function(e,t){t===void 0&&(t=!1);var i="";t&&(i+=this._generateTBNSpace(e));var o=this.intensity.isConnected?this.intensity.associatedVariableName:"1.0",a=this.direction.isConnected?this.direction.associatedVariableName:"vec2(1., 0.)";return i+=`anisotropicOutParams anisotropicOut;
            anisotropicBlock(
                vec3(`.concat(a,", ").concat(o,`),
            #ifdef ANISOTROPIC_TEXTURE
                vec3(0.),
            #endif
                TBN,
                normalW,
                viewDirectionW,
                anisotropicOut
            );\r
`),i},n.prototype.prepareDefines=function(e,t,i){r.prototype.prepareDefines.call(this,e,t,i),i.setValue("ANISOTROPIC",!0),i.setValue("ANISOTROPIC_TEXTURE",!1,!0)},n.prototype._buildBlock=function(e){return e.target===g.Fragment&&e.sharedData.blocksWithDefines.push(this),this},n}(L);P("BABYLON.AnisotropyBlock",wr);var Vr=function(r){R(n,r);function n(e){var t=r.call(this,e)||this;return t.useSphericalHarmonics=!0,t.forceIrradianceInFragment=!1,t._isUnique=!0,t.registerInput("position",h.Vector3,!1,g.Vertex),t.registerInput("world",h.Matrix,!1,g.Vertex),t.registerInput("color",h.Color3,!0,g.Fragment),t.registerOutput("reflection",h.Object,g.Fragment,new we("reflection",t,be.Output,n,"ReflectionBlock")),t}return n.prototype.getClassName=function(){return"ReflectionBlock"},Object.defineProperty(n.prototype,"position",{get:function(){return this._inputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"worldPosition",{get:function(){return this.worldPositionConnectionPoint},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"worldNormal",{get:function(){return this.worldNormalConnectionPoint},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"world",{get:function(){return this._inputs[1]},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"cameraPosition",{get:function(){return this.cameraPositionConnectionPoint},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"view",{get:function(){return this.viewConnectionPoint},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"color",{get:function(){return this._inputs[2]},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"reflection",{get:function(){return this._outputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"hasTexture",{get:function(){return!!this._getTexture()},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"reflectionColor",{get:function(){return this.color.isConnected?this.color.associatedVariableName:"vec3(1., 1., 1.)"},enumerable:!1,configurable:!0}),n.prototype._getTexture=function(){return this.texture?this.texture:this._scene.environmentTexture},n.prototype.prepareDefines=function(e,t,i){r.prototype.prepareDefines.call(this,e,t,i);var o=this._getTexture(),a=o&&o.getTextureMatrix;i.setValue("REFLECTION",a,!0),a&&(i.setValue(this._defineLODReflectionAlpha,o.lodLevelInAlpha,!0),i.setValue(this._defineLinearSpecularReflection,o.linearSpecularLOD,!0),i.setValue(this._defineOppositeZ,this._scene.useRightHandedSystem?!o.invertZ:o.invertZ,!0),i.setValue("SPHERICAL_HARMONICS",this.useSphericalHarmonics,!0),i.setValue("GAMMAREFLECTION",o.gammaSpace,!0),i.setValue("RGBDREFLECTION",o.isRGBD,!0),o&&o.coordinatesMode!==X.SKYBOX_MODE&&o.isCube&&(i.setValue("USESPHERICALFROMREFLECTIONMAP",!0),i.setValue("USEIRRADIANCEMAP",!1),this.forceIrradianceInFragment||this._scene.getEngine().getCaps().maxVaryingVectors<=8?i.setValue("USESPHERICALINVERTEX",!1):i.setValue("USESPHERICALINVERTEX",!0)))},n.prototype.bind=function(e,t,i,o){r.prototype.bind.call(this,e,t,i);var a=this._getTexture();if(!(!a||!o)){a.isCube?e.setTexture(this._cubeSamplerName,a):e.setTexture(this._2DSamplerName,a);var s=a.getSize().width;e.setFloat3(this._vReflectionMicrosurfaceInfosName,s,a.lodGenerationScale,a.lodGenerationOffset),e.setFloat2(this._vReflectionFilteringInfoName,s,Wt.Log2(s));var c=o.materialDefines,l=a.sphericalPolynomial;if(c.USESPHERICALFROMREFLECTIONMAP&&l)if(c.SPHERICAL_HARMONICS){var u=l.preScaledHarmonics;e.setVector3("vSphericalL00",u.l00),e.setVector3("vSphericalL1_1",u.l1_1),e.setVector3("vSphericalL10",u.l10),e.setVector3("vSphericalL11",u.l11),e.setVector3("vSphericalL2_2",u.l2_2),e.setVector3("vSphericalL2_1",u.l2_1),e.setVector3("vSphericalL20",u.l20),e.setVector3("vSphericalL21",u.l21),e.setVector3("vSphericalL22",u.l22)}else e.setFloat3("vSphericalX",l.x.x,l.x.y,l.x.z),e.setFloat3("vSphericalY",l.y.x,l.y.y,l.y.z),e.setFloat3("vSphericalZ",l.z.x,l.z.y,l.z.z),e.setFloat3("vSphericalXX_ZZ",l.xx.x-l.zz.x,l.xx.y-l.zz.y,l.xx.z-l.zz.z),e.setFloat3("vSphericalYY_ZZ",l.yy.x-l.zz.x,l.yy.y-l.zz.y,l.yy.z-l.zz.z),e.setFloat3("vSphericalZZ",l.zz.x,l.zz.y,l.zz.z),e.setFloat3("vSphericalXY",l.xy.x,l.xy.y,l.xy.z),e.setFloat3("vSphericalYZ",l.yz.x,l.yz.y,l.yz.z),e.setFloat3("vSphericalZX",l.zx.x,l.zx.y,l.zx.z)}},n.prototype.handleVertexSide=function(e){var t=r.prototype.handleVertexSide.call(this,e);e._emitFunctionFromInclude("harmonicsFunctions","//".concat(this.name),{replaceStrings:[{search:/uniform vec3 vSphericalL00;[\s\S]*?uniform vec3 vSphericalL22;/g,replace:""},{search:/uniform vec3 vSphericalX;[\s\S]*?uniform vec3 vSphericalZX;/g,replace:""}]});var i=e._getFreeVariableName("reflectionVector");return this._vEnvironmentIrradianceName=e._getFreeVariableName("vEnvironmentIrradiance"),e._emitVaryingFromString(this._vEnvironmentIrradianceName,"vec3","defined(USESPHERICALFROMREFLECTIONMAP) && defined(USESPHERICALINVERTEX)"),e._emitUniformFromString("vSphericalL00","vec3","SPHERICAL_HARMONICS"),e._emitUniformFromString("vSphericalL1_1","vec3","SPHERICAL_HARMONICS"),e._emitUniformFromString("vSphericalL10","vec3","SPHERICAL_HARMONICS"),e._emitUniformFromString("vSphericalL11","vec3","SPHERICAL_HARMONICS"),e._emitUniformFromString("vSphericalL2_2","vec3","SPHERICAL_HARMONICS"),e._emitUniformFromString("vSphericalL2_1","vec3","SPHERICAL_HARMONICS"),e._emitUniformFromString("vSphericalL20","vec3","SPHERICAL_HARMONICS"),e._emitUniformFromString("vSphericalL21","vec3","SPHERICAL_HARMONICS"),e._emitUniformFromString("vSphericalL22","vec3","SPHERICAL_HARMONICS"),e._emitUniformFromString("vSphericalX","vec3","SPHERICAL_HARMONICS",!0),e._emitUniformFromString("vSphericalY","vec3","SPHERICAL_HARMONICS",!0),e._emitUniformFromString("vSphericalZ","vec3","SPHERICAL_HARMONICS",!0),e._emitUniformFromString("vSphericalXX_ZZ","vec3","SPHERICAL_HARMONICS",!0),e._emitUniformFromString("vSphericalYY_ZZ","vec3","SPHERICAL_HARMONICS",!0),e._emitUniformFromString("vSphericalZZ","vec3","SPHERICAL_HARMONICS",!0),e._emitUniformFromString("vSphericalXY","vec3","SPHERICAL_HARMONICS",!0),e._emitUniformFromString("vSphericalYZ","vec3","SPHERICAL_HARMONICS",!0),e._emitUniformFromString("vSphericalZX","vec3","SPHERICAL_HARMONICS",!0),t+=`#if defined(USESPHERICALFROMREFLECTIONMAP) && defined(USESPHERICALINVERTEX)
                vec3 `.concat(i," = vec3(").concat(this._reflectionMatrixName," * vec4(normalize(").concat(this.worldNormal.associatedVariableName,`).xyz, 0)).xyz;
                #ifdef `).concat(this._defineOppositeZ,`
                    `).concat(i,`.z *= -1.0;
                #endif
                `).concat(this._vEnvironmentIrradianceName," = computeEnvironmentIrradiance(").concat(i,`);
            #endif\r
`),t},n.prototype.getCode=function(e,t){var i="";this.handleFragmentSideInits(e),e._emitFunctionFromInclude("harmonicsFunctions","//".concat(this.name),{replaceStrings:[{search:/uniform vec3 vSphericalL00;[\s\S]*?uniform vec3 vSphericalL22;/g,replace:""},{search:/uniform vec3 vSphericalX;[\s\S]*?uniform vec3 vSphericalZX;/g,replace:""}]}),e._emitFunction("sampleReflection",`
            #ifdef `.concat(this._define3DName,`
                #define sampleReflection(s, c) textureCube(s, c)
            #else
                #define sampleReflection(s, c) texture2D(s, c)
            #endif\r
`),"//".concat(this.name)),e._emitFunction("sampleReflectionLod",`
            #ifdef `.concat(this._define3DName,`
                #define sampleReflectionLod(s, c, l) textureCubeLodEXT(s, c, l)
            #else
                #define sampleReflectionLod(s, c, l) texture2DLodEXT(s, c, l)
            #endif\r
`),"//".concat(this.name));var o=`
            vec3 computeReflectionCoordsPBR(vec4 worldPos, vec3 worldNormal) {
                `.concat(this.handleFragmentSideCodeReflectionCoords("worldNormal","worldPos",!0,!0),`
                return `).concat(this._reflectionVectorName,`;
            }\r
`);return e._emitFunction("computeReflectionCoordsPBR",o,"//".concat(this.name)),this._vReflectionMicrosurfaceInfosName=e._getFreeVariableName("vReflectionMicrosurfaceInfos"),e._emitUniformFromString(this._vReflectionMicrosurfaceInfosName,"vec3"),this._vReflectionInfosName=e._getFreeVariableName("vReflectionInfos"),this._vReflectionFilteringInfoName=e._getFreeVariableName("vReflectionFilteringInfo"),e._emitUniformFromString(this._vReflectionFilteringInfoName,"vec2"),i+=`#ifdef REFLECTION
            vec2 `.concat(this._vReflectionInfosName,` = vec2(1., 0.);

            reflectionOutParams reflectionOut;

            reflectionBlock(
                `).concat("v_"+this.worldPosition.associatedVariableName+".xyz",`,
                `).concat(t,`,
                alphaG,
                `).concat(this._vReflectionMicrosurfaceInfosName,`,
                `).concat(this._vReflectionInfosName,`,
                `).concat(this.reflectionColor,`,
            #ifdef ANISOTROPIC
                anisotropicOut,
            #endif
            #if defined(`).concat(this._defineLODReflectionAlpha,") && !defined(").concat(this._defineSkyboxName,`)
                NdotVUnclamped,
            #endif
            #ifdef `).concat(this._defineLinearSpecularReflection,`
                roughness,
            #endif
            #ifdef `).concat(this._define3DName,`
                `).concat(this._cubeSamplerName,`,
            #else
                `).concat(this._2DSamplerName,`,
            #endif
            #if defined(NORMAL) && defined(USESPHERICALINVERTEX)
                `).concat(this._vEnvironmentIrradianceName,`,
            #endif
            #ifdef USESPHERICALFROMREFLECTIONMAP
                #if !defined(NORMAL) || !defined(USESPHERICALINVERTEX)
                    `).concat(this._reflectionMatrixName,`,
                #endif
            #endif
            #ifdef USEIRRADIANCEMAP
                irradianceSampler, // ** not handled **
            #endif
            #ifndef LODBASEDMICROSFURACE
                #ifdef `).concat(this._define3DName,`
                    `).concat(this._cubeSamplerName,`,
                    `).concat(this._cubeSamplerName,`,
                #else
                    `).concat(this._2DSamplerName,`,
                    `).concat(this._2DSamplerName,`,
                #endif
            #endif
            #ifdef REALTIME_FILTERING
                `).concat(this._vReflectionFilteringInfoName,`,
            #endif
                reflectionOut
            );
        #endif\r
`),i},n.prototype._buildBlock=function(e){return this._scene=e.sharedData.scene,e.target!==g.Fragment&&(this._defineLODReflectionAlpha=e._getFreeDefineName("LODINREFLECTIONALPHA"),this._defineLinearSpecularReflection=e._getFreeDefineName("LINEARSPECULARREFLECTION")),this},n.prototype._dumpPropertiesCode=function(){var e=r.prototype._dumpPropertiesCode.call(this);return this.texture&&(e+="".concat(this._codeVariableName,".texture.gammaSpace = ").concat(this.texture.gammaSpace,`;\r
`)),e+="".concat(this._codeVariableName,".useSphericalHarmonics = ").concat(this.useSphericalHarmonics,`;\r
`),e+="".concat(this._codeVariableName,".forceIrradianceInFragment = ").concat(this.forceIrradianceInFragment,`;\r
`),e},n.prototype.serialize=function(){var e,t,i=r.prototype.serialize.call(this);return i.useSphericalHarmonics=this.useSphericalHarmonics,i.forceIrradianceInFragment=this.forceIrradianceInFragment,i.gammaSpace=(t=(e=this.texture)===null||e===void 0?void 0:e.gammaSpace)!==null&&t!==void 0?t:!0,i},n.prototype._deserialize=function(e,t,i){r.prototype._deserialize.call(this,e,t,i),this.useSphericalHarmonics=e.useSphericalHarmonics,this.forceIrradianceInFragment=e.forceIrradianceInFragment,this.texture&&(this.texture.gammaSpace=e.gammaSpace)},E([te("Spherical Harmonics",ee.Boolean,"ADVANCED",{notifiers:{update:!0}})],n.prototype,"useSphericalHarmonics",void 0),E([te("Force irradiance in fragment",ee.Boolean,"ADVANCED",{notifiers:{update:!0}})],n.prototype,"forceIrradianceInFragment",void 0),n}(Ri);P("BABYLON.ReflectionBlock",Vr);var di=function(r){R(n,r);function n(e){var t=r.call(this,e,g.Fragment)||this;return t.remapF0OnInterfaceChange=!0,t._isUnique=!0,t.registerInput("intensity",h.Float,!1,g.Fragment),t.registerInput("roughness",h.Float,!0,g.Fragment),t.registerInput("indexOfRefraction",h.Float,!0,g.Fragment),t.registerInput("normalMapColor",h.Color3,!0,g.Fragment),t.registerInput("uv",h.Vector2,!0,g.Fragment),t.registerInput("tintColor",h.Color3,!0,g.Fragment),t.registerInput("tintAtDistance",h.Float,!0,g.Fragment),t.registerInput("tintThickness",h.Float,!0,g.Fragment),t.registerInput("worldTangent",h.Vector4,!0),t.registerOutput("clearcoat",h.Object,g.Fragment,new we("clearcoat",t,be.Output,n,"ClearCoatBlock")),t}return n.prototype.initialize=function(e){e._excludeVariableName("clearcoatOut"),e._excludeVariableName("vClearCoatParams"),e._excludeVariableName("vClearCoatTintParams"),e._excludeVariableName("vClearCoatRefractionParams"),e._excludeVariableName("vClearCoatTangentSpaceParams")},n.prototype.getClassName=function(){return"ClearCoatBlock"},Object.defineProperty(n.prototype,"intensity",{get:function(){return this._inputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"roughness",{get:function(){return this._inputs[1]},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"indexOfRefraction",{get:function(){return this._inputs[2]},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"normalMapColor",{get:function(){return this._inputs[3]},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"uv",{get:function(){return this._inputs[4]},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"tintColor",{get:function(){return this._inputs[5]},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"tintAtDistance",{get:function(){return this._inputs[6]},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"tintThickness",{get:function(){return this._inputs[7]},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"worldTangent",{get:function(){return this._inputs[8]},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"clearcoat",{get:function(){return this._outputs[0]},enumerable:!1,configurable:!0}),n.prototype.autoConfigure=function(){if(!this.intensity.isConnected){var e=new K("ClearCoat intensity",g.Fragment,h.Float);e.value=1,e.output.connectTo(this.intensity)}},n.prototype.prepareDefines=function(e,t,i){r.prototype.prepareDefines.call(this,e,t,i),i.setValue("CLEARCOAT",!0),i.setValue("CLEARCOAT_TEXTURE",!1,!0),i.setValue("CLEARCOAT_USE_ROUGHNESS_FROM_MAINTEXTURE",!0,!0),i.setValue("CLEARCOAT_TINT",this.tintColor.isConnected||this.tintThickness.isConnected||this.tintAtDistance.isConnected,!0),i.setValue("CLEARCOAT_BUMP",this.normalMapColor.isConnected,!0),i.setValue("CLEARCOAT_DEFAULTIOR",this.indexOfRefraction.isConnected?this.indexOfRefraction.connectInputBlock.value===Gn._DefaultIndexOfRefraction:!0,!0),i.setValue("CLEARCOAT_REMAP_F0",this.remapF0OnInterfaceChange,!0)},n.prototype.bind=function(e,t,i){var o,a;r.prototype.bind.call(this,e,t,i);var s=(a=(o=this.indexOfRefraction.connectInputBlock)===null||o===void 0?void 0:o.value)!==null&&a!==void 0?a:Gn._DefaultIndexOfRefraction,c=1-s,l=1+s,u=Math.pow(-c/l,2),f=1/s;e.setFloat4("vClearCoatRefractionParams",u,f,c,l);var d=this.clearcoat.hasEndpoints?this.clearcoat.endpoints[0].ownerBlock:null,p=d!=null&&d.perturbedNormal.isConnected?d.perturbedNormal.connectedPoint.ownerBlock:null;this._scene._mirroredCameraPosition?e.setFloat2("vClearCoatTangentSpaceParams",p!=null&&p.invertX?1:-1,p!=null&&p.invertY?1:-1):e.setFloat2("vClearCoatTangentSpaceParams",p!=null&&p.invertX?-1:1,p!=null&&p.invertY?-1:1)},n.prototype._generateTBNSpace=function(e,t,i){var o="",a="//".concat(this.name),s=this.worldTangent;e._emitExtension("derivatives","#extension GL_OES_standard_derivatives : enable");var c={search:/defined\(TANGENT\)/g,replace:s.isConnected?"defined(TANGENT)":"defined(IGNORE)"};return s.isConnected&&(o+="vec3 tbnNormal = normalize(".concat(i,`.xyz);\r
`),o+="vec3 tbnTangent = normalize(".concat(s.associatedVariableName,`.xyz);\r
`),o+=`vec3 tbnBitangent = cross(tbnNormal, tbnTangent);\r
`,o+=`mat3 vTBN = mat3(tbnTangent, tbnBitangent, tbnNormal);\r
`),e._emitFunctionFromInclude("bumpFragmentMainFunctions",a,{replaceStrings:[c]}),o},n.GetCode=function(e,t,i,o,a,s,c){var l="",u=t!=null&&t.intensity.isConnected?t.intensity.associatedVariableName:"1.",f=t!=null&&t.roughness.isConnected?t.roughness.associatedVariableName:"0.",d=t!=null&&t.normalMapColor.isConnected?t.normalMapColor.associatedVariableName:"vec3(0.)",p=t!=null&&t.uv.isConnected?t.uv.associatedVariableName:"vec2(0.)",m=t!=null&&t.tintColor.isConnected?t.tintColor.associatedVariableName:"vec3(1.)",_=t!=null&&t.tintThickness.isConnected?t.tintThickness.associatedVariableName:"1.",v=t!=null&&t.tintAtDistance.isConnected?t.tintAtDistance.associatedVariableName:"1.",b="vec4(0.)";return t&&(e._emitUniformFromString("vClearCoatRefractionParams","vec4"),e._emitUniformFromString("vClearCoatTangentSpaceParams","vec2")),a&&t&&(l+=t._generateTBNSpace(e,o,c),s=t.worldTangent.isConnected),l+=`clearcoatOutParams clearcoatOut;

        #ifdef CLEARCOAT
            vec2 vClearCoatParams = vec2(`.concat(u,", ").concat(f,`);
            vec4 vClearCoatTintParams = vec4(`).concat(m,", ").concat(_,`);

            clearcoatBlock(
                `).concat(o,`.xyz,
                geometricNormalW,
                viewDirectionW,
                vClearCoatParams,
                specularEnvironmentR0,
            #ifdef CLEARCOAT_TEXTURE
                vec2(0.),
            #endif
            #ifdef CLEARCOAT_TINT
                vClearCoatTintParams,
                `).concat(v,`,
                vClearCoatRefractionParams,
                #ifdef CLEARCOAT_TINT_TEXTURE
                    `).concat(b,`,
                #endif
            #endif
            #ifdef CLEARCOAT_BUMP
                vec2(0., 1.),
                vec4(`).concat(d,`, 0.),
                `).concat(p,`,
                #if defined(`).concat(s?"TANGENT":"IGNORE",`) && defined(NORMAL)
                    vTBN,
                #else
                    vClearCoatTangentSpaceParams,
                #endif
                #ifdef OBJECTSPACE_NORMALMAP
                    normalMatrix,
                #endif
            #endif
            #if defined(FORCENORMALFORWARD) && defined(NORMAL)
                faceNormal,
            #endif
            #ifdef REFLECTION
                `).concat(i==null?void 0:i._vReflectionMicrosurfaceInfosName,`,
                `).concat(i==null?void 0:i._vReflectionInfosName,`,
                `).concat(i==null?void 0:i.reflectionColor,`,
                vLightingIntensity,
                #ifdef `).concat(i==null?void 0:i._define3DName,`
                    `).concat(i==null?void 0:i._cubeSamplerName,`,
                #else
                    `).concat(i==null?void 0:i._2DSamplerName,`,
                #endif
                #ifndef LODBASEDMICROSFURACE
                    #ifdef `).concat(i==null?void 0:i._define3DName,`
                        `).concat(i==null?void 0:i._cubeSamplerName,`,
                        `).concat(i==null?void 0:i._cubeSamplerName,`,
                    #else
                        `).concat(i==null?void 0:i._2DSamplerName,`,
                        `).concat(i==null?void 0:i._2DSamplerName,`,
                    #endif
                #endif
            #endif
            #if defined(ENVIRONMENTBRDF) && !defined(`).concat(i==null?void 0:i._defineSkyboxName,`)
                #ifdef RADIANCEOCCLUSION
                    ambientMonochrome,
                #endif
            #endif
            #if defined(CLEARCOAT_BUMP) || defined(TWOSIDEDLIGHTING)
                (gl_FrontFacing ? 1. : -1.),
            #endif
                clearcoatOut
            );
        #else
            clearcoatOut.specularEnvironmentR0 = specularEnvironmentR0;
        #endif\r
`),l},n.prototype._buildBlock=function(e){return this._scene=e.sharedData.scene,e.target===g.Fragment&&(e.sharedData.bindableBlocks.push(this),e.sharedData.blocksWithDefines.push(this)),this},n.prototype._dumpPropertiesCode=function(){var e=r.prototype._dumpPropertiesCode.call(this);return e+="".concat(this._codeVariableName,".remapF0OnInterfaceChange = ").concat(this.remapF0OnInterfaceChange,`;\r
`),e},n.prototype.serialize=function(){var e=r.prototype.serialize.call(this);return e.remapF0OnInterfaceChange=this.remapF0OnInterfaceChange,e},n.prototype._deserialize=function(e,t,i){var o;r.prototype._deserialize.call(this,e,t,i),this.remapF0OnInterfaceChange=(o=e.remapF0OnInterfaceChange)!==null&&o!==void 0?o:!0},E([te("Remap F0 on interface change",ee.Boolean,"ADVANCED")],n.prototype,"remapF0OnInterfaceChange",void 0),n}(L);P("BABYLON.ClearCoatBlock",di);var Ur=function(r){R(n,r);function n(e){var t=r.call(this,e,g.Fragment)||this;return t.linkRefractionWithTransparency=!1,t.invertRefractionY=!1,t.useThicknessAsDepth=!1,t._isUnique=!0,t.registerInput("intensity",h.Float,!1,g.Fragment),t.registerInput("tintAtDistance",h.Float,!0,g.Fragment),t.registerInput("volumeIndexOfRefraction",h.Float,!0,g.Fragment),t.registerOutput("refraction",h.Object,g.Fragment,new we("refraction",t,be.Output,n,"RefractionBlock")),t}return n.prototype.initialize=function(e){e._excludeVariableName("vRefractionPosition"),e._excludeVariableName("vRefractionSize")},n.prototype.getClassName=function(){return"RefractionBlock"},Object.defineProperty(n.prototype,"intensity",{get:function(){return this._inputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"tintAtDistance",{get:function(){return this._inputs[1]},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"volumeIndexOfRefraction",{get:function(){return this._inputs[2]},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"view",{get:function(){return this.viewConnectionPoint},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"refraction",{get:function(){return this._outputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"hasTexture",{get:function(){return!!this._getTexture()},enumerable:!1,configurable:!0}),n.prototype._getTexture=function(){return this.texture?this.texture:this._scene.environmentTexture},n.prototype.autoConfigure=function(e){if(!this.intensity.isConnected){var t=new K("Refraction intensity",g.Fragment,h.Float);t.value=1,t.output.connectTo(this.intensity)}if(this.view&&!this.view.isConnected){var i=e.getInputBlockByPredicate(function(o){return o.systemValue===Y.View});i||(i=new K("view"),i.setAsSystemValue(Y.View)),i.output.connectTo(this.view)}},n.prototype.prepareDefines=function(e,t,i){r.prototype.prepareDefines.call(this,e,t,i);var o=this._getTexture(),a=o&&o.getTextureMatrix;i.setValue("SS_REFRACTION",a,!0),a&&(i.setValue(this._define3DName,o.isCube,!0),i.setValue(this._defineLODRefractionAlpha,o.lodLevelInAlpha,!0),i.setValue(this._defineLinearSpecularRefraction,o.linearSpecularLOD,!0),i.setValue(this._defineOppositeZ,this._scene.useRightHandedSystem?!o.invertZ:o.invertZ,!0),i.setValue("SS_LINKREFRACTIONTOTRANSPARENCY",this.linkRefractionWithTransparency,!0),i.setValue("SS_GAMMAREFRACTION",o.gammaSpace,!0),i.setValue("SS_RGBDREFRACTION",o.isRGBD,!0),i.setValue("SS_USE_LOCAL_REFRACTIONMAP_CUBIC",!!o.boundingBoxSize,!0),i.setValue("SS_USE_THICKNESS_AS_DEPTH",this.useThicknessAsDepth,!0))},n.prototype.isReady=function(){var e=this._getTexture();return!(e&&!e.isReadyOrNotBlocking())},n.prototype.bind=function(e,t,i){var o,a,s,c;r.prototype.bind.call(this,e,t,i);var l=this._getTexture();if(!!l){l.isCube?e.setTexture(this._cubeSamplerName,l):e.setTexture(this._2DSamplerName,l),e.setMatrix(this._refractionMatrixName,l.getReflectionTextureMatrix());var u=1;l.isCube||l.depth&&(u=l.depth);var f=(c=(a=(o=this.volumeIndexOfRefraction.connectInputBlock)===null||o===void 0?void 0:o.value)!==null&&a!==void 0?a:(s=this.indexOfRefractionConnectionPoint.connectInputBlock)===null||s===void 0?void 0:s.value)!==null&&c!==void 0?c:1.5;e.setFloat4(this._vRefractionInfosName,l.level,1/f,u,this.invertRefractionY?-1:1),e.setFloat4(this._vRefractionMicrosurfaceInfosName,l.getSize().width,l.lodGenerationScale,l.lodGenerationOffset,1/f);var d=l.getSize().width;if(e.setFloat2(this._vRefractionFilteringInfoName,d,Wt.Log2(d)),l.boundingBoxSize){var p=l;e.setVector3("vRefractionPosition",p.boundingBoxPosition),e.setVector3("vRefractionSize",p.boundingBoxSize)}}},n.prototype.getCode=function(e){var t="";return e.sharedData.blockingBlocks.push(this),e.sharedData.textureBlocks.push(this),this._cubeSamplerName=e._getFreeVariableName(this.name+"CubeSampler"),e.samplers.push(this._cubeSamplerName),this._2DSamplerName=e._getFreeVariableName(this.name+"2DSampler"),e.samplers.push(this._2DSamplerName),this._define3DName=e._getFreeDefineName("SS_REFRACTIONMAP_3D"),e._samplerDeclaration+="#ifdef ".concat(this._define3DName,`\r
`),e._samplerDeclaration+="uniform samplerCube ".concat(this._cubeSamplerName,`;\r
`),e._samplerDeclaration+=`#else\r
`,e._samplerDeclaration+="uniform sampler2D ".concat(this._2DSamplerName,`;\r
`),e._samplerDeclaration+=`#endif\r
`,e.sharedData.blocksWithDefines.push(this),e.sharedData.bindableBlocks.push(this),this._defineLODRefractionAlpha=e._getFreeDefineName("SS_LODINREFRACTIONALPHA"),this._defineLinearSpecularRefraction=e._getFreeDefineName("SS_LINEARSPECULARREFRACTION"),this._defineOppositeZ=e._getFreeDefineName("SS_REFRACTIONMAP_OPPOSITEZ"),this._refractionMatrixName=e._getFreeVariableName("refractionMatrix"),e._emitUniformFromString(this._refractionMatrixName,"mat4"),e._emitFunction("sampleRefraction",`
            #ifdef `.concat(this._define3DName,`
                #define sampleRefraction(s, c) textureCube(s, c)
            #else
                #define sampleRefraction(s, c) texture2D(s, c)
            #endif\r
`),"//".concat(this.name)),e._emitFunction("sampleRefractionLod",`
            #ifdef `.concat(this._define3DName,`
                #define sampleRefractionLod(s, c, l) textureCubeLodEXT(s, c, l)
            #else
                #define sampleRefractionLod(s, c, l) texture2DLodEXT(s, c, l)
            #endif\r
`),"//".concat(this.name)),this._vRefractionMicrosurfaceInfosName=e._getFreeVariableName("vRefractionMicrosurfaceInfos"),e._emitUniformFromString(this._vRefractionMicrosurfaceInfosName,"vec4"),this._vRefractionInfosName=e._getFreeVariableName("vRefractionInfos"),e._emitUniformFromString(this._vRefractionInfosName,"vec4"),this._vRefractionFilteringInfoName=e._getFreeVariableName("vRefractionFilteringInfo"),e._emitUniformFromString(this._vRefractionFilteringInfoName,"vec2"),e._emitUniformFromString("vRefractionPosition","vec3"),e._emitUniformFromString("vRefractionSize","vec3"),t},n.prototype._buildBlock=function(e){return this._scene=e.sharedData.scene,this},n.prototype._dumpPropertiesCode=function(){var e=r.prototype._dumpPropertiesCode.call(this);return this.texture&&(this.texture.isCube?e="".concat(this._codeVariableName,'.texture = new BABYLON.CubeTexture("').concat(this.texture.name,`");\r
`):e="".concat(this._codeVariableName,'.texture = new BABYLON.Texture("').concat(this.texture.name,`");\r
`),e+="".concat(this._codeVariableName,".texture.coordinatesMode = ").concat(this.texture.coordinatesMode,`;\r
`)),e+="".concat(this._codeVariableName,".linkRefractionWithTransparency = ").concat(this.linkRefractionWithTransparency,`;\r
`),e+="".concat(this._codeVariableName,".invertRefractionY = ").concat(this.invertRefractionY,`;\r
`),e+="".concat(this._codeVariableName,".useThicknessAsDepth = ").concat(this.useThicknessAsDepth,`;\r
`),e},n.prototype.serialize=function(){var e=r.prototype.serialize.call(this);return this.texture&&!this.texture.isRenderTarget&&(e.texture=this.texture.serialize()),e.linkRefractionWithTransparency=this.linkRefractionWithTransparency,e.invertRefractionY=this.invertRefractionY,e.useThicknessAsDepth=this.useThicknessAsDepth,e},n.prototype._deserialize=function(e,t,i){r.prototype._deserialize.call(this,e,t,i),e.texture&&(i=e.texture.url.indexOf("data:")===0?"":i,e.texture.isCube?this.texture=bi.Parse(e.texture,t,i):this.texture=X.Parse(e.texture,t,i)),this.linkRefractionWithTransparency=e.linkRefractionWithTransparency,this.invertRefractionY=e.invertRefractionY,this.useThicknessAsDepth=!!e.useThicknessAsDepth},E([te("Link refraction to transparency",ee.Boolean,"ADVANCED",{notifiers:{update:!0}})],n.prototype,"linkRefractionWithTransparency",void 0),E([te("Invert refraction Y",ee.Boolean,"ADVANCED",{notifiers:{update:!0}})],n.prototype,"invertRefractionY",void 0),E([te("Use thickness as depth",ee.Boolean,"ADVANCED",{notifiers:{update:!0}})],n.prototype,"useThicknessAsDepth",void 0),n}(L);P("BABYLON.RefractionBlock",Ur);var pi=function(r){R(n,r);function n(e){var t=r.call(this,e,g.Fragment)||this;return t._isUnique=!0,t.registerInput("thickness",h.Float,!1,g.Fragment),t.registerInput("tintColor",h.Color3,!0,g.Fragment),t.registerInput("translucencyIntensity",h.Float,!0,g.Fragment),t.registerInput("translucencyDiffusionDist",h.Color3,!0,g.Fragment),t.registerInput("refraction",h.Object,!0,g.Fragment,new we("refraction",t,be.Input,Ur,"RefractionBlock")),t.registerOutput("subsurface",h.Object,g.Fragment,new we("subsurface",t,be.Output,n,"SubSurfaceBlock")),t}return n.prototype.initialize=function(e){e._excludeVariableName("subSurfaceOut"),e._excludeVariableName("vThicknessParam"),e._excludeVariableName("vTintColor"),e._excludeVariableName("vSubSurfaceIntensity")},n.prototype.getClassName=function(){return"SubSurfaceBlock"},Object.defineProperty(n.prototype,"thickness",{get:function(){return this._inputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"tintColor",{get:function(){return this._inputs[1]},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"translucencyIntensity",{get:function(){return this._inputs[2]},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"translucencyDiffusionDist",{get:function(){return this._inputs[3]},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"refraction",{get:function(){return this._inputs[4]},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"subsurface",{get:function(){return this._outputs[0]},enumerable:!1,configurable:!0}),n.prototype.autoConfigure=function(){if(!this.thickness.isConnected){var e=new K("SubSurface thickness",g.Fragment,h.Float);e.value=0,e.output.connectTo(this.thickness)}},n.prototype.prepareDefines=function(e,t,i){r.prototype.prepareDefines.call(this,e,t,i);var o=this.translucencyDiffusionDist.isConnected||this.translucencyIntensity.isConnected;i.setValue("SUBSURFACE",o||this.refraction.isConnected,!0),i.setValue("SS_TRANSLUCENCY",o,!0),i.setValue("SS_THICKNESSANDMASK_TEXTURE",!1,!0),i.setValue("SS_REFRACTIONINTENSITY_TEXTURE",!1,!0),i.setValue("SS_TRANSLUCENCYINTENSITY_TEXTURE",!1,!0),i.setValue("SS_MASK_FROM_THICKNESS_TEXTURE",!1,!0),i.setValue("SS_USE_GLTF_TEXTURES",!1,!0)},n.GetCode=function(e,t,i,o){var a,s,c,l,u,f,d,p,m,_,v,b,A,S,C,O,B="",k=t!=null&&t.thickness.isConnected?t.thickness.associatedVariableName:"0.",D=t!=null&&t.tintColor.isConnected?t.tintColor.associatedVariableName:"vec3(1.)",Z=t!=null&&t.translucencyIntensity.isConnected?t==null?void 0:t.translucencyIntensity.associatedVariableName:"1.",$=t!=null&&t.translucencyDiffusionDist.isConnected?t==null?void 0:t.translucencyDiffusionDist.associatedVariableName:"vec3(1.)",I=t!=null&&t.refraction.isConnected?(a=t==null?void 0:t.refraction.connectedPoint)===null||a===void 0?void 0:a.ownerBlock:null,ue=I!=null&&I.tintAtDistance.isConnected?I.tintAtDistance.associatedVariableName:"1.",ge=I!=null&&I.intensity.isConnected?I.intensity.associatedVariableName:"1.",_e=I!=null&&I.view.isConnected?I.view.associatedVariableName:"";return B+=(s=I==null?void 0:I.getCode(e))!==null&&s!==void 0?s:"",B+=`subSurfaceOutParams subSurfaceOut;

        #ifdef SUBSURFACE
            vec2 vThicknessParam = vec2(0., `.concat(k,`);
            vec4 vTintColor = vec4(`).concat(D,", ").concat(ue,`);
            vec3 vSubSurfaceIntensity = vec3(`).concat(ge,", ").concat(Z,`, 0.);

            subSurfaceBlock(
                vSubSurfaceIntensity,
                vThicknessParam,
                vTintColor,
                normalW,
                specularEnvironmentReflectance,
            #ifdef SS_THICKNESSANDMASK_TEXTURE
                vec4(0.),
            #endif
            #ifdef REFLECTION
                #ifdef SS_TRANSLUCENCY
                    `).concat(i==null?void 0:i._reflectionMatrixName,`,
                    #ifdef USESPHERICALFROMREFLECTIONMAP
                        #if !defined(NORMAL) || !defined(USESPHERICALINVERTEX)
                            reflectionOut.irradianceVector,
                        #endif
                        #if defined(REALTIME_FILTERING)
                            `).concat(i==null?void 0:i._cubeSamplerName,`,
                            `).concat(i==null?void 0:i._vReflectionFilteringInfoName,`,
                        #endif
                        #endif
                    #ifdef USEIRRADIANCEMAP
                        irradianceSampler,
                    #endif
                #endif
            #endif
            #if defined(SS_REFRACTION) || defined(SS_TRANSLUCENCY)
                surfaceAlbedo,
            #endif
            #ifdef SS_REFRACTION
                `).concat(o,`.xyz,
                viewDirectionW,
                `).concat(_e,`,
                `).concat((c=I==null?void 0:I._vRefractionInfosName)!==null&&c!==void 0?c:"",`,
                `).concat((l=I==null?void 0:I._refractionMatrixName)!==null&&l!==void 0?l:"",`,
                `).concat((u=I==null?void 0:I._vRefractionMicrosurfaceInfosName)!==null&&u!==void 0?u:"",`,
                vLightingIntensity,
                #ifdef SS_LINKREFRACTIONTOTRANSPARENCY
                    alpha,
                #endif
                #ifdef `).concat((f=I==null?void 0:I._defineLODRefractionAlpha)!==null&&f!==void 0?f:"IGNORE",`
                    NdotVUnclamped,
                #endif
                #ifdef `).concat((d=I==null?void 0:I._defineLinearSpecularRefraction)!==null&&d!==void 0?d:"IGNORE",`
                    roughness,
                #endif
                alphaG,
                #ifdef `).concat((p=I==null?void 0:I._define3DName)!==null&&p!==void 0?p:"IGNORE",`
                    `).concat((m=I==null?void 0:I._cubeSamplerName)!==null&&m!==void 0?m:"",`,
                #else
                    `).concat((_=I==null?void 0:I._2DSamplerName)!==null&&_!==void 0?_:"",`,
                #endif
                #ifndef LODBASEDMICROSFURACE
                    #ifdef `).concat((v=I==null?void 0:I._define3DName)!==null&&v!==void 0?v:"IGNORE",`
                        `).concat((b=I==null?void 0:I._cubeSamplerName)!==null&&b!==void 0?b:"",`,
                        `).concat((A=I==null?void 0:I._cubeSamplerName)!==null&&A!==void 0?A:"",`,
                    #else
                        `).concat((S=I==null?void 0:I._2DSamplerName)!==null&&S!==void 0?S:"",`,
                        `).concat((C=I==null?void 0:I._2DSamplerName)!==null&&C!==void 0?C:"",`,
                    #endif
                #endif
                #ifdef ANISOTROPIC
                    anisotropicOut,
                #endif
                #ifdef REALTIME_FILTERING
                    `).concat((O=I==null?void 0:I._vRefractionFilteringInfoName)!==null&&O!==void 0?O:"",`,
                #endif
                #ifdef SS_USE_LOCAL_REFRACTIONMAP_CUBIC
                    vRefractionPosition,
                    vRefractionSize,
                #endif
            #endif
            #ifdef SS_TRANSLUCENCY
                `).concat($,`,
            #endif
                subSurfaceOut
            );

            #ifdef SS_REFRACTION
                surfaceAlbedo = subSurfaceOut.surfaceAlbedo;
                #ifdef SS_LINKREFRACTIONTOTRANSPARENCY
                    alpha = subSurfaceOut.alpha;
                #endif
            #endif
        #else
            subSurfaceOut.specularEnvironmentReflectance = specularEnvironmentReflectance;
        #endif\r
`),B},n.prototype._buildBlock=function(e){return e.target===g.Fragment&&e.sharedData.blocksWithDefines.push(this),this},n}(L);P("BABYLON.SubSurfaceBlock",pi);var Xl={ambientClr:["finalAmbient",""],diffuseDir:["finalDiffuse",""],specularDir:["finalSpecularScaled","!defined(UNLIT) && defined(SPECULARTERM)"],clearcoatDir:["finalClearCoatScaled","!defined(UNLIT) && defined(CLEARCOAT)"],sheenDir:["finalSheenScaled","!defined(UNLIT) && defined(SHEEN)"],diffuseInd:["finalIrradiance","!defined(UNLIT) && defined(REFLECTION)"],specularInd:["finalRadianceScaled","!defined(UNLIT) && defined(REFLECTION)"],clearcoatInd:["clearcoatOut.finalClearCoatRadianceScaled","!defined(UNLIT) && defined(REFLECTION) && defined(CLEARCOAT)"],sheenInd:["sheenOut.finalSheenRadianceScaled","!defined(UNLIT) && defined(REFLECTION) && defined(SHEEN) && defined(ENVIRONMENTBRDF)"],refraction:["subSurfaceOut.finalRefraction","!defined(UNLIT) && defined(SS_REFRACTION)"],lighting:["finalColor.rgb",""],shadow:["shadow",""],alpha:["alpha",""]},jl=function(r){R(n,r);function n(e){var t=r.call(this,e,g.VertexAndFragment)||this;return t._environmentBRDFTexture=null,t._metallicReflectanceColor=G.White(),t._metallicF0Factor=1,t.directIntensity=1,t.environmentIntensity=1,t.specularIntensity=1,t.lightFalloff=0,t.useAlphaTest=!1,t.alphaTestCutoff=.5,t.useAlphaBlending=!1,t.useRadianceOverAlpha=!0,t.useSpecularOverAlpha=!0,t.enableSpecularAntiAliasing=!1,t.realTimeFiltering=!1,t.realTimeFilteringQuality=8,t.useEnergyConservation=!0,t.useRadianceOcclusion=!0,t.useHorizonOcclusion=!0,t.unlit=!1,t.forceNormalForward=!1,t.debugMode=0,t.debugLimit=0,t.debugFactor=1,t._isUnique=!0,t.registerInput("worldPosition",h.Vector4,!1,g.Vertex),t.registerInput("worldNormal",h.Vector4,!1,g.Fragment),t.registerInput("view",h.Matrix,!1),t.registerInput("cameraPosition",h.Vector3,!1,g.Fragment),t.registerInput("perturbedNormal",h.Vector4,!0,g.Fragment),t.registerInput("baseColor",h.Color3,!0,g.Fragment),t.registerInput("metallic",h.Float,!1,g.Fragment),t.registerInput("roughness",h.Float,!1,g.Fragment),t.registerInput("ambientOcc",h.Float,!0,g.Fragment),t.registerInput("opacity",h.Float,!0,g.Fragment),t.registerInput("indexOfRefraction",h.Float,!0,g.Fragment),t.registerInput("ambientColor",h.Color3,!0,g.Fragment),t.registerInput("reflection",h.Object,!0,g.Fragment,new we("reflection",t,be.Input,Vr,"ReflectionBlock")),t.registerInput("clearcoat",h.Object,!0,g.Fragment,new we("clearcoat",t,be.Input,di,"ClearCoatBlock")),t.registerInput("sheen",h.Object,!0,g.Fragment,new we("sheen",t,be.Input,Br,"SheenBlock")),t.registerInput("subsurface",h.Object,!0,g.Fragment,new we("subsurface",t,be.Input,pi,"SubSurfaceBlock")),t.registerInput("anisotropy",h.Object,!0,g.Fragment,new we("anisotropy",t,be.Input,wr,"AnisotropyBlock")),t.registerOutput("ambientClr",h.Color3,g.Fragment),t.registerOutput("diffuseDir",h.Color3,g.Fragment),t.registerOutput("specularDir",h.Color3,g.Fragment),t.registerOutput("clearcoatDir",h.Color3,g.Fragment),t.registerOutput("sheenDir",h.Color3,g.Fragment),t.registerOutput("diffuseInd",h.Color3,g.Fragment),t.registerOutput("specularInd",h.Color3,g.Fragment),t.registerOutput("clearcoatInd",h.Color3,g.Fragment),t.registerOutput("sheenInd",h.Color3,g.Fragment),t.registerOutput("refraction",h.Color3,g.Fragment),t.registerOutput("lighting",h.Color3,g.Fragment),t.registerOutput("shadow",h.Float,g.Fragment),t.registerOutput("alpha",h.Float,g.Fragment),t}return n.prototype.initialize=function(e){e._excludeVariableName("vLightingIntensity"),e._excludeVariableName("geometricNormalW"),e._excludeVariableName("normalW"),e._excludeVariableName("faceNormal"),e._excludeVariableName("albedoOpacityOut"),e._excludeVariableName("surfaceAlbedo"),e._excludeVariableName("alpha"),e._excludeVariableName("aoOut"),e._excludeVariableName("baseColor"),e._excludeVariableName("reflectivityOut"),e._excludeVariableName("microSurface"),e._excludeVariableName("roughness"),e._excludeVariableName("NdotVUnclamped"),e._excludeVariableName("NdotV"),e._excludeVariableName("alphaG"),e._excludeVariableName("AARoughnessFactors"),e._excludeVariableName("environmentBrdf"),e._excludeVariableName("ambientMonochrome"),e._excludeVariableName("seo"),e._excludeVariableName("eho"),e._excludeVariableName("environmentRadiance"),e._excludeVariableName("irradianceVector"),e._excludeVariableName("environmentIrradiance"),e._excludeVariableName("diffuseBase"),e._excludeVariableName("specularBase"),e._excludeVariableName("preInfo"),e._excludeVariableName("info"),e._excludeVariableName("shadow"),e._excludeVariableName("finalDiffuse"),e._excludeVariableName("finalAmbient"),e._excludeVariableName("ambientOcclusionForDirectDiffuse"),e._excludeVariableName("finalColor"),e._excludeVariableName("vClipSpacePosition"),e._excludeVariableName("vDebugMode")},n.prototype.getClassName=function(){return"PBRMetallicRoughnessBlock"},Object.defineProperty(n.prototype,"worldPosition",{get:function(){return this._inputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"worldNormal",{get:function(){return this._inputs[1]},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"view",{get:function(){return this._inputs[2]},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"cameraPosition",{get:function(){return this._inputs[3]},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"perturbedNormal",{get:function(){return this._inputs[4]},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"baseColor",{get:function(){return this._inputs[5]},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"metallic",{get:function(){return this._inputs[6]},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"roughness",{get:function(){return this._inputs[7]},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"ambientOcc",{get:function(){return this._inputs[8]},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"opacity",{get:function(){return this._inputs[9]},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"indexOfRefraction",{get:function(){return this._inputs[10]},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"ambientColor",{get:function(){return this._inputs[11]},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"reflection",{get:function(){return this._inputs[12]},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"clearcoat",{get:function(){return this._inputs[13]},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"sheen",{get:function(){return this._inputs[14]},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"subsurface",{get:function(){return this._inputs[15]},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"anisotropy",{get:function(){return this._inputs[16]},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"ambientClr",{get:function(){return this._outputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"diffuseDir",{get:function(){return this._outputs[1]},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"specularDir",{get:function(){return this._outputs[2]},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"clearcoatDir",{get:function(){return this._outputs[3]},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"sheenDir",{get:function(){return this._outputs[4]},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"diffuseInd",{get:function(){return this._outputs[5]},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"specularInd",{get:function(){return this._outputs[6]},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"clearcoatInd",{get:function(){return this._outputs[7]},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"sheenInd",{get:function(){return this._outputs[8]},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"refraction",{get:function(){return this._outputs[9]},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"lighting",{get:function(){return this._outputs[10]},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"shadow",{get:function(){return this._outputs[11]},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"alpha",{get:function(){return this._outputs[12]},enumerable:!1,configurable:!0}),n.prototype.autoConfigure=function(e){if(!this.cameraPosition.isConnected){var t=e.getInputBlockByPredicate(function(o){return o.systemValue===Y.CameraPosition});t||(t=new K("cameraPosition"),t.setAsSystemValue(Y.CameraPosition)),t.output.connectTo(this.cameraPosition)}if(!this.view.isConnected){var i=e.getInputBlockByPredicate(function(o){return o.systemValue===Y.View});i||(i=new K("view"),i.setAsSystemValue(Y.View)),i.output.connectTo(this.view)}},n.prototype.prepareDefines=function(e,t,i){i.setValue("PBR",!0),i.setValue("METALLICWORKFLOW",!0),i.setValue("DEBUGMODE",this.debugMode,!0),i.setValue("NORMALXYSCALE",!0),i.setValue("BUMP",this.perturbedNormal.isConnected,!0),i.setValue("LODBASEDMICROSFURACE",this._scene.getEngine().getCaps().textureLOD),i.setValue("ALBEDO",!1,!0),i.setValue("OPACITY",this.opacity.isConnected,!0),i.setValue("AMBIENT",!0,!0),i.setValue("AMBIENTINGRAYSCALE",!1,!0),i.setValue("REFLECTIVITY",!1,!0),i.setValue("AOSTOREINMETALMAPRED",!1,!0),i.setValue("METALLNESSSTOREINMETALMAPBLUE",!1,!0),i.setValue("ROUGHNESSSTOREINMETALMAPALPHA",!1,!0),i.setValue("ROUGHNESSSTOREINMETALMAPGREEN",!1,!0),this.lightFalloff===ye.LIGHTFALLOFF_STANDARD?(i.setValue("USEPHYSICALLIGHTFALLOFF",!1),i.setValue("USEGLTFLIGHTFALLOFF",!1)):this.lightFalloff===ye.LIGHTFALLOFF_GLTF?(i.setValue("USEPHYSICALLIGHTFALLOFF",!1),i.setValue("USEGLTFLIGHTFALLOFF",!0)):(i.setValue("USEPHYSICALLIGHTFALLOFF",!0),i.setValue("USEGLTFLIGHTFALLOFF",!1));var o=this.alphaTestCutoff.toString();i.setValue("ALPHABLEND",this.useAlphaBlending,!0),i.setValue("ALPHAFROMALBEDO",!1,!0),i.setValue("ALPHATEST",this.useAlphaTest,!0),i.setValue("ALPHATESTVALUE",o.indexOf(".")<0?o+".":o,!0),i.setValue("OPACITYRGB",!1,!0),i.setValue("RADIANCEOVERALPHA",this.useRadianceOverAlpha,!0),i.setValue("SPECULAROVERALPHA",this.useSpecularOverAlpha,!0),i.setValue("SPECULARAA",this._scene.getEngine().getCaps().standardDerivatives&&this.enableSpecularAntiAliasing,!0),i.setValue("REALTIME_FILTERING",this.realTimeFiltering,!0);var a=e.getScene();if(a.getEngine()._features.needTypeSuffixInShaderConstants?i.setValue("NUM_SAMPLES",this.realTimeFilteringQuality+"u",!0):i.setValue("NUM_SAMPLES",""+this.realTimeFilteringQuality,!0),i.setValue("BRDF_V_HEIGHT_CORRELATED",!0),i.setValue("MS_BRDF_ENERGY_CONSERVATION",this.useEnergyConservation,!0),i.setValue("RADIANCEOCCLUSION",this.useRadianceOcclusion,!0),i.setValue("HORIZONOCCLUSION",this.useHorizonOcclusion,!0),i.setValue("UNLIT",this.unlit,!0),i.setValue("FORCENORMALFORWARD",this.forceNormalForward,!0),this._environmentBRDFTexture&&M.ReflectionTextureEnabled?(i.setValue("ENVIRONMENTBRDF",!0),i.setValue("ENVIRONMENTBRDF_RGBD",this._environmentBRDFTexture.isRGBD,!0)):(i.setValue("ENVIRONMENTBRDF",!1),i.setValue("ENVIRONMENTBRDF_RGBD",!1)),i._areImageProcessingDirty&&t.imageProcessingConfiguration&&t.imageProcessingConfiguration.prepareDefines(i),!!i._areLightsDirty)if(!this.light)F.PrepareDefinesForLights(a,e,i,!0,t.maxSimultaneousLights),i._needNormals=!0,F.PrepareDefinesForMultiview(a,i);else{var s={needNormals:!1,needRebuild:!1,lightmapMode:!1,shadowEnabled:!1,specularEnabled:!1};F.PrepareDefinesForLight(a,e,this.light,this._lightId,i,!0,s),s.needRebuild&&i.rebuild()}},n.prototype.updateUniformsAndSamples=function(e,t,i,o){for(var a=0;a<t.maxSimultaneousLights&&i["LIGHT"+a];a++){var s=e.uniforms.indexOf("vLightData"+a)>=0;F.PrepareUniformsAndSamplersForLight(a,e.uniforms,e.samplers,i["PROJECTEDLIGHTTEXTURE"+a],o,s)}},n.prototype.isReady=function(e,t,i){return!(this._environmentBRDFTexture&&!this._environmentBRDFTexture.isReady()||i._areImageProcessingDirty&&t.imageProcessingConfiguration&&!t.imageProcessingConfiguration.isReady())},n.prototype.bind=function(e,t,i){var o,a;if(!!i){var s=i.getScene();this.light?F.BindLight(this.light,this._lightId,s,e,!0):F.BindLights(s,i,e,!0,t.maxSimultaneousLights),e.setTexture(this._environmentBrdfSamplerName,this._environmentBRDFTexture),e.setFloat2("vDebugMode",this.debugLimit,this.debugFactor);var c=this._scene.ambientColor;c&&e.setColor3("ambientFromScene",c);var l=s.useRightHandedSystem===(s._mirroredCameraPosition!=null);e.setFloat(this._invertNormalName,l?-1:1),e.setFloat4("vLightingIntensity",this.directIntensity,1,this.environmentIntensity*this._scene.environmentIntensity,this.specularIntensity);var u=1,f=(a=(o=this.indexOfRefraction.connectInputBlock)===null||o===void 0?void 0:o.value)!==null&&a!==void 0?a:1.5,d=Math.pow((f-u)/(f+u),2);this._metallicReflectanceColor.scaleToRef(d*this._metallicF0Factor,ae.Color3[0]);var p=this._metallicF0Factor;e.setColor4(this._vMetallicReflectanceFactorsName,ae.Color3[0],p),t.imageProcessingConfiguration&&t.imageProcessingConfiguration.bind(e)}},n.prototype._injectVertexCode=function(e){var t,i,o=this.worldPosition,a="//".concat(this.name);this.light?(this._lightId=(e.counters.lightCounter!==void 0?e.counters.lightCounter:-1)+1,e.counters.lightCounter=this._lightId,e._emitFunctionFromInclude(e.supportUniformBuffers?"lightVxUboDeclaration":"lightVxFragmentDeclaration",a,{replaceStrings:[{search:/{X}/g,replace:this._lightId.toString()}]},this._lightId.toString())):(e._emitFunctionFromInclude(e.supportUniformBuffers?"lightVxUboDeclaration":"lightVxFragmentDeclaration",a,{repeatKey:"maxSimultaneousLights"}),this._lightId=0,e.sharedData.dynamicUniformBlocks.push(this));var s="v_"+o.associatedVariableName;e._emitVaryingFromString(s,"vec4")&&(e.compilationString+="".concat(s," = ").concat(o.associatedVariableName,`;\r
`));var c=this.reflection.isConnected?(t=this.reflection.connectedPoint)===null||t===void 0?void 0:t.ownerBlock:null;c&&(c.viewConnectionPoint=this.view),e.compilationString+=(i=c==null?void 0:c.handleVertexSide(e))!==null&&i!==void 0?i:"",e._emitUniformFromString("vDebugMode","vec2","defined(IGNORE) || DEBUGMODE > 0"),e._emitUniformFromString("ambientFromScene","vec3"),e._emitVaryingFromString("vClipSpacePosition","vec4","defined(IGNORE) || DEBUGMODE > 0")&&(e._injectAtEnd+=`#if DEBUGMODE > 0\r
`,e._injectAtEnd+=`vClipSpacePosition = gl_Position;\r
`,e._injectAtEnd+=`#endif\r
`),this.light?e.compilationString+=e._emitCodeFromInclude("shadowsVertex",a,{replaceStrings:[{search:/{X}/g,replace:this._lightId.toString()},{search:/worldPos/g,replace:o.associatedVariableName}]}):(e.compilationString+="vec4 worldPos = ".concat(o.associatedVariableName,`;\r
`),this.view.isConnected&&(e.compilationString+="mat4 view = ".concat(this.view.associatedVariableName,`;\r
`)),e.compilationString+=e._emitCodeFromInclude("shadowsVertex",a,{repeatKey:"maxSimultaneousLights"}))},n.prototype._getAlbedoOpacityCode=function(){var e=`albedoOpacityOutParams albedoOpacityOut;\r
`,t=this.baseColor.isConnected?this.baseColor.associatedVariableName:"vec3(1.)",i=this.opacity.isConnected?this.opacity.associatedVariableName:"1.";return e+=`albedoOpacityBlock(
                vec4(`.concat(t,`, 1.),
            #ifdef ALBEDO
                vec4(1.),
                vec2(1., 1.),
            #endif
            #ifdef OPACITY
                vec4(`).concat(i,`),
                vec2(1., 1.),
            #endif
                albedoOpacityOut
            );

            vec3 surfaceAlbedo = albedoOpacityOut.surfaceAlbedo;
            float alpha = albedoOpacityOut.alpha;\r
`),e},n.prototype._getAmbientOcclusionCode=function(){var e=`ambientOcclusionOutParams aoOut;\r
`,t=this.ambientOcc.isConnected?this.ambientOcc.associatedVariableName:"1.";return e+=`ambientOcclusionBlock(
            #ifdef AMBIENT
                vec3(`.concat(t,`),
                vec4(0., 1.0, 1.0, 0.),
            #endif
                aoOut
            );\r
`),e},n.prototype._getReflectivityCode=function(e){var t=`reflectivityOutParams reflectivityOut;\r
`,i="1.";return this._vMetallicReflectanceFactorsName=e._getFreeVariableName("vMetallicReflectanceFactors"),e._emitUniformFromString(this._vMetallicReflectanceFactorsName,"vec4"),t+=`vec3 baseColor = surfaceAlbedo;

            reflectivityBlock(
                vec4(`.concat(this.metallic.associatedVariableName,", ").concat(this.roughness.associatedVariableName,`, 0., 0.),
            #ifdef METALLICWORKFLOW
                surfaceAlbedo,
                `).concat(this._vMetallicReflectanceFactorsName,`,
            #endif
            #ifdef REFLECTIVITY
                vec3(0., 0., `).concat(i,`),
                vec4(1.),
            #endif
            #if defined(METALLICWORKFLOW) && defined(REFLECTIVITY)  && defined(AOSTOREINMETALMAPRED)
                aoOut.ambientOcclusionColor,
            #endif
            #ifdef MICROSURFACEMAP
                microSurfaceTexel, <== not handled!
            #endif
                reflectivityOut
            );

            float microSurface = reflectivityOut.microSurface;
            float roughness = reflectivityOut.roughness;

            #ifdef METALLICWORKFLOW
                surfaceAlbedo = reflectivityOut.surfaceAlbedo;
            #endif
            #if defined(METALLICWORKFLOW) && defined(REFLECTIVITY) && defined(AOSTOREINMETALMAPRED)
                aoOut.ambientOcclusionColor = reflectivityOut.ambientOcclusionColor;
            #endif\r
`),t},n.prototype._buildBlock=function(e){var t,i,o,a,s,c,l,u,f,d,p,m,_,v,b,A,S,C,O,B,k,D,Z,$,I,ue,ge,_e,ce,ie,Se,le,_t,ot,gt,vt,at,Et,We,st;r.prototype._buildBlock.call(this,e),this._scene=e.sharedData.scene,this._environmentBRDFTexture||(this._environmentBRDFTexture=Ai(this._scene));var x=this.reflection.isConnected?(t=this.reflection.connectedPoint)===null||t===void 0?void 0:t.ownerBlock:null;if(x&&(x.worldPositionConnectionPoint=this.worldPosition,x.cameraPositionConnectionPoint=this.cameraPosition,x.worldNormalConnectionPoint=this.worldNormal),e.target!==g.Fragment)return this._injectVertexCode(e),this;e.sharedData.forcedBindableBlocks.push(this),e.sharedData.blocksWithDefines.push(this),e.sharedData.blockingBlocks.push(this);var re="//".concat(this.name),Je="v_"+this.worldPosition.associatedVariableName,Oi=this.perturbedNormal;this._environmentBrdfSamplerName=e._getFreeVariableName("environmentBrdfSampler"),e._emit2DSampler(this._environmentBrdfSamplerName),e.sharedData.hints.needAlphaBlending=e.sharedData.hints.needAlphaBlending||this.useAlphaBlending,e.sharedData.hints.needAlphaTesting=e.sharedData.hints.needAlphaTesting||this.useAlphaTest,e._emitExtension("lod","#extension GL_EXT_shader_texture_lod : enable","defined(LODBASEDMICROSFURACE)"),e._emitExtension("derivatives","#extension GL_OES_standard_derivatives : enable"),e.uniforms.push("exposureLinear"),e.uniforms.push("contrast"),e.uniforms.push("vInverseScreenSize"),e.uniforms.push("vignetteSettings1"),e.uniforms.push("vignetteSettings2"),e.uniforms.push("vCameraColorCurveNegative"),e.uniforms.push("vCameraColorCurveNeutral"),e.uniforms.push("vCameraColorCurvePositive"),e.uniforms.push("txColorTransform"),e.uniforms.push("colorTransformSettings"),this.light?e._emitFunctionFromInclude(e.supportUniformBuffers?"lightUboDeclaration":"lightFragmentDeclaration",re,{replaceStrings:[{search:/{X}/g,replace:this._lightId.toString()}]},this._lightId.toString()):e._emitFunctionFromInclude(e.supportUniformBuffers?"lightUboDeclaration":"lightFragmentDeclaration",re,{repeatKey:"maxSimultaneousLights"}),e._emitFunctionFromInclude("helperFunctions",re),e._emitFunctionFromInclude("importanceSampling",re),e._emitFunctionFromInclude("pbrHelperFunctions",re),e._emitFunctionFromInclude("imageProcessingDeclaration",re),e._emitFunctionFromInclude("imageProcessingFunctions",re),e._emitFunctionFromInclude("shadowsFragmentFunctions",re,{replaceStrings:[{search:/vPositionW/g,replace:Je+".xyz"}]}),e._emitFunctionFromInclude("pbrDirectLightingSetupFunctions",re,{replaceStrings:[{search:/vPositionW/g,replace:Je+".xyz"}]}),e._emitFunctionFromInclude("pbrDirectLightingFalloffFunctions",re),e._emitFunctionFromInclude("pbrBRDFFunctions",re,{replaceStrings:[{search:/REFLECTIONMAP_SKYBOX/g,replace:(i=x==null?void 0:x._defineSkyboxName)!==null&&i!==void 0?i:"REFLECTIONMAP_SKYBOX"}]}),e._emitFunctionFromInclude("hdrFilteringFunctions",re),e._emitFunctionFromInclude("pbrDirectLightingFunctions",re,{replaceStrings:[{search:/vPositionW/g,replace:Je+".xyz"}]}),e._emitFunctionFromInclude("pbrIBLFunctions",re),e._emitFunctionFromInclude("pbrBlockAlbedoOpacity",re),e._emitFunctionFromInclude("pbrBlockReflectivity",re),e._emitFunctionFromInclude("pbrBlockAmbientOcclusion",re),e._emitFunctionFromInclude("pbrBlockAlphaFresnel",re),e._emitFunctionFromInclude("pbrBlockAnisotropic",re),e._emitUniformFromString("vLightingIntensity","vec4"),this._vNormalWName=e._getFreeVariableName("vNormalW"),e.compilationString+="vec4 ".concat(this._vNormalWName," = normalize(").concat(this.worldNormal.associatedVariableName,`);\r
`),e._registerTempVariable("viewDirectionW")&&(e.compilationString+="vec3 viewDirectionW = normalize(".concat(this.cameraPosition.associatedVariableName," - ").concat(Je,`.xyz);\r
`)),e.compilationString+="vec3 geometricNormalW = ".concat(this._vNormalWName,`.xyz;\r
`),e.compilationString+="vec3 normalW = ".concat(Oi.isConnected?"normalize("+Oi.associatedVariableName+".xyz)":"geometricNormalW",`;\r
`),this._invertNormalName=e._getFreeVariableName("invertNormal"),e._emitUniformFromString(this._invertNormalName,"float"),e.compilationString+=e._emitCodeFromInclude("pbrBlockNormalFinal",re,{replaceStrings:[{search:/vPositionW/g,replace:Je+".xyz"},{search:/vEyePosition.w/g,replace:this._invertNormalName}]}),e.compilationString+=this._getAlbedoOpacityCode(),e.compilationString+=e._emitCodeFromInclude("depthPrePass",re),e.compilationString+=this._getAmbientOcclusionCode(),e.compilationString+=e._emitCodeFromInclude("pbrBlockLightmapInit",re),e.compilationString+=`#ifdef UNLIT
                vec3 diffuseBase = vec3(1., 1., 1.);
            #else\r
`,e.compilationString+=this._getReflectivityCode(e),e.compilationString+=e._emitCodeFromInclude("pbrBlockGeometryInfo",re,{replaceStrings:[{search:/REFLECTIONMAP_SKYBOX/g,replace:(o=x==null?void 0:x._defineSkyboxName)!==null&&o!==void 0?o:"REFLECTIONMAP_SKYBOX"},{search:/REFLECTIONMAP_3D/g,replace:(a=x==null?void 0:x._define3DName)!==null&&a!==void 0?a:"REFLECTIONMAP_3D"}]});var xt=this.anisotropy.isConnected?(s=this.anisotropy.connectedPoint)===null||s===void 0?void 0:s.ownerBlock:null;xt&&(xt.worldPositionConnectionPoint=this.worldPosition,xt.worldNormalConnectionPoint=this.worldNormal,e.compilationString+=xt.getCode(e,!this.perturbedNormal.isConnected)),x&&x.hasTexture&&(e.compilationString+=x.getCode(e,xt?"anisotropicOut.anisotropicNormal":"normalW")),e._emitFunctionFromInclude("pbrBlockReflection",re,{replaceStrings:[{search:/computeReflectionCoords/g,replace:"computeReflectionCoordsPBR"},{search:/REFLECTIONMAP_3D/g,replace:(c=x==null?void 0:x._define3DName)!==null&&c!==void 0?c:"REFLECTIONMAP_3D"},{search:/REFLECTIONMAP_OPPOSITEZ/g,replace:(l=x==null?void 0:x._defineOppositeZ)!==null&&l!==void 0?l:"REFLECTIONMAP_OPPOSITEZ"},{search:/REFLECTIONMAP_PROJECTION/g,replace:(u=x==null?void 0:x._defineProjectionName)!==null&&u!==void 0?u:"REFLECTIONMAP_PROJECTION"},{search:/REFLECTIONMAP_SKYBOX/g,replace:(f=x==null?void 0:x._defineSkyboxName)!==null&&f!==void 0?f:"REFLECTIONMAP_SKYBOX"},{search:/LODINREFLECTIONALPHA/g,replace:(d=x==null?void 0:x._defineLODReflectionAlpha)!==null&&d!==void 0?d:"LODINREFLECTIONALPHA"},{search:/LINEARSPECULARREFLECTION/g,replace:(p=x==null?void 0:x._defineLinearSpecularReflection)!==null&&p!==void 0?p:"LINEARSPECULARREFLECTION"},{search:/vReflectionFilteringInfo/g,replace:(m=x==null?void 0:x._vReflectionFilteringInfoName)!==null&&m!==void 0?m:"vReflectionFilteringInfo"}]}),e.compilationString+=e._emitCodeFromInclude("pbrBlockReflectance0",re,{replaceStrings:[{search:/metallicReflectanceFactors/g,replace:this._vMetallicReflectanceFactorsName}]});var Ni=this.sheen.isConnected?(_=this.sheen.connectedPoint)===null||_===void 0?void 0:_.ownerBlock:null;Ni&&(e.compilationString+=Ni.getCode(x)),e._emitFunctionFromInclude("pbrBlockSheen",re,{replaceStrings:[{search:/REFLECTIONMAP_3D/g,replace:(v=x==null?void 0:x._define3DName)!==null&&v!==void 0?v:"REFLECTIONMAP_3D"},{search:/REFLECTIONMAP_SKYBOX/g,replace:(b=x==null?void 0:x._defineSkyboxName)!==null&&b!==void 0?b:"REFLECTIONMAP_SKYBOX"},{search:/LODINREFLECTIONALPHA/g,replace:(A=x==null?void 0:x._defineLODReflectionAlpha)!==null&&A!==void 0?A:"LODINREFLECTIONALPHA"},{search:/LINEARSPECULARREFLECTION/g,replace:(S=x==null?void 0:x._defineLinearSpecularReflection)!==null&&S!==void 0?S:"LINEARSPECULARREFLECTION"}]});var Qt=this.clearcoat.isConnected?(C=this.clearcoat.connectedPoint)===null||C===void 0?void 0:C.ownerBlock:null,Ii=!this.perturbedNormal.isConnected&&!this.anisotropy.isConnected,Hr=this.perturbedNormal.isConnected&&((B=((O=this.perturbedNormal.connectedPoint)===null||O===void 0?void 0:O.ownerBlock).worldTangent)===null||B===void 0?void 0:B.isConnected),zr=this.anisotropy.isConnected&&((k=this.anisotropy.connectedPoint)===null||k===void 0?void 0:k.ownerBlock).worldTangent.isConnected,pn=Hr||!this.perturbedNormal.isConnected&&zr;e.compilationString+=di.GetCode(e,Qt,x,Je,Ii,pn,this.worldNormal.associatedVariableName),Ii&&(pn=(D=Qt==null?void 0:Qt.worldTangent.isConnected)!==null&&D!==void 0?D:!1),e._emitFunctionFromInclude("pbrBlockClearcoat",re,{replaceStrings:[{search:/computeReflectionCoords/g,replace:"computeReflectionCoordsPBR"},{search:/REFLECTIONMAP_3D/g,replace:(Z=x==null?void 0:x._define3DName)!==null&&Z!==void 0?Z:"REFLECTIONMAP_3D"},{search:/REFLECTIONMAP_OPPOSITEZ/g,replace:($=x==null?void 0:x._defineOppositeZ)!==null&&$!==void 0?$:"REFLECTIONMAP_OPPOSITEZ"},{search:/REFLECTIONMAP_PROJECTION/g,replace:(I=x==null?void 0:x._defineProjectionName)!==null&&I!==void 0?I:"REFLECTIONMAP_PROJECTION"},{search:/REFLECTIONMAP_SKYBOX/g,replace:(ue=x==null?void 0:x._defineSkyboxName)!==null&&ue!==void 0?ue:"REFLECTIONMAP_SKYBOX"},{search:/LODINREFLECTIONALPHA/g,replace:(ge=x==null?void 0:x._defineLODReflectionAlpha)!==null&&ge!==void 0?ge:"LODINREFLECTIONALPHA"},{search:/LINEARSPECULARREFLECTION/g,replace:(_e=x==null?void 0:x._defineLinearSpecularReflection)!==null&&_e!==void 0?_e:"LINEARSPECULARREFLECTION"},{search:/defined\(TANGENT\)/g,replace:pn?"defined(TANGENT)":"defined(IGNORE)"}]}),e.compilationString+=e._emitCodeFromInclude("pbrBlockReflectance",re,{replaceStrings:[{search:/REFLECTIONMAP_SKYBOX/g,replace:(ce=x==null?void 0:x._defineSkyboxName)!==null&&ce!==void 0?ce:"REFLECTIONMAP_SKYBOX"},{search:/REFLECTIONMAP_3D/g,replace:(ie=x==null?void 0:x._define3DName)!==null&&ie!==void 0?ie:"REFLECTIONMAP_3D"}]});var Xr=this.subsurface.isConnected?(Se=this.subsurface.connectedPoint)===null||Se===void 0?void 0:Se.ownerBlock:null,Ie=this.subsurface.isConnected?(_t=((le=this.subsurface.connectedPoint)===null||le===void 0?void 0:le.ownerBlock).refraction.connectedPoint)===null||_t===void 0?void 0:_t.ownerBlock:null;Ie&&(Ie.viewConnectionPoint=this.view,Ie.indexOfRefractionConnectionPoint=this.indexOfRefraction),e.compilationString+=pi.GetCode(e,Xr,x,Je),e._emitFunctionFromInclude("pbrBlockSubSurface",re,{replaceStrings:[{search:/REFLECTIONMAP_3D/g,replace:(ot=x==null?void 0:x._define3DName)!==null&&ot!==void 0?ot:"REFLECTIONMAP_3D"},{search:/REFLECTIONMAP_OPPOSITEZ/g,replace:(gt=x==null?void 0:x._defineOppositeZ)!==null&&gt!==void 0?gt:"REFLECTIONMAP_OPPOSITEZ"},{search:/REFLECTIONMAP_PROJECTION/g,replace:(vt=x==null?void 0:x._defineProjectionName)!==null&&vt!==void 0?vt:"REFLECTIONMAP_PROJECTION"},{search:/SS_REFRACTIONMAP_3D/g,replace:(at=Ie==null?void 0:Ie._define3DName)!==null&&at!==void 0?at:"SS_REFRACTIONMAP_3D"},{search:/SS_LODINREFRACTIONALPHA/g,replace:(Et=Ie==null?void 0:Ie._defineLODRefractionAlpha)!==null&&Et!==void 0?Et:"SS_LODINREFRACTIONALPHA"},{search:/SS_LINEARSPECULARREFRACTION/g,replace:(We=Ie==null?void 0:Ie._defineLinearSpecularRefraction)!==null&&We!==void 0?We:"SS_LINEARSPECULARREFRACTION"},{search:/SS_REFRACTIONMAP_OPPOSITEZ/g,replace:(st=Ie==null?void 0:Ie._defineOppositeZ)!==null&&st!==void 0?st:"SS_REFRACTIONMAP_OPPOSITEZ"}]}),e.compilationString+=e._emitCodeFromInclude("pbrBlockDirectLighting",re),this.light?e.compilationString+=e._emitCodeFromInclude("lightFragment",re,{replaceStrings:[{search:/{X}/g,replace:this._lightId.toString()}]}):e.compilationString+=e._emitCodeFromInclude("lightFragment",re,{repeatKey:"maxSimultaneousLights"}),e.compilationString+=e._emitCodeFromInclude("pbrBlockFinalLitComponents",re),e.compilationString+=`#endif\r
`;var jr=this.ambientColor.isConnected?this.ambientColor.associatedVariableName:"vec3(0., 0., 0.)",mn=ye.DEFAULT_AO_ON_ANALYTICAL_LIGHTS.toString();mn.indexOf(".")===-1&&(mn+="."),e.compilationString+=e._emitCodeFromInclude("pbrBlockFinalUnlitComponents",re,{replaceStrings:[{search:/vec3 finalEmissive[\s\S]*?finalEmissive\*=vLightingIntensity\.y;/g,replace:""},{search:/vAmbientColor/g,replace:jr+" * ambientFromScene"},{search:/vAmbientInfos\.w/g,replace:mn}]}),e.compilationString+=e._emitCodeFromInclude("pbrBlockFinalColorComposition",re,{replaceStrings:[{search:/finalEmissive/g,replace:"vec3(0.)"}]}),e.compilationString+=e._emitCodeFromInclude("pbrBlockImageProcessing",re,{replaceStrings:[{search:/visibility/g,replace:"1."}]}),e.compilationString+=e._emitCodeFromInclude("pbrDebug",re,{replaceStrings:[{search:/vNormalW/g,replace:this._vNormalWName},{search:/vPositionW/g,replace:Je},{search:/albedoTexture\.rgb;/g,replace:`vec3(1.);\r
gl_FragColor.rgb = toGammaSpace(gl_FragColor.rgb);\r
`}]});for(var _n=0,Pi=this._outputs;_n<Pi.length;_n++){var Mt=Pi[_n];if(Mt.hasEndpoints){var gn=Xl[Mt.name];if(gn){var Yr=gn[0],vn=gn[1];vn&&(e.compilationString+="#if ".concat(vn,`\r
`)),e.compilationString+="".concat(this._declareOutput(Mt,e)," = ").concat(Yr,`;\r
`),vn&&(e.compilationString+=`#else\r
`,e.compilationString+="".concat(this._declareOutput(Mt,e),` = vec3(0.);\r
`),e.compilationString+=`#endif\r
`)}else console.error("There's no remapping for the ".concat(Mt.name," end point! No code generated"))}}return this},n.prototype._dumpPropertiesCode=function(){var e=r.prototype._dumpPropertiesCode.call(this);return e+="".concat(this._codeVariableName,".lightFalloff = ").concat(this.lightFalloff,`;\r
`),e+="".concat(this._codeVariableName,".useAlphaTest = ").concat(this.useAlphaTest,`;\r
`),e+="".concat(this._codeVariableName,".alphaTestCutoff = ").concat(this.alphaTestCutoff,`;\r
`),e+="".concat(this._codeVariableName,".useAlphaBlending = ").concat(this.useAlphaBlending,`;\r
`),e+="".concat(this._codeVariableName,".useRadianceOverAlpha = ").concat(this.useRadianceOverAlpha,`;\r
`),e+="".concat(this._codeVariableName,".useSpecularOverAlpha = ").concat(this.useSpecularOverAlpha,`;\r
`),e+="".concat(this._codeVariableName,".enableSpecularAntiAliasing = ").concat(this.enableSpecularAntiAliasing,`;\r
`),e+="".concat(this._codeVariableName,".realTimeFiltering = ").concat(this.realTimeFiltering,`;\r
`),e+="".concat(this._codeVariableName,".realTimeFilteringQuality = ").concat(this.realTimeFilteringQuality,`;\r
`),e+="".concat(this._codeVariableName,".useEnergyConservation = ").concat(this.useEnergyConservation,`;\r
`),e+="".concat(this._codeVariableName,".useRadianceOcclusion = ").concat(this.useRadianceOcclusion,`;\r
`),e+="".concat(this._codeVariableName,".useHorizonOcclusion = ").concat(this.useHorizonOcclusion,`;\r
`),e+="".concat(this._codeVariableName,".unlit = ").concat(this.unlit,`;\r
`),e+="".concat(this._codeVariableName,".forceNormalForward = ").concat(this.forceNormalForward,`;\r
`),e+="".concat(this._codeVariableName,".debugMode = ").concat(this.debugMode,`;\r
`),e+="".concat(this._codeVariableName,".debugLimit = ").concat(this.debugLimit,`;\r
`),e+="".concat(this._codeVariableName,".debugFactor = ").concat(this.debugFactor,`;\r
`),e},n.prototype.serialize=function(){var e=r.prototype.serialize.call(this);return this.light&&(e.lightId=this.light.id),e.lightFalloff=this.lightFalloff,e.useAlphaTest=this.useAlphaTest,e.alphaTestCutoff=this.alphaTestCutoff,e.useAlphaBlending=this.useAlphaBlending,e.useRadianceOverAlpha=this.useRadianceOverAlpha,e.useSpecularOverAlpha=this.useSpecularOverAlpha,e.enableSpecularAntiAliasing=this.enableSpecularAntiAliasing,e.realTimeFiltering=this.realTimeFiltering,e.realTimeFilteringQuality=this.realTimeFilteringQuality,e.useEnergyConservation=this.useEnergyConservation,e.useRadianceOcclusion=this.useRadianceOcclusion,e.useHorizonOcclusion=this.useHorizonOcclusion,e.unlit=this.unlit,e.forceNormalForward=this.forceNormalForward,e.debugMode=this.debugMode,e.debugLimit=this.debugLimit,e.debugFactor=this.debugFactor,e},n.prototype._deserialize=function(e,t,i){var o,a;r.prototype._deserialize.call(this,e,t,i),e.lightId&&(this.light=t.getLightById(e.lightId)),this.lightFalloff=(o=e.lightFalloff)!==null&&o!==void 0?o:0,this.useAlphaTest=e.useAlphaTest,this.alphaTestCutoff=e.alphaTestCutoff,this.useAlphaBlending=e.useAlphaBlending,this.useRadianceOverAlpha=e.useRadianceOverAlpha,this.useSpecularOverAlpha=e.useSpecularOverAlpha,this.enableSpecularAntiAliasing=e.enableSpecularAntiAliasing,this.realTimeFiltering=!!e.realTimeFiltering,this.realTimeFilteringQuality=(a=e.realTimeFilteringQuality)!==null&&a!==void 0?a:8,this.useEnergyConservation=e.useEnergyConservation,this.useRadianceOcclusion=e.useRadianceOcclusion,this.useHorizonOcclusion=e.useHorizonOcclusion,this.unlit=e.unlit,this.forceNormalForward=!!e.forceNormalForward,this.debugMode=e.debugMode,this.debugLimit=e.debugLimit,this.debugFactor=e.debugFactor},E([te("Direct lights",ee.Float,"INTENSITY",{min:0,max:1,notifiers:{update:!0}})],n.prototype,"directIntensity",void 0),E([te("Environment lights",ee.Float,"INTENSITY",{min:0,max:1,notifiers:{update:!0}})],n.prototype,"environmentIntensity",void 0),E([te("Specular highlights",ee.Float,"INTENSITY",{min:0,max:1,notifiers:{update:!0}})],n.prototype,"specularIntensity",void 0),E([te("Light falloff",ee.List,"LIGHTING & COLORS",{notifiers:{update:!0},options:[{label:"Physical",value:ye.LIGHTFALLOFF_PHYSICAL},{label:"GLTF",value:ye.LIGHTFALLOFF_GLTF},{label:"Standard",value:ye.LIGHTFALLOFF_STANDARD}]})],n.prototype,"lightFalloff",void 0),E([te("Alpha Testing",ee.Boolean,"OPACITY")],n.prototype,"useAlphaTest",void 0),E([te("Alpha CutOff",ee.Float,"OPACITY",{min:0,max:1,notifiers:{update:!0}})],n.prototype,"alphaTestCutoff",void 0),E([te("Alpha blending",ee.Boolean,"OPACITY")],n.prototype,"useAlphaBlending",void 0),E([te("Radiance over alpha",ee.Boolean,"RENDERING",{notifiers:{update:!0}})],n.prototype,"useRadianceOverAlpha",void 0),E([te("Specular over alpha",ee.Boolean,"RENDERING",{notifiers:{update:!0}})],n.prototype,"useSpecularOverAlpha",void 0),E([te("Specular anti-aliasing",ee.Boolean,"RENDERING",{notifiers:{update:!0}})],n.prototype,"enableSpecularAntiAliasing",void 0),E([te("Realtime filtering",ee.Boolean,"RENDERING",{notifiers:{update:!0}})],n.prototype,"realTimeFiltering",void 0),E([te("Realtime filtering quality",ee.List,"RENDERING",{notifiers:{update:!0},options:[{label:"Low",value:8},{label:"Medium",value:16},{label:"High",value:64}]})],n.prototype,"realTimeFilteringQuality",void 0),E([te("Energy Conservation",ee.Boolean,"ADVANCED",{notifiers:{update:!0}})],n.prototype,"useEnergyConservation",void 0),E([te("Radiance occlusion",ee.Boolean,"ADVANCED",{notifiers:{update:!0}})],n.prototype,"useRadianceOcclusion",void 0),E([te("Horizon occlusion",ee.Boolean,"ADVANCED",{notifiers:{update:!0}})],n.prototype,"useHorizonOcclusion",void 0),E([te("Unlit",ee.Boolean,"ADVANCED",{notifiers:{update:!0}})],n.prototype,"unlit",void 0),E([te("Force normal forward",ee.Boolean,"ADVANCED",{notifiers:{update:!0}})],n.prototype,"forceNormalForward",void 0),E([te("Debug mode",ee.List,"DEBUG",{notifiers:{update:!0},options:[{label:"None",value:0},{label:"Normalized position",value:1},{label:"Normals",value:2},{label:"Tangents",value:3},{label:"Bitangents",value:4},{label:"Bump Normals",value:5},{label:"ClearCoat Normals",value:8},{label:"ClearCoat Tangents",value:9},{label:"ClearCoat Bitangents",value:10},{label:"Anisotropic Normals",value:11},{label:"Anisotropic Tangents",value:12},{label:"Anisotropic Bitangents",value:13},{label:"Env Refraction",value:40},{label:"Env Reflection",value:41},{label:"Env Clear Coat",value:42},{label:"Direct Diffuse",value:50},{label:"Direct Specular",value:51},{label:"Direct Clear Coat",value:52},{label:"Direct Sheen",value:53},{label:"Env Irradiance",value:54},{label:"Surface Albedo",value:60},{label:"Reflectance 0",value:61},{label:"Metallic",value:62},{label:"Metallic F0",value:71},{label:"Roughness",value:63},{label:"AlphaG",value:64},{label:"NdotV",value:65},{label:"ClearCoat Color",value:66},{label:"ClearCoat Roughness",value:67},{label:"ClearCoat NdotV",value:68},{label:"Transmittance",value:69},{label:"Refraction Transmittance",value:70},{label:"SEO",value:80},{label:"EHO",value:81},{label:"Energy Factor",value:82},{label:"Specular Reflectance",value:83},{label:"Clear Coat Reflectance",value:84},{label:"Sheen Reflectance",value:85},{label:"Luminance Over Alpha",value:86},{label:"Alpha",value:87}]})],n.prototype,"debugMode",void 0),E([te("Split position",ee.Float,"DEBUG",{min:-1,max:1,notifiers:{update:!0}})],n.prototype,"debugLimit",void 0),E([te("Output factor",ee.Float,"DEBUG",{min:0,max:5,notifiers:{update:!0}})],n.prototype,"debugFactor",void 0),n}(L);P("BABYLON.PBRMetallicRoughnessBlock",jl);var Yl=function(r){R(n,r);function n(e){var t=r.call(this,e,g.Neutral)||this;return t.registerInput("left",h.AutoDetect),t.registerInput("right",h.AutoDetect),t.registerOutput("output",h.BasedOnInput),t._outputs[0]._typeConnectionSource=t._inputs[0],t._linkConnectionTypes(0,1),t}return n.prototype.getClassName=function(){return"ModBlock"},Object.defineProperty(n.prototype,"left",{get:function(){return this._inputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"right",{get:function(){return this._inputs[1]},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"output",{get:function(){return this._outputs[0]},enumerable:!1,configurable:!0}),n.prototype._buildBlock=function(e){r.prototype._buildBlock.call(this,e);var t=this._outputs[0];return e.compilationString+=this._declareOutput(t,e)+" = mod(".concat(this.left.associatedVariableName,", ").concat(this.right.associatedVariableName,`);\r
`),this},n}(L);P("BABYLON.ModBlock",Yl);var Wl=function(r){R(n,r);function n(e){var t=r.call(this,e,g.Neutral)||this;return t.registerInput("row0",h.Vector4),t.registerInput("row1",h.Vector4),t.registerInput("row2",h.Vector4),t.registerInput("row3",h.Vector4),t.registerOutput("output",h.Matrix),t}return n.prototype.getClassName=function(){return"MatrixBuilder"},Object.defineProperty(n.prototype,"row0",{get:function(){return this._inputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"row1",{get:function(){return this._inputs[1]},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"row2",{get:function(){return this._inputs[2]},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"row3",{get:function(){return this._inputs[3]},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"output",{get:function(){return this._outputs[0]},enumerable:!1,configurable:!0}),n.prototype.autoConfigure=function(){if(!this.row0.isConnected){var e=new K("row0");e.value=new ut(1,0,0,0),e.output.connectTo(this.row0)}if(!this.row1.isConnected){var t=new K("row1");t.value=new ut(0,1,0,0),t.output.connectTo(this.row1)}if(!this.row2.isConnected){var i=new K("row2");i.value=new ut(0,0,1,0),i.output.connectTo(this.row2)}if(!this.row3.isConnected){var o=new K("row3");o.value=new ut(0,0,0,1),o.output.connectTo(this.row3)}},n.prototype._buildBlock=function(e){r.prototype._buildBlock.call(this,e);var t=this._outputs[0],i=this.row0,o=this.row1,a=this.row2,s=this.row3;return e.compilationString+=this._declareOutput(t,e)+" = mat4(".concat(i.associatedVariableName,", ").concat(o.associatedVariableName,", ").concat(a.associatedVariableName,", ").concat(s.associatedVariableName,`);\r
`),this},n}(L);P("BABYLON.MatrixBuilder",Wl);var Ue;(function(r){r[r.Equal=0]="Equal",r[r.NotEqual=1]="NotEqual",r[r.LessThan=2]="LessThan",r[r.GreaterThan=3]="GreaterThan",r[r.LessOrEqual=4]="LessOrEqual",r[r.GreaterOrEqual=5]="GreaterOrEqual",r[r.Xor=6]="Xor",r[r.Or=7]="Or",r[r.And=8]="And"})(Ue||(Ue={}));var Kl=function(r){R(n,r);function n(e){var t=r.call(this,e,g.Neutral)||this;return t.condition=Ue.LessThan,t.registerInput("a",h.Float),t.registerInput("b",h.Float),t.registerInput("true",h.AutoDetect,!0),t.registerInput("false",h.AutoDetect,!0),t.registerOutput("output",h.BasedOnInput),t._linkConnectionTypes(2,3),t._outputs[0]._typeConnectionSource=t._inputs[2],t._outputs[0]._defaultConnectionPointType=h.Float,t}return n.prototype.getClassName=function(){return"ConditionalBlock"},Object.defineProperty(n.prototype,"a",{get:function(){return this._inputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"b",{get:function(){return this._inputs[1]},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"true",{get:function(){return this._inputs[2]},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"false",{get:function(){return this._inputs[3]},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"output",{get:function(){return this._outputs[0]},enumerable:!1,configurable:!0}),n.prototype._buildBlock=function(e){r.prototype._buildBlock.call(this,e);var t=this._outputs[0],i=this.true.isConnected?this.true.associatedVariableName:"1.0",o=this.false.isConnected?this.false.associatedVariableName:"0.0";switch(this.condition){case Ue.Equal:{e.compilationString+=this._declareOutput(t,e)+" = ".concat(this.a.associatedVariableName," == ").concat(this.b.associatedVariableName," ? ").concat(i," : ").concat(o,`;\r
`);break}case Ue.NotEqual:{e.compilationString+=this._declareOutput(t,e)+" = ".concat(this.a.associatedVariableName," != ").concat(this.b.associatedVariableName," ? ").concat(i," : ").concat(o,`;\r
`);break}case Ue.LessThan:{e.compilationString+=this._declareOutput(t,e)+" = ".concat(this.a.associatedVariableName," < ").concat(this.b.associatedVariableName," ? ").concat(i," : ").concat(o,`;\r
`);break}case Ue.LessOrEqual:{e.compilationString+=this._declareOutput(t,e)+" = ".concat(this.a.associatedVariableName," <= ").concat(this.b.associatedVariableName," ? ").concat(i," : ").concat(o,`;\r
`);break}case Ue.GreaterThan:{e.compilationString+=this._declareOutput(t,e)+" = ".concat(this.a.associatedVariableName," > ").concat(this.b.associatedVariableName," ? ").concat(i," : ").concat(o,`;\r
`);break}case Ue.GreaterOrEqual:{e.compilationString+=this._declareOutput(t,e)+" = ".concat(this.a.associatedVariableName," >= ").concat(this.b.associatedVariableName," ? ").concat(i," : ").concat(o,`;\r
`);break}case Ue.Xor:{e.compilationString+=this._declareOutput(t,e)+" = (mod(".concat(this.a.associatedVariableName," + ").concat(this.b.associatedVariableName,", 2.0) > 0.0) ? ").concat(i," : ").concat(o,`;\r
`);break}case Ue.Or:{e.compilationString+=this._declareOutput(t,e)+" = (min(".concat(this.a.associatedVariableName," + ").concat(this.b.associatedVariableName,", 1.0) > 0.0) ? ").concat(i," : ").concat(o,`;\r
`);break}case Ue.And:{e.compilationString+=this._declareOutput(t,e)+" = (".concat(this.a.associatedVariableName," * ").concat(this.b.associatedVariableName," > 0.0)  ? ").concat(i," : ").concat(o,`;\r
`);break}}return this},n.prototype.serialize=function(){var e=r.prototype.serialize.call(this);return e.condition=this.condition,e},n.prototype._deserialize=function(e,t,i){r.prototype._deserialize.call(this,e,t,i),this.condition=e.condition},n.prototype._dumpPropertiesCode=function(){var e=r.prototype._dumpPropertiesCode.call(this)+"".concat(this._codeVariableName,".condition = BABYLON.ConditionalBlockConditions.").concat(Ue[this.condition],`;\r
`);return e},n}(L);P("BABYLON.ConditionalBlock",Kl);var Ql=function(r){R(n,r);function n(e){var t=r.call(this,e,g.Neutral)||this;return t.octaves=6,t.registerInput("seed",h.AutoDetect),t.registerInput("chaos",h.AutoDetect,!0),t.registerInput("offsetX",h.Float,!0),t.registerInput("offsetY",h.Float,!0),t.registerInput("offsetZ",h.Float,!0),t.registerOutput("output",h.Float),t._inputs[0].acceptedConnectionPointTypes.push(h.Vector2),t._inputs[0].acceptedConnectionPointTypes.push(h.Vector3),t._linkConnectionTypes(0,1),t}return n.prototype.getClassName=function(){return"CloudBlock"},Object.defineProperty(n.prototype,"seed",{get:function(){return this._inputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"chaos",{get:function(){return this._inputs[1]},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"offsetX",{get:function(){return this._inputs[2]},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"offsetY",{get:function(){return this._inputs[3]},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"offsetZ",{get:function(){return this._inputs[4]},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"output",{get:function(){return this._outputs[0]},enumerable:!1,configurable:!0}),n.prototype._buildBlock=function(e){var t,i;if(r.prototype._buildBlock.call(this,e),!!this.seed.isConnected&&!!this._outputs[0].hasEndpoints){var o=`

        float cloudRandom(in float p) { p = fract(p * 0.011); p *= p + 7.5; p *= p + p; return fract(p); }

        // Based on Morgan McGuire @morgan3d
        // https://www.shadertoy.com/view/4dS3Wd
        float cloudNoise(in vec2 x, in vec2 chaos) {
            vec2 step = chaos * vec2(75., 120.) + vec2(75., 120.);

            vec2 i = floor(x);
            vec2 f = fract(x);

            float n = dot(i, step);

            vec2 u = f * f * (3.0 - 2.0 * f);
            return mix(
                    mix(cloudRandom(n + dot(step, vec2(0, 0))), cloudRandom(n + dot(step, vec2(1, 0))), u.x),
                    mix(cloudRandom(n + dot(step, vec2(0, 1))), cloudRandom(n + dot(step, vec2(1, 1))), u.x),
                    u.y
                );
        }

        float cloudNoise(in vec3 x, in vec3 chaos) {
            vec3 step = chaos * vec3(60., 120., 75.) + vec3(60., 120., 75.);

            vec3 i = floor(x);
            vec3 f = fract(x);

            float n = dot(i, step);

            vec3 u = f * f * (3.0 - 2.0 * f);
            return mix(mix(mix( cloudRandom(n + dot(step, vec3(0, 0, 0))), cloudRandom(n + dot(step, vec3(1, 0, 0))), u.x),
                           mix( cloudRandom(n + dot(step, vec3(0, 1, 0))), cloudRandom(n + dot(step, vec3(1, 1, 0))), u.x), u.y),
                       mix(mix( cloudRandom(n + dot(step, vec3(0, 0, 1))), cloudRandom(n + dot(step, vec3(1, 0, 1))), u.x),
                           mix( cloudRandom(n + dot(step, vec3(0, 1, 1))), cloudRandom(n + dot(step, vec3(1, 1, 1))), u.x), u.y), u.z);
        }`,a=`
        float fbm(in vec2 st, in vec2 chaos) {
            // Initial values
            float value = 0.0;
            float amplitude = .5;
            float frequency = 0.;

            // Loop of octaves
            for (int i = 0; i < OCTAVES; i++) {
                value += amplitude * cloudNoise(st, chaos);
                st *= 2.0;
                amplitude *= 0.5;
            }
            return value;
        }

        float fbm(in vec3 x, in vec3 chaos) {
            // Initial values
            float value = 0.0;
            float amplitude = 0.5;
            for (int i = 0; i < OCTAVES; ++i) {
                value += amplitude * cloudNoise(x, chaos);
                x = x * 2.0;
                amplitude *= 0.5;
            }
            return value;
        }`,s="fbm".concat(this.octaves);e._emitFunction("CloudBlockCode",o,"// CloudBlockCode"),e._emitFunction("CloudBlockCodeFBM"+this.octaves,a.replace(/fbm/gi,s).replace(/OCTAVES/gi,(this.octaves|0).toString()),"// CloudBlockCode FBM");var c=e._getFreeVariableName("st"),l=((t=this.seed.connectedPoint)===null||t===void 0?void 0:t.type)===h.Vector2?"vec2":"vec3";e.compilationString+="".concat(l," ").concat(c," = ").concat(this.seed.associatedVariableName,`;\r
`),this.offsetX.isConnected&&(e.compilationString+="".concat(c,".x += 0.1 * ").concat(this.offsetX.associatedVariableName,`;\r
`)),this.offsetY.isConnected&&(e.compilationString+="".concat(c,".y += 0.1 * ").concat(this.offsetY.associatedVariableName,`;\r
`)),this.offsetZ.isConnected&&l==="vec3"&&(e.compilationString+="".concat(c,".z += 0.1 * ").concat(this.offsetZ.associatedVariableName,`;\r
`));var u="";return this.chaos.isConnected?u=this.chaos.associatedVariableName:u=((i=this.seed.connectedPoint)===null||i===void 0?void 0:i.type)===h.Vector2?"vec2(0., 0.)":"vec3(0., 0., 0.)",e.compilationString+=this._declareOutput(this._outputs[0],e)+" = ".concat(s,"(").concat(c,", ").concat(u,`);\r
`),this}},n.prototype._dumpPropertiesCode=function(){var e=r.prototype._dumpPropertiesCode.call(this)+"".concat(this._codeVariableName,".octaves = ").concat(this.octaves,`;\r
`);return e},n.prototype.serialize=function(){var e=r.prototype.serialize.call(this);return e.octaves=this.octaves,e},n.prototype._deserialize=function(e,t,i){r.prototype._deserialize.call(this,e,t,i),this.octaves=e.octaves},E([te("Octaves",ee.Int)],n.prototype,"octaves",void 0),n}(L);P("BABYLON.CloudBlock",Ql);var ql=function(r){R(n,r);function n(e){var t=r.call(this,e,g.Neutral)||this;return t.registerInput("seed",h.Vector2),t.registerInput("offset",h.Float),t.registerInput("density",h.Float),t.registerOutput("output",h.Float),t.registerOutput("cells",h.Float),t}return n.prototype.getClassName=function(){return"VoronoiNoiseBlock"},Object.defineProperty(n.prototype,"seed",{get:function(){return this._inputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"offset",{get:function(){return this._inputs[1]},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"density",{get:function(){return this._inputs[2]},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"output",{get:function(){return this._outputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"cells",{get:function(){return this._outputs[1]},enumerable:!1,configurable:!0}),n.prototype._buildBlock=function(e){if(r.prototype._buildBlock.call(this,e),!!this.seed.isConnected){var t=`vec2 voronoiRandom(vec2 seed, float offset){
            mat2 m = mat2(15.27, 47.63, 99.41, 89.98);
            vec2 uv = fract(sin(m * seed) * 46839.32);
            return vec2(sin(uv.y * offset) * 0.5 + 0.5, cos(uv.x * offset) * 0.5 + 0.5);
        }
        `;e._emitFunction("voronoiRandom",t,"// Voronoi random generator"),t=`void voronoi(vec2 seed, float offset, float density, out float outValue, out float cells){
            vec2 g = floor(seed * density);
            vec2 f = fract(seed * density);
            float t = 8.0;
            vec3 res = vec3(8.0, 0.0, 0.0);

            for(int y=-1; y<=1; y++)
            {
                for(int x=-1; x<=1; x++)
                {
                    vec2 lattice = vec2(x,y);
                    vec2 randomOffset = voronoiRandom(lattice + g, offset);
                    float d = distance(lattice + randomOffset, f);
                    if(d < res.x)
                    {
                        res = vec3(d, randomOffset.x, randomOffset.y);
                        outValue = res.x;
                        cells = res.y;
                    }
                }
            }
        }
        `,e._emitFunction("voronoi",t,"// Voronoi");var i=e._getFreeVariableName("tempOutput"),o=e._getFreeVariableName("tempCells");return e.compilationString+="float ".concat(i,` = 0.0;\r
`),e.compilationString+="float ".concat(o,` = 0.0;\r
`),e.compilationString+="voronoi(".concat(this.seed.associatedVariableName,", ").concat(this.offset.associatedVariableName,", ").concat(this.density.associatedVariableName,", ").concat(i,", ").concat(o,`);\r
`),this.output.hasEndpoints&&(e.compilationString+=this._declareOutput(this.output,e)+" = ".concat(i,`;\r
`)),this.cells.hasEndpoints&&(e.compilationString+=this._declareOutput(this.cells,e)+" = ".concat(o,`;\r
`)),this}},n}(L);P("BABYLON.VoronoiNoiseBlock",ql);var Zl=function(r){R(n,r);function n(e){var t=r.call(this,e,g.Neutral)||this;return t.registerInput("input",h.AutoDetect),t.registerOutput("output",h.BasedOnInput),t._outputs[0]._typeConnectionSource=t._inputs[0],t}return n.prototype.getClassName=function(){return"ElbowBlock"},Object.defineProperty(n.prototype,"input",{get:function(){return this._inputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"output",{get:function(){return this._outputs[0]},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"target",{get:function(){var e=this._inputs[0];if(e.isConnected){var t=e.connectedPoint.ownerBlock;if(t.isInput)return g.Vertex}return this._target},set:function(e){(this._target&e)===0&&(this._target=e)},enumerable:!1,configurable:!0}),n.prototype._buildBlock=function(e){r.prototype._buildBlock.call(this,e);var t=this._outputs[0],i=this._inputs[0];return e.compilationString+=this._declareOutput(t,e)+" = ".concat(i.associatedVariableName,`;\r
`),this},n}(L);P("BABYLON.ElbowBlock",Zl);var Jl=Object.freeze(new q(0,0,0,0)),$l=Object.freeze(y.Zero()),eu=Object.freeze(Ge.Zero()),tu=Object.freeze(Io.Zero()),nu=Object.freeze(G.Black()),iu=function(){function r(n,e,t,i){var o=this;if(this._events=new Array,this._currentFrame=0,this._originalValue=new Array,this._originalBlendValue=null,this._offsetsCache={},this._highLimitsCache={},this._stopped=!1,this._blendingFactor=0,this._currentValue=null,this._currentActiveTarget=null,this._directTarget=null,this._targetPath="",this._weight=1,this._ratioOffset=0,this._previousDelay=0,this._previousRatio=0,this._targetIsArray=!1,this._animation=e,this._target=n,this._scene=t,this._host=i,this._activeTargets=[],e._runtimeAnimations.push(this),this._animationState={key:0,repeatCount:0,loopMode:this._getCorrectLoopMode()},this._animation.dataType===J.ANIMATIONTYPE_MATRIX&&(this._animationState.workValue=Q.Zero()),this._keys=this._animation.getKeys(),this._minFrame=this._keys[0].frame,this._maxFrame=this._keys[this._keys.length-1].frame,this._minValue=this._keys[0].value,this._maxValue=this._keys[this._keys.length-1].value,this._minFrame!==0){var a={frame:0,value:this._minValue};this._keys.splice(0,0,a)}if(this._target instanceof Array){for(var s=0,c=0,l=this._target;c<l.length;c++){var u=l[c];this._preparePath(u,s),this._getOriginalValues(s),s++}this._targetIsArray=!0}else this._preparePath(this._target),this._getOriginalValues(),this._targetIsArray=!1,this._directTarget=this._activeTargets[0];var f=e.getEvents();f&&f.length>0&&f.forEach(function(d){o._events.push(d._clone())}),this._enableBlending=n&&n.animationPropertiesOverride?n.animationPropertiesOverride.enableBlending:this._animation.enableBlending}return Object.defineProperty(r.prototype,"currentFrame",{get:function(){return this._currentFrame},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"weight",{get:function(){return this._weight},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"currentValue",{get:function(){return this._currentValue},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"targetPath",{get:function(){return this._targetPath},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"target",{get:function(){return this._currentActiveTarget},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"isAdditive",{get:function(){return this._host&&this._host.isAdditive},enumerable:!1,configurable:!0}),r.prototype._preparePath=function(n,e){e===void 0&&(e=0);var t=this._animation.targetPropertyPath;if(t.length>1){for(var i=n[t[0]],o=1;o<t.length-1;o++)i=i[t[o]];this._targetPath=t[t.length-1],this._activeTargets[e]=i}else this._targetPath=t[0],this._activeTargets[e]=n},Object.defineProperty(r.prototype,"animation",{get:function(){return this._animation},enumerable:!1,configurable:!0}),r.prototype.reset=function(n){if(n===void 0&&(n=!1),n)if(this._target instanceof Array)for(var e=0,t=0,i=this._target;t<i.length;t++){var o=i[t];this._originalValue[e]!==void 0&&this._setValue(o,this._activeTargets[e],this._originalValue[e],-1,e),e++}else this._originalValue[0]!==void 0&&this._setValue(this._target,this._directTarget,this._originalValue[0],-1,0);this._offsetsCache={},this._highLimitsCache={},this._currentFrame=0,this._blendingFactor=0;for(var e=0;e<this._events.length;e++)this._events[e].isDone=!1},r.prototype.isStopped=function(){return this._stopped},r.prototype.dispose=function(){var n=this._animation.runtimeAnimations.indexOf(this);n>-1&&this._animation.runtimeAnimations.splice(n,1)},r.prototype.setValue=function(n,e){if(this._targetIsArray){for(var t=0;t<this._target.length;t++){var i=this._target[t];this._setValue(i,this._activeTargets[t],n,e,t)}return}this._setValue(this._target,this._directTarget,n,e,0)},r.prototype._getOriginalValues=function(n){n===void 0&&(n=0);var e,t=this._activeTargets[n];t.getRestPose&&this._targetPath==="_matrix"?e=t.getRestPose():e=t[this._targetPath],e&&e.clone?this._originalValue[n]=e.clone():this._originalValue[n]=e},r.prototype._setValue=function(n,e,t,i,o){if(this._currentActiveTarget=e,this._weight=i,this._enableBlending&&this._blendingFactor<=1){if(!this._originalBlendValue){var a=e[this._targetPath];a.clone?this._originalBlendValue=a.clone():this._originalBlendValue=a}this._originalBlendValue.m?J.AllowMatrixDecomposeForInterpolation?this._currentValue?Q.DecomposeLerpToRef(this._originalBlendValue,t,this._blendingFactor,this._currentValue):this._currentValue=Q.DecomposeLerp(this._originalBlendValue,t,this._blendingFactor):this._currentValue?Q.LerpToRef(this._originalBlendValue,t,this._blendingFactor,this._currentValue):this._currentValue=Q.Lerp(this._originalBlendValue,t,this._blendingFactor):this._currentValue=J._UniversalLerp(this._originalBlendValue,t,this._blendingFactor);var s=n&&n.animationPropertiesOverride?n.animationPropertiesOverride.blendingSpeed:this._animation.blendingSpeed;this._blendingFactor+=s}else this._currentValue?this._currentValue.copyFrom?this._currentValue.copyFrom(t):this._currentValue=t:t!=null&&t.clone?this._currentValue=t.clone():this._currentValue=t;i!==-1?this._scene._registerTargetForLateAnimationBinding(this,this._originalValue[o]):e[this._targetPath]=this._currentValue,n.markAsDirty&&n.markAsDirty(this._animation.targetProperty)},r.prototype._getCorrectLoopMode=function(){return this._target&&this._target.animationPropertiesOverride?this._target.animationPropertiesOverride.loopMode:this._animation.loopMode},r.prototype.goToFrame=function(n){var e=this._animation.getKeys();n<e[0].frame?n=e[0].frame:n>e[e.length-1].frame&&(n=e[e.length-1].frame);var t=this._events;if(t.length)for(var i=0;i<t.length;i++)t[i].onlyOnce||(t[i].isDone=t[i].frame<n);this._currentFrame=n;var o=this._animation._interpolate(n,this._animationState);this.setValue(o,-1)},r.prototype._prepareForSpeedRatioChange=function(n){var e=this._previousDelay*(this._animation.framePerSecond*n)/1e3;this._ratioOffset=this._previousRatio-e},r.prototype.animate=function(n,e,t,i,o,a){a===void 0&&(a=-1);var s=this._animation,c=s.targetPropertyPath;if(!c||c.length<1)return this._stopped=!0,!1;var l=!0;(e<this._minFrame||e>this._maxFrame)&&(e=this._minFrame),(t<this._minFrame||t>this._maxFrame)&&(t=this._maxFrame);var u=t-e,f,d=n*(s.framePerSecond*o)/1e3+this._ratioOffset,p=0;if(this._previousDelay=n,this._previousRatio=d,!i&&t>=e&&d>=u)l=!1,p=s._getKeyValue(this._maxValue);else if(!i&&e>=t&&d<=u)l=!1,p=s._getKeyValue(this._minValue);else if(this._animationState.loopMode!==J.ANIMATIONLOOPMODE_CYCLE){var m=t.toString()+e.toString();if(!this._offsetsCache[m]){this._animationState.repeatCount=0,this._animationState.loopMode=J.ANIMATIONLOOPMODE_CYCLE;var _=s._interpolate(e,this._animationState),v=s._interpolate(t,this._animationState);switch(this._animationState.loopMode=this._getCorrectLoopMode(),s.dataType){case J.ANIMATIONTYPE_FLOAT:this._offsetsCache[m]=v-_;break;case J.ANIMATIONTYPE_QUATERNION:this._offsetsCache[m]=v.subtract(_);break;case J.ANIMATIONTYPE_VECTOR3:this._offsetsCache[m]=v.subtract(_);break;case J.ANIMATIONTYPE_VECTOR2:this._offsetsCache[m]=v.subtract(_);break;case J.ANIMATIONTYPE_SIZE:this._offsetsCache[m]=v.subtract(_);break;case J.ANIMATIONTYPE_COLOR3:this._offsetsCache[m]=v.subtract(_);break}this._highLimitsCache[m]=v}p=this._highLimitsCache[m],f=this._offsetsCache[m]}if(f===void 0)switch(s.dataType){case J.ANIMATIONTYPE_FLOAT:f=0;break;case J.ANIMATIONTYPE_QUATERNION:f=Jl;break;case J.ANIMATIONTYPE_VECTOR3:f=$l;break;case J.ANIMATIONTYPE_VECTOR2:f=eu;break;case J.ANIMATIONTYPE_SIZE:f=tu;break;case J.ANIMATIONTYPE_COLOR3:f=nu}var b;if(this._host&&this._host.syncRoot){var A=this._host.syncRoot,S=(A.masterFrame-A.fromFrame)/(A.toFrame-A.fromFrame);b=e+(t-e)*S}else d>0&&e>t||d<0&&e<t?b=l&&u!==0?t+d%u:e:b=l&&u!==0?e+d%u:t;var C=this._events;if((o>0&&this.currentFrame>b||o<0&&this.currentFrame<b)&&(this._onLoop(),C.length))for(var O=0;O<C.length;O++)C[O].onlyOnce||(C[O].isDone=!1);this._currentFrame=b,this._animationState.repeatCount=u===0?0:d/u>>0,this._animationState.highLimitValue=p,this._animationState.offsetValue=f;var B=s._interpolate(b,this._animationState);if(this.setValue(B,a),C.length){for(var O=0;O<C.length;O++)if(u>0&&b>=C[O].frame&&C[O].frame>=e||u<0&&b<=C[O].frame&&C[O].frame<=e){var k=C[O];k.isDone||(k.onlyOnce&&(C.splice(O,1),O--),k.isDone=!0,k.action(b))}}return l||(this._stopped=!0),l},r}(),kr=function(){function r(n,e,t,i,o,a,s,c,l,u){t===void 0&&(t=0),i===void 0&&(i=100),o===void 0&&(o=!1),a===void 0&&(a=1),u===void 0&&(u=!1),this.target=e,this.fromFrame=t,this.toFrame=i,this.loopAnimation=o,this.onAnimationEnd=s,this.onAnimationLoop=l,this.isAdditive=u,this._localDelayOffset=null,this._pausedDelay=null,this._manualJumpDelay=null,this._runtimeAnimations=new Array,this._paused=!1,this._speedRatio=1,this._weight=-1,this._syncRoot=null,this._frameToSyncFromJump=0,this.disposeOnEnd=!0,this.animationStarted=!1,this.onAnimationEndObservable=new U,this.onAnimationLoopObservable=new U,this._scene=n,c&&this.appendAnimations(e,c),this._speedRatio=a,n._activeAnimatables.push(this)}return Object.defineProperty(r.prototype,"syncRoot",{get:function(){return this._syncRoot},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"masterFrame",{get:function(){return this._runtimeAnimations.length===0?0:this._runtimeAnimations[0].currentFrame},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"weight",{get:function(){return this._weight},set:function(n){if(n===-1){this._weight=-1;return}this._weight=Math.min(Math.max(n,0),1)},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"speedRatio",{get:function(){return this._speedRatio},set:function(n){for(var e=0;e<this._runtimeAnimations.length;e++){var t=this._runtimeAnimations[e];t._prepareForSpeedRatioChange(n)}this._speedRatio=n},enumerable:!1,configurable:!0}),r.prototype.syncWith=function(n){if(this._syncRoot=n,n){var e=this._scene._activeAnimatables.indexOf(this);e>-1&&(this._scene._activeAnimatables.splice(e,1),this._scene._activeAnimatables.push(this))}return this},r.prototype.getAnimations=function(){return this._runtimeAnimations},r.prototype.appendAnimations=function(n,e){for(var t=this,i=0;i<e.length;i++){var o=e[i],a=new iu(n,o,this._scene,this);a._onLoop=function(){t.onAnimationLoopObservable.notifyObservers(t),t.onAnimationLoop&&t.onAnimationLoop()},this._runtimeAnimations.push(a)}},r.prototype.getAnimationByTargetProperty=function(n){for(var e=this._runtimeAnimations,t=0;t<e.length;t++)if(e[t].animation.targetProperty===n)return e[t].animation;return null},r.prototype.getRuntimeAnimationByTargetProperty=function(n){for(var e=this._runtimeAnimations,t=0;t<e.length;t++)if(e[t].animation.targetProperty===n)return e[t];return null},r.prototype.reset=function(){for(var n=this._runtimeAnimations,e=0;e<n.length;e++)n[e].reset(!0);this._localDelayOffset=null,this._pausedDelay=null},r.prototype.enableBlending=function(n){for(var e=this._runtimeAnimations,t=0;t<e.length;t++)e[t].animation.enableBlending=!0,e[t].animation.blendingSpeed=n},r.prototype.disableBlending=function(){for(var n=this._runtimeAnimations,e=0;e<n.length;e++)n[e].animation.enableBlending=!1},r.prototype.goToFrame=function(n){var e,t=this._runtimeAnimations;if(t[0]){var i=t[0].animation.framePerSecond;this._frameToSyncFromJump=(e=this._frameToSyncFromJump)!==null&&e!==void 0?e:t[0].currentFrame;var o=this.speedRatio===0?0:(n-this._frameToSyncFromJump)/i*1e3/this.speedRatio;this._manualJumpDelay=-o}for(var a=0;a<t.length;a++)t[a].goToFrame(n)},r.prototype.pause=function(){this._paused||(this._paused=!0)},r.prototype.restart=function(){this._paused=!1},r.prototype._raiseOnAnimationEnd=function(){this.onAnimationEnd&&this.onAnimationEnd(),this.onAnimationEndObservable.notifyObservers(this)},r.prototype.stop=function(n,e){if(n||e){var t=this._scene._activeAnimatables.indexOf(this);if(t>-1){for(var i=this._runtimeAnimations,o=i.length-1;o>=0;o--){var a=i[o];n&&a.animation.name!=n||e&&!e(a.target)||(a.dispose(),i.splice(o,1))}i.length==0&&(this._scene._activeAnimatables.splice(t,1),this._raiseOnAnimationEnd())}}else{var o=this._scene._activeAnimatables.indexOf(this);if(o>-1){this._scene._activeAnimatables.splice(o,1);for(var i=this._runtimeAnimations,s=0;s<i.length;s++)i[s].dispose();this._raiseOnAnimationEnd()}}},r.prototype.waitAsync=function(){var n=this;return new Promise(function(e){n.onAnimationEndObservable.add(function(){e(n)},void 0,void 0,n,!0)})},r.prototype._animate=function(n){if(this._paused)return this.animationStarted=!1,this._pausedDelay===null&&(this._pausedDelay=n),!0;if(this._localDelayOffset===null?(this._localDelayOffset=n,this._pausedDelay=null):this._pausedDelay!==null&&(this._localDelayOffset+=n-this._pausedDelay,this._pausedDelay=null),this._manualJumpDelay!==null&&(this._localDelayOffset+=this._manualJumpDelay,this._manualJumpDelay=null,this._frameToSyncFromJump=null),this._weight===0)return!0;var e=!1,t=this._runtimeAnimations,i;for(i=0;i<t.length;i++){var o=t[i],a=o.animate(n-this._localDelayOffset,this.fromFrame,this.toFrame,this.loopAnimation,this._speedRatio,this._weight);e=e||a}if(this.animationStarted=e,!e){if(this.disposeOnEnd)for(i=this._scene._activeAnimatables.indexOf(this),this._scene._activeAnimatables.splice(i,1),i=0;i<t.length;i++)t[i].dispose();this._raiseOnAnimationEnd(),this.disposeOnEnd&&(this.onAnimationEnd=null,this.onAnimationLoop=null,this.onAnimationLoopObservable.clear(),this.onAnimationEndObservable.clear())}return e},r}();Ne.prototype._animate=function(){if(!!this.animationsEnabled){var r=Po.Now;if(!this._animationTimeLast){if(this._pendingData.length>0)return;this._animationTimeLast=r}this.deltaTime=this.useConstantAnimationDeltaTime?16:(r-this._animationTimeLast)*this.animationTimeScale,this._animationTimeLast=r;var n=this._activeAnimatables;if(n.length!==0){this._animationTime+=this.deltaTime;for(var e=this._animationTime,t=0;t<n.length;t++){var i=n[t];!i._animate(e)&&i.disposeOnEnd&&t--}this._processLateAnimationBindings()}}};Ne.prototype.beginWeightedAnimation=function(r,n,e,t,i,o,a,s,c,l,u){t===void 0&&(t=1),o===void 0&&(o=1),u===void 0&&(u=!1);var f=this.beginAnimation(r,n,e,i,o,a,s,!1,c,l,u);return f.weight=t,f};Ne.prototype.beginAnimation=function(r,n,e,t,i,o,a,s,c,l,u){i===void 0&&(i=1),s===void 0&&(s=!0),u===void 0&&(u=!1),n>e&&i>0&&(i*=-1),s&&this.stopAnimation(r,void 0,c),a||(a=new kr(this,r,n,e,t,i,o,void 0,l,u));var f=c?c(r):!0;if(r.animations&&f&&a.appendAnimations(r,r.animations),r.getAnimatables)for(var d=r.getAnimatables(),p=0;p<d.length;p++)this.beginAnimation(d[p],n,e,t,i,o,a,s,c,l);return a.reset(),a};Ne.prototype.beginHierarchyAnimation=function(r,n,e,t,i,o,a,s,c,l,u,f){o===void 0&&(o=1),c===void 0&&(c=!0),f===void 0&&(f=!1);var d=r.getDescendants(n),p=[];p.push(this.beginAnimation(r,e,t,i,o,a,s,c,l,void 0,f));for(var m=0,_=d;m<_.length;m++){var v=_[m];p.push(this.beginAnimation(v,e,t,i,o,a,s,c,l,void 0,f))}return p};Ne.prototype.beginDirectAnimation=function(r,n,e,t,i,o,a,s,c){if(c===void 0&&(c=!1),o===void 0&&(o=1),e>t&&o>0)o*=-1;else if(t>e&&o<0){var l=t;t=e,e=l}var u=new kr(this,r,e,t,i,o,a,n,s,c);return u};Ne.prototype.beginDirectHierarchyAnimation=function(r,n,e,t,i,o,a,s,c,l){l===void 0&&(l=!1);var u=r.getDescendants(n),f=[];f.push(this.beginDirectAnimation(r,e,t,i,o,a,s,c,l));for(var d=0,p=u;d<p.length;d++){var m=p[d];f.push(this.beginDirectAnimation(m,e,t,i,o,a,s,c,l))}return f};Ne.prototype.getAnimatableByTarget=function(r){for(var n=0;n<this._activeAnimatables.length;n++)if(this._activeAnimatables[n].target===r)return this._activeAnimatables[n];return null};Ne.prototype.getAllAnimatablesByTarget=function(r){for(var n=[],e=0;e<this._activeAnimatables.length;e++)this._activeAnimatables[e].target===r&&n.push(this._activeAnimatables[e]);return n};Ne.prototype.stopAnimation=function(r,n,e){for(var t=this.getAllAnimatablesByTarget(r),i=0,o=t;i<o.length;i++){var a=o[i];a.stop(n,e)}};Ne.prototype.stopAllAnimations=function(){if(this._activeAnimatables){for(var r=0;r<this._activeAnimatables.length;r++)this._activeAnimatables[r].stop();this._activeAnimatables=[]}for(var n=0,e=this.animationGroups;n<e.length;n++){var t=e[n];t.stop()}};Ne.prototype._registerTargetForLateAnimationBinding=function(r,n){var e=r.target;this._registeredForLateAnimationBindings.pushNoDuplicate(e),e._lateAnimationHolders||(e._lateAnimationHolders={}),e._lateAnimationHolders[r.targetPath]||(e._lateAnimationHolders[r.targetPath]={totalWeight:0,totalAdditiveWeight:0,animations:[],additiveAnimations:[],originalValue:n}),r.isAdditive?(e._lateAnimationHolders[r.targetPath].additiveAnimations.push(r),e._lateAnimationHolders[r.targetPath].totalAdditiveWeight+=r.weight):(e._lateAnimationHolders[r.targetPath].animations.push(r),e._lateAnimationHolders[r.targetPath].totalWeight+=r.weight)};Ne.prototype._processLateAnimationBindingsForMatrices=function(r){if(r.totalWeight===0&&r.totalAdditiveWeight===0)return r.originalValue;var n=1,e=H.Vector3[0],t=H.Vector3[1],i=H.Quaternion[0],o=0,a=r.animations[0],s=r.originalValue,c=1,l=!1;if(r.totalWeight<1)c=1-r.totalWeight,s.decompose(t,i,e);else{if(o=1,n=r.totalWeight,c=a.weight/n,c==1)if(r.totalAdditiveWeight)l=!0;else return a.currentValue;a.currentValue.decompose(t,i,e)}if(!l){t.scaleInPlace(c),e.scaleInPlace(c),i.scaleInPlace(c);for(var u=o;u<r.animations.length;u++){var f=r.animations[u];if(f.weight!==0){c=f.weight/n;var d=H.Vector3[2],p=H.Vector3[3],m=H.Quaternion[1];f.currentValue.decompose(p,m,d),p.scaleAndAddToRef(c,t),m.scaleAndAddToRef(c,i),d.scaleAndAddToRef(c,e)}}}for(var u=0;u<r.additiveAnimations.length;u++){var f=r.additiveAnimations[u];if(f.weight!==0){var d=H.Vector3[2],p=H.Vector3[3],m=H.Quaternion[1];f.currentValue.decompose(p,m,d),p.multiplyToRef(t,p),y.LerpToRef(t,p,f.weight,t),i.multiplyToRef(m,m),q.SlerpToRef(i,m,f.weight,i),d.scaleAndAddToRef(f.weight,e)}}var _=a?a._animationState.workValue:H.Matrix[0].clone();return Q.ComposeToRef(t,i,e,_),_};Ne.prototype._processLateAnimationBindingsForQuaternions=function(r,n){if(r.totalWeight===0&&r.totalAdditiveWeight===0)return n;var e=r.animations[0],t=r.originalValue,i=n;if(r.totalWeight===0&&r.totalAdditiveWeight>0)i.copyFrom(t);else if(r.animations.length===1){if(q.SlerpToRef(t,e.currentValue,Math.min(1,r.totalWeight),i),r.totalAdditiveWeight===0)return i}else if(r.animations.length>1){var o=1,a=void 0,s=void 0;if(r.totalWeight<1){var c=1-r.totalWeight;a=[],s=[],a.push(t),s.push(c)}else{if(r.animations.length===2&&(q.SlerpToRef(r.animations[0].currentValue,r.animations[1].currentValue,r.animations[1].weight/r.totalWeight,n),r.totalAdditiveWeight===0))return n;a=[],s=[],o=r.totalWeight}for(var l=0;l<r.animations.length;l++){var u=r.animations[l];a.push(u.currentValue),s.push(u.weight/o)}for(var f=0,d=0;d<a.length;){if(!d){q.SlerpToRef(a[d],a[d+1],s[d+1]/(s[d]+s[d+1]),n),i=n,f=s[d]+s[d+1],d+=2;continue}f+=s[d],q.SlerpToRef(i,a[d],s[d]/f,i),d++}}for(var l=0;l<r.additiveAnimations.length;l++){var u=r.additiveAnimations[l];u.weight!==0&&(i.multiplyToRef(u.currentValue,H.Quaternion[0]),q.SlerpToRef(i,H.Quaternion[0],u.weight,i))}return i};Ne.prototype._processLateAnimationBindings=function(){if(!!this._registeredForLateAnimationBindings.length){for(var r=0;r<this._registeredForLateAnimationBindings.length;r++){var n=this._registeredForLateAnimationBindings.data[r];for(var e in n._lateAnimationHolders){var t=n._lateAnimationHolders[e],i=t.animations[0],o=t.originalValue,a=J.AllowMatrixDecomposeForInterpolation&&o.m,s=n[e];if(a)s=this._processLateAnimationBindingsForMatrices(t);else{var c=o.w!==void 0;if(c)s=this._processLateAnimationBindingsForQuaternions(t,s||q.Identity());else{var l=0,u=1;if(t.totalWeight<1)i&&o.scale?s=o.scale(1-t.totalWeight):i?s=o*(1-t.totalWeight):o.clone?s=o.clone():s=o;else if(i){u=t.totalWeight;var f=i.weight/u;f!==1?i.currentValue.scale?s=i.currentValue.scale(f):s=i.currentValue*f:s=i.currentValue,l=1}for(var d=l;d<t.animations.length;d++){var p=t.animations[d],f=p.weight/u;if(f)p.currentValue.scaleAndAddToRef?p.currentValue.scaleAndAddToRef(f,s):s+=p.currentValue*f;else continue}for(var d=0;d<t.additiveAnimations.length;d++){var p=t.additiveAnimations[d],f=p.weight;if(f)p.currentValue.scaleAndAddToRef?p.currentValue.scaleAndAddToRef(f,s):s+=p.currentValue*f;else continue}}}n[e]=s}n._lateAnimationHolders={}}this._registeredForLateAnimationBindings.reset()}};Pt.prototype.copyAnimationRange=function(r,n,e,t,i){t===void 0&&(t=!1),i===void 0&&(i=null),this.animations.length===0&&(this.animations.push(new J(this.name,"_matrix",r.animations[0].framePerSecond,J.ANIMATIONTYPE_MATRIX,0)),this.animations[0].setKeys([]));var o=r.animations[0].getRange(n);if(!o)return!1;for(var a=o.from,s=o.to,c=r.animations[0].getKeys(),l=r.length,u=r.getParent(),f=this.getParent(),d=t&&u&&l&&this.length&&l!==this.length,p=d&&f&&u?f.length/u.length:1,m=t&&!f&&i&&(i.x!==1||i.y!==1||i.z!==1),_=this.animations[0].getKeys(),v,b,A,S=0,C=c.length;S<C;S++)v=c[S],v.frame>=a&&v.frame<=s&&(t?(A=v.value.clone(),d?(b=A.getTranslation(),A.setTranslation(b.scaleInPlace(p))):m&&i?(b=A.getTranslation(),A.setTranslation(b.multiplyInPlace(i))):A=v.value):A=v.value,_.push({frame:v.frame+e,value:A}));return this.animations[0].createRange(n,a+e,s+e),!0};class ru extends xo{constructor(n,e){super(n,e)}init(){super.init(),la.CreateAsync(this.scene,{optionalFeatures:!0,floorMeshes:[this.envHelper.ground]})}}const ou=document.getElementById("renderCanvas"),mi=new ru(ou,window);mi.init();let Nn=!1;const an=document.getElementById("playBtn");function Gr(){Nn?(mi.pause(),an.innerText="PLAY"):(mi.play(),an.innerText="PAUSE"),Nn=!Nn}an.addEventListener("click",()=>{Gr()});document.addEventListener("keydown",r=>{r.target!==an&&r.code==="Space"&&Gr()});
