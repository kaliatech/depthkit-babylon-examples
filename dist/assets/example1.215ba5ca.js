var so=Object.defineProperty;var oo=(i,e,t)=>e in i?so(i,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):i[e]=t;var ft=(i,e,t)=>(oo(i,typeof e!="symbol"?e+"":e,t),t);async function lo(i){let e;return typeof i=="string"?e=await uo(i):e=i,fo(e),e}async function uo(i){const e=await fetch(i);if(!e.ok)throw new Error("Error loading props from URL. Status: "+e.status);return await e.json()}function fo(i){(i.textureWidth==null||i.textureHeight==null)&&(i.textureWidth=i.depthImageSize.x,i.textureHeight=i.depthImageSize.y*2),i.extrinsics==null&&(i.extrinsics={e00:1,e01:0,e02:0,e03:0,e10:0,e11:1,e12:0,e13:0,e20:0,e21:0,e22:1,e23:0,e30:0,e31:0,e32:0,e33:1}),i.crop==null&&(i.crop={x:0,y:0,z:1,w:1})}var K=function(){function i(){}return i.WithinEpsilon=function(e,t,r){return r===void 0&&(r=1401298e-51),Math.abs(e-t)<=r},i.ToHex=function(e){var t=e.toString(16);return e<=15?("0"+t).toUpperCase():t.toUpperCase()},i.Sign=function(e){return e=+e,e===0||isNaN(e)?e:e>0?1:-1},i.Clamp=function(e,t,r){return t===void 0&&(t=0),r===void 0&&(r=1),Math.min(r,Math.max(t,e))},i.Log2=function(e){return Math.log(e)*Math.LOG2E},i.ILog2=function(e){if(Math.log2)return Math.floor(Math.log2(e));if(e<0)return NaN;if(e===0)return-1/0;var t=0;if(e<1){for(;e<1;)t++,e=e*2;t=-t}else if(e>1)for(;e>1;)t++,e=Math.floor(e/2);return t},i.Repeat=function(e,t){return e-Math.floor(e/t)*t},i.Normalize=function(e,t,r){return(e-t)/(r-t)},i.Denormalize=function(e,t,r){return e*(r-t)+t},i.DeltaAngle=function(e,t){var r=i.Repeat(t-e,360);return r>180&&(r-=360),r},i.PingPong=function(e,t){var r=i.Repeat(e,t*2);return t-Math.abs(r-t)},i.SmoothStep=function(e,t,r){var n=i.Clamp(r);return n=-2*n*n*n+3*n*n,t*n+e*(1-n)},i.MoveTowards=function(e,t,r){var n=0;return Math.abs(t-e)<=r?n=t:n=e+i.Sign(t-e)*r,n},i.MoveTowardsAngle=function(e,t,r){var n=i.DeltaAngle(e,t),a=0;return-r<n&&n<r?a=t:(t=e+n,a=i.MoveTowards(e,t,r)),a},i.Lerp=function(e,t,r){return e+(t-e)*r},i.LerpAngle=function(e,t,r){var n=i.Repeat(t-e,360);return n>180&&(n-=360),e+n*i.Clamp(r)},i.InverseLerp=function(e,t,r){var n=0;return e!=t?n=i.Clamp((r-e)/(t-e)):n=0,n},i.Hermite=function(e,t,r,n,a){var s=a*a,o=a*s,l=2*o-3*s+1,u=-2*o+3*s,f=o-2*s+a,h=o-s;return e*l+r*u+t*f+n*h},i.Hermite1stDerivative=function(e,t,r,n,a){var s=a*a;return(s-a)*6*e+(3*s-4*a+1)*t+(-s+a)*6*r+(3*s-2*a)*n},i.RandomRange=function(e,t){return e===t?e:Math.random()*(t-e)+e},i.RangeToPercent=function(e,t,r){return(e-t)/(r-t)},i.PercentToRange=function(e,t,r){return(r-t)*e+t},i.NormalizeRadians=function(e){return e-=i.TwoPi*Math.floor((e+Math.PI)/i.TwoPi),e},i.HCF=function(e,t){var r=e%t;return r===0?t:i.HCF(t,r)},i.TwoPi=Math.PI*2,i}(),Lt=1/2.2,Nt=2.2,ke=(1+Math.sqrt(5))/2,Me=.001,je=function(){function i(){}return i.BuildArray=function(e,t){for(var r=[],n=0;n<e;++n)r.push(t());return r},i.BuildTuple=function(e,t){return i.BuildArray(e,t)},i}(),Ra={};function We(i,e){Ra[i]=e}function lt(i){return Ra[i]}var tr=function(){function i(){}return i.SetMatrixPrecision=function(e){if(i.MatrixTrackPrecisionChange=!1,e&&!i.MatrixUse64Bits&&i.MatrixTrackedMatrices)for(var t=0;t<i.MatrixTrackedMatrices.length;++t){var r=i.MatrixTrackedMatrices[t],n=r._m;r._m=new Array(16);for(var a=0;a<16;++a)r._m[a]=n[a]}i.MatrixUse64Bits=e,i.MatrixCurrentType=i.MatrixUse64Bits?Array:Float32Array,i.MatrixTrackedMatrices=null},i.MatrixUse64Bits=!1,i.MatrixTrackPrecisionChange=!0,i.MatrixCurrentType=Float32Array,i.MatrixTrackedMatrices=[],i}(),ye=function(){function i(){}return Object.defineProperty(i,"LastCreatedEngine",{get:function(){return this.Instances.length===0?null:this.Instances[this.Instances.length-1]},enumerable:!1,configurable:!0}),Object.defineProperty(i,"LastCreatedScene",{get:function(){return this._LastCreatedScene},enumerable:!1,configurable:!0}),i.Instances=new Array,i._LastCreatedScene=null,i.UseFallbackTexture=!0,i.FallbackTexture="",i}(),it=function(i){return parseInt(i.toString().replace(/\W/g,""))},se=function(){function i(e,t){e===void 0&&(e=0),t===void 0&&(t=0),this.x=e,this.y=t}return i.prototype.toString=function(){return"{X: ".concat(this.x," Y: ").concat(this.y,"}")},i.prototype.getClassName=function(){return"Vector2"},i.prototype.getHashCode=function(){var e=it(this.x),t=it(this.y),r=e;return r=r*397^t,r},i.prototype.toArray=function(e,t){return t===void 0&&(t=0),e[t]=this.x,e[t+1]=this.y,this},i.prototype.fromArray=function(e,t){return t===void 0&&(t=0),i.FromArrayToRef(e,t,this),this},i.prototype.asArray=function(){var e=new Array;return this.toArray(e,0),e},i.prototype.copyFrom=function(e){return this.x=e.x,this.y=e.y,this},i.prototype.copyFromFloats=function(e,t){return this.x=e,this.y=t,this},i.prototype.set=function(e,t){return this.copyFromFloats(e,t)},i.prototype.add=function(e){return new i(this.x+e.x,this.y+e.y)},i.prototype.addToRef=function(e,t){return t.x=this.x+e.x,t.y=this.y+e.y,this},i.prototype.addInPlace=function(e){return this.x+=e.x,this.y+=e.y,this},i.prototype.addVector3=function(e){return new i(this.x+e.x,this.y+e.y)},i.prototype.subtract=function(e){return new i(this.x-e.x,this.y-e.y)},i.prototype.subtractToRef=function(e,t){return t.x=this.x-e.x,t.y=this.y-e.y,this},i.prototype.subtractInPlace=function(e){return this.x-=e.x,this.y-=e.y,this},i.prototype.multiplyInPlace=function(e){return this.x*=e.x,this.y*=e.y,this},i.prototype.multiply=function(e){return new i(this.x*e.x,this.y*e.y)},i.prototype.multiplyToRef=function(e,t){return t.x=this.x*e.x,t.y=this.y*e.y,this},i.prototype.multiplyByFloats=function(e,t){return new i(this.x*e,this.y*t)},i.prototype.divide=function(e){return new i(this.x/e.x,this.y/e.y)},i.prototype.divideToRef=function(e,t){return t.x=this.x/e.x,t.y=this.y/e.y,this},i.prototype.divideInPlace=function(e){return this.divideToRef(e,this)},i.prototype.negate=function(){return new i(-this.x,-this.y)},i.prototype.negateInPlace=function(){return this.x*=-1,this.y*=-1,this},i.prototype.negateToRef=function(e){return e.copyFromFloats(this.x*-1,this.y*-1)},i.prototype.scaleInPlace=function(e){return this.x*=e,this.y*=e,this},i.prototype.scale=function(e){var t=new i(0,0);return this.scaleToRef(e,t),t},i.prototype.scaleToRef=function(e,t){return t.x=this.x*e,t.y=this.y*e,this},i.prototype.scaleAndAddToRef=function(e,t){return t.x+=this.x*e,t.y+=this.y*e,this},i.prototype.equals=function(e){return e&&this.x===e.x&&this.y===e.y},i.prototype.equalsWithEpsilon=function(e,t){return t===void 0&&(t=Me),e&&K.WithinEpsilon(this.x,e.x,t)&&K.WithinEpsilon(this.y,e.y,t)},i.prototype.floor=function(){return new i(Math.floor(this.x),Math.floor(this.y))},i.prototype.fract=function(){return new i(this.x-Math.floor(this.x),this.y-Math.floor(this.y))},i.prototype.rotateToRef=function(e,t){var r=Math.cos(e),n=Math.sin(e);return t.x=r*this.x-n*this.y,t.y=n*this.x+r*this.y,this},i.prototype.length=function(){return Math.sqrt(this.x*this.x+this.y*this.y)},i.prototype.lengthSquared=function(){return this.x*this.x+this.y*this.y},i.prototype.normalize=function(){return i.NormalizeToRef(this,this),this},i.prototype.clone=function(){return new i(this.x,this.y)},i.Zero=function(){return new i(0,0)},i.One=function(){return new i(1,1)},i.FromArray=function(e,t){return t===void 0&&(t=0),new i(e[t],e[t+1])},i.FromArrayToRef=function(e,t,r){r.x=e[t],r.y=e[t+1]},i.CatmullRom=function(e,t,r,n,a){var s=a*a,o=a*s,l=.5*(2*t.x+(-e.x+r.x)*a+(2*e.x-5*t.x+4*r.x-n.x)*s+(-e.x+3*t.x-3*r.x+n.x)*o),u=.5*(2*t.y+(-e.y+r.y)*a+(2*e.y-5*t.y+4*r.y-n.y)*s+(-e.y+3*t.y-3*r.y+n.y)*o);return new i(l,u)},i.Clamp=function(e,t,r){var n=e.x;n=n>r.x?r.x:n,n=n<t.x?t.x:n;var a=e.y;return a=a>r.y?r.y:a,a=a<t.y?t.y:a,new i(n,a)},i.Hermite=function(e,t,r,n,a){var s=a*a,o=a*s,l=2*o-3*s+1,u=-2*o+3*s,f=o-2*s+a,h=o-s,c=e.x*l+r.x*u+t.x*f+n.x*h,d=e.y*l+r.y*u+t.y*f+n.y*h;return new i(c,d)},i.Hermite1stDerivative=function(e,t,r,n,a){var s=i.Zero();return this.Hermite1stDerivativeToRef(e,t,r,n,a,s),s},i.Hermite1stDerivativeToRef=function(e,t,r,n,a,s){var o=a*a;s.x=(o-a)*6*e.x+(3*o-4*a+1)*t.x+(-o+a)*6*r.x+(3*o-2*a)*n.x,s.y=(o-a)*6*e.y+(3*o-4*a+1)*t.y+(-o+a)*6*r.y+(3*o-2*a)*n.y},i.Lerp=function(e,t,r){var n=e.x+(t.x-e.x)*r,a=e.y+(t.y-e.y)*r;return new i(n,a)},i.Dot=function(e,t){return e.x*t.x+e.y*t.y},i.Normalize=function(e){var t=i.Zero();return this.NormalizeToRef(e,t),t},i.NormalizeToRef=function(e,t){var r=e.length();r!==0&&(t.x=e.x/r,t.y=e.y/r)},i.Minimize=function(e,t){var r=e.x<t.x?e.x:t.x,n=e.y<t.y?e.y:t.y;return new i(r,n)},i.Maximize=function(e,t){var r=e.x>t.x?e.x:t.x,n=e.y>t.y?e.y:t.y;return new i(r,n)},i.Transform=function(e,t){var r=i.Zero();return i.TransformToRef(e,t,r),r},i.TransformToRef=function(e,t,r){var n=t.m,a=e.x*n[0]+e.y*n[4]+n[12],s=e.x*n[1]+e.y*n[5]+n[13];r.x=a,r.y=s},i.PointInTriangle=function(e,t,r,n){var a=.5*(-r.y*n.x+t.y*(-r.x+n.x)+t.x*(r.y-n.y)+r.x*n.y),s=a<0?-1:1,o=(t.y*n.x-t.x*n.y+(n.y-t.y)*e.x+(t.x-n.x)*e.y)*s,l=(t.x*r.y-t.y*r.x+(t.y-r.y)*e.x+(r.x-t.x)*e.y)*s;return o>0&&l>0&&o+l<2*a*s},i.Distance=function(e,t){return Math.sqrt(i.DistanceSquared(e,t))},i.DistanceSquared=function(e,t){var r=e.x-t.x,n=e.y-t.y;return r*r+n*n},i.Center=function(e,t){return i.CenterToRef(e,t,i.Zero())},i.CenterToRef=function(e,t,r){return r.copyFromFloats((e.x+t.x)/2,(e.y+t.y)/2)},i.DistanceOfPointFromSegment=function(e,t,r){var n=i.DistanceSquared(t,r);if(n===0)return i.Distance(e,t);var a=r.subtract(t),s=Math.max(0,Math.min(1,i.Dot(e.subtract(t),a)/n)),o=t.add(a.multiplyByFloats(s,s));return i.Distance(e,o)},i}(),m=function(){function i(e,t,r){e===void 0&&(e=0),t===void 0&&(t=0),r===void 0&&(r=0),this._isDirty=!0,this._x=e,this._y=t,this._z=r}return Object.defineProperty(i.prototype,"x",{get:function(){return this._x},set:function(e){this._x=e,this._isDirty=!0},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"y",{get:function(){return this._y},set:function(e){this._y=e,this._isDirty=!0},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"z",{get:function(){return this._z},set:function(e){this._z=e,this._isDirty=!0},enumerable:!1,configurable:!0}),i.prototype.toString=function(){return"{X: ".concat(this._x," Y: ").concat(this._y," Z: ").concat(this._z,"}")},i.prototype.getClassName=function(){return"Vector3"},i.prototype.getHashCode=function(){var e=it(this._x),t=it(this._y),r=it(this._z),n=e;return n=n*397^t,n=n*397^r,n},i.prototype.asArray=function(){var e=[];return this.toArray(e,0),e},i.prototype.toArray=function(e,t){return t===void 0&&(t=0),e[t]=this._x,e[t+1]=this._y,e[t+2]=this._z,this},i.prototype.fromArray=function(e,t){return t===void 0&&(t=0),i.FromArrayToRef(e,t,this),this},i.prototype.toQuaternion=function(){return de.RotationYawPitchRoll(this._y,this._x,this._z)},i.prototype.addInPlace=function(e){return this.addInPlaceFromFloats(e._x,e._y,e._z)},i.prototype.addInPlaceFromFloats=function(e,t,r){return this.x+=e,this.y+=t,this.z+=r,this},i.prototype.add=function(e){return new i(this._x+e._x,this._y+e._y,this._z+e._z)},i.prototype.addToRef=function(e,t){return t.copyFromFloats(this._x+e._x,this._y+e._y,this._z+e._z)},i.prototype.subtractInPlace=function(e){return this.x-=e._x,this.y-=e._y,this.z-=e._z,this},i.prototype.subtract=function(e){return new i(this._x-e._x,this._y-e._y,this._z-e._z)},i.prototype.subtractToRef=function(e,t){return this.subtractFromFloatsToRef(e._x,e._y,e._z,t)},i.prototype.subtractFromFloats=function(e,t,r){return new i(this._x-e,this._y-t,this._z-r)},i.prototype.subtractFromFloatsToRef=function(e,t,r,n){return n.copyFromFloats(this._x-e,this._y-t,this._z-r)},i.prototype.negate=function(){return new i(-this._x,-this._y,-this._z)},i.prototype.negateInPlace=function(){return this.x*=-1,this.y*=-1,this.z*=-1,this},i.prototype.negateToRef=function(e){return e.copyFromFloats(this._x*-1,this._y*-1,this._z*-1)},i.prototype.scaleInPlace=function(e){return this.x*=e,this.y*=e,this.z*=e,this},i.prototype.scale=function(e){return new i(this._x*e,this._y*e,this._z*e)},i.prototype.scaleToRef=function(e,t){return t.copyFromFloats(this._x*e,this._y*e,this._z*e)},i.prototype.scaleAndAddToRef=function(e,t){return t.addInPlaceFromFloats(this._x*e,this._y*e,this._z*e)},i.prototype.projectOnPlane=function(e,t){var r=i.Zero();return this.projectOnPlaneToRef(e,t,r),r},i.prototype.projectOnPlaneToRef=function(e,t,r){var n=e.normal,a=e.d,s=ae.Vector3[0];this.subtractToRef(t,s),s.normalize();var o=i.Dot(s,n),l=-(i.Dot(t,n)+a)/o,u=s.scaleInPlace(l);t.addToRef(u,r)},i.prototype.equals=function(e){return e&&this._x===e._x&&this._y===e._y&&this._z===e._z},i.prototype.equalsWithEpsilon=function(e,t){return t===void 0&&(t=Me),e&&K.WithinEpsilon(this._x,e._x,t)&&K.WithinEpsilon(this._y,e._y,t)&&K.WithinEpsilon(this._z,e._z,t)},i.prototype.equalsToFloats=function(e,t,r){return this._x===e&&this._y===t&&this._z===r},i.prototype.multiplyInPlace=function(e){return this.x*=e._x,this.y*=e._y,this.z*=e._z,this},i.prototype.multiply=function(e){return this.multiplyByFloats(e._x,e._y,e._z)},i.prototype.multiplyToRef=function(e,t){return t.copyFromFloats(this._x*e._x,this._y*e._y,this._z*e._z)},i.prototype.multiplyByFloats=function(e,t,r){return new i(this._x*e,this._y*t,this._z*r)},i.prototype.divide=function(e){return new i(this._x/e._x,this._y/e._y,this._z/e._z)},i.prototype.divideToRef=function(e,t){return t.copyFromFloats(this._x/e._x,this._y/e._y,this._z/e._z)},i.prototype.divideInPlace=function(e){return this.divideToRef(e,this)},i.prototype.minimizeInPlace=function(e){return this.minimizeInPlaceFromFloats(e._x,e._y,e._z)},i.prototype.maximizeInPlace=function(e){return this.maximizeInPlaceFromFloats(e._x,e._y,e._z)},i.prototype.minimizeInPlaceFromFloats=function(e,t,r){return e<this._x&&(this.x=e),t<this._y&&(this.y=t),r<this._z&&(this.z=r),this},i.prototype.maximizeInPlaceFromFloats=function(e,t,r){return e>this._x&&(this.x=e),t>this._y&&(this.y=t),r>this._z&&(this.z=r),this},i.prototype.isNonUniformWithinEpsilon=function(e){var t=Math.abs(this._x),r=Math.abs(this._y);if(!K.WithinEpsilon(t,r,e))return!0;var n=Math.abs(this._z);return!K.WithinEpsilon(t,n,e)||!K.WithinEpsilon(r,n,e)},Object.defineProperty(i.prototype,"isNonUniform",{get:function(){var e=Math.abs(this._x),t=Math.abs(this._y);if(e!==t)return!0;var r=Math.abs(this._z);return e!==r},enumerable:!1,configurable:!0}),i.prototype.floor=function(){return new i(Math.floor(this._x),Math.floor(this._y),Math.floor(this._z))},i.prototype.fract=function(){return new i(this._x-Math.floor(this._x),this._y-Math.floor(this._y),this._z-Math.floor(this._z))},i.prototype.length=function(){return Math.sqrt(this._x*this._x+this._y*this._y+this._z*this._z)},i.prototype.lengthSquared=function(){return this._x*this._x+this._y*this._y+this._z*this._z},i.prototype.normalize=function(){return this.normalizeFromLength(this.length())},i.prototype.reorderInPlace=function(e){var t=this;return e=e.toLowerCase(),e==="xyz"?this:(ae.Vector3[0].copyFrom(this),["x","y","z"].forEach(function(r,n){t[r]=ae.Vector3[0][e[n]]}),this)},i.prototype.rotateByQuaternionToRef=function(e,t){return e.toRotationMatrix(ae.Matrix[0]),i.TransformCoordinatesToRef(this,ae.Matrix[0],t),t},i.prototype.rotateByQuaternionAroundPointToRef=function(e,t,r){return this.subtractToRef(t,ae.Vector3[0]),ae.Vector3[0].rotateByQuaternionToRef(e,ae.Vector3[0]),t.addToRef(ae.Vector3[0],r),r},i.prototype.cross=function(e){return i.Cross(this,e)},i.prototype.normalizeFromLength=function(e){return e===0||e===1?this:this.scaleInPlace(1/e)},i.prototype.normalizeToNew=function(){var e=new i(0,0,0);return this.normalizeToRef(e),e},i.prototype.normalizeToRef=function(e){var t=this.length();return t===0||t===1?e.copyFromFloats(this._x,this._y,this._z):this.scaleToRef(1/t,e)},i.prototype.clone=function(){return new i(this._x,this._y,this._z)},i.prototype.copyFrom=function(e){return this.copyFromFloats(e._x,e._y,e._z)},i.prototype.copyFromFloats=function(e,t,r){return this.x=e,this.y=t,this.z=r,this},i.prototype.set=function(e,t,r){return this.copyFromFloats(e,t,r)},i.prototype.setAll=function(e){return this.x=this.y=this.z=e,this},i.GetClipFactor=function(e,t,r,n){var a=i.Dot(e,r)-n,s=i.Dot(t,r)-n,o=a/(a-s);return o},i.GetAngleBetweenVectors=function(e,t,r){var n=e.normalizeToRef(ae.Vector3[1]),a=t.normalizeToRef(ae.Vector3[2]),s=i.Dot(n,a),o=Math.acos(s),l=ae.Vector3[3];return i.CrossToRef(n,a,l),i.Dot(l,r)>0?isNaN(o)?0:o:isNaN(o)?-Math.PI:-Math.acos(s)},i.GetAngleBetweenVectorsOnPlane=function(e,t,r){ae.Vector3[0].copyFrom(e);var n=ae.Vector3[0];ae.Vector3[1].copyFrom(t);var a=ae.Vector3[1];ae.Vector3[2].copyFrom(r);var s=ae.Vector3[2],o=ae.Vector3[3],l=ae.Vector3[4];n.normalize(),a.normalize(),s.normalize(),i.CrossToRef(s,n,o),i.CrossToRef(o,s,l);var u=Math.atan2(i.Dot(a,o),i.Dot(a,l));return K.NormalizeRadians(u)},i.SlerpToRef=function(e,t,r,n){r=K.Clamp(r,0,1);var a=ae.Vector3[0],s=ae.Vector3[1];a.copyFrom(e);var o=a.length();a.normalizeFromLength(o),s.copyFrom(t);var l=s.length();s.normalizeFromLength(l);var u=i.Dot(a,s),f,h;if(u<1-Me){var c=Math.acos(u),d=1/Math.sin(c);f=Math.sin((1-r)*c)*d,h=Math.sin(r*c)*d}else f=1-r,h=r;a.scaleInPlace(f),s.scaleInPlace(h),n.copyFrom(a).addInPlace(s),n.scaleInPlace(K.Lerp(o,l,r))},i.SmoothToRef=function(e,t,r,n,a){i.SlerpToRef(e,t,n===0?1:r/n,a)},i.FromArray=function(e,t){return t===void 0&&(t=0),new i(e[t],e[t+1],e[t+2])},i.FromFloatArray=function(e,t){return i.FromArray(e,t)},i.FromArrayToRef=function(e,t,r){r.x=e[t],r.y=e[t+1],r.z=e[t+2]},i.FromFloatArrayToRef=function(e,t,r){return i.FromArrayToRef(e,t,r)},i.FromFloatsToRef=function(e,t,r,n){n.copyFromFloats(e,t,r)},i.Zero=function(){return new i(0,0,0)},i.One=function(){return new i(1,1,1)},i.Up=function(){return new i(0,1,0)},Object.defineProperty(i,"UpReadOnly",{get:function(){return i._UpReadOnly},enumerable:!1,configurable:!0}),Object.defineProperty(i,"RightReadOnly",{get:function(){return i._RightReadOnly},enumerable:!1,configurable:!0}),Object.defineProperty(i,"LeftReadOnly",{get:function(){return i._LeftReadOnly},enumerable:!1,configurable:!0}),Object.defineProperty(i,"LeftHandedForwardReadOnly",{get:function(){return i._LeftHandedForwardReadOnly},enumerable:!1,configurable:!0}),Object.defineProperty(i,"RightHandedForwardReadOnly",{get:function(){return i._RightHandedForwardReadOnly},enumerable:!1,configurable:!0}),Object.defineProperty(i,"ZeroReadOnly",{get:function(){return i._ZeroReadOnly},enumerable:!1,configurable:!0}),i.Down=function(){return new i(0,-1,0)},i.Forward=function(e){return e===void 0&&(e=!1),new i(0,0,e?-1:1)},i.Backward=function(e){return e===void 0&&(e=!1),new i(0,0,e?1:-1)},i.Right=function(){return new i(1,0,0)},i.Left=function(){return new i(-1,0,0)},i.TransformCoordinates=function(e,t){var r=i.Zero();return i.TransformCoordinatesToRef(e,t,r),r},i.TransformCoordinatesToRef=function(e,t,r){i.TransformCoordinatesFromFloatsToRef(e._x,e._y,e._z,t,r)},i.TransformCoordinatesFromFloatsToRef=function(e,t,r,n,a){var s=n.m,o=e*s[0]+t*s[4]+r*s[8]+s[12],l=e*s[1]+t*s[5]+r*s[9]+s[13],u=e*s[2]+t*s[6]+r*s[10]+s[14],f=1/(e*s[3]+t*s[7]+r*s[11]+s[15]);a.x=o*f,a.y=l*f,a.z=u*f},i.TransformNormal=function(e,t){var r=i.Zero();return i.TransformNormalToRef(e,t,r),r},i.TransformNormalToRef=function(e,t,r){this.TransformNormalFromFloatsToRef(e._x,e._y,e._z,t,r)},i.TransformNormalFromFloatsToRef=function(e,t,r,n,a){var s=n.m;a.x=e*s[0]+t*s[4]+r*s[8],a.y=e*s[1]+t*s[5]+r*s[9],a.z=e*s[2]+t*s[6]+r*s[10]},i.CatmullRom=function(e,t,r,n,a){var s=a*a,o=a*s,l=.5*(2*t._x+(-e._x+r._x)*a+(2*e._x-5*t._x+4*r._x-n._x)*s+(-e._x+3*t._x-3*r._x+n._x)*o),u=.5*(2*t._y+(-e._y+r._y)*a+(2*e._y-5*t._y+4*r._y-n._y)*s+(-e._y+3*t._y-3*r._y+n._y)*o),f=.5*(2*t._z+(-e._z+r._z)*a+(2*e._z-5*t._z+4*r._z-n._z)*s+(-e._z+3*t._z-3*r._z+n._z)*o);return new i(l,u,f)},i.Clamp=function(e,t,r){var n=new i;return i.ClampToRef(e,t,r,n),n},i.ClampToRef=function(e,t,r,n){var a=e._x;a=a>r._x?r._x:a,a=a<t._x?t._x:a;var s=e._y;s=s>r._y?r._y:s,s=s<t._y?t._y:s;var o=e._z;o=o>r._z?r._z:o,o=o<t._z?t._z:o,n.copyFromFloats(a,s,o)},i.CheckExtends=function(e,t,r){t.minimizeInPlace(e),r.maximizeInPlace(e)},i.Hermite=function(e,t,r,n,a){var s=a*a,o=a*s,l=2*o-3*s+1,u=-2*o+3*s,f=o-2*s+a,h=o-s,c=e._x*l+r._x*u+t._x*f+n._x*h,d=e._y*l+r._y*u+t._y*f+n._y*h,p=e._z*l+r._z*u+t._z*f+n._z*h;return new i(c,d,p)},i.Hermite1stDerivative=function(e,t,r,n,a){var s=i.Zero();return this.Hermite1stDerivativeToRef(e,t,r,n,a,s),s},i.Hermite1stDerivativeToRef=function(e,t,r,n,a,s){var o=a*a;s.x=(o-a)*6*e.x+(3*o-4*a+1)*t.x+(-o+a)*6*r.x+(3*o-2*a)*n.x,s.y=(o-a)*6*e.y+(3*o-4*a+1)*t.y+(-o+a)*6*r.y+(3*o-2*a)*n.y,s.z=(o-a)*6*e.z+(3*o-4*a+1)*t.z+(-o+a)*6*r.z+(3*o-2*a)*n.z},i.Lerp=function(e,t,r){var n=new i(0,0,0);return i.LerpToRef(e,t,r,n),n},i.LerpToRef=function(e,t,r,n){n.x=e._x+(t._x-e._x)*r,n.y=e._y+(t._y-e._y)*r,n.z=e._z+(t._z-e._z)*r},i.Dot=function(e,t){return e._x*t._x+e._y*t._y+e._z*t._z},i.Cross=function(e,t){var r=i.Zero();return i.CrossToRef(e,t,r),r},i.CrossToRef=function(e,t,r){var n=e._y*t._z-e._z*t._y,a=e._z*t._x-e._x*t._z,s=e._x*t._y-e._y*t._x;r.copyFromFloats(n,a,s)},i.Normalize=function(e){var t=i.Zero();return i.NormalizeToRef(e,t),t},i.NormalizeToRef=function(e,t){e.normalizeToRef(t)},i.Project=function(e,t,r,n){var a=new i;return i.ProjectToRef(e,t,r,n,a),a},i.ProjectToRef=function(e,t,r,n,a){var s=n.width,o=n.height,l=n.x,u=n.y,f=ae.Matrix[1];G.FromValuesToRef(s/2,0,0,0,0,-o/2,0,0,0,0,.5,0,l+s/2,o/2+u,.5,1,f);var h=ae.Matrix[0];return t.multiplyToRef(r,h),h.multiplyToRef(f,h),i.TransformCoordinatesToRef(e,h,a),a},i._UnprojectFromInvertedMatrixToRef=function(e,t,r){i.TransformCoordinatesToRef(e,t,r);var n=t.m,a=e._x*n[3]+e._y*n[7]+e._z*n[11]+n[15];K.WithinEpsilon(a,1)&&r.scaleInPlace(1/a)},i.UnprojectFromTransform=function(e,t,r,n,a){return this.Unproject(e,t,r,n,a,G.IdentityReadOnly)},i.Unproject=function(e,t,r,n,a,s){var o=i.Zero();return i.UnprojectToRef(e,t,r,n,a,s,o),o},i.UnprojectToRef=function(e,t,r,n,a,s,o){i.UnprojectFloatsToRef(e._x,e._y,e._z,t,r,n,a,s,o)},i.UnprojectFloatsToRef=function(e,t,r,n,a,s,o,l,u){var f,h=ae.Matrix[0];s.multiplyToRef(o,h),h.multiplyToRef(l,h),h.invert();var c=ae.Vector3[0];c.x=e/n*2-1,c.y=-(t/a*2-1),!((f=ye.LastCreatedEngine)===null||f===void 0)&&f.isNDCHalfZRange?c.z=r:c.z=2*r-1,i._UnprojectFromInvertedMatrixToRef(c,h,u)},i.Minimize=function(e,t){var r=e.clone();return r.minimizeInPlace(t),r},i.Maximize=function(e,t){var r=e.clone();return r.maximizeInPlace(t),r},i.Distance=function(e,t){return Math.sqrt(i.DistanceSquared(e,t))},i.DistanceSquared=function(e,t){var r=e._x-t._x,n=e._y-t._y,a=e._z-t._z;return r*r+n*n+a*a},i.ProjectOnTriangleToRef=function(e,t,r,n,a){var s=ae.Vector3[0],o=ae.Vector3[1],l=ae.Vector3[2],u=ae.Vector3[3],f=ae.Vector3[4];r.subtractToRef(t,s),n.subtractToRef(t,o),n.subtractToRef(r,l);var h=s.length(),c=o.length(),d=l.length();if(h<Me||c<Me||d<Me)return a.copyFrom(t),i.Distance(e,t);e.subtractToRef(t,f),i.CrossToRef(s,o,u);var p=u.length();if(p<Me)return a.copyFrom(t),i.Distance(e,t);u.normalizeFromLength(p);var _=f.length();if(_<Me)return a.copyFrom(t),0;f.normalizeFromLength(_);var g=i.Dot(u,f),v=ae.Vector3[5],y=ae.Vector3[6];v.copyFrom(u).scaleInPlace(-_*g),y.copyFrom(e).addInPlace(v);var b=ae.Vector3[4],E=ae.Vector3[5],A=ae.Vector3[7],S=ae.Vector3[8];b.copyFrom(s).scaleInPlace(1/h),S.copyFrom(o).scaleInPlace(1/c),b.addInPlace(S).scaleInPlace(-1),E.copyFrom(s).scaleInPlace(-1/h),S.copyFrom(l).scaleInPlace(1/d),E.addInPlace(S).scaleInPlace(-1),A.copyFrom(l).scaleInPlace(-1/d),S.copyFrom(o).scaleInPlace(-1/c),A.addInPlace(S).scaleInPlace(-1);var T=ae.Vector3[9],M;T.copyFrom(y).subtractInPlace(t),i.CrossToRef(b,T,S),M=i.Dot(S,u);var D=M;T.copyFrom(y).subtractInPlace(r),i.CrossToRef(E,T,S),M=i.Dot(S,u);var x=M;T.copyFrom(y).subtractInPlace(n),i.CrossToRef(A,T,S),M=i.Dot(S,u);var P=M,w=ae.Vector3[10],k,B;D>0&&x<0?(w.copyFrom(s),k=t,B=r):x>0&&P<0?(w.copyFrom(l),k=r,B=n):(w.copyFrom(o).scaleInPlace(-1),k=n,B=t);var L=ae.Vector3[9],H=ae.Vector3[4];k.subtractToRef(y,S),B.subtractToRef(y,L),i.CrossToRef(S,L,H);var W=i.Dot(H,u)<0;if(!W)return a.copyFrom(y),Math.abs(_*g);var F=ae.Vector3[5];i.CrossToRef(w,H,F),F.normalize();var V=ae.Vector3[9];V.copyFrom(k).subtractInPlace(y);var z=V.length();if(z<Me)return a.copyFrom(k),i.Distance(e,k);V.normalizeFromLength(z);var N=i.Dot(F,V),Q=ae.Vector3[7];Q.copyFrom(y).addInPlace(F.scaleInPlace(z*N)),S.copyFrom(Q).subtractInPlace(k),_=w.length(),w.normalizeFromLength(_);var Z=i.Dot(S,w)/Math.max(_,Me);return Z=K.Clamp(Z,0,1),Q.copyFrom(k).addInPlace(w.scaleInPlace(Z*_)),a.copyFrom(Q),i.Distance(e,Q)},i.Center=function(e,t){return i.CenterToRef(e,t,i.Zero())},i.CenterToRef=function(e,t,r){return r.copyFromFloats((e._x+t._x)/2,(e._y+t._y)/2,(e._z+t._z)/2)},i.RotationFromAxis=function(e,t,r){var n=i.Zero();return i.RotationFromAxisToRef(e,t,r,n),n},i.RotationFromAxisToRef=function(e,t,r,n){var a=ae.Quaternion[0];de.RotationQuaternionFromAxisToRef(e,t,r,a),a.toEulerAnglesToRef(n)},i._UpReadOnly=i.Up(),i._LeftHandedForwardReadOnly=i.Forward(!1),i._RightHandedForwardReadOnly=i.Forward(!0),i._RightReadOnly=i.Right(),i._LeftReadOnly=i.Left(),i._ZeroReadOnly=i.Zero(),i}(),Ke=function(){function i(e,t,r,n){this.x=e,this.y=t,this.z=r,this.w=n}return i.prototype.toString=function(){return"{X: ".concat(this.x," Y: ").concat(this.y," Z: ").concat(this.z," W: ").concat(this.w,"}")},i.prototype.getClassName=function(){return"Vector4"},i.prototype.getHashCode=function(){var e=it(this.x),t=it(this.y),r=it(this.z),n=it(this.w),a=e;return a=a*397^t,a=a*397^r,a=a*397^n,a},i.prototype.asArray=function(){var e=new Array;return this.toArray(e,0),e},i.prototype.toArray=function(e,t){return t===void 0&&(t=0),e[t]=this.x,e[t+1]=this.y,e[t+2]=this.z,e[t+3]=this.w,this},i.prototype.fromArray=function(e,t){return t===void 0&&(t=0),i.FromArrayToRef(e,t,this),this},i.prototype.addInPlace=function(e){return this.x+=e.x,this.y+=e.y,this.z+=e.z,this.w+=e.w,this},i.prototype.add=function(e){return new i(this.x+e.x,this.y+e.y,this.z+e.z,this.w+e.w)},i.prototype.addToRef=function(e,t){return t.x=this.x+e.x,t.y=this.y+e.y,t.z=this.z+e.z,t.w=this.w+e.w,this},i.prototype.subtractInPlace=function(e){return this.x-=e.x,this.y-=e.y,this.z-=e.z,this.w-=e.w,this},i.prototype.subtract=function(e){return new i(this.x-e.x,this.y-e.y,this.z-e.z,this.w-e.w)},i.prototype.subtractToRef=function(e,t){return t.x=this.x-e.x,t.y=this.y-e.y,t.z=this.z-e.z,t.w=this.w-e.w,this},i.prototype.subtractFromFloats=function(e,t,r,n){return new i(this.x-e,this.y-t,this.z-r,this.w-n)},i.prototype.subtractFromFloatsToRef=function(e,t,r,n,a){return a.x=this.x-e,a.y=this.y-t,a.z=this.z-r,a.w=this.w-n,this},i.prototype.negate=function(){return new i(-this.x,-this.y,-this.z,-this.w)},i.prototype.negateInPlace=function(){return this.x*=-1,this.y*=-1,this.z*=-1,this.w*=-1,this},i.prototype.negateToRef=function(e){return e.copyFromFloats(this.x*-1,this.y*-1,this.z*-1,this.w*-1)},i.prototype.scaleInPlace=function(e){return this.x*=e,this.y*=e,this.z*=e,this.w*=e,this},i.prototype.scale=function(e){return new i(this.x*e,this.y*e,this.z*e,this.w*e)},i.prototype.scaleToRef=function(e,t){return t.x=this.x*e,t.y=this.y*e,t.z=this.z*e,t.w=this.w*e,this},i.prototype.scaleAndAddToRef=function(e,t){return t.x+=this.x*e,t.y+=this.y*e,t.z+=this.z*e,t.w+=this.w*e,this},i.prototype.equals=function(e){return e&&this.x===e.x&&this.y===e.y&&this.z===e.z&&this.w===e.w},i.prototype.equalsWithEpsilon=function(e,t){return t===void 0&&(t=Me),e&&K.WithinEpsilon(this.x,e.x,t)&&K.WithinEpsilon(this.y,e.y,t)&&K.WithinEpsilon(this.z,e.z,t)&&K.WithinEpsilon(this.w,e.w,t)},i.prototype.equalsToFloats=function(e,t,r,n){return this.x===e&&this.y===t&&this.z===r&&this.w===n},i.prototype.multiplyInPlace=function(e){return this.x*=e.x,this.y*=e.y,this.z*=e.z,this.w*=e.w,this},i.prototype.multiply=function(e){return new i(this.x*e.x,this.y*e.y,this.z*e.z,this.w*e.w)},i.prototype.multiplyToRef=function(e,t){return t.x=this.x*e.x,t.y=this.y*e.y,t.z=this.z*e.z,t.w=this.w*e.w,this},i.prototype.multiplyByFloats=function(e,t,r,n){return new i(this.x*e,this.y*t,this.z*r,this.w*n)},i.prototype.divide=function(e){return new i(this.x/e.x,this.y/e.y,this.z/e.z,this.w/e.w)},i.prototype.divideToRef=function(e,t){return t.x=this.x/e.x,t.y=this.y/e.y,t.z=this.z/e.z,t.w=this.w/e.w,this},i.prototype.divideInPlace=function(e){return this.divideToRef(e,this)},i.prototype.minimizeInPlace=function(e){return e.x<this.x&&(this.x=e.x),e.y<this.y&&(this.y=e.y),e.z<this.z&&(this.z=e.z),e.w<this.w&&(this.w=e.w),this},i.prototype.maximizeInPlace=function(e){return e.x>this.x&&(this.x=e.x),e.y>this.y&&(this.y=e.y),e.z>this.z&&(this.z=e.z),e.w>this.w&&(this.w=e.w),this},i.prototype.floor=function(){return new i(Math.floor(this.x),Math.floor(this.y),Math.floor(this.z),Math.floor(this.w))},i.prototype.fract=function(){return new i(this.x-Math.floor(this.x),this.y-Math.floor(this.y),this.z-Math.floor(this.z),this.w-Math.floor(this.w))},i.prototype.length=function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w)},i.prototype.lengthSquared=function(){return this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w},i.prototype.normalize=function(){var e=this.length();return e===0?this:this.scaleInPlace(1/e)},i.prototype.toVector3=function(){return new m(this.x,this.y,this.z)},i.prototype.clone=function(){return new i(this.x,this.y,this.z,this.w)},i.prototype.copyFrom=function(e){return this.x=e.x,this.y=e.y,this.z=e.z,this.w=e.w,this},i.prototype.copyFromFloats=function(e,t,r,n){return this.x=e,this.y=t,this.z=r,this.w=n,this},i.prototype.set=function(e,t,r,n){return this.copyFromFloats(e,t,r,n)},i.prototype.setAll=function(e){return this.x=this.y=this.z=this.w=e,this},i.FromArray=function(e,t){return t||(t=0),new i(e[t],e[t+1],e[t+2],e[t+3])},i.FromArrayToRef=function(e,t,r){r.x=e[t],r.y=e[t+1],r.z=e[t+2],r.w=e[t+3]},i.FromFloatArrayToRef=function(e,t,r){i.FromArrayToRef(e,t,r)},i.FromFloatsToRef=function(e,t,r,n,a){a.x=e,a.y=t,a.z=r,a.w=n},i.Zero=function(){return new i(0,0,0,0)},i.One=function(){return new i(1,1,1,1)},i.Normalize=function(e){var t=i.Zero();return i.NormalizeToRef(e,t),t},i.NormalizeToRef=function(e,t){t.copyFrom(e),t.normalize()},i.Minimize=function(e,t){var r=e.clone();return r.minimizeInPlace(t),r},i.Maximize=function(e,t){var r=e.clone();return r.maximizeInPlace(t),r},i.Distance=function(e,t){return Math.sqrt(i.DistanceSquared(e,t))},i.DistanceSquared=function(e,t){var r=e.x-t.x,n=e.y-t.y,a=e.z-t.z,s=e.w-t.w;return r*r+n*n+a*a+s*s},i.Center=function(e,t){return i.CenterToRef(e,t,i.Zero())},i.CenterToRef=function(e,t,r){return r.copyFromFloats((e.x+t.x)/2,(e.y+t.y)/2,(e.z+t.z)/2,(e.w+t.w)/2)},i.TransformCoordinates=function(e,t){var r=i.Zero();return i.TransformCoordinatesToRef(e,t,r),r},i.TransformCoordinatesToRef=function(e,t,r){i.TransformCoordinatesFromFloatsToRef(e._x,e._y,e._z,t,r)},i.TransformCoordinatesFromFloatsToRef=function(e,t,r,n,a){var s=n.m,o=e*s[0]+t*s[4]+r*s[8]+s[12],l=e*s[1]+t*s[5]+r*s[9]+s[13],u=e*s[2]+t*s[6]+r*s[10]+s[14],f=e*s[3]+t*s[7]+r*s[11]+s[15];a.x=o,a.y=l,a.z=u,a.w=f},i.TransformNormal=function(e,t){var r=i.Zero();return i.TransformNormalToRef(e,t,r),r},i.TransformNormalToRef=function(e,t,r){var n=t.m,a=e.x*n[0]+e.y*n[4]+e.z*n[8],s=e.x*n[1]+e.y*n[5]+e.z*n[9],o=e.x*n[2]+e.y*n[6]+e.z*n[10];r.x=a,r.y=s,r.z=o,r.w=e.w},i.TransformNormalFromFloatsToRef=function(e,t,r,n,a,s){var o=a.m;s.x=e*o[0]+t*o[4]+r*o[8],s.y=e*o[1]+t*o[5]+r*o[9],s.z=e*o[2]+t*o[6]+r*o[10],s.w=n},i.FromVector3=function(e,t){return t===void 0&&(t=0),new i(e._x,e._y,e._z,t)},i}(),de=function(){function i(e,t,r,n){e===void 0&&(e=0),t===void 0&&(t=0),r===void 0&&(r=0),n===void 0&&(n=1),this._isDirty=!0,this._x=e,this._y=t,this._z=r,this._w=n}return Object.defineProperty(i.prototype,"x",{get:function(){return this._x},set:function(e){this._x=e,this._isDirty=!0},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"y",{get:function(){return this._y},set:function(e){this._y=e,this._isDirty=!0},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"z",{get:function(){return this._z},set:function(e){this._z=e,this._isDirty=!0},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"w",{get:function(){return this._w},set:function(e){this._w=e,this._isDirty=!0},enumerable:!1,configurable:!0}),i.prototype.toString=function(){return"{X: ".concat(this._x," Y: ").concat(this._y," Z: ").concat(this._z," W: ").concat(this._w,"}")},i.prototype.getClassName=function(){return"Quaternion"},i.prototype.getHashCode=function(){var e=it(this._x),t=it(this._y),r=it(this._z),n=it(this._w),a=e;return a=a*397^t,a=a*397^r,a=a*397^n,a},i.prototype.asArray=function(){return[this._x,this._y,this._z,this._w]},i.prototype.equals=function(e){return e&&this._x===e._x&&this._y===e._y&&this._z===e._z&&this._w===e._w},i.prototype.equalsWithEpsilon=function(e,t){return t===void 0&&(t=Me),e&&K.WithinEpsilon(this._x,e._x,t)&&K.WithinEpsilon(this._y,e._y,t)&&K.WithinEpsilon(this._z,e._z,t)&&K.WithinEpsilon(this._w,e._w,t)},i.prototype.clone=function(){return new i(this._x,this._y,this._z,this._w)},i.prototype.copyFrom=function(e){return this.x=e._x,this.y=e._y,this.z=e._z,this.w=e._w,this},i.prototype.copyFromFloats=function(e,t,r,n){return this.x=e,this.y=t,this.z=r,this.w=n,this},i.prototype.set=function(e,t,r,n){return this.copyFromFloats(e,t,r,n)},i.prototype.add=function(e){return new i(this._x+e._x,this._y+e._y,this._z+e._z,this._w+e._w)},i.prototype.addInPlace=function(e){return this._x+=e._x,this._y+=e._y,this._z+=e._z,this._w+=e._w,this},i.prototype.subtract=function(e){return new i(this._x-e._x,this._y-e._y,this._z-e._z,this._w-e._w)},i.prototype.scale=function(e){return new i(this._x*e,this._y*e,this._z*e,this._w*e)},i.prototype.scaleToRef=function(e,t){return t.x=this._x*e,t.y=this._y*e,t.z=this._z*e,t.w=this._w*e,this},i.prototype.scaleInPlace=function(e){return this.x*=e,this.y*=e,this.z*=e,this.w*=e,this},i.prototype.scaleAndAddToRef=function(e,t){return t.x+=this._x*e,t.y+=this._y*e,t.z+=this._z*e,t.w+=this._w*e,this},i.prototype.multiply=function(e){var t=new i(0,0,0,1);return this.multiplyToRef(e,t),t},i.prototype.multiplyToRef=function(e,t){var r=this._x*e._w+this._y*e._z-this._z*e._y+this._w*e._x,n=-this._x*e._z+this._y*e._w+this._z*e._x+this._w*e._y,a=this._x*e._y-this._y*e._x+this._z*e._w+this._w*e._z,s=-this._x*e._x-this._y*e._y-this._z*e._z+this._w*e._w;return t.copyFromFloats(r,n,a,s),this},i.prototype.multiplyInPlace=function(e){return this.multiplyToRef(e,this),this},i.prototype.conjugateToRef=function(e){return e.copyFromFloats(-this._x,-this._y,-this._z,this._w),this},i.prototype.conjugateInPlace=function(){return this.x*=-1,this.y*=-1,this.z*=-1,this},i.prototype.conjugate=function(){var e=new i(-this._x,-this._y,-this._z,this._w);return e},i.prototype.length=function(){return Math.sqrt(this._x*this._x+this._y*this._y+this._z*this._z+this._w*this._w)},i.prototype.normalize=function(){var e=this.length();if(e===0)return this;var t=1/e;return this.x*=t,this.y*=t,this.z*=t,this.w*=t,this},i.prototype.toEulerAngles=function(){var e=m.Zero();return this.toEulerAnglesToRef(e),e},i.prototype.toEulerAnglesToRef=function(e){var t=this._z,r=this._x,n=this._y,a=this._w,s=a*a,o=t*t,l=r*r,u=n*n,f=n*t-r*a,h=.4999999;return f<-h?(e.y=2*Math.atan2(n,a),e.x=Math.PI/2,e.z=0):f>h?(e.y=2*Math.atan2(n,a),e.x=-Math.PI/2,e.z=0):(e.z=Math.atan2(2*(r*n+t*a),-o-l+u+s),e.x=Math.asin(-2*(t*n-r*a)),e.y=Math.atan2(2*(t*r+n*a),o-l-u+s)),this},i.prototype.toRotationMatrix=function(e){return G.FromQuaternionToRef(this,e),this},i.prototype.fromRotationMatrix=function(e){return i.FromRotationMatrixToRef(e,this),this},i.FromRotationMatrix=function(e){var t=new i;return i.FromRotationMatrixToRef(e,t),t},i.FromRotationMatrixToRef=function(e,t){var r=e.m,n=r[0],a=r[4],s=r[8],o=r[1],l=r[5],u=r[9],f=r[2],h=r[6],c=r[10],d=n+l+c,p;d>0?(p=.5/Math.sqrt(d+1),t.w=.25/p,t.x=(h-u)*p,t.y=(s-f)*p,t.z=(o-a)*p):n>l&&n>c?(p=2*Math.sqrt(1+n-l-c),t.w=(h-u)/p,t.x=.25*p,t.y=(a+o)/p,t.z=(s+f)/p):l>c?(p=2*Math.sqrt(1+l-n-c),t.w=(s-f)/p,t.x=(a+o)/p,t.y=.25*p,t.z=(u+h)/p):(p=2*Math.sqrt(1+c-n-l),t.w=(o-a)/p,t.x=(s+f)/p,t.y=(u+h)/p,t.z=.25*p)},i.Dot=function(e,t){return e._x*t._x+e._y*t._y+e._z*t._z+e._w*t._w},i.AreClose=function(e,t){var r=i.Dot(e,t);return r>=0},i.SmoothToRef=function(e,t,r,n,a){var s=n===0?1:r/n;s=K.Clamp(s,0,1),i.SlerpToRef(e,t,s,a)},i.Zero=function(){return new i(0,0,0,0)},i.Inverse=function(e){return new i(-e._x,-e._y,-e._z,e._w)},i.InverseToRef=function(e,t){return t.set(-e._x,-e._y,-e._z,e._w),t},i.Identity=function(){return new i(0,0,0,1)},i.IsIdentity=function(e){return e&&e._x===0&&e._y===0&&e._z===0&&e._w===1},i.RotationAxis=function(e,t){return i.RotationAxisToRef(e,t,new i)},i.RotationAxisToRef=function(e,t,r){var n=Math.sin(t/2);return e.normalize(),r.w=Math.cos(t/2),r.x=e._x*n,r.y=e._y*n,r.z=e._z*n,r},i.FromArray=function(e,t){return t||(t=0),new i(e[t],e[t+1],e[t+2],e[t+3])},i.FromArrayToRef=function(e,t,r){r.x=e[t],r.y=e[t+1],r.z=e[t+2],r.w=e[t+3]},i.FromEulerAngles=function(e,t,r){var n=new i;return i.RotationYawPitchRollToRef(t,e,r,n),n},i.FromEulerAnglesToRef=function(e,t,r,n){return i.RotationYawPitchRollToRef(t,e,r,n),n},i.FromEulerVector=function(e){var t=new i;return i.RotationYawPitchRollToRef(e._y,e._x,e._z,t),t},i.FromEulerVectorToRef=function(e,t){return i.RotationYawPitchRollToRef(e._y,e._x,e._z,t),t},i.FromUnitVectorsToRef=function(e,t,r){var n=m.Dot(e,t)+1;return n<Me?Math.abs(e.x)>Math.abs(e.z)?r.set(-e.y,e.x,0,0):r.set(0,-e.z,e.y,0):(m.CrossToRef(e,t,U.Vector3[0]),r.set(U.Vector3[0].x,U.Vector3[0].y,U.Vector3[0].z,n)),r.normalize()},i.RotationYawPitchRoll=function(e,t,r){var n=new i;return i.RotationYawPitchRollToRef(e,t,r,n),n},i.RotationYawPitchRollToRef=function(e,t,r,n){var a=r*.5,s=t*.5,o=e*.5,l=Math.sin(a),u=Math.cos(a),f=Math.sin(s),h=Math.cos(s),c=Math.sin(o),d=Math.cos(o);n.x=d*f*u+c*h*l,n.y=c*h*u-d*f*l,n.z=d*h*l-c*f*u,n.w=d*h*u+c*f*l},i.RotationAlphaBetaGamma=function(e,t,r){var n=new i;return i.RotationAlphaBetaGammaToRef(e,t,r,n),n},i.RotationAlphaBetaGammaToRef=function(e,t,r,n){var a=(r+e)*.5,s=(r-e)*.5,o=t*.5;n.x=Math.cos(s)*Math.sin(o),n.y=Math.sin(s)*Math.sin(o),n.z=Math.sin(a)*Math.cos(o),n.w=Math.cos(a)*Math.cos(o)},i.RotationQuaternionFromAxis=function(e,t,r){var n=new i(0,0,0,0);return i.RotationQuaternionFromAxisToRef(e,t,r,n),n},i.RotationQuaternionFromAxisToRef=function(e,t,r,n){var a=ae.Matrix[0];G.FromXYZAxesToRef(e.normalize(),t.normalize(),r.normalize(),a),i.FromRotationMatrixToRef(a,n)},i.FromLookDirectionLH=function(e,t){var r=new i;return i.FromLookDirectionLHToRef(e,t,r),r},i.FromLookDirectionLHToRef=function(e,t,r){var n=ae.Matrix[0];G.LookDirectionLHToRef(e,t,n),i.FromRotationMatrixToRef(n,r)},i.FromLookDirectionRH=function(e,t){var r=new i;return i.FromLookDirectionRHToRef(e,t,r),r},i.FromLookDirectionRHToRef=function(e,t,r){var n=ae.Matrix[0];return G.LookDirectionRHToRef(e,t,n),i.FromRotationMatrixToRef(n,r)},i.Slerp=function(e,t,r){var n=i.Identity();return i.SlerpToRef(e,t,r,n),n},i.SlerpToRef=function(e,t,r,n){var a,s,o=e._x*t._x+e._y*t._y+e._z*t._z+e._w*t._w,l=!1;if(o<0&&(l=!0,o=-o),o>.999999)s=1-r,a=l?-r:r;else{var u=Math.acos(o),f=1/Math.sin(u);s=Math.sin((1-r)*u)*f,a=l?-Math.sin(r*u)*f:Math.sin(r*u)*f}n.x=s*e._x+a*t._x,n.y=s*e._y+a*t._y,n.z=s*e._z+a*t._z,n.w=s*e._w+a*t._w},i.Hermite=function(e,t,r,n,a){var s=a*a,o=a*s,l=2*o-3*s+1,u=-2*o+3*s,f=o-2*s+a,h=o-s,c=e._x*l+r._x*u+t._x*f+n._x*h,d=e._y*l+r._y*u+t._y*f+n._y*h,p=e._z*l+r._z*u+t._z*f+n._z*h,_=e._w*l+r._w*u+t._w*f+n._w*h;return new i(c,d,p,_)},i.Hermite1stDerivative=function(e,t,r,n,a){var s=i.Zero();return this.Hermite1stDerivativeToRef(e,t,r,n,a,s),s},i.Hermite1stDerivativeToRef=function(e,t,r,n,a,s){var o=a*a;s.x=(o-a)*6*e.x+(3*o-4*a+1)*t.x+(-o+a)*6*r.x+(3*o-2*a)*n.x,s.y=(o-a)*6*e.y+(3*o-4*a+1)*t.y+(-o+a)*6*r.y+(3*o-2*a)*n.y,s.z=(o-a)*6*e.z+(3*o-4*a+1)*t.z+(-o+a)*6*r.z+(3*o-2*a)*n.z,s.w=(o-a)*6*e.w+(3*o-4*a+1)*t.w+(-o+a)*6*r.w+(3*o-2*a)*n.w},i}(),G=function(){function i(){this._isIdentity=!1,this._isIdentityDirty=!0,this._isIdentity3x2=!0,this._isIdentity3x2Dirty=!0,this.updateFlag=-1,tr.MatrixTrackPrecisionChange&&tr.MatrixTrackedMatrices.push(this),this._m=new tr.MatrixCurrentType(16),this.markAsUpdated()}return Object.defineProperty(i,"Use64Bits",{get:function(){return tr.MatrixUse64Bits},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"m",{get:function(){return this._m},enumerable:!1,configurable:!0}),i.prototype.markAsUpdated=function(){this.updateFlag=i._UpdateFlagSeed++,this._isIdentity=!1,this._isIdentity3x2=!1,this._isIdentityDirty=!0,this._isIdentity3x2Dirty=!0},i.prototype._updateIdentityStatus=function(e,t,r,n){t===void 0&&(t=!1),r===void 0&&(r=!1),n===void 0&&(n=!0),this._isIdentity=e,this._isIdentity3x2=e||r,this._isIdentityDirty=this._isIdentity?!1:t,this._isIdentity3x2Dirty=this._isIdentity3x2?!1:n},i.prototype.isIdentity=function(){if(this._isIdentityDirty){this._isIdentityDirty=!1;var e=this._m;this._isIdentity=e[0]===1&&e[1]===0&&e[2]===0&&e[3]===0&&e[4]===0&&e[5]===1&&e[6]===0&&e[7]===0&&e[8]===0&&e[9]===0&&e[10]===1&&e[11]===0&&e[12]===0&&e[13]===0&&e[14]===0&&e[15]===1}return this._isIdentity},i.prototype.isIdentityAs3x2=function(){return this._isIdentity3x2Dirty&&(this._isIdentity3x2Dirty=!1,this._m[0]!==1||this._m[5]!==1||this._m[15]!==1?this._isIdentity3x2=!1:this._m[1]!==0||this._m[2]!==0||this._m[3]!==0||this._m[4]!==0||this._m[6]!==0||this._m[7]!==0||this._m[8]!==0||this._m[9]!==0||this._m[10]!==0||this._m[11]!==0||this._m[12]!==0||this._m[13]!==0||this._m[14]!==0?this._isIdentity3x2=!1:this._isIdentity3x2=!0),this._isIdentity3x2},i.prototype.determinant=function(){if(this._isIdentity===!0)return 1;var e=this._m,t=e[0],r=e[1],n=e[2],a=e[3],s=e[4],o=e[5],l=e[6],u=e[7],f=e[8],h=e[9],c=e[10],d=e[11],p=e[12],_=e[13],g=e[14],v=e[15],y=c*v-g*d,b=h*v-_*d,E=h*g-_*c,A=f*v-p*d,S=f*g-c*p,T=f*_-p*h,M=+(o*y-l*b+u*E),D=-(s*y-l*A+u*S),x=+(s*b-o*A+u*T),P=-(s*E-o*S+l*T);return t*M+r*D+n*x+a*P},i.prototype.toArray=function(){return this._m},i.prototype.asArray=function(){return this._m},i.prototype.invert=function(){return this.invertToRef(this),this},i.prototype.reset=function(){return i.FromValuesToRef(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,this),this._updateIdentityStatus(!1),this},i.prototype.add=function(e){var t=new i;return this.addToRef(e,t),t},i.prototype.addToRef=function(e,t){for(var r=this._m,n=t._m,a=e.m,s=0;s<16;s++)n[s]=r[s]+a[s];return t.markAsUpdated(),this},i.prototype.addToSelf=function(e){for(var t=this._m,r=e.m,n=0;n<16;n++)t[n]+=r[n];return this.markAsUpdated(),this},i.prototype.invertToRef=function(e){if(this._isIdentity===!0)return i.IdentityToRef(e),this;var t=this._m,r=t[0],n=t[1],a=t[2],s=t[3],o=t[4],l=t[5],u=t[6],f=t[7],h=t[8],c=t[9],d=t[10],p=t[11],_=t[12],g=t[13],v=t[14],y=t[15],b=d*y-v*p,E=c*y-g*p,A=c*v-g*d,S=h*y-_*p,T=h*v-d*_,M=h*g-_*c,D=+(l*b-u*E+f*A),x=-(o*b-u*S+f*T),P=+(o*E-l*S+f*M),w=-(o*A-l*T+u*M),k=r*D+n*x+a*P+s*w;if(k===0)return e.copyFrom(this),this;var B=1/k,L=u*y-v*f,H=l*y-g*f,W=l*v-g*u,F=o*y-_*f,V=o*v-_*u,z=o*g-_*l,N=u*p-d*f,Q=l*p-c*f,Z=l*d-c*u,ee=o*p-h*f,ne=o*d-h*u,Te=o*c-h*l,j=-(n*b-a*E+s*A),oe=+(r*b-a*S+s*T),be=-(r*E-n*S+s*M),Ee=+(r*A-n*T+a*M),Pe=+(n*L-a*H+s*W),Fe=-(r*L-a*F+s*V),Ae=+(r*H-n*F+s*z),xe=-(r*W-n*V+a*z),_e=-(n*N-a*Q+s*Z),we=+(r*N-a*ee+s*ne),Ve=-(r*Q-n*ee+s*Te),st=+(r*Z-n*ne+a*Te);return i.FromValuesToRef(D*B,j*B,Pe*B,_e*B,x*B,oe*B,Fe*B,we*B,P*B,be*B,Ae*B,Ve*B,w*B,Ee*B,xe*B,st*B,e),this},i.prototype.addAtIndex=function(e,t){return this._m[e]+=t,this.markAsUpdated(),this},i.prototype.multiplyAtIndex=function(e,t){return this._m[e]*=t,this.markAsUpdated(),this},i.prototype.setTranslationFromFloats=function(e,t,r){return this._m[12]=e,this._m[13]=t,this._m[14]=r,this.markAsUpdated(),this},i.prototype.addTranslationFromFloats=function(e,t,r){return this._m[12]+=e,this._m[13]+=t,this._m[14]+=r,this.markAsUpdated(),this},i.prototype.setTranslation=function(e){return this.setTranslationFromFloats(e._x,e._y,e._z)},i.prototype.getTranslation=function(){return new m(this._m[12],this._m[13],this._m[14])},i.prototype.getTranslationToRef=function(e){return e.x=this._m[12],e.y=this._m[13],e.z=this._m[14],this},i.prototype.removeRotationAndScaling=function(){var e=this.m;return i.FromValuesToRef(1,0,0,0,0,1,0,0,0,0,1,0,e[12],e[13],e[14],e[15],this),this._updateIdentityStatus(e[12]===0&&e[13]===0&&e[14]===0&&e[15]===1),this},i.prototype.multiply=function(e){var t=new i;return this.multiplyToRef(e,t),t},i.prototype.copyFrom=function(e){e.copyToArray(this._m);var t=e;return this.updateFlag=t.updateFlag,this._updateIdentityStatus(t._isIdentity,t._isIdentityDirty,t._isIdentity3x2,t._isIdentity3x2Dirty),this},i.prototype.copyToArray=function(e,t){t===void 0&&(t=0);var r=this._m;return e[t]=r[0],e[t+1]=r[1],e[t+2]=r[2],e[t+3]=r[3],e[t+4]=r[4],e[t+5]=r[5],e[t+6]=r[6],e[t+7]=r[7],e[t+8]=r[8],e[t+9]=r[9],e[t+10]=r[10],e[t+11]=r[11],e[t+12]=r[12],e[t+13]=r[13],e[t+14]=r[14],e[t+15]=r[15],this},i.prototype.multiplyToRef=function(e,t){return this._isIdentity?(t.copyFrom(e),this):e._isIdentity?(t.copyFrom(this),this):(this.multiplyToArray(e,t._m,0),t.markAsUpdated(),this)},i.prototype.multiplyToArray=function(e,t,r){var n=this._m,a=e.m,s=n[0],o=n[1],l=n[2],u=n[3],f=n[4],h=n[5],c=n[6],d=n[7],p=n[8],_=n[9],g=n[10],v=n[11],y=n[12],b=n[13],E=n[14],A=n[15],S=a[0],T=a[1],M=a[2],D=a[3],x=a[4],P=a[5],w=a[6],k=a[7],B=a[8],L=a[9],H=a[10],W=a[11],F=a[12],V=a[13],z=a[14],N=a[15];return t[r]=s*S+o*x+l*B+u*F,t[r+1]=s*T+o*P+l*L+u*V,t[r+2]=s*M+o*w+l*H+u*z,t[r+3]=s*D+o*k+l*W+u*N,t[r+4]=f*S+h*x+c*B+d*F,t[r+5]=f*T+h*P+c*L+d*V,t[r+6]=f*M+h*w+c*H+d*z,t[r+7]=f*D+h*k+c*W+d*N,t[r+8]=p*S+_*x+g*B+v*F,t[r+9]=p*T+_*P+g*L+v*V,t[r+10]=p*M+_*w+g*H+v*z,t[r+11]=p*D+_*k+g*W+v*N,t[r+12]=y*S+b*x+E*B+A*F,t[r+13]=y*T+b*P+E*L+A*V,t[r+14]=y*M+b*w+E*H+A*z,t[r+15]=y*D+b*k+E*W+A*N,this},i.prototype.equals=function(e){var t=e;if(!t)return!1;if((this._isIdentity||t._isIdentity)&&!this._isIdentityDirty&&!t._isIdentityDirty)return this._isIdentity&&t._isIdentity;var r=this.m,n=t.m;return r[0]===n[0]&&r[1]===n[1]&&r[2]===n[2]&&r[3]===n[3]&&r[4]===n[4]&&r[5]===n[5]&&r[6]===n[6]&&r[7]===n[7]&&r[8]===n[8]&&r[9]===n[9]&&r[10]===n[10]&&r[11]===n[11]&&r[12]===n[12]&&r[13]===n[13]&&r[14]===n[14]&&r[15]===n[15]},i.prototype.clone=function(){var e=new i;return e.copyFrom(this),e},i.prototype.getClassName=function(){return"Matrix"},i.prototype.getHashCode=function(){for(var e=it(this._m[0]),t=1;t<16;t++)e=e*397^it(this._m[t]);return e},i.prototype.decomposeToTransformNode=function(e){return e.rotationQuaternion=e.rotationQuaternion||new de,this.decompose(e.scaling,e.rotationQuaternion,e.position)},i.prototype.decompose=function(e,t,r,n){if(this._isIdentity)return r&&r.setAll(0),e&&e.setAll(1),t&&t.copyFromFloats(0,0,0,1),!0;var a=this._m;if(r&&r.copyFromFloats(a[12],a[13],a[14]),e=e||ae.Vector3[0],e.x=Math.sqrt(a[0]*a[0]+a[1]*a[1]+a[2]*a[2]),e.y=Math.sqrt(a[4]*a[4]+a[5]*a[5]+a[6]*a[6]),e.z=Math.sqrt(a[8]*a[8]+a[9]*a[9]+a[10]*a[10]),n){var s=n.scaling.x<0?-1:1,o=n.scaling.y<0?-1:1,l=n.scaling.z<0?-1:1;e.x*=s,e.y*=o,e.z*=l}else this.determinant()<=0&&(e.y*=-1);if(e._x===0||e._y===0||e._z===0)return t&&t.copyFromFloats(0,0,0,1),!1;if(t){var u=1/e._x,f=1/e._y,h=1/e._z;i.FromValuesToRef(a[0]*u,a[1]*u,a[2]*u,0,a[4]*f,a[5]*f,a[6]*f,0,a[8]*h,a[9]*h,a[10]*h,0,0,0,0,1,ae.Matrix[0]),de.FromRotationMatrixToRef(ae.Matrix[0],t)}return!0},i.prototype.getRow=function(e){if(e<0||e>3)return null;var t=e*4;return new Ke(this._m[t+0],this._m[t+1],this._m[t+2],this._m[t+3])},i.prototype.setRow=function(e,t){return this.setRowFromFloats(e,t.x,t.y,t.z,t.w)},i.prototype.transpose=function(){return i.Transpose(this)},i.prototype.transposeToRef=function(e){return i.TransposeToRef(this,e),this},i.prototype.setRowFromFloats=function(e,t,r,n,a){if(e<0||e>3)return this;var s=e*4;return this._m[s+0]=t,this._m[s+1]=r,this._m[s+2]=n,this._m[s+3]=a,this.markAsUpdated(),this},i.prototype.scale=function(e){var t=new i;return this.scaleToRef(e,t),t},i.prototype.scaleToRef=function(e,t){for(var r=0;r<16;r++)t._m[r]=this._m[r]*e;return t.markAsUpdated(),this},i.prototype.scaleAndAddToRef=function(e,t){for(var r=0;r<16;r++)t._m[r]+=this._m[r]*e;return t.markAsUpdated(),this},i.prototype.toNormalMatrix=function(e){var t=ae.Matrix[0];this.invertToRef(t),t.transposeToRef(e);var r=e._m;i.FromValuesToRef(r[0],r[1],r[2],0,r[4],r[5],r[6],0,r[8],r[9],r[10],0,0,0,0,1,e)},i.prototype.getRotationMatrix=function(){var e=new i;return this.getRotationMatrixToRef(e),e},i.prototype.getRotationMatrixToRef=function(e){var t=ae.Vector3[0];if(!this.decompose(t))return i.IdentityToRef(e),this;var r=this._m,n=1/t._x,a=1/t._y,s=1/t._z;return i.FromValuesToRef(r[0]*n,r[1]*n,r[2]*n,0,r[4]*a,r[5]*a,r[6]*a,0,r[8]*s,r[9]*s,r[10]*s,0,0,0,0,1,e),this},i.prototype.toggleModelMatrixHandInPlace=function(){var e=this._m;e[2]*=-1,e[6]*=-1,e[8]*=-1,e[9]*=-1,e[14]*=-1,this.markAsUpdated()},i.prototype.toggleProjectionMatrixHandInPlace=function(){var e=this._m;e[8]*=-1,e[9]*=-1,e[10]*=-1,e[11]*=-1,this.markAsUpdated()},i.FromArray=function(e,t){t===void 0&&(t=0);var r=new i;return i.FromArrayToRef(e,t,r),r},i.FromArrayToRef=function(e,t,r){for(var n=0;n<16;n++)r._m[n]=e[n+t];r.markAsUpdated()},i.FromFloat32ArrayToRefScaled=function(e,t,r,n){for(var a=0;a<16;a++)n._m[a]=e[a+t]*r;n.markAsUpdated()},Object.defineProperty(i,"IdentityReadOnly",{get:function(){return i._IdentityReadOnly},enumerable:!1,configurable:!0}),i.FromValuesToRef=function(e,t,r,n,a,s,o,l,u,f,h,c,d,p,_,g,v){var y=v._m;y[0]=e,y[1]=t,y[2]=r,y[3]=n,y[4]=a,y[5]=s,y[6]=o,y[7]=l,y[8]=u,y[9]=f,y[10]=h,y[11]=c,y[12]=d,y[13]=p,y[14]=_,y[15]=g,v.markAsUpdated()},i.FromValues=function(e,t,r,n,a,s,o,l,u,f,h,c,d,p,_,g){var v=new i,y=v._m;return y[0]=e,y[1]=t,y[2]=r,y[3]=n,y[4]=a,y[5]=s,y[6]=o,y[7]=l,y[8]=u,y[9]=f,y[10]=h,y[11]=c,y[12]=d,y[13]=p,y[14]=_,y[15]=g,v.markAsUpdated(),v},i.Compose=function(e,t,r){var n=new i;return i.ComposeToRef(e,t,r,n),n},i.ComposeToRef=function(e,t,r,n){var a=n._m,s=t._x,o=t._y,l=t._z,u=t._w,f=s+s,h=o+o,c=l+l,d=s*f,p=s*h,_=s*c,g=o*h,v=o*c,y=l*c,b=u*f,E=u*h,A=u*c,S=e._x,T=e._y,M=e._z;a[0]=(1-(g+y))*S,a[1]=(p+A)*S,a[2]=(_-E)*S,a[3]=0,a[4]=(p-A)*T,a[5]=(1-(d+y))*T,a[6]=(v+b)*T,a[7]=0,a[8]=(_+E)*M,a[9]=(v-b)*M,a[10]=(1-(d+g))*M,a[11]=0,a[12]=r._x,a[13]=r._y,a[14]=r._z,a[15]=1,n.markAsUpdated()},i.Identity=function(){var e=i.FromValues(1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1);return e._updateIdentityStatus(!0),e},i.IdentityToRef=function(e){i.FromValuesToRef(1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1,e),e._updateIdentityStatus(!0)},i.Zero=function(){var e=i.FromValues(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0);return e._updateIdentityStatus(!1),e},i.RotationX=function(e){var t=new i;return i.RotationXToRef(e,t),t},i.Invert=function(e){var t=new i;return e.invertToRef(t),t},i.RotationXToRef=function(e,t){var r=Math.sin(e),n=Math.cos(e);i.FromValuesToRef(1,0,0,0,0,n,r,0,0,-r,n,0,0,0,0,1,t),t._updateIdentityStatus(n===1&&r===0)},i.RotationY=function(e){var t=new i;return i.RotationYToRef(e,t),t},i.RotationYToRef=function(e,t){var r=Math.sin(e),n=Math.cos(e);i.FromValuesToRef(n,0,-r,0,0,1,0,0,r,0,n,0,0,0,0,1,t),t._updateIdentityStatus(n===1&&r===0)},i.RotationZ=function(e){var t=new i;return i.RotationZToRef(e,t),t},i.RotationZToRef=function(e,t){var r=Math.sin(e),n=Math.cos(e);i.FromValuesToRef(n,r,0,0,-r,n,0,0,0,0,1,0,0,0,0,1,t),t._updateIdentityStatus(n===1&&r===0)},i.RotationAxis=function(e,t){var r=new i;return i.RotationAxisToRef(e,t,r),r},i.RotationAxisToRef=function(e,t,r){var n=Math.sin(-t),a=Math.cos(-t),s=1-a;e.normalize();var o=r._m;o[0]=e._x*e._x*s+a,o[1]=e._x*e._y*s-e._z*n,o[2]=e._x*e._z*s+e._y*n,o[3]=0,o[4]=e._y*e._x*s+e._z*n,o[5]=e._y*e._y*s+a,o[6]=e._y*e._z*s-e._x*n,o[7]=0,o[8]=e._z*e._x*s-e._y*n,o[9]=e._z*e._y*s+e._x*n,o[10]=e._z*e._z*s+a,o[11]=0,o[12]=0,o[13]=0,o[14]=0,o[15]=1,r.markAsUpdated()},i.RotationAlignToRef=function(e,t,r){var n=m.Dot(t,e),a=r._m;if(n<-1+Me)a[0]=-1,a[1]=0,a[2]=0,a[3]=0,a[4]=0,a[5]=-1,a[6]=0,a[7]=0,a[8]=0,a[9]=0,a[10]=1,a[11]=0;else{var s=m.Cross(t,e),o=1/(1+n);a[0]=s._x*s._x*o+n,a[1]=s._y*s._x*o-s._z,a[2]=s._z*s._x*o+s._y,a[3]=0,a[4]=s._x*s._y*o+s._z,a[5]=s._y*s._y*o+n,a[6]=s._z*s._y*o-s._x,a[7]=0,a[8]=s._x*s._z*o-s._y,a[9]=s._y*s._z*o+s._x,a[10]=s._z*s._z*o+n,a[11]=0}a[12]=0,a[13]=0,a[14]=0,a[15]=1,r.markAsUpdated()},i.RotationYawPitchRoll=function(e,t,r){var n=new i;return i.RotationYawPitchRollToRef(e,t,r,n),n},i.RotationYawPitchRollToRef=function(e,t,r,n){de.RotationYawPitchRollToRef(e,t,r,ae.Quaternion[0]),ae.Quaternion[0].toRotationMatrix(n)},i.Scaling=function(e,t,r){var n=new i;return i.ScalingToRef(e,t,r,n),n},i.ScalingToRef=function(e,t,r,n){i.FromValuesToRef(e,0,0,0,0,t,0,0,0,0,r,0,0,0,0,1,n),n._updateIdentityStatus(e===1&&t===1&&r===1)},i.Translation=function(e,t,r){var n=new i;return i.TranslationToRef(e,t,r,n),n},i.TranslationToRef=function(e,t,r,n){i.FromValuesToRef(1,0,0,0,0,1,0,0,0,0,1,0,e,t,r,1,n),n._updateIdentityStatus(e===0&&t===0&&r===0)},i.Lerp=function(e,t,r){var n=new i;return i.LerpToRef(e,t,r,n),n},i.LerpToRef=function(e,t,r,n){for(var a=n._m,s=e.m,o=t.m,l=0;l<16;l++)a[l]=s[l]*(1-r)+o[l]*r;n.markAsUpdated()},i.DecomposeLerp=function(e,t,r){var n=new i;return i.DecomposeLerpToRef(e,t,r,n),n},i.DecomposeLerpToRef=function(e,t,r,n){var a=ae.Vector3[0],s=ae.Quaternion[0],o=ae.Vector3[1];e.decompose(a,s,o);var l=ae.Vector3[2],u=ae.Quaternion[1],f=ae.Vector3[3];t.decompose(l,u,f);var h=ae.Vector3[4];m.LerpToRef(a,l,r,h);var c=ae.Quaternion[2];de.SlerpToRef(s,u,r,c);var d=ae.Vector3[5];m.LerpToRef(o,f,r,d),i.ComposeToRef(h,c,d,n)},i.LookAtLH=function(e,t,r){var n=new i;return i.LookAtLHToRef(e,t,r,n),n},i.LookAtLHToRef=function(e,t,r,n){var a=ae.Vector3[0],s=ae.Vector3[1],o=ae.Vector3[2];t.subtractToRef(e,o),o.normalize(),m.CrossToRef(r,o,a);var l=a.lengthSquared();l===0?a.x=1:a.normalizeFromLength(Math.sqrt(l)),m.CrossToRef(o,a,s),s.normalize();var u=-m.Dot(a,e),f=-m.Dot(s,e),h=-m.Dot(o,e);i.FromValuesToRef(a._x,s._x,o._x,0,a._y,s._y,o._y,0,a._z,s._z,o._z,0,u,f,h,1,n)},i.LookAtRH=function(e,t,r){var n=new i;return i.LookAtRHToRef(e,t,r,n),n},i.LookAtRHToRef=function(e,t,r,n){var a=ae.Vector3[0],s=ae.Vector3[1],o=ae.Vector3[2];e.subtractToRef(t,o),o.normalize(),m.CrossToRef(r,o,a);var l=a.lengthSquared();l===0?a.x=1:a.normalizeFromLength(Math.sqrt(l)),m.CrossToRef(o,a,s),s.normalize();var u=-m.Dot(a,e),f=-m.Dot(s,e),h=-m.Dot(o,e);i.FromValuesToRef(a._x,s._x,o._x,0,a._y,s._y,o._y,0,a._z,s._z,o._z,0,u,f,h,1,n)},i.LookDirectionLH=function(e,t){var r=new i;return i.LookDirectionLHToRef(e,t,r),r},i.LookDirectionLHToRef=function(e,t,r){var n=ae.Vector3[0];n.copyFrom(e),n.scaleInPlace(-1);var a=ae.Vector3[1];m.CrossToRef(t,n,a),i.FromValuesToRef(a._x,a._y,a._z,0,t._x,t._y,t._z,0,n._x,n._y,n._z,0,0,0,0,1,r)},i.LookDirectionRH=function(e,t){var r=new i;return i.LookDirectionRHToRef(e,t,r),r},i.LookDirectionRHToRef=function(e,t,r){var n=ae.Vector3[2];m.CrossToRef(t,e,n),i.FromValuesToRef(n._x,n._y,n._z,0,t._x,t._y,t._z,0,e._x,e._y,e._z,0,0,0,0,1,r)},i.OrthoLH=function(e,t,r,n,a){var s=new i;return i.OrthoLHToRef(e,t,r,n,s,a),s},i.OrthoLHToRef=function(e,t,r,n,a,s){var o=r,l=n,u=2/e,f=2/t,h=2/(l-o),c=-(l+o)/(l-o);i.FromValuesToRef(u,0,0,0,0,f,0,0,0,0,h,0,0,0,c,1,a),s&&a.multiplyToRef(Gt,a),a._updateIdentityStatus(u===1&&f===1&&h===1&&c===0)},i.OrthoOffCenterLH=function(e,t,r,n,a,s,o){var l=new i;return i.OrthoOffCenterLHToRef(e,t,r,n,a,s,l,o),l},i.OrthoOffCenterLHToRef=function(e,t,r,n,a,s,o,l){var u=a,f=s,h=2/(t-e),c=2/(n-r),d=2/(f-u),p=-(f+u)/(f-u),_=(e+t)/(e-t),g=(n+r)/(r-n);i.FromValuesToRef(h,0,0,0,0,c,0,0,0,0,d,0,_,g,p,1,o),l&&o.multiplyToRef(Gt,o),o.markAsUpdated()},i.OrthoOffCenterRH=function(e,t,r,n,a,s,o){var l=new i;return i.OrthoOffCenterRHToRef(e,t,r,n,a,s,l,o),l},i.OrthoOffCenterRHToRef=function(e,t,r,n,a,s,o,l){i.OrthoOffCenterLHToRef(e,t,r,n,a,s,o,l),o._m[10]*=-1},i.PerspectiveLH=function(e,t,r,n,a,s){s===void 0&&(s=0);var o=new i,l=r,u=n,f=2*l/e,h=2*l/t,c=(u+l)/(u-l),d=-2*u*l/(u-l),p=Math.tan(s);return i.FromValuesToRef(f,0,0,0,0,h,0,p,0,0,c,1,0,0,d,0,o),a&&o.multiplyToRef(Gt,o),o._updateIdentityStatus(!1),o},i.PerspectiveFovLH=function(e,t,r,n,a,s,o){s===void 0&&(s=0),o===void 0&&(o=!1);var l=new i;return i.PerspectiveFovLHToRef(e,t,r,n,l,!0,a,s,o),l},i.PerspectiveFovLHToRef=function(e,t,r,n,a,s,o,l,u){s===void 0&&(s=!0),l===void 0&&(l=0),u===void 0&&(u=!1);var f=r,h=n,c=1/Math.tan(e*.5),d=s?c/t:c,p=s?c:c*t,_=u&&f===0?-1:h!==0?(h+f)/(h-f):1,g=u&&f===0?2*h:h!==0?-2*h*f/(h-f):-2*f,v=Math.tan(l);i.FromValuesToRef(d,0,0,0,0,p,0,v,0,0,_,1,0,0,g,0,a),o&&a.multiplyToRef(Gt,a),a._updateIdentityStatus(!1)},i.PerspectiveFovReverseLHToRef=function(e,t,r,n,a,s,o,l){s===void 0&&(s=!0),l===void 0&&(l=0);var u=1/Math.tan(e*.5),f=s?u/t:u,h=s?u:u*t,c=Math.tan(l);i.FromValuesToRef(f,0,0,0,0,h,0,c,0,0,-r,1,0,0,1,0,a),o&&a.multiplyToRef(Gt,a),a._updateIdentityStatus(!1)},i.PerspectiveFovRH=function(e,t,r,n,a,s,o){s===void 0&&(s=0),o===void 0&&(o=!1);var l=new i;return i.PerspectiveFovRHToRef(e,t,r,n,l,!0,a,s,o),l},i.PerspectiveFovRHToRef=function(e,t,r,n,a,s,o,l,u){s===void 0&&(s=!0),l===void 0&&(l=0),u===void 0&&(u=!1);var f=r,h=n,c=1/Math.tan(e*.5),d=s?c/t:c,p=s?c:c*t,_=u&&f===0?1:h!==0?-(h+f)/(h-f):-1,g=u&&f===0?2*h:h!==0?-2*h*f/(h-f):-2*f,v=Math.tan(l);i.FromValuesToRef(d,0,0,0,0,p,0,v,0,0,_,-1,0,0,g,0,a),o&&a.multiplyToRef(Gt,a),a._updateIdentityStatus(!1)},i.PerspectiveFovReverseRHToRef=function(e,t,r,n,a,s,o,l){s===void 0&&(s=!0),l===void 0&&(l=0);var u=1/Math.tan(e*.5),f=s?u/t:u,h=s?u:u*t,c=Math.tan(l);i.FromValuesToRef(f,0,0,0,0,h,0,c,0,0,-r,-1,0,0,-1,0,a),o&&a.multiplyToRef(Gt,a),a._updateIdentityStatus(!1)},i.PerspectiveFovWebVRToRef=function(e,t,r,n,a,s,o){a===void 0&&(a=!1),o===void 0&&(o=0);var l=a?-1:1,u=Math.tan(e.upDegrees*Math.PI/180),f=Math.tan(e.downDegrees*Math.PI/180),h=Math.tan(e.leftDegrees*Math.PI/180),c=Math.tan(e.rightDegrees*Math.PI/180),d=2/(h+c),p=2/(u+f),_=Math.tan(o),g=n._m;g[0]=d,g[1]=g[2]=g[3]=g[4]=0,g[5]=p,g[6]=0,g[7]=_,g[8]=(h-c)*d*.5,g[9]=-((u-f)*p*.5),g[10]=-r/(t-r),g[11]=1*l,g[12]=g[13]=g[15]=0,g[14]=-(2*r*t)/(r-t),s&&n.multiplyToRef(Gt,n),n.markAsUpdated()},i.GetFinalMatrix=function(e,t,r,n,a,s){var o=e.width,l=e.height,u=e.x,f=e.y,h=i.FromValues(o/2,0,0,0,0,-l/2,0,0,0,0,s-a,0,u+o/2,l/2+f,a,1),c=ae.Matrix[0];return t.multiplyToRef(r,c),c.multiplyToRef(n,c),c.multiply(h)},i.GetAsMatrix2x2=function(e){var t=e.m,r=[t[0],t[1],t[4],t[5]];return tr.MatrixUse64Bits?r:new Float32Array(r)},i.GetAsMatrix3x3=function(e){var t=e.m,r=[t[0],t[1],t[2],t[4],t[5],t[6],t[8],t[9],t[10]];return tr.MatrixUse64Bits?r:new Float32Array(r)},i.Transpose=function(e){var t=new i;return i.TransposeToRef(e,t),t},i.TransposeToRef=function(e,t){var r=t._m,n=e.m;r[0]=n[0],r[1]=n[4],r[2]=n[8],r[3]=n[12],r[4]=n[1],r[5]=n[5],r[6]=n[9],r[7]=n[13],r[8]=n[2],r[9]=n[6],r[10]=n[10],r[11]=n[14],r[12]=n[3],r[13]=n[7],r[14]=n[11],r[15]=n[15],t.markAsUpdated(),t._updateIdentityStatus(e._isIdentity,e._isIdentityDirty)},i.Reflection=function(e){var t=new i;return i.ReflectionToRef(e,t),t},i.ReflectionToRef=function(e,t){e.normalize();var r=e.normal.x,n=e.normal.y,a=e.normal.z,s=-2*r,o=-2*n,l=-2*a;i.FromValuesToRef(s*r+1,o*r,l*r,0,s*n,o*n+1,l*n,0,s*a,o*a,l*a+1,0,s*e.d,o*e.d,l*e.d,1,t)},i.FromXYZAxesToRef=function(e,t,r,n){i.FromValuesToRef(e._x,e._y,e._z,0,t._x,t._y,t._z,0,r._x,r._y,r._z,0,0,0,0,1,n)},i.FromQuaternionToRef=function(e,t){var r=e._x*e._x,n=e._y*e._y,a=e._z*e._z,s=e._x*e._y,o=e._z*e._w,l=e._z*e._x,u=e._y*e._w,f=e._y*e._z,h=e._x*e._w;t._m[0]=1-2*(n+a),t._m[1]=2*(s+o),t._m[2]=2*(l-u),t._m[3]=0,t._m[4]=2*(s-o),t._m[5]=1-2*(a+r),t._m[6]=2*(f+h),t._m[7]=0,t._m[8]=2*(l+u),t._m[9]=2*(f-h),t._m[10]=1-2*(n+r),t._m[11]=0,t._m[12]=0,t._m[13]=0,t._m[14]=0,t._m[15]=1,t.markAsUpdated()},i._UpdateFlagSeed=0,i._IdentityReadOnly=i.Identity(),i}(),ae=function(){function i(){}return i.Vector3=je.BuildTuple(11,m.Zero),i.Matrix=je.BuildTuple(2,G.Identity),i.Quaternion=je.BuildTuple(3,de.Zero),i}(),U=function(){function i(){}return i.Vector2=je.BuildTuple(3,se.Zero),i.Vector3=je.BuildTuple(13,m.Zero),i.Vector4=je.BuildTuple(3,Ke.Zero),i.Quaternion=je.BuildTuple(2,de.Zero),i.Matrix=je.BuildTuple(8,G.Identity),i}();We("BABYLON.Vector2",se);We("BABYLON.Vector3",m);We("BABYLON.Vector4",Ke);We("BABYLON.Matrix",G);var Gt=G.FromValues(1,0,0,0,0,1,0,0,0,0,.5,0,0,0,.5,1);/*! *****************************************************************************
Copyright (c) Microsoft Corporation.

Permission to use, copy, modify, and/or distribute this software for any
purpose with or without fee is hereby granted.

THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES WITH
REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY
AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT,
INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM
LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR
OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR
PERFORMANCE OF THIS SOFTWARE.
***************************************************************************** */var Fi=function(i,e){return Fi=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,r){t.__proto__=r}||function(t,r){for(var n in r)Object.prototype.hasOwnProperty.call(r,n)&&(t[n]=r[n])},Fi(i,e)};function $(i,e){if(typeof e!="function"&&e!==null)throw new TypeError("Class extends value "+String(e)+" is not a constructor or null");Fi(i,e);function t(){this.constructor=i}i.prototype=e===null?Object.create(e):(t.prototype=e.prototype,new t)}var Ue=function(){return Ue=Object.assign||function(e){for(var t,r=1,n=arguments.length;r<n;r++){t=arguments[r];for(var a in t)Object.prototype.hasOwnProperty.call(t,a)&&(e[a]=t[a])}return e},Ue.apply(this,arguments)};function C(i,e,t,r){var n=arguments.length,a=n<3?e:r===null?r=Object.getOwnPropertyDescriptor(e,t):r,s;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")a=Reflect.decorate(i,e,t,r);else for(var o=i.length-1;o>=0;o--)(s=i[o])&&(a=(n<3?s(a):n>3?s(e,t,a):s(e,t))||a);return n>3&&a&&Object.defineProperty(e,t,a),a}function qi(i,e,t,r){function n(a){return a instanceof t?a:new t(function(s){s(a)})}return new(t||(t=Promise))(function(a,s){function o(f){try{u(r.next(f))}catch(h){s(h)}}function l(f){try{u(r.throw(f))}catch(h){s(h)}}function u(f){f.done?a(f.value):n(f.value).then(o,l)}u((r=r.apply(i,e||[])).next())})}function gr(i,e){var t={label:0,sent:function(){if(a[0]&1)throw a[1];return a[1]},trys:[],ops:[]},r,n,a,s;return s={next:o(0),throw:o(1),return:o(2)},typeof Symbol=="function"&&(s[Symbol.iterator]=function(){return this}),s;function o(u){return function(f){return l([u,f])}}function l(u){if(r)throw new TypeError("Generator is already executing.");for(;t;)try{if(r=1,n&&(a=u[0]&2?n.return:u[0]?n.throw||((a=n.return)&&a.call(n),0):n.next)&&!(a=a.call(n,u[1])).done)return a;switch(n=0,a&&(u=[u[0]&2,a.value]),u[0]){case 0:case 1:a=u;break;case 4:return t.label++,{value:u[1],done:!1};case 5:t.label++,n=u[1],u=[0];continue;case 7:u=t.ops.pop(),t.trys.pop();continue;default:if(a=t.trys,!(a=a.length>0&&a[a.length-1])&&(u[0]===6||u[0]===2)){t=0;continue}if(u[0]===3&&(!a||u[1]>a[0]&&u[1]<a[3])){t.label=u[1];break}if(u[0]===6&&t.label<a[1]){t.label=a[1],a=u;break}if(a&&t.label<a[2]){t.label=a[2],t.ops.push(u);break}a[2]&&t.ops.pop(),t.trys.pop();continue}u=e.call(i,t)}catch(f){u=[6,f],n=0}finally{r=a=0}if(u[0]&5)throw u[1];return{value:u[0]?u[1]:void 0,done:!0}}}function ho(i,e,t){if(t||arguments.length===2)for(var r=0,n=e.length,a;r<n;r++)(a||!(r in e))&&(a||(a=Array.prototype.slice.call(e,0,r)),a[r]=e[r]);return i.concat(a||Array.prototype.slice.call(e))}var co=function(){function i(){}return i.Eval=function(e,t){return e.match(/\([^()]*\)/g)?e=e.replace(/\([^()]*\)/g,function(r){return r=r.slice(1,r.length-1),i._HandleParenthesisContent(r,t)}):e=i._HandleParenthesisContent(e,t),e==="true"?!0:e==="false"?!1:i.Eval(e,t)},i._HandleParenthesisContent=function(e,t){t=t||function(f){return f==="true"};var r,n=e.split("||");for(var a in n)if(Object.prototype.hasOwnProperty.call(n,a)){var s=i._SimplifyNegation(n[a].trim()),o=s.split("&&");if(o.length>1)for(var l=0;l<o.length;++l){var u=i._SimplifyNegation(o[l].trim());if(u!=="true"&&u!=="false"?u[0]==="!"?r=!t(u.substring(1)):r=t(u):r=u==="true",!r){s="false";break}}if(r||s==="true"){r=!0;break}s!=="true"&&s!=="false"?s[0]==="!"?r=!t(s.substring(1)):r=t(s):r=s==="true"}return r?"true":"false"},i._SimplifyNegation=function(e){return e=e.replace(/^[\s!]+/,function(t){return t=t.replace(/[\s]/g,function(){return""}),t.length%2?"!":""}),e=e.trim(),e==="!true"?e="false":e==="!false"&&(e="true"),e},i}(),Le=function(){function i(){}return i.EnableFor=function(e){e._tags=e._tags||{},e.hasTags=function(){return i.HasTags(e)},e.addTags=function(t){return i.AddTagsTo(e,t)},e.removeTags=function(t){return i.RemoveTagsFrom(e,t)},e.matchesTagsQuery=function(t){return i.MatchesQuery(e,t)}},i.DisableFor=function(e){delete e._tags,delete e.hasTags,delete e.addTags,delete e.removeTags,delete e.matchesTagsQuery},i.HasTags=function(e){if(!e._tags)return!1;var t=e._tags;for(var r in t)if(Object.prototype.hasOwnProperty.call(t,r))return!0;return!1},i.GetTags=function(e,t){if(t===void 0&&(t=!0),!e._tags)return null;if(t){var r=[];for(var n in e._tags)Object.prototype.hasOwnProperty.call(e._tags,n)&&e._tags[n]===!0&&r.push(n);return r.join(" ")}else return e._tags},i.AddTagsTo=function(e,t){if(!!t&&typeof t=="string"){var r=t.split(" ");r.forEach(function(n){i._AddTagTo(e,n)})}},i._AddTagTo=function(e,t){t=t.trim(),!(t===""||t==="true"||t==="false")&&(t.match(/[\s]/)||t.match(/^([!]|([|]|[&]){2})/)||(i.EnableFor(e),e._tags[t]=!0))},i.RemoveTagsFrom=function(e,t){if(!!i.HasTags(e)){var r=t.split(" ");for(var n in r)i._RemoveTagFrom(e,r[n])}},i._RemoveTagFrom=function(e,t){delete e._tags[t]},i.MatchesQuery=function(e,t){return t===void 0?!0:t===""?i.HasTags(e):co.Eval(t,function(r){return i.HasTags(e)&&e._tags[r]})},i}();function he(i){return"".concat(i," needs to be imported before as it contains a side-effect required by your code.")}var me=function(){function i(e,t,r){e===void 0&&(e=0),t===void 0&&(t=0),r===void 0&&(r=0),this.r=e,this.g=t,this.b=r}return i.prototype.toString=function(){return"{R: "+this.r+" G:"+this.g+" B:"+this.b+"}"},i.prototype.getClassName=function(){return"Color3"},i.prototype.getHashCode=function(){var e=this.r*255|0;return e=e*397^(this.g*255|0),e=e*397^(this.b*255|0),e},i.prototype.toArray=function(e,t){return t===void 0&&(t=0),e[t]=this.r,e[t+1]=this.g,e[t+2]=this.b,this},i.prototype.fromArray=function(e,t){return t===void 0&&(t=0),i.FromArrayToRef(e,t,this),this},i.prototype.toColor4=function(e){return e===void 0&&(e=1),new ce(this.r,this.g,this.b,e)},i.prototype.asArray=function(){var e=new Array;return this.toArray(e,0),e},i.prototype.toLuminance=function(){return this.r*.3+this.g*.59+this.b*.11},i.prototype.multiply=function(e){return new i(this.r*e.r,this.g*e.g,this.b*e.b)},i.prototype.multiplyToRef=function(e,t){return t.r=this.r*e.r,t.g=this.g*e.g,t.b=this.b*e.b,this},i.prototype.equals=function(e){return e&&this.r===e.r&&this.g===e.g&&this.b===e.b},i.prototype.equalsFloats=function(e,t,r){return this.r===e&&this.g===t&&this.b===r},i.prototype.scale=function(e){return new i(this.r*e,this.g*e,this.b*e)},i.prototype.scaleToRef=function(e,t){return t.r=this.r*e,t.g=this.g*e,t.b=this.b*e,this},i.prototype.scaleAndAddToRef=function(e,t){return t.r+=this.r*e,t.g+=this.g*e,t.b+=this.b*e,this},i.prototype.clampToRef=function(e,t,r){return e===void 0&&(e=0),t===void 0&&(t=1),r.r=K.Clamp(this.r,e,t),r.g=K.Clamp(this.g,e,t),r.b=K.Clamp(this.b,e,t),this},i.prototype.add=function(e){return new i(this.r+e.r,this.g+e.g,this.b+e.b)},i.prototype.addToRef=function(e,t){return t.r=this.r+e.r,t.g=this.g+e.g,t.b=this.b+e.b,this},i.prototype.subtract=function(e){return new i(this.r-e.r,this.g-e.g,this.b-e.b)},i.prototype.subtractToRef=function(e,t){return t.r=this.r-e.r,t.g=this.g-e.g,t.b=this.b-e.b,this},i.prototype.clone=function(){return new i(this.r,this.g,this.b)},i.prototype.copyFrom=function(e){return this.r=e.r,this.g=e.g,this.b=e.b,this},i.prototype.copyFromFloats=function(e,t,r){return this.r=e,this.g=t,this.b=r,this},i.prototype.set=function(e,t,r){return this.copyFromFloats(e,t,r)},i.prototype.toHexString=function(){var e=Math.round(this.r*255),t=Math.round(this.g*255),r=Math.round(this.b*255);return"#"+K.ToHex(e)+K.ToHex(t)+K.ToHex(r)},i.prototype.toLinearSpace=function(){var e=new i;return this.toLinearSpaceToRef(e),e},i.prototype.toHSV=function(){var e=new i;return this.toHSVToRef(e),e},i.prototype.toHSVToRef=function(e){var t=this.r,r=this.g,n=this.b,a=Math.max(t,r,n),s=Math.min(t,r,n),o=0,l=0,u=a,f=a-s;a!==0&&(l=f/a),a!=s&&(a==t?(o=(r-n)/f,r<n&&(o+=6)):a==r?o=(n-t)/f+2:a==n&&(o=(t-r)/f+4),o*=60),e.r=o,e.g=l,e.b=u},i.prototype.toLinearSpaceToRef=function(e){return e.r=Math.pow(this.r,Nt),e.g=Math.pow(this.g,Nt),e.b=Math.pow(this.b,Nt),this},i.prototype.toGammaSpace=function(){var e=new i;return this.toGammaSpaceToRef(e),e},i.prototype.toGammaSpaceToRef=function(e){return e.r=Math.pow(this.r,Lt),e.g=Math.pow(this.g,Lt),e.b=Math.pow(this.b,Lt),this},i.HSVtoRGBToRef=function(e,t,r,n){var a=r*t,s=e/60,o=a*(1-Math.abs(s%2-1)),l=0,u=0,f=0;s>=0&&s<=1?(l=a,u=o):s>=1&&s<=2?(l=o,u=a):s>=2&&s<=3?(u=a,f=o):s>=3&&s<=4?(u=o,f=a):s>=4&&s<=5?(l=o,f=a):s>=5&&s<=6&&(l=a,f=o);var h=r-a;n.set(l+h,u+h,f+h)},i.FromHexString=function(e){if(e.substring(0,1)!=="#"||e.length!==7)return new i(0,0,0);var t=parseInt(e.substring(1,3),16),r=parseInt(e.substring(3,5),16),n=parseInt(e.substring(5,7),16);return i.FromInts(t,r,n)},i.FromArray=function(e,t){return t===void 0&&(t=0),new i(e[t],e[t+1],e[t+2])},i.FromArrayToRef=function(e,t,r){t===void 0&&(t=0),r.r=e[t],r.g=e[t+1],r.b=e[t+2]},i.FromInts=function(e,t,r){return new i(e/255,t/255,r/255)},i.Lerp=function(e,t,r){var n=new i(0,0,0);return i.LerpToRef(e,t,r,n),n},i.LerpToRef=function(e,t,r,n){n.r=e.r+(t.r-e.r)*r,n.g=e.g+(t.g-e.g)*r,n.b=e.b+(t.b-e.b)*r},i.Hermite=function(e,t,r,n,a){var s=a*a,o=a*s,l=2*o-3*s+1,u=-2*o+3*s,f=o-2*s+a,h=o-s,c=e.r*l+r.r*u+t.r*f+n.r*h,d=e.g*l+r.g*u+t.g*f+n.g*h,p=e.b*l+r.b*u+t.b*f+n.b*h;return new i(c,d,p)},i.Hermite1stDerivative=function(e,t,r,n,a){var s=i.Black();return this.Hermite1stDerivativeToRef(e,t,r,n,a,s),s},i.Hermite1stDerivativeToRef=function(e,t,r,n,a,s){var o=a*a;s.r=(o-a)*6*e.r+(3*o-4*a+1)*t.r+(-o+a)*6*r.r+(3*o-2*a)*n.r,s.g=(o-a)*6*e.g+(3*o-4*a+1)*t.g+(-o+a)*6*r.g+(3*o-2*a)*n.g,s.b=(o-a)*6*e.b+(3*o-4*a+1)*t.b+(-o+a)*6*r.b+(3*o-2*a)*n.b},i.Red=function(){return new i(1,0,0)},i.Green=function(){return new i(0,1,0)},i.Blue=function(){return new i(0,0,1)},i.Black=function(){return new i(0,0,0)},Object.defineProperty(i,"BlackReadOnly",{get:function(){return i._BlackReadOnly},enumerable:!1,configurable:!0}),i.White=function(){return new i(1,1,1)},i.Purple=function(){return new i(.5,0,.5)},i.Magenta=function(){return new i(1,0,1)},i.Yellow=function(){return new i(1,1,0)},i.Gray=function(){return new i(.5,.5,.5)},i.Teal=function(){return new i(0,1,1)},i.Random=function(){return new i(Math.random(),Math.random(),Math.random())},i._BlackReadOnly=i.Black(),i}(),ce=function(){function i(e,t,r,n){e===void 0&&(e=0),t===void 0&&(t=0),r===void 0&&(r=0),n===void 0&&(n=1),this.r=e,this.g=t,this.b=r,this.a=n}return i.prototype.addInPlace=function(e){return this.r+=e.r,this.g+=e.g,this.b+=e.b,this.a+=e.a,this},i.prototype.asArray=function(){var e=new Array;return this.toArray(e,0),e},i.prototype.toArray=function(e,t){return t===void 0&&(t=0),e[t]=this.r,e[t+1]=this.g,e[t+2]=this.b,e[t+3]=this.a,this},i.prototype.fromArray=function(e,t){return t===void 0&&(t=0),i.FromArrayToRef(e,t,this),this},i.prototype.equals=function(e){return e&&this.r===e.r&&this.g===e.g&&this.b===e.b&&this.a===e.a},i.prototype.add=function(e){return new i(this.r+e.r,this.g+e.g,this.b+e.b,this.a+e.a)},i.prototype.subtract=function(e){return new i(this.r-e.r,this.g-e.g,this.b-e.b,this.a-e.a)},i.prototype.subtractToRef=function(e,t){return t.r=this.r-e.r,t.g=this.g-e.g,t.b=this.b-e.b,t.a=this.a-e.a,this},i.prototype.scale=function(e){return new i(this.r*e,this.g*e,this.b*e,this.a*e)},i.prototype.scaleToRef=function(e,t){return t.r=this.r*e,t.g=this.g*e,t.b=this.b*e,t.a=this.a*e,this},i.prototype.scaleAndAddToRef=function(e,t){return t.r+=this.r*e,t.g+=this.g*e,t.b+=this.b*e,t.a+=this.a*e,this},i.prototype.clampToRef=function(e,t,r){return e===void 0&&(e=0),t===void 0&&(t=1),r.r=K.Clamp(this.r,e,t),r.g=K.Clamp(this.g,e,t),r.b=K.Clamp(this.b,e,t),r.a=K.Clamp(this.a,e,t),this},i.prototype.multiply=function(e){return new i(this.r*e.r,this.g*e.g,this.b*e.b,this.a*e.a)},i.prototype.multiplyToRef=function(e,t){return t.r=this.r*e.r,t.g=this.g*e.g,t.b=this.b*e.b,t.a=this.a*e.a,t},i.prototype.toString=function(){return"{R: "+this.r+" G:"+this.g+" B:"+this.b+" A:"+this.a+"}"},i.prototype.getClassName=function(){return"Color4"},i.prototype.getHashCode=function(){var e=this.r*255|0;return e=e*397^(this.g*255|0),e=e*397^(this.b*255|0),e=e*397^(this.a*255|0),e},i.prototype.clone=function(){return new i(this.r,this.g,this.b,this.a)},i.prototype.copyFrom=function(e){return this.r=e.r,this.g=e.g,this.b=e.b,this.a=e.a,this},i.prototype.copyFromFloats=function(e,t,r,n){return this.r=e,this.g=t,this.b=r,this.a=n,this},i.prototype.set=function(e,t,r,n){return this.copyFromFloats(e,t,r,n)},i.prototype.toHexString=function(e){e===void 0&&(e=!1);var t=Math.round(this.r*255),r=Math.round(this.g*255),n=Math.round(this.b*255);if(e)return"#"+K.ToHex(t)+K.ToHex(r)+K.ToHex(n);var a=Math.round(this.a*255);return"#"+K.ToHex(t)+K.ToHex(r)+K.ToHex(n)+K.ToHex(a)},i.prototype.toLinearSpace=function(){var e=new i;return this.toLinearSpaceToRef(e),e},i.prototype.toLinearSpaceToRef=function(e){return e.r=Math.pow(this.r,Nt),e.g=Math.pow(this.g,Nt),e.b=Math.pow(this.b,Nt),e.a=this.a,this},i.prototype.toGammaSpace=function(){var e=new i;return this.toGammaSpaceToRef(e),e},i.prototype.toGammaSpaceToRef=function(e){return e.r=Math.pow(this.r,Lt),e.g=Math.pow(this.g,Lt),e.b=Math.pow(this.b,Lt),e.a=this.a,this},i.FromHexString=function(e){if(e.substring(0,1)!=="#"||e.length!==9&&e.length!==7)return new i(0,0,0,0);var t=parseInt(e.substring(1,3),16),r=parseInt(e.substring(3,5),16),n=parseInt(e.substring(5,7),16),a=e.length===9?parseInt(e.substring(7,9),16):255;return i.FromInts(t,r,n,a)},i.Lerp=function(e,t,r){var n=new i(0,0,0,0);return i.LerpToRef(e,t,r,n),n},i.LerpToRef=function(e,t,r,n){n.r=e.r+(t.r-e.r)*r,n.g=e.g+(t.g-e.g)*r,n.b=e.b+(t.b-e.b)*r,n.a=e.a+(t.a-e.a)*r},i.Hermite=function(e,t,r,n,a){var s=a*a,o=a*s,l=2*o-3*s+1,u=-2*o+3*s,f=o-2*s+a,h=o-s,c=e.r*l+r.r*u+t.r*f+n.r*h,d=e.g*l+r.g*u+t.g*f+n.g*h,p=e.b*l+r.b*u+t.b*f+n.b*h,_=e.a*l+r.a*u+t.a*f+n.a*h;return new i(c,d,p,_)},i.Hermite1stDerivative=function(e,t,r,n,a){var s=new i;return this.Hermite1stDerivativeToRef(e,t,r,n,a,s),s},i.Hermite1stDerivativeToRef=function(e,t,r,n,a,s){var o=a*a;s.r=(o-a)*6*e.r+(3*o-4*a+1)*t.r+(-o+a)*6*r.r+(3*o-2*a)*n.r,s.g=(o-a)*6*e.g+(3*o-4*a+1)*t.g+(-o+a)*6*r.g+(3*o-2*a)*n.g,s.b=(o-a)*6*e.b+(3*o-4*a+1)*t.b+(-o+a)*6*r.b+(3*o-2*a)*n.b,s.a=(o-a)*6*e.a+(3*o-4*a+1)*t.a+(-o+a)*6*r.a+(3*o-2*a)*n.a},i.FromColor3=function(e,t){return t===void 0&&(t=1),new i(e.r,e.g,e.b,t)},i.FromArray=function(e,t){return t===void 0&&(t=0),new i(e[t],e[t+1],e[t+2],e[t+3])},i.FromArrayToRef=function(e,t,r){t===void 0&&(t=0),r.r=e[t],r.g=e[t+1],r.b=e[t+2],r.a=e[t+3]},i.FromInts=function(e,t,r,n){return new i(e/255,t/255,r/255,n/255)},i.CheckColors4=function(e,t){if(e.length===t*3){for(var r=[],n=0;n<e.length;n+=3){var a=n/3*4;r[a]=e[n],r[a+1]=e[n+1],r[a+2]=e[n+2],r[a+3]=1}return r}return e},i}(),Ar=function(){function i(){}return i.Color3=je.BuildArray(3,me.Black),i.Color4=je.BuildArray(3,function(){return new ce(0,0,0,0)}),i}();We("BABYLON.Color3",me);We("BABYLON.Color4",ce);var Hr={},kr={},Mn=function(i,e,t){var r=i();Le&&Le.AddTagsTo(r,e.tags);var n=wi(r);for(var a in n){var s=n[a],o=e[a],l=s.type;if(o!=null&&(a!=="uniqueId"||pe.AllowLoadingUniqueId))switch(l){case 0:case 6:case 11:r[a]=o;break;case 1:r[a]=t||o.isRenderTarget?o:o.clone();break;case 2:case 3:case 4:case 5:case 7:case 10:case 12:r[a]=t?o:o.clone();break}}return r};function po(i){var e=i.getClassName();return Hr[e]||(Hr[e]={}),Hr[e]}function wi(i){var e=i.getClassName();if(kr[e])return kr[e];kr[e]={};for(var t=kr[e],r=i,n=e;n;){var a=Hr[n];for(var s in a)t[s]=a[s];var o=void 0,l=!1;do{if(o=Object.getPrototypeOf(r),!o.getClassName){l=!0;break}if(o.getClassName()!==n)break;r=o}while(o);if(l)break;n=o.getClassName(),r=o}return t}function mt(i,e){return function(t,r){var n=po(t);n[r]||(n[r]={type:i,sourceName:e})}}function _o(i,e){return e===void 0&&(e=null),function(t,r){var n=e||"_"+r;Object.defineProperty(t,r,{get:function(){return this[n]},set:function(a){typeof this.equals=="function"&&this.equals(a)||this[n]!==a&&(this[n]=a,t[i].apply(this))},enumerable:!0,configurable:!0})}}function ve(i,e){return e===void 0&&(e=null),_o(i,e)}function I(i){return mt(0,i)}function ot(i){return mt(1,i)}function wt(i){return mt(2,i)}function br(i){return mt(3,i)}function Pa(i){return mt(4,i)}function xt(i){return mt(5,i)}function Ma(i){return mt(6,i)}function vo(i){return mt(7,i)}function Ca(i){return mt(8,i)}function go(i){return mt(9,i)}function mo(i){return mt(10,i)}function yo(i){return mt(12,i)}var pe=function(){function i(){}return i.AppendSerializedAnimations=function(e,t){if(e.animations){t.animations=[];for(var r=0;r<e.animations.length;r++){var n=e.animations[r];t.animations.push(n.serialize())}}},i.Serialize=function(e,t){t||(t={}),Le&&(t.tags=Le.GetTags(e));var r=wi(e);for(var n in r){var a=r[n],s=a.sourceName||n,o=a.type,l=e[n];if(l!=null&&(n!=="uniqueId"||i.AllowLoadingUniqueId))switch(o){case 0:t[s]=l;break;case 1:t[s]=l.serialize();break;case 2:t[s]=l.asArray();break;case 3:t[s]=l.serialize();break;case 4:t[s]=l.asArray();break;case 5:t[s]=l.asArray();break;case 6:t[s]=l.id;break;case 7:t[s]=l.serialize();break;case 8:t[s]=l.asArray();break;case 9:t[s]=l.serialize();break;case 10:t[s]=l.asArray();break;case 11:t[s]=l.id;break;case 12:t[s]=l.asArray();break}}return t},i.Parse=function(e,t,r,n){n===void 0&&(n=null);var a=e();n||(n=""),Le&&Le.AddTagsTo(a,t.tags);var s=wi(a);for(var o in s){var l=s[o],u=t[l.sourceName||o],f=l.type;if(u!=null&&(o!=="uniqueId"||i.AllowLoadingUniqueId)){var h=a;switch(f){case 0:h[o]=u;break;case 1:r&&(h[o]=i._TextureParser(u,r,n));break;case 2:h[o]=me.FromArray(u);break;case 3:h[o]=i._FresnelParametersParser(u);break;case 4:h[o]=se.FromArray(u);break;case 5:h[o]=m.FromArray(u);break;case 6:r&&(h[o]=r.getLastMeshById(u));break;case 7:h[o]=i._ColorCurvesParser(u);break;case 8:h[o]=ce.FromArray(u);break;case 9:h[o]=i._ImageProcessingConfigurationParser(u);break;case 10:h[o]=de.FromArray(u);break;case 11:r&&(h[o]=r.getCameraById(u));break;case 12:h[o]=G.FromArray(u);break}}}return a},i.Clone=function(e,t){return Mn(e,t,!1)},i.Instanciate=function(e,t){return Mn(e,t,!0)},i.AllowLoadingUniqueId=!1,i._ImageProcessingConfigurationParser=function(e){throw he("ImageProcessingConfiguration")},i._FresnelParametersParser=function(e){throw he("FresnelParameters")},i._ColorCurvesParser=function(e){throw he("ColorCurves")},i._TextureParser=function(e,t,r){throw he("Texture")},i}();function Zt(i,e,t,r){var n=t.value;t.value=function(){for(var a=[],s=0;s<arguments.length;s++)a[s]=arguments[s];var o=n;if(typeof _native!="undefined"&&_native[e]){var l=_native[e];r?o=function(){for(var u=[],f=0;f<arguments.length;f++)u[f]=arguments[f];return r.apply(void 0,u)?l.apply(void 0,u):n.apply(void 0,u)}:o=l}return i[e]=o,o.apply(void 0,a)}}Zt.filter=function(i){return function(e,t,r){return Zt(e,t,r,i)}};var xa=function(){function i(){this.references=0,this.capacity=0,this.is32Bits=!1,this.uniqueId=i._Counter++}return Object.defineProperty(i.prototype,"underlyingResource",{get:function(){return null},enumerable:!1,configurable:!0}),i._Counter=0,i}(),Dr=function(){function i(){}return i.Slice=function(e,t,r){return e.slice?e.slice(t,r):Array.prototype.slice.call(e,t,r)},i.SliceToArray=function(e,t,r){return Array.isArray(e)?e.slice(t,r):Array.prototype.slice.call(e,t,r)},i}(),mr=function(){function i(e,t,r,n,a,s,o,l){n===void 0&&(n=0),a===void 0&&(a=!1),s===void 0&&(s=!1),o===void 0&&(o=!1),this._isAlreadyOwned=!1,e.getScene?this._engine=e.getScene().getEngine():this._engine=e,this._updatable=r,this._instanced=s,this._divisor=l||1,t instanceof xa?(this._data=null,this._buffer=t):(this._data=t,this._buffer=null),this.byteStride=o?n:n*Float32Array.BYTES_PER_ELEMENT,a||this.create()}return i.prototype.createVertexBuffer=function(e,t,r,n,a,s,o){s===void 0&&(s=!1);var l=s?t:t*Float32Array.BYTES_PER_ELEMENT,u=n?s?n:n*Float32Array.BYTES_PER_ELEMENT:this.byteStride;return new R(this._engine,this,e,this._updatable,!0,u,a===void 0?this._instanced:a,l,r,void 0,void 0,!0,this._divisor||o)},i.prototype.isUpdatable=function(){return this._updatable},i.prototype.getData=function(){return this._data},i.prototype.getBuffer=function(){return this._buffer},i.prototype.getStrideSize=function(){return this.byteStride/Float32Array.BYTES_PER_ELEMENT},i.prototype.create=function(e){e===void 0&&(e=null),!(!e&&this._buffer)&&(e=e||this._data,e&&(this._buffer?this._updatable&&(this._engine.updateDynamicVertexBuffer(this._buffer,e),this._data=e):this._updatable?(this._buffer=this._engine.createDynamicVertexBuffer(e),this._data=e):this._buffer=this._engine.createVertexBuffer(e)))},i.prototype._rebuild=function(){this._buffer=null,this.create(this._data)},i.prototype.update=function(e){this.create(e)},i.prototype.updateDirectly=function(e,t,r,n){n===void 0&&(n=!1),!!this._buffer&&this._updatable&&(this._engine.updateDynamicVertexBuffer(this._buffer,e,n?t:t*Float32Array.BYTES_PER_ELEMENT,r?r*this.byteStride:void 0),t===0&&r===void 0?this._data=e:this._data=null)},i.prototype._increaseReferences=function(){if(!!this._buffer){if(!this._isAlreadyOwned){this._isAlreadyOwned=!0;return}this._buffer.references++}},i.prototype.dispose=function(){!this._buffer||this._engine._releaseBuffer(this._buffer)&&(this._buffer=null,this._data=null)},i}(),R=function(){function i(e,t,r,n,a,s,o,l,u,f,h,c,d,p){if(h===void 0&&(h=!1),c===void 0&&(c=!1),d===void 0&&(d=1),p===void 0&&(p=!1),t instanceof mr?(this._buffer=t,this._ownsBuffer=p):(this._buffer=new mr(e,t,n,s,a,o,c),this._ownsBuffer=!0),this.uniqueId=i._Counter++,this._kind=r,f==null){var _=this.getData();this.type=i.FLOAT,_ instanceof Int8Array?this.type=i.BYTE:_ instanceof Uint8Array?this.type=i.UNSIGNED_BYTE:_ instanceof Int16Array?this.type=i.SHORT:_ instanceof Uint16Array?this.type=i.UNSIGNED_SHORT:_ instanceof Int32Array?this.type=i.INT:_ instanceof Uint32Array&&(this.type=i.UNSIGNED_INT)}else this.type=f;var g=i.GetTypeByteLength(this.type);c?(this._size=u||(s?s/g:i.DeduceStride(r)),this.byteStride=s||this._buffer.byteStride||this._size*g,this.byteOffset=l||0):(this._size=u||s||i.DeduceStride(r),this.byteStride=s?s*g:this._buffer.byteStride||this._size*g,this.byteOffset=(l||0)*g),this.normalized=h,this._instanced=o!==void 0?o:!1,this._instanceDivisor=o?d:0,this._computeHashCode()}return Object.defineProperty(i.prototype,"instanceDivisor",{get:function(){return this._instanceDivisor},set:function(e){this._instanceDivisor=e,e==0?this._instanced=!1:this._instanced=!0,this._computeHashCode()},enumerable:!1,configurable:!0}),i.prototype._computeHashCode=function(){this.hashCode=(this.type-5120<<0)+((this.normalized?1:0)<<3)+(this._size<<4)+((this._instanced?1:0)<<6)+(this.byteStride<<12)},i.prototype._rebuild=function(){!this._buffer||this._buffer._rebuild()},i.prototype.getKind=function(){return this._kind},i.prototype.isUpdatable=function(){return this._buffer.isUpdatable()},i.prototype.getData=function(){return this._buffer.getData()},i.prototype.getFloatData=function(e,t){var r=this.getData();if(!r)return null;var n=this.getSize()*i.GetTypeByteLength(this.type),a=e*this.getSize();if(this.type!==i.FLOAT||this.byteStride!==n){var s=new Float32Array(a);return this.forEach(a,function(h,c){return s[c]=h}),s}if(!(r instanceof Array||r instanceof Float32Array)||this.byteOffset!==0||r.length!==a)if(r instanceof Array){var o=this.byteOffset/4;return Dr.Slice(r,o,o+a)}else{if(r instanceof ArrayBuffer)return new Float32Array(r,this.byteOffset,a);var o=r.byteOffset+this.byteOffset;if(t){var l=new Float32Array(a),u=new Float32Array(r.buffer,o,a);return l.set(u),l}var f=o%4;return f&&(o=Math.max(0,o-f)),new Float32Array(r.buffer,o,a)}return t?Dr.Slice(r):r},i.prototype.getBuffer=function(){return this._buffer.getBuffer()},i.prototype.getStrideSize=function(){return this.byteStride/i.GetTypeByteLength(this.type)},i.prototype.getOffset=function(){return this.byteOffset/i.GetTypeByteLength(this.type)},i.prototype.getSize=function(e){return e===void 0&&(e=!1),e?this._size*i.GetTypeByteLength(this.type):this._size},i.prototype.getIsInstanced=function(){return this._instanced},i.prototype.getInstanceDivisor=function(){return this._instanceDivisor},i.prototype.create=function(e){this._buffer.create(e)},i.prototype.update=function(e){this._buffer.update(e)},i.prototype.updateDirectly=function(e,t,r){r===void 0&&(r=!1),this._buffer.updateDirectly(e,t,void 0,r)},i.prototype.dispose=function(){this._ownsBuffer&&this._buffer.dispose()},i.prototype.forEach=function(e,t){i.ForEach(this._buffer.getData(),this.byteOffset,this.byteStride,this._size,this.type,e,this.normalized,t)},i.DeduceStride=function(e){switch(e){case i.UVKind:case i.UV2Kind:case i.UV3Kind:case i.UV4Kind:case i.UV5Kind:case i.UV6Kind:return 2;case i.NormalKind:case i.PositionKind:return 3;case i.ColorKind:case i.MatricesIndicesKind:case i.MatricesIndicesExtraKind:case i.MatricesWeightsKind:case i.MatricesWeightsExtraKind:case i.TangentKind:return 4;default:throw new Error("Invalid kind '"+e+"'")}},i.GetTypeByteLength=function(e){switch(e){case i.BYTE:case i.UNSIGNED_BYTE:return 1;case i.SHORT:case i.UNSIGNED_SHORT:return 2;case i.INT:case i.UNSIGNED_INT:case i.FLOAT:return 4;default:throw new Error("Invalid type '".concat(e,"'"))}},i.ForEach=function(e,t,r,n,a,s,o,l){if(e instanceof Array)for(var u=t/4,f=r/4,h=0;h<s;h+=n){for(var c=0;c<n;c++)l(e[u+c],h+c);u+=f}else for(var d=e instanceof ArrayBuffer?new DataView(e):new DataView(e.buffer,e.byteOffset,e.byteLength),p=i.GetTypeByteLength(a),h=0;h<s;h+=n){for(var _=t,c=0;c<n;c++){var g=i._GetFloatValue(d,a,_,o);l(g,h+c),_+=p}t+=r}},i._GetFloatValue=function(e,t,r,n){switch(t){case i.BYTE:{var a=e.getInt8(r);return n&&(a=Math.max(a/127,-1)),a}case i.UNSIGNED_BYTE:{var a=e.getUint8(r);return n&&(a=a/255),a}case i.SHORT:{var a=e.getInt16(r,!0);return n&&(a=Math.max(a/32767,-1)),a}case i.UNSIGNED_SHORT:{var a=e.getUint16(r,!0);return n&&(a=a/65535),a}case i.INT:return e.getInt32(r,!0);case i.UNSIGNED_INT:return e.getUint32(r,!0);case i.FLOAT:return e.getFloat32(r,!0);default:throw new Error("Invalid component type ".concat(t))}},i._Counter=0,i.BYTE=5120,i.UNSIGNED_BYTE=5121,i.SHORT=5122,i.UNSIGNED_SHORT=5123,i.INT=5124,i.UNSIGNED_INT=5125,i.FLOAT=5126,i.PositionKind="position",i.NormalKind="normal",i.TangentKind="tangent",i.UVKind="uv",i.UV2Kind="uv2",i.UV3Kind="uv3",i.UV4Kind="uv4",i.UV5Kind="uv5",i.UV6Kind="uv6",i.ColorKind="color",i.ColorInstanceKind="instanceColor",i.MatricesIndicesKind="matricesIndices",i.MatricesWeightsKind="matricesWeights",i.MatricesIndicesExtraKind="matricesIndicesExtra",i.MatricesWeightsExtraKind="matricesWeightsExtra",i}(),Da=function(){function i(e,t,r,n){t===void 0&&(t=!1),this.initialize(e,t,r,n)}return i.prototype.initialize=function(e,t,r,n){return t===void 0&&(t=!1),this.mask=e,this.skipNextObservers=t,this.target=r,this.currentTarget=n,this},i}(),bo=function(){function i(e,t,r){r===void 0&&(r=null),this.callback=e,this.mask=t,this.scope=r,this._willBeUnregistered=!1,this.unregisterOnNextCall=!1}return i}(),X=function(){function i(e){this._observers=new Array,this._eventState=new Da(0),e&&(this._onObserverAdded=e)}return i.FromPromise=function(e,t){var r=new i;return e.then(function(n){r.notifyObservers(n)}).catch(function(n){if(t)t.notifyObservers(n);else throw n}),r},Object.defineProperty(i.prototype,"observers",{get:function(){return this._observers},enumerable:!1,configurable:!0}),i.prototype.add=function(e,t,r,n,a){if(t===void 0&&(t=-1),r===void 0&&(r=!1),n===void 0&&(n=null),a===void 0&&(a=!1),!e)return null;var s=new bo(e,t,n);return s.unregisterOnNextCall=a,r?this._observers.unshift(s):this._observers.push(s),this._onObserverAdded&&this._onObserverAdded(s),s},i.prototype.addOnce=function(e){return this.add(e,void 0,void 0,void 0,!0)},i.prototype.remove=function(e){if(!e)return!1;var t=this._observers.indexOf(e);return t!==-1?(this._deferUnregister(e),!0):!1},i.prototype.removeCallback=function(e,t){for(var r=0;r<this._observers.length;r++){var n=this._observers[r];if(!n._willBeUnregistered&&n.callback===e&&(!t||t===n.scope))return this._deferUnregister(n),!0}return!1},i.prototype._deferUnregister=function(e){var t=this;e.unregisterOnNextCall=!1,e._willBeUnregistered=!0,setTimeout(function(){t._remove(e)},0)},i.prototype._remove=function(e){if(!e)return!1;var t=this._observers.indexOf(e);return t!==-1?(this._observers.splice(t,1),!0):!1},i.prototype.makeObserverTopPriority=function(e){this._remove(e),this._observers.unshift(e)},i.prototype.makeObserverBottomPriority=function(e){this._remove(e),this._observers.push(e)},i.prototype.notifyObservers=function(e,t,r,n,a){if(t===void 0&&(t=-1),!this._observers.length)return!0;var s=this._eventState;s.mask=t,s.target=r,s.currentTarget=n,s.skipNextObservers=!1,s.lastReturnValue=e,s.userInfo=a;for(var o=0,l=this._observers;o<l.length;o++){var u=l[o];if(!u._willBeUnregistered&&(u.mask&t&&(u.scope?s.lastReturnValue=u.callback.apply(u.scope,[e,s]):s.lastReturnValue=u.callback(e,s),u.unregisterOnNextCall&&this._deferUnregister(u)),s.skipNextObservers))return!1}return!0},i.prototype.notifyObserversWithPromise=function(e,t,r,n,a){var s=this;t===void 0&&(t=-1);var o=Promise.resolve(e);if(!this._observers.length)return o;var l=this._eventState;return l.mask=t,l.target=r,l.currentTarget=n,l.skipNextObservers=!1,l.userInfo=a,this._observers.forEach(function(u){l.skipNextObservers||u._willBeUnregistered||u.mask&t&&(u.scope?o=o.then(function(f){return l.lastReturnValue=f,u.callback.apply(u.scope,[e,l])}):o=o.then(function(f){return l.lastReturnValue=f,u.callback(e,l)}),u.unregisterOnNextCall&&s._deferUnregister(u))}),o.then(function(){return e})},i.prototype.notifyObserver=function(e,t,r){if(r===void 0&&(r=-1),!e._willBeUnregistered){var n=this._eventState;n.mask=r,n.skipNextObservers=!1,e.callback(t,n),e.unregisterOnNextCall&&this._deferUnregister(e)}},i.prototype.hasObservers=function(){return this._observers.length>0},i.prototype.clear=function(){this._observers=new Array,this._onObserverAdded=null},i.prototype.clone=function(){var e=new i;return e._observers=this._observers.slice(0),e},i.prototype.hasSpecificMask=function(e){e===void 0&&(e=-1);for(var t=0,r=this._observers;t<r.length;t++){var n=r[t];if(n.mask&e||n.mask===e)return!0}return!1},i}();function Zi(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(i){var e=Math.random()*16|0,t=i==="x"?e:e&3|8;return t.toString(16)})}function To(){return typeof _native!="undefined"&&_native.XMLHttpRequest?new _native.XMLHttpRequest:new XMLHttpRequest}var Jt=function(){function i(){this._xhr=To()}return i.prototype._injectCustomRequestHeaders=function(){for(var e in i.CustomRequestHeaders){var t=i.CustomRequestHeaders[e];t&&this._xhr.setRequestHeader(e,t)}},Object.defineProperty(i.prototype,"onprogress",{get:function(){return this._xhr.onprogress},set:function(e){this._xhr.onprogress=e},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"readyState",{get:function(){return this._xhr.readyState},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"status",{get:function(){return this._xhr.status},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"statusText",{get:function(){return this._xhr.statusText},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"response",{get:function(){return this._xhr.response},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"responseURL",{get:function(){return this._xhr.responseURL},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"responseText",{get:function(){return this._xhr.responseText},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"responseType",{get:function(){return this._xhr.responseType},set:function(e){this._xhr.responseType=e},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"timeout",{get:function(){return this._xhr.timeout},set:function(e){this._xhr.timeout=e},enumerable:!1,configurable:!0}),i.prototype.addEventListener=function(e,t,r){this._xhr.addEventListener(e,t,r)},i.prototype.removeEventListener=function(e,t,r){this._xhr.removeEventListener(e,t,r)},i.prototype.abort=function(){this._xhr.abort()},i.prototype.send=function(e){i.CustomRequestHeaders&&this._injectCustomRequestHeaders(),this._xhr.send(e)},i.prototype.open=function(e,t){for(var r=0,n=i.CustomRequestModifiers;r<n.length;r++){var a=n[r];a(this._xhr,t)}return t=t.replace("file:http:","http:"),t=t.replace("file:https:","https:"),this._xhr.open(e,t,!0)},i.prototype.setRequestHeader=function(e,t){this._xhr.setRequestHeader(e,t)},i.prototype.getResponseHeader=function(e){return this._xhr.getResponseHeader(e)},i.CustomRequestHeaders={},i.CustomRequestModifiers=new Array,i}();function ze(){return typeof window!="undefined"}function Oa(){return typeof navigator!="undefined"}function Qi(){return typeof document!="undefined"}function $i(i){for(var e="",t=i.firstChild;t;)t.nodeType===3&&(e+=t.textContent),t=t.nextSibling;return e}var Li={IsWindowObjectExist:ze,IsNavigatorAvailable:Oa,IsDocumentAvailable:Qi,GetDOMTextContent:$i},Rr=function(){function i(){}return i.FilesToLoad={},i}(),Eo=function(){function i(){}return i.ExponentialBackoff=function(e,t){return e===void 0&&(e=3),t===void 0&&(t=500),function(r,n,a){return n.status!==0||a>=e||r.indexOf("file:")!==-1?-1:Math.pow(2,a)*t}},i}(),Or=function(i){$(e,i);function e(){return i!==null&&i.apply(this,arguments)||this}return e._setPrototypeOf=Object.setPrototypeOf||function(t,r){return t.__proto__=r,t},e}(Error),sr={MeshInvalidPositionsError:0,UnsupportedTextureError:1e3,GLTFLoaderUnexpectedMagicError:2e3,SceneLoaderError:3e3,LoadFileError:4e3,RequestFileError:4001,ReadFileError:4002},or=function(i){$(e,i);function e(t,r,n){var a=i.call(this,t)||this;return a.errorCode=r,a.innerError=n,a.name="RuntimeError",Or._setPrototypeOf(a,e.prototype),a}return e}(Or),Ut=function(i,e){return i.indexOf(e,i.length-e.length)!==-1},vt=function(i,e){return i?i.indexOf(e)===0:!1},Ia=function(i){if(typeof TextDecoder!="undefined")return new TextDecoder().decode(i);for(var e="",t=0;t<i.byteLength;t++)e+=String.fromCharCode(i[t]);return e},Ji=function(i){for(var e="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",t="",r,n,a,s,o,l,u,f=0,h=ArrayBuffer.isView(i)?new Uint8Array(i.buffer,i.byteOffset,i.byteLength):new Uint8Array(i);f<h.length;)r=h[f++],n=f<h.length?h[f++]:Number.NaN,a=f<h.length?h[f++]:Number.NaN,s=r>>2,o=(r&3)<<4|n>>4,l=(n&15)<<2|a>>6,u=a&63,isNaN(n)?l=u=64:isNaN(a)&&(u=64),t+=e.charAt(s)+e.charAt(o)+e.charAt(l)+e.charAt(u);return t},en=function(i){return atob(i)},Fa=function(i){for(var e=en(i),t=e.length,r=new Uint8Array(new ArrayBuffer(t)),n=0;n<t;n++)r[n]=e.charCodeAt(n);return r.buffer},Ao=function(i,e){for(var t=String(i);t.length<e;)t="0"+t;return t},Sp={EndsWith:Ut,StartsWith:vt,Decode:Ia,EncodeArrayBufferToBase64:Ji,DecodeBase64ToString:en,DecodeBase64ToBinary:Fa,PadNumber:Ao},Pr=function(){function i(){this.children=[]}return i.prototype.isValid=function(e){return!0},i.prototype.process=function(e,t){var r="";if(this.line){var n=this.line,a=t.processor;if(a){if(a.lineProcessor&&(n=a.lineProcessor(n,t.isFragment,t.processingContext)),a.attributeProcessor&&vt(this.line,"attribute"))n=a.attributeProcessor(this.line,e,t.processingContext);else if(a.varyingProcessor&&vt(this.line,"varying"))n=a.varyingProcessor(this.line,t.isFragment,e,t.processingContext);else if(a.uniformProcessor&&a.uniformRegexp&&a.uniformRegexp.test(this.line))t.lookForClosingBracketForUniformBuffer||(n=a.uniformProcessor(this.line,t.isFragment,e,t.processingContext));else if(a.uniformBufferProcessor&&a.uniformBufferRegexp&&a.uniformBufferRegexp.test(this.line))t.lookForClosingBracketForUniformBuffer||(n=a.uniformBufferProcessor(this.line,t.isFragment,t.processingContext),t.lookForClosingBracketForUniformBuffer=!0);else if(a.textureProcessor&&a.textureRegexp&&a.textureRegexp.test(this.line))n=a.textureProcessor(this.line,t.isFragment,e,t.processingContext);else if((a.uniformProcessor||a.uniformBufferProcessor)&&vt(this.line,"uniform")&&!t.lookForClosingBracketForUniformBuffer){var s=/uniform\s+(?:(?:highp)?|(?:lowp)?)\s*(\S+)\s+(\S+)\s*;/;s.test(this.line)?a.uniformProcessor&&(n=a.uniformProcessor(this.line,t.isFragment,e,t.processingContext)):a.uniformBufferProcessor&&(n=a.uniformBufferProcessor(this.line,t.isFragment,t.processingContext),t.lookForClosingBracketForUniformBuffer=!0)}t.lookForClosingBracketForUniformBuffer&&this.line.indexOf("}")!==-1&&(t.lookForClosingBracketForUniformBuffer=!1,a.endOfUniformBufferProcessor&&(n=a.endOfUniformBufferProcessor(this.line,t.isFragment,t.processingContext)))}r+=n+`\r
`}return this.children.forEach(function(o){r+=o.process(e,t)}),this.additionalDefineKey&&(e[this.additionalDefineKey]=this.additionalDefineValue||"true"),r},i}(),So=function(){function i(){}return Object.defineProperty(i.prototype,"currentLine",{get:function(){return this._lines[this.lineIndex]},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"canRead",{get:function(){return this.lineIndex<this._lines.length-1},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"lines",{set:function(e){this._lines=[];for(var t=0,r=e;t<r.length;t++){var n=r[t];if(n[0]==="#"){this._lines.push(n);continue}for(var a=n.split(";"),s=0;s<a.length;s++){var o=a[s];o=o.trim(),o&&this._lines.push(o+(s!==a.length-1?";":""))}}},enumerable:!1,configurable:!0}),i}(),ci=function(i){$(e,i);function e(){return i!==null&&i.apply(this,arguments)||this}return e.prototype.process=function(t,r){for(var n=0;n<this.children.length;n++){var a=this.children[n];if(a.isValid(t))return a.process(t,r)}return""},e}(Pr),Ro=function(i){$(e,i);function e(){return i!==null&&i.apply(this,arguments)||this}return e.prototype.isValid=function(t){return this.testExpression.isTrue(t)},e}(Pr),Ur=function(){function i(){}return i.prototype.isTrue=function(e){return!0},i.postfixToInfix=function(e){for(var t=[],r=0,n=e;r<n.length;r++){var a=n[r];if(i._OperatorPriority[a]===void 0)t.push(a);else{var s=t[t.length-1],o=t[t.length-2];t.length-=2,t.push("(".concat(o).concat(a).concat(s,")"))}}return t[t.length-1]},i.infixToPostfix=function(e){for(var t=[],r=-1,n=function(){u=u.trim(),u!==""&&(t.push(u),u="")},a=function(c){r<i._Stack.length-1&&(i._Stack[++r]=c)},s=function(){return i._Stack[r]},o=function(){return r===-1?"!!INVALID EXPRESSION!!":i._Stack[r--]},l=0,u="";l<e.length;){var f=e.charAt(l),h=l<e.length-1?e.substr(l,2):"";if(f==="(")u="",a(f);else if(f===")"){for(n();r!==-1&&s()!=="(";)t.push(o());o()}else if(i._OperatorPriority[h]>1){for(n();r!==-1&&i._OperatorPriority[s()]>=i._OperatorPriority[h];)t.push(o());a(h),l++}else u+=f;l++}for(n();r!==-1;)s()==="("?o():t.push(o());return t},i._OperatorPriority={")":0,"(":1,"||":2,"&&":3},i._Stack=["","","","","","","","","","","","","","","","","","","",""],i}(),Gr=function(i){$(e,i);function e(t,r){r===void 0&&(r=!1);var n=i.call(this)||this;return n.define=t,n.not=r,n}return e.prototype.isTrue=function(t){var r=t[this.define]!==void 0;return this.not&&(r=!r),r},e}(Ur),Po=function(i){$(e,i);function e(){return i!==null&&i.apply(this,arguments)||this}return e.prototype.isTrue=function(t){return this.leftOperand.isTrue(t)||this.rightOperand.isTrue(t)},e}(Ur),Mo=function(i){$(e,i);function e(){return i!==null&&i.apply(this,arguments)||this}return e.prototype.isTrue=function(t){return this.leftOperand.isTrue(t)&&this.rightOperand.isTrue(t)},e}(Ur),Co=function(i){$(e,i);function e(t,r,n){var a=i.call(this)||this;return a.define=t,a.operand=r,a.testValue=n,a}return e.prototype.isTrue=function(t){var r=t[this.define];r===void 0&&(r=this.define);var n=!1,a=parseInt(r),s=parseInt(this.testValue);switch(this.operand){case">":n=a>s;break;case"<":n=a<s;break;case"<=":n=a<=s;break;case">=":n=a>=s;break;case"==":n=a===s;break}return n},e}(Ur),qe;(function(i){i[i.GLSL=0]="GLSL",i[i.WGSL=1]="WGSL"})(qe||(qe={}));var xo=/defined\s*?\((.+?)\)/g,di=/defined\s*?\[(.+?)\]/g,Sr=function(){function i(){}return i.Initialize=function(e){e.processor&&e.processor.initializeShaders&&e.processor.initializeShaders(e.processingContext)},i.Process=function(e,t,r,n){var a=this,s;!((s=t.processor)===null||s===void 0)&&s.preProcessShaderCode&&(e=t.processor.preProcessShaderCode(e,t.isFragment)),this._ProcessIncludes(e,t,function(o){t.processCodeAfterIncludes&&(o=t.processCodeAfterIncludes(t.isFragment?"fragment":"vertex",o));var l=a._ProcessShaderConversion(o,t,n);r(l)})},i.PreProcess=function(e,t,r,n){var a=this,s;!((s=t.processor)===null||s===void 0)&&s.preProcessShaderCode&&(e=t.processor.preProcessShaderCode(e,t.isFragment)),this._ProcessIncludes(e,t,function(o){t.processCodeAfterIncludes&&(o=t.processCodeAfterIncludes(t.isFragment?"fragment":"vertex",o));var l=a._ApplyPreProcessing(o,t,n);r(l)})},i.Finalize=function(e,t,r){return!r.processor||!r.processor.finalizeShaders?{vertexCode:e,fragmentCode:t}:r.processor.finalizeShaders(e,t,r.processingContext)},i._ProcessPrecision=function(e,t){var r;if(!((r=t.processor)===null||r===void 0)&&r.noPrecision)return e;var n=t.shouldUseHighPrecisionShader;return e.indexOf("precision highp float")===-1?n?e=`precision highp float;
`+e:e=`precision mediump float;
`+e:n||(e=e.replace("precision highp float","precision mediump float")),e},i._ExtractOperation=function(e){var t=/defined\((.+)\)/,r=t.exec(e);if(r&&r.length)return new Gr(r[1].trim(),e[0]==="!");for(var n=["==",">=","<=","<",">"],a="",s=0,o=0,l=n;o<l.length&&(a=l[o],s=e.indexOf(a),!(s>-1));o++);if(s===-1)return new Gr(e);var u=e.substring(0,s).trim(),f=e.substring(s+a.length).trim();return new Co(u,a,f)},i._BuildSubExpression=function(e){e=e.replace(xo,"defined[$1]");for(var t=Ur.infixToPostfix(e),r=[],n=0,a=t;n<a.length;n++){var s=a[n];if(s!=="||"&&s!=="&&")r.push(s);else if(r.length>=2){var o=r[r.length-1],l=r[r.length-2];r.length-=2;var u=s=="&&"?new Mo:new Po;typeof o=="string"&&(o=o.replace(di,"defined($1)")),typeof l=="string"&&(l=l.replace(di,"defined($1)")),u.leftOperand=typeof l=="string"?this._ExtractOperation(l):l,u.rightOperand=typeof o=="string"?this._ExtractOperation(o):o,r.push(u)}}var f=r[r.length-1];return typeof f=="string"&&(f=f.replace(di,"defined($1)")),typeof f=="string"?this._ExtractOperation(f):f},i._BuildExpression=function(e,t){var r=new Ro,n=e.substring(0,t),a=e.substring(t);return a=a.substring(0,(a.indexOf("//")+1||a.length+1)-1).trim(),n==="#ifdef"?r.testExpression=new Gr(a):n==="#ifndef"?r.testExpression=new Gr(a,!0):r.testExpression=this._BuildSubExpression(a),r},i._MoveCursorWithinIf=function(e,t,r){for(var n=e.currentLine;this._MoveCursor(e,r);){n=e.currentLine;var a=n.substring(0,5).toLowerCase();if(a==="#else"){var s=new Pr;t.children.push(s),this._MoveCursor(e,s);return}else if(a==="#elif"){var o=this._BuildExpression(n,5);t.children.push(o),r=o}}},i._MoveCursor=function(e,t){for(;e.canRead;){e.lineIndex++;var r=e.currentLine,n=/(#ifdef)|(#else)|(#elif)|(#endif)|(#ifndef)|(#if)/,a=n.exec(r);if(a&&a.length){var s=a[0];switch(s){case"#ifdef":{var o=new ci;t.children.push(o);var l=this._BuildExpression(r,6);o.children.push(l),this._MoveCursorWithinIf(e,o,l);break}case"#else":case"#elif":return!0;case"#endif":return!1;case"#ifndef":{var o=new ci;t.children.push(o);var l=this._BuildExpression(r,7);o.children.push(l),this._MoveCursorWithinIf(e,o,l);break}case"#if":{var o=new ci,l=this._BuildExpression(r,3);t.children.push(o),o.children.push(l),this._MoveCursorWithinIf(e,o,l);break}}}else{var u=new Pr;if(u.line=r,t.children.push(u),r[0]==="#"&&r[1]==="d"){var f=r.replace(";","").split(" ");u.additionalDefineKey=f[1],f.length===3&&(u.additionalDefineValue=f[2])}}}return!1},i._EvaluatePreProcessors=function(e,t,r){var n=new Pr,a=new So;return a.lineIndex=-1,a.lines=e.split(`
`),this._MoveCursor(a,n),n.process(t,r)},i._PreparePreProcessors=function(e,t){for(var r,n=e.defines,a={},s=0,o=n;s<o.length;s++){var l=o[s],u=l.replace("#define","").replace(";","").trim(),f=u.split(" ");a[f[0]]=f.length>1?f[1]:""}return((r=e.processor)===null||r===void 0?void 0:r.shaderLanguage)===qe.GLSL&&(a.GL_ES="true"),a.__VERSION__=e.version,a[e.platformName]="true",t._getGlobalDefines(a),a},i._ProcessShaderConversion=function(e,t,r){var n=this._ProcessPrecision(e,t);if(!t.processor)return n;if(t.processor.shaderLanguage===qe.GLSL&&n.indexOf("#version 3")!==-1)return n.replace("#version 300 es","");var a=t.defines,s=this._PreparePreProcessors(t,r);return t.processor.preProcessor&&(n=t.processor.preProcessor(n,a,t.isFragment,t.processingContext)),n=this._EvaluatePreProcessors(n,s,t),t.processor.postProcessor&&(n=t.processor.postProcessor(n,a,t.isFragment,t.processingContext,r)),r._features.needShaderCodeInlining&&(n=r.inlineShaderCode(n)),n},i._ApplyPreProcessing=function(e,t,r){var n,a,s=e,o=t.defines,l=this._PreparePreProcessors(t,r);return!((n=t.processor)===null||n===void 0)&&n.preProcessor&&(s=t.processor.preProcessor(s,o,t.isFragment,t.processingContext)),s=this._EvaluatePreProcessors(s,l,t),!((a=t.processor)===null||a===void 0)&&a.postProcessor&&(s=t.processor.postProcessor(s,o,t.isFragment,t.processingContext,r)),r._features.needShaderCodeInlining&&(s=r.inlineShaderCode(s)),s},i._ProcessIncludes=function(e,t,r){for(var n=this,a=/#include\s?<(.+)>(\((.*)\))*(\[(.*)\])*/g,s=a.exec(e),o=new String(e),l=!1,u=function(){var h=s[1];if(h.indexOf("__decl__")!==-1&&(h=h.replace(/__decl__/,""),t.supportsUniformBuffers&&(h=h.replace(/Vertex/,"Ubo"),h=h.replace(/Fragment/,"Ubo")),h=h+"Declaration"),t.includesShadersStore[h]){var c=t.includesShadersStore[h];if(s[2])for(var d=s[3].split(","),p=0;p<d.length;p+=2){var _=new RegExp(d[p],"g"),g=d[p+1];c=c.replace(_,g)}if(s[4]){var v=s[5];if(v.indexOf("..")!==-1){var y=v.split(".."),b=parseInt(y[0]),E=parseInt(y[1]),A=c.slice(0);c="",isNaN(E)&&(E=t.indexParameters[y[1]]);for(var S=b;S<E;S++)t.supportsUniformBuffers||(A=A.replace(/light\{X\}.(\w*)/g,function(M,D){return D+"{X}"})),c+=A.replace(/\{X\}/g,S.toString())+`
`}else t.supportsUniformBuffers||(c=c.replace(/light\{X\}.(\w*)/g,function(M,D){return D+"{X}"})),c=c.replace(/\{X\}/g,v)}o=o.replace(s[0],c),l=l||c.indexOf("#include<")>=0||c.indexOf("#include <")>=0}else{var T=t.shadersRepository+"ShadersInclude/"+h+".fx";return i._FileToolsLoadFile(T,function(M){t.includesShadersStore[h]=M,n._ProcessIncludes(o,t,r)}),{value:void 0}}s=a.exec(e)};s!=null;){var f=u();if(typeof f=="object")return f.value}l?this._ProcessIncludes(o.toString(),t,r):r(o)},i._FileToolsLoadFile=function(e,t,r,n,a,s){throw he("FileTools")},i}(),Y=function(){function i(){}return i._CheckLimit=function(e,t){var r=i._LogLimitOutputs[e];return r?r.current++:(r={limit:t,current:1},i._LogLimitOutputs[e]=r),r.current<=r.limit},i._GenerateLimitMessage=function(e,t){var r=i._LogLimitOutputs[e];if(!(!r||!i.MessageLimitReached)&&r.current===r.limit)switch(t){case 0:i.Log(i.MessageLimitReached.replace(/%LIMIT%/g,""+r.limit).replace(/%TYPE%/g,"log"));break;case 1:i.Warn(i.MessageLimitReached.replace(/%LIMIT%/g,""+r.limit).replace(/%TYPE%/g,"warning"));break;case 2:i.Error(i.MessageLimitReached.replace(/%LIMIT%/g,""+r.limit).replace(/%TYPE%/g,"error"));break}},i._AddLogEntry=function(e){i._LogCache=e+i._LogCache,i.OnNewCacheEntry&&i.OnNewCacheEntry(e)},i._FormatMessage=function(e){var t=function(n){return n<10?"0"+n:""+n},r=new Date;return"["+t(r.getHours())+":"+t(r.getMinutes())+":"+t(r.getSeconds())+"]: "+e},i._LogDisabled=function(e,t){},i._LogEnabled=function(e,t){if(!(t!==void 0&&!i._CheckLimit(e,t))){var r=i._FormatMessage(e);console.log("BJS - "+r);var n="<div style='color:white'>"+r+"</div><br>";i._AddLogEntry(n),i._GenerateLimitMessage(e,0)}},i._WarnDisabled=function(e,t){},i._WarnEnabled=function(e,t){if(!(t!==void 0&&!i._CheckLimit(e,t))){var r=i._FormatMessage(e);console.warn("BJS - "+r);var n="<div style='color:orange'>"+e+"</div><br>";i._AddLogEntry(n),i._GenerateLimitMessage(e,1)}},i._ErrorDisabled=function(e,t){},i._ErrorEnabled=function(e,t){if(!(t!==void 0&&!i._CheckLimit(e,t))){var r=i._FormatMessage(e);i.errorsCount++,console.error("BJS - "+r);var n="<div style='color:red'>"+r+"</div><br>";i._AddLogEntry(n),i._GenerateLimitMessage(e,2)}},Object.defineProperty(i,"LogCache",{get:function(){return i._LogCache},enumerable:!1,configurable:!0}),i.ClearLogCache=function(){i._LogCache="",i._LogLimitOutputs={},i.errorsCount=0},Object.defineProperty(i,"LogLevels",{set:function(e){(e&i.MessageLogLevel)===i.MessageLogLevel?i.Log=i._LogEnabled:i.Log=i._LogDisabled,(e&i.WarningLogLevel)===i.WarningLogLevel?i.Warn=i._WarnEnabled:i.Warn=i._WarnDisabled,(e&i.ErrorLogLevel)===i.ErrorLogLevel?i.Error=i._ErrorEnabled:i.Error=i._ErrorDisabled},enumerable:!1,configurable:!0}),i.NoneLogLevel=0,i.MessageLogLevel=1,i.WarningLogLevel=2,i.ErrorLogLevel=4,i.AllLogLevel=7,i.MessageLimitReached="Too many %TYPE%s (%LIMIT%), no more %TYPE%s will be reported for this message.",i._LogCache="",i._LogLimitOutputs={},i.errorsCount=0,i.Log=i._LogEnabled,i.Warn=i._WarnEnabled,i.Error=i._ErrorEnabled,i}(),q=function(){function i(){}return i.GetShadersRepository=function(e){return e===void 0&&(e=qe.GLSL),e===qe.GLSL?i.ShadersRepository:i.ShadersRepositoryWGSL},i.GetShadersStore=function(e){return e===void 0&&(e=qe.GLSL),e===qe.GLSL?i.ShadersStore:i.ShadersStoreWGSL},i.GetIncludesShadersStore=function(e){return e===void 0&&(e=qe.GLSL),e===qe.GLSL?i.IncludesShadersStore:i.IncludesShadersStoreWGSL},i.ShadersRepository="src/Shaders/",i.ShadersStore={},i.IncludesShadersStore={},i.ShadersRepositoryWGSL="src/ShadersWGSL/",i.ShadersStoreWGSL={},i.IncludesShadersStoreWGSL={},i}(),Kt=function(){function i(e,t,r,n,a,s,o,l,u,f,h,c){n===void 0&&(n=null),s===void 0&&(s=null),o===void 0&&(o=null),l===void 0&&(l=null),u===void 0&&(u=null),h===void 0&&(h=""),c===void 0&&(c=qe.GLSL);var d=this,p,_,g;this.name=null,this.defines="",this.onCompiled=null,this.onError=null,this.onBind=null,this.uniqueId=0,this.onCompileObservable=new X,this.onErrorObservable=new X,this._onBindObservable=null,this._wasPreviouslyReady=!1,this._bonesComputationForcedToCPU=!1,this._uniformBuffersNames={},this._multiTarget=!1,this._samplers={},this._isReady=!1,this._compilationError="",this._allFallbacksProcessed=!1,this._uniforms={},this._key="",this._fallbacks=null,this._vertexSourceCodeOverride="",this._fragmentSourceCodeOverride="",this._transformFeedbackVaryings=null,this._pipelineContext=null,this._vertexSourceCode="",this._fragmentSourceCode="",this._rawVertexSourceCode="",this._rawFragmentSourceCode="",this.name=e,this._key=h;var v=void 0,y=null;if(t.attributes){var b=t;if(this._engine=r,this._attributesNames=b.attributes,this._uniformsNames=b.uniformsNames.concat(b.samplers),this._samplerList=b.samplers.slice(),this.defines=b.defines,this.onError=b.onError,this.onCompiled=b.onCompiled,this._fallbacks=b.fallbacks,this._indexParameters=b.indexParameters,this._transformFeedbackVaryings=b.transformFeedbackVaryings||null,this._multiTarget=!!b.multiTarget,this._shaderLanguage=(p=b.shaderLanguage)!==null&&p!==void 0?p:qe.GLSL,b.uniformBuffersNames){this._uniformBuffersNamesList=b.uniformBuffersNames.slice();for(var E=0;E<b.uniformBuffersNames.length;E++)this._uniformBuffersNames[b.uniformBuffersNames[E]]=E}y=(_=b.processFinalCode)!==null&&_!==void 0?_:null,v=(g=b.processCodeAfterIncludes)!==null&&g!==void 0?g:void 0}else this._engine=a,this.defines=s==null?"":s,this._uniformsNames=r.concat(n),this._samplerList=n?n.slice():[],this._attributesNames=t,this._uniformBuffersNamesList=[],this._shaderLanguage=c,this.onError=u,this.onCompiled=l,this._indexParameters=f,this._fallbacks=o;this._attributeLocationByName={},this.uniqueId=i._UniqueIdSeed++;var A,S,T=ze()?this._engine.getHostDocument():null;e.vertexSource?A="source:"+e.vertexSource:e.vertexElement?(A=T?T.getElementById(e.vertexElement):null,A||(A=e.vertexElement)):A=e.vertex||e,e.fragmentSource?S="source:"+e.fragmentSource:e.fragmentElement?(S=T?T.getElementById(e.fragmentElement):null,S||(S=e.fragmentElement)):S=e.fragment||e,this._processingContext=this._engine._getShaderProcessingContext(this._shaderLanguage);var M={defines:this.defines.split(`
`),indexParameters:this._indexParameters,isFragment:!1,shouldUseHighPrecisionShader:this._engine._shouldUseHighPrecisionShader,processor:this._engine._getShaderProcessor(this._shaderLanguage),supportsUniformBuffers:this._engine.supportsUniformBuffers,shadersRepository:q.GetShadersRepository(this._shaderLanguage),includesShadersStore:q.GetIncludesShadersStore(this._shaderLanguage),version:(this._engine.version*100).toString(),platformName:this._engine.shaderPlatformName,processingContext:this._processingContext,isNDCHalfZRange:this._engine.isNDCHalfZRange,useReverseDepthBuffer:this._engine.useReverseDepthBuffer,processCodeAfterIncludes:v},D=[void 0,void 0],x=function(){if(D[0]&&D[1]){M.isFragment=!0;var P=D[0],w=D[1];Sr.Process(w,M,function(k){y&&(k=y("fragment",k));var B=Sr.Finalize(P,k,M);d._useFinalCode(B.vertexCode,B.fragmentCode,e)},d._engine)}};this._loadShader(A,"Vertex","",function(P){Sr.Initialize(M),Sr.Process(P,M,function(w){d._rawVertexSourceCode=P,y&&(w=y("vertex",w)),D[0]=w,x()},d._engine)}),this._loadShader(S,"Fragment","Pixel",function(P){d._rawFragmentSourceCode=P,D[1]=P,x()})}return Object.defineProperty(i,"ShadersRepository",{get:function(){return q.ShadersRepository},set:function(e){q.ShadersRepository=e},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"onBindObservable",{get:function(){return this._onBindObservable||(this._onBindObservable=new X),this._onBindObservable},enumerable:!1,configurable:!0}),i.prototype._useFinalCode=function(e,t,r){if(r){var n=r.vertexElement||r.vertex||r.spectorName||r,a=r.fragmentElement||r.fragment||r.spectorName||r;this._vertexSourceCode=(this._shaderLanguage===qe.WGSL?"//":"")+"#define SHADER_NAME vertex:"+n+`
`+e,this._fragmentSourceCode=(this._shaderLanguage===qe.WGSL?"//":"")+"#define SHADER_NAME fragment:"+a+`
`+t}else this._vertexSourceCode=e,this._fragmentSourceCode=t;this._prepareEffect()},Object.defineProperty(i.prototype,"key",{get:function(){return this._key},enumerable:!1,configurable:!0}),i.prototype.isReady=function(){try{return this._isReadyInternal()}catch{return!1}},i.prototype._isReadyInternal=function(){return this._isReady?!0:this._pipelineContext?this._pipelineContext.isReady:!1},i.prototype.getEngine=function(){return this._engine},i.prototype.getPipelineContext=function(){return this._pipelineContext},i.prototype.getAttributesNames=function(){return this._attributesNames},i.prototype.getAttributeLocation=function(e){return this._attributes[e]},i.prototype.getAttributeLocationByName=function(e){return this._attributeLocationByName[e]},i.prototype.getAttributesCount=function(){return this._attributes.length},i.prototype.getUniformIndex=function(e){return this._uniformsNames.indexOf(e)},i.prototype.getUniform=function(e){return this._uniforms[e]},i.prototype.getSamplers=function(){return this._samplerList},i.prototype.getUniformNames=function(){return this._uniformsNames},i.prototype.getUniformBuffersNames=function(){return this._uniformBuffersNamesList},i.prototype.getIndexParameters=function(){return this._indexParameters},i.prototype.getCompilationError=function(){return this._compilationError},i.prototype.allFallbacksProcessed=function(){return this._allFallbacksProcessed},i.prototype.executeWhenCompiled=function(e){var t=this;if(this.isReady()){e(this);return}this.onCompileObservable.add(function(r){e(r)}),(!this._pipelineContext||this._pipelineContext.isAsync)&&setTimeout(function(){t._checkIsReady(null)},16)},i.prototype._checkIsReady=function(e){var t=this;try{if(this._isReadyInternal())return}catch(r){this._processCompilationErrors(r,e);return}setTimeout(function(){t._checkIsReady(e)},16)},i.prototype._loadShader=function(e,t,r,n){if(typeof HTMLElement!="undefined"&&e instanceof HTMLElement){var a=$i(e);n(a);return}if(e.substr(0,7)==="source:"){n(e.substr(7));return}if(e.substr(0,7)==="base64:"){var s=window.atob(e.substr(7));n(s);return}var o=q.GetShadersStore(this._shaderLanguage);if(o[e+t+"Shader"]){n(o[e+t+"Shader"]);return}if(r&&o[e+r+"Shader"]){n(o[e+r+"Shader"]);return}var l;e[0]==="."||e[0]==="/"||e.indexOf("http")>-1?l=e:l=q.GetShadersRepository(this._shaderLanguage)+e,this._engine._loadFile(l+"."+t.toLowerCase()+".fx",n)},Object.defineProperty(i.prototype,"vertexSourceCode",{get:function(){var e,t;return this._vertexSourceCodeOverride&&this._fragmentSourceCodeOverride?this._vertexSourceCodeOverride:(t=(e=this._pipelineContext)===null||e===void 0?void 0:e._getVertexShaderCode())!==null&&t!==void 0?t:this._vertexSourceCode},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"fragmentSourceCode",{get:function(){var e,t;return this._vertexSourceCodeOverride&&this._fragmentSourceCodeOverride?this._fragmentSourceCodeOverride:(t=(e=this._pipelineContext)===null||e===void 0?void 0:e._getFragmentShaderCode())!==null&&t!==void 0?t:this._fragmentSourceCode},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"rawVertexSourceCode",{get:function(){return this._rawVertexSourceCode},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"rawFragmentSourceCode",{get:function(){return this._rawFragmentSourceCode},enumerable:!1,configurable:!0}),i.prototype._rebuildProgram=function(e,t,r,n){var a=this;this._isReady=!1,this._vertexSourceCodeOverride=e,this._fragmentSourceCodeOverride=t,this.onError=function(s,o){n&&n(o)},this.onCompiled=function(){var s=a.getEngine().scenes;if(s)for(var o=0;o<s.length;o++)s[o].markAllMaterialsAsDirty(63);a._pipelineContext._handlesSpectorRebuildCallback(r)},this._fallbacks=null,this._prepareEffect()},i.prototype._prepareEffect=function(){var e=this,t=this._attributesNames,r=this.defines,n=this._pipelineContext;this._isReady=!1;try{var a=this._engine;this._pipelineContext=a.createPipelineContext(this._processingContext),this._pipelineContext._name=this._key;var s=this._rebuildProgram.bind(this);this._vertexSourceCodeOverride&&this._fragmentSourceCodeOverride?a._preparePipelineContext(this._pipelineContext,this._vertexSourceCodeOverride,this._fragmentSourceCodeOverride,!0,this._rawVertexSourceCode,this._rawFragmentSourceCode,s,null,this._transformFeedbackVaryings,this._key):a._preparePipelineContext(this._pipelineContext,this._vertexSourceCode,this._fragmentSourceCode,!1,this._rawVertexSourceCode,this._rawFragmentSourceCode,s,r,this._transformFeedbackVaryings,this._key),a._executeWhenRenderingStateIsCompiled(this._pipelineContext,function(){if(e._attributes=[],e._pipelineContext._fillEffectInformation(e,e._uniformBuffersNames,e._uniformsNames,e._uniforms,e._samplerList,e._samplers,t,e._attributes),t)for(var o=0;o<t.length;o++){var l=t[o];e._attributeLocationByName[l]=e._attributes[o]}a.bindSamplers(e),e._compilationError="",e._isReady=!0,e.onCompiled&&e.onCompiled(e),e.onCompileObservable.notifyObservers(e),e.onCompileObservable.clear(),e._fallbacks&&e._fallbacks.unBindMesh(),n&&e.getEngine()._deletePipelineContext(n)}),this._pipelineContext.isAsync&&this._checkIsReady(n)}catch(o){this._processCompilationErrors(o,n)}},i.prototype._getShaderCodeAndErrorLine=function(e,t,r){var n=r?/FRAGMENT SHADER ERROR: 0:(\d+?):/:/VERTEX SHADER ERROR: 0:(\d+?):/,a=null;if(t&&e){var s=t.match(n);if(s&&s.length===2){var o=parseInt(s[1]),l=e.split(`
`,-1);l.length>=o&&(a="Offending line [".concat(o,"] in ").concat(r?"fragment":"vertex"," code: ").concat(l[o-1]))}}return[e,a]},i.prototype._processCompilationErrors=function(e,t){var r,n,a,s,o;t===void 0&&(t=null),this._compilationError=e.message;var l=this._attributesNames,u=this._fallbacks;if(Y.Error("Unable to compile effect:"),Y.Error("Uniforms: "+this._uniformsNames.map(function(d){return" "+d})),Y.Error("Attributes: "+l.map(function(d){return" "+d})),Y.Error(`Defines:\r
`+this.defines),i.LogShaderCodeOnCompilationError){var f=null,h=null,c=null;!((a=this._pipelineContext)===null||a===void 0)&&a._getVertexShaderCode()&&(r=this._getShaderCodeAndErrorLine(this._pipelineContext._getVertexShaderCode(),this._compilationError,!1),c=r[0],f=r[1],c&&(Y.Error("Vertex code:"),Y.Error(c))),!((s=this._pipelineContext)===null||s===void 0)&&s._getFragmentShaderCode()&&(n=this._getShaderCodeAndErrorLine((o=this._pipelineContext)===null||o===void 0?void 0:o._getFragmentShaderCode(),this._compilationError,!0),c=n[0],h=n[1],c&&(Y.Error("Fragment code:"),Y.Error(c))),f&&Y.Error(f),h&&Y.Error(h)}Y.Error("Error: "+this._compilationError),t&&(this._pipelineContext=t,this._isReady=!0,this.onError&&this.onError(this,this._compilationError),this.onErrorObservable.notifyObservers(this)),u?(this._pipelineContext=null,u.hasMoreFallbacks?(this._allFallbacksProcessed=!1,Y.Error("Trying next fallback."),this.defines=u.reduce(this.defines,this),this._prepareEffect()):(this._allFallbacksProcessed=!0,this.onError&&this.onError(this,this._compilationError),this.onErrorObservable.notifyObservers(this),this.onErrorObservable.clear(),this._fallbacks&&this._fallbacks.unBindMesh())):this._allFallbacksProcessed=!0},Object.defineProperty(i.prototype,"isSupported",{get:function(){return this._compilationError===""},enumerable:!1,configurable:!0}),i.prototype._bindTexture=function(e,t){this._engine._bindTexture(this._samplers[e],t,e)},i.prototype.setTexture=function(e,t){this._engine.setTexture(this._samplers[e],this._uniforms[e],t,e)},i.prototype.setDepthStencilTexture=function(e,t){this._engine.setDepthStencilTexture(this._samplers[e],this._uniforms[e],t,e)},i.prototype.setTextureArray=function(e,t){var r=e+"Ex";if(this._samplerList.indexOf(r+"0")===-1){for(var n=this._samplerList.indexOf(e),a=1;a<t.length;a++){var s=r+(a-1).toString();this._samplerList.splice(n+a,0,s)}for(var o=0,l=0,u=this._samplerList;l<u.length;l++){var f=u[l];this._samplers[f]=o,o+=1}}this._engine.setTextureArray(this._samplers[e],this._uniforms[e],t,e)},i.prototype.setTextureFromPostProcess=function(e,t){this._engine.setTextureFromPostProcess(this._samplers[e],t,e)},i.prototype.setTextureFromPostProcessOutput=function(e,t){this._engine.setTextureFromPostProcessOutput(this._samplers[e],t,e)},i.prototype.bindUniformBuffer=function(e,t){var r=this._uniformBuffersNames[t];r===void 0||i._BaseCache[r]===e&&this._engine._features.useUBOBindingCache||(i._BaseCache[r]=e,this._engine.bindUniformBufferBase(e,r,t))},i.prototype.bindUniformBlock=function(e,t){this._engine.bindUniformBlock(this._pipelineContext,e,t)},i.prototype.setInt=function(e,t){return this._pipelineContext.setInt(e,t),this},i.prototype.setInt2=function(e,t,r){return this._pipelineContext.setInt2(e,t,r),this},i.prototype.setInt3=function(e,t,r,n){return this._pipelineContext.setInt3(e,t,r,n),this},i.prototype.setInt4=function(e,t,r,n,a){return this._pipelineContext.setInt4(e,t,r,n,a),this},i.prototype.setIntArray=function(e,t){return this._pipelineContext.setIntArray(e,t),this},i.prototype.setIntArray2=function(e,t){return this._pipelineContext.setIntArray2(e,t),this},i.prototype.setIntArray3=function(e,t){return this._pipelineContext.setIntArray3(e,t),this},i.prototype.setIntArray4=function(e,t){return this._pipelineContext.setIntArray4(e,t),this},i.prototype.setFloatArray=function(e,t){return this._pipelineContext.setArray(e,t),this},i.prototype.setFloatArray2=function(e,t){return this._pipelineContext.setArray2(e,t),this},i.prototype.setFloatArray3=function(e,t){return this._pipelineContext.setArray3(e,t),this},i.prototype.setFloatArray4=function(e,t){return this._pipelineContext.setArray4(e,t),this},i.prototype.setArray=function(e,t){return this._pipelineContext.setArray(e,t),this},i.prototype.setArray2=function(e,t){return this._pipelineContext.setArray2(e,t),this},i.prototype.setArray3=function(e,t){return this._pipelineContext.setArray3(e,t),this},i.prototype.setArray4=function(e,t){return this._pipelineContext.setArray4(e,t),this},i.prototype.setMatrices=function(e,t){return this._pipelineContext.setMatrices(e,t),this},i.prototype.setMatrix=function(e,t){return this._pipelineContext.setMatrix(e,t),this},i.prototype.setMatrix3x3=function(e,t){return this._pipelineContext.setMatrix3x3(e,t),this},i.prototype.setMatrix2x2=function(e,t){return this._pipelineContext.setMatrix2x2(e,t),this},i.prototype.setFloat=function(e,t){return this._pipelineContext.setFloat(e,t),this},i.prototype.setBool=function(e,t){return this._pipelineContext.setInt(e,t?1:0),this},i.prototype.setVector2=function(e,t){return this._pipelineContext.setVector2(e,t),this},i.prototype.setFloat2=function(e,t,r){return this._pipelineContext.setFloat2(e,t,r),this},i.prototype.setVector3=function(e,t){return this._pipelineContext.setVector3(e,t),this},i.prototype.setFloat3=function(e,t,r,n){return this._pipelineContext.setFloat3(e,t,r,n),this},i.prototype.setVector4=function(e,t){return this._pipelineContext.setVector4(e,t),this},i.prototype.setFloat4=function(e,t,r,n,a){return this._pipelineContext.setFloat4(e,t,r,n,a),this},i.prototype.setColor3=function(e,t){return this._pipelineContext.setColor3(e,t),this},i.prototype.setColor4=function(e,t,r){return this._pipelineContext.setColor4(e,t,r),this},i.prototype.setDirectColor4=function(e,t){return this._pipelineContext.setDirectColor4(e,t),this},i.prototype.dispose=function(){this._pipelineContext&&this._pipelineContext.dispose(),this._engine._releaseEffect(this)},i.RegisterShader=function(e,t,r,n){n===void 0&&(n=qe.GLSL),t&&(q.GetShadersStore(n)["".concat(e,"PixelShader")]=t),r&&(q.GetShadersStore(n)["".concat(e,"VertexShader")]=r)},i.ResetCache=function(){i._BaseCache={}},i.LogShaderCodeOnCompilationError=!0,i._UniqueIdSeed=0,i._BaseCache={},i.ShadersStore=q.ShadersStore,i.IncludesShadersStore=q.IncludesShadersStore,i}(),Do=function(){function i(e){e===void 0&&(e=!0),this._isDepthTestDirty=!1,this._isDepthMaskDirty=!1,this._isDepthFuncDirty=!1,this._isCullFaceDirty=!1,this._isCullDirty=!1,this._isZOffsetDirty=!1,this._isFrontFaceDirty=!1,e&&this.reset()}return Object.defineProperty(i.prototype,"isDirty",{get:function(){return this._isDepthFuncDirty||this._isDepthTestDirty||this._isDepthMaskDirty||this._isCullFaceDirty||this._isCullDirty||this._isZOffsetDirty||this._isFrontFaceDirty},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"zOffset",{get:function(){return this._zOffset},set:function(e){this._zOffset!==e&&(this._zOffset=e,this._isZOffsetDirty=!0)},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"zOffsetUnits",{get:function(){return this._zOffsetUnits},set:function(e){this._zOffsetUnits!==e&&(this._zOffsetUnits=e,this._isZOffsetDirty=!0)},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"cullFace",{get:function(){return this._cullFace},set:function(e){this._cullFace!==e&&(this._cullFace=e,this._isCullFaceDirty=!0)},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"cull",{get:function(){return this._cull},set:function(e){this._cull!==e&&(this._cull=e,this._isCullDirty=!0)},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"depthFunc",{get:function(){return this._depthFunc},set:function(e){this._depthFunc!==e&&(this._depthFunc=e,this._isDepthFuncDirty=!0)},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"depthMask",{get:function(){return this._depthMask},set:function(e){this._depthMask!==e&&(this._depthMask=e,this._isDepthMaskDirty=!0)},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"depthTest",{get:function(){return this._depthTest},set:function(e){this._depthTest!==e&&(this._depthTest=e,this._isDepthTestDirty=!0)},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"frontFace",{get:function(){return this._frontFace},set:function(e){this._frontFace!==e&&(this._frontFace=e,this._isFrontFaceDirty=!0)},enumerable:!1,configurable:!0}),i.prototype.reset=function(){this._depthMask=!0,this._depthTest=!0,this._depthFunc=null,this._cullFace=null,this._cull=null,this._zOffset=0,this._zOffsetUnits=0,this._frontFace=null,this._isDepthTestDirty=!0,this._isDepthMaskDirty=!0,this._isDepthFuncDirty=!1,this._isCullFaceDirty=!1,this._isCullDirty=!1,this._isZOffsetDirty=!0,this._isFrontFaceDirty=!1},i.prototype.apply=function(e){!this.isDirty||(this._isCullDirty&&(this.cull?e.enable(e.CULL_FACE):e.disable(e.CULL_FACE),this._isCullDirty=!1),this._isCullFaceDirty&&(e.cullFace(this.cullFace),this._isCullFaceDirty=!1),this._isDepthMaskDirty&&(e.depthMask(this.depthMask),this._isDepthMaskDirty=!1),this._isDepthTestDirty&&(this.depthTest?e.enable(e.DEPTH_TEST):e.disable(e.DEPTH_TEST),this._isDepthTestDirty=!1),this._isDepthFuncDirty&&(e.depthFunc(this.depthFunc),this._isDepthFuncDirty=!1),this._isZOffsetDirty&&(this.zOffset||this.zOffsetUnits?(e.enable(e.POLYGON_OFFSET_FILL),e.polygonOffset(this.zOffset,this.zOffsetUnits)):e.disable(e.POLYGON_OFFSET_FILL),this._isZOffsetDirty=!1),this._isFrontFaceDirty&&(e.frontFace(this.frontFace),this._isFrontFaceDirty=!1))},i}(),Oo=function(){function i(){this.reset()}return i.prototype.reset=function(){this.enabled=!1,this.mask=255,this.func=i.ALWAYS,this.funcRef=1,this.funcMask=255,this.opStencilFail=i.KEEP,this.opDepthFail=i.KEEP,this.opStencilDepthPass=i.REPLACE},Object.defineProperty(i.prototype,"stencilFunc",{get:function(){return this.func},set:function(e){this.func=e},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"stencilFuncRef",{get:function(){return this.funcRef},set:function(e){this.funcRef=e},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"stencilFuncMask",{get:function(){return this.funcMask},set:function(e){this.funcMask=e},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"stencilOpStencilFail",{get:function(){return this.opStencilFail},set:function(e){this.opStencilFail=e},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"stencilOpDepthFail",{get:function(){return this.opDepthFail},set:function(e){this.opDepthFail=e},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"stencilOpStencilDepthPass",{get:function(){return this.opStencilDepthPass},set:function(e){this.opStencilDepthPass=e},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"stencilMask",{get:function(){return this.mask},set:function(e){this.mask=e},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"stencilTest",{get:function(){return this.enabled},set:function(e){this.enabled=e},enumerable:!1,configurable:!0}),i.ALWAYS=519,i.KEEP=7680,i.REPLACE=7681,i}(),Io=function(){function i(){this._blendFunctionParameters=new Array(4),this._blendEquationParameters=new Array(2),this._blendConstants=new Array(4),this._isBlendConstantsDirty=!1,this._alphaBlend=!1,this._isAlphaBlendDirty=!1,this._isBlendFunctionParametersDirty=!1,this._isBlendEquationParametersDirty=!1,this.reset()}return Object.defineProperty(i.prototype,"isDirty",{get:function(){return this._isAlphaBlendDirty||this._isBlendFunctionParametersDirty||this._isBlendEquationParametersDirty},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"alphaBlend",{get:function(){return this._alphaBlend},set:function(e){this._alphaBlend!==e&&(this._alphaBlend=e,this._isAlphaBlendDirty=!0)},enumerable:!1,configurable:!0}),i.prototype.setAlphaBlendConstants=function(e,t,r,n){this._blendConstants[0]===e&&this._blendConstants[1]===t&&this._blendConstants[2]===r&&this._blendConstants[3]===n||(this._blendConstants[0]=e,this._blendConstants[1]=t,this._blendConstants[2]=r,this._blendConstants[3]=n,this._isBlendConstantsDirty=!0)},i.prototype.setAlphaBlendFunctionParameters=function(e,t,r,n){this._blendFunctionParameters[0]===e&&this._blendFunctionParameters[1]===t&&this._blendFunctionParameters[2]===r&&this._blendFunctionParameters[3]===n||(this._blendFunctionParameters[0]=e,this._blendFunctionParameters[1]=t,this._blendFunctionParameters[2]=r,this._blendFunctionParameters[3]=n,this._isBlendFunctionParametersDirty=!0)},i.prototype.setAlphaEquationParameters=function(e,t){this._blendEquationParameters[0]===e&&this._blendEquationParameters[1]===t||(this._blendEquationParameters[0]=e,this._blendEquationParameters[1]=t,this._isBlendEquationParametersDirty=!0)},i.prototype.reset=function(){this._alphaBlend=!1,this._blendFunctionParameters[0]=null,this._blendFunctionParameters[1]=null,this._blendFunctionParameters[2]=null,this._blendFunctionParameters[3]=null,this._blendEquationParameters[0]=null,this._blendEquationParameters[1]=null,this._blendConstants[0]=null,this._blendConstants[1]=null,this._blendConstants[2]=null,this._blendConstants[3]=null,this._isAlphaBlendDirty=!0,this._isBlendFunctionParametersDirty=!1,this._isBlendEquationParametersDirty=!1,this._isBlendConstantsDirty=!1},i.prototype.apply=function(e){!this.isDirty||(this._isAlphaBlendDirty&&(this._alphaBlend?e.enable(e.BLEND):e.disable(e.BLEND),this._isAlphaBlendDirty=!1),this._isBlendFunctionParametersDirty&&(e.blendFuncSeparate(this._blendFunctionParameters[0],this._blendFunctionParameters[1],this._blendFunctionParameters[2],this._blendFunctionParameters[3]),this._isBlendFunctionParametersDirty=!1),this._isBlendEquationParametersDirty&&(e.blendEquationSeparate(this._blendEquationParameters[0],this._blendEquationParameters[1]),this._isBlendEquationParametersDirty=!1),this._isBlendConstantsDirty&&(e.blendColor(this._blendConstants[0],this._blendConstants[1],this._blendConstants[2],this._blendConstants[3]),this._isBlendConstantsDirty=!1))},i}(),Fo=function(){function i(){this.samplingMode=-1,this._useMipMaps=!0,this._cachedWrapU=null,this._cachedWrapV=null,this._cachedWrapR=null,this._cachedAnisotropicFilteringLevel=null,this._comparisonFunction=0}return Object.defineProperty(i.prototype,"wrapU",{get:function(){return this._cachedWrapU},set:function(e){this._cachedWrapU=e},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"wrapV",{get:function(){return this._cachedWrapV},set:function(e){this._cachedWrapV=e},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"wrapR",{get:function(){return this._cachedWrapR},set:function(e){this._cachedWrapR=e},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"anisotropicFilteringLevel",{get:function(){return this._cachedAnisotropicFilteringLevel},set:function(e){this._cachedAnisotropicFilteringLevel=e},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"comparisonFunction",{get:function(){return this._comparisonFunction},set:function(e){this._comparisonFunction=e},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"useMipMaps",{get:function(){return this._useMipMaps},set:function(e){this._useMipMaps=e},enumerable:!1,configurable:!0}),i.prototype.setParameters=function(e,t,r,n,a,s){return e===void 0&&(e=1),t===void 0&&(t=1),r===void 0&&(r=1),n===void 0&&(n=1),a===void 0&&(a=2),s===void 0&&(s=0),this._cachedWrapU=e,this._cachedWrapV=t,this._cachedWrapR=r,this._cachedAnisotropicFilteringLevel=n,this.samplingMode=a,this._comparisonFunction=s,this},i.prototype.compareSampler=function(e){return this._cachedWrapU===e._cachedWrapU&&this._cachedWrapV===e._cachedWrapV&&this._cachedWrapR===e._cachedWrapR&&this._cachedAnisotropicFilteringLevel===e._cachedAnisotropicFilteringLevel&&this.samplingMode===e.samplingMode&&this._comparisonFunction===e._comparisonFunction&&this._useMipMaps===e._useMipMaps},i}(),Ie;(function(i){i[i.Unknown=0]="Unknown",i[i.Url=1]="Url",i[i.Temp=2]="Temp",i[i.Raw=3]="Raw",i[i.Dynamic=4]="Dynamic",i[i.RenderTarget=5]="RenderTarget",i[i.MultiRenderTarget=6]="MultiRenderTarget",i[i.Cube=7]="Cube",i[i.CubeRaw=8]="CubeRaw",i[i.CubePrefiltered=9]="CubePrefiltered",i[i.Raw3D=10]="Raw3D",i[i.Raw2DArray=11]="Raw2DArray",i[i.DepthStencil=12]="DepthStencil",i[i.CubeRawRGBD=13]="CubeRawRGBD",i[i.Depth=14]="Depth"})(Ie||(Ie={}));var at=function(i){$(e,i);function e(t,r,n){n===void 0&&(n=!1);var a=i.call(this)||this;return a.isReady=!1,a.isCube=!1,a.is3D=!1,a.is2DArray=!1,a.isMultiview=!1,a.url="",a.generateMipMaps=!1,a.samples=0,a.type=-1,a.format=-1,a.onLoadedObservable=new X,a.onErrorObservable=new X,a.onRebuildCallback=null,a.width=0,a.height=0,a.depth=0,a.baseWidth=0,a.baseHeight=0,a.baseDepth=0,a.invertY=!1,a._invertVScale=!1,a._associatedChannel=-1,a._source=Ie.Unknown,a._buffer=null,a._bufferView=null,a._bufferViewArray=null,a._bufferViewArrayArray=null,a._size=0,a._extension="",a._files=null,a._workingCanvas=null,a._workingContext=null,a._cachedCoordinatesMode=null,a._isDisabled=!1,a._compression=null,a._sphericalPolynomial=null,a._sphericalPolynomialPromise=null,a._sphericalPolynomialComputed=!1,a._lodGenerationScale=0,a._lodGenerationOffset=0,a._useSRGBBuffer=!1,a._lodTextureHigh=null,a._lodTextureMid=null,a._lodTextureLow=null,a._isRGBD=!1,a._linearSpecularLOD=!1,a._irradianceTexture=null,a._hardwareTexture=null,a._maxLodLevel=null,a._references=1,a._gammaSpace=null,a._engine=t,a._source=r,a._uniqueId=e._Counter++,n||(a._hardwareTexture=t._createHardwareTexture()),a}return Object.defineProperty(e.prototype,"useMipMaps",{get:function(){return this.generateMipMaps},set:function(t){this.generateMipMaps=t},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"uniqueId",{get:function(){return this._uniqueId},enumerable:!1,configurable:!0}),e.prototype.getEngine=function(){return this._engine},Object.defineProperty(e.prototype,"source",{get:function(){return this._source},enumerable:!1,configurable:!0}),e.prototype.incrementReferences=function(){this._references++},e.prototype.updateSize=function(t,r,n){n===void 0&&(n=1),this._engine.updateTextureDimensions(this,t,r,n),this.width=t,this.height=r,this.depth=n,this.baseWidth=t,this.baseHeight=r,this.baseDepth=n,this._size=t*r*n},e.prototype._rebuild=function(){var t=this,r;if(this.isReady=!1,this._cachedCoordinatesMode=null,this._cachedWrapU=null,this._cachedWrapV=null,this._cachedWrapR=null,this._cachedAnisotropicFilteringLevel=null,this.onRebuildCallback){var n=this.onRebuildCallback(this),a=function(o){o._swapAndDie(t,!1),t.isReady=n.isReady};n.isAsync?n.proxy.then(a):a(n.proxy);return}var s;switch(this.source){case Ie.Temp:break;case Ie.Url:s=this._engine.createTexture((r=this._originalUrl)!==null&&r!==void 0?r:this.url,!this.generateMipMaps,this.invertY,null,this.samplingMode,function(){s._swapAndDie(t,!1),t.isReady=!0},null,this._buffer,void 0,this.format,this._extension,void 0,void 0,void 0,this._useSRGBBuffer);return;case Ie.Raw:s=this._engine.createRawTexture(this._bufferView,this.baseWidth,this.baseHeight,this.format,this.generateMipMaps,this.invertY,this.samplingMode,this._compression,this.type),s._swapAndDie(this,!1),this.isReady=!0;break;case Ie.Raw3D:s=this._engine.createRawTexture3D(this._bufferView,this.baseWidth,this.baseHeight,this.baseDepth,this.format,this.generateMipMaps,this.invertY,this.samplingMode,this._compression,this.type),s._swapAndDie(this,!1),this.isReady=!0;break;case Ie.Raw2DArray:s=this._engine.createRawTexture2DArray(this._bufferView,this.baseWidth,this.baseHeight,this.baseDepth,this.format,this.generateMipMaps,this.invertY,this.samplingMode,this._compression,this.type),s._swapAndDie(this,!1),this.isReady=!0;break;case Ie.Dynamic:s=this._engine.createDynamicTexture(this.baseWidth,this.baseHeight,this.generateMipMaps,this.samplingMode),s._swapAndDie(this,!1),this._engine.updateDynamicTexture(this,this._engine.getRenderingCanvas(),this.invertY,void 0,void 0,!0);break;case Ie.Cube:s=this._engine.createCubeTexture(this.url,null,this._files,!this.generateMipMaps,function(){s._swapAndDie(t,!1),t.isReady=!0},null,this.format,this._extension,!1,0,0,null,void 0,this._useSRGBBuffer);return;case Ie.CubeRaw:s=this._engine.createRawCubeTexture(this._bufferViewArray,this.width,this.format,this.type,this.generateMipMaps,this.invertY,this.samplingMode,this._compression),s._swapAndDie(this,!1),this.isReady=!0;break;case Ie.CubeRawRGBD:return;case Ie.CubePrefiltered:s=this._engine.createPrefilteredCubeTexture(this.url,null,this._lodGenerationScale,this._lodGenerationOffset,function(o){o&&o._swapAndDie(t,!1),t.isReady=!0},null,this.format,this._extension),s._sphericalPolynomial=this._sphericalPolynomial;return}},e.prototype._swapAndDie=function(t,r){var n;r===void 0&&(r=!0),(n=this._hardwareTexture)===null||n===void 0||n.setUsage(t._source,this.generateMipMaps,this.isCube,this.width,this.height),t._hardwareTexture=this._hardwareTexture,r&&(t._isRGBD=this._isRGBD),this._lodTextureHigh&&(t._lodTextureHigh&&t._lodTextureHigh.dispose(),t._lodTextureHigh=this._lodTextureHigh),this._lodTextureMid&&(t._lodTextureMid&&t._lodTextureMid.dispose(),t._lodTextureMid=this._lodTextureMid),this._lodTextureLow&&(t._lodTextureLow&&t._lodTextureLow.dispose(),t._lodTextureLow=this._lodTextureLow),this._irradianceTexture&&(t._irradianceTexture&&t._irradianceTexture.dispose(),t._irradianceTexture=this._irradianceTexture);var a=this._engine.getLoadedTexturesCache(),s=a.indexOf(this);s!==-1&&a.splice(s,1),s=a.indexOf(t),s===-1&&a.push(t)},e.prototype.dispose=function(){this._references--,this.onLoadedObservable.clear(),this.onErrorObservable.clear(),this._references===0&&(this._engine._releaseTexture(this),this._hardwareTexture=null)},e._Counter=0,e}(Fo),wo=function(){function i(){this.shaderLanguage=qe.GLSL}return i.prototype.postProcessor=function(e,t,r,n,a){if(!a.getCaps().drawBuffersExtension){var s=/#extension.+GL_EXT_draw_buffers.+(enable|require)/g;e=e.replace(s,"")}return e},i}(),Lo=function(){function i(){this.shaderLanguage=qe.GLSL}return i.prototype.attributeProcessor=function(e){return e.replace("attribute","in")},i.prototype.varyingProcessor=function(e,t){return e.replace("varying",t?"in":"out")},i.prototype.postProcessor=function(e,t,r){var n=e.search(/#extension.+GL_EXT_draw_buffers.+require/)!==-1,a=/#extension.+(GL_OVR_multiview2|GL_OES_standard_derivatives|GL_EXT_shader_texture_lod|GL_EXT_frag_depth|GL_EXT_draw_buffers).+(enable|require)/g;if(e=e.replace(a,""),e=e.replace(/texture2D\s*\(/g,"texture("),r)e=e.replace(/texture2DLodEXT\s*\(/g,"textureLod("),e=e.replace(/textureCubeLodEXT\s*\(/g,"textureLod("),e=e.replace(/textureCube\s*\(/g,"texture("),e=e.replace(/gl_FragDepthEXT/g,"gl_FragDepth"),e=e.replace(/gl_FragColor/g,"glFragColor"),e=e.replace(/gl_FragData/g,"glFragData"),e=e.replace(/void\s+?main\s*\(/g,(n?"":`out vec4 glFragColor;
`)+"void main(");else{var s=t.indexOf("#define MULTIVIEW")!==-1;if(s)return`#extension GL_OVR_multiview2 : require
layout (num_views = 2) in;
`+e}return e},i}(),Ir=function(i){$(e,i);function e(t){var r=i.call(this)||this;return r._buffer=t,r}return Object.defineProperty(e.prototype,"underlyingResource",{get:function(){return this._buffer},enumerable:!1,configurable:!0}),e}(xa),No=function(){function i(){this._valueCache={},this.vertexCompilationError=null,this.fragmentCompilationError=null,this.programLinkError=null,this.programValidationError=null}return Object.defineProperty(i.prototype,"isAsync",{get:function(){return this.isParallelCompiled},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"isReady",{get:function(){return this.program?this.isParallelCompiled?this.engine._isRenderingStateCompiled(this):!0:!1},enumerable:!1,configurable:!0}),i.prototype._handlesSpectorRebuildCallback=function(e){e&&this.program&&e(this.program)},i.prototype._fillEffectInformation=function(e,t,r,n,a,s,o,l){var u=this.engine;if(u.supportsUniformBuffers)for(var f in t)e.bindUniformBlock(f,t[f]);var h=this.engine.getUniforms(this,r);h.forEach(function(v,y){n[r[y]]=v}),this._uniforms=n;var c;for(c=0;c<a.length;c++){var d=e.getUniform(a[c]);d==null&&(a.splice(c,1),c--)}a.forEach(function(v,y){s[v]=y});for(var p=0,_=u.getAttributes(this,o);p<_.length;p++){var g=_[p];l.push(g)}},i.prototype.dispose=function(){this._uniforms={}},i.prototype._cacheMatrix=function(e,t){var r=this._valueCache[e],n=t.updateFlag;return r!==void 0&&r===n?!1:(this._valueCache[e]=n,!0)},i.prototype._cacheFloat2=function(e,t,r){var n=this._valueCache[e];if(!n||n.length!==2)return n=[t,r],this._valueCache[e]=n,!0;var a=!1;return n[0]!==t&&(n[0]=t,a=!0),n[1]!==r&&(n[1]=r,a=!0),a},i.prototype._cacheFloat3=function(e,t,r,n){var a=this._valueCache[e];if(!a||a.length!==3)return a=[t,r,n],this._valueCache[e]=a,!0;var s=!1;return a[0]!==t&&(a[0]=t,s=!0),a[1]!==r&&(a[1]=r,s=!0),a[2]!==n&&(a[2]=n,s=!0),s},i.prototype._cacheFloat4=function(e,t,r,n,a){var s=this._valueCache[e];if(!s||s.length!==4)return s=[t,r,n,a],this._valueCache[e]=s,!0;var o=!1;return s[0]!==t&&(s[0]=t,o=!0),s[1]!==r&&(s[1]=r,o=!0),s[2]!==n&&(s[2]=n,o=!0),s[3]!==a&&(s[3]=a,o=!0),o},i.prototype.setInt=function(e,t){var r=this._valueCache[e];r!==void 0&&r===t||this.engine.setInt(this._uniforms[e],t)&&(this._valueCache[e]=t)},i.prototype.setInt2=function(e,t,r){this._cacheFloat2(e,t,r)&&(this.engine.setInt2(this._uniforms[e],t,r)||(this._valueCache[e]=null))},i.prototype.setInt3=function(e,t,r,n){this._cacheFloat3(e,t,r,n)&&(this.engine.setInt3(this._uniforms[e],t,r,n)||(this._valueCache[e]=null))},i.prototype.setInt4=function(e,t,r,n,a){this._cacheFloat4(e,t,r,n,a)&&(this.engine.setInt4(this._uniforms[e],t,r,n,a)||(this._valueCache[e]=null))},i.prototype.setIntArray=function(e,t){this._valueCache[e]=null,this.engine.setIntArray(this._uniforms[e],t)},i.prototype.setIntArray2=function(e,t){this._valueCache[e]=null,this.engine.setIntArray2(this._uniforms[e],t)},i.prototype.setIntArray3=function(e,t){this._valueCache[e]=null,this.engine.setIntArray3(this._uniforms[e],t)},i.prototype.setIntArray4=function(e,t){this._valueCache[e]=null,this.engine.setIntArray4(this._uniforms[e],t)},i.prototype.setArray=function(e,t){this._valueCache[e]=null,this.engine.setArray(this._uniforms[e],t)},i.prototype.setArray2=function(e,t){this._valueCache[e]=null,this.engine.setArray2(this._uniforms[e],t)},i.prototype.setArray3=function(e,t){this._valueCache[e]=null,this.engine.setArray3(this._uniforms[e],t)},i.prototype.setArray4=function(e,t){this._valueCache[e]=null,this.engine.setArray4(this._uniforms[e],t)},i.prototype.setMatrices=function(e,t){!t||(this._valueCache[e]=null,this.engine.setMatrices(this._uniforms[e],t))},i.prototype.setMatrix=function(e,t){this._cacheMatrix(e,t)&&(this.engine.setMatrices(this._uniforms[e],t.toArray())||(this._valueCache[e]=null))},i.prototype.setMatrix3x3=function(e,t){this._valueCache[e]=null,this.engine.setMatrix3x3(this._uniforms[e],t)},i.prototype.setMatrix2x2=function(e,t){this._valueCache[e]=null,this.engine.setMatrix2x2(this._uniforms[e],t)},i.prototype.setFloat=function(e,t){var r=this._valueCache[e];r!==void 0&&r===t||this.engine.setFloat(this._uniforms[e],t)&&(this._valueCache[e]=t)},i.prototype.setVector2=function(e,t){this._cacheFloat2(e,t.x,t.y)&&(this.engine.setFloat2(this._uniforms[e],t.x,t.y)||(this._valueCache[e]=null))},i.prototype.setFloat2=function(e,t,r){this._cacheFloat2(e,t,r)&&(this.engine.setFloat2(this._uniforms[e],t,r)||(this._valueCache[e]=null))},i.prototype.setVector3=function(e,t){this._cacheFloat3(e,t.x,t.y,t.z)&&(this.engine.setFloat3(this._uniforms[e],t.x,t.y,t.z)||(this._valueCache[e]=null))},i.prototype.setFloat3=function(e,t,r,n){this._cacheFloat3(e,t,r,n)&&(this.engine.setFloat3(this._uniforms[e],t,r,n)||(this._valueCache[e]=null))},i.prototype.setVector4=function(e,t){this._cacheFloat4(e,t.x,t.y,t.z,t.w)&&(this.engine.setFloat4(this._uniforms[e],t.x,t.y,t.z,t.w)||(this._valueCache[e]=null))},i.prototype.setFloat4=function(e,t,r,n,a){this._cacheFloat4(e,t,r,n,a)&&(this.engine.setFloat4(this._uniforms[e],t,r,n,a)||(this._valueCache[e]=null))},i.prototype.setColor3=function(e,t){this._cacheFloat3(e,t.r,t.g,t.b)&&(this.engine.setFloat3(this._uniforms[e],t.r,t.g,t.b)||(this._valueCache[e]=null))},i.prototype.setColor4=function(e,t,r){this._cacheFloat4(e,t.r,t.g,t.b,r)&&(this.engine.setFloat4(this._uniforms[e],t.r,t.g,t.b,r)||(this._valueCache[e]=null))},i.prototype.setDirectColor4=function(e,t){this._cacheFloat4(e,t.r,t.g,t.b,t.a)&&(this.engine.setFloat4(this._uniforms[e],t.r,t.g,t.b,t.a)||(this._valueCache[e]=null))},i.prototype._getVertexShaderCode=function(){return this.vertexShader?this.engine._getShaderSource(this.vertexShader):null},i.prototype._getFragmentShaderCode=function(){return this.fragmentShader?this.engine._getShaderSource(this.fragmentShader):null},i}(),wa=function(){function i(e,t){if(e===void 0&&(e=null),this._MSAARenderBuffer=null,this._context=t,!e&&(e=t.createTexture(),!e))throw new Error("Unable to create webGL texture");this.set(e)}return Object.defineProperty(i.prototype,"underlyingResource",{get:function(){return this._webGLTexture},enumerable:!1,configurable:!0}),i.prototype.setUsage=function(){},i.prototype.set=function(e){this._webGLTexture=e},i.prototype.reset=function(){this._webGLTexture=null,this._MSAARenderBuffer=null},i.prototype.release=function(){this._MSAARenderBuffer&&(this._context.deleteRenderbuffer(this._MSAARenderBuffer),this._MSAARenderBuffer=null),this._webGLTexture&&this._context.deleteTexture(this._webGLTexture),this.reset()},i}(),Bt=function(){function i(e,t){t===void 0&&(t=!0),this.effect=null,this.defines=null,this.drawContext=e.createDrawContext(),t&&(this.materialContext=e.createMaterialContext())}return i.IsWrapper=function(e){return e.getPipelineContext===void 0},i.GetEffect=function(e){return e.getPipelineContext===void 0?e.effect:e},i.prototype.setEffect=function(e,t,r){var n;r===void 0&&(r=!0),this.effect=e,t!==void 0&&(this.defines=t),r&&((n=this.drawContext)===null||n===void 0||n.reset())},i.prototype.dispose=function(){var e;(e=this.drawContext)===null||e===void 0||e.dispose()},i}(),Bo=function(){function i(e){e===void 0&&(e=!0),this._isStencilTestDirty=!1,this._isStencilMaskDirty=!1,this._isStencilFuncDirty=!1,this._isStencilOpDirty=!1,this.useStencilGlobalOnly=!1,e&&this.reset()}return Object.defineProperty(i.prototype,"isDirty",{get:function(){return this._isStencilTestDirty||this._isStencilMaskDirty||this._isStencilFuncDirty||this._isStencilOpDirty},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"func",{get:function(){return this._func},set:function(e){this._func!==e&&(this._func=e,this._isStencilFuncDirty=!0)},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"funcRef",{get:function(){return this._funcRef},set:function(e){this._funcRef!==e&&(this._funcRef=e,this._isStencilFuncDirty=!0)},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"funcMask",{get:function(){return this._funcMask},set:function(e){this._funcMask!==e&&(this._funcMask=e,this._isStencilFuncDirty=!0)},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"opStencilFail",{get:function(){return this._opStencilFail},set:function(e){this._opStencilFail!==e&&(this._opStencilFail=e,this._isStencilOpDirty=!0)},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"opDepthFail",{get:function(){return this._opDepthFail},set:function(e){this._opDepthFail!==e&&(this._opDepthFail=e,this._isStencilOpDirty=!0)},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"opStencilDepthPass",{get:function(){return this._opStencilDepthPass},set:function(e){this._opStencilDepthPass!==e&&(this._opStencilDepthPass=e,this._isStencilOpDirty=!0)},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"mask",{get:function(){return this._mask},set:function(e){this._mask!==e&&(this._mask=e,this._isStencilMaskDirty=!0)},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"enabled",{get:function(){return this._enabled},set:function(e){this._enabled!==e&&(this._enabled=e,this._isStencilTestDirty=!0)},enumerable:!1,configurable:!0}),i.prototype.reset=function(){var e;this.stencilMaterial=void 0,(e=this.stencilGlobal)===null||e===void 0||e.reset(),this._isStencilTestDirty=!0,this._isStencilMaskDirty=!0,this._isStencilFuncDirty=!0,this._isStencilOpDirty=!0},i.prototype.apply=function(e){var t;if(!!e){var r=!this.useStencilGlobalOnly&&!!(!((t=this.stencilMaterial)===null||t===void 0)&&t.enabled);this.enabled=r?this.stencilMaterial.enabled:this.stencilGlobal.enabled,this.func=r?this.stencilMaterial.func:this.stencilGlobal.func,this.funcRef=r?this.stencilMaterial.funcRef:this.stencilGlobal.funcRef,this.funcMask=r?this.stencilMaterial.funcMask:this.stencilGlobal.funcMask,this.opStencilFail=r?this.stencilMaterial.opStencilFail:this.stencilGlobal.opStencilFail,this.opDepthFail=r?this.stencilMaterial.opDepthFail:this.stencilGlobal.opDepthFail,this.opStencilDepthPass=r?this.stencilMaterial.opStencilDepthPass:this.stencilGlobal.opStencilDepthPass,this.mask=r?this.stencilMaterial.mask:this.stencilGlobal.mask,this.isDirty&&(this._isStencilTestDirty&&(this.enabled?e.enable(e.STENCIL_TEST):e.disable(e.STENCIL_TEST),this._isStencilTestDirty=!1),this._isStencilMaskDirty&&(e.stencilMask(this.mask),this._isStencilMaskDirty=!1),this._isStencilFuncDirty&&(e.stencilFunc(this.func,this.funcRef,this.funcMask),this._isStencilFuncDirty=!1),this._isStencilOpDirty&&(e.stencilOp(this.opStencilFail,this.opDepthFail,this.opStencilDepthPass),this._isStencilOpDirty=!1))}},i}(),Uo=function(){function i(){}return i}(),ge=function(){function i(e,t,r,n){var a=this;this._name="WebGL",this.forcePOTTextures=!1,this.isFullscreen=!1,this.cullBackFaces=null,this.renderEvenInBackground=!0,this.preventCacheWipeBetweenFrames=!1,this.validateShaderPrograms=!1,this._useReverseDepthBuffer=!1,this.isNDCHalfZRange=!1,this.hasOriginBottomLeft=!0,this.disableUniformBuffers=!1,this.onDisposeObservable=new X,this._frameId=0,this._uniformBuffers=new Array,this._storageBuffers=new Array,this._webGLVersion=1,this._windowIsBackground=!1,this._highPrecisionShadersAllowed=!0,this._badOS=!1,this._badDesktopOS=!1,this._renderingQueueLaunched=!1,this._activeRenderLoops=new Array,this.onContextLostObservable=new X,this.onContextRestoredObservable=new X,this._contextWasLost=!1,this._doNotHandleContextLost=!1,this.disableVertexArrayObjects=!1,this._colorWrite=!0,this._colorWriteChanged=!0,this._depthCullingState=new Do,this._stencilStateComposer=new Bo,this._stencilState=new Oo,this._alphaState=new Io,this._alphaMode=1,this._alphaEquation=0,this._internalTexturesCache=new Array,this._renderTargetWrapperCache=new Array,this._activeChannel=0,this._currentTextureChannel=-1,this._boundTexturesCache={},this._compiledEffects={},this._vertexAttribArraysEnabled=[],this._uintIndicesCurrentlySet=!1,this._currentBoundBuffer=new Array,this._currentFramebuffer=null,this._dummyFramebuffer=null,this._currentBufferPointers=new Array,this._currentInstanceLocations=new Array,this._currentInstanceBuffers=new Array,this._vaoRecordInProgress=!1,this._mustWipeVertexAttributes=!1,this._nextFreeTextureSlots=new Array,this._maxSimultaneousTextures=0,this._activeRequests=new Array,this._adaptToDeviceRatio=!1,this._transformTextureUrl=null,this.hostInformation={isMobile:!1},this.premultipliedAlpha=!0,this.onBeforeTextureInitObservable=new X,this._isWebGPU=!1,this._snapshotRenderingMode=0,this._viewportCached={x:0,y:0,z:0,w:0},this._unpackFlipYCached=null,this.enableUnpackFlipYCached=!0,this._boundUniforms={};var s=null;if(r=r||{},this._creationOptions=r,this._adaptToDeviceRatio=n!=null?n:!1,this._stencilStateComposer.stencilGlobal=this._stencilState,tr.SetMatrixPrecision(!!r.useHighPrecisionMatrix),!!e){if(n=n||r.adaptToDeviceRatio||!1,e.getContext){if(s=e,this._renderingCanvas=s,t!==void 0&&(r.antialias=t),r.deterministicLockstep===void 0&&(r.deterministicLockstep=!1),r.lockstepMaxSteps===void 0&&(r.lockstepMaxSteps=4),r.timeStep===void 0&&(r.timeStep=1/60),r.preserveDrawingBuffer===void 0&&(r.preserveDrawingBuffer=!1),r.audioEngine===void 0&&(r.audioEngine=!0),r.audioEngineOptions!==void 0&&r.audioEngineOptions.audioContext!==void 0&&(this._audioContext=r.audioEngineOptions.audioContext),r.audioEngineOptions!==void 0&&r.audioEngineOptions.audioDestination!==void 0&&(this._audioDestination=r.audioEngineOptions.audioDestination),r.stencil===void 0&&(r.stencil=!0),r.premultipliedAlpha===!1&&(this.premultipliedAlpha=!1),r.xrCompatible===void 0&&(r.xrCompatible=!0),this._doNotHandleContextLost=!!r.doNotHandleContextLost,navigator&&navigator.userAgent){this._checkForMobile=function(){var P=navigator.userAgent;a.hostInformation.isMobile=P.indexOf("Mobile")!==-1||P.indexOf("Mac")!==-1&&Qi()&&"ontouchend"in document},this._checkForMobile(),ze()&&window.addEventListener("resize",this._checkForMobile);for(var o=navigator.userAgent,l=0,u=i.ExceptionList;l<u.length;l++){var f=u[l],h=f.key,c=f.targets,d=new RegExp(h);if(d.test(o)){if(f.capture&&f.captureConstraint){var p=f.capture,_=f.captureConstraint,g=new RegExp(p),v=g.exec(o);if(v&&v.length>0){var y=parseInt(v[v.length-1]);if(y>=_)continue}}for(var b=0,E=c;b<E.length;b++){var A=E[b];switch(A){case"uniformBuffer":this.disableUniformBuffers=!0;break;case"vao":this.disableVertexArrayObjects=!0;break}}}}}if(this._doNotHandleContextLost||(this._onContextLost=function(P){P.preventDefault(),a._contextWasLost=!0,Y.Warn("WebGL context lost."),a.onContextLostObservable.notifyObservers(a)},this._onContextRestored=function(){a._restoreEngineAfterContextLost(a._initGLContext.bind(a))},s.addEventListener("webglcontextlost",this._onContextLost,!1),s.addEventListener("webglcontextrestored",this._onContextRestored,!1),r.powerPreference="high-performance"),this._badDesktopOS=/^((?!chrome|android).)*safari/i.test(navigator.userAgent),this._badDesktopOS&&(r.xrCompatible=!1),!r.disableWebGL2Support)try{this._gl=s.getContext("webgl2",r)||s.getContext("experimental-webgl2",r),this._gl&&(this._webGLVersion=2,this._shaderPlatformName="WEBGL2",this._gl.deleteQuery||(this._webGLVersion=1,this._shaderPlatformName="WEBGL1"))}catch{}if(!this._gl){if(!s)throw new Error("The provided canvas is null or undefined.");try{this._gl=s.getContext("webgl",r)||s.getContext("experimental-webgl",r)}catch{throw new Error("WebGL not supported")}}if(!this._gl)throw new Error("WebGL not supported")}else{this._gl=e,this._renderingCanvas=this._gl.canvas,this._gl.renderbufferStorageMultisample?(this._webGLVersion=2,this._shaderPlatformName="WEBGL2"):this._shaderPlatformName="WEBGL1";var S=this._gl.getContextAttributes();S&&(r.stencil=S.stencil)}this._gl.pixelStorei(this._gl.UNPACK_COLORSPACE_CONVERSION_WEBGL,this._gl.NONE),r.useHighPrecisionFloats!==void 0&&(this._highPrecisionShadersAllowed=r.useHighPrecisionFloats);var T=ze()&&window.devicePixelRatio||1,M=r.limitDeviceRatio||T;this._hardwareScalingLevel=n?1/Math.min(M,T):1,this.resize(),this._isStencilEnable=!!r.stencil,this._initGLContext(),this._initFeatures();for(var D=0;D<this._caps.maxVertexAttribs;D++)this._currentBufferPointers[D]=new Uo;this._shaderProcessor=this.webGLVersion>1?new Lo:new wo,this._badOS=/iPad/i.test(navigator.userAgent)||/iPhone/i.test(navigator.userAgent);var x="Babylon.js v".concat(i.Version);console.log(x+" - ".concat(this.description)),this._renderingCanvas&&this._renderingCanvas.setAttribute&&this._renderingCanvas.setAttribute("data-engine",x)}}return Object.defineProperty(i,"NpmPackage",{get:function(){return"babylonjs@5.0.3"},enumerable:!1,configurable:!0}),Object.defineProperty(i,"Version",{get:function(){return"5.0.3"},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"description",{get:function(){var e=this.name+this.webGLVersion;return this._caps.parallelShaderCompile&&(e+=" - Parallel shader compilation"),e},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"name",{get:function(){return this._name},set:function(e){this._name=e},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"version",{get:function(){return this._webGLVersion},enumerable:!1,configurable:!0}),Object.defineProperty(i,"ShadersRepository",{get:function(){return Kt.ShadersRepository},set:function(e){Kt.ShadersRepository=e},enumerable:!1,configurable:!0}),i.prototype._getShaderProcessor=function(e){return this._shaderProcessor},Object.defineProperty(i.prototype,"useReverseDepthBuffer",{get:function(){return this._useReverseDepthBuffer},set:function(e){e!==this._useReverseDepthBuffer&&(this._useReverseDepthBuffer=e,e?this._depthCullingState.depthFunc=518:this._depthCullingState.depthFunc=515)},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"frameId",{get:function(){return this._frameId},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"supportsUniformBuffers",{get:function(){return this.webGLVersion>1&&!this.disableUniformBuffers},enumerable:!1,configurable:!0}),i.prototype.getCreationOptions=function(){return this._creationOptions},Object.defineProperty(i.prototype,"_shouldUseHighPrecisionShader",{get:function(){return!!(this._caps.highPrecisionShaderSupported&&this._highPrecisionShadersAllowed)},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"needPOTTextures",{get:function(){return this._webGLVersion<2||this.forcePOTTextures},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"activeRenderLoops",{get:function(){return this._activeRenderLoops},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"doNotHandleContextLost",{get:function(){return this._doNotHandleContextLost},set:function(e){this._doNotHandleContextLost=e},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"_supportsHardwareTextureRescaling",{get:function(){return!1},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"framebufferDimensionsObject",{set:function(e){this._framebufferDimensionsObject=e},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"currentViewport",{get:function(){return this._cachedViewport},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"emptyTexture",{get:function(){return this._emptyTexture||(this._emptyTexture=this.createRawTexture(new Uint8Array(4),1,1,5,!1,!1,1)),this._emptyTexture},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"emptyTexture3D",{get:function(){return this._emptyTexture3D||(this._emptyTexture3D=this.createRawTexture3D(new Uint8Array(4),1,1,1,5,!1,!1,1)),this._emptyTexture3D},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"emptyTexture2DArray",{get:function(){return this._emptyTexture2DArray||(this._emptyTexture2DArray=this.createRawTexture2DArray(new Uint8Array(4),1,1,1,5,!1,!1,1)),this._emptyTexture2DArray},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"emptyCubeTexture",{get:function(){if(!this._emptyCubeTexture){var e=new Uint8Array(4),t=[e,e,e,e,e,e];this._emptyCubeTexture=this.createRawCubeTexture(t,1,5,0,!1,!1,1)}return this._emptyCubeTexture},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"isWebGPU",{get:function(){return this._isWebGPU},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"shaderPlatformName",{get:function(){return this._shaderPlatformName},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"snapshotRendering",{get:function(){return!1},set:function(e){},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"snapshotRenderingMode",{get:function(){return this._snapshotRenderingMode},set:function(e){this._snapshotRenderingMode=e},enumerable:!1,configurable:!0}),i.prototype.snapshotRenderingReset=function(){this.snapshotRendering=!1},i._CreateCanvas=function(e,t){if(typeof document=="undefined")return new OffscreenCanvas(e,t);var r=document.createElement("canvas");return r.width=e,r.height=t,r},i.prototype.createCanvas=function(e,t){return i._CreateCanvas(e,t)},i.prototype.createCanvasImage=function(){return document.createElement("img")},i.prototype._restoreEngineAfterContextLost=function(e){var t=this;setTimeout(function(){return qi(t,void 0,void 0,function(){var r,n,a,s,o;return gr(this,function(l){switch(l.label){case 0:return this._dummyFramebuffer=null,r=this._depthCullingState.depthTest,n=this._depthCullingState.depthFunc,a=this._depthCullingState.depthMask,s=this._stencilState.stencilTest,[4,e()];case 1:return l.sent(),this._rebuildEffects(),(o=this._rebuildComputeEffects)===null||o===void 0||o.call(this),this._rebuildInternalTextures(),this._rebuildRenderTargetWrappers(),this._rebuildBuffers(),this.wipeCaches(!0),this._depthCullingState.depthTest=r,this._depthCullingState.depthFunc=n,this._depthCullingState.depthMask=a,this._stencilState.stencilTest=s,Y.Warn(this.name+" context successfully restored."),this.onContextRestoredObservable.notifyObservers(this),this._contextWasLost=!1,[2]}})})},0)},i.prototype._sharedInit=function(e,t,r){this._renderingCanvas=e},i.prototype._getShaderProcessingContext=function(e){return null},i.prototype._rebuildInternalTextures=function(){for(var e=this._internalTexturesCache.slice(),t=0,r=e;t<r.length;t++){var n=r[t];n._rebuild()}},i.prototype._rebuildRenderTargetWrappers=function(){for(var e=this._renderTargetWrapperCache.slice(),t=0,r=e;t<r.length;t++){var n=r[t];n._rebuild()}},i.prototype._rebuildEffects=function(){for(var e in this._compiledEffects){var t=this._compiledEffects[e];t._pipelineContext=null,t._wasPreviouslyReady=!1,t._prepareEffect()}Kt.ResetCache()},i.prototype.areAllEffectsReady=function(){for(var e in this._compiledEffects){var t=this._compiledEffects[e];if(!t.isReady())return!1}return!0},i.prototype._rebuildBuffers=function(){for(var e=0,t=this._uniformBuffers;e<t.length;e++){var r=t[e];r._rebuild()}for(var n=0,a=this._storageBuffers;n<a.length;n++){var s=a[n];s._rebuild()}},i.prototype._initGLContext=function(){this._caps={maxTexturesImageUnits:this._gl.getParameter(this._gl.MAX_TEXTURE_IMAGE_UNITS),maxCombinedTexturesImageUnits:this._gl.getParameter(this._gl.MAX_COMBINED_TEXTURE_IMAGE_UNITS),maxVertexTextureImageUnits:this._gl.getParameter(this._gl.MAX_VERTEX_TEXTURE_IMAGE_UNITS),maxTextureSize:this._gl.getParameter(this._gl.MAX_TEXTURE_SIZE),maxSamples:this._webGLVersion>1?this._gl.getParameter(this._gl.MAX_SAMPLES):1,maxCubemapTextureSize:this._gl.getParameter(this._gl.MAX_CUBE_MAP_TEXTURE_SIZE),maxRenderTextureSize:this._gl.getParameter(this._gl.MAX_RENDERBUFFER_SIZE),maxVertexAttribs:this._gl.getParameter(this._gl.MAX_VERTEX_ATTRIBS),maxVaryingVectors:this._gl.getParameter(this._gl.MAX_VARYING_VECTORS),maxFragmentUniformVectors:this._gl.getParameter(this._gl.MAX_FRAGMENT_UNIFORM_VECTORS),maxVertexUniformVectors:this._gl.getParameter(this._gl.MAX_VERTEX_UNIFORM_VECTORS),parallelShaderCompile:this._gl.getExtension("KHR_parallel_shader_compile")||void 0,standardDerivatives:this._webGLVersion>1||this._gl.getExtension("OES_standard_derivatives")!==null,maxAnisotropy:1,astc:this._gl.getExtension("WEBGL_compressed_texture_astc")||this._gl.getExtension("WEBKIT_WEBGL_compressed_texture_astc"),bptc:this._gl.getExtension("EXT_texture_compression_bptc")||this._gl.getExtension("WEBKIT_EXT_texture_compression_bptc"),s3tc:this._gl.getExtension("WEBGL_compressed_texture_s3tc")||this._gl.getExtension("WEBKIT_WEBGL_compressed_texture_s3tc"),s3tc_srgb:this._gl.getExtension("WEBGL_compressed_texture_s3tc_srgb")||this._gl.getExtension("WEBKIT_WEBGL_compressed_texture_s3tc_srgb"),pvrtc:this._gl.getExtension("WEBGL_compressed_texture_pvrtc")||this._gl.getExtension("WEBKIT_WEBGL_compressed_texture_pvrtc"),etc1:this._gl.getExtension("WEBGL_compressed_texture_etc1")||this._gl.getExtension("WEBKIT_WEBGL_compressed_texture_etc1"),etc2:this._gl.getExtension("WEBGL_compressed_texture_etc")||this._gl.getExtension("WEBKIT_WEBGL_compressed_texture_etc")||this._gl.getExtension("WEBGL_compressed_texture_es3_0"),textureAnisotropicFilterExtension:this._gl.getExtension("EXT_texture_filter_anisotropic")||this._gl.getExtension("WEBKIT_EXT_texture_filter_anisotropic")||this._gl.getExtension("MOZ_EXT_texture_filter_anisotropic"),uintIndices:this._webGLVersion>1||this._gl.getExtension("OES_element_index_uint")!==null,fragmentDepthSupported:this._webGLVersion>1||this._gl.getExtension("EXT_frag_depth")!==null,highPrecisionShaderSupported:!1,timerQuery:this._gl.getExtension("EXT_disjoint_timer_query_webgl2")||this._gl.getExtension("EXT_disjoint_timer_query"),supportOcclusionQuery:this._webGLVersion>1,canUseTimestampForTimerQuery:!1,drawBuffersExtension:!1,maxMSAASamples:1,colorBufferFloat:!!(this._webGLVersion>1&&this._gl.getExtension("EXT_color_buffer_float")),textureFloat:!!(this._webGLVersion>1||this._gl.getExtension("OES_texture_float")),textureHalfFloat:!!(this._webGLVersion>1||this._gl.getExtension("OES_texture_half_float")),textureHalfFloatRender:!1,textureFloatLinearFiltering:!1,textureFloatRender:!1,textureHalfFloatLinearFiltering:!1,vertexArrayObject:!1,instancedArrays:!1,textureLOD:!!(this._webGLVersion>1||this._gl.getExtension("EXT_shader_texture_lod")),blendMinMax:!1,multiview:this._gl.getExtension("OVR_multiview2"),oculusMultiview:this._gl.getExtension("OCULUS_multiview"),depthTextureExtension:!1,canUseGLInstanceID:this._webGLVersion>1,canUseGLVertexID:this._webGLVersion>1,supportComputeShaders:!1,supportSRGBBuffers:!1,supportTransformFeedbacks:this._webGLVersion>1,textureMaxLevel:this._webGLVersion>1},this._glVersion=this._gl.getParameter(this._gl.VERSION);var e=this._gl.getExtension("WEBGL_debug_renderer_info");if(e!=null&&(this._glRenderer=this._gl.getParameter(e.UNMASKED_RENDERER_WEBGL),this._glVendor=this._gl.getParameter(e.UNMASKED_VENDOR_WEBGL)),this._glVendor||(this._glVendor=this._gl.getParameter(this._gl.VENDOR)||"Unknown vendor"),this._glRenderer||(this._glRenderer=this._gl.getParameter(this._gl.RENDERER)||"Unknown renderer"),this._gl.HALF_FLOAT_OES!==36193&&(this._gl.HALF_FLOAT_OES=36193),this._gl.RGBA16F!==34842&&(this._gl.RGBA16F=34842),this._gl.RGBA32F!==34836&&(this._gl.RGBA32F=34836),this._gl.DEPTH24_STENCIL8!==35056&&(this._gl.DEPTH24_STENCIL8=35056),this._caps.timerQuery&&(this._webGLVersion===1&&(this._gl.getQuery=this._caps.timerQuery.getQueryEXT.bind(this._caps.timerQuery)),this._caps.canUseTimestampForTimerQuery=this._gl.getQuery(this._caps.timerQuery.TIMESTAMP_EXT,this._caps.timerQuery.QUERY_COUNTER_BITS_EXT)>0),this._caps.maxAnisotropy=this._caps.textureAnisotropicFilterExtension?this._gl.getParameter(this._caps.textureAnisotropicFilterExtension.MAX_TEXTURE_MAX_ANISOTROPY_EXT):0,this._caps.textureFloatLinearFiltering=!!(this._caps.textureFloat&&this._gl.getExtension("OES_texture_float_linear")),this._caps.textureFloatRender=!!(this._caps.textureFloat&&this._canRenderToFloatFramebuffer()),this._caps.textureHalfFloatLinearFiltering=!!(this._webGLVersion>1||this._caps.textureHalfFloat&&this._gl.getExtension("OES_texture_half_float_linear")),this._caps.astc&&(this._gl.COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR=this._caps.astc.COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR),this._caps.bptc&&(this._gl.COMPRESSED_SRGB_ALPHA_BPTC_UNORM_EXT=this._caps.bptc.COMPRESSED_SRGB_ALPHA_BPTC_UNORM_EXT),this._caps.s3tc_srgb&&(this._gl.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT=this._caps.s3tc_srgb.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT,this._gl.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT=this._caps.s3tc_srgb.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT),this._webGLVersion>1&&this._gl.HALF_FLOAT_OES!==5131&&(this._gl.HALF_FLOAT_OES=5131),this._caps.textureHalfFloatRender=this._caps.textureHalfFloat&&this._canRenderToHalfFloatFramebuffer(),this._webGLVersion>1)this._caps.drawBuffersExtension=!0,this._caps.maxMSAASamples=this._gl.getParameter(this._gl.MAX_SAMPLES);else{var t=this._gl.getExtension("WEBGL_draw_buffers");if(t!==null){this._caps.drawBuffersExtension=!0,this._gl.drawBuffers=t.drawBuffersWEBGL.bind(t),this._gl.DRAW_FRAMEBUFFER=this._gl.FRAMEBUFFER;for(var r=0;r<16;r++)this._gl["COLOR_ATTACHMENT"+r+"_WEBGL"]=t["COLOR_ATTACHMENT"+r+"_WEBGL"]}}if(this._webGLVersion>1)this._caps.depthTextureExtension=!0;else{var n=this._gl.getExtension("WEBGL_depth_texture");n!=null&&(this._caps.depthTextureExtension=!0,this._gl.UNSIGNED_INT_24_8=n.UNSIGNED_INT_24_8_WEBGL)}if(this.disableVertexArrayObjects)this._caps.vertexArrayObject=!1;else if(this._webGLVersion>1)this._caps.vertexArrayObject=!0;else{var a=this._gl.getExtension("OES_vertex_array_object");a!=null&&(this._caps.vertexArrayObject=!0,this._gl.createVertexArray=a.createVertexArrayOES.bind(a),this._gl.bindVertexArray=a.bindVertexArrayOES.bind(a),this._gl.deleteVertexArray=a.deleteVertexArrayOES.bind(a))}if(this._webGLVersion>1)this._caps.instancedArrays=!0;else{var s=this._gl.getExtension("ANGLE_instanced_arrays");s!=null?(this._caps.instancedArrays=!0,this._gl.drawArraysInstanced=s.drawArraysInstancedANGLE.bind(s),this._gl.drawElementsInstanced=s.drawElementsInstancedANGLE.bind(s),this._gl.vertexAttribDivisor=s.vertexAttribDivisorANGLE.bind(s)):this._caps.instancedArrays=!1}if(this._gl.getShaderPrecisionFormat){var o=this._gl.getShaderPrecisionFormat(this._gl.VERTEX_SHADER,this._gl.HIGH_FLOAT),l=this._gl.getShaderPrecisionFormat(this._gl.FRAGMENT_SHADER,this._gl.HIGH_FLOAT);o&&l&&(this._caps.highPrecisionShaderSupported=o.precision!==0&&l.precision!==0)}if(this._webGLVersion>1)this._caps.blendMinMax=!0;else{var u=this._gl.getExtension("EXT_blend_minmax");u!=null&&(this._caps.blendMinMax=!0,this._gl.MAX=u.MAX_EXT,this._gl.MIN=u.MIN_EXT)}if(!this._caps.supportSRGBBuffers){if(this._webGLVersion>1)this._caps.supportSRGBBuffers=!0;else{var f=this._gl.getExtension("EXT_sRGB");f!=null&&(this._caps.supportSRGBBuffers=!0,this._gl.SRGB=f.SRGB_EXT,this._gl.SRGB8=f.SRGB_ALPHA_EXT,this._gl.SRGB8_ALPHA8=f.SRGB_ALPHA_EXT)}this._caps.supportSRGBBuffers=this._caps.supportSRGBBuffers&&!!(this._creationOptions&&this._creationOptions.forceSRGBBufferSupportState)}this._depthCullingState.depthTest=!0,this._depthCullingState.depthFunc=this._gl.LEQUAL,this._depthCullingState.depthMask=!0,this._maxSimultaneousTextures=this._caps.maxCombinedTexturesImageUnits;for(var h=0;h<this._maxSimultaneousTextures;h++)this._nextFreeTextureSlots.push(h)},i.prototype._initFeatures=function(){this._features={forceBitmapOverHTMLImageElement:!1,supportRenderAndCopyToLodForFloatTextures:this._webGLVersion!==1,supportDepthStencilTexture:this._webGLVersion!==1,supportShadowSamplers:this._webGLVersion!==1,uniformBufferHardCheckMatrix:!1,allowTexturePrefiltering:this._webGLVersion!==1,trackUbosInFrame:!1,checkUbosContentBeforeUpload:!1,supportCSM:this._webGLVersion!==1,basisNeedsPOT:this._webGLVersion===1,support3DTextures:this._webGLVersion!==1,needTypeSuffixInShaderConstants:this._webGLVersion!==1,supportMSAA:this._webGLVersion!==1,supportSSAO2:this._webGLVersion!==1,supportExtendedTextureFormats:this._webGLVersion!==1,supportSwitchCaseInShader:this._webGLVersion!==1,supportSyncTextureRead:!0,needsInvertingBitmap:!0,useUBOBindingCache:!0,needShaderCodeInlining:!1,needToAlwaysBindUniformBuffers:!1,supportRenderPasses:!1,_collectUbosUpdatedInFrame:!1}},Object.defineProperty(i.prototype,"webGLVersion",{get:function(){return this._webGLVersion},enumerable:!1,configurable:!0}),i.prototype.getClassName=function(){return"ThinEngine"},Object.defineProperty(i.prototype,"isStencilEnable",{get:function(){return this._isStencilEnable},enumerable:!1,configurable:!0}),i.prototype._prepareWorkingCanvas=function(){if(!this._workingCanvas){this._workingCanvas=this.createCanvas(1,1);var e=this._workingCanvas.getContext("2d");e&&(this._workingContext=e)}},i.prototype.resetTextureCache=function(){for(var e in this._boundTexturesCache)!Object.prototype.hasOwnProperty.call(this._boundTexturesCache,e)||(this._boundTexturesCache[e]=null);this._currentTextureChannel=-1},i.prototype.getInfo=function(){return this.getGlInfo()},i.prototype.getGlInfo=function(){return{vendor:this._glVendor,renderer:this._glRenderer,version:this._glVersion}},i.prototype.setHardwareScalingLevel=function(e){this._hardwareScalingLevel=e,this.resize()},i.prototype.getHardwareScalingLevel=function(){return this._hardwareScalingLevel},i.prototype.getLoadedTexturesCache=function(){return this._internalTexturesCache},i.prototype.getCaps=function(){return this._caps},i.prototype.stopRenderLoop=function(e){if(!e){this._activeRenderLoops=[];return}var t=this._activeRenderLoops.indexOf(e);t>=0&&this._activeRenderLoops.splice(t,1)},i.prototype._renderLoop=function(){if(!this._contextWasLost){var e=!0;if(!this.renderEvenInBackground&&this._windowIsBackground&&(e=!1),e){this.beginFrame();for(var t=0;t<this._activeRenderLoops.length;t++){var r=this._activeRenderLoops[t];r()}this.endFrame()}}this._activeRenderLoops.length>0?this._frameHandler=this._queueNewFrame(this._boundRenderFunction,this.getHostWindow()):this._renderingQueueLaunched=!1},i.prototype.getRenderingCanvas=function(){return this._renderingCanvas},i.prototype.getAudioContext=function(){return this._audioContext},i.prototype.getAudioDestination=function(){return this._audioDestination},i.prototype.getHostWindow=function(){return ze()?this._renderingCanvas&&this._renderingCanvas.ownerDocument&&this._renderingCanvas.ownerDocument.defaultView?this._renderingCanvas.ownerDocument.defaultView:window:null},i.prototype.getRenderWidth=function(e){return e===void 0&&(e=!1),!e&&this._currentRenderTarget?this._currentRenderTarget.width:this._framebufferDimensionsObject?this._framebufferDimensionsObject.framebufferWidth:this._gl.drawingBufferWidth},i.prototype.getRenderHeight=function(e){return e===void 0&&(e=!1),!e&&this._currentRenderTarget?this._currentRenderTarget.height:this._framebufferDimensionsObject?this._framebufferDimensionsObject.framebufferHeight:this._gl.drawingBufferHeight},i.prototype._queueNewFrame=function(e,t){return i.QueueNewFrame(e,t)},i.prototype.runRenderLoop=function(e){this._activeRenderLoops.indexOf(e)===-1&&(this._activeRenderLoops.push(e),this._renderingQueueLaunched||(this._renderingQueueLaunched=!0,this._boundRenderFunction=this._renderLoop.bind(this),this._frameHandler=this._queueNewFrame(this._boundRenderFunction,this.getHostWindow())))},i.prototype.clear=function(e,t,r,n){n===void 0&&(n=!1);var a=this.stencilStateComposer.useStencilGlobalOnly;this.stencilStateComposer.useStencilGlobalOnly=!0,this.applyStates(),this.stencilStateComposer.useStencilGlobalOnly=a;var s=0;t&&e&&(this._gl.clearColor(e.r,e.g,e.b,e.a!==void 0?e.a:1),s|=this._gl.COLOR_BUFFER_BIT),r&&(this.useReverseDepthBuffer?(this._depthCullingState.depthFunc=this._gl.GEQUAL,this._gl.clearDepth(0)):this._gl.clearDepth(1),s|=this._gl.DEPTH_BUFFER_BIT),n&&(this._gl.clearStencil(0),s|=this._gl.STENCIL_BUFFER_BIT),this._gl.clear(s)},i.prototype._viewport=function(e,t,r,n){(e!==this._viewportCached.x||t!==this._viewportCached.y||r!==this._viewportCached.z||n!==this._viewportCached.w)&&(this._viewportCached.x=e,this._viewportCached.y=t,this._viewportCached.z=r,this._viewportCached.w=n,this._gl.viewport(e,t,r,n))},i.prototype.setViewport=function(e,t,r){var n=t||this.getRenderWidth(),a=r||this.getRenderHeight(),s=e.x||0,o=e.y||0;this._cachedViewport=e,this._viewport(s*n,o*a,n*e.width,a*e.height)},i.prototype.beginFrame=function(){},i.prototype.endFrame=function(){this._badOS&&this.flushFramebuffer(),this._frameId++},i.prototype.resize=function(e){e===void 0&&(e=!1);var t,r;if(this._adaptToDeviceRatio){var n=ze()&&window.devicePixelRatio||1,a=this._creationOptions.limitDeviceRatio||n;this._hardwareScalingLevel=this._adaptToDeviceRatio?1/Math.min(a,n):1}ze()?(t=this._renderingCanvas?this._renderingCanvas.clientWidth||this._renderingCanvas.width:window.innerWidth,r=this._renderingCanvas?this._renderingCanvas.clientHeight||this._renderingCanvas.height:window.innerHeight):(t=this._renderingCanvas?this._renderingCanvas.width:100,r=this._renderingCanvas?this._renderingCanvas.height:100),this.setSize(t/this._hardwareScalingLevel,r/this._hardwareScalingLevel,e)},i.prototype.setSize=function(e,t,r){return r===void 0&&(r=!1),!this._renderingCanvas||(e=e|0,t=t|0,!r&&this._renderingCanvas.width===e&&this._renderingCanvas.height===t)?!1:(this._renderingCanvas.width=e,this._renderingCanvas.height=t,!0)},i.prototype.bindFramebuffer=function(e,t,r,n,a,s,o){var l,u,f,h,c;t===void 0&&(t=0),s===void 0&&(s=0),o===void 0&&(o=0);var d=e;this._currentRenderTarget&&this.unBindFramebuffer(this._currentRenderTarget),this._currentRenderTarget=e,this._bindUnboundFramebuffer(d._MSAAFramebuffer?d._MSAAFramebuffer:d._framebuffer);var p=this._gl;e.is2DArray?p.framebufferTextureLayer(p.FRAMEBUFFER,p.COLOR_ATTACHMENT0,(l=e.texture._hardwareTexture)===null||l===void 0?void 0:l.underlyingResource,s,o):e.isCube&&p.framebufferTexture2D(p.FRAMEBUFFER,p.COLOR_ATTACHMENT0,p.TEXTURE_CUBE_MAP_POSITIVE_X+t,(u=e.texture._hardwareTexture)===null||u===void 0?void 0:u.underlyingResource,s);var _=e._depthStencilTexture;if(_){var g=e._depthStencilTextureWithStencil?p.DEPTH_STENCIL_ATTACHMENT:p.DEPTH_ATTACHMENT;e.is2DArray?p.framebufferTextureLayer(p.FRAMEBUFFER,g,(f=_._hardwareTexture)===null||f===void 0?void 0:f.underlyingResource,s,o):e.isCube?p.framebufferTexture2D(p.FRAMEBUFFER,g,p.TEXTURE_CUBE_MAP_POSITIVE_X+t,(h=_._hardwareTexture)===null||h===void 0?void 0:h.underlyingResource,s):p.framebufferTexture2D(p.FRAMEBUFFER,g,p.TEXTURE_2D,(c=_._hardwareTexture)===null||c===void 0?void 0:c.underlyingResource,s)}this._cachedViewport&&!a?this.setViewport(this._cachedViewport,r,n):(r||(r=e.width,s&&(r=r/Math.pow(2,s))),n||(n=e.height,s&&(n=n/Math.pow(2,s))),this._viewport(0,0,r,n)),this.wipeCaches()},i.prototype.setState=function(e,t,r,n,a,s,o){var l,u;t===void 0&&(t=0),n===void 0&&(n=!1),o===void 0&&(o=0),(this._depthCullingState.cull!==e||r)&&(this._depthCullingState.cull=e);var f=!((u=(l=this.cullBackFaces)!==null&&l!==void 0?l:a)!==null&&u!==void 0)||u?this._gl.BACK:this._gl.FRONT;(this._depthCullingState.cullFace!==f||r)&&(this._depthCullingState.cullFace=f),this.setZOffset(t),this.setZOffsetUnits(o);var h=n?this._gl.CW:this._gl.CCW;(this._depthCullingState.frontFace!==h||r)&&(this._depthCullingState.frontFace=h),this._stencilStateComposer.stencilMaterial=s},i.prototype.setZOffset=function(e){this._depthCullingState.zOffset=this.useReverseDepthBuffer?-e:e},i.prototype.getZOffset=function(){var e=this._depthCullingState.zOffset;return this.useReverseDepthBuffer?-e:e},i.prototype.setZOffsetUnits=function(e){this._depthCullingState.zOffsetUnits=this.useReverseDepthBuffer?-e:e},i.prototype.getZOffsetUnits=function(){var e=this._depthCullingState.zOffsetUnits;return this.useReverseDepthBuffer?-e:e},i.prototype._bindUnboundFramebuffer=function(e){this._currentFramebuffer!==e&&(this._gl.bindFramebuffer(this._gl.FRAMEBUFFER,e),this._currentFramebuffer=e)},i.prototype._currentFrameBufferIsDefaultFrameBuffer=function(){return this._currentFramebuffer===null},i.prototype.generateMipmaps=function(e){this._bindTextureDirectly(this._gl.TEXTURE_2D,e,!0),this._gl.generateMipmap(this._gl.TEXTURE_2D),this._bindTextureDirectly(this._gl.TEXTURE_2D,null)},i.prototype.unBindFramebuffer=function(e,t,r){var n;t===void 0&&(t=!1);var a=e;this._currentRenderTarget=null;var s=this._gl;if(a._MSAAFramebuffer){if(e.isMulti){this.unBindMultiColorAttachmentFramebuffer(e,t,r);return}s.bindFramebuffer(s.READ_FRAMEBUFFER,a._MSAAFramebuffer),s.bindFramebuffer(s.DRAW_FRAMEBUFFER,a._framebuffer),s.blitFramebuffer(0,0,e.width,e.height,0,0,e.width,e.height,s.COLOR_BUFFER_BIT,s.NEAREST)}((n=e.texture)===null||n===void 0?void 0:n.generateMipMaps)&&!t&&!e.isCube&&this.generateMipmaps(e.texture),r&&(a._MSAAFramebuffer&&this._bindUnboundFramebuffer(a._framebuffer),r()),this._bindUnboundFramebuffer(null)},i.prototype.flushFramebuffer=function(){this._gl.flush()},i.prototype.restoreDefaultFramebuffer=function(){this._currentRenderTarget?this.unBindFramebuffer(this._currentRenderTarget):this._bindUnboundFramebuffer(null),this._cachedViewport&&this.setViewport(this._cachedViewport),this.wipeCaches()},i.prototype._resetVertexBufferBinding=function(){this.bindArrayBuffer(null),this._cachedVertexBuffers=null},i.prototype.createVertexBuffer=function(e){return this._createVertexBuffer(e,this._gl.STATIC_DRAW)},i.prototype._createVertexBuffer=function(e,t){var r=this._gl.createBuffer();if(!r)throw new Error("Unable to create vertex buffer");var n=new Ir(r);return this.bindArrayBuffer(n),e instanceof Array?this._gl.bufferData(this._gl.ARRAY_BUFFER,new Float32Array(e),t):this._gl.bufferData(this._gl.ARRAY_BUFFER,e,t),this._resetVertexBufferBinding(),n.references=1,n},i.prototype.createDynamicVertexBuffer=function(e){return this._createVertexBuffer(e,this._gl.DYNAMIC_DRAW)},i.prototype._resetIndexBufferBinding=function(){this.bindIndexBuffer(null),this._cachedIndexBuffer=null},i.prototype.createIndexBuffer=function(e,t){var r=this._gl.createBuffer(),n=new Ir(r);if(!r)throw new Error("Unable to create index buffer");this.bindIndexBuffer(n);var a=this._normalizeIndexData(e);return this._gl.bufferData(this._gl.ELEMENT_ARRAY_BUFFER,a,t?this._gl.DYNAMIC_DRAW:this._gl.STATIC_DRAW),this._resetIndexBufferBinding(),n.references=1,n.is32Bits=a.BYTES_PER_ELEMENT===4,n},i.prototype._normalizeIndexData=function(e){var t=e.BYTES_PER_ELEMENT;if(t===2)return e;if(this._caps.uintIndices){if(e instanceof Uint32Array)return e;for(var r=0;r<e.length;r++)if(e[r]>=65535)return new Uint32Array(e);return new Uint16Array(e)}return new Uint16Array(e)},i.prototype.bindArrayBuffer=function(e){this._vaoRecordInProgress||this._unbindVertexArrayObject(),this._bindBuffer(e,this._gl.ARRAY_BUFFER)},i.prototype.bindUniformBlock=function(e,t,r){var n=e.program,a=this._gl.getUniformBlockIndex(n,t);this._gl.uniformBlockBinding(n,a,r)},i.prototype.bindIndexBuffer=function(e){this._vaoRecordInProgress||this._unbindVertexArrayObject(),this._bindBuffer(e,this._gl.ELEMENT_ARRAY_BUFFER)},i.prototype._bindBuffer=function(e,t){(this._vaoRecordInProgress||this._currentBoundBuffer[t]!==e)&&(this._gl.bindBuffer(t,e?e.underlyingResource:null),this._currentBoundBuffer[t]=e)},i.prototype.updateArrayBuffer=function(e){this._gl.bufferSubData(this._gl.ARRAY_BUFFER,0,e)},i.prototype._vertexAttribPointer=function(e,t,r,n,a,s,o){var l=this._currentBufferPointers[t];if(!!l){var u=!1;l.active?(l.buffer!==e&&(l.buffer=e,u=!0),l.size!==r&&(l.size=r,u=!0),l.type!==n&&(l.type=n,u=!0),l.normalized!==a&&(l.normalized=a,u=!0),l.stride!==s&&(l.stride=s,u=!0),l.offset!==o&&(l.offset=o,u=!0)):(u=!0,l.active=!0,l.index=t,l.size=r,l.type=n,l.normalized=a,l.stride=s,l.offset=o,l.buffer=e),(u||this._vaoRecordInProgress)&&(this.bindArrayBuffer(e),this._gl.vertexAttribPointer(t,r,n,a,s,o))}},i.prototype._bindIndexBufferWithCache=function(e){e!=null&&this._cachedIndexBuffer!==e&&(this._cachedIndexBuffer=e,this.bindIndexBuffer(e),this._uintIndicesCurrentlySet=e.is32Bits)},i.prototype._bindVertexBuffersAttributes=function(e,t,r){var n=t.getAttributesNames();this._vaoRecordInProgress||this._unbindVertexArrayObject(),this.unbindAllAttributes();for(var a=0;a<n.length;a++){var s=t.getAttributeLocation(a);if(s>=0){var o=n[a],l=null;if(r&&(l=r[o]),l||(l=e[o]),!l)continue;this._gl.enableVertexAttribArray(s),this._vaoRecordInProgress||(this._vertexAttribArraysEnabled[s]=!0);var u=l.getBuffer();u&&(this._vertexAttribPointer(u,s,l.getSize(),l.type,l.normalized,l.byteStride,l.byteOffset),l.getIsInstanced()&&(this._gl.vertexAttribDivisor(s,l.getInstanceDivisor()),this._vaoRecordInProgress||(this._currentInstanceLocations.push(s),this._currentInstanceBuffers.push(u))))}}},i.prototype.recordVertexArrayObject=function(e,t,r,n){var a=this._gl.createVertexArray();return this._vaoRecordInProgress=!0,this._gl.bindVertexArray(a),this._mustWipeVertexAttributes=!0,this._bindVertexBuffersAttributes(e,r,n),this.bindIndexBuffer(t),this._vaoRecordInProgress=!1,this._gl.bindVertexArray(null),a},i.prototype.bindVertexArrayObject=function(e,t){this._cachedVertexArrayObject!==e&&(this._cachedVertexArrayObject=e,this._gl.bindVertexArray(e),this._cachedVertexBuffers=null,this._cachedIndexBuffer=null,this._uintIndicesCurrentlySet=t!=null&&t.is32Bits,this._mustWipeVertexAttributes=!0)},i.prototype.bindBuffersDirectly=function(e,t,r,n,a){if(this._cachedVertexBuffers!==e||this._cachedEffectForVertexBuffers!==a){this._cachedVertexBuffers=e,this._cachedEffectForVertexBuffers=a;var s=a.getAttributesCount();this._unbindVertexArrayObject(),this.unbindAllAttributes();for(var o=0,l=0;l<s;l++)if(l<r.length){var u=a.getAttributeLocation(l);u>=0&&(this._gl.enableVertexAttribArray(u),this._vertexAttribArraysEnabled[u]=!0,this._vertexAttribPointer(e,u,r[l],this._gl.FLOAT,!1,n,o)),o+=r[l]*4}}this._bindIndexBufferWithCache(t)},i.prototype._unbindVertexArrayObject=function(){!this._cachedVertexArrayObject||(this._cachedVertexArrayObject=null,this._gl.bindVertexArray(null))},i.prototype.bindBuffers=function(e,t,r,n){(this._cachedVertexBuffers!==e||this._cachedEffectForVertexBuffers!==r)&&(this._cachedVertexBuffers=e,this._cachedEffectForVertexBuffers=r,this._bindVertexBuffersAttributes(e,r,n)),this._bindIndexBufferWithCache(t)},i.prototype.unbindInstanceAttributes=function(){for(var e,t=0,r=this._currentInstanceLocations.length;t<r;t++){var n=this._currentInstanceBuffers[t];e!=n&&n.references&&(e=n,this.bindArrayBuffer(n));var a=this._currentInstanceLocations[t];this._gl.vertexAttribDivisor(a,0)}this._currentInstanceBuffers.length=0,this._currentInstanceLocations.length=0},i.prototype.releaseVertexArrayObject=function(e){this._gl.deleteVertexArray(e)},i.prototype._releaseBuffer=function(e){return e.references--,e.references===0?(this._deleteBuffer(e),!0):!1},i.prototype._deleteBuffer=function(e){this._gl.deleteBuffer(e.underlyingResource)},i.prototype.updateAndBindInstancesBuffer=function(e,t,r){if(this.bindArrayBuffer(e),t&&this._gl.bufferSubData(this._gl.ARRAY_BUFFER,0,t),r[0].index!==void 0)this.bindInstancesBuffer(e,r,!0);else for(var n=0;n<4;n++){var a=r[n];this._vertexAttribArraysEnabled[a]||(this._gl.enableVertexAttribArray(a),this._vertexAttribArraysEnabled[a]=!0),this._vertexAttribPointer(e,a,4,this._gl.FLOAT,!1,64,n*16),this._gl.vertexAttribDivisor(a,1),this._currentInstanceLocations.push(a),this._currentInstanceBuffers.push(e)}},i.prototype.bindInstancesBuffer=function(e,t,r){r===void 0&&(r=!0),this.bindArrayBuffer(e);var n=0;if(r)for(var a=0;a<t.length;a++){var s=t[a];n+=s.attributeSize*4}for(var a=0;a<t.length;a++){var s=t[a];s.index===void 0&&(s.index=this._currentEffect.getAttributeLocationByName(s.attributeName)),!(s.index<0)&&(this._vertexAttribArraysEnabled[s.index]||(this._gl.enableVertexAttribArray(s.index),this._vertexAttribArraysEnabled[s.index]=!0),this._vertexAttribPointer(e,s.index,s.attributeSize,s.attributeType||this._gl.FLOAT,s.normalized||!1,n,s.offset),this._gl.vertexAttribDivisor(s.index,s.divisor===void 0?1:s.divisor),this._currentInstanceLocations.push(s.index),this._currentInstanceBuffers.push(e))}},i.prototype.disableInstanceAttributeByName=function(e){if(!!this._currentEffect){var t=this._currentEffect.getAttributeLocationByName(e);this.disableInstanceAttribute(t)}},i.prototype.disableInstanceAttribute=function(e){for(var t=!1,r;(r=this._currentInstanceLocations.indexOf(e))!==-1;)this._currentInstanceLocations.splice(r,1),this._currentInstanceBuffers.splice(r,1),t=!0,r=this._currentInstanceLocations.indexOf(e);t&&(this._gl.vertexAttribDivisor(e,0),this.disableAttributeByIndex(e))},i.prototype.disableAttributeByIndex=function(e){this._gl.disableVertexAttribArray(e),this._vertexAttribArraysEnabled[e]=!1,this._currentBufferPointers[e].active=!1},i.prototype.draw=function(e,t,r,n){this.drawElementsType(e?0:1,t,r,n)},i.prototype.drawPointClouds=function(e,t,r){this.drawArraysType(2,e,t,r)},i.prototype.drawUnIndexed=function(e,t,r,n){this.drawArraysType(e?0:1,t,r,n)},i.prototype.drawElementsType=function(e,t,r,n){this.applyStates(),this._reportDrawCall();var a=this._drawMode(e),s=this._uintIndicesCurrentlySet?this._gl.UNSIGNED_INT:this._gl.UNSIGNED_SHORT,o=this._uintIndicesCurrentlySet?4:2;n?this._gl.drawElementsInstanced(a,r,s,t*o,n):this._gl.drawElements(a,r,s,t*o)},i.prototype.drawArraysType=function(e,t,r,n){this.applyStates(),this._reportDrawCall();var a=this._drawMode(e);n?this._gl.drawArraysInstanced(a,t,r,n):this._gl.drawArrays(a,t,r)},i.prototype._drawMode=function(e){switch(e){case 0:return this._gl.TRIANGLES;case 2:return this._gl.POINTS;case 1:return this._gl.LINES;case 3:return this._gl.POINTS;case 4:return this._gl.LINES;case 5:return this._gl.LINE_LOOP;case 6:return this._gl.LINE_STRIP;case 7:return this._gl.TRIANGLE_STRIP;case 8:return this._gl.TRIANGLE_FAN;default:return this._gl.TRIANGLES}},i.prototype._reportDrawCall=function(){},i.prototype._releaseEffect=function(e){if(this._compiledEffects[e._key]){delete this._compiledEffects[e._key];var t=e.getPipelineContext();t&&this._deletePipelineContext(t)}},i.prototype._deletePipelineContext=function(e){var t=e;t&&t.program&&(t.program.__SPECTOR_rebuildProgram=null,this._gl.deleteProgram(t.program))},i.prototype._getGlobalDefines=function(e){if(e){this.isNDCHalfZRange?e.IS_NDC_HALF_ZRANGE="":delete e.IS_NDC_HALF_ZRANGE,this.useReverseDepthBuffer?e.USE_REVERSE_DEPTHBUFFER="":delete e.USE_REVERSE_DEPTHBUFFER;return}else{var t="";return this.isNDCHalfZRange&&(t+="#define IS_NDC_HALF_ZRANGE"),this.useReverseDepthBuffer&&(t&&(t+=`
`),t+="#define USE_REVERSE_DEPTHBUFFER"),t}},i.prototype.createEffect=function(e,t,r,n,a,s,o,l,u,f){var h;f===void 0&&(f=qe.GLSL);var c=e.vertexElement||e.vertex||e.vertexToken||e.vertexSource||e,d=e.fragmentElement||e.fragment||e.fragmentToken||e.fragmentSource||e,p=this._getGlobalDefines(),_=(h=a!=null?a:t.defines)!==null&&h!==void 0?h:"";p&&(_+=p);var g=c+"+"+d+"@"+_;if(this._compiledEffects[g]){var v=this._compiledEffects[g];return o&&v.isReady()&&o(v),v}var y=new Kt(e,t,r,n,this,a,s,o,l,u,g,f);return this._compiledEffects[g]=y,y},i._ConcatenateShader=function(e,t,r){return r===void 0&&(r=""),r+(t?t+`
`:"")+e},i.prototype._compileShader=function(e,t,r,n){return this._compileRawShader(i._ConcatenateShader(e,r,n),t)},i.prototype._compileRawShader=function(e,t){var r=this._gl,n=r.createShader(t==="vertex"?r.VERTEX_SHADER:r.FRAGMENT_SHADER);if(!n){for(var a=r.NO_ERROR,s=r.NO_ERROR;(s=r.getError())!==r.NO_ERROR;)a=s;throw new Error("Something went wrong while creating a gl ".concat(t," shader object. gl error=").concat(a,", gl isContextLost=").concat(r.isContextLost(),", _contextWasLost=").concat(this._contextWasLost))}return r.shaderSource(n,e),r.compileShader(n),n},i.prototype._getShaderSource=function(e){return this._gl.getShaderSource(e)},i.prototype.createRawShaderProgram=function(e,t,r,n,a){a===void 0&&(a=null),n=n||this._gl;var s=this._compileRawShader(t,"vertex"),o=this._compileRawShader(r,"fragment");return this._createShaderProgram(e,s,o,n,a)},i.prototype.createShaderProgram=function(e,t,r,n,a,s){s===void 0&&(s=null),a=a||this._gl;var o=this._webGLVersion>1?`#version 300 es
#define WEBGL2 
`:"",l=this._compileShader(t,"vertex",n,o),u=this._compileShader(r,"fragment",n,o);return this._createShaderProgram(e,l,u,a,s)},i.prototype.inlineShaderCode=function(e){return e},i.prototype.createPipelineContext=function(e){var t=new No;return t.engine=this,this._caps.parallelShaderCompile&&(t.isParallelCompiled=!0),t},i.prototype.createMaterialContext=function(){},i.prototype.createDrawContext=function(){},i.prototype._createShaderProgram=function(e,t,r,n,a){var s=n.createProgram();if(e.program=s,!s)throw new Error("Unable to create program");return n.attachShader(s,t),n.attachShader(s,r),n.linkProgram(s),e.context=n,e.vertexShader=t,e.fragmentShader=r,e.isParallelCompiled||this._finalizePipelineContext(e),s},i.prototype._finalizePipelineContext=function(e){var t=e.context,r=e.vertexShader,n=e.fragmentShader,a=e.program,s=t.getProgramParameter(a,t.LINK_STATUS);if(!s){if(!this._gl.getShaderParameter(r,this._gl.COMPILE_STATUS)){var o=this._gl.getShaderInfoLog(r);if(o)throw e.vertexCompilationError=o,new Error("VERTEX SHADER "+o)}if(!this._gl.getShaderParameter(n,this._gl.COMPILE_STATUS)){var o=this._gl.getShaderInfoLog(n);if(o)throw e.fragmentCompilationError=o,new Error("FRAGMENT SHADER "+o)}var l=t.getProgramInfoLog(a);if(l)throw e.programLinkError=l,new Error(l)}if(this.validateShaderPrograms){t.validateProgram(a);var u=t.getProgramParameter(a,t.VALIDATE_STATUS);if(!u){var l=t.getProgramInfoLog(a);if(l)throw e.programValidationError=l,new Error(l)}}t.deleteShader(r),t.deleteShader(n),e.vertexShader=void 0,e.fragmentShader=void 0,e.onCompiled&&(e.onCompiled(),e.onCompiled=void 0)},i.prototype._preparePipelineContext=function(e,t,r,n,a,s,o,l,u,f){var h=e;n?h.program=this.createRawShaderProgram(h,t,r,void 0,u):h.program=this.createShaderProgram(h,t,r,l,void 0,u),h.program.__SPECTOR_rebuildProgram=o},i.prototype._isRenderingStateCompiled=function(e){var t=e;return this._gl.getProgramParameter(t.program,this._caps.parallelShaderCompile.COMPLETION_STATUS_KHR)?(this._finalizePipelineContext(t),!0):!1},i.prototype._executeWhenRenderingStateIsCompiled=function(e,t){var r=e;if(!r.isParallelCompiled){t();return}var n=r.onCompiled;n?r.onCompiled=function(){n(),t()}:r.onCompiled=t},i.prototype.getUniforms=function(e,t){for(var r=new Array,n=e,a=0;a<t.length;a++)r.push(this._gl.getUniformLocation(n.program,t[a]));return r},i.prototype.getAttributes=function(e,t){for(var r=[],n=e,a=0;a<t.length;a++)try{r.push(this._gl.getAttribLocation(n.program,t[a]))}catch{r.push(-1)}return r},i.prototype.enableEffect=function(e){e=e!==null&&Bt.IsWrapper(e)?e.effect:e,!(!e||e===this._currentEffect)&&(this._stencilStateComposer.stencilMaterial=void 0,e=e,this.bindSamplers(e),this._currentEffect=e,e.onBind&&e.onBind(e),e._onBindObservable&&e._onBindObservable.notifyObservers(e))},i.prototype.setInt=function(e,t){return e?(this._gl.uniform1i(e,t),!0):!1},i.prototype.setInt2=function(e,t,r){return e?(this._gl.uniform2i(e,t,r),!0):!1},i.prototype.setInt3=function(e,t,r,n){return e?(this._gl.uniform3i(e,t,r,n),!0):!1},i.prototype.setInt4=function(e,t,r,n,a){return e?(this._gl.uniform4i(e,t,r,n,a),!0):!1},i.prototype.setIntArray=function(e,t){return e?(this._gl.uniform1iv(e,t),!0):!1},i.prototype.setIntArray2=function(e,t){return!e||t.length%2!==0?!1:(this._gl.uniform2iv(e,t),!0)},i.prototype.setIntArray3=function(e,t){return!e||t.length%3!==0?!1:(this._gl.uniform3iv(e,t),!0)},i.prototype.setIntArray4=function(e,t){return!e||t.length%4!==0?!1:(this._gl.uniform4iv(e,t),!0)},i.prototype.setArray=function(e,t){return!e||t.length<1?!1:(this._gl.uniform1fv(e,t),!0)},i.prototype.setArray2=function(e,t){return!e||t.length%2!==0?!1:(this._gl.uniform2fv(e,t),!0)},i.prototype.setArray3=function(e,t){return!e||t.length%3!==0?!1:(this._gl.uniform3fv(e,t),!0)},i.prototype.setArray4=function(e,t){return!e||t.length%4!==0?!1:(this._gl.uniform4fv(e,t),!0)},i.prototype.setMatrices=function(e,t){return e?(this._gl.uniformMatrix4fv(e,!1,t),!0):!1},i.prototype.setMatrix3x3=function(e,t){return e?(this._gl.uniformMatrix3fv(e,!1,t),!0):!1},i.prototype.setMatrix2x2=function(e,t){return e?(this._gl.uniformMatrix2fv(e,!1,t),!0):!1},i.prototype.setFloat=function(e,t){return e?(this._gl.uniform1f(e,t),!0):!1},i.prototype.setFloat2=function(e,t,r){return e?(this._gl.uniform2f(e,t,r),!0):!1},i.prototype.setFloat3=function(e,t,r,n){return e?(this._gl.uniform3f(e,t,r,n),!0):!1},i.prototype.setFloat4=function(e,t,r,n,a){return e?(this._gl.uniform4f(e,t,r,n,a),!0):!1},i.prototype.applyStates=function(){if(this._depthCullingState.apply(this._gl),this._stencilStateComposer.apply(this._gl),this._alphaState.apply(this._gl),this._colorWriteChanged){this._colorWriteChanged=!1;var e=this._colorWrite;this._gl.colorMask(e,e,e,e)}},i.prototype.setColorWrite=function(e){e!==this._colorWrite&&(this._colorWriteChanged=!0,this._colorWrite=e)},i.prototype.getColorWrite=function(){return this._colorWrite},Object.defineProperty(i.prototype,"depthCullingState",{get:function(){return this._depthCullingState},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"alphaState",{get:function(){return this._alphaState},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"stencilState",{get:function(){return this._stencilState},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"stencilStateComposer",{get:function(){return this._stencilStateComposer},enumerable:!1,configurable:!0}),i.prototype.clearInternalTexturesCache=function(){this._internalTexturesCache=[]},i.prototype.wipeCaches=function(e){this.preventCacheWipeBetweenFrames&&!e||(this._currentEffect=null,this._viewportCached.x=0,this._viewportCached.y=0,this._viewportCached.z=0,this._viewportCached.w=0,this._unbindVertexArrayObject(),e&&(this._currentProgram=null,this.resetTextureCache(),this._stencilStateComposer.reset(),this._depthCullingState.reset(),this._depthCullingState.depthFunc=this._gl.LEQUAL,this._alphaState.reset(),this._alphaMode=1,this._alphaEquation=0,this._colorWrite=!0,this._colorWriteChanged=!0,this._unpackFlipYCached=null,this._gl.pixelStorei(this._gl.UNPACK_COLORSPACE_CONVERSION_WEBGL,this._gl.NONE),this._gl.pixelStorei(this._gl.UNPACK_PREMULTIPLY_ALPHA_WEBGL,0),this._mustWipeVertexAttributes=!0,this.unbindAllAttributes()),this._resetVertexBufferBinding(),this._cachedIndexBuffer=null,this._cachedEffectForVertexBuffers=null,this.bindIndexBuffer(null))},i.prototype._getSamplingParameters=function(e,t){var r=this._gl,n=r.NEAREST,a=r.NEAREST;switch(e){case 11:n=r.LINEAR,t?a=r.LINEAR_MIPMAP_NEAREST:a=r.LINEAR;break;case 3:n=r.LINEAR,t?a=r.LINEAR_MIPMAP_LINEAR:a=r.LINEAR;break;case 8:n=r.NEAREST,t?a=r.NEAREST_MIPMAP_LINEAR:a=r.NEAREST;break;case 4:n=r.NEAREST,t?a=r.NEAREST_MIPMAP_NEAREST:a=r.NEAREST;break;case 5:n=r.NEAREST,t?a=r.LINEAR_MIPMAP_NEAREST:a=r.LINEAR;break;case 6:n=r.NEAREST,t?a=r.LINEAR_MIPMAP_LINEAR:a=r.LINEAR;break;case 7:n=r.NEAREST,a=r.LINEAR;break;case 1:n=r.NEAREST,a=r.NEAREST;break;case 9:n=r.LINEAR,t?a=r.NEAREST_MIPMAP_NEAREST:a=r.NEAREST;break;case 10:n=r.LINEAR,t?a=r.NEAREST_MIPMAP_LINEAR:a=r.NEAREST;break;case 2:n=r.LINEAR,a=r.LINEAR;break;case 12:n=r.LINEAR,a=r.NEAREST;break}return{min:a,mag:n}},i.prototype._createTexture=function(){var e=this._gl.createTexture();if(!e)throw new Error("Unable to create texture");return e},i.prototype._createHardwareTexture=function(){return new wa(this._createTexture(),this._gl)},i.prototype._createInternalTexture=function(e,t,r,n){n===void 0&&(n=Ie.Unknown);var a={};t!==void 0&&typeof t=="object"?(a.generateMipMaps=t.generateMipMaps,a.type=t.type===void 0?0:t.type,a.samplingMode=t.samplingMode===void 0?3:t.samplingMode,a.format=t.format===void 0?5:t.format):(a.generateMipMaps=t,a.type=0,a.samplingMode=3,a.format=5),(a.type===1&&!this._caps.textureFloatLinearFiltering||a.type===2&&!this._caps.textureHalfFloatLinearFiltering)&&(a.samplingMode=1),a.type===1&&!this._caps.textureFloat&&(a.type=0,Y.Warn("Float textures are not supported. Type forced to TEXTURETYPE_UNSIGNED_BYTE"));var s=this._gl,o=new at(this,n),l=e.width||e,u=e.height||e,f=e.layers||0,h=this._getSamplingParameters(a.samplingMode,!!a.generateMipMaps),c=f!==0?s.TEXTURE_2D_ARRAY:s.TEXTURE_2D,d=this._getRGBABufferInternalSizedFormat(a.type,a.format),p=this._getInternalFormat(a.format),_=this._getWebGLTextureType(a.type);return this._bindTextureDirectly(c,o),f!==0?(o.is2DArray=!0,s.texImage3D(c,0,d,l,u,f,0,p,_,null)):s.texImage2D(c,0,d,l,u,0,p,_,null),s.texParameteri(c,s.TEXTURE_MAG_FILTER,h.mag),s.texParameteri(c,s.TEXTURE_MIN_FILTER,h.min),s.texParameteri(c,s.TEXTURE_WRAP_S,s.CLAMP_TO_EDGE),s.texParameteri(c,s.TEXTURE_WRAP_T,s.CLAMP_TO_EDGE),a.generateMipMaps&&this._gl.generateMipmap(c),this._bindTextureDirectly(c,null),o.baseWidth=l,o.baseHeight=u,o.width=l,o.height=u,o.depth=f,o.isReady=!0,o.samples=1,o.generateMipMaps=!!a.generateMipMaps,o.samplingMode=a.samplingMode,o.type=a.type,o.format=a.format,this._internalTexturesCache.push(o),o},i.prototype._getUseSRGBBuffer=function(e,t){return e&&this._caps.supportSRGBBuffers&&(this.webGLVersion>1||this.isWebGPU||t)},i.prototype._createTextureBase=function(e,t,r,n,a,s,o,l,u,f,h,c,d,p,_,g){var v=this;a===void 0&&(a=3),s===void 0&&(s=null),o===void 0&&(o=null),f===void 0&&(f=null),h===void 0&&(h=null),c===void 0&&(c=null),d===void 0&&(d=null),e=e||"";var y=e.substr(0,5)==="data:",b=e.substr(0,5)==="blob:",E=y&&e.indexOf(";base64,")!==-1,A=h||new at(this,Ie.Url),S=e;this._transformTextureUrl&&!E&&!h&&!f&&(e=this._transformTextureUrl(e)),S!==e&&(A._originalUrl=S);var T=e.lastIndexOf("."),M=d||(T>-1?e.substring(T).toLowerCase():""),D=null,x=M.indexOf("?");x>-1&&(M=M.split("?")[0]);for(var P=0,w=i._TextureLoaders;P<w.length;P++){var k=w[P];if(k.canLoad(M,p)){D=k;break}}n&&n._addPendingData(A),A.url=e,A.generateMipMaps=!t,A.samplingMode=a,A.invertY=r,A._useSRGBBuffer=this._getUseSRGBBuffer(!!g,t),this._doNotHandleContextLost||(A._buffer=f);var B=null;s&&!h&&(B=A.onLoadedObservable.add(s)),h||this._internalTexturesCache.push(A);var L=function(F,V){n&&n._removePendingData(A),e===S?(B&&A.onLoadedObservable.remove(B),ye.UseFallbackTexture&&v._createTextureBase(ye.FallbackTexture,t,A.invertY,n,a,null,o,l,u,f,A),F=(F||"Unknown error")+(ye.UseFallbackTexture?" - Fallback texture was used":""),A.onErrorObservable.notifyObservers({message:F,exception:V}),o&&o(F,V)):(Y.Warn("Failed to load ".concat(e,", falling back to ").concat(S)),v._createTextureBase(S,t,A.invertY,n,a,s,o,l,u,f,A,c,d,p,_,g))};if(D){var H=function(F){D.loadData(F,A,function(V,z,N,Q,Z,ee){ee?L("TextureLoader failed to load data"):l(A,M,n,{width:V,height:z},A.invertY,!N,Q,function(){return Z(),!1},a)},_)};f?f instanceof ArrayBuffer?H(new Uint8Array(f)):ArrayBuffer.isView(f)?H(f):o&&o("Unable to load: only ArrayBuffer or ArrayBufferView is supported",null):this._loadFile(e,function(F){return H(new Uint8Array(F))},void 0,n?n.offlineProvider:void 0,!0,function(F,V){L("Unable to load "+(F&&F.responseURL,V))})}else{var W=function(F){b&&!v._doNotHandleContextLost&&(A._buffer=F),l(A,M,n,F,A.invertY,t,!1,u,a)};!y||E?f&&(typeof f.decoding=="string"||f.close)?W(f):i._FileToolsLoadImage(e,W,L,n?n.offlineProvider:null,p,A.invertY&&this._features.needsInvertingBitmap?{imageOrientation:"flipY"}:void 0):typeof f=="string"||f instanceof ArrayBuffer||ArrayBuffer.isView(f)||f instanceof Blob?i._FileToolsLoadImage(f,W,L,n?n.offlineProvider:null,p,A.invertY&&this._features.needsInvertingBitmap?{imageOrientation:"flipY"}:void 0):f&&W(f)}return A},i.prototype.createTexture=function(e,t,r,n,a,s,o,l,u,f,h,c,d,p,_){var g=this;return a===void 0&&(a=3),s===void 0&&(s=null),o===void 0&&(o=null),l===void 0&&(l=null),u===void 0&&(u=null),f===void 0&&(f=null),h===void 0&&(h=null),this._createTextureBase(e,t,r,n,a,s,o,this._prepareWebGLTexture.bind(this),function(v,y,b,E,A,S){var T=g._gl,M=b.width===v&&b.height===y,D=f?g._getInternalFormat(f,A._useSRGBBuffer):E===".jpg"&&!A._useSRGBBuffer?T.RGB:A._useSRGBBuffer?T.SRGB8_ALPHA8:T.RGBA,x=f?g._getInternalFormat(f):E===".jpg"&&!A._useSRGBBuffer?T.RGB:T.RGBA;if(A._useSRGBBuffer&&g.webGLVersion===1&&(x=D),M)return T.texImage2D(T.TEXTURE_2D,0,D,x,T.UNSIGNED_BYTE,b),!1;var P=g._caps.maxTextureSize;if(b.width>P||b.height>P||!g._supportsHardwareTextureRescaling)return g._prepareWorkingCanvas(),!g._workingCanvas||!g._workingContext||(g._workingCanvas.width=v,g._workingCanvas.height=y,g._workingContext.drawImage(b,0,0,b.width,b.height,0,0,v,y),T.texImage2D(T.TEXTURE_2D,0,D,x,T.UNSIGNED_BYTE,g._workingCanvas),A.width=v,A.height=y),!1;var w=new at(g,Ie.Temp);return g._bindTextureDirectly(T.TEXTURE_2D,w,!0),T.texImage2D(T.TEXTURE_2D,0,D,x,T.UNSIGNED_BYTE,b),g._rescaleTexture(w,A,n,D,function(){g._releaseTexture(w),g._bindTextureDirectly(T.TEXTURE_2D,A,!0),S()}),!0},l,u,f,h,c,d,_)},i._FileToolsLoadImage=function(e,t,r,n,a,s){throw he("FileTools")},i.prototype._rescaleTexture=function(e,t,r,n,a){},i.prototype.createRawTexture=function(e,t,r,n,a,s,o,l,u){throw he("Engine.RawTexture")},i.prototype.createRawCubeTexture=function(e,t,r,n,a,s,o,l){throw he("Engine.RawTexture")},i.prototype.createRawTexture3D=function(e,t,r,n,a,s,o,l,u,f){throw he("Engine.RawTexture")},i.prototype.createRawTexture2DArray=function(e,t,r,n,a,s,o,l,u,f){throw he("Engine.RawTexture")},i.prototype._unpackFlipY=function(e){this._unpackFlipYCached!==e&&(this._gl.pixelStorei(this._gl.UNPACK_FLIP_Y_WEBGL,e?1:0),this.enableUnpackFlipYCached&&(this._unpackFlipYCached=e))},i.prototype._getUnpackAlignement=function(){return this._gl.getParameter(this._gl.UNPACK_ALIGNMENT)},i.prototype._getTextureTarget=function(e){return e.isCube?this._gl.TEXTURE_CUBE_MAP:e.is3D?this._gl.TEXTURE_3D:e.is2DArray||e.isMultiview?this._gl.TEXTURE_2D_ARRAY:this._gl.TEXTURE_2D},i.prototype.updateTextureSamplingMode=function(e,t,r){r===void 0&&(r=!1);var n=this._getTextureTarget(t),a=this._getSamplingParameters(e,t.generateMipMaps||r);this._setTextureParameterInteger(n,this._gl.TEXTURE_MAG_FILTER,a.mag,t),this._setTextureParameterInteger(n,this._gl.TEXTURE_MIN_FILTER,a.min),r&&(t.generateMipMaps=!0,this._gl.generateMipmap(n)),this._bindTextureDirectly(n,null),t.samplingMode=e},i.prototype.updateTextureDimensions=function(e,t,r,n){},i.prototype.updateTextureWrappingMode=function(e,t,r,n){r===void 0&&(r=null),n===void 0&&(n=null);var a=this._getTextureTarget(e);t!==null&&(this._setTextureParameterInteger(a,this._gl.TEXTURE_WRAP_S,this._getTextureWrapMode(t),e),e._cachedWrapU=t),r!==null&&(this._setTextureParameterInteger(a,this._gl.TEXTURE_WRAP_T,this._getTextureWrapMode(r),e),e._cachedWrapV=r),(e.is2DArray||e.is3D)&&n!==null&&(this._setTextureParameterInteger(a,this._gl.TEXTURE_WRAP_R,this._getTextureWrapMode(n),e),e._cachedWrapR=n),this._bindTextureDirectly(a,null)},i.prototype._setupDepthStencilTexture=function(e,t,r,n,a,s){s===void 0&&(s=1);var o=t.width||t,l=t.height||t,u=t.layers||0;e.baseWidth=o,e.baseHeight=l,e.width=o,e.height=l,e.is2DArray=u>0,e.depth=u,e.isReady=!0,e.samples=s,e.generateMipMaps=!1,e.samplingMode=n?2:1,e.type=0,e._comparisonFunction=a;var f=this._gl,h=this._getTextureTarget(e),c=this._getSamplingParameters(e.samplingMode,!1);f.texParameteri(h,f.TEXTURE_MAG_FILTER,c.mag),f.texParameteri(h,f.TEXTURE_MIN_FILTER,c.min),f.texParameteri(h,f.TEXTURE_WRAP_S,f.CLAMP_TO_EDGE),f.texParameteri(h,f.TEXTURE_WRAP_T,f.CLAMP_TO_EDGE),a===0?(f.texParameteri(h,f.TEXTURE_COMPARE_FUNC,515),f.texParameteri(h,f.TEXTURE_COMPARE_MODE,f.NONE)):(f.texParameteri(h,f.TEXTURE_COMPARE_FUNC,a),f.texParameteri(h,f.TEXTURE_COMPARE_MODE,f.COMPARE_REF_TO_TEXTURE))},i.prototype._uploadCompressedDataToTextureDirectly=function(e,t,r,n,a,s,o){s===void 0&&(s=0),o===void 0&&(o=0);var l=this._gl,u=l.TEXTURE_2D;if(e.isCube&&(u=l.TEXTURE_CUBE_MAP_POSITIVE_X+s),e._useSRGBBuffer)switch(t){case 36492:t=l.COMPRESSED_SRGB_ALPHA_BPTC_UNORM_EXT;break;case 37808:t=l.COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR;break;case 33776:this._caps.s3tc_srgb?t=l.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT:e._useSRGBBuffer=!1;break;case 33779:this._caps.s3tc_srgb?t=l.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT:e._useSRGBBuffer=!1;break;default:e._useSRGBBuffer=!1;break}this._gl.compressedTexImage2D(u,o,t,r,n,0,a)},i.prototype._uploadDataToTextureDirectly=function(e,t,r,n,a,s){r===void 0&&(r=0),n===void 0&&(n=0),s===void 0&&(s=!1);var o=this._gl,l=this._getWebGLTextureType(e.type),u=this._getInternalFormat(e.format),f=a===void 0?this._getRGBABufferInternalSizedFormat(e.type,e.format,e._useSRGBBuffer):this._getInternalFormat(a,e._useSRGBBuffer);this._unpackFlipY(e.invertY);var h=o.TEXTURE_2D;e.isCube&&(h=o.TEXTURE_CUBE_MAP_POSITIVE_X+r);var c=Math.round(Math.log(e.width)*Math.LOG2E),d=Math.round(Math.log(e.height)*Math.LOG2E),p=s?e.width:Math.pow(2,Math.max(c-n,0)),_=s?e.height:Math.pow(2,Math.max(d-n,0));o.texImage2D(h,n,f,p,_,0,u,l,t)},i.prototype.updateTextureData=function(e,t,r,n,a,s,o,l,u){o===void 0&&(o=0),l===void 0&&(l=0),u===void 0&&(u=!1);var f=this._gl,h=this._getWebGLTextureType(e.type),c=this._getInternalFormat(e.format);this._unpackFlipY(e.invertY);var d=f.TEXTURE_2D;e.isCube&&(d=f.TEXTURE_CUBE_MAP_POSITIVE_X+o),this._bindTextureDirectly(d,e,!0),f.texSubImage2D(d,l,r,n,a,s,c,h,t),u&&this._gl.generateMipmap(d),this._bindTextureDirectly(d,null)},i.prototype._uploadArrayBufferViewToTexture=function(e,t,r,n){r===void 0&&(r=0),n===void 0&&(n=0);var a=this._gl,s=e.isCube?a.TEXTURE_CUBE_MAP:a.TEXTURE_2D;this._bindTextureDirectly(s,e,!0),this._uploadDataToTextureDirectly(e,t,r,n),this._bindTextureDirectly(s,null,!0)},i.prototype._prepareWebGLTextureContinuation=function(e,t,r,n,a){var s=this._gl;if(!!s){var o=this._getSamplingParameters(a,!r);s.texParameteri(s.TEXTURE_2D,s.TEXTURE_MAG_FILTER,o.mag),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_MIN_FILTER,o.min),!r&&!n&&s.generateMipmap(s.TEXTURE_2D),this._bindTextureDirectly(s.TEXTURE_2D,null),t&&t._removePendingData(e),e.onLoadedObservable.notifyObservers(e),e.onLoadedObservable.clear()}},i.prototype._prepareWebGLTexture=function(e,t,r,n,a,s,o,l,u){var f=this;u===void 0&&(u=3);var h=this.getCaps().maxTextureSize,c=Math.min(h,this.needPOTTextures?i.GetExponentOfTwo(n.width,h):n.width),d=Math.min(h,this.needPOTTextures?i.GetExponentOfTwo(n.height,h):n.height),p=this._gl;if(!!p){if(!e._hardwareTexture){r&&r._removePendingData(e);return}this._bindTextureDirectly(p.TEXTURE_2D,e,!0),this._unpackFlipY(a===void 0?!0:!!a),e.baseWidth=n.width,e.baseHeight=n.height,e.width=c,e.height=d,e.isReady=!0,!l(c,d,n,t,e,function(){f._prepareWebGLTextureContinuation(e,r,s,o,u)})&&this._prepareWebGLTextureContinuation(e,r,s,o,u)}},i.prototype._setupFramebufferDepthAttachments=function(e,t,r,n,a){a===void 0&&(a=1);var s=this._gl;if(e&&t)return this._createRenderBuffer(r,n,a,s.DEPTH_STENCIL,s.DEPTH24_STENCIL8,s.DEPTH_STENCIL_ATTACHMENT);if(t){var o=s.DEPTH_COMPONENT16;return this._webGLVersion>1&&(o=s.DEPTH_COMPONENT32F),this._createRenderBuffer(r,n,a,o,o,s.DEPTH_ATTACHMENT)}return e?this._createRenderBuffer(r,n,a,s.STENCIL_INDEX8,s.STENCIL_INDEX8,s.STENCIL_ATTACHMENT):null},i.prototype._createRenderBuffer=function(e,t,r,n,a,s,o){o===void 0&&(o=!0);var l=this._gl,u=l.createRenderbuffer();return l.bindRenderbuffer(l.RENDERBUFFER,u),r>1&&l.renderbufferStorageMultisample?l.renderbufferStorageMultisample(l.RENDERBUFFER,r,a,e,t):l.renderbufferStorage(l.RENDERBUFFER,n,e,t),l.framebufferRenderbuffer(l.FRAMEBUFFER,s,l.RENDERBUFFER,u),o&&l.bindRenderbuffer(l.RENDERBUFFER,null),u},i.prototype._releaseTexture=function(e){var t;this._deleteTexture((t=e._hardwareTexture)===null||t===void 0?void 0:t.underlyingResource),this.unbindAllTextures();var r=this._internalTexturesCache.indexOf(e);r!==-1&&this._internalTexturesCache.splice(r,1),e._lodTextureHigh&&e._lodTextureHigh.dispose(),e._lodTextureMid&&e._lodTextureMid.dispose(),e._lodTextureLow&&e._lodTextureLow.dispose(),e._irradianceTexture&&e._irradianceTexture.dispose()},i.prototype._releaseRenderTargetWrapper=function(e){var t=this._renderTargetWrapperCache.indexOf(e);t!==-1&&this._renderTargetWrapperCache.splice(t,1)},i.prototype._deleteTexture=function(e){e&&this._gl.deleteTexture(e)},i.prototype._setProgram=function(e){this._currentProgram!==e&&(this._gl.useProgram(e),this._currentProgram=e)},i.prototype.bindSamplers=function(e){var t=e.getPipelineContext();this._setProgram(t.program);for(var r=e.getSamplers(),n=0;n<r.length;n++){var a=e.getUniform(r[n]);a&&(this._boundUniforms[n]=a)}this._currentEffect=null},i.prototype._activateCurrentTexture=function(){this._currentTextureChannel!==this._activeChannel&&(this._gl.activeTexture(this._gl.TEXTURE0+this._activeChannel),this._currentTextureChannel=this._activeChannel)},i.prototype._bindTextureDirectly=function(e,t,r,n){var a,s;r===void 0&&(r=!1),n===void 0&&(n=!1);var o=!1,l=t&&t._associatedChannel>-1;r&&l&&(this._activeChannel=t._associatedChannel);var u=this._boundTexturesCache[this._activeChannel];if(u!==t||n){if(this._activateCurrentTexture(),t&&t.isMultiview)throw console.error(e,t),"_bindTextureDirectly called with a multiview texture!";this._gl.bindTexture(e,(s=(a=t==null?void 0:t._hardwareTexture)===null||a===void 0?void 0:a.underlyingResource)!==null&&s!==void 0?s:null),this._boundTexturesCache[this._activeChannel]=t,t&&(t._associatedChannel=this._activeChannel)}else r&&(o=!0,this._activateCurrentTexture());return l&&!r&&this._bindSamplerUniformToChannel(t._associatedChannel,this._activeChannel),o},i.prototype._bindTexture=function(e,t,r){if(e!==void 0){t&&(t._associatedChannel=e),this._activeChannel=e;var n=t?this._getTextureTarget(t):this._gl.TEXTURE_2D;this._bindTextureDirectly(n,t)}},i.prototype.unbindAllTextures=function(){for(var e=0;e<this._maxSimultaneousTextures;e++)this._activeChannel=e,this._bindTextureDirectly(this._gl.TEXTURE_2D,null),this._bindTextureDirectly(this._gl.TEXTURE_CUBE_MAP,null),this.webGLVersion>1&&(this._bindTextureDirectly(this._gl.TEXTURE_3D,null),this._bindTextureDirectly(this._gl.TEXTURE_2D_ARRAY,null))},i.prototype.setTexture=function(e,t,r,n){e!==void 0&&(t&&(this._boundUniforms[e]=t),this._setTexture(e,r))},i.prototype._bindSamplerUniformToChannel=function(e,t){var r=this._boundUniforms[e];!r||r._currentState===t||(this._gl.uniform1i(r,t),r._currentState=t)},i.prototype._getTextureWrapMode=function(e){switch(e){case 1:return this._gl.REPEAT;case 0:return this._gl.CLAMP_TO_EDGE;case 2:return this._gl.MIRRORED_REPEAT}return this._gl.REPEAT},i.prototype._setTexture=function(e,t,r,n,a){if(r===void 0&&(r=!1),n===void 0&&(n=!1),!t)return this._boundTexturesCache[e]!=null&&(this._activeChannel=e,this._bindTextureDirectly(this._gl.TEXTURE_2D,null),this._bindTextureDirectly(this._gl.TEXTURE_CUBE_MAP,null),this.webGLVersion>1&&(this._bindTextureDirectly(this._gl.TEXTURE_3D,null),this._bindTextureDirectly(this._gl.TEXTURE_2D_ARRAY,null))),!1;if(t.video)this._activeChannel=e,t.update();else if(t.delayLoadState===4)return t.delayLoad(),!1;var s;n?s=t.depthStencilTexture:t.isReady()?s=t.getInternalTexture():t.isCube?s=this.emptyCubeTexture:t.is3D?s=this.emptyTexture3D:t.is2DArray?s=this.emptyTexture2DArray:s=this.emptyTexture,!r&&s&&(s._associatedChannel=e);var o=!0;this._boundTexturesCache[e]===s&&(r||this._bindSamplerUniformToChannel(s._associatedChannel,e),o=!1),this._activeChannel=e;var l=this._getTextureTarget(s);if(o&&this._bindTextureDirectly(l,s,r),s&&!s.isMultiview){if(s.isCube&&s._cachedCoordinatesMode!==t.coordinatesMode){s._cachedCoordinatesMode=t.coordinatesMode;var u=t.coordinatesMode!==3&&t.coordinatesMode!==5?1:0;t.wrapU=u,t.wrapV=u}s._cachedWrapU!==t.wrapU&&(s._cachedWrapU=t.wrapU,this._setTextureParameterInteger(l,this._gl.TEXTURE_WRAP_S,this._getTextureWrapMode(t.wrapU),s)),s._cachedWrapV!==t.wrapV&&(s._cachedWrapV=t.wrapV,this._setTextureParameterInteger(l,this._gl.TEXTURE_WRAP_T,this._getTextureWrapMode(t.wrapV),s)),s.is3D&&s._cachedWrapR!==t.wrapR&&(s._cachedWrapR=t.wrapR,this._setTextureParameterInteger(l,this._gl.TEXTURE_WRAP_R,this._getTextureWrapMode(t.wrapR),s)),this._setAnisotropicLevel(l,s,t.anisotropicFilteringLevel)}return!0},i.prototype.setTextureArray=function(e,t,r,n){if(!(e===void 0||!t)){(!this._textureUnits||this._textureUnits.length!==r.length)&&(this._textureUnits=new Int32Array(r.length));for(var a=0;a<r.length;a++){var s=r[a].getInternalTexture();s?(this._textureUnits[a]=e+a,s._associatedChannel=e+a):this._textureUnits[a]=-1}this._gl.uniform1iv(t,this._textureUnits);for(var o=0;o<r.length;o++)this._setTexture(this._textureUnits[o],r[o],!0)}},i.prototype._setAnisotropicLevel=function(e,t,r){var n=this._caps.textureAnisotropicFilterExtension;t.samplingMode!==11&&t.samplingMode!==3&&t.samplingMode!==2&&(r=1),n&&t._cachedAnisotropicFilteringLevel!==r&&(this._setTextureParameterFloat(e,n.TEXTURE_MAX_ANISOTROPY_EXT,Math.min(r,this._caps.maxAnisotropy),t),t._cachedAnisotropicFilteringLevel=r)},i.prototype._setTextureParameterFloat=function(e,t,r,n){this._bindTextureDirectly(e,n,!0,!0),this._gl.texParameterf(e,t,r)},i.prototype._setTextureParameterInteger=function(e,t,r,n){n&&this._bindTextureDirectly(e,n,!0,!0),this._gl.texParameteri(e,t,r)},i.prototype.unbindAllAttributes=function(){if(this._mustWipeVertexAttributes){this._mustWipeVertexAttributes=!1;for(var e=0;e<this._caps.maxVertexAttribs;e++)this.disableAttributeByIndex(e);return}for(var e=0,t=this._vertexAttribArraysEnabled.length;e<t;e++)e>=this._caps.maxVertexAttribs||!this._vertexAttribArraysEnabled[e]||this.disableAttributeByIndex(e)},i.prototype.releaseEffects=function(){for(var e in this._compiledEffects){var t=this._compiledEffects[e].getPipelineContext();this._deletePipelineContext(t)}this._compiledEffects={}},i.prototype.dispose=function(){var e;this.stopRenderLoop(),this.onBeforeTextureInitObservable&&this.onBeforeTextureInitObservable.clear(),this._emptyTexture&&(this._releaseTexture(this._emptyTexture),this._emptyTexture=null),this._emptyCubeTexture&&(this._releaseTexture(this._emptyCubeTexture),this._emptyCubeTexture=null),this._dummyFramebuffer&&this._gl.deleteFramebuffer(this._dummyFramebuffer),this.releaseEffects(),(e=this.releaseComputeEffects)===null||e===void 0||e.call(this),this.unbindAllAttributes(),this._boundUniforms=[],ze()&&this._renderingCanvas&&(this._doNotHandleContextLost||(this._renderingCanvas.removeEventListener("webglcontextlost",this._onContextLost),this._renderingCanvas.removeEventListener("webglcontextrestored",this._onContextRestored)),window.removeEventListener("resize",this._checkForMobile)),this._workingCanvas=null,this._workingContext=null,this._currentBufferPointers=[],this._renderingCanvas=null,this._currentProgram=null,this._boundRenderFunction=null,Kt.ResetCache();for(var t=0,r=this._activeRequests;t<r.length;t++){var n=r[t];n.abort()}this.onDisposeObservable.notifyObservers(this),this.onDisposeObservable.clear()},i.prototype.attachContextLostEvent=function(e){this._renderingCanvas&&this._renderingCanvas.addEventListener("webglcontextlost",e,!1)},i.prototype.attachContextRestoredEvent=function(e){this._renderingCanvas&&this._renderingCanvas.addEventListener("webglcontextrestored",e,!1)},i.prototype.getError=function(){return this._gl.getError()},i.prototype._canRenderToFloatFramebuffer=function(){return this._webGLVersion>1?this._caps.colorBufferFloat:this._canRenderToFramebuffer(1)},i.prototype._canRenderToHalfFloatFramebuffer=function(){return this._webGLVersion>1?this._caps.colorBufferFloat:this._canRenderToFramebuffer(2)},i.prototype._canRenderToFramebuffer=function(e){for(var t=this._gl;t.getError()!==t.NO_ERROR;);var r=!0,n=t.createTexture();t.bindTexture(t.TEXTURE_2D,n),t.texImage2D(t.TEXTURE_2D,0,this._getRGBABufferInternalSizedFormat(e),1,1,0,t.RGBA,this._getWebGLTextureType(e),null),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.NEAREST),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.NEAREST);var a=t.createFramebuffer();t.bindFramebuffer(t.FRAMEBUFFER,a),t.framebufferTexture2D(t.FRAMEBUFFER,t.COLOR_ATTACHMENT0,t.TEXTURE_2D,n,0);var s=t.checkFramebufferStatus(t.FRAMEBUFFER);if(r=r&&s===t.FRAMEBUFFER_COMPLETE,r=r&&t.getError()===t.NO_ERROR,r&&(t.clear(t.COLOR_BUFFER_BIT),r=r&&t.getError()===t.NO_ERROR),r){t.bindFramebuffer(t.FRAMEBUFFER,null);var o=t.RGBA,l=t.UNSIGNED_BYTE,u=new Uint8Array(4);t.readPixels(0,0,1,1,o,l,u),r=r&&t.getError()===t.NO_ERROR}for(t.deleteTexture(n),t.deleteFramebuffer(a),t.bindFramebuffer(t.FRAMEBUFFER,null);!r&&t.getError()!==t.NO_ERROR;);return r},i.prototype._getWebGLTextureType=function(e){if(this._webGLVersion===1){switch(e){case 1:return this._gl.FLOAT;case 2:return this._gl.HALF_FLOAT_OES;case 0:return this._gl.UNSIGNED_BYTE;case 8:return this._gl.UNSIGNED_SHORT_4_4_4_4;case 9:return this._gl.UNSIGNED_SHORT_5_5_5_1;case 10:return this._gl.UNSIGNED_SHORT_5_6_5}return this._gl.UNSIGNED_BYTE}switch(e){case 3:return this._gl.BYTE;case 0:return this._gl.UNSIGNED_BYTE;case 4:return this._gl.SHORT;case 5:return this._gl.UNSIGNED_SHORT;case 6:return this._gl.INT;case 7:return this._gl.UNSIGNED_INT;case 1:return this._gl.FLOAT;case 2:return this._gl.HALF_FLOAT;case 8:return this._gl.UNSIGNED_SHORT_4_4_4_4;case 9:return this._gl.UNSIGNED_SHORT_5_5_5_1;case 10:return this._gl.UNSIGNED_SHORT_5_6_5;case 11:return this._gl.UNSIGNED_INT_2_10_10_10_REV;case 12:return this._gl.UNSIGNED_INT_24_8;case 13:return this._gl.UNSIGNED_INT_10F_11F_11F_REV;case 14:return this._gl.UNSIGNED_INT_5_9_9_9_REV;case 15:return this._gl.FLOAT_32_UNSIGNED_INT_24_8_REV}return this._gl.UNSIGNED_BYTE},i.prototype._getInternalFormat=function(e,t){t===void 0&&(t=!1);var r=t?this._gl.SRGB8_ALPHA8:this._gl.RGBA;switch(e){case 0:r=this._gl.ALPHA;break;case 1:r=this._gl.LUMINANCE;break;case 2:r=this._gl.LUMINANCE_ALPHA;break;case 6:r=this._gl.RED;break;case 7:r=this._gl.RG;break;case 4:r=t?this._gl.SRGB:this._gl.RGB;break;case 5:r=t?this._gl.SRGB8_ALPHA8:this._gl.RGBA;break}if(this._webGLVersion>1)switch(e){case 8:r=this._gl.RED_INTEGER;break;case 9:r=this._gl.RG_INTEGER;break;case 10:r=this._gl.RGB_INTEGER;break;case 11:r=this._gl.RGBA_INTEGER;break}return r},i.prototype._getRGBABufferInternalSizedFormat=function(e,t,r){if(r===void 0&&(r=!1),this._webGLVersion===1){if(t!==void 0)switch(t){case 0:return this._gl.ALPHA;case 1:return this._gl.LUMINANCE;case 2:return this._gl.LUMINANCE_ALPHA;case 4:return r?this._gl.SRGB:this._gl.RGB}return this._gl.RGBA}switch(e){case 3:switch(t){case 6:return this._gl.R8_SNORM;case 7:return this._gl.RG8_SNORM;case 4:return this._gl.RGB8_SNORM;case 8:return this._gl.R8I;case 9:return this._gl.RG8I;case 10:return this._gl.RGB8I;case 11:return this._gl.RGBA8I;default:return this._gl.RGBA8_SNORM}case 0:switch(t){case 6:return this._gl.R8;case 7:return this._gl.RG8;case 4:return r?this._gl.SRGB8:this._gl.RGB8;case 5:return r?this._gl.SRGB8_ALPHA8:this._gl.RGBA8;case 8:return this._gl.R8UI;case 9:return this._gl.RG8UI;case 10:return this._gl.RGB8UI;case 11:return this._gl.RGBA8UI;case 0:return this._gl.ALPHA;case 1:return this._gl.LUMINANCE;case 2:return this._gl.LUMINANCE_ALPHA;default:return this._gl.RGBA8}case 4:switch(t){case 8:return this._gl.R16I;case 9:return this._gl.RG16I;case 10:return this._gl.RGB16I;case 11:return this._gl.RGBA16I;default:return this._gl.RGBA16I}case 5:switch(t){case 8:return this._gl.R16UI;case 9:return this._gl.RG16UI;case 10:return this._gl.RGB16UI;case 11:return this._gl.RGBA16UI;default:return this._gl.RGBA16UI}case 6:switch(t){case 8:return this._gl.R32I;case 9:return this._gl.RG32I;case 10:return this._gl.RGB32I;case 11:return this._gl.RGBA32I;default:return this._gl.RGBA32I}case 7:switch(t){case 8:return this._gl.R32UI;case 9:return this._gl.RG32UI;case 10:return this._gl.RGB32UI;case 11:return this._gl.RGBA32UI;default:return this._gl.RGBA32UI}case 1:switch(t){case 6:return this._gl.R32F;case 7:return this._gl.RG32F;case 4:return this._gl.RGB32F;case 5:return this._gl.RGBA32F;default:return this._gl.RGBA32F}case 2:switch(t){case 6:return this._gl.R16F;case 7:return this._gl.RG16F;case 4:return this._gl.RGB16F;case 5:return this._gl.RGBA16F;default:return this._gl.RGBA16F}case 10:return this._gl.RGB565;case 13:return this._gl.R11F_G11F_B10F;case 14:return this._gl.RGB9_E5;case 8:return this._gl.RGBA4;case 9:return this._gl.RGB5_A1;case 11:switch(t){case 5:return this._gl.RGB10_A2;case 11:return this._gl.RGB10_A2UI;default:return this._gl.RGB10_A2}}return r?this._gl.SRGB8_ALPHA8:this._gl.RGBA8},i.prototype._getRGBAMultiSampleBufferFormat=function(e){return e===1?this._gl.RGBA32F:e===2?this._gl.RGBA16F:this._gl.RGBA8},i.prototype._loadFile=function(e,t,r,n,a,s){var o=this,l=i._FileToolsLoadFile(e,t,r,n,a,s);return this._activeRequests.push(l),l.onCompleteObservable.add(function(u){o._activeRequests.splice(o._activeRequests.indexOf(u),1)}),l},i._FileToolsLoadFile=function(e,t,r,n,a,s){throw he("FileTools")},i.prototype.readPixels=function(e,t,r,n,a,s){a===void 0&&(a=!0),s===void 0&&(s=!0);var o=a?4:3,l=a?this._gl.RGBA:this._gl.RGB,u=new Uint8Array(n*r*o);return s&&this.flushFramebuffer(),this._gl.readPixels(e,t,r,n,l,this._gl.UNSIGNED_BYTE,u),Promise.resolve(u)},Object.defineProperty(i,"IsSupportedAsync",{get:function(){return Promise.resolve(this.isSupported())},enumerable:!1,configurable:!0}),Object.defineProperty(i,"IsSupported",{get:function(){return this.isSupported()},enumerable:!1,configurable:!0}),i.isSupported=function(){if(this._HasMajorPerformanceCaveat!==null)return!this._HasMajorPerformanceCaveat;if(this._IsSupported===null)try{var e=this._CreateCanvas(1,1),t=e.getContext("webgl")||e.getContext("experimental-webgl");this._IsSupported=t!=null&&!!window.WebGLRenderingContext}catch{this._IsSupported=!1}return this._IsSupported},Object.defineProperty(i,"HasMajorPerformanceCaveat",{get:function(){if(this._HasMajorPerformanceCaveat===null)try{var e=this._CreateCanvas(1,1),t=e.getContext("webgl",{failIfMajorPerformanceCaveat:!0})||e.getContext("experimental-webgl",{failIfMajorPerformanceCaveat:!0});this._HasMajorPerformanceCaveat=!t}catch{this._HasMajorPerformanceCaveat=!1}return this._HasMajorPerformanceCaveat},enumerable:!1,configurable:!0}),i.CeilingPOT=function(e){return e--,e|=e>>1,e|=e>>2,e|=e>>4,e|=e>>8,e|=e>>16,e++,e},i.FloorPOT=function(e){return e=e|e>>1,e=e|e>>2,e=e|e>>4,e=e|e>>8,e=e|e>>16,e-(e>>1)},i.NearestPOT=function(e){var t=i.CeilingPOT(e),r=i.FloorPOT(e);return t-e>e-r?r:t},i.GetExponentOfTwo=function(e,t,r){r===void 0&&(r=2);var n;switch(r){case 1:n=i.FloorPOT(e);break;case 2:n=i.NearestPOT(e);break;case 3:default:n=i.CeilingPOT(e);break}return Math.min(n,t)},i.QueueNewFrame=function(e,t){return ze()?(t||(t=window),t.requestPostAnimationFrame?t.requestPostAnimationFrame(e):t.requestAnimationFrame?t.requestAnimationFrame(e):t.msRequestAnimationFrame?t.msRequestAnimationFrame(e):t.webkitRequestAnimationFrame?t.webkitRequestAnimationFrame(e):t.mozRequestAnimationFrame?t.mozRequestAnimationFrame(e):t.oRequestAnimationFrame?t.oRequestAnimationFrame(e):window.setTimeout(e,16)):typeof requestAnimationFrame!="undefined"?requestAnimationFrame(e):setTimeout(e,16)},i.prototype.getHostDocument=function(){return this._renderingCanvas&&this._renderingCanvas.ownerDocument?this._renderingCanvas.ownerDocument:document},i.ExceptionList=[{key:"Chrome/63.0",capture:"63\\.0\\.3239\\.(\\d+)",captureConstraint:108,targets:["uniformBuffer"]},{key:"Firefox/58",capture:null,captureConstraint:null,targets:["uniformBuffer"]},{key:"Firefox/59",capture:null,captureConstraint:null,targets:["uniformBuffer"]},{key:"Chrome/72.+?Mobile",capture:null,captureConstraint:null,targets:["vao"]},{key:"Chrome/73.+?Mobile",capture:null,captureConstraint:null,targets:["vao"]},{key:"Chrome/74.+?Mobile",capture:null,captureConstraint:null,targets:["vao"]},{key:"Mac OS.+Chrome/71",capture:null,captureConstraint:null,targets:["vao"]},{key:"Mac OS.+Chrome/72",capture:null,captureConstraint:null,targets:["vao"]}],i._TextureLoaders=[],i.CollisionsEpsilon=.001,i._IsSupported=null,i._HasMajorPerformanceCaveat=null,i}(),qr=function(){function i(){}return i.SetImmediate=function(e){ze()&&window.setImmediate?window.setImmediate(e):setTimeout(e,1)},i}(),Vo=new RegExp(/^data:([^,]+\/[^,]+)?;base64,/i),Cn=function(i){$(e,i);function e(t,r){var n=i.call(this,t,sr.LoadFileError)||this;return n.name="LoadFileError",Or._setPrototypeOf(n,e.prototype),r instanceof Jt?n.request=r:n.file=r,n}return e}(or),xn=function(i){$(e,i);function e(t,r){var n=i.call(this,t,sr.RequestFileError)||this;return n.request=r,n.name="RequestFileError",Or._setPrototypeOf(n,e.prototype),n}return e}(or),ko=function(i){$(e,i);function e(t,r){var n=i.call(this,t,sr.ReadFileError)||this;return n.file=r,n.name="ReadFileError",Or._setPrototypeOf(n,e.prototype),n}return e}(or),Xe={DefaultRetryStrategy:Eo.ExponentialBackoff(),BaseUrl:"",CorsBehavior:"anonymous",PreprocessUrl:function(i){return i}},La=function(i){return i=i.replace(/#/gm,"%23"),i},tn=function(i,e){if(!(i&&i.indexOf("data:")===0)&&Xe.CorsBehavior)if(typeof Xe.CorsBehavior=="string"||Xe.CorsBehavior instanceof String)e.crossOrigin=Xe.CorsBehavior;else{var t=Xe.CorsBehavior(i);t&&(e.crossOrigin=t)}},Vr=function(i,e,t,r,n,a){var s;n===void 0&&(n="");var o,l=!1;i instanceof ArrayBuffer||ArrayBuffer.isView(i)?typeof Blob!="undefined"?(o=URL.createObjectURL(new Blob([i],{type:n})),l=!0):o="data:".concat(n,";base64,")+Ji(i):i instanceof Blob?(o=URL.createObjectURL(i),l=!0):(o=La(i),o=Xe.PreprocessUrl(i));var u=ye.LastCreatedEngine,f=function(y){if(t){var b=o||i.toString();t("Error while trying to load image: ".concat(b.indexOf("http")===0||b.length<=128?b:b.slice(0,128)+"..."),y)}};if(typeof Image=="undefined"||((s=u==null?void 0:u._features.forceBitmapOverHTMLImageElement)!==null&&s!==void 0?s:!1))return fr(o,function(y){u.createImageBitmap(new Blob([y],{type:n}),Ue({premultiplyAlpha:"none"},a)).then(function(b){e(b),l&&URL.revokeObjectURL(o)}).catch(function(b){t&&t("Error while trying to load image: "+i,b)})},void 0,r||void 0,!0,function(y,b){f(b)}),null;var h=new Image;tn(o,h);var c=function(){h.removeEventListener("load",c),h.removeEventListener("error",d),e(h),l&&h.src&&URL.revokeObjectURL(h.src)},d=function(y){h.removeEventListener("load",c),h.removeEventListener("error",d),f(y),l&&h.src&&URL.revokeObjectURL(h.src)};h.addEventListener("load",c),h.addEventListener("error",d);var p=function(){h.src=o},_=function(){r&&r.loadImage(o,h)};if(o.substr(0,5)!=="blob:"&&o.substr(0,5)!=="data:"&&r&&r.enableTexturesOffline)r.open(_,p);else{if(o.indexOf("file:")!==-1){var g=decodeURIComponent(o.substring(5).toLowerCase());if(Rr.FilesToLoad[g]){try{var v=void 0;try{v=URL.createObjectURL(Rr.FilesToLoad[g])}catch{v=URL.createObjectURL(Rr.FilesToLoad[g])}h.src=v,l=!0}catch{h.src=""}return h}}p()}return h},Fr=function(i,e,t,r,n){var a=new FileReader,s={onCompleteObservable:new X,abort:function(){return a.abort()}};return a.onloadend=function(){return s.onCompleteObservable.notifyObservers(s)},n&&(a.onerror=function(){n(new ko("Unable to read ".concat(i.name),i))}),a.onload=function(o){e(o.target.result)},t&&(a.onprogress=t),r?a.readAsArrayBuffer(i):a.readAsText(i),s},fr=function(i,e,t,r,n,a,s){if(i.name)return Fr(i,e,t,n,a?function(h){a(void 0,h)}:void 0);var o=i;if(o.indexOf("file:")!==-1){var l=decodeURIComponent(o.substring(5).toLowerCase());l.indexOf("./")===0&&(l=l.substring(2));var u=Rr.FilesToLoad[l];if(u)return Fr(u,e,t,n,a?function(h){return a(void 0,new Cn(h.message,h.file))}:void 0)}if(ni(o)){var f={onCompleteObservable:new X,abort:function(){return function(){}}};try{e(n?nn(o):Ba(o))}catch(h){a?a(void 0,h):Y.Error(h.message||"Failed to parse the Data URL")}return qr.SetImmediate(function(){f.onCompleteObservable.notifyObservers(f)}),f}return rn(o,function(h,c){e(h,c?c.responseURL:void 0)},t,r,n,a?function(h){a(h.request,new Cn(h.message,h.request))}:void 0,s)},rn=function(i,e,t,r,n,a,s){i=La(i),i=Xe.PreprocessUrl(i);var o=Xe.BaseUrl+i,l=!1,u={onCompleteObservable:new X,abort:function(){return l=!0}},f=function(){var d=new Jt,p=null,_,g=function(){!d||(t&&d.removeEventListener("progress",t),_&&d.removeEventListener("readystatechange",_),d.removeEventListener("loadend",v))},v=function(){g(),u.onCompleteObservable.notifyObservers(u),u.onCompleteObservable.clear(),t=void 0,_=null,v=null,a=void 0,s=void 0,e=void 0};u.abort=function(){l=!0,v&&v(),d&&d.readyState!==(XMLHttpRequest.DONE||4)&&d.abort(),p!==null&&(clearTimeout(p),p=null),d=null};var y=function(E){var A=E.message||"Unknown error";a&&d?a(new xn(A,d)):Y.Error(A)},b=function(E){if(!!d){if(d.open("GET",o),s)try{s(d)}catch(A){y(A);return}n&&(d.responseType="arraybuffer"),t&&d.addEventListener("progress",t),v&&d.addEventListener("loadend",v),_=function(){if(!(l||!d)&&d.readyState===(XMLHttpRequest.DONE||4)){if(_&&d.removeEventListener("readystatechange",_),d.status>=200&&d.status<300||d.status===0&&(!ze()||Na())){try{e&&e(n?d.response:d.responseText,d)}catch(M){y(M)}return}var A=Xe.DefaultRetryStrategy;if(A){var S=A(o,d,E);if(S!==-1){g(),d=new Jt,p=setTimeout(function(){return b(E+1)},S);return}}var T=new xn("Error status: "+d.status+" "+d.statusText+" - Unable to load "+o,d);a&&a(T)}},d.addEventListener("readystatechange",_),d.send()}};b(0)};if(r&&r.enableSceneOffline){var h=function(d){d&&d.status>400?a&&a(d):f()},c=function(){r&&r.loadFile(Xe.BaseUrl+i,function(d){!l&&e&&e(d),u.onCompleteObservable.notifyObservers(u)},t?function(d){!l&&t&&t(d)}:void 0,h,n)};r.open(c,h)}else f();return u},Na=function(){return typeof location!="undefined"&&location.protocol==="file:"},ni=function(i){return Vo.test(i)};function nn(i){return Fa(i.split(",")[1])}var Ba=function(i){return en(i.split(",")[1])},Go=function(){ge._FileToolsLoadImage=Vr,ge._FileToolsLoadFile=fr,Sr._FileToolsLoadFile=fr};Go();var Tr,zo=function(i,e,t,r,n,a,s,o,l,u){Tr={DecodeBase64UrlToBinary:i,DecodeBase64UrlToString:e,DefaultRetryStrategy:t.DefaultRetryStrategy,BaseUrl:t.BaseUrl,CorsBehavior:t.CorsBehavior,PreprocessUrl:t.PreprocessUrl,IsBase64DataUrl:r,IsFileURL:n,LoadFile:a,LoadImage:s,ReadFile:o,RequestFile:l,SetCorsBehavior:u},Object.defineProperty(Tr,"DefaultRetryStrategy",{get:function(){return t.DefaultRetryStrategy},set:function(f){t.DefaultRetryStrategy=f}}),Object.defineProperty(Tr,"BaseUrl",{get:function(){return t.BaseUrl},set:function(f){t.BaseUrl=f}}),Object.defineProperty(Tr,"PreprocessUrl",{get:function(){return t.PreprocessUrl},set:function(f){t.PreprocessUrl=f}}),Object.defineProperty(Tr,"CorsBehavior",{get:function(){return t.CorsBehavior},set:function(f){t.CorsBehavior=f}})};zo(nn,Ba,Xe,ni,Na,fr,Vr,Fr,rn,tn);var Zr=function(){function i(e,t){this.width=e,this.height=t}return i.prototype.toString=function(){return"{W: ".concat(this.width,", H: ").concat(this.height,"}")},i.prototype.getClassName=function(){return"Size"},i.prototype.getHashCode=function(){var e=this.width|0;return e=e*397^(this.height|0),e},i.prototype.copyFrom=function(e){this.width=e.width,this.height=e.height},i.prototype.copyFromFloats=function(e,t){return this.width=e,this.height=t,this},i.prototype.set=function(e,t){return this.copyFromFloats(e,t)},i.prototype.multiplyByFloats=function(e,t){return new i(this.width*e,this.height*t)},i.prototype.clone=function(){return new i(this.width,this.height)},i.prototype.equals=function(e){return e?this.width===e.width&&this.height===e.height:!1},Object.defineProperty(i.prototype,"surface",{get:function(){return this.width*this.height},enumerable:!1,configurable:!0}),i.Zero=function(){return new i(0,0)},i.prototype.add=function(e){var t=new i(this.width+e.width,this.height+e.height);return t},i.prototype.subtract=function(e){var t=new i(this.width-e.width,this.height-e.height);return t},i.Lerp=function(e,t,r){var n=e.width+(t.width-e.width)*r,a=e.height+(t.height-e.height)*r;return new i(n,a)},i}(),Wo=function(){function i(e){this._wrapU=1,this._wrapV=1,this.wrapR=1,this.anisotropicFilteringLevel=4,this.delayLoadState=0,this._texture=null,this._engine=null,this._cachedSize=Zr.Zero(),this._cachedBaseSize=Zr.Zero(),this._initialSamplingMode=2,this._texture=e,this._texture&&(this._engine=this._texture.getEngine())}return Object.defineProperty(i.prototype,"wrapU",{get:function(){return this._wrapU},set:function(e){this._wrapU=e},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"wrapV",{get:function(){return this._wrapV},set:function(e){this._wrapV=e},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"coordinatesMode",{get:function(){return 0},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"isCube",{get:function(){return this._texture?this._texture.isCube:!1},set:function(e){!this._texture||(this._texture.isCube=e)},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"is3D",{get:function(){return this._texture?this._texture.is3D:!1},set:function(e){!this._texture||(this._texture.is3D=e)},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"is2DArray",{get:function(){return this._texture?this._texture.is2DArray:!1},set:function(e){!this._texture||(this._texture.is2DArray=e)},enumerable:!1,configurable:!0}),i.prototype.getClassName=function(){return"ThinTexture"},i.prototype.isReady=function(){return this.delayLoadState===4?(this.delayLoad(),!1):this._texture?this._texture.isReady:!1},i.prototype.delayLoad=function(){},i.prototype.getInternalTexture=function(){return this._texture},i.prototype.getSize=function(){if(this._texture){if(this._texture.width)return this._cachedSize.width=this._texture.width,this._cachedSize.height=this._texture.height,this._cachedSize;if(this._texture._size)return this._cachedSize.width=this._texture._size,this._cachedSize.height=this._texture._size,this._cachedSize}return this._cachedSize},i.prototype.getBaseSize=function(){return!this.isReady()||!this._texture?(this._cachedBaseSize.width=0,this._cachedBaseSize.height=0,this._cachedBaseSize):this._texture._size?(this._cachedBaseSize.width=this._texture._size,this._cachedBaseSize.height=this._texture._size,this._cachedBaseSize):(this._cachedBaseSize.width=this._texture.baseWidth,this._cachedBaseSize.height=this._texture.baseHeight,this._cachedBaseSize)},Object.defineProperty(i.prototype,"samplingMode",{get:function(){return this._texture?this._texture.samplingMode:this._initialSamplingMode},enumerable:!1,configurable:!0}),i.prototype.updateSamplingMode=function(e){this._texture&&this._engine&&this._engine.updateTextureSamplingMode(e,this._texture)},i.prototype.releaseInternalTexture=function(){this._texture&&(this._texture.dispose(),this._texture=null)},i.prototype.dispose=function(){this._texture&&(this.releaseInternalTexture(),this._engine=null)},i}(),bt=function(i){$(e,i);function e(t){var r=i.call(this,null)||this;return r.metadata=null,r.reservedDataStore=null,r._hasAlpha=!1,r._getAlphaFromRGB=!1,r.level=1,r._coordinatesIndex=0,r._coordinatesMode=0,r.wrapR=1,r.anisotropicFilteringLevel=e.DEFAULT_ANISOTROPIC_FILTERING_LEVEL,r._isCube=!1,r._gammaSpace=!0,r.invertZ=!1,r.lodLevelInAlpha=!1,r.isRenderTarget=!1,r._prefiltered=!1,r._forceSerialize=!1,r.animations=new Array,r.onDisposeObservable=new X,r._onDisposeObserver=null,r._scene=null,r._uid=null,r._parentContainer=null,r._loadingError=!1,t?e._IsScene(t)?r._scene=t:r._engine=t:r._scene=ye.LastCreatedScene,r._scene&&(r.uniqueId=r._scene.getUniqueId(),r._scene.addTexture(r),r._engine=r._scene.getEngine()),r._uid=null,r}return Object.defineProperty(e.prototype,"hasAlpha",{get:function(){return this._hasAlpha},set:function(t){var r=this;this._hasAlpha!==t&&(this._hasAlpha=t,this._scene&&this._scene.markAllMaterialsAsDirty(1,function(n){return n.hasTexture(r)}))},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"getAlphaFromRGB",{get:function(){return this._getAlphaFromRGB},set:function(t){var r=this;this._getAlphaFromRGB!==t&&(this._getAlphaFromRGB=t,this._scene&&this._scene.markAllMaterialsAsDirty(1,function(n){return n.hasTexture(r)}))},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"coordinatesIndex",{get:function(){return this._coordinatesIndex},set:function(t){var r=this;this._coordinatesIndex!==t&&(this._coordinatesIndex=t,this._scene&&this._scene.markAllMaterialsAsDirty(1,function(n){return n.hasTexture(r)}))},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"coordinatesMode",{get:function(){return this._coordinatesMode},set:function(t){var r=this;this._coordinatesMode!==t&&(this._coordinatesMode=t,this._scene&&this._scene.markAllMaterialsAsDirty(1,function(n){return n.hasTexture(r)}))},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"wrapU",{get:function(){return this._wrapU},set:function(t){this._wrapU=t},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"wrapV",{get:function(){return this._wrapV},set:function(t){this._wrapV=t},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"isCube",{get:function(){return this._texture?this._texture.isCube:this._isCube},set:function(t){this._texture?this._texture.isCube=t:this._isCube=t},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"is3D",{get:function(){return this._texture?this._texture.is3D:!1},set:function(t){!this._texture||(this._texture.is3D=t)},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"is2DArray",{get:function(){return this._texture?this._texture.is2DArray:!1},set:function(t){!this._texture||(this._texture.is2DArray=t)},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"gammaSpace",{get:function(){if(this._texture)this._texture._gammaSpace===null&&(this._texture._gammaSpace=this._gammaSpace);else return this._gammaSpace;return this._texture._gammaSpace&&!this._texture._useSRGBBuffer},set:function(t){if(this._texture){if(this._texture._gammaSpace===t)return;this._texture._gammaSpace=t}else{if(this._gammaSpace===t)return;this._gammaSpace=t}this._markAllSubMeshesAsTexturesDirty()},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"isRGBD",{get:function(){return this._texture!=null&&this._texture._isRGBD},set:function(t){this._texture&&(this._texture._isRGBD=t)},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"noMipmap",{get:function(){return!1},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"lodGenerationOffset",{get:function(){return this._texture?this._texture._lodGenerationOffset:0},set:function(t){this._texture&&(this._texture._lodGenerationOffset=t)},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"lodGenerationScale",{get:function(){return this._texture?this._texture._lodGenerationScale:0},set:function(t){this._texture&&(this._texture._lodGenerationScale=t)},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"linearSpecularLOD",{get:function(){return this._texture?this._texture._linearSpecularLOD:!1},set:function(t){this._texture&&(this._texture._linearSpecularLOD=t)},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"irradianceTexture",{get:function(){return this._texture?this._texture._irradianceTexture:null},set:function(t){this._texture&&(this._texture._irradianceTexture=t)},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"uid",{get:function(){return this._uid||(this._uid=Zi()),this._uid},enumerable:!1,configurable:!0}),e.prototype.toString=function(){return this.name},e.prototype.getClassName=function(){return"BaseTexture"},Object.defineProperty(e.prototype,"onDispose",{set:function(t){this._onDisposeObserver&&this.onDisposeObservable.remove(this._onDisposeObserver),this._onDisposeObserver=this.onDisposeObservable.add(t)},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"isBlocking",{get:function(){return!0},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"loadingError",{get:function(){return this._loadingError},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"errorObject",{get:function(){return this._errorObject},enumerable:!1,configurable:!0}),e.prototype.getScene=function(){return this._scene},e.prototype._getEngine=function(){return this._engine},e.prototype.checkTransformsAreIdentical=function(t){return t!==null},e.prototype.getTextureMatrix=function(){return G.IdentityReadOnly},e.prototype.getReflectionTextureMatrix=function(){return G.IdentityReadOnly},e.prototype.isReadyOrNotBlocking=function(){return!this.isBlocking||this.isReady()||this.loadingError},e.prototype.scale=function(t){},Object.defineProperty(e.prototype,"canRescale",{get:function(){return!1},enumerable:!1,configurable:!0}),e.prototype._getFromCache=function(t,r,n,a,s){var o=this._getEngine();if(!o)return null;for(var l=o._getUseSRGBBuffer(!!s,r),u=o.getLoadedTexturesCache(),f=0;f<u.length;f++){var h=u[f];if((s===void 0||l===h._useSRGBBuffer)&&(a===void 0||a===h.invertY)&&h.url===t&&h.generateMipMaps===!r&&(!n||n===h.samplingMode))return h.incrementReferences(),h}return null},e.prototype._rebuild=function(){},e.prototype.clone=function(){return null},Object.defineProperty(e.prototype,"textureType",{get:function(){return this._texture&&this._texture.type!==void 0?this._texture.type:0},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"textureFormat",{get:function(){return this._texture&&this._texture.format!==void 0?this._texture.format:5},enumerable:!1,configurable:!0}),e.prototype._markAllSubMeshesAsTexturesDirty=function(){var t=this.getScene();!t||t.markAllMaterialsAsDirty(1)},e.prototype.readPixels=function(t,r,n,a,s,o,l,u,f){if(t===void 0&&(t=0),r===void 0&&(r=0),n===void 0&&(n=null),a===void 0&&(a=!0),s===void 0&&(s=!1),o===void 0&&(o=0),l===void 0&&(l=0),u===void 0&&(u=Number.MAX_VALUE),f===void 0&&(f=Number.MAX_VALUE),!this._texture)return null;var h=this._getEngine();if(!h)return null;var c=this.getSize(),d=c.width,p=c.height;r!==0&&(d=d/Math.pow(2,r),p=p/Math.pow(2,r),d=Math.round(d),p=Math.round(p)),u=Math.min(d,u),f=Math.min(p,f);try{return this._texture.isCube?h._readTexturePixels(this._texture,u,f,t,r,n,a,s,o,l):h._readTexturePixels(this._texture,u,f,-1,r,n,a,s,o,l)}catch{return null}},e.prototype._readPixelsSync=function(t,r,n,a,s){if(t===void 0&&(t=0),r===void 0&&(r=0),n===void 0&&(n=null),a===void 0&&(a=!0),s===void 0&&(s=!1),!this._texture)return null;var o=this.getSize(),l=o.width,u=o.height,f=this._getEngine();if(!f)return null;r!=0&&(l=l/Math.pow(2,r),u=u/Math.pow(2,r),l=Math.round(l),u=Math.round(u));try{return this._texture.isCube?f._readTexturePixelsSync(this._texture,l,u,t,r,n,a,s):f._readTexturePixelsSync(this._texture,l,u,-1,r,n,a,s)}catch{return null}},Object.defineProperty(e.prototype,"_lodTextureHigh",{get:function(){return this._texture?this._texture._lodTextureHigh:null},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"_lodTextureMid",{get:function(){return this._texture?this._texture._lodTextureMid:null},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"_lodTextureLow",{get:function(){return this._texture?this._texture._lodTextureLow:null},enumerable:!1,configurable:!0}),e.prototype.dispose=function(){if(this._scene){this._scene.stopAnimation&&this._scene.stopAnimation(this),this._scene._removePendingData(this);var t=this._scene.textures.indexOf(this);if(t>=0&&this._scene.textures.splice(t,1),this._scene.onTextureRemovedObservable.notifyObservers(this),this._scene=null,this._parentContainer){var r=this._parentContainer.textures.indexOf(this);r>-1&&this._parentContainer.textures.splice(r,1),this._parentContainer=null}}this.onDisposeObservable.notifyObservers(this),this.onDisposeObservable.clear(),this.metadata=null,i.prototype.dispose.call(this)},e.prototype.serialize=function(){if(!this.name)return null;var t=pe.Serialize(this);return pe.AppendSerializedAnimations(this,t),t},e.WhenAllReady=function(t,r){var n=t.length;if(n===0){r();return}for(var a=0;a<t.length;a++){var s=t[a];if(s.isReady())--n===0&&r();else{var o=s.onLoadObservable;o?o.addOnce(function(){--n===0&&r()}):--n===0&&r()}}},e._IsScene=function(t){return t.getClassName()==="Scene"},e.DEFAULT_ANISOTROPIC_FILTERING_LEVEL=4,C([I()],e.prototype,"uniqueId",void 0),C([I()],e.prototype,"name",void 0),C([I()],e.prototype,"metadata",void 0),C([I("hasAlpha")],e.prototype,"_hasAlpha",void 0),C([I("getAlphaFromRGB")],e.prototype,"_getAlphaFromRGB",void 0),C([I()],e.prototype,"level",void 0),C([I("coordinatesIndex")],e.prototype,"_coordinatesIndex",void 0),C([I("coordinatesMode")],e.prototype,"_coordinatesMode",void 0),C([I()],e.prototype,"wrapU",null),C([I()],e.prototype,"wrapV",null),C([I()],e.prototype,"wrapR",void 0),C([I()],e.prototype,"anisotropicFilteringLevel",void 0),C([I()],e.prototype,"isCube",null),C([I()],e.prototype,"is3D",null),C([I()],e.prototype,"is2DArray",null),C([I()],e.prototype,"gammaSpace",null),C([I()],e.prototype,"invertZ",void 0),C([I()],e.prototype,"lodLevelInAlpha",void 0),C([I()],e.prototype,"lodGenerationOffset",null),C([I()],e.prototype,"lodGenerationScale",null),C([I()],e.prototype,"linearSpecularLOD",null),C([ot()],e.prototype,"irradianceTexture",null),C([I()],e.prototype,"isRenderTarget",void 0),e}(Wo),Xr=function(){function i(){}return i.Instantiate=function(e){if(this.RegisteredExternalClasses&&this.RegisteredExternalClasses[e])return this.RegisteredExternalClasses[e];var t=lt(e);if(t)return t;Y.Warn(e+" not found, you may have missed an import.");for(var r=e.split("."),n=window||this,a=0,s=r.length;a<s;a++)n=n[r[a]];return typeof n!="function"?null:n},i.RegisteredExternalClasses={},i}(),yr=function(){function i(e,t,r,n){this.normal=new m(e,t,r),this.d=n}return i.prototype.asArray=function(){return[this.normal.x,this.normal.y,this.normal.z,this.d]},i.prototype.clone=function(){return new i(this.normal.x,this.normal.y,this.normal.z,this.d)},i.prototype.getClassName=function(){return"Plane"},i.prototype.getHashCode=function(){var e=this.normal.getHashCode();return e=e*397^(this.d|0),e},i.prototype.normalize=function(){var e=Math.sqrt(this.normal.x*this.normal.x+this.normal.y*this.normal.y+this.normal.z*this.normal.z),t=0;return e!==0&&(t=1/e),this.normal.x*=t,this.normal.y*=t,this.normal.z*=t,this.d*=t,this},i.prototype.transform=function(e){var t=i._TmpMatrix;e.invertToRef(t);var r=t.m,n=this.normal.x,a=this.normal.y,s=this.normal.z,o=this.d,l=n*r[0]+a*r[1]+s*r[2]+o*r[3],u=n*r[4]+a*r[5]+s*r[6]+o*r[7],f=n*r[8]+a*r[9]+s*r[10]+o*r[11],h=n*r[12]+a*r[13]+s*r[14]+o*r[15];return new i(l,u,f,h)},i.prototype.dotCoordinate=function(e){return this.normal.x*e.x+this.normal.y*e.y+this.normal.z*e.z+this.d},i.prototype.copyFromPoints=function(e,t,r){var n=t.x-e.x,a=t.y-e.y,s=t.z-e.z,o=r.x-e.x,l=r.y-e.y,u=r.z-e.z,f=a*u-s*l,h=s*o-n*u,c=n*l-a*o,d=Math.sqrt(f*f+h*h+c*c),p;return d!==0?p=1/d:p=0,this.normal.x=f*p,this.normal.y=h*p,this.normal.z=c*p,this.d=-(this.normal.x*e.x+this.normal.y*e.y+this.normal.z*e.z),this},i.prototype.isFrontFacingTo=function(e,t){var r=m.Dot(this.normal,e);return r<=t},i.prototype.signedDistanceTo=function(e){return m.Dot(e,this.normal)+this.d},i.FromArray=function(e){return new i(e[0],e[1],e[2],e[3])},i.FromPoints=function(e,t,r){var n=new i(0,0,0,0);return n.copyFromPoints(e,t,r),n},i.FromPositionAndNormal=function(e,t){var r=new i(0,0,0,0);return t.normalize(),r.normal=t,r.d=-(t.x*e.x+t.y*e.y+t.z*e.z),r},i.SignedDistanceToPlaneFromPositionAndNormal=function(e,t,r){var n=-(t.x*e.x+t.y*e.y+t.z*e.z);return m.Dot(r,t)+n},i._TmpMatrix=G.Identity(),i}();function Ua(i,e,t){t===void 0&&(t=!1);var r=e.width,n=e.height;if(i instanceof Float32Array){for(var a=i.byteLength/i.BYTES_PER_ELEMENT,s=new Uint8Array(a);--a>=0;){var o=i[a];o<0?o=0:o>1&&(o=1),s[a]=o*255}i=s}var l=document.createElement("canvas");l.width=r,l.height=n;var u=l.getContext("2d");if(!u)return null;var f=u.createImageData(r,n),h=f.data;if(h.set(i),u.putImageData(f,0,0),t){var c=document.createElement("canvas");c.width=r,c.height=n;var d=c.getContext("2d");return d?(d.translate(0,n),d.scale(1,-1),d.drawImage(l,0,0),c.toDataURL("image/png")):null}return l.toDataURL("image/png")}function Ho(i,e,t){e===void 0&&(e=0),t===void 0&&(t=0);var r=i.getInternalTexture();if(!r)return null;var n=i._readPixelsSync(e,t);return n?Ua(n,i.getSize(),r.invertY):null}function Xo(i,e,t){return e===void 0&&(e=0),t===void 0&&(t=0),qi(this,void 0,void 0,function(){var r,n;return gr(this,function(a){switch(a.label){case 0:return r=i.getInternalTexture(),r?[4,i.readPixels(e,t)]:[2,null];case 1:return n=a.sent(),n?[2,Ua(n,i.getSize(),r.invertY)]:[2,null]}})})}var Se=function(){function i(){}return i.UseOpenGLOrientationForUV=!1,i}(),re=function(i){$(e,i);function e(t,r,n,a,s,o,l,u,f,h,c,d,p){s===void 0&&(s=e.TRILINEAR_SAMPLINGMODE),o===void 0&&(o=null),l===void 0&&(l=null),u===void 0&&(u=null),f===void 0&&(f=!1);var _=this,g,v,y,b,E,A,S,T,M;_=i.call(this,r)||this,_.url=null,_.uOffset=0,_.vOffset=0,_.uScale=1,_.vScale=1,_.uAng=0,_.vAng=0,_.wAng=0,_.uRotationCenter=.5,_.vRotationCenter=.5,_.wRotationCenter=.5,_.homogeneousRotationInUVTransform=!1,_.inspectableCustomProperties=null,_._noMipmap=!1,_._invertY=!1,_._rowGenerationMatrix=null,_._cachedTextureMatrix=null,_._projectionModeMatrix=null,_._t0=null,_._t1=null,_._t2=null,_._cachedUOffset=-1,_._cachedVOffset=-1,_._cachedUScale=0,_._cachedVScale=0,_._cachedUAng=-1,_._cachedVAng=-1,_._cachedWAng=-1,_._cachedProjectionMatrixId=-1,_._cachedURotationCenter=-1,_._cachedVRotationCenter=-1,_._cachedWRotationCenter=-1,_._cachedHomogeneousRotationInUVTransform=!1,_._cachedCoordinatesMode=-1,_._buffer=null,_._deleteBuffer=!1,_._format=null,_._delayedOnLoad=null,_._delayedOnError=null,_.onLoadObservable=new X,_._isBlocking=!0,_.name=t||"",_.url=t;var D,x=!1,P=null;typeof n=="object"&&n!==null?(D=(g=n.noMipmap)!==null&&g!==void 0?g:!1,a=(v=n.invertY)!==null&&v!==void 0?v:!Se.UseOpenGLOrientationForUV,s=(y=n.samplingMode)!==null&&y!==void 0?y:e.TRILINEAR_SAMPLINGMODE,o=(b=n.onLoad)!==null&&b!==void 0?b:null,l=(E=n.onError)!==null&&E!==void 0?E:null,u=(A=n.buffer)!==null&&A!==void 0?A:null,f=(S=n.deleteBuffer)!==null&&S!==void 0?S:!1,h=n.format,c=n.mimeType,d=n.loaderOptions,p=n.creationFlags,x=(T=n.useSRGBBuffer)!==null&&T!==void 0?T:!1,P=(M=n.internalTexture)!==null&&M!==void 0?M:null):D=!!n,_._noMipmap=D,_._invertY=a===void 0?!Se.UseOpenGLOrientationForUV:a,_._initialSamplingMode=s,_._buffer=u,_._deleteBuffer=f,_._mimeType=c,_._loaderOptions=d,_._creationFlags=p,_._useSRGBBuffer=x,h&&(_._format=h);var w=_.getScene(),k=_._getEngine();if(!k)return _;k.onBeforeTextureInitObservable.notifyObservers(_);var B=function(){_._texture&&(_._texture._invertVScale&&(_.vScale*=-1,_.vOffset+=1),_._texture._cachedWrapU!==null&&(_.wrapU=_._texture._cachedWrapU,_._texture._cachedWrapU=null),_._texture._cachedWrapV!==null&&(_.wrapV=_._texture._cachedWrapV,_._texture._cachedWrapV=null),_._texture._cachedWrapR!==null&&(_.wrapR=_._texture._cachedWrapR,_._texture._cachedWrapR=null)),_.onLoadObservable.hasObservers()&&_.onLoadObservable.notifyObservers(_),o&&o(),!_.isBlocking&&w&&w.resetCachedMaterial()},L=function(W,F){_._loadingError=!0,_._errorObject={message:W,exception:F},l&&l(W,F),e.OnTextureLoadErrorObservable.notifyObservers(_)};if(!_.url)return _._delayedOnLoad=B,_._delayedOnError=L,_;if(_._texture=P!=null?P:_._getFromCache(_.url,D,s,_._invertY,x),_._texture)if(_._texture.isReady)qr.SetImmediate(function(){return B()});else{var H=_._texture.onLoadedObservable.add(B);_._texture.onErrorObservable.add(function(W){var F;L(W.message,W.exception),(F=_._texture)===null||F===void 0||F.onLoadedObservable.remove(H)})}else if(!w||!w.useDelayedTextureLoading){try{_._texture=k.createTexture(_.url,D,_._invertY,w,s,B,L,_._buffer,void 0,_._format,null,c,d,p,x)}catch(W){throw L("error loading",W),W}f&&(_._buffer=null)}else _.delayLoadState=4,_._delayedOnLoad=B,_._delayedOnError=L;return _}return Object.defineProperty(e.prototype,"noMipmap",{get:function(){return this._noMipmap},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"mimeType",{get:function(){return this._mimeType},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"isBlocking",{get:function(){return this._isBlocking},set:function(t){this._isBlocking=t},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"invertY",{get:function(){return this._invertY},enumerable:!1,configurable:!0}),e.prototype.updateURL=function(t,r,n){r===void 0&&(r=null),this.url&&(this.releaseInternalTexture(),this.getScene().markAllMaterialsAsDirty(1)),(!this.name||vt(this.name,"data:"))&&(this.name=t),this.url=t,this._buffer=r,this.delayLoadState=4,n&&(this._delayedOnLoad=n),this.delayLoad()},e.prototype.delayLoad=function(){if(this.delayLoadState===4){var t=this.getScene();!t||(this.delayLoadState=1,this._texture=this._getFromCache(this.url,this._noMipmap,this.samplingMode,this._invertY,this._useSRGBBuffer),this._texture?this._delayedOnLoad&&(this._texture.isReady?qr.SetImmediate(this._delayedOnLoad):this._texture.onLoadedObservable.add(this._delayedOnLoad)):(this._texture=t.getEngine().createTexture(this.url,this._noMipmap,this._invertY,t,this.samplingMode,this._delayedOnLoad,this._delayedOnError,this._buffer,null,this._format,null,this._mimeType,this._loaderOptions,this._creationFlags,this._useSRGBBuffer),this._deleteBuffer&&(this._buffer=null)),this._delayedOnLoad=null,this._delayedOnError=null)}},e.prototype._prepareRowForTextureGeneration=function(t,r,n,a){t*=this._cachedUScale,r*=this._cachedVScale,t-=this.uRotationCenter*this._cachedUScale,r-=this.vRotationCenter*this._cachedVScale,n-=this.wRotationCenter,m.TransformCoordinatesFromFloatsToRef(t,r,n,this._rowGenerationMatrix,a),a.x+=this.uRotationCenter*this._cachedUScale+this._cachedUOffset,a.y+=this.vRotationCenter*this._cachedVScale+this._cachedVOffset,a.z+=this.wRotationCenter},e.prototype.checkTransformsAreIdentical=function(t){return t!==null&&this.uOffset===t.uOffset&&this.vOffset===t.vOffset&&this.uScale===t.uScale&&this.vScale===t.vScale&&this.uAng===t.uAng&&this.vAng===t.vAng&&this.wAng===t.wAng},e.prototype.getTextureMatrix=function(t){var r=this;if(t===void 0&&(t=1),this.uOffset===this._cachedUOffset&&this.vOffset===this._cachedVOffset&&this.uScale*t===this._cachedUScale&&this.vScale===this._cachedVScale&&this.uAng===this._cachedUAng&&this.vAng===this._cachedVAng&&this.wAng===this._cachedWAng&&this.uRotationCenter===this._cachedURotationCenter&&this.vRotationCenter===this._cachedVRotationCenter&&this.wRotationCenter===this._cachedWRotationCenter&&this.homogeneousRotationInUVTransform===this._cachedHomogeneousRotationInUVTransform)return this._cachedTextureMatrix;this._cachedUOffset=this.uOffset,this._cachedVOffset=this.vOffset,this._cachedUScale=this.uScale*t,this._cachedVScale=this.vScale,this._cachedUAng=this.uAng,this._cachedVAng=this.vAng,this._cachedWAng=this.wAng,this._cachedURotationCenter=this.uRotationCenter,this._cachedVRotationCenter=this.vRotationCenter,this._cachedWRotationCenter=this.wRotationCenter,this._cachedHomogeneousRotationInUVTransform=this.homogeneousRotationInUVTransform,(!this._cachedTextureMatrix||!this._rowGenerationMatrix)&&(this._cachedTextureMatrix=G.Zero(),this._rowGenerationMatrix=new G,this._t0=m.Zero(),this._t1=m.Zero(),this._t2=m.Zero()),G.RotationYawPitchRollToRef(this.vAng,this.uAng,this.wAng,this._rowGenerationMatrix),this.homogeneousRotationInUVTransform?(G.TranslationToRef(-this._cachedURotationCenter,-this._cachedVRotationCenter,-this._cachedWRotationCenter,U.Matrix[0]),G.TranslationToRef(this._cachedURotationCenter,this._cachedVRotationCenter,this._cachedWRotationCenter,U.Matrix[1]),G.ScalingToRef(this._cachedUScale,this._cachedVScale,0,U.Matrix[2]),G.TranslationToRef(this._cachedUOffset,this._cachedVOffset,0,U.Matrix[3]),U.Matrix[0].multiplyToRef(this._rowGenerationMatrix,this._cachedTextureMatrix),this._cachedTextureMatrix.multiplyToRef(U.Matrix[1],this._cachedTextureMatrix),this._cachedTextureMatrix.multiplyToRef(U.Matrix[2],this._cachedTextureMatrix),this._cachedTextureMatrix.multiplyToRef(U.Matrix[3],this._cachedTextureMatrix),this._cachedTextureMatrix.setRowFromFloats(2,this._cachedTextureMatrix.m[12],this._cachedTextureMatrix.m[13],this._cachedTextureMatrix.m[14],1)):(this._prepareRowForTextureGeneration(0,0,0,this._t0),this._prepareRowForTextureGeneration(1,0,0,this._t1),this._prepareRowForTextureGeneration(0,1,0,this._t2),this._t1.subtractInPlace(this._t0),this._t2.subtractInPlace(this._t0),G.FromValuesToRef(this._t1.x,this._t1.y,this._t1.z,0,this._t2.x,this._t2.y,this._t2.z,0,this._t0.x,this._t0.y,this._t0.z,0,0,0,0,1,this._cachedTextureMatrix));var n=this.getScene();return n?(n.markAllMaterialsAsDirty(1,function(a){return a.hasTexture(r)}),this._cachedTextureMatrix):this._cachedTextureMatrix},e.prototype.getReflectionTextureMatrix=function(){var t=this,r=this.getScene();if(!r)return this._cachedTextureMatrix;if(this.uOffset===this._cachedUOffset&&this.vOffset===this._cachedVOffset&&this.uScale===this._cachedUScale&&this.vScale===this._cachedVScale&&this.coordinatesMode===this._cachedCoordinatesMode)if(this.coordinatesMode===e.PROJECTION_MODE){if(this._cachedProjectionMatrixId===r.getProjectionMatrix().updateFlag)return this._cachedTextureMatrix}else return this._cachedTextureMatrix;this._cachedTextureMatrix||(this._cachedTextureMatrix=G.Zero()),this._projectionModeMatrix||(this._projectionModeMatrix=G.Zero());var n=this._cachedCoordinatesMode!==this.coordinatesMode;switch(this._cachedUOffset=this.uOffset,this._cachedVOffset=this.vOffset,this._cachedUScale=this.uScale,this._cachedVScale=this.vScale,this._cachedCoordinatesMode=this.coordinatesMode,this.coordinatesMode){case e.PLANAR_MODE:{G.IdentityToRef(this._cachedTextureMatrix),this._cachedTextureMatrix[0]=this.uScale,this._cachedTextureMatrix[5]=this.vScale,this._cachedTextureMatrix[12]=this.uOffset,this._cachedTextureMatrix[13]=this.vOffset;break}case e.PROJECTION_MODE:{G.FromValuesToRef(.5,0,0,0,0,-.5,0,0,0,0,0,0,.5,.5,1,1,this._projectionModeMatrix);var a=r.getProjectionMatrix();this._cachedProjectionMatrixId=a.updateFlag,a.multiplyToRef(this._projectionModeMatrix,this._cachedTextureMatrix);break}default:G.IdentityToRef(this._cachedTextureMatrix);break}return n&&r.markAllMaterialsAsDirty(1,function(s){return s.getActiveTextures().indexOf(t)!==-1}),this._cachedTextureMatrix},e.prototype.clone=function(){var t=this,r={noMipmap:this._noMipmap,invertY:this._invertY,samplingMode:this.samplingMode,onLoad:void 0,onError:void 0,buffer:this._texture?this._texture._buffer:void 0,deleteBuffer:this._deleteBuffer,format:this.textureFormat,mimeType:this.mimeType,loaderOptions:this._loaderOptions,creationFlags:this._creationFlags,useSRGBBuffer:this._useSRGBBuffer};return pe.Clone(function(){return new e(t._texture?t._texture.url:null,t.getScene(),r)},this)},e.prototype.serialize=function(){var t=this.name;e.SerializeBuffers||vt(this.name,"data:")&&(this.name=""),vt(this.name,"data:")&&this.url===this.name&&(this.url="");var r=i.prototype.serialize.call(this);return r?((e.SerializeBuffers||e.ForceSerializeBuffers)&&(typeof this._buffer=="string"&&this._buffer.substr(0,5)==="data:"?(r.base64String=this._buffer,r.name=r.name.replace("data:","")):this.url&&vt(this.url,"data:")&&this._buffer instanceof Uint8Array?r.base64String="data:image/png;base64,"+Ji(this._buffer):(e.ForceSerializeBuffers||this.url&&vt(this.url,"blob:")||this._forceSerialize)&&(r.base64String=!this._engine||this._engine._features.supportSyncTextureRead?Ho(this):Xo(this))),r.invertY=this._invertY,r.samplingMode=this.samplingMode,r._creationFlags=this._creationFlags,r._useSRGBBuffer=this._useSRGBBuffer,this.name=t,r):null},e.prototype.getClassName=function(){return"Texture"},e.prototype.dispose=function(){i.prototype.dispose.call(this),this.onLoadObservable.clear(),this._delayedOnLoad=null,this._delayedOnError=null},e.Parse=function(t,r,n){if(t.customType){var a=Xr.Instantiate(t.customType),s=a.Parse(t,r,n);return t.samplingMode&&s.updateSamplingMode&&s._samplingMode&&s._samplingMode!==t.samplingMode&&s.updateSamplingMode(t.samplingMode),s}if(t.isCube&&!t.isRenderTarget)return e._CubeTextureParser(t,r,n);if(!t.name&&!t.isRenderTarget)return null;var o=function(){if(l&&l._texture&&(l._texture._cachedWrapU=null,l._texture._cachedWrapV=null,l._texture._cachedWrapR=null),t.samplingMode){var u=t.samplingMode;l&&l.samplingMode!==u&&l.updateSamplingMode(u)}if(l&&t.animations)for(var f=0;f<t.animations.length;f++){var h=t.animations[f],c=lt("BABYLON.Animation");c&&l.animations.push(c.Parse(h))}},l=pe.Parse(function(){var u,f,h,c=!0;if(t.noMipmap&&(c=!1),t.mirrorPlane){var d=e._CreateMirror(t.name,t.renderTargetSize,r,c);return d._waitingRenderList=t.renderList,d.mirrorPlane=yr.FromArray(t.mirrorPlane),o(),d}else if(t.isRenderTarget){var p=null;if(t.isCube){if(r.reflectionProbes)for(var _=0;_<r.reflectionProbes.length;_++){var g=r.reflectionProbes[_];if(g.name===t.name)return g.cubeTexture}}else p=e._CreateRenderTargetTexture(t.name,t.renderTargetSize,r,c,(u=t._creationFlags)!==null&&u!==void 0?u:0),p._waitingRenderList=t.renderList;return o(),p}else{var v;if(t.base64String)v=e.CreateFromBase64String(t.base64String,t.name,r,!c,t.invertY,t.samplingMode,o,(f=t._creationFlags)!==null&&f!==void 0?f:0,(h=t._useSRGBBuffer)!==null&&h!==void 0?h:!1);else{var y=void 0;t.name&&t.name.indexOf("://")>0?y=t.name:y=n+t.name,(vt(t.url,"data:")||e.UseSerializedUrlIfAny&&t.url)&&(y=t.url),v=new e(y,r,!c,t.invertY,t.samplingMode,o)}return v}},t,r);return l},e.CreateFromBase64String=function(t,r,n,a,s,o,l,u,f,h){return o===void 0&&(o=e.TRILINEAR_SAMPLINGMODE),l===void 0&&(l=null),u===void 0&&(u=null),f===void 0&&(f=5),new e("data:"+r,n,a,s,o,l,u,t,!1,f,void 0,void 0,h)},e.LoadFromDataString=function(t,r,n,a,s,o,l,u,f,h,c){return a===void 0&&(a=!1),o===void 0&&(o=!0),l===void 0&&(l=e.TRILINEAR_SAMPLINGMODE),u===void 0&&(u=null),f===void 0&&(f=null),h===void 0&&(h=5),t.substr(0,5)!=="data:"&&(t="data:"+t),new e(t,n,s,o,l,u,f,r,a,h,void 0,void 0,c)},e.SerializeBuffers=!0,e.ForceSerializeBuffers=!1,e.OnTextureLoadErrorObservable=new X,e._CubeTextureParser=function(t,r,n){throw he("CubeTexture")},e._CreateMirror=function(t,r,n,a){throw he("MirrorTexture")},e._CreateRenderTargetTexture=function(t,r,n,a,s){throw he("RenderTargetTexture")},e.NEAREST_SAMPLINGMODE=1,e.NEAREST_NEAREST_MIPLINEAR=8,e.BILINEAR_SAMPLINGMODE=2,e.LINEAR_LINEAR_MIPNEAREST=11,e.TRILINEAR_SAMPLINGMODE=3,e.LINEAR_LINEAR_MIPLINEAR=3,e.NEAREST_NEAREST_MIPNEAREST=4,e.NEAREST_LINEAR_MIPNEAREST=5,e.NEAREST_LINEAR_MIPLINEAR=6,e.NEAREST_LINEAR=7,e.NEAREST_NEAREST=1,e.LINEAR_NEAREST_MIPNEAREST=9,e.LINEAR_NEAREST_MIPLINEAR=10,e.LINEAR_LINEAR=2,e.LINEAR_NEAREST=12,e.EXPLICIT_MODE=0,e.SPHERICAL_MODE=1,e.PLANAR_MODE=2,e.CUBIC_MODE=3,e.PROJECTION_MODE=4,e.SKYBOX_MODE=5,e.INVCUBIC_MODE=6,e.EQUIRECTANGULAR_MODE=7,e.FIXED_EQUIRECTANGULAR_MODE=8,e.FIXED_EQUIRECTANGULAR_MIRRORED_MODE=9,e.CLAMP_ADDRESSMODE=0,e.WRAP_ADDRESSMODE=1,e.MIRROR_ADDRESSMODE=2,e.UseSerializedUrlIfAny=!1,C([I()],e.prototype,"url",void 0),C([I()],e.prototype,"uOffset",void 0),C([I()],e.prototype,"vOffset",void 0),C([I()],e.prototype,"uScale",void 0),C([I()],e.prototype,"vScale",void 0),C([I()],e.prototype,"uAng",void 0),C([I()],e.prototype,"vAng",void 0),C([I()],e.prototype,"wAng",void 0),C([I()],e.prototype,"uRotationCenter",void 0),C([I()],e.prototype,"vRotationCenter",void 0),C([I()],e.prototype,"wRotationCenter",void 0),C([I()],e.prototype,"homogeneousRotationInUVTransform",void 0),C([I()],e.prototype,"isBlocking",null),e}(bt);We("BABYLON.Texture",re);pe._TextureParser=re.Parse;var Je=function(){function i(e){this.length=0,this.data=new Array(e),this._id=i._GlobalId++}return i.prototype.push=function(e){this.data[this.length++]=e,this.length>this.data.length&&(this.data.length*=2)},i.prototype.forEach=function(e){for(var t=0;t<this.length;t++)e(this.data[t])},i.prototype.sort=function(e){this.data.sort(e)},i.prototype.reset=function(){this.length=0},i.prototype.dispose=function(){this.reset(),this.data&&(this.data.length=0,this.data=[])},i.prototype.concat=function(e){if(e.length!==0){this.length+e.length>this.data.length&&(this.data.length=(this.length+e.length)*2);for(var t=0;t<e.length;t++)this.data[this.length++]=(e.data||e)[t]}},i.prototype.indexOf=function(e){var t=this.data.indexOf(e);return t>=this.length?-1:t},i.prototype.contains=function(e){return this.indexOf(e)!==-1},i._GlobalId=0,i}(),rr=function(i){$(e,i);function e(){var t=i!==null&&i.apply(this,arguments)||this;return t._duplicateId=0,t}return e.prototype.push=function(t){i.prototype.push.call(this,t),t.__smartArrayFlags||(t.__smartArrayFlags={}),t.__smartArrayFlags[this._id]=this._duplicateId},e.prototype.pushNoDuplicate=function(t){return t.__smartArrayFlags&&t.__smartArrayFlags[this._id]===this._duplicateId?!1:(this.push(t),!0)},e.prototype.reset=function(){i.prototype.reset.call(this),this._duplicateId++},e.prototype.concatWithNoDuplicate=function(t){if(t.length!==0){this.length+t.length>this.data.length&&(this.data.length=(this.length+t.length)*2);for(var r=0;r<t.length;r++){var n=(t.data||t)[r];this.pushNoDuplicate(n)}}},e}(Je),Dn=function(i,e){return!i||i.getClassName&&i.getClassName()==="Mesh"?null:i.getClassName&&i.getClassName()==="SubMesh"?i.clone(e):i.clone?i.clone():null};function jo(i){var e=[];do Object.getOwnPropertyNames(i).forEach(function(t){e.indexOf(t)===-1&&e.push(t)});while(i=Object.getPrototypeOf(i));return e}var dt=function(){function i(){}return i.DeepCopy=function(e,t,r,n){for(var a=jo(e),s=0,o=a;s<o.length;s++){var l=o[s];if(!(l[0]==="_"&&(!n||n.indexOf(l)===-1))&&!Ut(l,"Observable")&&!(r&&r.indexOf(l)!==-1)){var u=e[l],f=typeof u;if(f!=="function")try{if(f==="object")if(u instanceof Array){if(t[l]=[],u.length>0)if(typeof u[0]=="object")for(var h=0;h<u.length;h++){var c=Dn(u[h],t);t[l].indexOf(c)===-1&&t[l].push(c)}else t[l]=u.slice(0)}else t[l]=Dn(u,t);else t[l]=u}catch(d){Y.Warn(d.message)}}}},i}(),nt=function(){function i(){}return Object.defineProperty(i,"Now",{get:function(){return Li.IsWindowObjectExist()&&window.performance&&window.performance.now?window.performance.now():Date.now()},enumerable:!1,configurable:!0}),i}(),Pt;(function(i){i[i.Pending=0]="Pending",i[i.Fulfilled=1]="Fulfilled",i[i.Rejected=2]="Rejected"})(Pt||(Pt={}));var Ko=function(){function i(){this.count=0,this.target=0,this.results=[]}return i}(),Yo=function(){function i(e){var t=this;if(this._state=Pt.Pending,this._children=new Array,this._rejectWasConsumed=!1,!!e)try{e(function(r){t._resolve(r)},function(r){t._reject(r)})}catch(r){this._reject(r)}}return Object.defineProperty(i.prototype,"_result",{get:function(){return this._resultValue},set:function(e){this._resultValue=e,this._parent&&this._parent._result===void 0&&(this._parent._result=e)},enumerable:!1,configurable:!0}),i.prototype.catch=function(e){return this.then(void 0,e)},i.prototype.then=function(e,t){var r=this,n=new i;return n._onFulfilled=e,n._onRejected=t,this._children.push(n),n._parent=this,this._state!==Pt.Pending&&setTimeout(function(){r._state===Pt.Fulfilled||r._rejectWasConsumed?n._resolve(r._result):n._reject(r._reason)}),n},i.prototype._moveChildren=function(e){var t,r=this;if((t=this._children).push.apply(t,e.splice(0,e.length)),this._children.forEach(function(u){u._parent=r}),this._state===Pt.Fulfilled)for(var n=0,a=this._children;n<a.length;n++){var s=a[n];s._resolve(this._result)}else if(this._state===Pt.Rejected)for(var o=0,l=this._children;o<l.length;o++){var s=l[o];s._reject(this._reason)}},i.prototype._resolve=function(e){try{this._state=Pt.Fulfilled;var t=null;if(this._onFulfilled&&(t=this._onFulfilled(e)),t!=null)if(t._state!==void 0){var r=t;r._parent=this,r._moveChildren(this._children),e=r._result}else e=t;this._result=e;for(var n=0,a=this._children;n<a.length;n++){var s=a[n];s._resolve(e)}this._children.length=0,delete this._onFulfilled,delete this._onRejected}catch(o){this._reject(o,!0)}},i.prototype._reject=function(e,t){if(t===void 0&&(t=!1),this._state=Pt.Rejected,this._reason=e,this._onRejected&&!t)try{this._onRejected(e),this._rejectWasConsumed=!0}catch(s){e=s}for(var r=0,n=this._children;r<n.length;r++){var a=n[r];this._rejectWasConsumed?a._resolve(null):a._reject(e)}this._children.length=0,delete this._onFulfilled,delete this._onRejected},i.resolve=function(e){var t=new i;return t._resolve(e),t},i._RegisterForFulfillment=function(e,t,r){e.then(function(n){return t.results[r]=n,t.count++,t.count===t.target&&t.rootPromise._resolve(t.results),null},function(n){t.rootPromise._state!==Pt.Rejected&&t.rootPromise._reject(n)})},i.all=function(e){var t=new i,r=new Ko;if(r.target=e.length,r.rootPromise=t,e.length)for(var n=0;n<e.length;n++)i._RegisterForFulfillment(e[n],r,n);else t._resolve([]);return t},i.race=function(e){var t=new i;if(e.length)for(var r=0,n=e;r<n.length;r++){var a=n[r];a.then(function(s){return t&&(t._resolve(s),t=null),null},function(s){t&&(t._reject(s),t=null)})}return t},i}(),qo=function(){function i(){}return i.Apply=function(e){if(e===void 0&&(e=!1),e||typeof Promise=="undefined"){var t=window;t.Promise=Yo}},i}(),te=function(){function i(){}return Object.defineProperty(i,"BaseUrl",{get:function(){return Xe.BaseUrl},set:function(e){Xe.BaseUrl=e},enumerable:!1,configurable:!0}),Object.defineProperty(i,"DefaultRetryStrategy",{get:function(){return Xe.DefaultRetryStrategy},set:function(e){Xe.DefaultRetryStrategy=e},enumerable:!1,configurable:!0}),Object.defineProperty(i,"CorsBehavior",{get:function(){return Xe.CorsBehavior},set:function(e){Xe.CorsBehavior=e},enumerable:!1,configurable:!0}),Object.defineProperty(i,"UseFallbackTexture",{get:function(){return ye.UseFallbackTexture},set:function(e){ye.UseFallbackTexture=e},enumerable:!1,configurable:!0}),Object.defineProperty(i,"RegisteredExternalClasses",{get:function(){return Xr.RegisteredExternalClasses},set:function(e){Xr.RegisteredExternalClasses=e},enumerable:!1,configurable:!0}),Object.defineProperty(i,"fallbackTexture",{get:function(){return ye.FallbackTexture},set:function(e){ye.FallbackTexture=e},enumerable:!1,configurable:!0}),i.FetchToRef=function(e,t,r,n,a,s){var o=Math.abs(e)*r%r|0,l=Math.abs(t)*n%n|0,u=(o+l*r)*4;s.r=a[u]/255,s.g=a[u+1]/255,s.b=a[u+2]/255,s.a=a[u+3]/255},i.Mix=function(e,t,r){return e*(1-r)+t*r},i.Instantiate=function(e){return Xr.Instantiate(e)},i.Slice=function(e,t,r){return Dr.Slice(e,t,r)},i.SliceToArray=function(e,t,r){return Dr.SliceToArray(e,t,r)},i.SetImmediate=function(e){qr.SetImmediate(e)},i.IsExponentOfTwo=function(e){var t=1;do t*=2;while(t<e);return t===e},i.FloatRound=function(e){return Math.fround?Math.fround(e):(i._TmpFloatArray[0]=e,i._TmpFloatArray[0])},i.GetFilename=function(e){var t=e.lastIndexOf("/");return t<0?e:e.substring(t+1)},i.GetFolderPath=function(e,t){t===void 0&&(t=!1);var r=e.lastIndexOf("/");return r<0?t?e:"":e.substring(0,r+1)},i.ToDegrees=function(e){return e*180/Math.PI},i.ToRadians=function(e){return e*Math.PI/180},i.MakeArray=function(e,t){return t!==!0&&(e===void 0||e==null)?null:Array.isArray(e)?e:[e]},i.GetPointerPrefix=function(e){var t="pointer";return ze()&&!window.PointerEvent&&(t="mouse"),e._badDesktopOS&&!e._badOS&&!(document&&"ontouchend"in document)&&(t="mouse"),t},i.SetCorsBehavior=function(e,t){tn(e,t)},i.CleanUrl=function(e){return e=e.replace(/#/gm,"%23"),e},Object.defineProperty(i,"PreprocessUrl",{get:function(){return Xe.PreprocessUrl},set:function(e){Xe.PreprocessUrl=e},enumerable:!1,configurable:!0}),i.LoadImage=function(e,t,r,n,a,s){return Vr(e,t,r,n,a,s)},i.LoadFile=function(e,t,r,n,a,s){return fr(e,t,r,n,a,s)},i.LoadFileAsync=function(e,t){return t===void 0&&(t=!0),new Promise(function(r,n){fr(e,function(a){r(a)},void 0,void 0,t,function(a,s){n(s)})})},i.LoadScript=function(e,t,r,n){if(!!ze()){var a=document.getElementsByTagName("head")[0],s=document.createElement("script");s.setAttribute("type","text/javascript"),s.setAttribute("src",e),n&&(s.id=n),s.onload=function(){t&&t()},s.onerror=function(o){r&&r("Unable to load script '".concat(e,"'"),o)},a.appendChild(s)}},i.LoadScriptAsync=function(e){var t=this;return new Promise(function(r,n){t.LoadScript(e,function(){r()},function(a,s){n(s)})})},i.ReadFileAsDataURL=function(e,t,r){var n=new FileReader,a={onCompleteObservable:new X,abort:function(){return n.abort()}};return n.onloadend=function(){a.onCompleteObservable.notifyObservers(a)},n.onload=function(s){t(s.target.result)},n.onprogress=r,n.readAsDataURL(e),a},i.ReadFile=function(e,t,r,n,a){return Fr(e,t,r,n,a)},i.FileAsURL=function(e){var t=new Blob([e]),r=window.URL||window.webkitURL,n=r.createObjectURL(t);return n},i.Format=function(e,t){return t===void 0&&(t=2),e.toFixed(t)},i.DeepCopy=function(e,t,r,n){dt.DeepCopy(e,t,r,n)},i.IsEmpty=function(e){for(var t in e)if(Object.prototype.hasOwnProperty.call(e,t))return!1;return!0},i.RegisterTopRootEvents=function(e,t){for(var r=0;r<t.length;r++){var n=t[r];e.addEventListener(n.name,n.handler,!1);try{window.parent&&window.parent.addEventListener(n.name,n.handler,!1)}catch{}}},i.UnregisterTopRootEvents=function(e,t){for(var r=0;r<t.length;r++){var n=t[r];e.removeEventListener(n.name,n.handler);try{e.parent&&e.parent.removeEventListener(n.name,n.handler)}catch{}}},i.DumpFramebuffer=function(e,t,r,n,a,s){return a===void 0&&(a="image/png"),qi(this,void 0,void 0,function(){var o,l;return gr(this,function(u){switch(u.label){case 0:return[4,r.readPixels(0,0,e,t)];case 1:return o=u.sent(),l=new Uint8Array(o.buffer),i.DumpData(e,t,l,n,a,s,!0),[2]}})})},i.DumpData=function(e,t,r,n,a,s,o,l,u){a===void 0&&(a="image/png"),o===void 0&&(o=!1),l===void 0&&(l=!1),i._ScreenshotCanvas||(i._ScreenshotCanvas=document.createElement("canvas")),i._ScreenshotCanvas.width=e,i._ScreenshotCanvas.height=t;var f=i._ScreenshotCanvas.getContext("2d");if(f){if(r instanceof Float32Array){for(var h=new Uint8Array(r.length),c=r.length;c--;){var d=r[c];h[c]=d<0?0:d>1?1:Math.round(d*255)}r=h}var p=f.createImageData(e,t),_=p.data;_.set(r),f.putImageData(p,0,0);var g=i._ScreenshotCanvas;if(o){var v=document.createElement("canvas");v.width=e,v.height=t;var y=v.getContext("2d");if(!y)return;y.translate(0,t),y.scale(1,-1),y.drawImage(i._ScreenshotCanvas,0,0),g=v}l?i.ToBlob(g,function(b){var E=new FileReader;E.onload=function(A){var S=A.target.result;n&&n(S)},E.readAsArrayBuffer(b)},a,u):i.EncodeScreenshotCanvasData(n,a,s,g,u)}},i.DumpDataAsync=function(e,t,r,n,a,s,o,l){return n===void 0&&(n="image/png"),s===void 0&&(s=!1),o===void 0&&(o=!1),new Promise(function(u){i.DumpData(e,t,r,function(f){return u(f)},n,a,s,o,l)})},i.ToBlob=function(e,t,r,n){r===void 0&&(r="image/png"),e.toBlob||(e.toBlob=function(a,s,o){var l=this;setTimeout(function(){for(var u=atob(l.toDataURL(s,o).split(",")[1]),f=u.length,h=new Uint8Array(f),c=0;c<f;c++)h[c]=u.charCodeAt(c);a(new Blob([h]))})}),e.toBlob(function(a){t(a)},r,n)},i.EncodeScreenshotCanvasData=function(e,t,r,n,a){if(t===void 0&&(t="image/png"),e){var s=(n!=null?n:i._ScreenshotCanvas).toDataURL(t,a);e(s)}else this.ToBlob(n!=null?n:i._ScreenshotCanvas,function(o){if("download"in document.createElement("a")){if(!r){var l=new Date,u=(l.getFullYear()+"-"+(l.getMonth()+1)).slice(2)+"-"+l.getDate()+"_"+l.getHours()+"-"+("0"+l.getMinutes()).slice(-2);r="screenshot_"+u+".png"}i.Download(o,r)}else if(o){var f=URL.createObjectURL(o),h=window.open("");if(!h)return;var c=h.document.createElement("img");c.onload=function(){URL.revokeObjectURL(f)},c.src=f,h.document.body.appendChild(c)}},t,a)},i.Download=function(e,t){if(navigator&&navigator.msSaveBlob){navigator.msSaveBlob(e,t);return}var r=window.URL.createObjectURL(e),n=document.createElement("a");document.body.appendChild(n),n.style.display="none",n.href=r,n.download=t,n.addEventListener("click",function(){n.parentElement&&n.parentElement.removeChild(n)}),n.click(),window.URL.revokeObjectURL(r)},i.BackCompatCameraNoPreventDefault=function(e){return typeof e[0]=="boolean"?e[0]:typeof e[1]=="boolean"?e[1]:!1},i.CreateScreenshot=function(e,t,r,n,a){throw he("ScreenshotTools")},i.CreateScreenshotAsync=function(e,t,r,n){throw he("ScreenshotTools")},i.CreateScreenshotUsingRenderTarget=function(e,t,r,n,a,s,o,l){throw he("ScreenshotTools")},i.CreateScreenshotUsingRenderTargetAsync=function(e,t,r,n,a,s,o){throw he("ScreenshotTools")},i.RandomId=function(){return Zi()},i.IsBase64=function(e){return ni(e)},i.DecodeBase64=function(e){return nn(e)},Object.defineProperty(i,"errorsCount",{get:function(){return Y.errorsCount},enumerable:!1,configurable:!0}),i.Log=function(e){Y.Log(e)},i.Warn=function(e){Y.Warn(e)},i.Error=function(e){Y.Error(e)},Object.defineProperty(i,"LogCache",{get:function(){return Y.LogCache},enumerable:!1,configurable:!0}),i.ClearLogCache=function(){Y.ClearLogCache()},Object.defineProperty(i,"LogLevels",{set:function(e){Y.LogLevels=e},enumerable:!1,configurable:!0}),Object.defineProperty(i,"PerformanceLogLevel",{set:function(e){if((e&i.PerformanceUserMarkLogLevel)===i.PerformanceUserMarkLogLevel){i.StartPerformanceCounter=i._StartUserMark,i.EndPerformanceCounter=i._EndUserMark;return}if((e&i.PerformanceConsoleLogLevel)===i.PerformanceConsoleLogLevel){i.StartPerformanceCounter=i._StartPerformanceConsole,i.EndPerformanceCounter=i._EndPerformanceConsole;return}i.StartPerformanceCounter=i._StartPerformanceCounterDisabled,i.EndPerformanceCounter=i._EndPerformanceCounterDisabled},enumerable:!1,configurable:!0}),i._StartPerformanceCounterDisabled=function(e,t){},i._EndPerformanceCounterDisabled=function(e,t){},i._StartUserMark=function(e,t){if(t===void 0&&(t=!0),!i._Performance){if(!ze())return;i._Performance=window.performance}!t||!i._Performance.mark||i._Performance.mark(e+"-Begin")},i._EndUserMark=function(e,t){t===void 0&&(t=!0),!(!t||!i._Performance.mark)&&(i._Performance.mark(e+"-End"),i._Performance.measure(e,e+"-Begin",e+"-End"))},i._StartPerformanceConsole=function(e,t){t===void 0&&(t=!0),t&&(i._StartUserMark(e,t),console.time&&console.time(e))},i._EndPerformanceConsole=function(e,t){t===void 0&&(t=!0),t&&(i._EndUserMark(e,t),console.timeEnd(e))},Object.defineProperty(i,"Now",{get:function(){return nt.Now},enumerable:!1,configurable:!0}),i.GetClassName=function(e,t){t===void 0&&(t=!1);var r=null;if(!t&&e.getClassName)r=e.getClassName();else{if(e instanceof Object){var n=t?e:Object.getPrototypeOf(e);r=n.constructor.__bjsclassName__}r||(r=typeof e)}return r},i.First=function(e,t){for(var r=0,n=e;r<n.length;r++){var a=n[r];if(t(a))return a}return null},i.getFullClassName=function(e,t){t===void 0&&(t=!1);var r=null,n=null;if(!t&&e.getClassName)r=e.getClassName();else{if(e instanceof Object){var a=t?e:Object.getPrototypeOf(e);r=a.constructor.__bjsclassName__,n=a.constructor.__bjsmoduleName__}r||(r=typeof e)}return r?(n!=null?n+".":"")+r:null},i.DelayAsync=function(e){return new Promise(function(t){setTimeout(function(){t()},e)})},i.IsSafari=function(){return Oa()?/^((?!chrome|android).)*safari/i.test(navigator.userAgent):!1},i.UseCustomRequestHeaders=!1,i.CustomRequestHeaders=Jt.CustomRequestHeaders,i._TmpFloatArray=new Float32Array(1),i.GetDOMTextContent=$i,i.GetAbsoluteUrl=typeof document=="object"?function(e){var t=document.createElement("a");return t.href=e,t.href}:typeof URL=="function"&&typeof location=="object"?function(e){return new URL(e,location.origin).href}:function(){throw new Error("Unable to get absolute URL. Override BABYLON.Tools.GetAbsoluteUrl to a custom implementation for the current context.")},i.NoneLogLevel=Y.NoneLogLevel,i.MessageLogLevel=Y.MessageLogLevel,i.WarningLogLevel=Y.WarningLogLevel,i.ErrorLogLevel=Y.ErrorLogLevel,i.AllLogLevel=Y.AllLogLevel,i.IsWindowObjectExist=ze,i.PerformanceNoneLogLevel=0,i.PerformanceUserMarkLogLevel=1,i.PerformanceConsoleLogLevel=2,i.StartPerformanceCounter=i._StartPerformanceCounterDisabled,i.EndPerformanceCounter=i._EndPerformanceCounterDisabled,i}(),Zo=function(){function i(e,t,r,n){n===void 0&&(n=0),this.iterations=e,this.index=n-1,this._done=!1,this._fn=t,this._successCallback=r}return i.prototype.executeNext=function(){this._done||(this.index+1<this.iterations?(++this.index,this._fn(this)):this.breakLoop())},i.prototype.breakLoop=function(){this._done=!0,this._successCallback()},i.Run=function(e,t,r,n){n===void 0&&(n=0);var a=new i(e,t,r,n);return a.executeNext(),a},i.SyncAsyncForLoop=function(e,t,r,n,a,s){return s===void 0&&(s=0),i.Run(Math.ceil(e/t),function(o){a&&a()?o.breakLoop():setTimeout(function(){for(var l=0;l<t;++l){var u=o.index*t+l;if(u>=e)break;if(r(u),a&&a()){o.breakLoop();break}}o.executeNext()},s)},n)},i}();ye.FallbackTexture="data:image/jpg;base64,/9j/4AAQSkZJRgABAQEAYABgAAD/4QBmRXhpZgAATU0AKgAAAAgABAEaAAUAAAABAAAAPgEbAAUAAAABAAAARgEoAAMAAAABAAIAAAExAAIAAAAQAAAATgAAAAAAAABgAAAAAQAAAGAAAAABcGFpbnQubmV0IDQuMC41AP/bAEMABAIDAwMCBAMDAwQEBAQFCQYFBQUFCwgIBgkNCw0NDQsMDA4QFBEODxMPDAwSGBITFRYXFxcOERkbGRYaFBYXFv/bAEMBBAQEBQUFCgYGChYPDA8WFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFv/AABEIAQABAAMBIgACEQEDEQH/xAAfAAABBQEBAQEBAQAAAAAAAAAAAQIDBAUGBwgJCgv/xAC1EAACAQMDAgQDBQUEBAAAAX0BAgMABBEFEiExQQYTUWEHInEUMoGRoQgjQrHBFVLR8CQzYnKCCQoWFxgZGiUmJygpKjQ1Njc4OTpDREVGR0hJSlNUVVZXWFlaY2RlZmdoaWpzdHV2d3h5eoOEhYaHiImKkpOUlZaXmJmaoqOkpaanqKmqsrO0tba3uLm6wsPExcbHyMnK0tPU1dbX2Nna4eLj5OXm5+jp6vHy8/T19vf4+fr/xAAfAQADAQEBAQEBAQEBAAAAAAAAAQIDBAUGBwgJCgv/xAC1EQACAQIEBAMEBwUEBAABAncAAQIDEQQFITEGEkFRB2FxEyIygQgUQpGhscEJIzNS8BVictEKFiQ04SXxFxgZGiYnKCkqNTY3ODk6Q0RFRkdISUpTVFVWV1hZWmNkZWZnaGlqc3R1dnd4eXqCg4SFhoeIiYqSk5SVlpeYmZqio6Slpqeoqaqys7S1tre4ubrCw8TFxsfIycrS09TV1tfY2dri4+Tl5ufo6ery8/T19vf4+fr/2gAMAwEAAhEDEQA/APH6KKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FCiiigD6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++gooooA+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gUKKKKAPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76CiiigD5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BQooooA+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/voKKKKAPl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FCiiigD6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++gooooA+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gUKKKKAPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76CiiigD5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BQooooA+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/voKKKKAPl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FCiiigD6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++gooooA+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gUKKKKAPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76P//Z";qo.Apply();var Qo=function(){function i(){this._doNotSerialize=!1,this._isDisposed=!1,this._sceneRootNodesIndex=-1,this._isEnabled=!0,this._isParentEnabled=!0,this._isReady=!0,this._onEnabledStateChangedObservable=new X,this._onClonedObservable=new X}return i}(),ct=function(){function i(e,t){t===void 0&&(t=null),this._isDirty=!1,this._nodeDataStorage=new Qo,this.state="",this.metadata=null,this.reservedDataStore=null,this._parentContainer=null,this.animations=new Array,this._ranges={},this.onReady=null,this._currentRenderId=-1,this._parentUpdateId=-1,this._childUpdateId=-1,this._waitingParentId=null,this._cache={},this._parentNode=null,this._children=null,this._worldMatrix=G.Identity(),this._worldMatrixDeterminant=0,this._worldMatrixDeterminantIsDirty=!0,this._animationPropertiesOverride=null,this._isNode=!0,this.onDisposeObservable=new X,this._onDisposeObserver=null,this._behaviors=new Array,this.name=e,this.id=e,this._scene=t||ye.LastCreatedScene,this.uniqueId=this._scene.getUniqueId(),this._initCache()}return i.AddNodeConstructor=function(e,t){this._NodeConstructors[e]=t},i.Construct=function(e,t,r,n){var a=this._NodeConstructors[e];return a?a(t,r,n):null},Object.defineProperty(i.prototype,"doNotSerialize",{get:function(){return this._nodeDataStorage._doNotSerialize?!0:this._parentNode?this._parentNode.doNotSerialize:!1},set:function(e){this._nodeDataStorage._doNotSerialize=e},enumerable:!1,configurable:!0}),i.prototype.isDisposed=function(){return this._nodeDataStorage._isDisposed},Object.defineProperty(i.prototype,"parent",{get:function(){return this._parentNode},set:function(e){if(this._parentNode!==e){var t=this._parentNode;if(this._parentNode&&this._parentNode._children!==void 0&&this._parentNode._children!==null){var r=this._parentNode._children.indexOf(this);r!==-1&&this._parentNode._children.splice(r,1),!e&&!this._nodeDataStorage._isDisposed&&this._addToSceneRootNodes()}this._parentNode=e,this._parentNode&&((this._parentNode._children===void 0||this._parentNode._children===null)&&(this._parentNode._children=new Array),this._parentNode._children.push(this),t||this._removeFromSceneRootNodes()),this._syncParentEnabledState()}},enumerable:!1,configurable:!0}),i.prototype._addToSceneRootNodes=function(){this._nodeDataStorage._sceneRootNodesIndex===-1&&(this._nodeDataStorage._sceneRootNodesIndex=this._scene.rootNodes.length,this._scene.rootNodes.push(this))},i.prototype._removeFromSceneRootNodes=function(){if(this._nodeDataStorage._sceneRootNodesIndex!==-1){var e=this._scene.rootNodes,t=e.length-1;e[this._nodeDataStorage._sceneRootNodesIndex]=e[t],e[this._nodeDataStorage._sceneRootNodesIndex]._nodeDataStorage._sceneRootNodesIndex=this._nodeDataStorage._sceneRootNodesIndex,this._scene.rootNodes.pop(),this._nodeDataStorage._sceneRootNodesIndex=-1}},Object.defineProperty(i.prototype,"animationPropertiesOverride",{get:function(){return this._animationPropertiesOverride?this._animationPropertiesOverride:this._scene.animationPropertiesOverride},set:function(e){this._animationPropertiesOverride=e},enumerable:!1,configurable:!0}),i.prototype.getClassName=function(){return"Node"},Object.defineProperty(i.prototype,"onDispose",{set:function(e){this._onDisposeObserver&&this.onDisposeObservable.remove(this._onDisposeObserver),this._onDisposeObserver=this.onDisposeObservable.add(e)},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"onEnabledStateChangedObservable",{get:function(){return this._nodeDataStorage._onEnabledStateChangedObservable},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"onClonedObservable",{get:function(){return this._nodeDataStorage._onClonedObservable},enumerable:!1,configurable:!0}),i.prototype.getScene=function(){return this._scene},i.prototype.getEngine=function(){return this._scene.getEngine()},i.prototype.addBehavior=function(e,t){var r=this;t===void 0&&(t=!1);var n=this._behaviors.indexOf(e);return n!==-1?this:(e.init(),this._scene.isLoading&&!t?this._scene.onDataLoadedObservable.addOnce(function(){e.attach(r)}):e.attach(this),this._behaviors.push(e),this)},i.prototype.removeBehavior=function(e){var t=this._behaviors.indexOf(e);return t===-1?this:(this._behaviors[t].detach(),this._behaviors.splice(t,1),this)},Object.defineProperty(i.prototype,"behaviors",{get:function(){return this._behaviors},enumerable:!1,configurable:!0}),i.prototype.getBehaviorByName=function(e){for(var t=0,r=this._behaviors;t<r.length;t++){var n=r[t];if(n.name===e)return n}return null},i.prototype.getWorldMatrix=function(){return this._currentRenderId!==this._scene.getRenderId()&&this.computeWorldMatrix(),this._worldMatrix},i.prototype._getWorldMatrixDeterminant=function(){return this._worldMatrixDeterminantIsDirty&&(this._worldMatrixDeterminantIsDirty=!1,this._worldMatrixDeterminant=this._worldMatrix.determinant()),this._worldMatrixDeterminant},Object.defineProperty(i.prototype,"worldMatrixFromCache",{get:function(){return this._worldMatrix},enumerable:!1,configurable:!0}),i.prototype._initCache=function(){this._cache={},this._cache.parent=void 0},i.prototype.updateCache=function(e){!e&&this.isSynchronized()||(this._cache.parent=this.parent,this._updateCache())},i.prototype._getActionManagerForTrigger=function(e,t){return this.parent?this.parent._getActionManagerForTrigger(e,!1):null},i.prototype._updateCache=function(e){},i.prototype._isSynchronized=function(){return!0},i.prototype._markSyncedWithParent=function(){this._parentNode&&(this._parentUpdateId=this._parentNode._childUpdateId)},i.prototype.isSynchronizedWithParent=function(){return this._parentNode?this._parentNode._isDirty||this._parentUpdateId!==this._parentNode._childUpdateId?!1:this._parentNode.isSynchronized():!0},i.prototype.isSynchronized=function(){return this._cache.parent!==this._parentNode?(this._cache.parent=this._parentNode,!1):this._parentNode&&!this.isSynchronizedWithParent()?!1:this._isSynchronized()},i.prototype.isReady=function(e){return this._nodeDataStorage._isReady},i.prototype.markAsDirty=function(e){return this._currentRenderId=Number.MAX_VALUE,this._isDirty=!0,this},i.prototype.isEnabled=function(e){return e===void 0&&(e=!0),e===!1?this._nodeDataStorage._isEnabled:this._nodeDataStorage._isEnabled?this._nodeDataStorage._isParentEnabled:!1},i.prototype._syncParentEnabledState=function(){this._nodeDataStorage._isParentEnabled=this._parentNode?this._parentNode.isEnabled():!0,this._children&&this._children.forEach(function(e){e._syncParentEnabledState()})},i.prototype.setEnabled=function(e){this._nodeDataStorage._isEnabled!==e&&(this._nodeDataStorage._isEnabled=e,this._nodeDataStorage._onEnabledStateChangedObservable.notifyObservers(e),this._syncParentEnabledState())},i.prototype.isDescendantOf=function(e){return this.parent?this.parent===e?!0:this.parent.isDescendantOf(e):!1},i.prototype._getDescendants=function(e,t,r){if(t===void 0&&(t=!1),!!this._children)for(var n=0;n<this._children.length;n++){var a=this._children[n];(!r||r(a))&&e.push(a),t||a._getDescendants(e,!1,r)}},i.prototype.getDescendants=function(e,t){var r=new Array;return this._getDescendants(r,e,t),r},i.prototype.getChildMeshes=function(e,t){var r=[];return this._getDescendants(r,e,function(n){return(!t||t(n))&&n.cullingStrategy!==void 0}),r},i.prototype.getChildren=function(e,t){return t===void 0&&(t=!0),this.getDescendants(t,e)},i.prototype._setReady=function(e){if(e!==this._nodeDataStorage._isReady){if(!e){this._nodeDataStorage._isReady=!1;return}this.onReady&&this.onReady(this),this._nodeDataStorage._isReady=!0}},i.prototype.getAnimationByName=function(e){for(var t=0;t<this.animations.length;t++){var r=this.animations[t];if(r.name===e)return r}return null},i.prototype.createAnimationRange=function(e,t,r){if(!this._ranges[e]){this._ranges[e]=i._AnimationRangeFactory(e,t,r);for(var n=0,a=this.animations.length;n<a;n++)this.animations[n]&&this.animations[n].createRange(e,t,r)}},i.prototype.deleteAnimationRange=function(e,t){t===void 0&&(t=!0);for(var r=0,n=this.animations.length;r<n;r++)this.animations[r]&&this.animations[r].deleteRange(e,t);this._ranges[e]=null},i.prototype.getAnimationRange=function(e){return this._ranges[e]||null},i.prototype.getAnimationRanges=function(){var e=[],t;for(t in this._ranges)e.push(this._ranges[t]);return e},i.prototype.beginAnimation=function(e,t,r,n){var a=this.getAnimationRange(e);return a?this._scene.beginAnimation(this,a.from,a.to,t,r,n):null},i.prototype.serializeAnimationRanges=function(){var e=[];for(var t in this._ranges){var r=this._ranges[t];if(!!r){var n={};n.name=t,n.from=r.from,n.to=r.to,e.push(n)}}return e},i.prototype.computeWorldMatrix=function(e){return this._worldMatrix||(this._worldMatrix=G.Identity()),this._worldMatrix},i.prototype.dispose=function(e,t){if(t===void 0&&(t=!1),this._nodeDataStorage._isDisposed=!0,!e)for(var r=this.getDescendants(!0),n=0,a=r;n<a.length;n++){var s=a[n];s.dispose(e,t)}this.parent?this.parent=null:this._removeFromSceneRootNodes(),this.onDisposeObservable.notifyObservers(this),this.onDisposeObservable.clear(),this.onEnabledStateChangedObservable.clear(),this.onClonedObservable.clear();for(var o=0,l=this._behaviors;o<l.length;o++){var u=l[o];u.detach()}this._behaviors=[],this.metadata=null},i.ParseAnimationRanges=function(e,t,r){if(t.ranges)for(var n=0;n<t.ranges.length;n++){var a=t.ranges[n];e.createAnimationRange(a.name,a.from,a.to)}},i.prototype.getHierarchyBoundingVectors=function(e,t){e===void 0&&(e=!0),t===void 0&&(t=null),this.getScene().incrementRenderId(),this.computeWorldMatrix(!0);var r,n,a=this;if(a.getBoundingInfo&&a.subMeshes){var s=a.getBoundingInfo();r=s.boundingBox.minimumWorld.clone(),n=s.boundingBox.maximumWorld.clone()}else r=new m(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),n=new m(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE);if(e)for(var o=this.getDescendants(!1),l=0,u=o;l<u.length;l++){var f=u[l],h=f;if(h.computeWorldMatrix(!0),!(t&&!t(h))&&!(!h.getBoundingInfo||h.getTotalVertices()===0)){var c=h.getBoundingInfo(),d=c.boundingBox,p=d.minimumWorld,_=d.maximumWorld;m.CheckExtends(p,r,n),m.CheckExtends(_,r,n)}}return{min:r,max:n}},i._AnimationRangeFactory=function(e,t,r){throw he("AnimationRange")},i._NodeConstructors={},C([I()],i.prototype,"name",void 0),C([I()],i.prototype,"id",void 0),C([I()],i.prototype,"uniqueId",void 0),C([I()],i.prototype,"state",void 0),C([I()],i.prototype,"metadata",void 0),i}(),Va=function(){function i(e,t,r,n){this.x=e,this.y=t,this.width=r,this.height=n}return i.prototype.toGlobal=function(e,t){return new i(this.x*e,this.y*t,this.width*e,this.height*t)},i.prototype.toGlobalToRef=function(e,t,r){return r.x=this.x*e,r.y=this.y*t,r.width=this.width*e,r.height=this.height*t,this},i.prototype.clone=function(){return new i(this.x,this.y,this.width,this.height)},i}(),Qr=function(){function i(){}return i.GetPlanes=function(e){for(var t=[],r=0;r<6;r++)t.push(new yr(0,0,0,0));return i.GetPlanesToRef(e,t),t},i.GetNearPlaneToRef=function(e,t){var r=e.m;t.normal.x=r[3]+r[2],t.normal.y=r[7]+r[6],t.normal.z=r[11]+r[10],t.d=r[15]+r[14],t.normalize()},i.GetFarPlaneToRef=function(e,t){var r=e.m;t.normal.x=r[3]-r[2],t.normal.y=r[7]-r[6],t.normal.z=r[11]-r[10],t.d=r[15]-r[14],t.normalize()},i.GetLeftPlaneToRef=function(e,t){var r=e.m;t.normal.x=r[3]+r[0],t.normal.y=r[7]+r[4],t.normal.z=r[11]+r[8],t.d=r[15]+r[12],t.normalize()},i.GetRightPlaneToRef=function(e,t){var r=e.m;t.normal.x=r[3]-r[0],t.normal.y=r[7]-r[4],t.normal.z=r[11]-r[8],t.d=r[15]-r[12],t.normalize()},i.GetTopPlaneToRef=function(e,t){var r=e.m;t.normal.x=r[3]-r[1],t.normal.y=r[7]-r[5],t.normal.z=r[11]-r[9],t.d=r[15]-r[13],t.normalize()},i.GetBottomPlaneToRef=function(e,t){var r=e.m;t.normal.x=r[3]+r[1],t.normal.y=r[7]+r[5],t.normal.z=r[11]+r[9],t.d=r[15]+r[13],t.normalize()},i.GetPlanesToRef=function(e,t){i.GetNearPlaneToRef(e,t[0]),i.GetFarPlaneToRef(e,t[1]),i.GetLeftPlaneToRef(e,t[2]),i.GetRightPlaneToRef(e,t[3]),i.GetTopPlaneToRef(e,t[4]),i.GetBottomPlaneToRef(e,t[5])},i}(),Ne=function(i){$(e,i);function e(t,r,n,a){a===void 0&&(a=!0);var s=i.call(this,t,n)||this;return s._position=m.Zero(),s._upVector=m.Up(),s.orthoLeft=null,s.orthoRight=null,s.orthoBottom=null,s.orthoTop=null,s.fov=.8,s.projectionPlaneTilt=0,s.minZ=1,s.maxZ=1e4,s.inertia=.9,s.mode=e.PERSPECTIVE_CAMERA,s.isIntermediate=!1,s.viewport=new Va(0,0,1,1),s.layerMask=268435455,s.fovMode=e.FOVMODE_VERTICAL_FIXED,s.cameraRigMode=e.RIG_MODE_NONE,s.customRenderTargets=new Array,s.outputRenderTarget=null,s.onViewMatrixChangedObservable=new X,s.onProjectionMatrixChangedObservable=new X,s.onAfterCheckInputsObservable=new X,s.onRestoreStateObservable=new X,s.isRigCamera=!1,s._rigCameras=new Array,s._webvrViewMatrix=G.Identity(),s._skipRendering=!1,s._projectionMatrix=new G,s._postProcesses=new Array,s._activeMeshes=new Je(256),s._globalPosition=m.Zero(),s._computedViewMatrix=G.Identity(),s._doNotComputeProjectionMatrix=!1,s._transformMatrix=G.Zero(),s._refreshFrustumPlanes=!0,s._absoluteRotation=de.Identity(),s._isCamera=!0,s._isLeftCamera=!1,s._isRightCamera=!1,s.getScene().addCamera(s),a&&!s.getScene().activeCamera&&(s.getScene().activeCamera=s),s.position=r,s.renderPassId=s.getScene().getEngine().createRenderPassId("Camera ".concat(t)),s}return Object.defineProperty(e.prototype,"position",{get:function(){return this._position},set:function(t){this._position=t},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"upVector",{get:function(){return this._upVector},set:function(t){this._upVector=t},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"screenArea",{get:function(){var t,r,n,a,s=0,o=0;if(this.mode===e.PERSPECTIVE_CAMERA)this.fovMode===e.FOVMODE_VERTICAL_FIXED?(o=this.minZ*2*Math.tan(this.fov/2),s=this.getEngine().getAspectRatio(this)*o):(s=this.minZ*2*Math.tan(this.fov/2),o=s/this.getEngine().getAspectRatio(this));else{var l=this.getEngine().getRenderWidth()/2,u=this.getEngine().getRenderHeight()/2;s=((t=this.orthoRight)!==null&&t!==void 0?t:l)-((r=this.orthoLeft)!==null&&r!==void 0?r:-l),o=((n=this.orthoTop)!==null&&n!==void 0?n:u)-((a=this.orthoBottom)!==null&&a!==void 0?a:-u)}return s*o},enumerable:!1,configurable:!0}),e.prototype.storeState=function(){return this._stateStored=!0,this._storedFov=this.fov,this},e.prototype._restoreStateValues=function(){return this._stateStored?(this.fov=this._storedFov,!0):!1},e.prototype.restoreState=function(){return this._restoreStateValues()?(this.onRestoreStateObservable.notifyObservers(this),!0):!1},e.prototype.getClassName=function(){return"Camera"},e.prototype.toString=function(t){var r="Name: "+this.name;if(r+=", type: "+this.getClassName(),this.animations)for(var n=0;n<this.animations.length;n++)r+=", animation[0]: "+this.animations[n].toString(t);return r},e.prototype.applyVerticalCorrection=function(){var t=this.absoluteRotation.toEulerAngles();this.projectionPlaneTilt=this._scene.useRightHandedSystem?-t.x:t.x},Object.defineProperty(e.prototype,"globalPosition",{get:function(){return this._globalPosition},enumerable:!1,configurable:!0}),e.prototype.getActiveMeshes=function(){return this._activeMeshes},e.prototype.isActiveMesh=function(t){return this._activeMeshes.indexOf(t)!==-1},e.prototype.isReady=function(t){if(t===void 0&&(t=!1),t)for(var r=0,n=this._postProcesses;r<n.length;r++){var a=n[r];if(a&&!a.isReady())return!1}return i.prototype.isReady.call(this,t)},e.prototype._initCache=function(){i.prototype._initCache.call(this),this._cache.position=new m(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),this._cache.upVector=new m(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),this._cache.mode=void 0,this._cache.minZ=void 0,this._cache.maxZ=void 0,this._cache.fov=void 0,this._cache.fovMode=void 0,this._cache.aspectRatio=void 0,this._cache.orthoLeft=void 0,this._cache.orthoRight=void 0,this._cache.orthoBottom=void 0,this._cache.orthoTop=void 0,this._cache.renderWidth=void 0,this._cache.renderHeight=void 0},e.prototype._updateCache=function(t){t||i.prototype._updateCache.call(this),this._cache.position.copyFrom(this.position),this._cache.upVector.copyFrom(this.upVector)},e.prototype._isSynchronized=function(){return this._isSynchronizedViewMatrix()&&this._isSynchronizedProjectionMatrix()},e.prototype._isSynchronizedViewMatrix=function(){return i.prototype._isSynchronized.call(this)?this._cache.position.equals(this.position)&&this._cache.upVector.equals(this.upVector)&&this.isSynchronizedWithParent():!1},e.prototype._isSynchronizedProjectionMatrix=function(){var t=this._cache.mode===this.mode&&this._cache.minZ===this.minZ&&this._cache.maxZ===this.maxZ;if(!t)return!1;var r=this.getEngine();return this.mode===e.PERSPECTIVE_CAMERA?t=this._cache.fov===this.fov&&this._cache.fovMode===this.fovMode&&this._cache.aspectRatio===r.getAspectRatio(this)&&this._cache.projectionPlaneTilt===this.projectionPlaneTilt:t=this._cache.orthoLeft===this.orthoLeft&&this._cache.orthoRight===this.orthoRight&&this._cache.orthoBottom===this.orthoBottom&&this._cache.orthoTop===this.orthoTop&&this._cache.renderWidth===r.getRenderWidth()&&this._cache.renderHeight===r.getRenderHeight(),t},e.prototype.attachControl=function(t,r){},e.prototype.detachControl=function(t){},e.prototype.update=function(){this._checkInputs(),this.cameraRigMode!==e.RIG_MODE_NONE&&this._updateRigCameras()},e.prototype._checkInputs=function(){this.onAfterCheckInputsObservable.notifyObservers(this)},Object.defineProperty(e.prototype,"rigCameras",{get:function(){return this._rigCameras},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"rigPostProcess",{get:function(){return this._rigPostProcess},enumerable:!1,configurable:!0}),e.prototype._getFirstPostProcess=function(){for(var t=0;t<this._postProcesses.length;t++)if(this._postProcesses[t]!==null)return this._postProcesses[t];return null},e.prototype._cascadePostProcessesToRigCams=function(){var t=this._getFirstPostProcess();t&&t.markTextureDirty();for(var r=0,n=this._rigCameras.length;r<n;r++){var a=this._rigCameras[r],s=a._rigPostProcess;if(s){var o=s.getEffectName()==="pass";o&&(a.isIntermediate=this._postProcesses.length===0),a._postProcesses=this._postProcesses.slice(0).concat(s),s.markTextureDirty()}else a._postProcesses=this._postProcesses.slice(0)}},e.prototype.attachPostProcess=function(t,r){return r===void 0&&(r=null),!t.isReusable()&&this._postProcesses.indexOf(t)>-1?(Y.Error("You're trying to reuse a post process not defined as reusable."),0):(r==null||r<0?this._postProcesses.push(t):this._postProcesses[r]===null?this._postProcesses[r]=t:this._postProcesses.splice(r,0,t),this._cascadePostProcessesToRigCams(),this._scene.prePassRenderer&&this._scene.prePassRenderer.markAsDirty(),this._postProcesses.indexOf(t))},e.prototype.detachPostProcess=function(t){var r=this._postProcesses.indexOf(t);r!==-1&&(this._postProcesses[r]=null),this._scene.prePassRenderer&&this._scene.prePassRenderer.markAsDirty(),this._cascadePostProcessesToRigCams()},e.prototype.getWorldMatrix=function(){return this._isSynchronizedViewMatrix()?this._worldMatrix:(this.getViewMatrix(),this._worldMatrix)},e.prototype._getViewMatrix=function(){return G.Identity()},e.prototype.getViewMatrix=function(t){return!t&&this._isSynchronizedViewMatrix()?this._computedViewMatrix:(this.updateCache(),this._computedViewMatrix=this._getViewMatrix(),this._currentRenderId=this.getScene().getRenderId(),this._childUpdateId++,this._refreshFrustumPlanes=!0,this._cameraRigParams&&this._cameraRigParams.vrPreViewMatrix&&this._computedViewMatrix.multiplyToRef(this._cameraRigParams.vrPreViewMatrix,this._computedViewMatrix),this.parent&&this.parent.onViewMatrixChangedObservable&&this.parent.onViewMatrixChangedObservable.notifyObservers(this.parent),this.onViewMatrixChangedObservable.notifyObservers(this),this._computedViewMatrix.invertToRef(this._worldMatrix),this._computedViewMatrix)},e.prototype.freezeProjectionMatrix=function(t){this._doNotComputeProjectionMatrix=!0,t!==void 0&&(this._projectionMatrix=t)},e.prototype.unfreezeProjectionMatrix=function(){this._doNotComputeProjectionMatrix=!1},e.prototype.getProjectionMatrix=function(t){var r,n,a,s,o,l,u,f;if(this._doNotComputeProjectionMatrix||!t&&this._isSynchronizedProjectionMatrix())return this._projectionMatrix;this._cache.mode=this.mode,this._cache.minZ=this.minZ,this._cache.maxZ=this.maxZ,this._refreshFrustumPlanes=!0;var h=this.getEngine(),c=this.getScene();if(this.mode===e.PERSPECTIVE_CAMERA){this._cache.fov=this.fov,this._cache.fovMode=this.fovMode,this._cache.aspectRatio=h.getAspectRatio(this),this._cache.projectionPlaneTilt=this.projectionPlaneTilt,this.minZ<=0&&(this.minZ=.1);var d=h.useReverseDepthBuffer,p=void 0;c.useRightHandedSystem?p=G.PerspectiveFovRHToRef:p=G.PerspectiveFovLHToRef,p(this.fov,h.getAspectRatio(this),d?this.maxZ:this.minZ,d?this.minZ:this.maxZ,this._projectionMatrix,this.fovMode===e.FOVMODE_VERTICAL_FIXED,h.isNDCHalfZRange,this.projectionPlaneTilt,h.useReverseDepthBuffer)}else{var _=h.getRenderWidth()/2,g=h.getRenderHeight()/2;c.useRightHandedSystem?G.OrthoOffCenterRHToRef((r=this.orthoLeft)!==null&&r!==void 0?r:-_,(n=this.orthoRight)!==null&&n!==void 0?n:_,(a=this.orthoBottom)!==null&&a!==void 0?a:-g,(s=this.orthoTop)!==null&&s!==void 0?s:g,this.minZ,this.maxZ,this._projectionMatrix,h.isNDCHalfZRange):G.OrthoOffCenterLHToRef((o=this.orthoLeft)!==null&&o!==void 0?o:-_,(l=this.orthoRight)!==null&&l!==void 0?l:_,(u=this.orthoBottom)!==null&&u!==void 0?u:-g,(f=this.orthoTop)!==null&&f!==void 0?f:g,this.minZ,this.maxZ,this._projectionMatrix,h.isNDCHalfZRange),this._cache.orthoLeft=this.orthoLeft,this._cache.orthoRight=this.orthoRight,this._cache.orthoBottom=this.orthoBottom,this._cache.orthoTop=this.orthoTop,this._cache.renderWidth=h.getRenderWidth(),this._cache.renderHeight=h.getRenderHeight()}return this.onProjectionMatrixChangedObservable.notifyObservers(this),this._projectionMatrix},e.prototype.getTransformationMatrix=function(){return this._computedViewMatrix.multiplyToRef(this._projectionMatrix,this._transformMatrix),this._transformMatrix},e.prototype._updateFrustumPlanes=function(){!this._refreshFrustumPlanes||(this.getTransformationMatrix(),this._frustumPlanes?Qr.GetPlanesToRef(this._transformMatrix,this._frustumPlanes):this._frustumPlanes=Qr.GetPlanes(this._transformMatrix),this._refreshFrustumPlanes=!1)},e.prototype.isInFrustum=function(t,r){if(r===void 0&&(r=!1),this._updateFrustumPlanes(),r&&this.rigCameras.length>0){var n=!1;return this.rigCameras.forEach(function(a){a._updateFrustumPlanes(),n=n||t.isInFrustum(a._frustumPlanes)}),n}else return t.isInFrustum(this._frustumPlanes)},e.prototype.isCompletelyInFrustum=function(t){return this._updateFrustumPlanes(),t.isCompletelyInFrustum(this._frustumPlanes)},e.prototype.getForwardRay=function(t,r,n){throw he("Ray")},e.prototype.getForwardRayToRef=function(t,r,n,a){throw he("Ray")},e.prototype.dispose=function(t,r){for(r===void 0&&(r=!1),this.onViewMatrixChangedObservable.clear(),this.onProjectionMatrixChangedObservable.clear(),this.onAfterCheckInputsObservable.clear(),this.onRestoreStateObservable.clear(),this.inputs&&this.inputs.clear(),this.getScene().stopAnimation(this),this.getScene().removeCamera(this);this._rigCameras.length>0;){var n=this._rigCameras.pop();n&&n.dispose()}if(this._parentContainer){var a=this._parentContainer.cameras.indexOf(this);a>-1&&this._parentContainer.cameras.splice(a,1),this._parentContainer=null}if(this._rigPostProcess)this._rigPostProcess.dispose(this),this._rigPostProcess=null,this._postProcesses=[];else if(this.cameraRigMode!==e.RIG_MODE_NONE)this._rigPostProcess=null,this._postProcesses=[];else for(var s=this._postProcesses.length;--s>=0;){var o=this._postProcesses[s];o&&o.dispose(this)}for(var l=this.customRenderTargets.length;--l>=0;)this.customRenderTargets[l].dispose();this.customRenderTargets=[],this._activeMeshes.dispose(),this.getScene().getEngine().releaseRenderPassId(this.renderPassId),i.prototype.dispose.call(this,t,r)},Object.defineProperty(e.prototype,"isLeftCamera",{get:function(){return this._isLeftCamera},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"isRightCamera",{get:function(){return this._isRightCamera},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"leftCamera",{get:function(){return this._rigCameras.length<1?null:this._rigCameras[0]},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"rightCamera",{get:function(){return this._rigCameras.length<2?null:this._rigCameras[1]},enumerable:!1,configurable:!0}),e.prototype.getLeftTarget=function(){return this._rigCameras.length<1?null:this._rigCameras[0].getTarget()},e.prototype.getRightTarget=function(){return this._rigCameras.length<2?null:this._rigCameras[1].getTarget()},e.prototype.setCameraRigMode=function(t,r){if(this.cameraRigMode!==t){for(;this._rigCameras.length>0;){var n=this._rigCameras.pop();n&&n.dispose()}if(this.cameraRigMode=t,this._cameraRigParams={},this._cameraRigParams.interaxialDistance=r.interaxialDistance||.0637,this._cameraRigParams.stereoHalfAngle=te.ToRadians(this._cameraRigParams.interaxialDistance/.0637),this.cameraRigMode!==e.RIG_MODE_NONE){var a=this.createRigCamera(this.name+"_L",0);a&&(a._isLeftCamera=!0);var s=this.createRigCamera(this.name+"_R",1);s&&(s._isRightCamera=!0),a&&s&&(this._rigCameras.push(a),this._rigCameras.push(s))}this._setRigMode(r),this._cascadePostProcessesToRigCams(),this.update()}},e.prototype._setRigMode=function(t){},e.prototype._getVRProjectionMatrix=function(){return G.PerspectiveFovLHToRef(this._cameraRigParams.vrMetrics.aspectRatioFov,this._cameraRigParams.vrMetrics.aspectRatio,this.minZ,this.maxZ,this._cameraRigParams.vrWorkMatrix,!0,this.getEngine().isNDCHalfZRange),this._cameraRigParams.vrWorkMatrix.multiplyToRef(this._cameraRigParams.vrHMatrix,this._projectionMatrix),this._projectionMatrix},e.prototype._updateCameraRotationMatrix=function(){},e.prototype._updateWebVRCameraRotationMatrix=function(){},e.prototype._getWebVRProjectionMatrix=function(){return G.Identity()},e.prototype._getWebVRViewMatrix=function(){return G.Identity()},e.prototype.setCameraRigParameter=function(t,r){this._cameraRigParams||(this._cameraRigParams={}),this._cameraRigParams[t]=r,t==="interaxialDistance"&&(this._cameraRigParams.stereoHalfAngle=te.ToRadians(r/.0637))},e.prototype.createRigCamera=function(t,r){return null},e.prototype._updateRigCameras=function(){for(var t=0;t<this._rigCameras.length;t++)this._rigCameras[t].minZ=this.minZ,this._rigCameras[t].maxZ=this.maxZ,this._rigCameras[t].fov=this.fov,this._rigCameras[t].upVector.copyFrom(this.upVector);this.cameraRigMode===e.RIG_MODE_STEREOSCOPIC_ANAGLYPH&&(this._rigCameras[0].viewport=this._rigCameras[1].viewport=this.viewport)},e.prototype._setupInputs=function(){},e.prototype.serialize=function(){var t=pe.Serialize(this);return t.uniqueId=this.uniqueId,t.type=this.getClassName(),this.parent&&(t.parentId=this.parent.uniqueId),this.inputs&&this.inputs.serialize(t),pe.AppendSerializedAnimations(this,t),t.ranges=this.serializeAnimationRanges(),t.isEnabled=this.isEnabled(),t},e.prototype.clone=function(t){var r=pe.Clone(e.GetConstructorFromName(this.getClassName(),t,this.getScene(),this.interaxialDistance,this.isStereoscopicSideBySide),this);return r.name=t,this.onClonedObservable.notifyObservers(r),r},e.prototype.getDirection=function(t){var r=m.Zero();return this.getDirectionToRef(t,r),r},Object.defineProperty(e.prototype,"absoluteRotation",{get:function(){return this.getWorldMatrix().decompose(void 0,this._absoluteRotation),this._absoluteRotation},enumerable:!1,configurable:!0}),e.prototype.getDirectionToRef=function(t,r){m.TransformNormalToRef(t,this.getWorldMatrix(),r)},e.GetConstructorFromName=function(t,r,n,a,s){a===void 0&&(a=0),s===void 0&&(s=!0);var o=ct.Construct(t,r,n,{interaxial_distance:a,isStereoscopicSideBySide:s});return o||function(){return e._CreateDefaultParsedCamera(r,n)}},e.prototype.computeWorldMatrix=function(){return this.getWorldMatrix()},e.Parse=function(t,r){var n=t.type,a=e.GetConstructorFromName(n,t.name,r,t.interaxial_distance,t.isStereoscopicSideBySide),s=pe.Parse(a,t,r);if(t.parentId!==void 0&&(s._waitingParentId=t.parentId),s.inputs&&(s.inputs.parse(t),s._setupInputs()),t.upVector&&(s.upVector=m.FromArray(t.upVector)),s.setPosition&&(s.position.copyFromFloats(0,0,0),s.setPosition(m.FromArray(t.position))),t.target&&s.setTarget&&s.setTarget(m.FromArray(t.target)),t.cameraRigMode){var o=t.interaxial_distance?{interaxialDistance:t.interaxial_distance}:{};s.setCameraRigMode(t.cameraRigMode,o)}if(t.animations){for(var l=0;l<t.animations.length;l++){var u=t.animations[l],f=lt("BABYLON.Animation");f&&s.animations.push(f.Parse(u))}ct.ParseAnimationRanges(s,t,r)}return t.autoAnimate&&r.beginAnimation(s,t.autoAnimateFrom,t.autoAnimateTo,t.autoAnimateLoop,t.autoAnimateSpeed||1),t.isEnabled!==void 0&&s.setEnabled(t.isEnabled),s},e._CreateDefaultParsedCamera=function(t,r){throw he("UniversalCamera")},e.PERSPECTIVE_CAMERA=0,e.ORTHOGRAPHIC_CAMERA=1,e.FOVMODE_VERTICAL_FIXED=0,e.FOVMODE_HORIZONTAL_FIXED=1,e.RIG_MODE_NONE=0,e.RIG_MODE_STEREOSCOPIC_ANAGLYPH=10,e.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_PARALLEL=11,e.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_CROSSEYED=12,e.RIG_MODE_STEREOSCOPIC_OVERUNDER=13,e.RIG_MODE_STEREOSCOPIC_INTERLACED=14,e.RIG_MODE_VR=20,e.RIG_MODE_WEBVR=21,e.RIG_MODE_CUSTOM=22,e.ForceAttachControlToAlwaysPreventDefault=!1,C([xt("position")],e.prototype,"_position",void 0),C([xt("upVector")],e.prototype,"_upVector",void 0),C([I()],e.prototype,"orthoLeft",void 0),C([I()],e.prototype,"orthoRight",void 0),C([I()],e.prototype,"orthoBottom",void 0),C([I()],e.prototype,"orthoTop",void 0),C([I()],e.prototype,"fov",void 0),C([I()],e.prototype,"projectionPlaneTilt",void 0),C([I()],e.prototype,"minZ",void 0),C([I()],e.prototype,"maxZ",void 0),C([I()],e.prototype,"inertia",void 0),C([I()],e.prototype,"mode",void 0),C([I()],e.prototype,"layerMask",void 0),C([I()],e.prototype,"fovMode",void 0),C([I()],e.prototype,"cameraRigMode",void 0),C([I()],e.prototype,"interaxialDistance",void 0),C([I()],e.prototype,"isStereoscopicSideBySide",void 0),e}(ct),Ni=function(){function i(){this._count=0,this._data={}}return i.prototype.copyFrom=function(e){var t=this;this.clear(),e.forEach(function(r,n){return t.add(r,n)})},i.prototype.get=function(e){var t=this._data[e];if(t!==void 0)return t},i.prototype.getOrAddWithFactory=function(e,t){var r=this.get(e);return r!==void 0||(r=t(e),r&&this.add(e,r)),r},i.prototype.getOrAdd=function(e,t){var r=this.get(e);return r!==void 0?r:(this.add(e,t),t)},i.prototype.contains=function(e){return this._data[e]!==void 0},i.prototype.add=function(e,t){return this._data[e]!==void 0?!1:(this._data[e]=t,++this._count,!0)},i.prototype.set=function(e,t){return this._data[e]===void 0?!1:(this._data[e]=t,!0)},i.prototype.getAndRemove=function(e){var t=this.get(e);return t!==void 0?(delete this._data[e],--this._count,t):null},i.prototype.remove=function(e){return this.contains(e)?(delete this._data[e],--this._count,!0):!1},i.prototype.clear=function(){this._data={},this._count=0},Object.defineProperty(i.prototype,"count",{get:function(){return this._count},enumerable:!1,configurable:!0}),i.prototype.forEach=function(e){for(var t in this._data){var r=this._data[t];e(t,r)}},i.prototype.first=function(e){for(var t in this._data){var r=this._data[t],n=e(t,r);if(n)return n}return null},i}(),$o=function(){function i(){this.rootNodes=new Array,this.cameras=new Array,this.lights=new Array,this.meshes=new Array,this.skeletons=new Array,this.particleSystems=new Array,this.animations=[],this.animationGroups=new Array,this.multiMaterials=new Array,this.materials=new Array,this.morphTargetManagers=new Array,this.geometries=new Array,this.transformNodes=new Array,this.actionManagers=new Array,this.textures=new Array,this._environmentTexture=null,this.postProcesses=new Array}return i.AddParser=function(e,t){this._BabylonFileParsers[e]=t},i.GetParser=function(e){return this._BabylonFileParsers[e]?this._BabylonFileParsers[e]:null},i.AddIndividualParser=function(e,t){this._IndividualBabylonFileParsers[e]=t},i.GetIndividualParser=function(e){return this._IndividualBabylonFileParsers[e]?this._IndividualBabylonFileParsers[e]:null},i.Parse=function(e,t,r,n){for(var a in this._BabylonFileParsers)Object.prototype.hasOwnProperty.call(this._BabylonFileParsers,a)&&this._BabylonFileParsers[a](e,t,r,n)},Object.defineProperty(i.prototype,"environmentTexture",{get:function(){return this._environmentTexture},set:function(e){this._environmentTexture=e},enumerable:!1,configurable:!0}),i.prototype.getNodes=function(){var e=new Array;return e=e.concat(this.meshes),e=e.concat(this.lights),e=e.concat(this.cameras),e=e.concat(this.transformNodes),this.skeletons.forEach(function(t){return e=e.concat(t.bones)}),e},i._BabylonFileParsers={},i._IndividualBabylonFileParsers={},i}(),ai=function(){function i(e){if(this._isDirty=!0,this._areLightsDirty=!0,this._areLightsDisposed=!1,this._areAttributesDirty=!0,this._areTexturesDirty=!0,this._areFresnelDirty=!0,this._areMiscDirty=!0,this._arePrePassDirty=!0,this._areImageProcessingDirty=!0,this._normals=!1,this._uvs=!1,this._needNormals=!1,this._needUVs=!1,this._externalProperties=e,e)for(var t in e)Object.prototype.hasOwnProperty.call(e,t)&&this._setDefaultValue(t)}return Object.defineProperty(i.prototype,"isDirty",{get:function(){return this._isDirty},enumerable:!1,configurable:!0}),i.prototype.markAsProcessed=function(){this._isDirty=!1,this._areAttributesDirty=!1,this._areTexturesDirty=!1,this._areFresnelDirty=!1,this._areLightsDirty=!1,this._areLightsDisposed=!1,this._areMiscDirty=!1,this._arePrePassDirty=!1,this._areImageProcessingDirty=!1},i.prototype.markAsUnprocessed=function(){this._isDirty=!0},i.prototype.markAllAsDirty=function(){this._areTexturesDirty=!0,this._areAttributesDirty=!0,this._areLightsDirty=!0,this._areFresnelDirty=!0,this._areMiscDirty=!0,this._areImageProcessingDirty=!0,this._isDirty=!0},i.prototype.markAsImageProcessingDirty=function(){this._areImageProcessingDirty=!0,this._isDirty=!0},i.prototype.markAsLightDirty=function(e){e===void 0&&(e=!1),this._areLightsDirty=!0,this._areLightsDisposed=this._areLightsDisposed||e,this._isDirty=!0},i.prototype.markAsAttributesDirty=function(){this._areAttributesDirty=!0,this._isDirty=!0},i.prototype.markAsTexturesDirty=function(){this._areTexturesDirty=!0,this._isDirty=!0},i.prototype.markAsFresnelDirty=function(){this._areFresnelDirty=!0,this._isDirty=!0},i.prototype.markAsMiscDirty=function(){this._areMiscDirty=!0,this._isDirty=!0},i.prototype.markAsPrePassDirty=function(){this._arePrePassDirty=!0,this._isDirty=!0},i.prototype.rebuild=function(){this._keys=[];for(var e=0,t=Object.keys(this);e<t.length;e++){var r=t[e];r[0]!=="_"&&this._keys.push(r)}if(this._externalProperties)for(var n in this._externalProperties)this._keys.indexOf(n)===-1&&this._keys.push(n)},i.prototype.isEqual=function(e){if(this._keys.length!==e._keys.length)return!1;for(var t=0;t<this._keys.length;t++){var r=this._keys[t];if(this[r]!==e[r])return!1}return!0},i.prototype.cloneTo=function(e){this._keys.length!==e._keys.length&&(e._keys=this._keys.slice(0));for(var t=0;t<this._keys.length;t++){var r=this._keys[t];e[r]=this[r]}},i.prototype.reset=function(){var e=this;this._keys.forEach(function(t){return e._setDefaultValue(t)})},i.prototype._setDefaultValue=function(e){var t,r,n,a,s,o=(n=(r=(t=this._externalProperties)===null||t===void 0?void 0:t[e])===null||r===void 0?void 0:r.type)!==null&&n!==void 0?n:typeof this[e],l=(s=(a=this._externalProperties)===null||a===void 0?void 0:a[e])===null||s===void 0?void 0:s.default;switch(o){case"number":this[e]=l!=null?l:0;break;case"string":this[e]=l!=null?l:"";break;default:this[e]=l!=null?l:!1;break}},i.prototype.toString=function(){for(var e="",t=0;t<this._keys.length;t++){var r=this._keys[t],n=this[r],a=typeof n;switch(a){case"number":case"string":e+="#define "+r+" "+n+`
`;break;default:n&&(e+="#define "+r+`
`);break}}return e},i}(),jr=function(){function i(){this._dirty=!0,this._tempColor=new ce(0,0,0,0),this._globalCurve=new ce(0,0,0,0),this._highlightsCurve=new ce(0,0,0,0),this._midtonesCurve=new ce(0,0,0,0),this._shadowsCurve=new ce(0,0,0,0),this._positiveCurve=new ce(0,0,0,0),this._negativeCurve=new ce(0,0,0,0),this._globalHue=30,this._globalDensity=0,this._globalSaturation=0,this._globalExposure=0,this._highlightsHue=30,this._highlightsDensity=0,this._highlightsSaturation=0,this._highlightsExposure=0,this._midtonesHue=30,this._midtonesDensity=0,this._midtonesSaturation=0,this._midtonesExposure=0,this._shadowsHue=30,this._shadowsDensity=0,this._shadowsSaturation=0,this._shadowsExposure=0}return Object.defineProperty(i.prototype,"globalHue",{get:function(){return this._globalHue},set:function(e){this._globalHue=e,this._dirty=!0},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"globalDensity",{get:function(){return this._globalDensity},set:function(e){this._globalDensity=e,this._dirty=!0},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"globalSaturation",{get:function(){return this._globalSaturation},set:function(e){this._globalSaturation=e,this._dirty=!0},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"globalExposure",{get:function(){return this._globalExposure},set:function(e){this._globalExposure=e,this._dirty=!0},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"highlightsHue",{get:function(){return this._highlightsHue},set:function(e){this._highlightsHue=e,this._dirty=!0},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"highlightsDensity",{get:function(){return this._highlightsDensity},set:function(e){this._highlightsDensity=e,this._dirty=!0},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"highlightsSaturation",{get:function(){return this._highlightsSaturation},set:function(e){this._highlightsSaturation=e,this._dirty=!0},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"highlightsExposure",{get:function(){return this._highlightsExposure},set:function(e){this._highlightsExposure=e,this._dirty=!0},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"midtonesHue",{get:function(){return this._midtonesHue},set:function(e){this._midtonesHue=e,this._dirty=!0},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"midtonesDensity",{get:function(){return this._midtonesDensity},set:function(e){this._midtonesDensity=e,this._dirty=!0},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"midtonesSaturation",{get:function(){return this._midtonesSaturation},set:function(e){this._midtonesSaturation=e,this._dirty=!0},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"midtonesExposure",{get:function(){return this._midtonesExposure},set:function(e){this._midtonesExposure=e,this._dirty=!0},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"shadowsHue",{get:function(){return this._shadowsHue},set:function(e){this._shadowsHue=e,this._dirty=!0},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"shadowsDensity",{get:function(){return this._shadowsDensity},set:function(e){this._shadowsDensity=e,this._dirty=!0},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"shadowsSaturation",{get:function(){return this._shadowsSaturation},set:function(e){this._shadowsSaturation=e,this._dirty=!0},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"shadowsExposure",{get:function(){return this._shadowsExposure},set:function(e){this._shadowsExposure=e,this._dirty=!0},enumerable:!1,configurable:!0}),i.prototype.getClassName=function(){return"ColorCurves"},i.Bind=function(e,t,r,n,a){r===void 0&&(r="vCameraColorCurvePositive"),n===void 0&&(n="vCameraColorCurveNeutral"),a===void 0&&(a="vCameraColorCurveNegative"),e._dirty&&(e._dirty=!1,e._getColorGradingDataToRef(e._globalHue,e._globalDensity,e._globalSaturation,e._globalExposure,e._globalCurve),e._getColorGradingDataToRef(e._highlightsHue,e._highlightsDensity,e._highlightsSaturation,e._highlightsExposure,e._tempColor),e._tempColor.multiplyToRef(e._globalCurve,e._highlightsCurve),e._getColorGradingDataToRef(e._midtonesHue,e._midtonesDensity,e._midtonesSaturation,e._midtonesExposure,e._tempColor),e._tempColor.multiplyToRef(e._globalCurve,e._midtonesCurve),e._getColorGradingDataToRef(e._shadowsHue,e._shadowsDensity,e._shadowsSaturation,e._shadowsExposure,e._tempColor),e._tempColor.multiplyToRef(e._globalCurve,e._shadowsCurve),e._highlightsCurve.subtractToRef(e._midtonesCurve,e._positiveCurve),e._midtonesCurve.subtractToRef(e._shadowsCurve,e._negativeCurve)),t&&(t.setFloat4(r,e._positiveCurve.r,e._positiveCurve.g,e._positiveCurve.b,e._positiveCurve.a),t.setFloat4(n,e._midtonesCurve.r,e._midtonesCurve.g,e._midtonesCurve.b,e._midtonesCurve.a),t.setFloat4(a,e._negativeCurve.r,e._negativeCurve.g,e._negativeCurve.b,e._negativeCurve.a))},i.PrepareUniforms=function(e){e.push("vCameraColorCurveNeutral","vCameraColorCurvePositive","vCameraColorCurveNegative")},i.prototype._getColorGradingDataToRef=function(e,t,r,n,a){e!=null&&(e=i._Clamp(e,0,360),t=i._Clamp(t,-100,100),r=i._Clamp(r,-100,100),n=i._Clamp(n,-100,100),t=i._ApplyColorGradingSliderNonlinear(t),t*=.5,n=i._ApplyColorGradingSliderNonlinear(n),t<0&&(t*=-1,e=(e+180)%360),i._FromHSBToRef(e,t,50+.25*n,a),a.scaleToRef(2,a),a.a=1+.01*r)},i._ApplyColorGradingSliderNonlinear=function(e){e/=100;var t=Math.abs(e);return t=Math.pow(t,2),e<0&&(t*=-1),t*=100,t},i._FromHSBToRef=function(e,t,r,n){var a=i._Clamp(e,0,360),s=i._Clamp(t/100,0,1),o=i._Clamp(r/100,0,1);if(s===0)n.r=o,n.g=o,n.b=o;else{a/=60;var l=Math.floor(a),u=a-l,f=o*(1-s),h=o*(1-s*u),c=o*(1-s*(1-u));switch(l){case 0:n.r=o,n.g=c,n.b=f;break;case 1:n.r=h,n.g=o,n.b=f;break;case 2:n.r=f,n.g=o,n.b=c;break;case 3:n.r=f,n.g=h,n.b=o;break;case 4:n.r=c,n.g=f,n.b=o;break;default:n.r=o,n.g=f,n.b=h;break}}n.a=1},i._Clamp=function(e,t,r){return Math.min(Math.max(e,t),r)},i.prototype.clone=function(){return pe.Clone(function(){return new i},this)},i.prototype.serialize=function(){return pe.Serialize(this)},i.Parse=function(e){return pe.Parse(function(){return new i},e,null,null)},C([I()],i.prototype,"_globalHue",void 0),C([I()],i.prototype,"_globalDensity",void 0),C([I()],i.prototype,"_globalSaturation",void 0),C([I()],i.prototype,"_globalExposure",void 0),C([I()],i.prototype,"_highlightsHue",void 0),C([I()],i.prototype,"_highlightsDensity",void 0),C([I()],i.prototype,"_highlightsSaturation",void 0),C([I()],i.prototype,"_highlightsExposure",void 0),C([I()],i.prototype,"_midtonesHue",void 0),C([I()],i.prototype,"_midtonesDensity",void 0),C([I()],i.prototype,"_midtonesSaturation",void 0),C([I()],i.prototype,"_midtonesExposure",void 0),i}();pe._ColorCurvesParser=jr.Parse;var Jo=function(i){$(e,i);function e(){var t=i.call(this)||this;return t.IMAGEPROCESSING=!1,t.VIGNETTE=!1,t.VIGNETTEBLENDMODEMULTIPLY=!1,t.VIGNETTEBLENDMODEOPAQUE=!1,t.TONEMAPPING=!1,t.TONEMAPPING_ACES=!1,t.CONTRAST=!1,t.COLORCURVES=!1,t.COLORGRADING=!1,t.COLORGRADING3D=!1,t.SAMPLER3DGREENDEPTH=!1,t.SAMPLER3DBGRMAP=!1,t.IMAGEPROCESSINGPOSTPROCESS=!1,t.EXPOSURE=!1,t.SKIPFINALCOLORCLAMP=!1,t.rebuild(),t}return e}(ai),Tt=function(){function i(){this.colorCurves=new jr,this._colorCurvesEnabled=!1,this._colorGradingEnabled=!1,this._colorGradingWithGreenDepth=!0,this._colorGradingBGR=!0,this._exposure=1,this._toneMappingEnabled=!1,this._toneMappingType=i.TONEMAPPING_STANDARD,this._contrast=1,this.vignetteStretch=0,this.vignetteCentreX=0,this.vignetteCentreY=0,this.vignetteWeight=1.5,this.vignetteColor=new ce(0,0,0,0),this.vignetteCameraFov=.5,this._vignetteBlendMode=i.VIGNETTEMODE_MULTIPLY,this._vignetteEnabled=!1,this._skipFinalColorClamp=!1,this._applyByPostProcess=!1,this._isEnabled=!0,this.onUpdateParameters=new X}return Object.defineProperty(i.prototype,"colorCurvesEnabled",{get:function(){return this._colorCurvesEnabled},set:function(e){this._colorCurvesEnabled!==e&&(this._colorCurvesEnabled=e,this._updateParameters())},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"colorGradingTexture",{get:function(){return this._colorGradingTexture},set:function(e){this._colorGradingTexture!==e&&(this._colorGradingTexture=e,this._updateParameters())},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"colorGradingEnabled",{get:function(){return this._colorGradingEnabled},set:function(e){this._colorGradingEnabled!==e&&(this._colorGradingEnabled=e,this._updateParameters())},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"colorGradingWithGreenDepth",{get:function(){return this._colorGradingWithGreenDepth},set:function(e){this._colorGradingWithGreenDepth!==e&&(this._colorGradingWithGreenDepth=e,this._updateParameters())},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"colorGradingBGR",{get:function(){return this._colorGradingBGR},set:function(e){this._colorGradingBGR!==e&&(this._colorGradingBGR=e,this._updateParameters())},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"exposure",{get:function(){return this._exposure},set:function(e){this._exposure!==e&&(this._exposure=e,this._updateParameters())},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"toneMappingEnabled",{get:function(){return this._toneMappingEnabled},set:function(e){this._toneMappingEnabled!==e&&(this._toneMappingEnabled=e,this._updateParameters())},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"toneMappingType",{get:function(){return this._toneMappingType},set:function(e){this._toneMappingType!==e&&(this._toneMappingType=e,this._updateParameters())},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"contrast",{get:function(){return this._contrast},set:function(e){this._contrast!==e&&(this._contrast=e,this._updateParameters())},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"vignetteBlendMode",{get:function(){return this._vignetteBlendMode},set:function(e){this._vignetteBlendMode!==e&&(this._vignetteBlendMode=e,this._updateParameters())},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"vignetteEnabled",{get:function(){return this._vignetteEnabled},set:function(e){this._vignetteEnabled!==e&&(this._vignetteEnabled=e,this._updateParameters())},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"skipFinalColorClamp",{get:function(){return this._skipFinalColorClamp},set:function(e){this._skipFinalColorClamp!==e&&(this._skipFinalColorClamp=e,this._updateParameters())},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"applyByPostProcess",{get:function(){return this._applyByPostProcess},set:function(e){this._applyByPostProcess!==e&&(this._applyByPostProcess=e,this._updateParameters())},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"isEnabled",{get:function(){return this._isEnabled},set:function(e){this._isEnabled!==e&&(this._isEnabled=e,this._updateParameters())},enumerable:!1,configurable:!0}),i.prototype._updateParameters=function(){this.onUpdateParameters.notifyObservers(this)},i.prototype.getClassName=function(){return"ImageProcessingConfiguration"},i.PrepareUniforms=function(e,t){t.EXPOSURE&&e.push("exposureLinear"),t.CONTRAST&&e.push("contrast"),t.COLORGRADING&&e.push("colorTransformSettings"),t.VIGNETTE&&(e.push("vInverseScreenSize"),e.push("vignetteSettings1"),e.push("vignetteSettings2")),t.COLORCURVES&&jr.PrepareUniforms(e)},i.PrepareSamplers=function(e,t){t.COLORGRADING&&e.push("txColorTransform")},i.prototype.prepareDefines=function(e,t){if(t===void 0&&(t=!1),t!==this.applyByPostProcess||!this._isEnabled){e.VIGNETTE=!1,e.TONEMAPPING=!1,e.TONEMAPPING_ACES=!1,e.CONTRAST=!1,e.EXPOSURE=!1,e.COLORCURVES=!1,e.COLORGRADING=!1,e.COLORGRADING3D=!1,e.IMAGEPROCESSING=!1,e.SKIPFINALCOLORCLAMP=this.skipFinalColorClamp,e.IMAGEPROCESSINGPOSTPROCESS=this.applyByPostProcess&&this._isEnabled;return}switch(e.VIGNETTE=this.vignetteEnabled,e.VIGNETTEBLENDMODEMULTIPLY=this.vignetteBlendMode===i._VIGNETTEMODE_MULTIPLY,e.VIGNETTEBLENDMODEOPAQUE=!e.VIGNETTEBLENDMODEMULTIPLY,e.TONEMAPPING=this.toneMappingEnabled,this._toneMappingType){case i.TONEMAPPING_ACES:e.TONEMAPPING_ACES=!0;break;default:e.TONEMAPPING_ACES=!1;break}e.CONTRAST=this.contrast!==1,e.EXPOSURE=this.exposure!==1,e.COLORCURVES=this.colorCurvesEnabled&&!!this.colorCurves,e.COLORGRADING=this.colorGradingEnabled&&!!this.colorGradingTexture,e.COLORGRADING?e.COLORGRADING3D=this.colorGradingTexture.is3D:e.COLORGRADING3D=!1,e.SAMPLER3DGREENDEPTH=this.colorGradingWithGreenDepth,e.SAMPLER3DBGRMAP=this.colorGradingBGR,e.IMAGEPROCESSINGPOSTPROCESS=this.applyByPostProcess,e.SKIPFINALCOLORCLAMP=this.skipFinalColorClamp,e.IMAGEPROCESSING=e.VIGNETTE||e.TONEMAPPING||e.CONTRAST||e.EXPOSURE||e.COLORCURVES||e.COLORGRADING},i.prototype.isReady=function(){return!this.colorGradingEnabled||!this.colorGradingTexture||this.colorGradingTexture.isReady()},i.prototype.bind=function(e,t){if(this._colorCurvesEnabled&&this.colorCurves&&jr.Bind(this.colorCurves,e),this._vignetteEnabled){var r=1/e.getEngine().getRenderWidth(),n=1/e.getEngine().getRenderHeight();e.setFloat2("vInverseScreenSize",r,n);var a=t!=null?t:n/r,s=Math.tan(this.vignetteCameraFov*.5),o=s*a,l=Math.sqrt(o*s);o=te.Mix(o,l,this.vignetteStretch),s=te.Mix(s,l,this.vignetteStretch),e.setFloat4("vignetteSettings1",o,s,-o*this.vignetteCentreX,-s*this.vignetteCentreY);var u=-2*this.vignetteWeight;e.setFloat4("vignetteSettings2",this.vignetteColor.r,this.vignetteColor.g,this.vignetteColor.b,u)}if(e.setFloat("exposureLinear",this.exposure),e.setFloat("contrast",this.contrast),this.colorGradingTexture){e.setTexture("txColorTransform",this.colorGradingTexture);var f=this.colorGradingTexture.getSize().height;e.setFloat4("colorTransformSettings",(f-1)/f,.5/f,f,this.colorGradingTexture.level)}},i.prototype.clone=function(){return pe.Clone(function(){return new i},this)},i.prototype.serialize=function(){return pe.Serialize(this)},i.Parse=function(e){return pe.Parse(function(){return new i},e,null,null)},Object.defineProperty(i,"VIGNETTEMODE_MULTIPLY",{get:function(){return this._VIGNETTEMODE_MULTIPLY},enumerable:!1,configurable:!0}),Object.defineProperty(i,"VIGNETTEMODE_OPAQUE",{get:function(){return this._VIGNETTEMODE_OPAQUE},enumerable:!1,configurable:!0}),i.TONEMAPPING_STANDARD=0,i.TONEMAPPING_ACES=1,i._VIGNETTEMODE_MULTIPLY=0,i._VIGNETTEMODE_OPAQUE=1,C([vo()],i.prototype,"colorCurves",void 0),C([I()],i.prototype,"_colorCurvesEnabled",void 0),C([ot("colorGradingTexture")],i.prototype,"_colorGradingTexture",void 0),C([I()],i.prototype,"_colorGradingEnabled",void 0),C([I()],i.prototype,"_colorGradingWithGreenDepth",void 0),C([I()],i.prototype,"_colorGradingBGR",void 0),C([I()],i.prototype,"_exposure",void 0),C([I()],i.prototype,"_toneMappingEnabled",void 0),C([I()],i.prototype,"_toneMappingType",void 0),C([I()],i.prototype,"_contrast",void 0),C([I()],i.prototype,"vignetteStretch",void 0),C([I()],i.prototype,"vignetteCentreX",void 0),C([I()],i.prototype,"vignetteCentreY",void 0),C([I()],i.prototype,"vignetteWeight",void 0),C([Ca()],i.prototype,"vignetteColor",void 0),C([I()],i.prototype,"vignetteCameraFov",void 0),C([I()],i.prototype,"_vignetteBlendMode",void 0),C([I()],i.prototype,"_vignetteEnabled",void 0),C([I()],i.prototype,"_skipFinalColorClamp",void 0),C([I()],i.prototype,"_applyByPostProcess",void 0),C([I()],i.prototype,"_isEnabled",void 0),i}();pe._ImageProcessingConfigurationParser=Tt.Parse;ge.prototype.createUniformBuffer=function(i){var e=this._gl.createBuffer();if(!e)throw new Error("Unable to create uniform buffer");var t=new Ir(e);return this.bindUniformBuffer(t),i instanceof Float32Array?this._gl.bufferData(this._gl.UNIFORM_BUFFER,i,this._gl.STATIC_DRAW):this._gl.bufferData(this._gl.UNIFORM_BUFFER,new Float32Array(i),this._gl.STATIC_DRAW),this.bindUniformBuffer(null),t.references=1,t};ge.prototype.createDynamicUniformBuffer=function(i){var e=this._gl.createBuffer();if(!e)throw new Error("Unable to create dynamic uniform buffer");var t=new Ir(e);return this.bindUniformBuffer(t),i instanceof Float32Array?this._gl.bufferData(this._gl.UNIFORM_BUFFER,i,this._gl.DYNAMIC_DRAW):this._gl.bufferData(this._gl.UNIFORM_BUFFER,new Float32Array(i),this._gl.DYNAMIC_DRAW),this.bindUniformBuffer(null),t.references=1,t};ge.prototype.updateUniformBuffer=function(i,e,t,r){this.bindUniformBuffer(i),t===void 0&&(t=0),r===void 0?e instanceof Float32Array?this._gl.bufferSubData(this._gl.UNIFORM_BUFFER,t,e):this._gl.bufferSubData(this._gl.UNIFORM_BUFFER,t,new Float32Array(e)):e instanceof Float32Array?this._gl.bufferSubData(this._gl.UNIFORM_BUFFER,0,e.subarray(t,t+r)):this._gl.bufferSubData(this._gl.UNIFORM_BUFFER,0,new Float32Array(e).subarray(t,t+r)),this.bindUniformBuffer(null)};ge.prototype.bindUniformBuffer=function(i){this._gl.bindBuffer(this._gl.UNIFORM_BUFFER,i?i.underlyingResource:null)};ge.prototype.bindUniformBufferBase=function(i,e,t){this._gl.bindBufferBase(this._gl.UNIFORM_BUFFER,e,i?i.underlyingResource:null)};ge.prototype.bindUniformBlock=function(i,e,t){var r=i.program,n=this._gl.getUniformBlockIndex(r,e);n!==4294967295&&this._gl.uniformBlockBinding(r,n,t)};var si=function(){function i(e,t,r,n,a){a===void 0&&(a=!1),this._valueCache={},this._engine=e,this._noUBO=!e.supportsUniformBuffers||a,this._dynamic=r,this._name=n!=null?n:"no-name",this._data=t||[],this._uniformLocations={},this._uniformSizes={},this._uniformArraySizes={},this._uniformLocationPointer=0,this._needSync=!1,this._engine._features.trackUbosInFrame&&(this._buffers=[],this._bufferIndex=-1,this._createBufferOnWrite=!1,this._currentFrameId=0),this._noUBO?(this.updateMatrix3x3=this._updateMatrix3x3ForEffect,this.updateMatrix2x2=this._updateMatrix2x2ForEffect,this.updateFloat=this._updateFloatForEffect,this.updateFloat2=this._updateFloat2ForEffect,this.updateFloat3=this._updateFloat3ForEffect,this.updateFloat4=this._updateFloat4ForEffect,this.updateFloatArray=this._updateFloatArrayForEffect,this.updateArray=this._updateArrayForEffect,this.updateIntArray=this._updateIntArrayForEffect,this.updateMatrix=this._updateMatrixForEffect,this.updateMatrices=this._updateMatricesForEffect,this.updateVector3=this._updateVector3ForEffect,this.updateVector4=this._updateVector4ForEffect,this.updateColor3=this._updateColor3ForEffect,this.updateColor4=this._updateColor4ForEffect,this.updateDirectColor4=this._updateDirectColor4ForEffect,this.updateInt=this._updateIntForEffect,this.updateInt2=this._updateInt2ForEffect,this.updateInt3=this._updateInt3ForEffect,this.updateInt4=this._updateInt4ForEffect):(this._engine._uniformBuffers.push(this),this.updateMatrix3x3=this._updateMatrix3x3ForUniform,this.updateMatrix2x2=this._updateMatrix2x2ForUniform,this.updateFloat=this._updateFloatForUniform,this.updateFloat2=this._updateFloat2ForUniform,this.updateFloat3=this._updateFloat3ForUniform,this.updateFloat4=this._updateFloat4ForUniform,this.updateFloatArray=this._updateFloatArrayForUniform,this.updateArray=this._updateArrayForUniform,this.updateIntArray=this._updateIntArrayForUniform,this.updateMatrix=this._updateMatrixForUniform,this.updateMatrices=this._updateMatricesForUniform,this.updateVector3=this._updateVector3ForUniform,this.updateVector4=this._updateVector4ForUniform,this.updateColor3=this._updateColor3ForUniform,this.updateColor4=this._updateColor4ForUniform,this.updateDirectColor4=this._updateDirectColor4ForUniform,this.updateInt=this._updateIntForUniform,this.updateInt2=this._updateInt2ForUniform,this.updateInt3=this._updateInt3ForUniform,this.updateInt4=this._updateInt4ForUniform)}return Object.defineProperty(i.prototype,"useUbo",{get:function(){return!this._noUBO},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"isSync",{get:function(){return!this._needSync},enumerable:!1,configurable:!0}),i.prototype.isDynamic=function(){return this._dynamic!==void 0},i.prototype.getData=function(){return this._bufferData},i.prototype.getBuffer=function(){return this._buffer},i.prototype._fillAlignment=function(e){var t;if(e<=2?t=e:t=4,this._uniformLocationPointer%t!==0){var r=this._uniformLocationPointer;this._uniformLocationPointer+=t-this._uniformLocationPointer%t;for(var n=this._uniformLocationPointer-r,a=0;a<n;a++)this._data.push(0)}},i.prototype.addUniform=function(e,t,r){if(r===void 0&&(r=0),!this._noUBO&&this._uniformLocations[e]===void 0){var n;if(r>0){if(t instanceof Array)throw"addUniform should not be use with Array in UBO: "+e;if(this._fillAlignment(4),this._uniformArraySizes[e]={strideSize:t,arraySize:r},t==16)t=t*r;else{var a=4-t,s=a*r;t=t*r+s}n=[];for(var o=0;o<t;o++)n.push(0)}else{if(t instanceof Array)n=t,t=n.length;else{t=t,n=[];for(var o=0;o<t;o++)n.push(0)}this._fillAlignment(t)}this._uniformSizes[e]=t,this._uniformLocations[e]=this._uniformLocationPointer,this._uniformLocationPointer+=t;for(var o=0;o<t;o++)this._data.push(n[o]);this._needSync=!0}},i.prototype.addMatrix=function(e,t){this.addUniform(e,Array.prototype.slice.call(t.toArray()))},i.prototype.addFloat2=function(e,t,r){var n=[t,r];this.addUniform(e,n)},i.prototype.addFloat3=function(e,t,r,n){var a=[t,r,n];this.addUniform(e,a)},i.prototype.addColor3=function(e,t){var r=[t.r,t.g,t.b];this.addUniform(e,r)},i.prototype.addColor4=function(e,t,r){var n=[t.r,t.g,t.b,r];this.addUniform(e,n)},i.prototype.addVector3=function(e,t){var r=[t.x,t.y,t.z];this.addUniform(e,r)},i.prototype.addMatrix3x3=function(e){this.addUniform(e,12)},i.prototype.addMatrix2x2=function(e){this.addUniform(e,8)},i.prototype.create=function(){this._noUBO||this._buffer||(this._fillAlignment(4),this._bufferData=new Float32Array(this._data),this._rebuild(),this._needSync=!0)},i.prototype._rebuild=function(){this._noUBO||!this._bufferData||(this._dynamic?this._buffer=this._engine.createDynamicUniformBuffer(this._bufferData):this._buffer=this._engine.createUniformBuffer(this._bufferData),this._engine._features.trackUbosInFrame&&(this._buffers.push([this._buffer,this._engine._features.checkUbosContentBeforeUpload?this._bufferData.slice():void 0]),this._bufferIndex=this._buffers.length-1,this._createBufferOnWrite=!1))},Object.defineProperty(i.prototype,"_numBuffers",{get:function(){return this._buffers.length},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"_indexBuffer",{get:function(){return this._bufferIndex},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"name",{get:function(){return this._name},enumerable:!1,configurable:!0}),i.prototype._buffersEqual=function(e,t){for(var r=0;r<e.length;++r)if(e[r]!==t[r])return!1;return!0},i.prototype._copyBuffer=function(e,t){for(var r=0;r<e.length;++r)t[r]=e[r]},i.prototype.update=function(){if(!this._noUBO){if(this.bindUniformBuffer(),!this._buffer){this.create();return}if(!this._dynamic&&!this._needSync){this._createBufferOnWrite=this._engine._features.trackUbosInFrame;return}if(this._buffers&&this._buffers.length>1&&this._buffers[this._bufferIndex][1])if(this._buffersEqual(this._bufferData,this._buffers[this._bufferIndex][1])){this._needSync=!1,this._createBufferOnWrite=this._engine._features.trackUbosInFrame;return}else this._copyBuffer(this._bufferData,this._buffers[this._bufferIndex][1]);this._engine.updateUniformBuffer(this._buffer,this._bufferData),this._engine._features._collectUbosUpdatedInFrame&&(i._UpdatedUbosInFrame[this._name]||(i._UpdatedUbosInFrame[this._name]=0),i._UpdatedUbosInFrame[this._name]++),this._needSync=!1,this._createBufferOnWrite=this._engine._features.trackUbosInFrame}},i.prototype._createNewBuffer=function(){this._bufferIndex+1<this._buffers.length?(this._bufferIndex++,this._buffer=this._buffers[this._bufferIndex][0],this._createBufferOnWrite=!1,this._needSync=!0):this._rebuild()},i.prototype._checkNewFrame=function(){this._engine._features.trackUbosInFrame&&this._currentFrameId!==this._engine.frameId&&(this._currentFrameId=this._engine.frameId,this._createBufferOnWrite=!1,this._buffers&&this._buffers.length>0?(this._needSync=this._bufferIndex!==0,this._bufferIndex=0,this._buffer=this._buffers[this._bufferIndex][0]):this._bufferIndex=-1)},i.prototype.updateUniform=function(e,t,r){this._checkNewFrame();var n=this._uniformLocations[e];if(n===void 0){if(this._buffer){Y.Error("Cannot add an uniform after UBO has been created.");return}this.addUniform(e,r),n=this._uniformLocations[e]}if(this._buffer||this.create(),this._dynamic)for(var s=0;s<r;s++)this._bufferData[n+s]=t[s];else{for(var a=!1,s=0;s<r;s++)(r===16&&!this._engine._features.uniformBufferHardCheckMatrix||this._bufferData[n+s]!==te.FloatRound(t[s]))&&(a=!0,this._createBufferOnWrite&&this._createNewBuffer(),this._bufferData[n+s]=t[s]);this._needSync=this._needSync||a}},i.prototype.updateUniformArray=function(e,t,r){this._checkNewFrame();var n=this._uniformLocations[e];if(n===void 0){Y.Error("Cannot add an uniform Array dynamically. Please, add it using addUniform.");return}this._buffer||this.create();var a=this._uniformArraySizes[e];if(this._dynamic)for(var u=0;u<r;u++)this._bufferData[n+u]=t[u];else{for(var s=!1,o=0,l=0,u=0;u<r;u++)if(this._bufferData[n+l*4+o]!==te.FloatRound(t[u])&&(s=!0,this._createBufferOnWrite&&this._createNewBuffer(),this._bufferData[n+l*4+o]=t[u]),o++,o===a.strideSize){for(;o<4;o++)this._bufferData[n+l*4+o]=0;o=0,l++}this._needSync=this._needSync||s}},i.prototype._cacheMatrix=function(e,t){this._checkNewFrame();var r=this._valueCache[e],n=t.updateFlag;return r!==void 0&&r===n?!1:(this._valueCache[e]=n,!0)},i.prototype._updateMatrix3x3ForUniform=function(e,t){for(var r=0;r<3;r++)i._TempBuffer[r*4]=t[r*3],i._TempBuffer[r*4+1]=t[r*3+1],i._TempBuffer[r*4+2]=t[r*3+2],i._TempBuffer[r*4+3]=0;this.updateUniform(e,i._TempBuffer,12)},i.prototype._updateMatrix3x3ForEffect=function(e,t){this._currentEffect.setMatrix3x3(e,t)},i.prototype._updateMatrix2x2ForEffect=function(e,t){this._currentEffect.setMatrix2x2(e,t)},i.prototype._updateMatrix2x2ForUniform=function(e,t){for(var r=0;r<2;r++)i._TempBuffer[r*4]=t[r*2],i._TempBuffer[r*4+1]=t[r*2+1],i._TempBuffer[r*4+2]=0,i._TempBuffer[r*4+3]=0;this.updateUniform(e,i._TempBuffer,8)},i.prototype._updateFloatForEffect=function(e,t){this._currentEffect.setFloat(e,t)},i.prototype._updateFloatForUniform=function(e,t){i._TempBuffer[0]=t,this.updateUniform(e,i._TempBuffer,1)},i.prototype._updateFloat2ForEffect=function(e,t,r,n){n===void 0&&(n=""),this._currentEffect.setFloat2(e+n,t,r)},i.prototype._updateFloat2ForUniform=function(e,t,r){i._TempBuffer[0]=t,i._TempBuffer[1]=r,this.updateUniform(e,i._TempBuffer,2)},i.prototype._updateFloat3ForEffect=function(e,t,r,n,a){a===void 0&&(a=""),this._currentEffect.setFloat3(e+a,t,r,n)},i.prototype._updateFloat3ForUniform=function(e,t,r,n){i._TempBuffer[0]=t,i._TempBuffer[1]=r,i._TempBuffer[2]=n,this.updateUniform(e,i._TempBuffer,3)},i.prototype._updateFloat4ForEffect=function(e,t,r,n,a,s){s===void 0&&(s=""),this._currentEffect.setFloat4(e+s,t,r,n,a)},i.prototype._updateFloat4ForUniform=function(e,t,r,n,a){i._TempBuffer[0]=t,i._TempBuffer[1]=r,i._TempBuffer[2]=n,i._TempBuffer[3]=a,this.updateUniform(e,i._TempBuffer,4)},i.prototype._updateFloatArrayForEffect=function(e,t){this._currentEffect.setFloatArray(e,t)},i.prototype._updateFloatArrayForUniform=function(e,t){this.updateUniformArray(e,t,t.length)},i.prototype._updateArrayForEffect=function(e,t){this._currentEffect.setArray(e,t)},i.prototype._updateArrayForUniform=function(e,t){this.updateUniformArray(e,t,t.length)},i.prototype._updateIntArrayForEffect=function(e,t){this._currentEffect.setIntArray(e,t)},i.prototype._updateIntArrayForUniform=function(e,t){i._TempBufferInt32View.set(t),this.updateUniformArray(e,i._TempBuffer,t.length)},i.prototype._updateMatrixForEffect=function(e,t){this._currentEffect.setMatrix(e,t)},i.prototype._updateMatrixForUniform=function(e,t){this._cacheMatrix(e,t)&&this.updateUniform(e,t.toArray(),16)},i.prototype._updateMatricesForEffect=function(e,t){this._currentEffect.setMatrices(e,t)},i.prototype._updateMatricesForUniform=function(e,t){this.updateUniform(e,t,t.length)},i.prototype._updateVector3ForEffect=function(e,t){this._currentEffect.setVector3(e,t)},i.prototype._updateVector3ForUniform=function(e,t){i._TempBuffer[0]=t.x,i._TempBuffer[1]=t.y,i._TempBuffer[2]=t.z,this.updateUniform(e,i._TempBuffer,3)},i.prototype._updateVector4ForEffect=function(e,t){this._currentEffect.setVector4(e,t)},i.prototype._updateVector4ForUniform=function(e,t){i._TempBuffer[0]=t.x,i._TempBuffer[1]=t.y,i._TempBuffer[2]=t.z,i._TempBuffer[3]=t.w,this.updateUniform(e,i._TempBuffer,4)},i.prototype._updateColor3ForEffect=function(e,t,r){r===void 0&&(r=""),this._currentEffect.setColor3(e+r,t)},i.prototype._updateColor3ForUniform=function(e,t){i._TempBuffer[0]=t.r,i._TempBuffer[1]=t.g,i._TempBuffer[2]=t.b,this.updateUniform(e,i._TempBuffer,3)},i.prototype._updateColor4ForEffect=function(e,t,r,n){n===void 0&&(n=""),this._currentEffect.setColor4(e+n,t,r)},i.prototype._updateDirectColor4ForEffect=function(e,t,r){r===void 0&&(r=""),this._currentEffect.setDirectColor4(e+r,t)},i.prototype._updateColor4ForUniform=function(e,t,r){i._TempBuffer[0]=t.r,i._TempBuffer[1]=t.g,i._TempBuffer[2]=t.b,i._TempBuffer[3]=r,this.updateUniform(e,i._TempBuffer,4)},i.prototype._updateDirectColor4ForUniform=function(e,t){i._TempBuffer[0]=t.r,i._TempBuffer[1]=t.g,i._TempBuffer[2]=t.b,i._TempBuffer[3]=t.a,this.updateUniform(e,i._TempBuffer,4)},i.prototype._updateIntForEffect=function(e,t,r){r===void 0&&(r=""),this._currentEffect.setInt(e+r,t)},i.prototype._updateIntForUniform=function(e,t){i._TempBufferInt32View[0]=t,this.updateUniform(e,i._TempBuffer,1)},i.prototype._updateInt2ForEffect=function(e,t,r,n){n===void 0&&(n=""),this._currentEffect.setInt2(e+n,t,r)},i.prototype._updateInt2ForUniform=function(e,t,r){i._TempBufferInt32View[0]=t,i._TempBufferInt32View[1]=r,this.updateUniform(e,i._TempBuffer,2)},i.prototype._updateInt3ForEffect=function(e,t,r,n,a){a===void 0&&(a=""),this._currentEffect.setInt3(e+a,t,r,n)},i.prototype._updateInt3ForUniform=function(e,t,r,n){i._TempBufferInt32View[0]=t,i._TempBufferInt32View[1]=r,i._TempBufferInt32View[2]=n,this.updateUniform(e,i._TempBuffer,3)},i.prototype._updateInt4ForEffect=function(e,t,r,n,a,s){s===void 0&&(s=""),this._currentEffect.setInt4(e+s,t,r,n,a)},i.prototype._updateInt4ForUniform=function(e,t,r,n,a){i._TempBufferInt32View[0]=t,i._TempBufferInt32View[1]=r,i._TempBufferInt32View[2]=n,i._TempBufferInt32View[3]=a,this.updateUniform(e,i._TempBuffer,4)},i.prototype.setTexture=function(e,t){this._currentEffect.setTexture(e,t)},i.prototype.updateUniformDirectly=function(e,t){this.updateUniform(e,t,t.length),this.update()},i.prototype.bindToEffect=function(e,t){this._currentEffect=e,this._currentEffectName=t},i.prototype.bindUniformBuffer=function(){!this._noUBO&&this._buffer&&this._currentEffect&&this._currentEffect.bindUniformBuffer(this._buffer,this._currentEffectName)},i.prototype.unbindEffect=function(){this._currentEffect=void 0,this._currentEffectName=void 0},i.prototype.setDataBuffer=function(e){if(!this._buffers)return this._buffer===e;for(var t=0;t<this._buffers.length;++t){var r=this._buffers[t];if(r[0]===e)return this._bufferIndex=t,this._buffer=e,this._createBufferOnWrite=!1,this._currentEffect=void 0,!0}return!1},i.prototype.dispose=function(){if(!this._noUBO){var e=this._engine._uniformBuffers,t=e.indexOf(this);if(t!==-1&&(e[t]=e[e.length-1],e.pop()),this._engine._features.trackUbosInFrame&&this._buffers)for(var r=0;r<this._buffers.length;++r){var n=this._buffers[r][0];this._engine._releaseBuffer(n)}else this._buffer&&this._engine._releaseBuffer(this._buffer)&&(this._buffer=null)}},i._UpdatedUbosInFrame={},i._MAX_UNIFORM_SIZE=256,i._TempBuffer=new Float32Array(i._MAX_UNIFORM_SIZE),i._TempBufferInt32View=new Uint32Array(i._TempBuffer.buffer),i}(),Et=function(){function i(){this._pickingUnavailable=!1,this.hit=!1,this.distance=0,this.pickedPoint=null,this.pickedMesh=null,this.bu=0,this.bv=0,this.faceId=-1,this.subMeshFaceId=-1,this.subMeshId=0,this.pickedSprite=null,this.thinInstanceIndex=-1,this.ray=null,this.originMesh=null,this.aimTransform=null,this.gripTransform=null}return i.prototype.getNormal=function(e,t){if(e===void 0&&(e=!1),t===void 0&&(t=!0),!this.pickedMesh||!this.pickedMesh.isVerticesDataPresent(R.NormalKind))return null;var r=this.pickedMesh.getIndices();if(!r)return null;var n;if(t){var a=this.pickedMesh.getVerticesData(R.NormalKind),s=m.FromArray(a,r[this.faceId*3]*3),o=m.FromArray(a,r[this.faceId*3+1]*3),l=m.FromArray(a,r[this.faceId*3+2]*3);s=s.scale(this.bu),o=o.scale(this.bv),l=l.scale(1-this.bu-this.bv),n=new m(s.x+o.x+l.x,s.y+o.y+l.y,s.z+o.z+l.z)}else{var u=this.pickedMesh.getVerticesData(R.PositionKind),f=m.FromArray(u,r[this.faceId*3]*3),h=m.FromArray(u,r[this.faceId*3+1]*3),c=m.FromArray(u,r[this.faceId*3+2]*3),d=f.subtract(h),p=c.subtract(h);n=m.Cross(d,p)}if(e){var _=this.pickedMesh.getWorldMatrix();this.pickedMesh.nonUniformScaling&&(U.Matrix[0].copyFrom(_),_=U.Matrix[0],_.setTranslationFromFloats(0,0,0),_.invert(),_.transposeToRef(U.Matrix[1]),_=U.Matrix[1]),n=m.TransformNormal(n,_)}return n.normalize(),n},i.prototype.getTextureCoordinates=function(){if(!this.pickedMesh||!this.pickedMesh.isVerticesDataPresent(R.UVKind))return null;var e=this.pickedMesh.getIndices();if(!e)return null;var t=this.pickedMesh.getVerticesData(R.UVKind);if(!t)return null;var r=se.FromArray(t,e[this.faceId*3]*2),n=se.FromArray(t,e[this.faceId*3+1]*2),a=se.FromArray(t,e[this.faceId*3+2]*2);return r=r.scale(this.bu),n=n.scale(this.bv),a=a.scale(1-this.bu-this.bv),new se(r.x+n.x+a.x,r.y+n.y+a.y)},i}(),tt=function(){function i(e,t,r,n,a,s){this.source=e,this.pointerX=t,this.pointerY=r,this.meshUnderPointer=n,this.sourceEvent=a,this.additionalData=s}return i.CreateNew=function(e,t,r){var n=e.getScene();return new i(e,n.pointerX,n.pointerY,n.meshUnderPointer||e,t,r)},i.CreateNewFromSprite=function(e,t,r,n){return new i(e,t.pointerX,t.pointerY,t.meshUnderPointer,r,n)},i.CreateNewFromScene=function(e,t){return new i(null,e.pointerX,e.pointerY,e.meshUnderPointer,t)},i.CreateNewFromPrimitive=function(e,t,r,n){return new i(e,t.x,t.y,null,r,n)},i}(),$r=function(){function i(e){this._vertexBuffers={},this._scene=e}return i.prototype._prepareBuffers=function(){if(!this._vertexBuffers[R.PositionKind]){var e=[];e.push(1,1),e.push(-1,1),e.push(-1,-1),e.push(1,-1),this._vertexBuffers[R.PositionKind]=new R(this._scene.getEngine(),e,R.PositionKind,!1,!1,2),this._buildIndexBuffer()}},i.prototype._buildIndexBuffer=function(){var e=[];e.push(0),e.push(1),e.push(2),e.push(0),e.push(2),e.push(3),this._indexBuffer=this._scene.getEngine().createIndexBuffer(e)},i.prototype._rebuild=function(){var e=this._vertexBuffers[R.PositionKind];!e||(e._rebuild(),this._buildIndexBuffer())},i.prototype._prepareFrame=function(e,t){e===void 0&&(e=null),t===void 0&&(t=null);var r=this._scene.activeCamera;return!r||(t=t||r._postProcesses.filter(function(n){return n!=null}),!t||t.length===0||!this._scene.postProcessesEnabled)?!1:(t[0].activate(r,e,t!=null),!0)},i.prototype.directRender=function(e,t,r,n,a,s){var o;t===void 0&&(t=null),r===void 0&&(r=!1),n===void 0&&(n=0),a===void 0&&(a=0),s===void 0&&(s=!1);for(var l=this._scene.getEngine(),u=0;u<e.length;u++){u<e.length-1?e[u+1].activate(this._scene.activeCamera,t==null?void 0:t.texture):(t?l.bindFramebuffer(t,n,void 0,void 0,r,a):s||l.restoreDefaultFramebuffer(),(o=l._debugInsertMarker)===null||o===void 0||o.call(l,"post process ".concat(e[u].name," output")));var f=e[u],h=f.apply();h&&(f.onBeforeRenderObservable.notifyObservers(h),this._prepareBuffers(),l.bindBuffers(this._vertexBuffers,this._indexBuffer,h),l.drawElementsType(0,0,6),f.onAfterRenderObservable.notifyObservers(h))}l.setDepthBuffer(!0),l.setDepthWrite(!0)},i.prototype._finalizeFrame=function(e,t,r,n,a){var s;a===void 0&&(a=!1);var o=this._scene.activeCamera;if(!!o&&(n=n||o._postProcesses.filter(function(d){return d!=null}),!(n.length===0||!this._scene.postProcessesEnabled))){for(var l=this._scene.getEngine(),u=0,f=n.length;u<f;u++){var h=n[u];if(u<f-1?h._outputTexture=n[u+1].activate(o,t==null?void 0:t.texture):(t?(l.bindFramebuffer(t,r,void 0,void 0,a),h._outputTexture=t):(l.restoreDefaultFramebuffer(),h._outputTexture=null),(s=l._debugInsertMarker)===null||s===void 0||s.call(l,"post process ".concat(n[u].name," output"))),e)break;var c=h.apply();c&&(h.onBeforeRenderObservable.notifyObservers(c),this._prepareBuffers(),l.bindBuffers(this._vertexBuffers,this._indexBuffer,c),l.drawElementsType(0,0,6),h.onAfterRenderObservable.notifyObservers(c))}l.setDepthBuffer(!0),l.setDepthWrite(!0),l.setAlphaMode(0)}},i.prototype.dispose=function(){var e=this._vertexBuffers[R.PositionKind];e&&(e.dispose(),this._vertexBuffers[R.PositionKind]=null),this._indexBuffer&&(this._scene.getEngine()._releaseBuffer(this._indexBuffer),this._indexBuffer=null)},i}(),el=function(){function i(e,t,r,n,a){r===void 0&&(r=null),n===void 0&&(n=null),a===void 0&&(a=null),this.index=e,this._opaqueSubMeshes=new Je(256),this._transparentSubMeshes=new Je(256),this._alphaTestSubMeshes=new Je(256),this._depthOnlySubMeshes=new Je(256),this._particleSystems=new Je(256),this._spriteManagers=new Je(256),this._empty=!0,this._edgesRenderers=new rr(16),this._scene=t,this.opaqueSortCompareFn=r,this.alphaTestSortCompareFn=n,this.transparentSortCompareFn=a}return Object.defineProperty(i.prototype,"opaqueSortCompareFn",{set:function(e){this._opaqueSortCompareFn=e,e?this._renderOpaque=this._renderOpaqueSorted:this._renderOpaque=i._RenderUnsorted},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"alphaTestSortCompareFn",{set:function(e){this._alphaTestSortCompareFn=e,e?this._renderAlphaTest=this._renderAlphaTestSorted:this._renderAlphaTest=i._RenderUnsorted},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"transparentSortCompareFn",{set:function(e){e?this._transparentSortCompareFn=e:this._transparentSortCompareFn=i.defaultTransparentSortCompare,this._renderTransparent=this._renderTransparentSorted},enumerable:!1,configurable:!0}),i.prototype.render=function(e,t,r,n){if(e){e(this._opaqueSubMeshes,this._alphaTestSubMeshes,this._transparentSubMeshes,this._depthOnlySubMeshes);return}var a=this._scene.getEngine();this._depthOnlySubMeshes.length!==0&&(a.setColorWrite(!1),this._renderAlphaTest(this._depthOnlySubMeshes),a.setColorWrite(!0)),this._opaqueSubMeshes.length!==0&&this._renderOpaque(this._opaqueSubMeshes),this._alphaTestSubMeshes.length!==0&&this._renderAlphaTest(this._alphaTestSubMeshes);var s=a.getStencilBuffer();if(a.setStencilBuffer(!1),t&&this._renderSprites(),r&&this._renderParticles(n),this.onBeforeTransparentRendering&&this.onBeforeTransparentRendering(),this._transparentSubMeshes.length!==0||this._scene.useOrderIndependentTransparency){if(a.setStencilBuffer(s),this._scene.useOrderIndependentTransparency){var o=this._scene.depthPeelingRenderer.render(this._transparentSubMeshes);o.length&&this._renderTransparent(o)}else this._renderTransparent(this._transparentSubMeshes);a.setAlphaMode(0)}if(a.setStencilBuffer(!1),this._edgesRenderers.length){for(var l=0;l<this._edgesRenderers.length;l++)this._edgesRenderers.data[l].render();a.setAlphaMode(0)}a.setStencilBuffer(s)},i.prototype._renderOpaqueSorted=function(e){return i._RenderSorted(e,this._opaqueSortCompareFn,this._scene.activeCamera,!1)},i.prototype._renderAlphaTestSorted=function(e){return i._RenderSorted(e,this._alphaTestSortCompareFn,this._scene.activeCamera,!1)},i.prototype._renderTransparentSorted=function(e){return i._RenderSorted(e,this._transparentSortCompareFn,this._scene.activeCamera,!0)},i._RenderSorted=function(e,t,r,n){for(var a=0,s,o=r?r.globalPosition:i._ZeroVector;a<e.length;a++)s=e.data[a],s._alphaIndex=s.getMesh().alphaIndex,s._distanceToCamera=m.Distance(s.getBoundingInfo().boundingSphere.centerWorld,o);var l=e.data.slice(0,e.length);for(t&&l.sort(t),a=0;a<l.length;a++){if(s=l[a],n){var u=s.getMaterial();if(u&&u.needDepthPrePass){var f=u.getScene().getEngine();f.setColorWrite(!1),f.setAlphaMode(0),s.render(!1),f.setColorWrite(!0)}}s.render(n)}},i._RenderUnsorted=function(e){for(var t=0;t<e.length;t++){var r=e.data[t];r.render(!1)}},i.defaultTransparentSortCompare=function(e,t){return e._alphaIndex>t._alphaIndex?1:e._alphaIndex<t._alphaIndex?-1:i.backToFrontSortCompare(e,t)},i.backToFrontSortCompare=function(e,t){return e._distanceToCamera<t._distanceToCamera?1:e._distanceToCamera>t._distanceToCamera?-1:0},i.frontToBackSortCompare=function(e,t){return e._distanceToCamera<t._distanceToCamera?-1:e._distanceToCamera>t._distanceToCamera?1:0},i.prototype.prepare=function(){this._opaqueSubMeshes.reset(),this._transparentSubMeshes.reset(),this._alphaTestSubMeshes.reset(),this._depthOnlySubMeshes.reset(),this._particleSystems.reset(),this._spriteManagers.reset(),this._edgesRenderers.reset(),this._empty=!0},i.prototype.dispose=function(){this._opaqueSubMeshes.dispose(),this._transparentSubMeshes.dispose(),this._alphaTestSubMeshes.dispose(),this._depthOnlySubMeshes.dispose(),this._particleSystems.dispose(),this._spriteManagers.dispose(),this._edgesRenderers.dispose()},i.prototype.dispatch=function(e,t,r){t===void 0&&(t=e.getMesh()),r===void 0&&(r=e.getMaterial()),r!=null&&(r.needAlphaBlendingForMesh(t)?this._transparentSubMeshes.push(e):r.needAlphaTesting()?(r.needDepthPrePass&&this._depthOnlySubMeshes.push(e),this._alphaTestSubMeshes.push(e)):(r.needDepthPrePass&&this._depthOnlySubMeshes.push(e),this._opaqueSubMeshes.push(e)),t._renderingGroup=this,t._edgesRenderer&&t._edgesRenderer.isEnabled&&this._edgesRenderers.pushNoDuplicate(t._edgesRenderer),this._empty=!1)},i.prototype.dispatchSprites=function(e){this._spriteManagers.push(e),this._empty=!1},i.prototype.dispatchParticles=function(e){this._particleSystems.push(e),this._empty=!1},i.prototype._renderParticles=function(e){if(this._particleSystems.length!==0){var t=this._scene.activeCamera;this._scene.onBeforeParticlesRenderingObservable.notifyObservers(this._scene);for(var r=0;r<this._particleSystems.length;r++){var n=this._particleSystems.data[r];if((t&&t.layerMask&n.layerMask)!==0){var a=n.emitter;(!a.position||!e||e.indexOf(a)!==-1)&&this._scene._activeParticles.addCount(n.render(),!1)}}this._scene.onAfterParticlesRenderingObservable.notifyObservers(this._scene)}},i.prototype._renderSprites=function(){if(!(!this._scene.spritesEnabled||this._spriteManagers.length===0)){var e=this._scene.activeCamera;this._scene.onBeforeSpritesRenderingObservable.notifyObservers(this._scene);for(var t=0;t<this._spriteManagers.length;t++){var r=this._spriteManagers.data[t];(e&&e.layerMask&r.layerMask)!==0&&r.render()}this._scene.onAfterSpritesRenderingObservable.notifyObservers(this._scene)}},i._ZeroVector=m.Zero(),i}(),tl=function(){function i(){}return i}(),Jr=function(){function i(e){this._useSceneAutoClearSetup=!1,this._renderingGroups=new Array,this._autoClearDepthStencil={},this._customOpaqueSortCompareFn={},this._customAlphaTestSortCompareFn={},this._customTransparentSortCompareFn={},this._renderingGroupInfo=new tl,this._scene=e;for(var t=i.MIN_RENDERINGGROUPS;t<i.MAX_RENDERINGGROUPS;t++)this._autoClearDepthStencil[t]={autoClear:!0,depth:!0,stencil:!0}}return i.prototype._clearDepthStencilBuffer=function(e,t){e===void 0&&(e=!0),t===void 0&&(t=!0),!this._depthStencilBufferAlreadyCleaned&&(this._scene.getEngine().clear(null,!1,e,t),this._depthStencilBufferAlreadyCleaned=!0)},i.prototype.render=function(e,t,r,n){var a=this._renderingGroupInfo;if(a.scene=this._scene,a.camera=this._scene.activeCamera,this._scene.spriteManagers&&n)for(var s=0;s<this._scene.spriteManagers.length;s++){var o=this._scene.spriteManagers[s];this.dispatchSprites(o)}for(var s=i.MIN_RENDERINGGROUPS;s<i.MAX_RENDERINGGROUPS;s++){this._depthStencilBufferAlreadyCleaned=s===i.MIN_RENDERINGGROUPS;var l=this._renderingGroups[s];if(!(!l||l._empty)){var u=Math.pow(2,s);if(a.renderingGroupId=s,this._scene.onBeforeRenderingGroupObservable.notifyObservers(a,u),i.AUTOCLEAR){var f=this._useSceneAutoClearSetup?this._scene.getAutoClearDepthStencilSetup(s):this._autoClearDepthStencil[s];f&&f.autoClear&&this._clearDepthStencilBuffer(f.depth,f.stencil)}for(var h=0,c=this._scene._beforeRenderingGroupDrawStage;h<c.length;h++){var d=c[h];d.action(s)}l.render(e,n,r,t);for(var p=0,_=this._scene._afterRenderingGroupDrawStage;p<_.length;p++){var d=_[p];d.action(s)}this._scene.onAfterRenderingGroupObservable.notifyObservers(a,u)}}},i.prototype.reset=function(){for(var e=i.MIN_RENDERINGGROUPS;e<i.MAX_RENDERINGGROUPS;e++){var t=this._renderingGroups[e];t&&t.prepare()}},i.prototype.dispose=function(){this.freeRenderingGroups(),this._renderingGroups.length=0,this._renderingGroupInfo=null},i.prototype.freeRenderingGroups=function(){for(var e=i.MIN_RENDERINGGROUPS;e<i.MAX_RENDERINGGROUPS;e++){var t=this._renderingGroups[e];t&&t.dispose()}},i.prototype._prepareRenderingGroup=function(e){this._renderingGroups[e]===void 0&&(this._renderingGroups[e]=new el(e,this._scene,this._customOpaqueSortCompareFn[e],this._customAlphaTestSortCompareFn[e],this._customTransparentSortCompareFn[e]))},i.prototype.dispatchSprites=function(e){var t=e.renderingGroupId||0;this._prepareRenderingGroup(t),this._renderingGroups[t].dispatchSprites(e)},i.prototype.dispatchParticles=function(e){var t=e.renderingGroupId||0;this._prepareRenderingGroup(t),this._renderingGroups[t].dispatchParticles(e)},i.prototype.dispatch=function(e,t,r){t===void 0&&(t=e.getMesh());var n=t.renderingGroupId||0;this._prepareRenderingGroup(n),this._renderingGroups[n].dispatch(e,t,r)},i.prototype.setRenderingOrder=function(e,t,r,n){if(t===void 0&&(t=null),r===void 0&&(r=null),n===void 0&&(n=null),this._customOpaqueSortCompareFn[e]=t,this._customAlphaTestSortCompareFn[e]=r,this._customTransparentSortCompareFn[e]=n,this._renderingGroups[e]){var a=this._renderingGroups[e];a.opaqueSortCompareFn=this._customOpaqueSortCompareFn[e],a.alphaTestSortCompareFn=this._customAlphaTestSortCompareFn[e],a.transparentSortCompareFn=this._customTransparentSortCompareFn[e]}},i.prototype.setRenderingAutoClearDepthStencil=function(e,t,r,n){r===void 0&&(r=!0),n===void 0&&(n=!0),this._autoClearDepthStencil[e]={autoClear:t,depth:r,stencil:n}},i.prototype.getAutoClearDepthStencilSetup=function(e){return this._autoClearDepthStencil[e]},i.MAX_RENDERINGGROUPS=4,i.MIN_RENDERINGGROUPS=0,i.AUTOCLEAR=!0,i}(),On=function(){function i(){}return i.NAME_EFFECTLAYER="EffectLayer",i.NAME_LAYER="Layer",i.NAME_LENSFLARESYSTEM="LensFlareSystem",i.NAME_BOUNDINGBOXRENDERER="BoundingBoxRenderer",i.NAME_PARTICLESYSTEM="ParticleSystem",i.NAME_GAMEPAD="Gamepad",i.NAME_SIMPLIFICATIONQUEUE="SimplificationQueue",i.NAME_GEOMETRYBUFFERRENDERER="GeometryBufferRenderer",i.NAME_PREPASSRENDERER="PrePassRenderer",i.NAME_DEPTHRENDERER="DepthRenderer",i.NAME_DEPTHPEELINGRENDERER="DepthPeelingRenderer",i.NAME_POSTPROCESSRENDERPIPELINEMANAGER="PostProcessRenderPipelineManager",i.NAME_SPRITE="Sprite",i.NAME_SUBSURFACE="SubSurface",i.NAME_OUTLINERENDERER="Outline",i.NAME_PROCEDURALTEXTURE="ProceduralTexture",i.NAME_SHADOWGENERATOR="ShadowGenerator",i.NAME_OCTREE="Octree",i.NAME_PHYSICSENGINE="PhysicsEngine",i.NAME_AUDIO="Audio",i.STEP_ISREADYFORMESH_EFFECTLAYER=0,i.STEP_BEFOREEVALUATEACTIVEMESH_BOUNDINGBOXRENDERER=0,i.STEP_EVALUATESUBMESH_BOUNDINGBOXRENDERER=0,i.STEP_PREACTIVEMESH_BOUNDINGBOXRENDERER=0,i.STEP_CAMERADRAWRENDERTARGET_EFFECTLAYER=1,i.STEP_BEFORECAMERADRAW_PREPASS=0,i.STEP_BEFORECAMERADRAW_EFFECTLAYER=1,i.STEP_BEFORECAMERADRAW_LAYER=2,i.STEP_BEFORERENDERTARGETDRAW_PREPASS=0,i.STEP_BEFORERENDERTARGETDRAW_LAYER=1,i.STEP_BEFORERENDERINGMESH_PREPASS=0,i.STEP_BEFORERENDERINGMESH_OUTLINE=1,i.STEP_AFTERRENDERINGMESH_PREPASS=0,i.STEP_AFTERRENDERINGMESH_OUTLINE=1,i.STEP_AFTERRENDERINGGROUPDRAW_EFFECTLAYER_DRAW=0,i.STEP_AFTERRENDERINGGROUPDRAW_BOUNDINGBOXRENDERER=1,i.STEP_BEFORECAMERAUPDATE_SIMPLIFICATIONQUEUE=0,i.STEP_BEFORECAMERAUPDATE_GAMEPAD=1,i.STEP_BEFORECLEAR_PROCEDURALTEXTURE=0,i.STEP_AFTERRENDERTARGETDRAW_PREPASS=0,i.STEP_AFTERRENDERTARGETDRAW_LAYER=1,i.STEP_AFTERCAMERADRAW_PREPASS=0,i.STEP_AFTERCAMERADRAW_EFFECTLAYER=1,i.STEP_AFTERCAMERADRAW_LENSFLARESYSTEM=2,i.STEP_AFTERCAMERADRAW_EFFECTLAYER_DRAW=3,i.STEP_AFTERCAMERADRAW_LAYER=4,i.STEP_AFTERRENDER_AUDIO=0,i.STEP_GATHERRENDERTARGETS_DEPTHRENDERER=0,i.STEP_GATHERRENDERTARGETS_GEOMETRYBUFFERRENDERER=1,i.STEP_GATHERRENDERTARGETS_SHADOWGENERATOR=2,i.STEP_GATHERRENDERTARGETS_POSTPROCESSRENDERPIPELINEMANAGER=3,i.STEP_GATHERACTIVECAMERARENDERTARGETS_DEPTHRENDERER=0,i.STEP_BEFORECLEARSTAGE_PREPASS=0,i.STEP_BEFORERENDERTARGETCLEARSTAGE_PREPASS=0,i.STEP_POINTERMOVE_SPRITE=0,i.STEP_POINTERDOWN_SPRITE=0,i.STEP_POINTERUP_SPRITE=0,i}(),Ge=function(i){$(e,i);function e(t){return i.apply(this,t)||this}return e.Create=function(){return Object.create(e.prototype)},e.prototype.registerStep=function(t,r,n){for(var a=0,s=Number.MAX_VALUE;a<this.length;a++){var o=this[a];if(s=o.index,t<s)break}this.splice(a,0,{index:t,component:r,action:n.bind(r)})},e.prototype.clear=function(){this.length=0},e}(Array),fe=function(){function i(){}return i.POINTERDOWN=1,i.POINTERUP=2,i.POINTERMOVE=4,i.POINTERWHEEL=8,i.POINTERPICK=16,i.POINTERTAP=32,i.POINTERDOUBLETAP=64,i}(),ka=function(){function i(e,t){this.type=e,this.event=t}return i}(),rl=function(i){$(e,i);function e(t,r,n,a){var s=i.call(this,t,r)||this;return s.ray=null,s.skipOnPointerObservable=!1,s.localPosition=new se(n,a),s}return e}(ka),Yt=function(i){$(e,i);function e(t,r,n){var a=i.call(this,t,r)||this;return a.pickInfo=n,a}return e}(ka),Er=function(){function i(){this.hoverCursor="",this.actions=new Array,this.isRecursive=!1}return Object.defineProperty(i,"HasTriggers",{get:function(){for(var e in i.Triggers)if(Object.prototype.hasOwnProperty.call(i.Triggers,e))return!0;return!1},enumerable:!1,configurable:!0}),Object.defineProperty(i,"HasPickTriggers",{get:function(){for(var e in i.Triggers)if(Object.prototype.hasOwnProperty.call(i.Triggers,e)){var t=parseInt(e);if(t>=1&&t<=7)return!0}return!1},enumerable:!1,configurable:!0}),i.HasSpecificTrigger=function(e){for(var t in i.Triggers)if(Object.prototype.hasOwnProperty.call(i.Triggers,t)){var r=parseInt(t);if(r===e)return!0}return!1},i.Triggers={},i}(),Bi=function(){function i(){}return i.KEYDOWN=1,i.KEYUP=2,i}(),Ui=function(){function i(e,t){this.type=e,this.event=t}return i}(),In=function(i){$(e,i);function e(t,r){var n=i.call(this,t,r)||this;return n.type=t,n.event=r,n.skipOnKeyboardObservable=!1,n}return Object.defineProperty(e.prototype,"skipOnPointerObservable",{get:function(){return this.skipOnKeyboardObservable},set:function(t){this.skipOnKeyboardObservable=t},enumerable:!1,configurable:!0}),e}(Ui),ie;(function(i){i[i.Generic=0]="Generic",i[i.Keyboard=1]="Keyboard",i[i.Mouse=2]="Mouse",i[i.Touch=3]="Touch",i[i.DualShock=4]="DualShock",i[i.Xbox=5]="Xbox",i[i.Switch=6]="Switch",i[i.DualSense=7]="DualSense"})(ie||(ie={}));var ue;(function(i){i[i.Horizontal=0]="Horizontal",i[i.Vertical=1]="Vertical",i[i.LeftClick=2]="LeftClick",i[i.MiddleClick=3]="MiddleClick",i[i.RightClick=4]="RightClick",i[i.BrowserBack=5]="BrowserBack",i[i.BrowserForward=6]="BrowserForward",i[i.MouseWheelX=7]="MouseWheelX",i[i.MouseWheelY=8]="MouseWheelY",i[i.MouseWheelZ=9]="MouseWheelZ",i[i.Move=12]="Move"})(ue||(ue={}));var Qt;(function(i){i[i.Horizontal=0]="Horizontal",i[i.Vertical=1]="Vertical",i[i.LeftClick=2]="LeftClick",i[i.MiddleClick=3]="MiddleClick",i[i.RightClick=4]="RightClick",i[i.BrowserBack=5]="BrowserBack",i[i.BrowserForward=6]="BrowserForward",i[i.MouseWheelX=7]="MouseWheelX",i[i.MouseWheelY=8]="MouseWheelY",i[i.MouseWheelZ=9]="MouseWheelZ",i[i.DeltaHorizontal=10]="DeltaHorizontal",i[i.DeltaVertical=11]="DeltaVertical"})(Qt||(Qt={}));var Fn;(function(i){i[i.Cross=0]="Cross",i[i.Circle=1]="Circle",i[i.Square=2]="Square",i[i.Triangle=3]="Triangle",i[i.L1=4]="L1",i[i.R1=5]="R1",i[i.L2=6]="L2",i[i.R2=7]="R2",i[i.Share=8]="Share",i[i.Options=9]="Options",i[i.L3=10]="L3",i[i.R3=11]="R3",i[i.DPadUp=12]="DPadUp",i[i.DPadDown=13]="DPadDown",i[i.DPadLeft=14]="DPadLeft",i[i.DPadRight=15]="DPadRight",i[i.Home=16]="Home",i[i.TouchPad=17]="TouchPad",i[i.LStickXAxis=18]="LStickXAxis",i[i.LStickYAxis=19]="LStickYAxis",i[i.RStickXAxis=20]="RStickXAxis",i[i.RStickYAxis=21]="RStickYAxis"})(Fn||(Fn={}));var wn;(function(i){i[i.Cross=0]="Cross",i[i.Circle=1]="Circle",i[i.Square=2]="Square",i[i.Triangle=3]="Triangle",i[i.L1=4]="L1",i[i.R1=5]="R1",i[i.L2=6]="L2",i[i.R2=7]="R2",i[i.Create=8]="Create",i[i.Options=9]="Options",i[i.L3=10]="L3",i[i.R3=11]="R3",i[i.DPadUp=12]="DPadUp",i[i.DPadDown=13]="DPadDown",i[i.DPadLeft=14]="DPadLeft",i[i.DPadRight=15]="DPadRight",i[i.Home=16]="Home",i[i.TouchPad=17]="TouchPad",i[i.LStickXAxis=18]="LStickXAxis",i[i.LStickYAxis=19]="LStickYAxis",i[i.RStickXAxis=20]="RStickXAxis",i[i.RStickYAxis=21]="RStickYAxis"})(wn||(wn={}));var Ln;(function(i){i[i.A=0]="A",i[i.B=1]="B",i[i.X=2]="X",i[i.Y=3]="Y",i[i.LB=4]="LB",i[i.RB=5]="RB",i[i.LT=6]="LT",i[i.RT=7]="RT",i[i.Back=8]="Back",i[i.Start=9]="Start",i[i.LS=10]="LS",i[i.RS=11]="RS",i[i.DPadUp=12]="DPadUp",i[i.DPadDown=13]="DPadDown",i[i.DPadLeft=14]="DPadLeft",i[i.DPadRight=15]="DPadRight",i[i.Home=16]="Home",i[i.LStickXAxis=17]="LStickXAxis",i[i.LStickYAxis=18]="LStickYAxis",i[i.RStickXAxis=19]="RStickXAxis",i[i.RStickYAxis=20]="RStickYAxis"})(Ln||(Ln={}));var Nn;(function(i){i[i.B=0]="B",i[i.A=1]="A",i[i.Y=2]="Y",i[i.X=3]="X",i[i.L=4]="L",i[i.R=5]="R",i[i.ZL=6]="ZL",i[i.ZR=7]="ZR",i[i.Minus=8]="Minus",i[i.Plus=9]="Plus",i[i.LS=10]="LS",i[i.RS=11]="RS",i[i.DPadUp=12]="DPadUp",i[i.DPadDown=13]="DPadDown",i[i.DPadLeft=14]="DPadLeft",i[i.DPadRight=15]="DPadRight",i[i.Home=16]="Home",i[i.Capture=17]="Capture",i[i.LStickXAxis=18]="LStickXAxis",i[i.LStickYAxis=19]="LStickYAxis",i[i.RStickXAxis=20]="RStickXAxis",i[i.RStickYAxis=21]="RStickYAxis"})(Nn||(Nn={}));var Bn;(function(i){i[i.PointerMove=0]="PointerMove",i[i.PointerDown=1]="PointerDown",i[i.PointerUp=2]="PointerUp"})(Bn||(Bn={}));var Ga=function(){function i(){}return i.DOM_DELTA_PIXEL=0,i.DOM_DELTA_LINE=1,i.DOM_DELTA_PAGE=2,i}(),_r=function(){function i(){}return i.CreateDeviceEvent=function(e,t,r,n,a,s){switch(e){case ie.Keyboard:return this._CreateKeyboardEvent(r,n,a,s);case ie.Mouse:if(r===ue.MouseWheelX||r===ue.MouseWheelY||r===ue.MouseWheelZ)return this._CreateWheelEvent(e,t,r,n,a,s);case ie.Touch:return this._CreatePointerEvent(e,t,r,n,a,s);default:throw"Unable to generate event for device ".concat(ie[e])}},i._CreatePointerEvent=function(e,t,r,n,a,s){var o=this._CreateMouseEvent(e,t,r,n,a,s);return e===ie.Mouse?(o.deviceType=ie.Mouse,o.pointerId=1,o.pointerType="mouse"):(o.deviceType=ie.Touch,o.pointerId=t,o.pointerType="touch"),r===ue.Move?o.type="pointermove":r>=ue.LeftClick&&r<=ue.RightClick&&(o.type=n===1?"pointerdown":"pointerup",o.button=r-2),o},i._CreateWheelEvent=function(e,t,r,n,a,s){var o=this._CreateMouseEvent(e,t,r,n,a,s);return o.type="wheel",o.deltaMode=Ga.DOM_DELTA_PIXEL,o.deltaX=r===ue.MouseWheelX?n:a.pollInput(e,t,ue.MouseWheelX),o.deltaY=r===ue.MouseWheelY?n:a.pollInput(e,t,ue.MouseWheelY),o.deltaZ=r===ue.MouseWheelZ?n:a.pollInput(e,t,ue.MouseWheelZ),o},i._CreateMouseEvent=function(e,t,r,n,a,s){var o=this._CreateEvent(s),l=a.pollInput(e,t,ue.Horizontal),u=a.pollInput(e,t,ue.Vertical);return s?(o.movementX=0,o.movementY=0,o.offsetX=o.movementX-s.getBoundingClientRect().x,o.offsetY=o.movementY-s.getBoundingClientRect().y):(o.movementX=a.pollInput(e,t,Qt.DeltaHorizontal),o.movementY=a.pollInput(e,t,Qt.DeltaVertical),o.offsetX=0,o.offsetY=0),this._CheckNonCharacterKeys(o,a),o.clientX=l,o.clientY=u,o.x=l,o.y=u,o.deviceType=e,o.deviceSlot=t,o.inputIndex=r,o},i._CreateKeyboardEvent=function(e,t,r,n){var a=this._CreateEvent(n);return this._CheckNonCharacterKeys(a,r),a.deviceType=ie.Keyboard,a.deviceSlot=0,a.inputIndex=e,a.type=t===1?"keydown":"keyup",a.key=String.fromCharCode(e),a.keyCode=e,a},i._CheckNonCharacterKeys=function(e,t){var r=t.isDeviceAvailable(ie.Keyboard),n=r&&t.pollInput(ie.Keyboard,0,18)===1,a=r&&t.pollInput(ie.Keyboard,0,17)===1,s=r&&(t.pollInput(ie.Keyboard,0,91)===1||t.pollInput(ie.Keyboard,0,92)===1||t.pollInput(ie.Keyboard,0,93)===1),o=r&&t.pollInput(ie.Keyboard,0,16)===1;e.altKey=n,e.ctrlKey=a,e.metaKey=s,e.shiftKey=o},i._CreateEvent=function(e){var t={};return t.preventDefault=function(){},t.target=e,t},i}(),il=function(){function i(e,t,r){var n=this;this._nativeInput=_native.DeviceInputSystem?new _native.DeviceInputSystem(e,t,function(a,s,o,l){var u=o===Qt.Horizontal||o===Qt.Vertical||o===Qt.DeltaHorizontal||o===Qt.DeltaVertical?ue.Move:o,f=_r.CreateDeviceEvent(a,s,u,l,n);r(a,s,f)}):this._createDummyNativeInput()}return i.prototype.pollInput=function(e,t,r){return this._nativeInput.pollInput(e,t,r)},i.prototype.isDeviceAvailable=function(e){return e===ie.Mouse||e===ie.Touch},i.prototype.dispose=function(){this._nativeInput.dispose()},i.prototype._createDummyNativeInput=function(){var e={pollInput:function(){return 0},isDeviceAvailable:function(){return!1},dispose:function(){}};return e},i}(),Un=255,Vn=Object.keys(ue).length/2,nl=function(){function i(e,t,r,n){var a=this;this._inputs=[],this._keyboardActive=!1,this._pointerActive=!1,this._usingSafari=te.IsSafari(),this._keyboardDownEvent=function(s){},this._keyboardUpEvent=function(s){},this._keyboardBlurEvent=function(s){},this._pointerMoveEvent=function(s){},this._pointerDownEvent=function(s){},this._pointerUpEvent=function(s){},this._pointerCancelEvent=function(s){},this._pointerWheelEvent=function(s){},this._pointerBlurEvent=function(s){},this._eventsAttached=!1,this._mouseId=-1,this._isUsingFirefox=Li.IsNavigatorAvailable()&&navigator.userAgent&&navigator.userAgent.indexOf("Firefox")!==-1,this._maxTouchPoints=0,this._pointerInputClearObserver=null,this._gamepadConnectedEvent=function(s){},this._gamepadDisconnectedEvent=function(s){},this._eventPrefix=te.GetPointerPrefix(e),this._engine=e,this._onDeviceConnected=t,this._onDeviceDisconnected=r,this._onInputChanged=n,this._enableEvents(),this._engine._onEngineViewChanged||(this._engine._onEngineViewChanged=function(){a._enableEvents()})}return i.prototype.pollInput=function(e,t,r){var n=this._inputs[e][t];if(!n)throw"Unable to find device ".concat(ie[e]);e>=ie.DualShock&&e<=ie.DualSense&&navigator.getGamepads&&this._updateDevice(e,t,r);var a=n[r];if(a===void 0)throw"Unable to find input ".concat(r," for device ").concat(ie[e]," in slot ").concat(t);return r===ue.Move&&te.Warn("Unable to provide information for PointerInput.Move.  Try using PointerInput.Horizontal or PointerInput.Vertical for move data."),a},i.prototype.isDeviceAvailable=function(e){return this._inputs[e]!==void 0},i.prototype.dispose=function(){this._onDeviceConnected=function(){},this._onDeviceDisconnected=function(){},this._onInputChanged=function(){},delete this._engine._onEngineViewChanged,this._elementToAttachTo&&this._disableEvents()},i.prototype._enableEvents=function(){var e=this===null||this===void 0?void 0:this._engine.getInputElement();if(e&&(!this._eventsAttached||this._elementToAttachTo!==e)){if(this._disableEvents(),this._inputs)for(var t=0,r=this._inputs;t<r.length;t++){var n=r[t];if(n)for(var a in n){var s=+a,o=n[s];if(o)for(var l=0;l<o.length;l++)o[l]=0}}this._elementToAttachTo=e,this._elementToAttachTo.tabIndex=this._elementToAttachTo.tabIndex!==-1?this._elementToAttachTo.tabIndex:this._engine.canvasTabIndex,this._handleKeyActions(),this._handlePointerActions(),this._handleGamepadActions(),this._eventsAttached=!0,this._checkForConnectedDevices()}},i.prototype._disableEvents=function(){this._elementToAttachTo&&(this._elementToAttachTo.removeEventListener("blur",this._keyboardBlurEvent),this._elementToAttachTo.removeEventListener("blur",this._pointerBlurEvent),this._elementToAttachTo.removeEventListener("keydown",this._keyboardDownEvent),this._elementToAttachTo.removeEventListener("keyup",this._keyboardUpEvent),this._elementToAttachTo.removeEventListener(this._eventPrefix+"move",this._pointerMoveEvent),this._elementToAttachTo.removeEventListener(this._eventPrefix+"down",this._pointerDownEvent),this._elementToAttachTo.removeEventListener(this._eventPrefix+"up",this._pointerUpEvent),this._elementToAttachTo.removeEventListener(this._eventPrefix+"cancel",this._pointerCancelEvent),this._elementToAttachTo.removeEventListener(this._wheelEventName,this._pointerWheelEvent),window.removeEventListener("gamepadconnected",this._gamepadConnectedEvent),window.removeEventListener("gamepaddisconnected",this._gamepadDisconnectedEvent)),this._pointerInputClearObserver&&this._engine.onEndFrameObservable.remove(this._pointerInputClearObserver),this._eventsAttached=!1},i.prototype._checkForConnectedDevices=function(){if(navigator.getGamepads)for(var e=navigator.getGamepads(),t=0,r=e;t<r.length;t++){var n=r[t];n&&this._addGamePad(n)}matchMedia("(pointer:fine)").matches&&this._addPointerDevice(ie.Mouse,0,0,0)},i.prototype._addGamePad=function(e){var t=this._getGamepadDeviceType(e.id),r=e.index;this._gamepads=this._gamepads||new Array(e.index+1),this._registerDevice(t,r,e.buttons.length+e.axes.length),this._gamepads[r]=t},i.prototype._addPointerDevice=function(e,t,r,n){this._pointerActive||(this._pointerActive=!0),this._registerDevice(e,t,Vn);var a=this._inputs[e][t];a[0]=r,a[1]=n},i.prototype._registerDevice=function(e,t,r){if(t===void 0)throw"Unable to register device ".concat(ie[e]," to undefined slot.");if(this._inputs[e]||(this._inputs[e]={}),!this._inputs[e][t]){for(var n=new Array(r),a=0;a<r;a++)n[a]=0;this._inputs[e][t]=n,this._onDeviceConnected(e,t)}},i.prototype._unregisterDevice=function(e,t){this._inputs[e][t]&&(delete this._inputs[e][t],this._onDeviceDisconnected(e,t))},i.prototype._handleKeyActions=function(){var e=this;this._keyboardDownEvent=function(t){e._keyboardActive||(e._keyboardActive=!0,e._registerDevice(ie.Keyboard,0,Un));var r=e._inputs[ie.Keyboard][0];if(r){r[t.keyCode]=1;var n=t;n.inputIndex=t.keyCode,e._onInputChanged(ie.Keyboard,0,n)}},this._keyboardUpEvent=function(t){e._keyboardActive||(e._keyboardActive=!0,e._registerDevice(ie.Keyboard,0,Un));var r=e._inputs[ie.Keyboard][0];if(r){r[t.keyCode]=0;var n=t;n.inputIndex=t.keyCode,e._onInputChanged(ie.Keyboard,0,n)}},this._keyboardBlurEvent=function(){if(e._keyboardActive){for(var t=e._inputs[ie.Keyboard][0],r=0;r<t.length;r++)if(t[r]!==0){t[r]=0;var n=_r.CreateDeviceEvent(ie.Keyboard,0,r,0,e,e._elementToAttachTo);e._onInputChanged(ie.Keyboard,0,n)}}},this._elementToAttachTo.addEventListener("keydown",this._keyboardDownEvent),this._elementToAttachTo.addEventListener("keyup",this._keyboardUpEvent),this._elementToAttachTo.addEventListener("blur",this._keyboardBlurEvent)},i.prototype._handlePointerActions=function(){var e=this;this._maxTouchPoints=Li.IsNavigatorAvailable()&&navigator.maxTouchPoints||2,this._activeTouchIds||(this._activeTouchIds=new Array(this._maxTouchPoints));for(var t=0;t<this._maxTouchPoints;t++)this._activeTouchIds[t]=-1;this._pointerMoveEvent=function(s){var o=e._getPointerType(s),l=o===ie.Mouse?0:e._activeTouchIds.indexOf(s.pointerId);e._inputs[o]||(e._inputs[o]={}),e._inputs[o][l]||e._addPointerDevice(o,l,s.clientX,s.clientY);var u=e._inputs[o][l];if(u){u[ue.Horizontal]=s.clientX,u[ue.Vertical]=s.clientY;var f=s;f.inputIndex=ue.Move,e._onInputChanged(o,l,f),!e._usingSafari&&s.button!==-1&&(f.inputIndex=s.button+2,u[s.button+2]=u[s.button+2]?0:1,e._onInputChanged(o,l,f))}},this._pointerDownEvent=function(s){var o=e._getPointerType(s),l=o===ie.Mouse?0:s.pointerId;if(o===ie.Touch){var u=e._activeTouchIds.indexOf(-1);if(u>=0)l=u,e._activeTouchIds[u]=s.pointerId;else{te.Warn("Max number of touches exceeded.  Ignoring touches in excess of ".concat(e._maxTouchPoints));return}}e._inputs[o]||(e._inputs[o]={}),e._inputs[o][l]?o===ie.Touch&&e._onDeviceConnected(o,l):e._addPointerDevice(o,l,s.clientX,s.clientY);var f=e._inputs[o][l];if(f){var h=f[ue.Horizontal],c=f[ue.Vertical];if(o===ie.Mouse){if(e._mouseId===-1&&(s.pointerId===void 0?e._mouseId=e._isUsingFirefox?0:1:e._mouseId=s.pointerId),!document.pointerLockElement&&e._elementToAttachTo.hasPointerCapture)try{e._elementToAttachTo.setPointerCapture(e._mouseId)}catch{}}else if(s.pointerId&&!document.pointerLockElement&&e._elementToAttachTo.hasPointerCapture)try{e._elementToAttachTo.setPointerCapture(s.pointerId)}catch{}f[ue.Horizontal]=s.clientX,f[ue.Vertical]=s.clientY,f[s.button+2]=1;var d=s;d.inputIndex=s.button+2,e._onInputChanged(o,l,d),(h!==s.clientX||c!==s.clientY)&&(d.inputIndex=ue.Move,e._onInputChanged(o,l,d))}},this._pointerUpEvent=function(s){var o,l,u,f,h,c=e._getPointerType(s),d=c===ie.Mouse?0:e._activeTouchIds.indexOf(s.pointerId);if(c===ie.Touch){if(d===-1)return;e._activeTouchIds[d]=-1}var p=(o=e._inputs[c])===null||o===void 0?void 0:o[d];if(p&&p[s.button+2]!==0){var _=p[ue.Horizontal],g=p[ue.Vertical];p[ue.Horizontal]=s.clientX,p[ue.Vertical]=s.clientY,p[s.button+2]=0;var v=s;(_!==s.clientX||g!==s.clientY)&&(v.inputIndex=ue.Move,e._onInputChanged(c,d,v)),v.inputIndex=s.button+2,c===ie.Mouse&&e._mouseId>=0&&((u=(l=e._elementToAttachTo).hasPointerCapture)===null||u===void 0?void 0:u.call(l,e._mouseId))?e._elementToAttachTo.releasePointerCapture(e._mouseId):s.pointerId&&((h=(f=e._elementToAttachTo).hasPointerCapture)===null||h===void 0?void 0:h.call(f,s.pointerId))&&e._elementToAttachTo.releasePointerCapture(s.pointerId),e._onInputChanged(c,d,v),c===ie.Touch&&e._onDeviceDisconnected(c,d)}},this._pointerCancelEvent=function(s){var o,l,u,f;if(s.pointerType==="mouse"){var h=e._inputs[ie.Mouse][0];e._mouseId>=0&&((l=(o=e._elementToAttachTo).hasPointerCapture)===null||l===void 0?void 0:l.call(o,e._mouseId))&&e._elementToAttachTo.releasePointerCapture(e._mouseId);for(var c=ue.LeftClick;c<=ue.BrowserForward;c++)if(h[c]===1){h[c]=0;var d=_r.CreateDeviceEvent(ie.Mouse,0,c,0,e,e._elementToAttachTo);e._onInputChanged(ie.Mouse,0,d)}}else{var p=e._activeTouchIds.indexOf(s.pointerId);!((f=(u=e._elementToAttachTo).hasPointerCapture)===null||f===void 0)&&f.call(u,s.pointerId)&&e._elementToAttachTo.releasePointerCapture(s.pointerId),e._inputs[ie.Touch][p][ue.LeftClick]=0;var d=_r.CreateDeviceEvent(ie.Touch,p,ue.LeftClick,0,e,e._elementToAttachTo);e._onInputChanged(ie.Touch,p,d),e._activeTouchIds[p]=-1,e._onDeviceDisconnected(ie.Touch,p)}},this._wheelEventName="onwheel"in document.createElement("div")?"wheel":document.onmousewheel!==void 0?"mousewheel":"DOMMouseScroll";var r=!1,n=function(){};try{var a={passive:{get:function(){r=!0}}};this._elementToAttachTo.addEventListener("test",n,a),this._elementToAttachTo.removeEventListener("test",n,a)}catch{}this._pointerBlurEvent=function(){var s,o,l,u,f;if(e.isDeviceAvailable(ie.Mouse)){var h=e._inputs[ie.Mouse][0];e._mouseId>=0&&((o=(s=e._elementToAttachTo).hasPointerCapture)===null||o===void 0?void 0:o.call(s,e._mouseId))&&e._elementToAttachTo.releasePointerCapture(e._mouseId);for(var c=ue.LeftClick;c<=ue.BrowserForward;c++)if(h[c]===1){h[c]=0;var d=_r.CreateDeviceEvent(ie.Mouse,0,c,0,e,e._elementToAttachTo);e._onInputChanged(ie.Mouse,0,d)}}if(e.isDeviceAvailable(ie.Touch))for(var h=e._inputs[ie.Touch],p=0;p<e._activeTouchIds.length;p++){var _=e._activeTouchIds[p];if(!((u=(l=e._elementToAttachTo).hasPointerCapture)===null||u===void 0)&&u.call(l,_)&&e._elementToAttachTo.releasePointerCapture(_),_!==-1&&((f=h[p])===null||f===void 0?void 0:f[ue.LeftClick])===1){h[p][ue.LeftClick]=0;var d=_r.CreateDeviceEvent(ie.Touch,p,ue.LeftClick,0,e,e._elementToAttachTo);e._onInputChanged(ie.Touch,p,d),e._activeTouchIds[p]=-1,e._onDeviceDisconnected(ie.Touch,p)}}},this._pointerWheelEvent=function(s){var o=ie.Mouse,l=0;e._inputs[o]||(e._inputs[o]=[]),e._inputs[o][l]||(e._pointerActive=!0,e._registerDevice(o,l,Vn));var u=e._inputs[o][l];if(u){u[ue.MouseWheelX]=s.deltaX||0,u[ue.MouseWheelY]=s.deltaY||s.wheelDelta||0,u[ue.MouseWheelZ]=s.deltaZ||0;var f=s;u[ue.MouseWheelX]!==0&&(f.inputIndex=ue.MouseWheelX,e._onInputChanged(o,l,f)),u[ue.MouseWheelY]!==0&&(f.inputIndex=ue.MouseWheelY,e._onInputChanged(o,l,f)),u[ue.MouseWheelZ]!==0&&(f.inputIndex=ue.MouseWheelZ,e._onInputChanged(o,l,f))}},this._elementToAttachTo.addEventListener(this._eventPrefix+"move",this._pointerMoveEvent),this._elementToAttachTo.addEventListener(this._eventPrefix+"down",this._pointerDownEvent),this._elementToAttachTo.addEventListener(this._eventPrefix+"up",this._pointerUpEvent),this._elementToAttachTo.addEventListener(this._eventPrefix+"cancel",this._pointerCancelEvent),this._elementToAttachTo.addEventListener("blur",this._pointerBlurEvent),this._elementToAttachTo.addEventListener(this._wheelEventName,this._pointerWheelEvent,r?{passive:!1}:!1),this._pointerInputClearObserver=this._engine.onEndFrameObservable.add(function(){if(e.isDeviceAvailable(ie.Mouse)){var s=e._inputs[ie.Mouse][0];s[ue.MouseWheelX]=0,s[ue.MouseWheelY]=0,s[ue.MouseWheelZ]=0}})},i.prototype._handleGamepadActions=function(){var e=this;this._gamepadConnectedEvent=function(t){e._addGamePad(t.gamepad)},this._gamepadDisconnectedEvent=function(t){if(e._gamepads){var r=e._getGamepadDeviceType(t.gamepad.id),n=t.gamepad.index;e._unregisterDevice(r,n),delete e._gamepads[n]}},window.addEventListener("gamepadconnected",this._gamepadConnectedEvent),window.addEventListener("gamepaddisconnected",this._gamepadDisconnectedEvent)},i.prototype._updateDevice=function(e,t,r){var n=navigator.getGamepads()[t];if(n&&e===this._gamepads[t]){var a=this._inputs[e][t];r>=n.buttons.length?a[r]=n.axes[r-n.buttons.length].valueOf():a[r]=n.buttons[r].value}},i.prototype._getGamepadDeviceType=function(e){return e.indexOf("054c")!==-1?e.indexOf("0ce6")!==-1?ie.DualSense:ie.DualShock:e.indexOf("Xbox One")!==-1||e.search("Xbox 360")!==-1||e.search("xinput")!==-1?ie.Xbox:e.indexOf("057e")!==-1?ie.Switch:ie.Generic},i.prototype._getPointerType=function(e){var t=ie.Mouse;return(e.pointerType==="touch"||e.pointerType==="pen"||e.touches)&&(t=ie.Touch),t},i}(),kn=function(){function i(e,t,r){r===void 0&&(r=0),this.deviceType=t,this.deviceSlot=r,this.onInputChangedObservable=new X,this._deviceInputSystem=e}return i.prototype.getInput=function(e){return this._deviceInputSystem.pollInput(this.deviceType,this.deviceSlot,e)},i}(),al=function(){function i(e){var t=this;this._registeredManagers=new Array,this._refCount=0,this.registerManager=function(o){for(var l=0;l<t._devices.length;l++){var u=t._devices[l];for(var f in u){var h=+f;o._addDevice(new kn(t._deviceInputSystem,l,h))}}t._registeredManagers.push(o)},this.unregisterManager=function(o){var l=t._registeredManagers.indexOf(o);l>-1&&t._registeredManagers.splice(l,1)};var r=Object.keys(ie).length/2;this._devices=new Array(r);var n=function(o,l){t._devices[o]||(t._devices[o]=new Array),t._devices[o][l]||(t._devices[o][l]=l);for(var u=0,f=t._registeredManagers;u<f.length;u++){var h=f[u],c=new kn(t._deviceInputSystem,o,l);h._addDevice(c)}},a=function(o,l){var u;!((u=t._devices[o])===null||u===void 0)&&u[l]&&delete t._devices[o][l];for(var f=0,h=t._registeredManagers;f<h.length;f++){var c=h[f];c._removeDevice(o,l)}},s=function(o,l,u){if(u)for(var f=0,h=t._registeredManagers;f<h.length;f++){var c=h[f];c._onInputChanged(o,l,u)}};typeof _native!="undefined"?this._deviceInputSystem=new il(n,a,s):this._deviceInputSystem=new nl(e,n,a,s)}return i.prototype.dispose=function(){this._deviceInputSystem.dispose()},i}(),sl=function(){function i(e){var t=this,r=Object.keys(ie).length/2;this._devices=new Array(r),this._firstDevice=new Array(r),this._engine=e,this._engine._deviceSourceManager||(this._engine._deviceSourceManager=new al(e)),this._engine._deviceSourceManager._refCount++,this.onDeviceConnectedObservable=new X(function(n){for(var a=0,s=t._devices;a<s.length;a++){var o=s[a];if(o)for(var l=0,u=o;l<u.length;l++){var f=u[l];f&&t.onDeviceConnectedObservable.notifyObserver(n,f)}}}),this.onDeviceDisconnectedObservable=new X,this._engine._deviceSourceManager.registerManager(this),this._onDisposeObserver=e.onDisposeObservable.add(function(){t.dispose()})}return i.prototype.getDeviceSource=function(e,t){if(t===void 0){if(this._firstDevice[e]===void 0)return null;t=this._firstDevice[e]}return!this._devices[e]||this._devices[e][t]===void 0?null:this._devices[e][t]},i.prototype.getDeviceSources=function(e){return this._devices[e].filter(function(t){return!!t})},i.prototype.dispose=function(){this.onDeviceConnectedObservable.clear(),this.onDeviceDisconnectedObservable.clear(),this._engine._deviceSourceManager&&(this._engine._deviceSourceManager.unregisterManager(this),--this._engine._deviceSourceManager._refCount<1&&(this._engine._deviceSourceManager.dispose(),delete this._engine._deviceSourceManager)),this._engine.onDisposeObservable.remove(this._onDisposeObserver)},i.prototype._addDevice=function(e){this._devices[e.deviceType]||(this._devices[e.deviceType]=new Array),this._devices[e.deviceType][e.deviceSlot]||(this._devices[e.deviceType][e.deviceSlot]=e,this._updateFirstDevices(e.deviceType)),this.onDeviceConnectedObservable.notifyObservers(e)},i.prototype._removeDevice=function(e,t){var r,n,a=(r=this._devices[e])===null||r===void 0?void 0:r[t];this.onDeviceDisconnectedObservable.notifyObservers(a),!((n=this._devices[e])===null||n===void 0)&&n[t]&&delete this._devices[e][t],this._updateFirstDevices(e)},i.prototype._onInputChanged=function(e,t,r){var n,a;(a=(n=this._devices[e])===null||n===void 0?void 0:n[t])===null||a===void 0||a.onInputChangedObservable.notifyObservers(r)},i.prototype._updateFirstDevices=function(e){switch(e){case ie.Keyboard:case ie.Mouse:this._firstDevice[e]=0;break;case ie.Touch:case ie.DualSense:case ie.DualShock:case ie.Xbox:case ie.Switch:case ie.Generic:{delete this._firstDevice[e];var t=this._devices[e];if(t){for(var r=0;r<t.length;r++)if(t[r]){this._firstDevice[e]=r;break}}break}}},i}(),Gn=function(){function i(){this._singleClick=!1,this._doubleClick=!1,this._hasSwiped=!1,this._ignore=!1}return Object.defineProperty(i.prototype,"singleClick",{get:function(){return this._singleClick},set:function(e){this._singleClick=e},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"doubleClick",{get:function(){return this._doubleClick},set:function(e){this._doubleClick=e},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"hasSwiped",{get:function(){return this._hasSwiped},set:function(e){this._hasSwiped=e},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"ignore",{get:function(){return this._ignore},set:function(e){this._ignore=e},enumerable:!1,configurable:!0}),i}(),Dt=function(){function i(e){this._alreadyAttached=!1,this._meshPickProceed=!1,this._currentPickResult=null,this._previousPickResult=null,this._totalPointersPressed=0,this._doubleClickOccured=!1,this._pointerX=0,this._pointerY=0,this._startingPointerPosition=new se(0,0),this._previousStartingPointerPosition=new se(0,0),this._startingPointerTime=0,this._previousStartingPointerTime=0,this._pointerCaptures={},this._meshUnderPointerId={},this._deviceSourceManager=null,this._scene=e||ye.LastCreatedScene,this._scene}return Object.defineProperty(i.prototype,"meshUnderPointer",{get:function(){return this._pointerOverMesh},enumerable:!1,configurable:!0}),i.prototype.getMeshUnderPointerByPointerId=function(e){return this._meshUnderPointerId[e]||null},Object.defineProperty(i.prototype,"unTranslatedPointer",{get:function(){return new se(this._unTranslatedPointerX,this._unTranslatedPointerY)},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"pointerX",{get:function(){return this._pointerX},set:function(e){this._pointerX=e},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"pointerY",{get:function(){return this._pointerY},set:function(e){this._pointerY=e},enumerable:!1,configurable:!0}),i.prototype._updatePointerPosition=function(e){var t=this._scene.getEngine().getInputElementClientRect();!t||(this._pointerX=e.clientX-t.left,this._pointerY=e.clientY-t.top,this._unTranslatedPointerX=this._pointerX,this._unTranslatedPointerY=this._pointerY)},i.prototype._processPointerMove=function(e,t){var r=this._scene,n=r.getEngine(),a=n.getInputElement();a&&(a.tabIndex=n.canvasTabIndex,r.doNotHandleCursors||(a.style.cursor=r.defaultCursor));var s=!!(e&&e.hit&&e.pickedMesh);s?(r.setPointerOverMesh(e.pickedMesh,t.pointerId,e),this._pointerOverMesh&&this._pointerOverMesh.actionManager&&this._pointerOverMesh.actionManager.hasPointerTriggers&&!r.doNotHandleCursors&&a&&(this._pointerOverMesh.actionManager.hoverCursor?a.style.cursor=this._pointerOverMesh.actionManager.hoverCursor:a.style.cursor=r.hoverCursor)):r.setPointerOverMesh(null,t.pointerId,e);for(var o=0,l=r._pointerMoveStage;o<l.length;o++){var u=l[o];e=u.action(this._unTranslatedPointerX,this._unTranslatedPointerY,e,s,a)}if(e){var f=t.type==="wheel"||t.type==="mousewheel"||t.type==="DOMMouseScroll"?fe.POINTERWHEEL:fe.POINTERMOVE;if(r.onPointerMove&&r.onPointerMove(t,e,f),r.onPointerObservable.hasObservers()){var h=new Yt(f,t,e);this._setRayOnPointerInfo(h),r.onPointerObservable.notifyObservers(h,f)}}},i.prototype._setRayOnPointerInfo=function(e){var t=this._scene;e.pickInfo&&!e.pickInfo._pickingUnavailable&&(e.pickInfo.ray||(e.pickInfo.ray=t.createPickingRay(e.event.offsetX,e.event.offsetY,G.Identity(),t.activeCamera)))},i.prototype._checkPrePointerObservable=function(e,t,r){var n=this._scene,a=new rl(r,t,this._unTranslatedPointerX,this._unTranslatedPointerY);return e&&(a.ray=e.ray,e.originMesh&&(a.nearInteractionPickingInfo=e)),n.onPrePointerObservable.notifyObservers(a,r),!!a.skipOnPointerObservable},i.prototype.simulatePointerMove=function(e,t){var r=new PointerEvent("pointermove",t);r.inputIndex=ue.Move,!this._checkPrePointerObservable(e,r,fe.POINTERMOVE)&&this._processPointerMove(e,r)},i.prototype.simulatePointerDown=function(e,t){var r=new PointerEvent("pointerdown",t);r.inputIndex=r.button+2,!this._checkPrePointerObservable(e,r,fe.POINTERDOWN)&&this._processPointerDown(e,r)},i.prototype._processPointerDown=function(e,t){var r=this,n=this._scene;if(e&&e.hit&&e.pickedMesh){this._pickedDownMesh=e.pickedMesh;var a=e.pickedMesh._getActionManagerForTrigger();if(a){if(a.hasPickTriggers)switch(a.processTrigger(5,tt.CreateNew(e.pickedMesh,t)),t.button){case 0:a.processTrigger(2,tt.CreateNew(e.pickedMesh,t));break;case 1:a.processTrigger(4,tt.CreateNew(e.pickedMesh,t));break;case 2:a.processTrigger(3,tt.CreateNew(e.pickedMesh,t));break}a.hasSpecificTrigger(8)&&window.setTimeout(function(){var h=n.pick(r._unTranslatedPointerX,r._unTranslatedPointerY,function(c){return c.isPickable&&c.isVisible&&c.isReady()&&c.actionManager&&c.actionManager.hasSpecificTrigger(8)&&c===r._pickedDownMesh},!1,n.cameraToUseForPointers);h&&h.hit&&h.pickedMesh&&a&&r._totalPointersPressed!==0&&Date.now()-r._startingPointerTime>i.LongPressDelay&&!r._isPointerSwiping()&&(r._startingPointerTime=0,a.processTrigger(8,tt.CreateNew(h.pickedMesh,t)))},i.LongPressDelay)}}else for(var s=0,o=n._pointerDownStage;s<o.length;s++){var l=o[s];e=l.action(this._unTranslatedPointerX,this._unTranslatedPointerY,e,t)}if(e){var u=fe.POINTERDOWN;if(n.onPointerDown&&n.onPointerDown(t,e,u),n.onPointerObservable.hasObservers()){var f=new Yt(u,t,e);this._setRayOnPointerInfo(f),n.onPointerObservable.notifyObservers(f,u)}}},i.prototype._isPointerSwiping=function(){return Math.abs(this._startingPointerPosition.x-this._pointerX)>i.DragMovementThreshold||Math.abs(this._startingPointerPosition.y-this._pointerY)>i.DragMovementThreshold},i.prototype.simulatePointerUp=function(e,t,r){var n=new PointerEvent("pointerup",t);n.inputIndex=ue.Move;var a=new Gn;r?a.doubleClick=!0:a.singleClick=!0,!this._checkPrePointerObservable(e,n,fe.POINTERUP)&&this._processPointerUp(e,n,a)},i.prototype._processPointerUp=function(e,t,r){var n=this._scene;if(e&&e&&e.pickedMesh){if(this._pickedUpMesh=e.pickedMesh,this._pickedDownMesh===this._pickedUpMesh&&(n.onPointerPick&&n.onPointerPick(t,e),r.singleClick&&!r.ignore&&n.onPointerObservable.hasObservers())){var a=fe.POINTERPICK,s=new Yt(a,t,e);this._setRayOnPointerInfo(s),n.onPointerObservable.notifyObservers(s,a)}var o=e.pickedMesh._getActionManagerForTrigger();if(o&&!r.ignore){o.processTrigger(7,tt.CreateNew(e.pickedMesh,t,e)),!r.hasSwiped&&r.singleClick&&o.processTrigger(1,tt.CreateNew(e.pickedMesh,t,e));var l=e.pickedMesh._getActionManagerForTrigger(6);r.doubleClick&&l&&l.processTrigger(6,tt.CreateNew(e.pickedMesh,t,e))}}else if(!r.ignore)for(var u=0,f=n._pointerUpStage;u<f.length;u++){var h=f[u];e=h.action(this._unTranslatedPointerX,this._unTranslatedPointerY,e,t)}if(this._pickedDownMesh&&this._pickedDownMesh!==this._pickedUpMesh){var c=this._pickedDownMesh._getActionManagerForTrigger(16);c&&c.processTrigger(16,tt.CreateNew(this._pickedDownMesh,t))}var d=0;if(n.onPointerObservable.hasObservers()){if(!r.ignore&&!r.hasSwiped&&(r.singleClick&&n.onPointerObservable.hasSpecificMask(fe.POINTERTAP)?d=fe.POINTERTAP:r.doubleClick&&n.onPointerObservable.hasSpecificMask(fe.POINTERDOUBLETAP)&&(d=fe.POINTERDOUBLETAP),d)){var s=new Yt(d,t,e);this._setRayOnPointerInfo(s),n.onPointerObservable.notifyObservers(s,d)}if(!r.ignore){d=fe.POINTERUP;var s=new Yt(d,t,e);this._setRayOnPointerInfo(s),n.onPointerObservable.notifyObservers(s,d)}}n.onPointerUp&&!r.ignore&&n.onPointerUp(t,e,d)},i.prototype.isPointerCaptured=function(e){return e===void 0&&(e=0),this._pointerCaptures[e]},i.prototype.attachControl=function(e,t,r,n){var a=this;e===void 0&&(e=!0),t===void 0&&(t=!0),r===void 0&&(r=!0),n===void 0&&(n=null);var s=this._scene,o=s.getEngine();n||(n=o.getInputElement()),this._alreadyAttached&&this.detachControl(),n&&(this._alreadyAttachedTo=n),this._deviceSourceManager=new sl(o),this._initActionManager=function(l){if(!a._meshPickProceed){var u=s.pick(a._unTranslatedPointerX,a._unTranslatedPointerY,s.pointerDownPredicate,!1,s.cameraToUseForPointers);a._currentPickResult=u,u&&(l=u.hit&&u.pickedMesh?u.pickedMesh._getActionManagerForTrigger():null),a._meshPickProceed=!0}return l},this._delayedSimpleClick=function(l,u,f){(Date.now()-a._previousStartingPointerTime>i.DoubleClickDelay&&!a._doubleClickOccured||l!==a._previousButtonPressed)&&(a._doubleClickOccured=!1,u.singleClick=!0,u.ignore=!1,f(u,a._currentPickResult))},this._initClickEvent=function(l,u,f,h){var c=new Gn;a._currentPickResult=null;var d=null,p=l.hasSpecificMask(fe.POINTERPICK)||u.hasSpecificMask(fe.POINTERPICK)||l.hasSpecificMask(fe.POINTERTAP)||u.hasSpecificMask(fe.POINTERTAP)||l.hasSpecificMask(fe.POINTERDOUBLETAP)||u.hasSpecificMask(fe.POINTERDOUBLETAP);!p&&Er&&(d=a._initActionManager(d,c),d&&(p=d.hasPickTriggers));var _=!1;if(p){var g=f.button;if(c.hasSwiped=a._isPointerSwiping(),!c.hasSwiped){var v=!i.ExclusiveDoubleClickMode;v||(v=!l.hasSpecificMask(fe.POINTERDOUBLETAP)&&!u.hasSpecificMask(fe.POINTERDOUBLETAP),v&&!Er.HasSpecificTrigger(6)&&(d=a._initActionManager(d,c),d&&(v=!d.hasSpecificTrigger(6)))),v?(Date.now()-a._previousStartingPointerTime>i.DoubleClickDelay||g!==a._previousButtonPressed)&&(c.singleClick=!0,h(c,a._currentPickResult),_=!0):(a._previousDelayedSimpleClickTimeout=a._delayedSimpleClickTimeout,a._delayedSimpleClickTimeout=window.setTimeout(a._delayedSimpleClick.bind(a,g,c,h),i.DoubleClickDelay));var y=l.hasSpecificMask(fe.POINTERDOUBLETAP)||u.hasSpecificMask(fe.POINTERDOUBLETAP);!y&&Er.HasSpecificTrigger(6)&&(d=a._initActionManager(d,c),d&&(y=d.hasSpecificTrigger(6))),y&&(g===a._previousButtonPressed&&Date.now()-a._previousStartingPointerTime<i.DoubleClickDelay&&!a._doubleClickOccured?(!c.hasSwiped&&!a._isPointerSwiping()?(a._previousStartingPointerTime=0,a._doubleClickOccured=!0,c.doubleClick=!0,c.ignore=!1,i.ExclusiveDoubleClickMode&&a._previousDelayedSimpleClickTimeout&&clearTimeout(a._previousDelayedSimpleClickTimeout),a._previousDelayedSimpleClickTimeout=a._delayedSimpleClickTimeout,h(c,a._currentPickResult)):(a._doubleClickOccured=!1,a._previousStartingPointerTime=a._startingPointerTime,a._previousStartingPointerPosition.x=a._startingPointerPosition.x,a._previousStartingPointerPosition.y=a._startingPointerPosition.y,a._previousButtonPressed=g,i.ExclusiveDoubleClickMode?(a._previousDelayedSimpleClickTimeout&&clearTimeout(a._previousDelayedSimpleClickTimeout),a._previousDelayedSimpleClickTimeout=a._delayedSimpleClickTimeout,h(c,a._previousPickResult)):h(c,a._currentPickResult)),_=!0):(a._doubleClickOccured=!1,a._previousStartingPointerTime=a._startingPointerTime,a._previousStartingPointerPosition.x=a._startingPointerPosition.x,a._previousStartingPointerPosition.y=a._startingPointerPosition.y,a._previousButtonPressed=g))}}_||h(c,a._currentPickResult)},this._onPointerMove=function(l){if(l.pointerId===void 0&&(l.pointerId=0),a._updatePointerPosition(l),!a._checkPrePointerObservable(null,l,l.type==="wheel"||l.type==="mousewheel"||l.type==="DOMMouseScroll"?fe.POINTERWHEEL:fe.POINTERMOVE)&&!(!s.cameraToUseForPointers&&!s.activeCamera)){if(s.skipPointerMovePicking){a._processPointerMove(new Et,l);return}s.pointerMovePredicate||(s.pointerMovePredicate=function(f){return f.isPickable&&f.isVisible&&f.isReady()&&f.isEnabled()&&(f.enablePointerMoveEvents||s.constantlyUpdateMeshUnderPointer||f._getActionManagerForTrigger()!==null)&&(!s.cameraToUseForPointers||(s.cameraToUseForPointers.layerMask&f.layerMask)!==0)});var u=s.pick(a._unTranslatedPointerX,a._unTranslatedPointerY,s.pointerMovePredicate,!1,s.cameraToUseForPointers,s.pointerMoveTrianglePredicate);a._processPointerMove(u,l)}},this._onPointerDown=function(l){if(a._totalPointersPressed++,a._pickedDownMesh=null,a._meshPickProceed=!1,l.pointerId===void 0&&(l.pointerId=0),a._updatePointerPosition(l),s.preventDefaultOnPointerDown&&n&&(l.preventDefault(),n.focus()),a._startingPointerPosition.x=a._pointerX,a._startingPointerPosition.y=a._pointerY,a._startingPointerTime=Date.now(),!a._checkPrePointerObservable(null,l,fe.POINTERDOWN)&&!(!s.cameraToUseForPointers&&!s.activeCamera)){a._pointerCaptures[l.pointerId]=!0,s.pointerDownPredicate||(s.pointerDownPredicate=function(f){return f.isPickable&&f.isVisible&&f.isReady()&&f.isEnabled()&&(!s.cameraToUseForPointers||(s.cameraToUseForPointers.layerMask&f.layerMask)!==0)}),a._pickedDownMesh=null;var u=s.pick(a._unTranslatedPointerX,a._unTranslatedPointerY,s.pointerDownPredicate,!1,s.cameraToUseForPointers);a._processPointerDown(u,l)}},this._onPointerUp=function(l){a._totalPointersPressed!==0&&(a._totalPointersPressed--,a._pickedUpMesh=null,a._meshPickProceed=!1,l.pointerId===void 0&&(l.pointerId=0),a._updatePointerPosition(l),s.preventDefaultOnPointerUp&&n&&(l.preventDefault(),n.focus()),a._initClickEvent(s.onPrePointerObservable,s.onPointerObservable,l,function(u,f){s.onPrePointerObservable.hasObservers()&&!u.ignore&&(!u.hasSwiped&&(u.singleClick&&s.onPrePointerObservable.hasSpecificMask(fe.POINTERTAP)&&a._checkPrePointerObservable(null,l,fe.POINTERTAP)||u.doubleClick&&s.onPrePointerObservable.hasSpecificMask(fe.POINTERDOUBLETAP)&&a._checkPrePointerObservable(null,l,fe.POINTERDOUBLETAP))||a._checkPrePointerObservable(null,l,fe.POINTERUP))||!a._pointerCaptures[l.pointerId]&&l.buttons>0||(a._pointerCaptures[l.pointerId]=!1,!(!s.cameraToUseForPointers&&!s.activeCamera)&&(s.pointerUpPredicate||(s.pointerUpPredicate=function(h){return h.isPickable&&h.isVisible&&h.isReady()&&h.isEnabled()&&(!s.cameraToUseForPointers||(s.cameraToUseForPointers.layerMask&h.layerMask)!==0)}),!a._meshPickProceed&&(Er&&Er.HasTriggers||s.onPointerObservable.hasObservers())&&a._initActionManager(null,u),f||(f=a._currentPickResult),a._processPointerUp(f,l,u),a._previousPickResult=a._currentPickResult))}))},this._onKeyDown=function(l){var u=Bi.KEYDOWN;if(s.onPreKeyboardObservable.hasObservers()){var f=new In(u,l);if(s.onPreKeyboardObservable.notifyObservers(f,u),f.skipOnKeyboardObservable)return}if(s.onKeyboardObservable.hasObservers()){var f=new Ui(u,l);s.onKeyboardObservable.notifyObservers(f,u)}s.actionManager&&s.actionManager.processTrigger(14,tt.CreateNewFromScene(s,l))},this._onKeyUp=function(l){var u=Bi.KEYUP;if(s.onPreKeyboardObservable.hasObservers()){var f=new In(u,l);if(s.onPreKeyboardObservable.notifyObservers(f,u),f.skipOnKeyboardObservable)return}if(s.onKeyboardObservable.hasObservers()){var f=new Ui(u,l);s.onKeyboardObservable.notifyObservers(f,u)}s.actionManager&&s.actionManager.processTrigger(15,tt.CreateNewFromScene(s,l))},this._deviceSourceManager.onDeviceConnectedObservable.add(function(l){l.deviceType===ie.Mouse?l.onInputChangedObservable.add(function(u){u.inputIndex===ue.LeftClick||u.inputIndex===ue.MiddleClick||u.inputIndex===ue.RightClick?t&&l.getInput(u.inputIndex)===1?a._onPointerDown(u):e&&l.getInput(u.inputIndex)===0&&a._onPointerUp(u):r&&(u.inputIndex===ue.Move||u.inputIndex===ue.MouseWheelX||u.inputIndex===ue.MouseWheelY||u.inputIndex===ue.MouseWheelZ)&&a._onPointerMove(u)}):l.deviceType===ie.Touch?l.onInputChangedObservable.add(function(u){u.inputIndex===ue.LeftClick&&(t&&l.getInput(u.inputIndex)===1?a._onPointerDown(u):e&&l.getInput(u.inputIndex)===0&&a._onPointerUp(u)),r&&u.inputIndex===ue.Move&&a._onPointerMove(u)}):l.deviceType===ie.Keyboard&&l.onInputChangedObservable.add(function(u){u.type==="keydown"?a._onKeyDown(u):u.type==="keyup"&&a._onKeyUp(u)})}),this._alreadyAttached=!0},i.prototype.detachControl=function(){this._alreadyAttached&&(this._deviceSourceManager.dispose(),this._deviceSourceManager=null,this._alreadyAttachedTo&&!this._scene.doNotHandleCursors&&(this._alreadyAttachedTo.style.cursor=this._scene.defaultCursor),this._alreadyAttached=!1,this._alreadyAttachedTo=null)},i.prototype.setPointerOverMesh=function(e,t,r){if(t===void 0&&(t=0),this._meshUnderPointerId[t]!==e){var n=this._meshUnderPointerId[t],a;n&&(a=n._getActionManagerForTrigger(10),a&&a.processTrigger(10,tt.CreateNew(n,void 0,{pointerId:t}))),e?(this._meshUnderPointerId[t]=e,this._pointerOverMesh=e,a=e._getActionManagerForTrigger(9),a&&a.processTrigger(9,tt.CreateNew(e,void 0,{pointerId:t,pickResult:r}))):(delete this._meshUnderPointerId[t],this._pointerOverMesh=null)}},i.prototype.getPointerOverMesh=function(){return this._pointerOverMesh},i.prototype._invalidateMesh=function(e){this._pointerOverMesh===e&&(this._pointerOverMesh=null),this._pickedDownMesh===e&&(this._pickedDownMesh=null),this._pickedUpMesh===e&&(this._pickedUpMesh=null);for(var t in this._meshUnderPointerId)this._meshUnderPointerId[t]===e&&delete this._meshUnderPointerId[t]},i.DragMovementThreshold=10,i.LongPressDelay=500,i.DoubleClickDelay=300,i.ExclusiveDoubleClickMode=!1,i}(),$e=function(){function i(){this._startMonitoringTime=0,this._min=0,this._max=0,this._average=0,this._lastSecAverage=0,this._current=0,this._totalValueCount=0,this._totalAccumulated=0,this._lastSecAccumulated=0,this._lastSecTime=0,this._lastSecValueCount=0}return Object.defineProperty(i.prototype,"min",{get:function(){return this._min},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"max",{get:function(){return this._max},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"average",{get:function(){return this._average},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"lastSecAverage",{get:function(){return this._lastSecAverage},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"current",{get:function(){return this._current},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"total",{get:function(){return this._totalAccumulated},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"count",{get:function(){return this._totalValueCount},enumerable:!1,configurable:!0}),i.prototype.fetchNewFrame=function(){this._totalValueCount++,this._current=0,this._lastSecValueCount++},i.prototype.addCount=function(e,t){!i.Enabled||(this._current+=e,t&&this._fetchResult())},i.prototype.beginMonitoring=function(){!i.Enabled||(this._startMonitoringTime=nt.Now)},i.prototype.endMonitoring=function(e){if(e===void 0&&(e=!0),!!i.Enabled){e&&this.fetchNewFrame();var t=nt.Now;this._current=t-this._startMonitoringTime,e&&this._fetchResult()}},i.prototype._fetchResult=function(){this._totalAccumulated+=this._current,this._lastSecAccumulated+=this._current,this._min=Math.min(this._min,this._current),this._max=Math.max(this._max,this._current),this._average=this._totalAccumulated/this._totalValueCount;var e=nt.Now;e-this._lastSecTime>1e3&&(this._lastSecAverage=this._lastSecAccumulated/this._lastSecValueCount,this._lastSecTime=e,this._lastSecAccumulated=0,this._lastSecValueCount=0)},i.Enabled=!0,i}(),ol=function(){function i(){}return Object.defineProperty(i,"UniqueId",{get:function(){var e=this._UniqueIdCounter;return this._UniqueIdCounter++,e},enumerable:!1,configurable:!0}),i._UniqueIdCounter=1,i}(),Ze=function(){function i(){}return i.CompareLightsPriority=function(e,t){return e.shadowEnabled!==t.shadowEnabled?(t.shadowEnabled?1:0)-(e.shadowEnabled?1:0):t.renderPriority-e.renderPriority},i.FALLOFF_DEFAULT=0,i.FALLOFF_PHYSICAL=1,i.FALLOFF_GLTF=2,i.FALLOFF_STANDARD=3,i.LIGHTMAP_DEFAULT=0,i.LIGHTMAP_SPECULAR=1,i.LIGHTMAP_SHADOWSONLY=2,i.INTENSITYMODE_AUTOMATIC=0,i.INTENSITYMODE_LUMINOUSPOWER=1,i.INTENSITYMODE_LUMINOUSINTENSITY=2,i.INTENSITYMODE_ILLUMINANCE=3,i.INTENSITYMODE_LUMINANCE=4,i.LIGHTTYPEID_POINTLIGHT=0,i.LIGHTTYPEID_DIRECTIONALLIGHT=1,i.LIGHTTYPEID_SPOTLIGHT=2,i.LIGHTTYPEID_HEMISPHERICLIGHT=3,i}(),zn=function(){function i(e,t){i.IsAvailable&&(this._observer=new window.ComputePressureObserver(e,t))}return Object.defineProperty(i,"IsAvailable",{get:function(){return ze()&&"ComputePressureObserver"in window},enumerable:!1,configurable:!0}),i.prototype.observe=function(){var e,t;!((e=this._observer)===null||e===void 0)&&e.observe&&((t=this._observer)===null||t===void 0||t.observe())},i.prototype.unobserve=function(){var e,t;!((e=this._observer)===null||e===void 0)&&e.unobserve&&((t=this._observer)===null||t===void 0||t.unobserve())},i}(),Re=function(i){$(e,i);function e(t,r){var n=i.call(this)||this;n._inputManager=new Dt(n),n.cameraToUseForPointers=null,n._isScene=!0,n._blockEntityCollection=!1,n.autoClear=!0,n.autoClearDepthAndStencil=!0,n.clearColor=new ce(.2,.2,.3,1),n.ambientColor=new me(0,0,0),n.environmentIntensity=1,n._forceWireframe=!1,n._skipFrustumClipping=!1,n._forcePointsCloud=!1,n.animationsEnabled=!0,n._animationPropertiesOverride=null,n.useConstantAnimationDeltaTime=!1,n.constantlyUpdateMeshUnderPointer=!1,n.hoverCursor="pointer",n.defaultCursor="",n.doNotHandleCursors=!1,n.preventDefaultOnPointerDown=!0,n.preventDefaultOnPointerUp=!0,n.metadata=null,n.reservedDataStore=null,n.disableOfflineSupportExceptionRules=new Array,n.onDisposeObservable=new X,n._onDisposeObserver=null,n.onBeforeRenderObservable=new X,n._onBeforeRenderObserver=null,n.onAfterRenderObservable=new X,n.onAfterRenderCameraObservable=new X,n._onAfterRenderObserver=null,n.onBeforeAnimationsObservable=new X,n.onAfterAnimationsObservable=new X,n.onBeforeDrawPhaseObservable=new X,n.onAfterDrawPhaseObservable=new X,n.onReadyObservable=new X,n.onBeforeCameraRenderObservable=new X,n._onBeforeCameraRenderObserver=null,n.onAfterCameraRenderObservable=new X,n._onAfterCameraRenderObserver=null,n.onBeforeActiveMeshesEvaluationObservable=new X,n.onAfterActiveMeshesEvaluationObservable=new X,n.onBeforeParticlesRenderingObservable=new X,n.onAfterParticlesRenderingObservable=new X,n.onDataLoadedObservable=new X,n.onNewCameraAddedObservable=new X,n.onCameraRemovedObservable=new X,n.onNewLightAddedObservable=new X,n.onLightRemovedObservable=new X,n.onNewGeometryAddedObservable=new X,n.onGeometryRemovedObservable=new X,n.onNewTransformNodeAddedObservable=new X,n.onTransformNodeRemovedObservable=new X,n.onNewMeshAddedObservable=new X,n.onMeshRemovedObservable=new X,n.onNewSkeletonAddedObservable=new X,n.onSkeletonRemovedObservable=new X,n.onNewMaterialAddedObservable=new X,n.onNewMultiMaterialAddedObservable=new X,n.onMaterialRemovedObservable=new X,n.onMultiMaterialRemovedObservable=new X,n.onNewTextureAddedObservable=new X,n.onTextureRemovedObservable=new X,n.onBeforeRenderTargetsRenderObservable=new X,n.onAfterRenderTargetsRenderObservable=new X,n.onBeforeStepObservable=new X,n.onAfterStepObservable=new X,n.onActiveCameraChanged=new X,n.onBeforeRenderingGroupObservable=new X,n.onAfterRenderingGroupObservable=new X,n.onMeshImportedObservable=new X,n.onAnimationFileImportedObservable=new X,n._registeredForLateAnimationBindings=new rr(256),n.skipPointerMovePicking=!1,n.onPrePointerObservable=new X,n.onPointerObservable=new X,n.onPreKeyboardObservable=new X,n.onKeyboardObservable=new X,n._useRightHandedSystem=!1,n._timeAccumulator=0,n._currentStepId=0,n._currentInternalStep=0,n._fogEnabled=!0,n._fogMode=e.FOGMODE_NONE,n.fogColor=new me(.2,.2,.3),n.fogDensity=.1,n.fogStart=0,n.fogEnd=1e3,n.needsPreviousWorldMatrices=!1,n._shadowsEnabled=!0,n._lightsEnabled=!0,n.activeCameras=new Array,n._texturesEnabled=!0,n.physicsEnabled=!0,n.particlesEnabled=!0,n.spritesEnabled=!0,n._skeletonsEnabled=!0,n.lensFlaresEnabled=!0,n.collisionsEnabled=!0,n.gravity=new m(0,-9.807,0),n.postProcessesEnabled=!0,n.renderTargetsEnabled=!0,n.dumpNextRenderTargets=!1,n.customRenderTargets=new Array,n.importedMeshesFiles=new Array,n.probesEnabled=!0,n._meshesForIntersections=new rr(256),n.proceduralTexturesEnabled=!0,n._totalVertices=new $e,n._activeIndices=new $e,n._activeParticles=new $e,n._activeBones=new $e,n._animationTime=0,n.animationTimeScale=1,n._renderId=0,n._frameId=0,n._executeWhenReadyTimeoutId=null,n._intermediateRendering=!1,n._defaultFrameBufferCleared=!1,n._viewUpdateFlag=-1,n._projectionUpdateFlag=-1,n._toBeDisposed=new Array(256),n._activeRequests=new Array,n._pendingData=new Array,n._isDisposed=!1,n.dispatchAllSubMeshesOfActiveMeshes=!1,n._activeMeshes=new Je(256),n._processedMaterials=new Je(256),n._renderTargets=new rr(256),n._materialsRenderTargets=new rr(256),n._activeParticleSystems=new Je(256),n._activeSkeletons=new rr(32),n._softwareSkinnedMeshes=new rr(32),n._activeAnimatables=new Array,n._transformMatrix=G.Zero(),n.requireLightSorting=!1,n._components=[],n._serializableComponents=[],n._transientComponents=[],n._beforeCameraUpdateStage=Ge.Create(),n._beforeClearStage=Ge.Create(),n._beforeRenderTargetClearStage=Ge.Create(),n._gatherRenderTargetsStage=Ge.Create(),n._gatherActiveCameraRenderTargetsStage=Ge.Create(),n._isReadyForMeshStage=Ge.Create(),n._beforeEvaluateActiveMeshStage=Ge.Create(),n._evaluateSubMeshStage=Ge.Create(),n._preActiveMeshStage=Ge.Create(),n._cameraDrawRenderTargetStage=Ge.Create(),n._beforeCameraDrawStage=Ge.Create(),n._beforeRenderTargetDrawStage=Ge.Create(),n._beforeRenderingGroupDrawStage=Ge.Create(),n._beforeRenderingMeshStage=Ge.Create(),n._afterRenderingMeshStage=Ge.Create(),n._afterRenderingGroupDrawStage=Ge.Create(),n._afterCameraDrawStage=Ge.Create(),n._afterRenderTargetDrawStage=Ge.Create(),n._afterRenderStage=Ge.Create(),n._pointerMoveStage=Ge.Create(),n._pointerDownStage=Ge.Create(),n._pointerUpStage=Ge.Create(),n._geometriesByUniqueId=null,n._defaultMeshCandidates={data:[],length:0},n._defaultSubMeshCandidates={data:[],length:0},n._preventFreeActiveMeshesAndRenderingGroups=!1,n._activeMeshesFrozen=!1,n._skipEvaluateActiveMeshesCompletely=!1,n._allowPostProcessClearColor=!0,n.getDeterministicFrameTime=function(){return n._engine.getTimeStep()},n._blockMaterialDirtyMechanism=!1,n._perfCollector=null,n.onComputePressureChanged=new X;var a=Ue({useGeometryUniqueIdsMap:!0,useMaterialMeshMap:!0,useClonedMeshMap:!0,virtual:!1},r);return n._engine=t||ye.LastCreatedEngine,a.virtual?n._engine._virtualScenes.push(n):(ye._LastCreatedScene=n,n._engine.scenes.push(n)),n._uid=null,n._renderingManager=new Jr(n),$r&&(n.postProcessManager=new $r(n)),ze()&&n.attachControl(),n._createUbo(),Tt&&(n._imageProcessingConfiguration=new Tt),n.setDefaultCandidateProviders(),a.useGeometryUniqueIdsMap&&(n._geometriesByUniqueId={}),n.useMaterialMeshMap=a.useMaterialMeshMap,n.useClonedMeshMap=a.useClonedMeshMap,(!r||!r.virtual)&&n._engine.onNewSceneAddedObservable.notifyObservers(n),zn.IsAvailable&&(n._computePressureObserver=new zn(function(s){n.onComputePressureChanged.notifyObservers(s)},{cpuUtilizationThresholds:[.25,.5,.75,.9],cpuSpeedThresholds:[.5]}),n._computePressureObserver.observe()),n}return e.DefaultMaterialFactory=function(t){throw he("StandardMaterial")},e.CollisionCoordinatorFactory=function(){throw he("DefaultCollisionCoordinator")},Object.defineProperty(e.prototype,"environmentTexture",{get:function(){return this._environmentTexture},set:function(t){this._environmentTexture!==t&&(this._environmentTexture=t,this.markAllMaterialsAsDirty(1))},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"imageProcessingConfiguration",{get:function(){return this._imageProcessingConfiguration},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"forceWireframe",{get:function(){return this._forceWireframe},set:function(t){this._forceWireframe!==t&&(this._forceWireframe=t,this.markAllMaterialsAsDirty(16))},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"skipFrustumClipping",{get:function(){return this._skipFrustumClipping},set:function(t){this._skipFrustumClipping!==t&&(this._skipFrustumClipping=t)},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"forcePointsCloud",{get:function(){return this._forcePointsCloud},set:function(t){this._forcePointsCloud!==t&&(this._forcePointsCloud=t,this.markAllMaterialsAsDirty(16))},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"animationPropertiesOverride",{get:function(){return this._animationPropertiesOverride},set:function(t){this._animationPropertiesOverride=t},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"onDispose",{set:function(t){this._onDisposeObserver&&this.onDisposeObservable.remove(this._onDisposeObserver),this._onDisposeObserver=this.onDisposeObservable.add(t)},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"beforeRender",{set:function(t){this._onBeforeRenderObserver&&this.onBeforeRenderObservable.remove(this._onBeforeRenderObserver),t&&(this._onBeforeRenderObserver=this.onBeforeRenderObservable.add(t))},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"afterRender",{set:function(t){this._onAfterRenderObserver&&this.onAfterRenderObservable.remove(this._onAfterRenderObserver),t&&(this._onAfterRenderObserver=this.onAfterRenderObservable.add(t))},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"beforeCameraRender",{set:function(t){this._onBeforeCameraRenderObserver&&this.onBeforeCameraRenderObservable.remove(this._onBeforeCameraRenderObserver),this._onBeforeCameraRenderObserver=this.onBeforeCameraRenderObservable.add(t)},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"afterCameraRender",{set:function(t){this._onAfterCameraRenderObserver&&this.onAfterCameraRenderObservable.remove(this._onAfterCameraRenderObserver),this._onAfterCameraRenderObserver=this.onAfterCameraRenderObservable.add(t)},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"unTranslatedPointer",{get:function(){return this._inputManager.unTranslatedPointer},enumerable:!1,configurable:!0}),Object.defineProperty(e,"DragMovementThreshold",{get:function(){return Dt.DragMovementThreshold},set:function(t){Dt.DragMovementThreshold=t},enumerable:!1,configurable:!0}),Object.defineProperty(e,"LongPressDelay",{get:function(){return Dt.LongPressDelay},set:function(t){Dt.LongPressDelay=t},enumerable:!1,configurable:!0}),Object.defineProperty(e,"DoubleClickDelay",{get:function(){return Dt.DoubleClickDelay},set:function(t){Dt.DoubleClickDelay=t},enumerable:!1,configurable:!0}),Object.defineProperty(e,"ExclusiveDoubleClickMode",{get:function(){return Dt.ExclusiveDoubleClickMode},set:function(t){Dt.ExclusiveDoubleClickMode=t},enumerable:!1,configurable:!0}),e.prototype.bindEyePosition=function(t,r,n){var a;r===void 0&&(r="vEyePosition"),n===void 0&&(n=!1);var s=this._forcedViewPosition?this._forcedViewPosition:this._mirroredCameraPosition?this._mirroredCameraPosition:(a=this.activeCamera.globalPosition)!==null&&a!==void 0?a:this.activeCamera.devicePosition,o=this.useRightHandedSystem===(this._mirroredCameraPosition!=null);return U.Vector4[0].set(s.x,s.y,s.z,o?-1:1),t&&(n?t.setFloat3(r,U.Vector4[0].x,U.Vector4[0].y,U.Vector4[0].z):t.setVector4(r,U.Vector4[0])),U.Vector4[0]},e.prototype.finalizeSceneUbo=function(){var t=this.getSceneUniformBuffer(),r=this.bindEyePosition(null);return t.updateFloat4("vEyePosition",r.x,r.y,r.z,r.w),t.update(),t},Object.defineProperty(e.prototype,"useRightHandedSystem",{get:function(){return this._useRightHandedSystem},set:function(t){this._useRightHandedSystem!==t&&(this._useRightHandedSystem=t,this.markAllMaterialsAsDirty(16))},enumerable:!1,configurable:!0}),e.prototype.setStepId=function(t){this._currentStepId=t},e.prototype.getStepId=function(){return this._currentStepId},e.prototype.getInternalStep=function(){return this._currentInternalStep},Object.defineProperty(e.prototype,"fogEnabled",{get:function(){return this._fogEnabled},set:function(t){this._fogEnabled!==t&&(this._fogEnabled=t,this.markAllMaterialsAsDirty(16))},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"fogMode",{get:function(){return this._fogMode},set:function(t){this._fogMode!==t&&(this._fogMode=t,this.markAllMaterialsAsDirty(16))},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"prePass",{get:function(){return!!this.prePassRenderer&&this.prePassRenderer.defaultRT.enabled},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"shadowsEnabled",{get:function(){return this._shadowsEnabled},set:function(t){this._shadowsEnabled!==t&&(this._shadowsEnabled=t,this.markAllMaterialsAsDirty(2))},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"lightsEnabled",{get:function(){return this._lightsEnabled},set:function(t){this._lightsEnabled!==t&&(this._lightsEnabled=t,this.markAllMaterialsAsDirty(2))},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"activeCamera",{get:function(){return this._activeCamera},set:function(t){t!==this._activeCamera&&(this._activeCamera=t,this.onActiveCameraChanged.notifyObservers(this))},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"defaultMaterial",{get:function(){return this._defaultMaterial||(this._defaultMaterial=e.DefaultMaterialFactory(this)),this._defaultMaterial},set:function(t){this._defaultMaterial=t},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"texturesEnabled",{get:function(){return this._texturesEnabled},set:function(t){this._texturesEnabled!==t&&(this._texturesEnabled=t,this.markAllMaterialsAsDirty(1))},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"skeletonsEnabled",{get:function(){return this._skeletonsEnabled},set:function(t){this._skeletonsEnabled!==t&&(this._skeletonsEnabled=t,this.markAllMaterialsAsDirty(8))},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"collisionCoordinator",{get:function(){return this._collisionCoordinator||(this._collisionCoordinator=e.CollisionCoordinatorFactory(),this._collisionCoordinator.init(this)),this._collisionCoordinator},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"frustumPlanes",{get:function(){return this._frustumPlanes},enumerable:!1,configurable:!0}),e.prototype._registerTransientComponents=function(){if(this._transientComponents.length>0){for(var t=0,r=this._transientComponents;t<r.length;t++){var n=r[t];n.register()}this._transientComponents=[]}},e.prototype._addComponent=function(t){this._components.push(t),this._transientComponents.push(t);var r=t;r.addFromContainer&&r.serialize&&this._serializableComponents.push(r)},e.prototype._getComponent=function(t){for(var r=0,n=this._components;r<n.length;r++){var a=n[r];if(a.name===t)return a}return null},e.prototype.getClassName=function(){return"Scene"},e.prototype._getDefaultMeshCandidates=function(){return this._defaultMeshCandidates.data=this.meshes,this._defaultMeshCandidates.length=this.meshes.length,this._defaultMeshCandidates},e.prototype._getDefaultSubMeshCandidates=function(t){return this._defaultSubMeshCandidates.data=t.subMeshes,this._defaultSubMeshCandidates.length=t.subMeshes.length,this._defaultSubMeshCandidates},e.prototype.setDefaultCandidateProviders=function(){this.getActiveMeshCandidates=this._getDefaultMeshCandidates.bind(this),this.getActiveSubMeshCandidates=this._getDefaultSubMeshCandidates.bind(this),this.getIntersectingSubMeshCandidates=this._getDefaultSubMeshCandidates.bind(this),this.getCollidingSubMeshCandidates=this._getDefaultSubMeshCandidates.bind(this)},Object.defineProperty(e.prototype,"meshUnderPointer",{get:function(){return this._inputManager.meshUnderPointer},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"pointerX",{get:function(){return this._inputManager.pointerX},set:function(t){this._inputManager.pointerX=t},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"pointerY",{get:function(){return this._inputManager.pointerY},set:function(t){this._inputManager.pointerY=t},enumerable:!1,configurable:!0}),e.prototype.getCachedMaterial=function(){return this._cachedMaterial},e.prototype.getCachedEffect=function(){return this._cachedEffect},e.prototype.getCachedVisibility=function(){return this._cachedVisibility},e.prototype.isCachedMaterialInvalid=function(t,r,n){return n===void 0&&(n=1),this._cachedEffect!==r||this._cachedMaterial!==t||this._cachedVisibility!==n},e.prototype.getEngine=function(){return this._engine},e.prototype.getTotalVertices=function(){return this._totalVertices.current},Object.defineProperty(e.prototype,"totalVerticesPerfCounter",{get:function(){return this._totalVertices},enumerable:!1,configurable:!0}),e.prototype.getActiveIndices=function(){return this._activeIndices.current},Object.defineProperty(e.prototype,"totalActiveIndicesPerfCounter",{get:function(){return this._activeIndices},enumerable:!1,configurable:!0}),e.prototype.getActiveParticles=function(){return this._activeParticles.current},Object.defineProperty(e.prototype,"activeParticlesPerfCounter",{get:function(){return this._activeParticles},enumerable:!1,configurable:!0}),e.prototype.getActiveBones=function(){return this._activeBones.current},Object.defineProperty(e.prototype,"activeBonesPerfCounter",{get:function(){return this._activeBones},enumerable:!1,configurable:!0}),e.prototype.getActiveMeshes=function(){return this._activeMeshes},e.prototype.getAnimationRatio=function(){return this._animationRatio!==void 0?this._animationRatio:1},e.prototype.getRenderId=function(){return this._renderId},e.prototype.getFrameId=function(){return this._frameId},e.prototype.incrementRenderId=function(){this._renderId++},e.prototype._createUbo=function(){this.setSceneUniformBuffer(this.createSceneUniformBuffer())},e.prototype.simulatePointerMove=function(t,r){return this._inputManager.simulatePointerMove(t,r),this},e.prototype.simulatePointerDown=function(t,r){return this._inputManager.simulatePointerDown(t,r),this},e.prototype.simulatePointerUp=function(t,r,n){return this._inputManager.simulatePointerUp(t,r,n),this},e.prototype.isPointerCaptured=function(t){return t===void 0&&(t=0),this._inputManager.isPointerCaptured(t)},e.prototype.attachControl=function(t,r,n){t===void 0&&(t=!0),r===void 0&&(r=!0),n===void 0&&(n=!0),this._inputManager.attachControl(t,r,n)},e.prototype.detachControl=function(){this._inputManager.detachControl()},e.prototype.isReady=function(t){if(t===void 0&&(t=!0),this._isDisposed)return!1;var r,n=this.getEngine();if(this._pendingData.length>0)return!1;t&&(this._processedMaterials.reset(),this._materialsRenderTargets.reset());var a=!0;for(r=0;r<this.meshes.length;r++){var s=this.meshes[r];if(!!s.isEnabled()&&!(!s.subMeshes||s.subMeshes.length===0)){if(!s.isReady(!0)){a=!1;continue}for(var o=s.hasThinInstances||s.getClassName()==="InstancedMesh"||s.getClassName()==="InstancedLinesMesh"||n.getCaps().instancedArrays&&s.instances.length>0,l=0,u=this._isReadyForMeshStage;l<u.length;l++){var f=u[l];f.action(s,o)||(a=!1)}if(!!t){var h=s.material||this.defaultMaterial;if(h)if(h._storeEffectOnSubMeshes)for(var c=0,d=s.subMeshes;c<d.length;c++){var p=d[c],_=p.getMaterial();_&&_.hasRenderTargetTextures&&_.getRenderTargetTextures!=null&&this._processedMaterials.indexOf(_)===-1&&(this._processedMaterials.push(_),this._materialsRenderTargets.concatWithNoDuplicate(_.getRenderTargetTextures()))}else h.hasRenderTargetTextures&&h.getRenderTargetTextures!=null&&this._processedMaterials.indexOf(h)===-1&&(this._processedMaterials.push(h),this._materialsRenderTargets.concatWithNoDuplicate(h.getRenderTargetTextures()))}}}if(!a||!n.areAllEffectsReady())return!1;if(t)for(r=0;r<this._materialsRenderTargets.length;++r){var g=this._materialsRenderTargets.data[r];if(!g.isReadyForRendering())return!1}for(r=0;r<this.geometries.length;r++){var v=this.geometries[r];if(v.delayLoadState===2)return!1}if(this.activeCameras&&this.activeCameras.length>0)for(var y=0,b=this.activeCameras;y<b.length;y++){var E=b[y];if(!E.isReady(!0))return!1}else if(this.activeCamera&&!this.activeCamera.isReady(!0))return!1;for(var A=0,S=this.particleSystems;A<S.length;A++){var T=S[A];if(!T.isReady())return!1}return!0},e.prototype.resetCachedMaterial=function(){this._cachedMaterial=null,this._cachedEffect=null,this._cachedVisibility=null},e.prototype.registerBeforeRender=function(t){this.onBeforeRenderObservable.add(t)},e.prototype.unregisterBeforeRender=function(t){this.onBeforeRenderObservable.removeCallback(t)},e.prototype.registerAfterRender=function(t){this.onAfterRenderObservable.add(t)},e.prototype.unregisterAfterRender=function(t){this.onAfterRenderObservable.removeCallback(t)},e.prototype._executeOnceBeforeRender=function(t){var r=this,n=function(){t(),setTimeout(function(){r.unregisterBeforeRender(n)})};this.registerBeforeRender(n)},e.prototype.executeOnceBeforeRender=function(t,r){var n=this;r!==void 0?setTimeout(function(){n._executeOnceBeforeRender(t)},r):this._executeOnceBeforeRender(t)},e.prototype._addPendingData=function(t){this._pendingData.push(t)},e.prototype._removePendingData=function(t){var r=this.isLoading,n=this._pendingData.indexOf(t);n!==-1&&this._pendingData.splice(n,1),r&&!this.isLoading&&this.onDataLoadedObservable.notifyObservers(this)},e.prototype.getWaitingItemsCount=function(){return this._pendingData.length},Object.defineProperty(e.prototype,"isLoading",{get:function(){return this._pendingData.length>0},enumerable:!1,configurable:!0}),e.prototype.executeWhenReady=function(t,r){var n=this;r===void 0&&(r=!1),this.onReadyObservable.add(t),this._executeWhenReadyTimeoutId===null&&(this._executeWhenReadyTimeoutId=setTimeout(function(){n._checkIsReady(r)},150))},e.prototype.whenReadyAsync=function(t){var r=this;return t===void 0&&(t=!1),new Promise(function(n){r.executeWhenReady(function(){n()},t)})},e.prototype._checkIsReady=function(t){var r=this;if(t===void 0&&(t=!1),this._registerTransientComponents(),this.isReady(t)){this.onReadyObservable.notifyObservers(this),this.onReadyObservable.clear(),this._executeWhenReadyTimeoutId=null;return}if(this._isDisposed){this.onReadyObservable.clear(),this._executeWhenReadyTimeoutId=null;return}this._executeWhenReadyTimeoutId=setTimeout(function(){r._checkIsReady(t)},100)},Object.defineProperty(e.prototype,"animatables",{get:function(){return this._activeAnimatables},enumerable:!1,configurable:!0}),e.prototype.resetLastAnimationTimeFrame=function(){this._animationTimeLast=nt.Now},e.prototype.getViewMatrix=function(){return this._viewMatrix},e.prototype.getProjectionMatrix=function(){return this._projectionMatrix},e.prototype.getTransformMatrix=function(){return this._transformMatrix},e.prototype.setTransformMatrix=function(t,r,n,a){!n&&!a&&this._multiviewSceneUbo&&(this._multiviewSceneUbo.dispose(),this._multiviewSceneUbo=null),!(this._viewUpdateFlag===t.updateFlag&&this._projectionUpdateFlag===r.updateFlag)&&(this._viewUpdateFlag=t.updateFlag,this._projectionUpdateFlag=r.updateFlag,this._viewMatrix=t,this._projectionMatrix=r,this._viewMatrix.multiplyToRef(this._projectionMatrix,this._transformMatrix),this._frustumPlanes?Qr.GetPlanesToRef(this._transformMatrix,this._frustumPlanes):this._frustumPlanes=Qr.GetPlanes(this._transformMatrix),this._multiviewSceneUbo&&this._multiviewSceneUbo.useUbo?this._updateMultiviewUbo(n,a):this._sceneUbo.useUbo&&(this._sceneUbo.updateMatrix("viewProjection",this._transformMatrix),this._sceneUbo.updateMatrix("view",this._viewMatrix),this._sceneUbo.updateMatrix("projection",this._projectionMatrix)))},e.prototype.getSceneUniformBuffer=function(){return this._multiviewSceneUbo?this._multiviewSceneUbo:this._sceneUbo},e.prototype.createSceneUniformBuffer=function(t){var r=new si(this._engine,void 0,!1,t!=null?t:"scene");return r.addUniform("viewProjection",16),r.addUniform("view",16),r.addUniform("projection",16),r.addUniform("vEyePosition",4),r},e.prototype.setSceneUniformBuffer=function(t){this._sceneUbo=t,this._viewUpdateFlag=-1,this._projectionUpdateFlag=-1},e.prototype.getUniqueId=function(){return ol.UniqueId},e.prototype.addMesh=function(t,r){var n=this;r===void 0&&(r=!1),!this._blockEntityCollection&&(this.meshes.push(t),t._resyncLightSources(),t.parent||t._addToSceneRootNodes(),this.onNewMeshAddedObservable.notifyObservers(t),r&&t.getChildMeshes().forEach(function(a){n.addMesh(a)}))},e.prototype.removeMesh=function(t,r){var n=this;r===void 0&&(r=!1);var a=this.meshes.indexOf(t);return a!==-1&&(this.meshes[a]=this.meshes[this.meshes.length-1],this.meshes.pop(),t.parent||t._removeFromSceneRootNodes()),this._inputManager._invalidateMesh(t),this.onMeshRemovedObservable.notifyObservers(t),r&&t.getChildMeshes().forEach(function(s){n.removeMesh(s)}),a},e.prototype.addTransformNode=function(t){this._blockEntityCollection||t.getScene()===this&&t._indexInSceneTransformNodesArray!==-1||(t._indexInSceneTransformNodesArray=this.transformNodes.length,this.transformNodes.push(t),t.parent||t._addToSceneRootNodes(),this.onNewTransformNodeAddedObservable.notifyObservers(t))},e.prototype.removeTransformNode=function(t){var r=t._indexInSceneTransformNodesArray;if(r!==-1){if(r!==this.transformNodes.length-1){var n=this.transformNodes[this.transformNodes.length-1];this.transformNodes[r]=n,n._indexInSceneTransformNodesArray=r}t._indexInSceneTransformNodesArray=-1,this.transformNodes.pop(),t.parent||t._removeFromSceneRootNodes()}return this.onTransformNodeRemovedObservable.notifyObservers(t),r},e.prototype.removeSkeleton=function(t){var r=this.skeletons.indexOf(t);return r!==-1&&(this.skeletons.splice(r,1),this.onSkeletonRemovedObservable.notifyObservers(t),this._executeActiveContainerCleanup(this._activeSkeletons)),r},e.prototype.removeMorphTargetManager=function(t){var r=this.morphTargetManagers.indexOf(t);return r!==-1&&this.morphTargetManagers.splice(r,1),r},e.prototype.removeLight=function(t){var r=this.lights.indexOf(t);if(r!==-1){for(var n=0,a=this.meshes;n<a.length;n++){var s=a[n];s._removeLightSource(t,!1)}this.lights.splice(r,1),this.sortLightsByPriority(),t.parent||t._removeFromSceneRootNodes()}return this.onLightRemovedObservable.notifyObservers(t),r},e.prototype.removeCamera=function(t){var r=this.cameras.indexOf(t);if(r!==-1&&(this.cameras.splice(r,1),t.parent||t._removeFromSceneRootNodes()),this.activeCameras){var n=this.activeCameras.indexOf(t);n!==-1&&this.activeCameras.splice(n,1)}return this.activeCamera===t&&(this.cameras.length>0?this.activeCamera=this.cameras[0]:this.activeCamera=null),this.onCameraRemovedObservable.notifyObservers(t),r},e.prototype.removeParticleSystem=function(t){var r=this.particleSystems.indexOf(t);return r!==-1&&(this.particleSystems.splice(r,1),this._executeActiveContainerCleanup(this._activeParticleSystems)),r},e.prototype.removeAnimation=function(t){var r=this.animations.indexOf(t);return r!==-1&&this.animations.splice(r,1),r},e.prototype.stopAnimation=function(t,r,n){},e.prototype.removeAnimationGroup=function(t){var r=this.animationGroups.indexOf(t);return r!==-1&&this.animationGroups.splice(r,1),r},e.prototype.removeMultiMaterial=function(t){var r=this.multiMaterials.indexOf(t);return r!==-1&&this.multiMaterials.splice(r,1),this.onMultiMaterialRemovedObservable.notifyObservers(t),r},e.prototype.removeMaterial=function(t){var r=t._indexInSceneMaterialArray;if(r!==-1&&r<this.materials.length){if(r!==this.materials.length-1){var n=this.materials[this.materials.length-1];this.materials[r]=n,n._indexInSceneMaterialArray=r}t._indexInSceneMaterialArray=-1,this.materials.pop()}return this.onMaterialRemovedObservable.notifyObservers(t),r},e.prototype.removeActionManager=function(t){var r=this.actionManagers.indexOf(t);return r!==-1&&this.actionManagers.splice(r,1),r},e.prototype.removeTexture=function(t){var r=this.textures.indexOf(t);return r!==-1&&this.textures.splice(r,1),this.onTextureRemovedObservable.notifyObservers(t),r},e.prototype.addLight=function(t){if(!this._blockEntityCollection){this.lights.push(t),this.sortLightsByPriority(),t.parent||t._addToSceneRootNodes();for(var r=0,n=this.meshes;r<n.length;r++){var a=n[r];a.lightSources.indexOf(t)===-1&&(a.lightSources.push(t),a._resyncLightSources())}this.onNewLightAddedObservable.notifyObservers(t)}},e.prototype.sortLightsByPriority=function(){this.requireLightSorting&&this.lights.sort(Ze.CompareLightsPriority)},e.prototype.addCamera=function(t){this._blockEntityCollection||(this.cameras.push(t),this.onNewCameraAddedObservable.notifyObservers(t),t.parent||t._addToSceneRootNodes())},e.prototype.addSkeleton=function(t){this._blockEntityCollection||(this.skeletons.push(t),this.onNewSkeletonAddedObservable.notifyObservers(t))},e.prototype.addParticleSystem=function(t){this._blockEntityCollection||this.particleSystems.push(t)},e.prototype.addAnimation=function(t){this._blockEntityCollection||this.animations.push(t)},e.prototype.addAnimationGroup=function(t){this._blockEntityCollection||this.animationGroups.push(t)},e.prototype.addMultiMaterial=function(t){this._blockEntityCollection||(this.multiMaterials.push(t),this.onNewMultiMaterialAddedObservable.notifyObservers(t))},e.prototype.addMaterial=function(t){this._blockEntityCollection||t.getScene()===this&&t._indexInSceneMaterialArray!==-1||(t._indexInSceneMaterialArray=this.materials.length,this.materials.push(t),this.onNewMaterialAddedObservable.notifyObservers(t))},e.prototype.addMorphTargetManager=function(t){this._blockEntityCollection||this.morphTargetManagers.push(t)},e.prototype.addGeometry=function(t){this._blockEntityCollection||(this._geometriesByUniqueId&&(this._geometriesByUniqueId[t.uniqueId]=this.geometries.length),this.geometries.push(t))},e.prototype.addActionManager=function(t){this.actionManagers.push(t)},e.prototype.addTexture=function(t){this._blockEntityCollection||(this.textures.push(t),this.onNewTextureAddedObservable.notifyObservers(t))},e.prototype.switchActiveCamera=function(t,r){r===void 0&&(r=!0);var n=this._engine.getInputElement();!n||(this.activeCamera&&this.activeCamera.detachControl(),this.activeCamera=t,r&&t.attachControl())},e.prototype.setActiveCameraById=function(t){var r=this.getCameraById(t);return r?(this.activeCamera=r,r):null},e.prototype.setActiveCameraByName=function(t){var r=this.getCameraByName(t);return r?(this.activeCamera=r,r):null},e.prototype.getAnimationGroupByName=function(t){for(var r=0;r<this.animationGroups.length;r++)if(this.animationGroups[r].name===t)return this.animationGroups[r];return null},e.prototype.getMaterialByUniqueID=function(t){for(var r=0;r<this.materials.length;r++)if(this.materials[r].uniqueId===t)return this.materials[r];return null},e.prototype.getMaterialById=function(t){for(var r=0;r<this.materials.length;r++)if(this.materials[r].id===t)return this.materials[r];return null},e.prototype.getLastMaterialById=function(t,r){r===void 0&&(r=!1);for(var n=this.materials.length-1;n>=0;n--)if(this.materials[n].id===t)return this.materials[n];if(r){for(var n=this.multiMaterials.length-1;n>=0;n--)if(this.multiMaterials[n].id===t)return this.multiMaterials[n]}return null},e.prototype.getMaterialByName=function(t){for(var r=0;r<this.materials.length;r++)if(this.materials[r].name===t)return this.materials[r];return null},e.prototype.getTextureByUniqueId=function(t){for(var r=0;r<this.textures.length;r++)if(this.textures[r].uniqueId===t)return this.textures[r];return null},e.prototype.getTextureByName=function(t){for(var r=0;r<this.textures.length;r++)if(this.textures[r].name===t)return this.textures[r];return null},e.prototype.getCameraById=function(t){for(var r=0;r<this.cameras.length;r++)if(this.cameras[r].id===t)return this.cameras[r];return null},e.prototype.getCameraByUniqueId=function(t){for(var r=0;r<this.cameras.length;r++)if(this.cameras[r].uniqueId===t)return this.cameras[r];return null},e.prototype.getCameraByName=function(t){for(var r=0;r<this.cameras.length;r++)if(this.cameras[r].name===t)return this.cameras[r];return null},e.prototype.getBoneById=function(t){for(var r=0;r<this.skeletons.length;r++)for(var n=this.skeletons[r],a=0;a<n.bones.length;a++)if(n.bones[a].id===t)return n.bones[a];return null},e.prototype.getBoneByName=function(t){for(var r=0;r<this.skeletons.length;r++)for(var n=this.skeletons[r],a=0;a<n.bones.length;a++)if(n.bones[a].name===t)return n.bones[a];return null},e.prototype.getLightByName=function(t){for(var r=0;r<this.lights.length;r++)if(this.lights[r].name===t)return this.lights[r];return null},e.prototype.getLightById=function(t){for(var r=0;r<this.lights.length;r++)if(this.lights[r].id===t)return this.lights[r];return null},e.prototype.getLightByUniqueId=function(t){for(var r=0;r<this.lights.length;r++)if(this.lights[r].uniqueId===t)return this.lights[r];return null},e.prototype.getParticleSystemById=function(t){for(var r=0;r<this.particleSystems.length;r++)if(this.particleSystems[r].id===t)return this.particleSystems[r];return null},e.prototype.getGeometryById=function(t){for(var r=0;r<this.geometries.length;r++)if(this.geometries[r].id===t)return this.geometries[r];return null},e.prototype._getGeometryByUniqueId=function(t){if(this._geometriesByUniqueId){var r=this._geometriesByUniqueId[t];if(r!==void 0)return this.geometries[r]}else for(var r=0;r<this.geometries.length;r++)if(this.geometries[r].uniqueId===t)return this.geometries[r];return null},e.prototype.pushGeometry=function(t,r){return!r&&this._getGeometryByUniqueId(t.uniqueId)?!1:(this.addGeometry(t),this.onNewGeometryAddedObservable.notifyObservers(t),!0)},e.prototype.removeGeometry=function(t){var r;if(this._geometriesByUniqueId){if(r=this._geometriesByUniqueId[t.uniqueId],r===void 0)return!1}else if(r=this.geometries.indexOf(t),r<0)return!1;if(r!==this.geometries.length-1){var n=this.geometries[this.geometries.length-1];n&&(this.geometries[r]=n,this._geometriesByUniqueId&&(this._geometriesByUniqueId[n.uniqueId]=r,this._geometriesByUniqueId[t.uniqueId]=void 0))}return this.geometries.pop(),this.onGeometryRemovedObservable.notifyObservers(t),!0},e.prototype.getGeometries=function(){return this.geometries},e.prototype.getMeshById=function(t){for(var r=0;r<this.meshes.length;r++)if(this.meshes[r].id===t)return this.meshes[r];return null},e.prototype.getMeshesById=function(t){return this.meshes.filter(function(r){return r.id===t})},e.prototype.getTransformNodeById=function(t){for(var r=0;r<this.transformNodes.length;r++)if(this.transformNodes[r].id===t)return this.transformNodes[r];return null},e.prototype.getTransformNodeByUniqueId=function(t){for(var r=0;r<this.transformNodes.length;r++)if(this.transformNodes[r].uniqueId===t)return this.transformNodes[r];return null},e.prototype.getTransformNodesById=function(t){return this.transformNodes.filter(function(r){return r.id===t})},e.prototype.getMeshByUniqueId=function(t){for(var r=0;r<this.meshes.length;r++)if(this.meshes[r].uniqueId===t)return this.meshes[r];return null},e.prototype.getLastMeshById=function(t){for(var r=this.meshes.length-1;r>=0;r--)if(this.meshes[r].id===t)return this.meshes[r];return null},e.prototype.getLastEntryById=function(t){var r;for(r=this.meshes.length-1;r>=0;r--)if(this.meshes[r].id===t)return this.meshes[r];for(r=this.transformNodes.length-1;r>=0;r--)if(this.transformNodes[r].id===t)return this.transformNodes[r];for(r=this.cameras.length-1;r>=0;r--)if(this.cameras[r].id===t)return this.cameras[r];for(r=this.lights.length-1;r>=0;r--)if(this.lights[r].id===t)return this.lights[r];return null},e.prototype.getNodeById=function(t){var r=this.getMeshById(t);if(r)return r;var n=this.getTransformNodeById(t);if(n)return n;var a=this.getLightById(t);if(a)return a;var s=this.getCameraById(t);if(s)return s;var o=this.getBoneById(t);return o||null},e.prototype.getNodeByName=function(t){var r=this.getMeshByName(t);if(r)return r;var n=this.getTransformNodeByName(t);if(n)return n;var a=this.getLightByName(t);if(a)return a;var s=this.getCameraByName(t);if(s)return s;var o=this.getBoneByName(t);return o||null},e.prototype.getMeshByName=function(t){for(var r=0;r<this.meshes.length;r++)if(this.meshes[r].name===t)return this.meshes[r];return null},e.prototype.getTransformNodeByName=function(t){for(var r=0;r<this.transformNodes.length;r++)if(this.transformNodes[r].name===t)return this.transformNodes[r];return null},e.prototype.getLastSkeletonById=function(t){for(var r=this.skeletons.length-1;r>=0;r--)if(this.skeletons[r].id===t)return this.skeletons[r];return null},e.prototype.getSkeletonByUniqueId=function(t){for(var r=0;r<this.skeletons.length;r++)if(this.skeletons[r].uniqueId===t)return this.skeletons[r];return null},e.prototype.getSkeletonById=function(t){for(var r=0;r<this.skeletons.length;r++)if(this.skeletons[r].id===t)return this.skeletons[r];return null},e.prototype.getSkeletonByName=function(t){for(var r=0;r<this.skeletons.length;r++)if(this.skeletons[r].name===t)return this.skeletons[r];return null},e.prototype.getMorphTargetManagerById=function(t){for(var r=0;r<this.morphTargetManagers.length;r++)if(this.morphTargetManagers[r].uniqueId===t)return this.morphTargetManagers[r];return null},e.prototype.getMorphTargetById=function(t){for(var r=0;r<this.morphTargetManagers.length;++r)for(var n=this.morphTargetManagers[r],a=0;a<n.numTargets;++a){var s=n.getTarget(a);if(s.id===t)return s}return null},e.prototype.getMorphTargetByName=function(t){for(var r=0;r<this.morphTargetManagers.length;++r)for(var n=this.morphTargetManagers[r],a=0;a<n.numTargets;++a){var s=n.getTarget(a);if(s.name===t)return s}return null},e.prototype.getPostProcessByName=function(t){for(var r=0;r<this.postProcesses.length;++r){var n=this.postProcesses[r];if(n.name===t)return n}return null},e.prototype.isActiveMesh=function(t){return this._activeMeshes.indexOf(t)!==-1},Object.defineProperty(e.prototype,"uid",{get:function(){return this._uid||(this._uid=te.RandomId()),this._uid},enumerable:!1,configurable:!0}),e.prototype.addExternalData=function(t,r){return this._externalData||(this._externalData=new Ni),this._externalData.add(t,r)},e.prototype.getExternalData=function(t){return this._externalData?this._externalData.get(t):null},e.prototype.getOrAddExternalDataWithFactory=function(t,r){return this._externalData||(this._externalData=new Ni),this._externalData.getOrAddWithFactory(t,r)},e.prototype.removeExternalData=function(t){return this._externalData.remove(t)},e.prototype._evaluateSubMesh=function(t,r,n){if(n.hasInstances||n.isAnInstance||this.dispatchAllSubMeshesOfActiveMeshes||this._skipFrustumClipping||r.alwaysSelectAsActiveMesh||r.subMeshes.length===1||t.isInFrustum(this._frustumPlanes)){for(var a=0,s=this._evaluateSubMeshStage;a<s.length;a++){var o=s[a];o.action(r,t)}var l=t.getMaterial();l!=null&&(l.hasRenderTargetTextures&&l.getRenderTargetTextures!=null&&this._processedMaterials.indexOf(l)===-1&&(this._processedMaterials.push(l),this._materialsRenderTargets.concatWithNoDuplicate(l.getRenderTargetTextures())),this._renderingManager.dispatch(t,r,l))}},e.prototype.freeProcessedMaterials=function(){this._processedMaterials.dispose()},Object.defineProperty(e.prototype,"blockfreeActiveMeshesAndRenderingGroups",{get:function(){return this._preventFreeActiveMeshesAndRenderingGroups},set:function(t){this._preventFreeActiveMeshesAndRenderingGroups!==t&&(t&&(this.freeActiveMeshes(),this.freeRenderingGroups()),this._preventFreeActiveMeshesAndRenderingGroups=t)},enumerable:!1,configurable:!0}),e.prototype.freeActiveMeshes=function(){if(!this.blockfreeActiveMeshesAndRenderingGroups&&(this._activeMeshes.dispose(),this.activeCamera&&this.activeCamera._activeMeshes&&this.activeCamera._activeMeshes.dispose(),this.activeCameras))for(var t=0;t<this.activeCameras.length;t++){var r=this.activeCameras[t];r&&r._activeMeshes&&r._activeMeshes.dispose()}},e.prototype.freeRenderingGroups=function(){if(!this.blockfreeActiveMeshesAndRenderingGroups&&(this._renderingManager&&this._renderingManager.freeRenderingGroups(),this.textures))for(var t=0;t<this.textures.length;t++){var r=this.textures[t];r&&r.renderList&&r.freeRenderingGroups()}},e.prototype._isInIntermediateRendering=function(){return this._intermediateRendering},e.prototype.freezeActiveMeshes=function(t,r,n,a){var s=this;return t===void 0&&(t=!1),a===void 0&&(a=!0),this.executeWhenReady(function(){if(!s.activeCamera){n&&n("No active camera found");return}if(s._frustumPlanes||s.updateTransformMatrix(),s._evaluateActiveMeshes(),s._activeMeshesFrozen=!0,s._skipEvaluateActiveMeshesCompletely=t,a)for(var o=0;o<s._activeMeshes.length;o++)s._activeMeshes.data[o]._freeze();r&&r()}),this},e.prototype.unfreezeActiveMeshes=function(){for(var t=0;t<this.meshes.length;t++){var r=this.meshes[t];r._internalAbstractMeshDataInfo&&(r._internalAbstractMeshDataInfo._isActive=!1)}for(var t=0;t<this._activeMeshes.length;t++)this._activeMeshes.data[t]._unFreeze();return this._activeMeshesFrozen=!1,this},e.prototype._executeActiveContainerCleanup=function(t){var r=this._engine.snapshotRendering&&this._engine.snapshotRenderingMode===1;!r&&this._activeMeshesFrozen&&this._activeMeshes.length||this.onBeforeRenderObservable.addOnce(function(){return t.dispose()})},e.prototype._evaluateActiveMeshes=function(){var t;if(this._engine.snapshotRendering&&this._engine.snapshotRenderingMode===1){this._activeMeshes.length>0&&((t=this.activeCamera)===null||t===void 0||t._activeMeshes.reset(),this._activeMeshes.reset(),this._renderingManager.reset(),this._processedMaterials.reset(),this._activeParticleSystems.reset(),this._activeSkeletons.reset(),this._softwareSkinnedMeshes.reset());return}if(this._activeMeshesFrozen&&this._activeMeshes.length){if(!this._skipEvaluateActiveMeshesCompletely)for(var r=this._activeMeshes.length,n=0;n<r;n++){var a=this._activeMeshes.data[n];a.computeWorldMatrix()}if(this._activeParticleSystems)for(var s=this._activeParticleSystems.length,n=0;n<s;n++)this._activeParticleSystems.data[n].animate();return}if(!!this.activeCamera){this.onBeforeActiveMeshesEvaluationObservable.notifyObservers(this),this.activeCamera._activeMeshes.reset(),this._activeMeshes.reset(),this._renderingManager.reset(),this._processedMaterials.reset(),this._activeParticleSystems.reset(),this._activeSkeletons.reset(),this._softwareSkinnedMeshes.reset(),this._materialsRenderTargets.reset();for(var o=0,l=this._beforeEvaluateActiveMeshStage;o<l.length;o++){var u=l[o];u.action()}for(var f=this.getActiveMeshCandidates(),h=f.length,n=0;n<h;n++){var a=f.data[n];if(a._internalAbstractMeshDataInfo._currentLODIsUpToDate=!1,!a.isBlocked&&(this._totalVertices.addCount(a.getTotalVertices(),!1),!(!a.isReady()||!a.isEnabled()||a.scaling.lengthSquared()===0))){a.computeWorldMatrix(),a.actionManager&&a.actionManager.hasSpecificTriggers2(12,13)&&this._meshesForIntersections.pushNoDuplicate(a);var c=this.customLODSelector?this.customLODSelector(a,this.activeCamera):a.getLOD(this.activeCamera);if(a._internalAbstractMeshDataInfo._currentLOD=c,a._internalAbstractMeshDataInfo._currentLODIsUpToDate=!0,c!=null&&(c!==a&&c.billboardMode!==0&&c.computeWorldMatrix(),a._preActivate(),a.isVisible&&a.visibility>0&&(a.layerMask&this.activeCamera.layerMask)!==0&&(this._skipFrustumClipping||a.alwaysSelectAsActiveMesh||a.isInFrustum(this._frustumPlanes)))){this._activeMeshes.push(a),this.activeCamera._activeMeshes.push(a),c!==a&&c._activate(this._renderId,!1);for(var d=0,p=this._preActiveMeshStage;d<p.length;d++){var u=p[d];u.action(a)}a._activate(this._renderId,!1)&&(a.isAnInstance?a._internalAbstractMeshDataInfo._actAsRegularMesh&&(c=a):c._internalAbstractMeshDataInfo._onlyForInstances=!1,c._internalAbstractMeshDataInfo._isActive=!0,this._activeMesh(a,c)),a._postActivate()}}}if(this.onAfterActiveMeshesEvaluationObservable.notifyObservers(this),this.particlesEnabled){this.onBeforeParticlesRenderingObservable.notifyObservers(this);for(var _=0;_<this.particleSystems.length;_++){var g=this.particleSystems[_];if(!(!g.isStarted()||!g.emitter)){var v=g.emitter;(!v.position||v.isEnabled())&&(this._activeParticleSystems.push(g),g.animate(),this._renderingManager.dispatchParticles(g))}}this.onAfterParticlesRenderingObservable.notifyObservers(this)}}},e.prototype._activeMesh=function(t,r){if(this._skeletonsEnabled&&r.skeleton!==null&&r.skeleton!==void 0&&(this._activeSkeletons.pushNoDuplicate(r.skeleton)&&(r.skeleton.prepare(),this._activeBones.addCount(r.skeleton.bones.length,!1)),r.computeBonesUsingShaders||this._softwareSkinnedMeshes.pushNoDuplicate(r)),r!=null&&r.subMeshes!==void 0&&r.subMeshes!==null&&r.subMeshes.length>0)for(var n=this.getActiveSubMeshCandidates(r),a=n.length,s=0;s<a;s++){var o=n.data[s];this._evaluateSubMesh(o,r,t)}},e.prototype.updateTransformMatrix=function(t){if(!!this.activeCamera)if(this.activeCamera._renderingMultiview){var r=this.activeCamera._rigCameras[0],n=this.activeCamera._rigCameras[1];this.setTransformMatrix(r.getViewMatrix(),r.getProjectionMatrix(t),n.getViewMatrix(),n.getProjectionMatrix(t))}else this.setTransformMatrix(this.activeCamera.getViewMatrix(),this.activeCamera.getProjectionMatrix(t))},e.prototype._bindFrameBuffer=function(t,r){r===void 0&&(r=!0),t&&t._multiviewTexture?t._multiviewTexture._bindFrameBuffer():t&&t.outputRenderTarget?t.outputRenderTarget._bindFrameBuffer():this._engine._currentFrameBufferIsDefaultFrameBuffer()||this._engine.restoreDefaultFramebuffer(),r&&this._clearFrameBuffer(t)},e.prototype._clearFrameBuffer=function(t){if(!(t&&t._multiviewTexture))if(t&&t.outputRenderTarget){var r=t.outputRenderTarget;r.onClearObservable.hasObservers()?r.onClearObservable.notifyObservers(this._engine):r.skipInitialClear||(this._engine.clear(r.clearColor||this.clearColor,!r._cleared,!0,!0),r._cleared=!0)}else this._defaultFrameBufferCleared?this._engine.clear(null,!1,!0,!0):(this._defaultFrameBufferCleared=!0,this._clear())},e.prototype._renderForCamera=function(t,r,n){var a,s,o;if(n===void 0&&(n=!0),!(t&&t._skipRendering)){var l=this._engine;if(this._activeCamera=t,!this.activeCamera)throw new Error("Active camera not set");if(l.setViewport(this.activeCamera.viewport),this.resetCachedMaterial(),this._renderId++,!this.prePass&&n){var u=!0;t._renderingMultiview&&t.outputRenderTarget&&(u=t.outputRenderTarget.skipInitialClear,this.autoClear&&(t.outputRenderTarget.skipInitialClear=!1)),this._bindFrameBuffer(this._activeCamera),t._renderingMultiview&&t.outputRenderTarget&&(t.outputRenderTarget.skipInitialClear=u)}this.updateTransformMatrix(),this.onBeforeCameraRenderObservable.notifyObservers(this.activeCamera),this._evaluateActiveMeshes();for(var f=0;f<this._softwareSkinnedMeshes.length;f++){var h=this._softwareSkinnedMeshes.data[f];h.applySkeleton(h.skeleton)}this.onBeforeRenderTargetsRenderObservable.notifyObservers(this),this._renderTargets.concatWithNoDuplicate(this._materialsRenderTargets),t.customRenderTargets&&t.customRenderTargets.length>0&&this._renderTargets.concatWithNoDuplicate(t.customRenderTargets),r&&r.customRenderTargets&&r.customRenderTargets.length>0&&this._renderTargets.concatWithNoDuplicate(r.customRenderTargets),this.environmentTexture&&this.environmentTexture.isRenderTarget&&this._renderTargets.pushNoDuplicate(this.environmentTexture);for(var c=0,d=this._gatherActiveCameraRenderTargetsStage;c<d.length;c++){var p=d[c];p.action(this._renderTargets)}var _=!1;if(this.renderTargetsEnabled){if(this._intermediateRendering=!0,this._renderTargets.length>0){te.StartPerformanceCounter("Render targets",this._renderTargets.length>0);for(var g=0;g<this._renderTargets.length;g++){var v=this._renderTargets.data[g];if(v._shouldRender()){this._renderId++;var y=v.activeCamera&&v.activeCamera!==this.activeCamera;v.render(y,this.dumpNextRenderTargets),_=!0}}te.EndPerformanceCounter("Render targets",this._renderTargets.length>0),this._renderId++}for(var b=0,E=this._cameraDrawRenderTargetStage;b<E.length;b++){var p=E[b];_=p.action(this.activeCamera)||_}this._intermediateRendering=!1}this._engine.currentRenderPassId=(o=(s=(a=t.outputRenderTarget)===null||a===void 0?void 0:a.renderPassId)!==null&&s!==void 0?s:t.renderPassId)!==null&&o!==void 0?o:0,_&&!this.prePass&&this._bindFrameBuffer(this._activeCamera,!1),this.onAfterRenderTargetsRenderObservable.notifyObservers(this),this.postProcessManager&&!t._multiviewTexture&&!this.prePass&&this.postProcessManager._prepareFrame();for(var A=0,S=this._beforeCameraDrawStage;A<S.length;A++){var p=S[A];p.action(this.activeCamera)}this.onBeforeDrawPhaseObservable.notifyObservers(this),l.snapshotRendering&&l.snapshotRenderingMode===1&&this.finalizeSceneUbo(),this._renderingManager.render(null,null,!0,!0),this.onAfterDrawPhaseObservable.notifyObservers(this);for(var T=0,M=this._afterCameraDrawStage;T<M.length;T++){var p=M[T];p.action(this.activeCamera)}if(this.postProcessManager&&!t._multiviewTexture){var D=t.outputRenderTarget?t.outputRenderTarget.renderTarget:void 0;this.postProcessManager._finalizeFrame(t.isIntermediate,D)}this._renderTargets.reset(),this.onAfterCameraRenderObservable.notifyObservers(this.activeCamera)}},e.prototype._processSubCameras=function(t,r){if(r===void 0&&(r=!0),t.cameraRigMode===0||t._renderingMultiview){t._renderingMultiview&&!this._multiviewSceneUbo&&this._createMultiviewUbo(),this._renderForCamera(t,void 0,r),this.onAfterRenderCameraObservable.notifyObservers(t);return}if(t._useMultiviewToSingleView)this._renderMultiviewToSingleView(t);else{this.onBeforeCameraRenderObservable.notifyObservers(t);for(var n=0;n<t._rigCameras.length;n++)this._renderForCamera(t._rigCameras[n],t)}this._activeCamera=t,this.updateTransformMatrix(),this.onAfterRenderCameraObservable.notifyObservers(t)},e.prototype._checkIntersections=function(){for(var t=0;t<this._meshesForIntersections.length;t++){var r=this._meshesForIntersections.data[t];if(!!r.actionManager)for(var n=function(s){var o=r.actionManager.actions[s];if(o.trigger===12||o.trigger===13){var l=o.getTriggerParameter(),u=l.mesh?l.mesh:l,f=u.intersectsMesh(r,l.usePreciseIntersection),h=r._intersectionsInProgress.indexOf(u);f&&h===-1?o.trigger===12?(o._executeCurrent(tt.CreateNew(r,void 0,u)),r._intersectionsInProgress.push(u)):o.trigger===13&&r._intersectionsInProgress.push(u):!f&&h>-1&&(o.trigger===13&&o._executeCurrent(tt.CreateNew(r,void 0,u)),(!r.actionManager.hasSpecificTrigger(13,function(c){var d=c.mesh?c.mesh:c;return u===d})||o.trigger===13)&&r._intersectionsInProgress.splice(h,1))}},a=0;r.actionManager&&a<r.actionManager.actions.length;a++)n(a)}},e.prototype._advancePhysicsEngineStep=function(t){},e.prototype._animate=function(){},e.prototype.animate=function(){if(this._engine.isDeterministicLockStep()){var t=Math.max(e.MinDeltaTime,Math.min(this._engine.getDeltaTime(),e.MaxDeltaTime))+this._timeAccumulator,r=this._engine.getTimeStep(),n=1e3/r/1e3,a=0,s=this._engine.getLockstepMaxSteps(),o=Math.floor(t/r);for(o=Math.min(o,s);t>0&&a<o;)this.onBeforeStepObservable.notifyObservers(this),this._animationRatio=r*n,this._animate(),this.onAfterAnimationsObservable.notifyObservers(this),this.physicsEnabled&&this._advancePhysicsEngineStep(r),this.onAfterStepObservable.notifyObservers(this),this._currentStepId++,a++,t-=r;this._timeAccumulator=t<0?0:t}else{var t=this.useConstantAnimationDeltaTime?16:Math.max(e.MinDeltaTime,Math.min(this._engine.getDeltaTime(),e.MaxDeltaTime));this._animationRatio=t*(60/1e3),this._animate(),this.onAfterAnimationsObservable.notifyObservers(this),this.physicsEnabled&&this._advancePhysicsEngineStep(t)}},e.prototype._clear=function(){(this.autoClearDepthAndStencil||this.autoClear)&&this._engine.clear(this.clearColor,this.autoClear||this.forceWireframe||this.forcePointsCloud,this.autoClearDepthAndStencil,this.autoClearDepthAndStencil)},e.prototype._checkCameraRenderTarget=function(t){var r;if((t==null?void 0:t.outputRenderTarget)&&!(t!=null&&t.isRigCamera)&&(t.outputRenderTarget._cleared=!1),!((r=t==null?void 0:t.rigCameras)===null||r===void 0)&&r.length)for(var n=0;n<t.rigCameras.length;++n){var a=t.rigCameras[n].outputRenderTarget;a&&(a._cleared=!1)}},e.prototype.resetDrawCache=function(t){if(!!this.meshes)for(var r=0,n=this.meshes;r<n.length;r++){var a=n[r];a.resetDrawCache(t)}},e.prototype.render=function(t,r){var n,a,s;if(t===void 0&&(t=!0),r===void 0&&(r=!1),!this.isDisposed){this.onReadyObservable.hasObservers()&&this._executeWhenReadyTimeoutId===null&&this._checkIsReady(),this._frameId++,this._defaultFrameBufferCleared=!1,this._checkCameraRenderTarget(this.activeCamera),!((n=this.activeCameras)===null||n===void 0)&&n.length&&this.activeCameras.forEach(this._checkCameraRenderTarget),this._registerTransientComponents(),this._activeParticles.fetchNewFrame(),this._totalVertices.fetchNewFrame(),this._activeIndices.fetchNewFrame(),this._activeBones.fetchNewFrame(),this._meshesForIntersections.reset(),this.resetCachedMaterial(),this.onBeforeAnimationsObservable.notifyObservers(this),this.actionManager&&this.actionManager.processTrigger(11),r||this.animate();for(var o=0,l=this._beforeCameraUpdateStage;o<l.length;o++){var u=l[o];u.action()}if(t){if(this.activeCameras&&this.activeCameras.length>0)for(var f=0;f<this.activeCameras.length;f++){var h=this.activeCameras[f];if(h.update(),h.cameraRigMode!==0)for(var c=0;c<h._rigCameras.length;c++)h._rigCameras[c].update()}else if(this.activeCamera&&(this.activeCamera.update(),this.activeCamera.cameraRigMode!==0))for(var c=0;c<this.activeCamera._rigCameras.length;c++)this.activeCamera._rigCameras[c].update()}this.onBeforeRenderObservable.notifyObservers(this);var d=this.getEngine();this.onBeforeRenderTargetsRenderObservable.notifyObservers(this);var p=!((a=this.activeCameras)===null||a===void 0)&&a.length?this.activeCameras[0]:this.activeCamera;if(this.renderTargetsEnabled){te.StartPerformanceCounter("Custom render targets",this.customRenderTargets.length>0),this._intermediateRendering=!0;for(var _=0;_<this.customRenderTargets.length;_++){var g=this.customRenderTargets[_];if(g._shouldRender()){if(this._renderId++,this.activeCamera=g.activeCamera||this.activeCamera,!this.activeCamera)throw new Error("Active camera not set");d.setViewport(this.activeCamera.viewport),this.updateTransformMatrix(),g.render(p!==this.activeCamera,this.dumpNextRenderTargets)}}te.EndPerformanceCounter("Custom render targets",this.customRenderTargets.length>0),this._intermediateRendering=!1,this._renderId++}this._engine.currentRenderPassId=(s=p==null?void 0:p.renderPassId)!==null&&s!==void 0?s:0,this.activeCamera=p,this._activeCamera&&this._activeCamera.cameraRigMode!==22&&!this.prePass&&this._bindFrameBuffer(this._activeCamera,!1),this.onAfterRenderTargetsRenderObservable.notifyObservers(this);for(var v=0,y=this._beforeClearStage;v<y.length;v++){var u=y[v];u.action()}this._clearFrameBuffer(this.activeCamera);for(var b=0,E=this._gatherRenderTargetsStage;b<E.length;b++){var u=E[b];u.action(this._renderTargets)}if(this.activeCameras&&this.activeCameras.length>0)for(var f=0;f<this.activeCameras.length;f++)this._processSubCameras(this.activeCameras[f],f>0);else{if(!this.activeCamera)throw new Error("No camera defined");this._processSubCameras(this.activeCamera,!!this.activeCamera.outputRenderTarget)}this._checkIntersections();for(var A=0,S=this._afterRenderStage;A<S.length;A++){var u=S[A];u.action()}if(this.afterRender&&this.afterRender(),this.onAfterRenderObservable.notifyObservers(this),this._toBeDisposed.length){for(var c=0;c<this._toBeDisposed.length;c++){var T=this._toBeDisposed[c];T&&T.dispose()}this._toBeDisposed=[]}this.dumpNextRenderTargets&&(this.dumpNextRenderTargets=!1),this._activeBones.addCount(0,!0),this._activeIndices.addCount(0,!0),this._activeParticles.addCount(0,!0),this._engine.restoreDefaultFramebuffer()}},e.prototype.freezeMaterials=function(){for(var t=0;t<this.materials.length;t++)this.materials[t].freeze()},e.prototype.unfreezeMaterials=function(){for(var t=0;t<this.materials.length;t++)this.materials[t].unfreeze()},e.prototype.dispose=function(){var t;if(!this.isDisposed){this.beforeRender=null,this.afterRender=null,this.metadata=null,this.skeletons=[],this.morphTargetManagers=[],this._transientComponents=[],this._isReadyForMeshStage.clear(),this._beforeEvaluateActiveMeshStage.clear(),this._evaluateSubMeshStage.clear(),this._preActiveMeshStage.clear(),this._cameraDrawRenderTargetStage.clear(),this._beforeCameraDrawStage.clear(),this._beforeRenderTargetDrawStage.clear(),this._beforeRenderingGroupDrawStage.clear(),this._beforeRenderingMeshStage.clear(),this._afterRenderingMeshStage.clear(),this._afterRenderingGroupDrawStage.clear(),this._afterCameraDrawStage.clear(),this._afterRenderTargetDrawStage.clear(),this._afterRenderStage.clear(),this._beforeCameraUpdateStage.clear(),this._beforeClearStage.clear(),this._gatherRenderTargetsStage.clear(),this._gatherActiveCameraRenderTargetsStage.clear(),this._pointerMoveStage.clear(),this._pointerDownStage.clear(),this._pointerUpStage.clear(),this.importedMeshesFiles=new Array,this.stopAllAnimations&&this.stopAllAnimations(),this.resetCachedMaterial(),this.activeCamera&&(this.activeCamera._activeMeshes.dispose(),this.activeCamera=null),this._activeMeshes.dispose(),this._renderingManager.dispose(),this._processedMaterials.dispose(),this._activeParticleSystems.dispose(),this._activeSkeletons.dispose(),this._softwareSkinnedMeshes.dispose(),this._renderTargets.dispose(),this._materialsRenderTargets.dispose(),this._registeredForLateAnimationBindings.dispose(),this._meshesForIntersections.dispose(),this._toBeDisposed=[];for(var r=this._activeRequests.slice(),n=0,a=r;n<a.length;n++){var s=a[n];s.abort()}this._activeRequests=[],this.onDisposeObservable.notifyObservers(this),this.onDisposeObservable.clear(),this.onBeforeRenderObservable.clear(),this.onAfterRenderObservable.clear(),this.onBeforeRenderTargetsRenderObservable.clear(),this.onAfterRenderTargetsRenderObservable.clear(),this.onAfterStepObservable.clear(),this.onBeforeStepObservable.clear(),this.onBeforeActiveMeshesEvaluationObservable.clear(),this.onAfterActiveMeshesEvaluationObservable.clear(),this.onBeforeParticlesRenderingObservable.clear(),this.onAfterParticlesRenderingObservable.clear(),this.onBeforeDrawPhaseObservable.clear(),this.onAfterDrawPhaseObservable.clear(),this.onBeforeAnimationsObservable.clear(),this.onAfterAnimationsObservable.clear(),this.onDataLoadedObservable.clear(),this.onBeforeRenderingGroupObservable.clear(),this.onAfterRenderingGroupObservable.clear(),this.onMeshImportedObservable.clear(),this.onBeforeCameraRenderObservable.clear(),this.onAfterCameraRenderObservable.clear(),this.onReadyObservable.clear(),this.onNewCameraAddedObservable.clear(),this.onCameraRemovedObservable.clear(),this.onNewLightAddedObservable.clear(),this.onLightRemovedObservable.clear(),this.onNewGeometryAddedObservable.clear(),this.onGeometryRemovedObservable.clear(),this.onNewTransformNodeAddedObservable.clear(),this.onTransformNodeRemovedObservable.clear(),this.onNewMeshAddedObservable.clear(),this.onMeshRemovedObservable.clear(),this.onNewSkeletonAddedObservable.clear(),this.onSkeletonRemovedObservable.clear(),this.onNewMaterialAddedObservable.clear(),this.onNewMultiMaterialAddedObservable.clear(),this.onMaterialRemovedObservable.clear(),this.onMultiMaterialRemovedObservable.clear(),this.onNewTextureAddedObservable.clear(),this.onTextureRemovedObservable.clear(),this.onPrePointerObservable.clear(),this.onPointerObservable.clear(),this.onPreKeyboardObservable.clear(),this.onKeyboardObservable.clear(),this.onActiveCameraChanged.clear(),this.onComputePressureChanged.clear(),(t=this._computePressureObserver)===null||t===void 0||t.unobserve(),this._computePressureObserver=void 0,this.detachControl();var o=this._engine.getInputElement();if(o)for(var l=0;l<this.cameras.length;l++)this.cameras[l].detachControl();this._disposeList(this.animationGroups),this._disposeList(this.lights),this._disposeList(this.meshes,function(f){return f.dispose(!0)}),this._disposeList(this.transformNodes,function(f){return f.dispose(!0)}),this._disposeList(this.cameras),this._defaultMaterial&&this._defaultMaterial.dispose(),this._disposeList(this.multiMaterials),this._disposeList(this.materials),this._disposeList(this.particleSystems),this._disposeList(this.postProcesses),this._disposeList(this.textures),this._disposeList(this.morphTargetManagers),this._sceneUbo.dispose(),this._multiviewSceneUbo&&this._multiviewSceneUbo.dispose(),this.postProcessManager.dispose(),this._disposeList(this._components);var u=this._engine.scenes.indexOf(this);u>-1&&this._engine.scenes.splice(u,1),ye._LastCreatedScene===this&&(this._engine.scenes.length>0?ye._LastCreatedScene=this._engine.scenes[this._engine.scenes.length-1]:ye._LastCreatedScene=null),u=this._engine._virtualScenes.indexOf(this),u>-1&&this._engine._virtualScenes.splice(u,1),this._engine.wipeCaches(!0),this._isDisposed=!0}},e.prototype._disposeList=function(t,r){var n=Dr.Slice(t,0);r=r!=null?r:function(l){return l.dispose()};for(var a=0,s=n;a<s.length;a++){var o=s[a];r(o)}t.length=0},Object.defineProperty(e.prototype,"isDisposed",{get:function(){return this._isDisposed},enumerable:!1,configurable:!0}),e.prototype.clearCachedVertexData=function(){for(var t=0;t<this.meshes.length;t++){var r=this.meshes[t],n=r.geometry;n&&n.clearCachedData()}},e.prototype.cleanCachedTextureBuffer=function(){for(var t=0,r=this.textures;t<r.length;t++){var n=r[t],a=n._buffer;a&&(n._buffer=null)}},e.prototype.getWorldExtends=function(t){var r=new m(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),n=new m(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE);return t=t||function(){return!0},this.meshes.filter(t).forEach(function(a){if(a.computeWorldMatrix(!0),!(!a.subMeshes||a.subMeshes.length===0||a.infiniteDistance)){var s=a.getBoundingInfo(),o=s.boundingBox.minimumWorld,l=s.boundingBox.maximumWorld;m.CheckExtends(o,r,n),m.CheckExtends(l,r,n)}}),{min:r,max:n}},e.prototype.createPickingRay=function(t,r,n,a,s){throw he("Ray")},e.prototype.createPickingRayToRef=function(t,r,n,a,s,o,l){throw he("Ray")},e.prototype.createPickingRayInCameraSpace=function(t,r,n){throw he("Ray")},e.prototype.createPickingRayInCameraSpaceToRef=function(t,r,n,a){throw he("Ray")},e.prototype.pick=function(t,r,n,a,s,o){var l=new Et;return l._pickingUnavailable=!0,l},e.prototype.pickWithBoundingInfo=function(t,r,n,a,s){var o=new Et;return o._pickingUnavailable=!0,o},e.prototype.pickWithRay=function(t,r,n,a){throw he("Ray")},e.prototype.multiPick=function(t,r,n,a,s){throw he("Ray")},e.prototype.multiPickWithRay=function(t,r,n){throw he("Ray")},e.prototype.setPointerOverMesh=function(t,r,n){this._inputManager.setPointerOverMesh(t,r,n)},e.prototype.getPointerOverMesh=function(){return this._inputManager.getPointerOverMesh()},e.prototype._rebuildGeometries=function(){for(var t=0,r=this.geometries;t<r.length;t++){var n=r[t];n._rebuild()}for(var a=0,s=this.meshes;a<s.length;a++){var o=s[a];o._rebuild()}this.postProcessManager&&this.postProcessManager._rebuild();for(var l=0,u=this._components;l<u.length;l++){var f=u[l];f.rebuild()}for(var h=0,c=this.particleSystems;h<c.length;h++){var d=c[h];d.rebuild()}if(this.spriteManagers)for(var p=0,_=this.spriteManagers;p<_.length;p++){var g=_[p];g.rebuild()}},e.prototype._rebuildTextures=function(){for(var t=0,r=this.textures;t<r.length;t++){var n=r[t];n._rebuild()}this.markAllMaterialsAsDirty(1)},e.prototype._getByTags=function(t,r,n){if(r===void 0)return t;var a=[];n=n||function(l){};for(var s in t){var o=t[s];Le&&Le.MatchesQuery(o,r)&&(a.push(o),n(o))}return a},e.prototype.getMeshesByTags=function(t,r){return this._getByTags(this.meshes,t,r)},e.prototype.getCamerasByTags=function(t,r){return this._getByTags(this.cameras,t,r)},e.prototype.getLightsByTags=function(t,r){return this._getByTags(this.lights,t,r)},e.prototype.getMaterialByTags=function(t,r){return this._getByTags(this.materials,t,r).concat(this._getByTags(this.multiMaterials,t,r))},e.prototype.getTransformNodesByTags=function(t,r){return this._getByTags(this.transformNodes,t,r)},e.prototype.setRenderingOrder=function(t,r,n,a){r===void 0&&(r=null),n===void 0&&(n=null),a===void 0&&(a=null),this._renderingManager.setRenderingOrder(t,r,n,a)},e.prototype.setRenderingAutoClearDepthStencil=function(t,r,n,a){n===void 0&&(n=!0),a===void 0&&(a=!0),this._renderingManager.setRenderingAutoClearDepthStencil(t,r,n,a)},e.prototype.getAutoClearDepthStencilSetup=function(t){return this._renderingManager.getAutoClearDepthStencilSetup(t)},Object.defineProperty(e.prototype,"blockMaterialDirtyMechanism",{get:function(){return this._blockMaterialDirtyMechanism},set:function(t){this._blockMaterialDirtyMechanism!==t&&(this._blockMaterialDirtyMechanism=t,t||this.markAllMaterialsAsDirty(63))},enumerable:!1,configurable:!0}),e.prototype.markAllMaterialsAsDirty=function(t,r){if(!this._blockMaterialDirtyMechanism)for(var n=0,a=this.materials;n<a.length;n++){var s=a[n];r&&!r(s)||s.markAsDirty(t)}},e.prototype._loadFile=function(t,r,n,a,s,o,l){var u=this,f=fr(t,r,n,a?this.offlineProvider:void 0,s,o,l);return this._activeRequests.push(f),f.onCompleteObservable.add(function(h){u._activeRequests.splice(u._activeRequests.indexOf(h),1)}),f},e.prototype._loadFileAsync=function(t,r,n,a,s){var o=this;return new Promise(function(l,u){o._loadFile(t,function(f){l(f)},r,n,a,function(f,h){u(h)},s)})},e.prototype._requestFile=function(t,r,n,a,s,o,l){var u=this,f=rn(t,r,n,a?this.offlineProvider:void 0,s,o,l);return this._activeRequests.push(f),f.onCompleteObservable.add(function(h){u._activeRequests.splice(u._activeRequests.indexOf(h),1)}),f},e.prototype._requestFileAsync=function(t,r,n,a,s){var o=this;return new Promise(function(l,u){o._requestFile(t,function(f){l(f)},r,n,a,function(f){u(f)},s)})},e.prototype._readFile=function(t,r,n,a,s){var o=this,l=Fr(t,r,n,a,s);return this._activeRequests.push(l),l.onCompleteObservable.add(function(u){o._activeRequests.splice(o._activeRequests.indexOf(u),1)}),l},e.prototype._readFileAsync=function(t,r,n){var a=this;return new Promise(function(s,o){a._readFile(t,function(l){s(l)},r,n,function(l){o(l)})})},e.prototype.getPerfCollector=function(){throw he("performanceViewerSceneExtension")},e.FOGMODE_NONE=0,e.FOGMODE_EXP=1,e.FOGMODE_EXP2=2,e.FOGMODE_LINEAR=3,e.MinDeltaTime=1,e.MaxDeltaTime=1e3,e}($o);Re.prototype.setActiveCameraByID=function(i){return this.setActiveCameraById(i)};Re.prototype.getLastMaterialByID=function(i){return this.getLastMaterialById(i)};Re.prototype.getMaterialByID=function(i){return this.getMaterialById(i)};Re.prototype.getTextureByUniqueID=function(i){return this.getTextureByUniqueId(i)};Re.prototype.getCameraByID=function(i){return this.getCameraById(i)};Re.prototype.getCameraByUniqueID=function(i){return this.getCameraByUniqueId(i)};Re.prototype.getBoneByID=function(i){return this.getBoneById(i)};Re.prototype.getLightByID=function(i){return this.getLightById(i)};Re.prototype.getLightByUniqueID=function(i){return this.getLightByUniqueId(i)};Re.prototype.getParticleSystemByID=function(i){return this.getParticleSystemById(i)};Re.prototype.getGeometryByID=function(i){return this.getGeometryById(i)};Re.prototype.getMeshByID=function(i){return this.getMeshById(i)};Re.prototype.getMeshesByID=function(i){return this.getMeshesById(i)};Re.prototype.getTransformNodeByID=function(i){return this.getTransformNodeById(i)};Re.prototype.getTransformNodeByUniqueID=function(i){return this.getTransformNodeByUniqueId(i)};Re.prototype.getTransformNodesByID=function(i){return this.getTransformNodesById(i)};Re.prototype.getMeshByUniqueID=function(i){return this.getMeshByUniqueId(i)};Re.prototype.getLastMeshByID=function(i){return this.getLastMeshById(i)};Re.prototype.getLastEntryByID=function(i){return this.getLastEntryById(i)};Re.prototype.getNodeByID=function(i){return this.getNodeById(i)};Re.prototype.getLastSkeletonByID=function(i){return this.getLastSkeletonById(i)};var gt=function(i){$(e,i);function e(t,r){var n=i.call(this,t,r)||this;return n.diffuse=new me(1,1,1),n.specular=new me(1,1,1),n.falloffType=e.FALLOFF_DEFAULT,n.intensity=1,n._range=Number.MAX_VALUE,n._inverseSquaredRange=0,n._photometricScale=1,n._intensityMode=e.INTENSITYMODE_AUTOMATIC,n._radius=1e-5,n.renderPriority=0,n._shadowEnabled=!0,n._excludeWithLayerMask=0,n._includeOnlyWithLayerMask=0,n._lightmapMode=0,n._excludedMeshesIds=new Array,n._includedOnlyMeshesIds=new Array,n._isLight=!0,n.getScene().addLight(n),n._uniformBuffer=new si(n.getScene().getEngine(),void 0,void 0,t),n._buildUniformLayout(),n.includedOnlyMeshes=new Array,n.excludedMeshes=new Array,n._resyncMeshes(),n}return Object.defineProperty(e.prototype,"range",{get:function(){return this._range},set:function(t){this._range=t,this._inverseSquaredRange=1/(this.range*this.range)},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"intensityMode",{get:function(){return this._intensityMode},set:function(t){this._intensityMode=t,this._computePhotometricScale()},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"radius",{get:function(){return this._radius},set:function(t){this._radius=t,this._computePhotometricScale()},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"shadowEnabled",{get:function(){return this._shadowEnabled},set:function(t){this._shadowEnabled!==t&&(this._shadowEnabled=t,this._markMeshesAsLightDirty())},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"includedOnlyMeshes",{get:function(){return this._includedOnlyMeshes},set:function(t){this._includedOnlyMeshes=t,this._hookArrayForIncludedOnly(t)},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"excludedMeshes",{get:function(){return this._excludedMeshes},set:function(t){this._excludedMeshes=t,this._hookArrayForExcluded(t)},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"excludeWithLayerMask",{get:function(){return this._excludeWithLayerMask},set:function(t){this._excludeWithLayerMask=t,this._resyncMeshes()},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"includeOnlyWithLayerMask",{get:function(){return this._includeOnlyWithLayerMask},set:function(t){this._includeOnlyWithLayerMask=t,this._resyncMeshes()},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"lightmapMode",{get:function(){return this._lightmapMode},set:function(t){this._lightmapMode!==t&&(this._lightmapMode=t,this._markMeshesAsLightDirty())},enumerable:!1,configurable:!0}),e.prototype.transferTexturesToEffect=function(t,r){return this},e.prototype._bindLight=function(t,r,n,a,s){s===void 0&&(s=!0);var o=t.toString(),l=!1;if(this._uniformBuffer.bindToEffect(n,"Light"+o),this._renderId!==r.getRenderId()||this._lastUseSpecular!==a||!this._uniformBuffer.useUbo){this._renderId=r.getRenderId(),this._lastUseSpecular=a;var u=this.getScaledIntensity();this.transferToEffect(n,o),this.diffuse.scaleToRef(u,Ar.Color3[0]),this._uniformBuffer.updateColor4("vLightDiffuse",Ar.Color3[0],this.range,o),a&&(this.specular.scaleToRef(u,Ar.Color3[1]),this._uniformBuffer.updateColor4("vLightSpecular",Ar.Color3[1],this.radius,o)),l=!0}if(this.transferTexturesToEffect(n,o),r.shadowsEnabled&&this.shadowEnabled&&s){var f=this.getShadowGenerator();f&&(f.bindShadowLight(o,n),l=!0)}l?this._uniformBuffer.update():this._uniformBuffer.bindUniformBuffer()},e.prototype.getClassName=function(){return"Light"},e.prototype.toString=function(t){var r="Name: "+this.name;if(r+=", type: "+["Point","Directional","Spot","Hemispheric"][this.getTypeID()],this.animations)for(var n=0;n<this.animations.length;n++)r+=", animation[0]: "+this.animations[n].toString(t);return r},e.prototype._syncParentEnabledState=function(){i.prototype._syncParentEnabledState.call(this),this.isDisposed()||this._resyncMeshes()},e.prototype.setEnabled=function(t){i.prototype.setEnabled.call(this,t),this._resyncMeshes()},e.prototype.getShadowGenerator=function(){return this._shadowGenerator},e.prototype.getAbsolutePosition=function(){return m.Zero()},e.prototype.canAffectMesh=function(t){return t?!(this.includedOnlyMeshes&&this.includedOnlyMeshes.length>0&&this.includedOnlyMeshes.indexOf(t)===-1||this.excludedMeshes&&this.excludedMeshes.length>0&&this.excludedMeshes.indexOf(t)!==-1||this.includeOnlyWithLayerMask!==0&&(this.includeOnlyWithLayerMask&t.layerMask)===0||this.excludeWithLayerMask!==0&&this.excludeWithLayerMask&t.layerMask):!0},e.prototype.dispose=function(t,r){if(r===void 0&&(r=!1),this._shadowGenerator&&(this._shadowGenerator.dispose(),this._shadowGenerator=null),this.getScene().stopAnimation(this),this._parentContainer){var n=this._parentContainer.lights.indexOf(this);n>-1&&this._parentContainer.lights.splice(n,1),this._parentContainer=null}for(var a=0,s=this.getScene().meshes;a<s.length;a++){var o=s[a];o._removeLightSource(this,!0)}this._uniformBuffer.dispose(),this.getScene().removeLight(this),i.prototype.dispose.call(this,t,r)},e.prototype.getTypeID=function(){return 0},e.prototype.getScaledIntensity=function(){return this._photometricScale*this.intensity},e.prototype.clone=function(t,r){r===void 0&&(r=null);var n=e.GetConstructorFromName(this.getTypeID(),t,this.getScene());if(!n)return null;var a=pe.Clone(n,this);return t&&(a.name=t),r&&(a.parent=r),a.setEnabled(this.isEnabled()),this.onClonedObservable.notifyObservers(a),a},e.prototype.serialize=function(){var t=pe.Serialize(this);return t.uniqueId=this.uniqueId,t.type=this.getTypeID(),this.parent&&(t.parentId=this.parent.uniqueId),this.excludedMeshes.length>0&&(t.excludedMeshesIds=[],this.excludedMeshes.forEach(function(r){t.excludedMeshesIds.push(r.id)})),this.includedOnlyMeshes.length>0&&(t.includedOnlyMeshesIds=[],this.includedOnlyMeshes.forEach(function(r){t.includedOnlyMeshesIds.push(r.id)})),pe.AppendSerializedAnimations(this,t),t.ranges=this.serializeAnimationRanges(),t.isEnabled=this.isEnabled(),t},e.GetConstructorFromName=function(t,r,n){var a=ct.Construct("Light_Type_"+t,r,n);return a||null},e.Parse=function(t,r){var n=e.GetConstructorFromName(t.type,t.name,r);if(!n)return null;var a=pe.Parse(n,t,r);if(t.excludedMeshesIds&&(a._excludedMeshesIds=t.excludedMeshesIds),t.includedOnlyMeshesIds&&(a._includedOnlyMeshesIds=t.includedOnlyMeshesIds),t.parentId!==void 0&&(a._waitingParentId=t.parentId),t.falloffType!==void 0&&(a.falloffType=t.falloffType),t.lightmapMode!==void 0&&(a.lightmapMode=t.lightmapMode),t.animations){for(var s=0;s<t.animations.length;s++){var o=t.animations[s],l=lt("BABYLON.Animation");l&&a.animations.push(l.Parse(o))}ct.ParseAnimationRanges(a,t,r)}return t.autoAnimate&&r.beginAnimation(a,t.autoAnimateFrom,t.autoAnimateTo,t.autoAnimateLoop,t.autoAnimateSpeed||1),t.isEnabled!==void 0&&a.setEnabled(t.isEnabled),a},e.prototype._hookArrayForExcluded=function(t){var r=this,n=t.push;t.push=function(){for(var u=[],f=0;f<arguments.length;f++)u[f]=arguments[f];for(var h=n.apply(t,u),c=0,d=u;c<d.length;c++){var p=d[c];p._resyncLightSource(r)}return h};var a=t.splice;t.splice=function(u,f){for(var h=a.apply(t,[u,f]),c=0,d=h;c<d.length;c++){var p=d[c];p._resyncLightSource(r)}return h};for(var s=0,o=t;s<o.length;s++){var l=o[s];l._resyncLightSource(this)}},e.prototype._hookArrayForIncludedOnly=function(t){var r=this,n=t.push;t.push=function(){for(var s=[],o=0;o<arguments.length;o++)s[o]=arguments[o];var l=n.apply(t,s);return r._resyncMeshes(),l};var a=t.splice;t.splice=function(s,o){var l=a.apply(t,[s,o]);return r._resyncMeshes(),l},this._resyncMeshes()},e.prototype._resyncMeshes=function(){for(var t=0,r=this.getScene().meshes;t<r.length;t++){var n=r[t];n._resyncLightSource(this)}},e.prototype._markMeshesAsLightDirty=function(){for(var t=0,r=this.getScene().meshes;t<r.length;t++){var n=r[t];n.lightSources.indexOf(this)!==-1&&n._markSubMeshesAsLightDirty()}},e.prototype._computePhotometricScale=function(){this._photometricScale=this._getPhotometricScale(),this.getScene().resetCachedMaterial()},e.prototype._getPhotometricScale=function(){var t=0,r=this.getTypeID(),n=this.intensityMode;switch(n===e.INTENSITYMODE_AUTOMATIC&&(r===e.LIGHTTYPEID_DIRECTIONALLIGHT?n=e.INTENSITYMODE_ILLUMINANCE:n=e.INTENSITYMODE_LUMINOUSINTENSITY),r){case e.LIGHTTYPEID_POINTLIGHT:case e.LIGHTTYPEID_SPOTLIGHT:switch(n){case e.INTENSITYMODE_LUMINOUSPOWER:t=1/(4*Math.PI);break;case e.INTENSITYMODE_LUMINOUSINTENSITY:t=1;break;case e.INTENSITYMODE_LUMINANCE:t=this.radius*this.radius;break}break;case e.LIGHTTYPEID_DIRECTIONALLIGHT:switch(n){case e.INTENSITYMODE_ILLUMINANCE:t=1;break;case e.INTENSITYMODE_LUMINANCE:{var a=this.radius;a=Math.max(a,.001);var s=2*Math.PI*(1-Math.cos(a));t=s;break}}break;case e.LIGHTTYPEID_HEMISPHERICLIGHT:t=1;break}return t},e.prototype._reorderLightsInScene=function(){var t=this.getScene();this._renderPriority!=0&&(t.requireLightSorting=!0),this.getScene().sortLightsByPriority()},e.FALLOFF_DEFAULT=Ze.FALLOFF_DEFAULT,e.FALLOFF_PHYSICAL=Ze.FALLOFF_PHYSICAL,e.FALLOFF_GLTF=Ze.FALLOFF_GLTF,e.FALLOFF_STANDARD=Ze.FALLOFF_STANDARD,e.LIGHTMAP_DEFAULT=Ze.LIGHTMAP_DEFAULT,e.LIGHTMAP_SPECULAR=Ze.LIGHTMAP_SPECULAR,e.LIGHTMAP_SHADOWSONLY=Ze.LIGHTMAP_SHADOWSONLY,e.INTENSITYMODE_AUTOMATIC=Ze.INTENSITYMODE_AUTOMATIC,e.INTENSITYMODE_LUMINOUSPOWER=Ze.INTENSITYMODE_LUMINOUSPOWER,e.INTENSITYMODE_LUMINOUSINTENSITY=Ze.INTENSITYMODE_LUMINOUSINTENSITY,e.INTENSITYMODE_ILLUMINANCE=Ze.INTENSITYMODE_ILLUMINANCE,e.INTENSITYMODE_LUMINANCE=Ze.INTENSITYMODE_LUMINANCE,e.LIGHTTYPEID_POINTLIGHT=Ze.LIGHTTYPEID_POINTLIGHT,e.LIGHTTYPEID_DIRECTIONALLIGHT=Ze.LIGHTTYPEID_DIRECTIONALLIGHT,e.LIGHTTYPEID_SPOTLIGHT=Ze.LIGHTTYPEID_SPOTLIGHT,e.LIGHTTYPEID_HEMISPHERICLIGHT=Ze.LIGHTTYPEID_HEMISPHERICLIGHT,C([wt()],e.prototype,"diffuse",void 0),C([wt()],e.prototype,"specular",void 0),C([I()],e.prototype,"falloffType",void 0),C([I()],e.prototype,"intensity",void 0),C([I()],e.prototype,"range",null),C([I()],e.prototype,"intensityMode",null),C([I()],e.prototype,"radius",null),C([I()],e.prototype,"_renderPriority",void 0),C([ve("_reorderLightsInScene")],e.prototype,"renderPriority",void 0),C([I("shadowEnabled")],e.prototype,"_shadowEnabled",void 0),C([I("excludeWithLayerMask")],e.prototype,"_excludeWithLayerMask",void 0),C([I("includeOnlyWithLayerMask")],e.prototype,"_includeOnlyWithLayerMask",void 0),C([I("lightmapMode")],e.prototype,"_lightmapMode",void 0),e}(ct),za=function(){function i(){}return i.BindClipPlane=function(e,t){if(t.clipPlane){var r=t.clipPlane;e.setFloat4("vClipPlane",r.normal.x,r.normal.y,r.normal.z,r.d)}if(t.clipPlane2){var r=t.clipPlane2;e.setFloat4("vClipPlane2",r.normal.x,r.normal.y,r.normal.z,r.d)}if(t.clipPlane3){var r=t.clipPlane3;e.setFloat4("vClipPlane3",r.normal.x,r.normal.y,r.normal.z,r.d)}if(t.clipPlane4){var r=t.clipPlane4;e.setFloat4("vClipPlane4",r.normal.x,r.normal.y,r.normal.z,r.d)}if(t.clipPlane5){var r=t.clipPlane5;e.setFloat4("vClipPlane5",r.normal.x,r.normal.y,r.normal.z,r.d)}if(t.clipPlane6){var r=t.clipPlane6;e.setFloat4("vClipPlane6",r.normal.x,r.normal.y,r.normal.z,r.d)}},i}(),le=function(){function i(){}return i.BindSceneUniformBuffer=function(e,t){t.bindToEffect(e,"Scene")},i.PrepareDefinesForMergedUV=function(e,t,r){t._needUVs=!0,t[r]=!0,e.getTextureMatrix().isIdentityAs3x2()?(t[r+"DIRECTUV"]=e.coordinatesIndex+1,t["MAINUV"+(e.coordinatesIndex+1)]=!0):t[r+"DIRECTUV"]=0},i.BindTextureMatrix=function(e,t,r){var n=e.getTextureMatrix();t.updateMatrix(r+"Matrix",n)},i.GetFogState=function(e,t){return t.fogEnabled&&e.applyFog&&t.fogMode!==Re.FOGMODE_NONE},i.PrepareDefinesForMisc=function(e,t,r,n,a,s,o){o._areMiscDirty&&(o.LOGARITHMICDEPTH=r,o.POINTSIZE=n,o.FOG=a&&this.GetFogState(e,t),o.NONUNIFORMSCALING=e.nonUniformScaling,o.ALPHATEST=s)},i.PrepareDefinesForFrameBoundValues=function(e,t,r,n,a,s){a===void 0&&(a=null),s===void 0&&(s=!1);var o=!1,l=!1,u=!1,f=!1,h=!1,c=!1,d=!1;l=a==null?e.clipPlane!==void 0&&e.clipPlane!==null:a,u=a==null?e.clipPlane2!==void 0&&e.clipPlane2!==null:a,f=a==null?e.clipPlane3!==void 0&&e.clipPlane3!==null:a,h=a==null?e.clipPlane4!==void 0&&e.clipPlane4!==null:a,c=a==null?e.clipPlane5!==void 0&&e.clipPlane5!==null:a,d=a==null?e.clipPlane6!==void 0&&e.clipPlane6!==null:a,r.CLIPPLANE!==l&&(r.CLIPPLANE=l,o=!0),r.CLIPPLANE2!==u&&(r.CLIPPLANE2=u,o=!0),r.CLIPPLANE3!==f&&(r.CLIPPLANE3=f,o=!0),r.CLIPPLANE4!==h&&(r.CLIPPLANE4=h,o=!0),r.CLIPPLANE5!==c&&(r.CLIPPLANE5=c,o=!0),r.CLIPPLANE6!==d&&(r.CLIPPLANE6=d,o=!0),r.DEPTHPREPASS!==!t.getColorWrite()&&(r.DEPTHPREPASS=!r.DEPTHPREPASS,o=!0),r.INSTANCES!==n&&(r.INSTANCES=n,o=!0),r.INSTANCESCOLOR&&!r.INSTANCES&&(r.INSTANCESCOLOR=!1,o=!0),r.THIN_INSTANCES!==s&&(r.THIN_INSTANCES=s,o=!0),o&&r.markAsUnprocessed()},i.PrepareDefinesForBones=function(e,t){if(e.useBones&&e.computeBonesUsingShaders&&e.skeleton){t.NUM_BONE_INFLUENCERS=e.numBoneInfluencers;var r=t.BONETEXTURE!==void 0;if(e.skeleton.isUsingTextureForMatrices&&r)t.BONETEXTURE=!0;else{t.BonesPerMesh=e.skeleton.bones.length+1,t.BONETEXTURE=r?!1:void 0;var n=e.getScene().prePassRenderer;if(n&&n.enabled){var a=n.excludedSkinnedMesh.indexOf(e)===-1;t.BONES_VELOCITY_ENABLED=a}}}else t.NUM_BONE_INFLUENCERS=0,t.BonesPerMesh=0},i.PrepareDefinesForMorphTargets=function(e,t){var r=e.morphTargetManager;r?(t.MORPHTARGETS_UV=r.supportsUVs&&t.UV1,t.MORPHTARGETS_TANGENT=r.supportsTangents&&t.TANGENT,t.MORPHTARGETS_NORMAL=r.supportsNormals&&t.NORMAL,t.MORPHTARGETS=r.numInfluencers>0,t.NUM_MORPH_INFLUENCERS=r.numInfluencers,t.MORPHTARGETS_TEXTURE=r.isUsingTextureForTargets):(t.MORPHTARGETS_UV=!1,t.MORPHTARGETS_TANGENT=!1,t.MORPHTARGETS_NORMAL=!1,t.MORPHTARGETS=!1,t.NUM_MORPH_INFLUENCERS=0)},i.PrepareDefinesForBakedVertexAnimation=function(e,t){var r=e.bakedVertexAnimationManager;t.BAKED_VERTEX_ANIMATION_TEXTURE=!!(r&&r.isEnabled)},i.PrepareDefinesForAttributes=function(e,t,r,n,a,s,o){if(a===void 0&&(a=!1),s===void 0&&(s=!0),o===void 0&&(o=!0),!t._areAttributesDirty&&t._needNormals===t._normals&&t._needUVs===t._uvs)return!1;t._normals=t._needNormals,t._uvs=t._needUVs,t.NORMAL=t._needNormals&&e.isVerticesDataPresent(R.NormalKind),t._needNormals&&e.isVerticesDataPresent(R.TangentKind)&&(t.TANGENT=!0);for(var l=1;l<=6;++l)t["UV"+l]=t._needUVs?e.isVerticesDataPresent("uv".concat(l===1?"":l)):!1;if(r){var u=e.useVertexColors&&e.isVerticesDataPresent(R.ColorKind);t.VERTEXCOLOR=u,t.VERTEXALPHA=e.hasVertexAlpha&&u&&s}return e.isVerticesDataPresent(R.ColorInstanceKind)&&(t.INSTANCESCOLOR=!0),n&&this.PrepareDefinesForBones(e,t),a&&this.PrepareDefinesForMorphTargets(e,t),o&&this.PrepareDefinesForBakedVertexAnimation(e,t),!0},i.PrepareDefinesForMultiview=function(e,t){if(e.activeCamera){var r=t.MULTIVIEW;t.MULTIVIEW=e.activeCamera.outputRenderTarget!==null&&e.activeCamera.outputRenderTarget.getViewCount()>1,t.MULTIVIEW!=r&&t.markAsUnprocessed()}},i.PrepareDefinesForOIT=function(e,t,r){var n=t.ORDER_INDEPENDENT_TRANSPARENCY,a=t.ORDER_INDEPENDENT_TRANSPARENCY_16BITS;t.ORDER_INDEPENDENT_TRANSPARENCY=e.useOrderIndependentTransparency&&r,t.ORDER_INDEPENDENT_TRANSPARENCY_16BITS=!e.getEngine().getCaps().textureFloatLinearFiltering,(n!==t.ORDER_INDEPENDENT_TRANSPARENCY||a!==t.ORDER_INDEPENDENT_TRANSPARENCY_16BITS)&&t.markAsUnprocessed()},i.PrepareDefinesForPrePass=function(e,t,r){var n=t.PREPASS;if(!!t._arePrePassDirty){var a=[{type:1,define:"PREPASS_POSITION",index:"PREPASS_POSITION_INDEX"},{type:2,define:"PREPASS_VELOCITY",index:"PREPASS_VELOCITY_INDEX"},{type:3,define:"PREPASS_REFLECTIVITY",index:"PREPASS_REFLECTIVITY_INDEX"},{type:0,define:"PREPASS_IRRADIANCE",index:"PREPASS_IRRADIANCE_INDEX"},{type:7,define:"PREPASS_ALBEDO_SQRT",index:"PREPASS_ALBEDO_SQRT_INDEX"},{type:5,define:"PREPASS_DEPTH",index:"PREPASS_DEPTH_INDEX"},{type:6,define:"PREPASS_NORMAL",index:"PREPASS_NORMAL_INDEX"}];if(e.prePassRenderer&&e.prePassRenderer.enabled&&r){t.PREPASS=!0,t.SCENE_MRT_COUNT=e.prePassRenderer.mrtCount;for(var s=0;s<a.length;s++){var o=e.prePassRenderer.getIndex(a[s].type);o!==-1?(t[a[s].define]=!0,t[a[s].index]=o):t[a[s].define]=!1}}else{t.PREPASS=!1;for(var s=0;s<a.length;s++)t[a[s].define]=!1}t.PREPASS!=n&&(t.markAsUnprocessed(),t.markAsImageProcessingDirty())}},i.PrepareDefinesForLight=function(e,t,r,n,a,s,o){switch(o.needNormals=!0,a["LIGHT"+n]===void 0&&(o.needRebuild=!0),a["LIGHT"+n]=!0,a["SPOTLIGHT"+n]=!1,a["HEMILIGHT"+n]=!1,a["POINTLIGHT"+n]=!1,a["DIRLIGHT"+n]=!1,r.prepareLightSpecificDefines(a,n),a["LIGHT_FALLOFF_PHYSICAL"+n]=!1,a["LIGHT_FALLOFF_GLTF"+n]=!1,a["LIGHT_FALLOFF_STANDARD"+n]=!1,r.falloffType){case gt.FALLOFF_GLTF:a["LIGHT_FALLOFF_GLTF"+n]=!0;break;case gt.FALLOFF_PHYSICAL:a["LIGHT_FALLOFF_PHYSICAL"+n]=!0;break;case gt.FALLOFF_STANDARD:a["LIGHT_FALLOFF_STANDARD"+n]=!0;break}if(s&&!r.specular.equalsFloats(0,0,0)&&(o.specularEnabled=!0),a["SHADOW"+n]=!1,a["SHADOWCSM"+n]=!1,a["SHADOWCSMDEBUG"+n]=!1,a["SHADOWCSMNUM_CASCADES"+n]=!1,a["SHADOWCSMUSESHADOWMAXZ"+n]=!1,a["SHADOWCSMNOBLEND"+n]=!1,a["SHADOWCSM_RIGHTHANDED"+n]=!1,a["SHADOWPCF"+n]=!1,a["SHADOWPCSS"+n]=!1,a["SHADOWPOISSON"+n]=!1,a["SHADOWESM"+n]=!1,a["SHADOWCLOSEESM"+n]=!1,a["SHADOWCUBE"+n]=!1,a["SHADOWLOWQUALITY"+n]=!1,a["SHADOWMEDIUMQUALITY"+n]=!1,t&&t.receiveShadows&&e.shadowsEnabled&&r.shadowEnabled){var l=r.getShadowGenerator();if(l){var u=l.getShadowMap();u&&u.renderList&&u.renderList.length>0&&(o.shadowEnabled=!0,l.prepareDefines(a,n))}}r.lightmapMode!=gt.LIGHTMAP_DEFAULT?(o.lightmapMode=!0,a["LIGHTMAPEXCLUDED"+n]=!0,a["LIGHTMAPNOSPECULAR"+n]=r.lightmapMode==gt.LIGHTMAP_SHADOWSONLY):(a["LIGHTMAPEXCLUDED"+n]=!1,a["LIGHTMAPNOSPECULAR"+n]=!1)},i.PrepareDefinesForLights=function(e,t,r,n,a,s){if(a===void 0&&(a=4),s===void 0&&(s=!1),!r._areLightsDirty)return r._needNormals;var o=0,l={needNormals:!1,needRebuild:!1,lightmapMode:!1,shadowEnabled:!1,specularEnabled:!1};if(e.lightsEnabled&&!s)for(var u=0,f=t.lightSources;u<f.length;u++){var h=f[u];if(this.PrepareDefinesForLight(e,t,h,o,r,n,l),o++,o===a)break}r.SPECULARTERM=l.specularEnabled,r.SHADOWS=l.shadowEnabled;for(var c=o;c<a;c++)r["LIGHT"+c]!==void 0&&(r["LIGHT"+c]=!1,r["HEMILIGHT"+c]=!1,r["POINTLIGHT"+c]=!1,r["DIRLIGHT"+c]=!1,r["SPOTLIGHT"+c]=!1,r["SHADOW"+c]=!1,r["SHADOWCSM"+c]=!1,r["SHADOWCSMDEBUG"+c]=!1,r["SHADOWCSMNUM_CASCADES"+c]=!1,r["SHADOWCSMUSESHADOWMAXZ"+c]=!1,r["SHADOWCSMNOBLEND"+c]=!1,r["SHADOWCSM_RIGHTHANDED"+c]=!1,r["SHADOWPCF"+c]=!1,r["SHADOWPCSS"+c]=!1,r["SHADOWPOISSON"+c]=!1,r["SHADOWESM"+c]=!1,r["SHADOWCLOSEESM"+c]=!1,r["SHADOWCUBE"+c]=!1,r["SHADOWLOWQUALITY"+c]=!1,r["SHADOWMEDIUMQUALITY"+c]=!1);var d=e.getEngine().getCaps();return r.SHADOWFLOAT===void 0&&(l.needRebuild=!0),r.SHADOWFLOAT=l.shadowEnabled&&(d.textureFloatRender&&d.textureFloatLinearFiltering||d.textureHalfFloatRender&&d.textureHalfFloatLinearFiltering),r.LIGHTMAPEXCLUDED=l.lightmapMode,l.needRebuild&&r.rebuild(),l.needNormals},i.PrepareUniformsAndSamplersForLight=function(e,t,r,n,a,s){a===void 0&&(a=null),s===void 0&&(s=!1),a&&a.push("Light"+e),!s&&(t.push("vLightData"+e,"vLightDiffuse"+e,"vLightSpecular"+e,"vLightDirection"+e,"vLightFalloff"+e,"vLightGround"+e,"lightMatrix"+e,"shadowsInfo"+e,"depthValues"+e),r.push("shadowSampler"+e),r.push("depthSampler"+e),t.push("viewFrustumZ"+e,"cascadeBlendFactor"+e,"lightSizeUVCorrection"+e,"depthCorrection"+e,"penumbraDarkness"+e,"frustumLengths"+e),n&&(r.push("projectionLightSampler"+e),t.push("textureProjectionMatrix"+e)))},i.PrepareUniformsAndSamplersList=function(e,t,r,n){n===void 0&&(n=4);var a,s=null;if(e.uniformsNames){var o=e;a=o.uniformsNames,s=o.uniformBuffersNames,t=o.samplers,r=o.defines,n=o.maxSimultaneousLights||0}else a=e,t||(t=[]);for(var l=0;l<n&&r["LIGHT"+l];l++)this.PrepareUniformsAndSamplersForLight(l,a,t,r["PROJECTEDLIGHTTEXTURE"+l],s);r.NUM_MORPH_INFLUENCERS&&a.push("morphTargetInfluences"),r.BAKED_VERTEX_ANIMATION_TEXTURE&&(a.push("bakedVertexAnimationSettings"),a.push("bakedVertexAnimationTextureSizeInverted"),a.push("bakedVertexAnimationTime"),t.push("bakedVertexAnimationTexture"))},i.HandleFallbacksForShadows=function(e,t,r,n){r===void 0&&(r=4),n===void 0&&(n=0);for(var a=0,s=0;s<r&&e["LIGHT"+s];s++)s>0&&(a=n+s,t.addFallback(a,"LIGHT"+s)),e.SHADOWS||(e["SHADOW"+s]&&t.addFallback(n,"SHADOW"+s),e["SHADOWPCF"+s]&&t.addFallback(n,"SHADOWPCF"+s),e["SHADOWPCSS"+s]&&t.addFallback(n,"SHADOWPCSS"+s),e["SHADOWPOISSON"+s]&&t.addFallback(n,"SHADOWPOISSON"+s),e["SHADOWESM"+s]&&t.addFallback(n,"SHADOWESM"+s),e["SHADOWCLOSEESM"+s]&&t.addFallback(n,"SHADOWCLOSEESM"+s));return a++},i.PrepareAttributesForMorphTargetsInfluencers=function(e,t,r){this._TmpMorphInfluencers.NUM_MORPH_INFLUENCERS=r,this.PrepareAttributesForMorphTargets(e,t,this._TmpMorphInfluencers)},i.PrepareAttributesForMorphTargets=function(e,t,r){var n=r.NUM_MORPH_INFLUENCERS;if(n>0&&ye.LastCreatedEngine){var a=ye.LastCreatedEngine.getCaps().maxVertexAttribs,s=t.morphTargetManager;if(s!=null&&s.isUsingTextureForTargets)return;for(var o=s&&s.supportsNormals&&r.NORMAL,l=s&&s.supportsTangents&&r.TANGENT,u=s&&s.supportsUVs&&r.UV1,f=0;f<n;f++)e.push(R.PositionKind+f),o&&e.push(R.NormalKind+f),l&&e.push(R.TangentKind+f),u&&e.push(R.UVKind+"_"+f),e.length>a&&Y.Error("Cannot add more vertex attributes for mesh "+t.name)}},i.PrepareAttributesForBakedVertexAnimation=function(e,t,r){var n=r.BAKED_VERTEX_ANIMATION_TEXTURE&&r.INSTANCES;n&&e.push("bakedVertexAnimationSettingsInstanced")},i.PrepareAttributesForBones=function(e,t,r,n){r.NUM_BONE_INFLUENCERS>0&&(n.addCPUSkinningFallback(0,t),e.push(R.MatricesIndicesKind),e.push(R.MatricesWeightsKind),r.NUM_BONE_INFLUENCERS>4&&(e.push(R.MatricesIndicesExtraKind),e.push(R.MatricesWeightsExtraKind)))},i.PrepareAttributesForInstances=function(e,t){(t.INSTANCES||t.THIN_INSTANCES)&&this.PushAttributesForInstances(e,!!t.PREPASS_VELOCITY)},i.PushAttributesForInstances=function(e,t){t===void 0&&(t=!1),e.push("world0"),e.push("world1"),e.push("world2"),e.push("world3"),t&&(e.push("previousWorld0"),e.push("previousWorld1"),e.push("previousWorld2"),e.push("previousWorld3"))},i.BindLightProperties=function(e,t,r){e.transferToEffect(t,r+"")},i.BindLight=function(e,t,r,n,a,s){s===void 0&&(s=!0),e._bindLight(t,r,n,a,s)},i.BindLights=function(e,t,r,n,a){a===void 0&&(a=4);for(var s=Math.min(t.lightSources.length,a),o=0;o<s;o++){var l=t.lightSources[o];this.BindLight(l,o,e,r,typeof n=="boolean"?n:n.SPECULARTERM,t.receiveShadows)}},i.BindFogParameters=function(e,t,r,n){n===void 0&&(n=!1),e.fogEnabled&&t.applyFog&&e.fogMode!==Re.FOGMODE_NONE&&(r.setFloat4("vFogInfos",e.fogMode,e.fogStart,e.fogEnd,e.fogDensity),n?(e.fogColor.toLinearSpaceToRef(this._TempFogColor),r.setColor3("vFogColor",this._TempFogColor)):r.setColor3("vFogColor",e.fogColor))},i.BindBonesParameters=function(e,t,r){if(!(!t||!e)&&(e.computeBonesUsingShaders&&t._bonesComputationForcedToCPU&&(e.computeBonesUsingShaders=!1),e.useBones&&e.computeBonesUsingShaders&&e.skeleton)){var n=e.skeleton;if(n.isUsingTextureForMatrices&&t.getUniformIndex("boneTextureWidth")>-1){var a=n.getTransformMatrixTexture(e);t.setTexture("boneSampler",a),t.setFloat("boneTextureWidth",4*(n.bones.length+1))}else{var s=n.getTransformMatrices(e);s&&(t.setMatrices("mBones",s),r&&e.getScene().prePassRenderer&&e.getScene().prePassRenderer.getIndex(2)&&(r.previousBones[e.uniqueId]||(r.previousBones[e.uniqueId]=s.slice()),t.setMatrices("mPreviousBones",r.previousBones[e.uniqueId]),i._CopyBonesTransformationMatrices(s,r.previousBones[e.uniqueId])))}}},i._CopyBonesTransformationMatrices=function(e,t){return t.set(e),t},i.BindMorphTargetParameters=function(e,t){var r=e.morphTargetManager;!e||!r||t.setFloatArray("morphTargetInfluences",r.influences)},i.BindLogDepth=function(e,t,r){if(!e||e.LOGARITHMICDEPTH){var n=r.activeCamera;n.mode===Ne.ORTHOGRAPHIC_CAMERA&&Y.Error("Logarithmic depth is not compatible with orthographic cameras!",20),t.setFloat("logarithmicDepthConstant",2/(Math.log(n.maxZ+1)/Math.LN2))}},i.BindClipPlane=function(e,t){za.BindClipPlane(e,t)},i._TmpMorphInfluencers={NUM_MORPH_INFLUENCERS:0},i._TempFogColor=me.Black(),i}(),oi=function(){function i(){this._defines={},this._currentRank=32,this._maxRank=-1,this._mesh=null}return i.prototype.unBindMesh=function(){this._mesh=null},i.prototype.addFallback=function(e,t){this._defines[e]||(e<this._currentRank&&(this._currentRank=e),e>this._maxRank&&(this._maxRank=e),this._defines[e]=new Array),this._defines[e].push(t)},i.prototype.addCPUSkinningFallback=function(e,t){this._mesh=t,e<this._currentRank&&(this._currentRank=e),e>this._maxRank&&(this._maxRank=e)},Object.defineProperty(i.prototype,"hasMoreFallbacks",{get:function(){return this._currentRank<=this._maxRank},enumerable:!1,configurable:!0}),i.prototype.reduce=function(e,t){if(this._mesh&&this._mesh.computeBonesUsingShaders&&this._mesh.numBoneInfluencers>0){this._mesh.computeBonesUsingShaders=!1,e=e.replace("#define NUM_BONE_INFLUENCERS "+this._mesh.numBoneInfluencers,"#define NUM_BONE_INFLUENCERS 0"),t._bonesComputationForcedToCPU=!0;for(var r=this._mesh.getScene(),n=0;n<r.meshes.length;n++){var a=r.meshes[n];if(!a.material){!this._mesh.material&&a.computeBonesUsingShaders&&a.numBoneInfluencers>0&&(a.computeBonesUsingShaders=!1);continue}if(!(!a.computeBonesUsingShaders||a.numBoneInfluencers===0)){if(a.material.getEffect()===t)a.computeBonesUsingShaders=!1;else if(a.subMeshes)for(var s=0,o=a.subMeshes;s<o.length;s++){var l=o[s],u=l.effect;if(u===t){a.computeBonesUsingShaders=!1;break}}}}}else{var f=this._defines[this._currentRank];if(f)for(var n=0;n<f.length;n++)e=e.replace("#define "+f[n],"");this._currentRank++}return e},i}(),Vi=function(){function i(e,t,r){this.bu=e,this.bv=t,this.distance=r,this.faceId=0,this.subMeshId=0}return i}(),Wn=function(){function i(e,t,r){this.vectors=je.BuildArray(8,m.Zero),this.center=m.Zero(),this.centerWorld=m.Zero(),this.extendSize=m.Zero(),this.extendSizeWorld=m.Zero(),this.directions=je.BuildArray(3,m.Zero),this.vectorsWorld=je.BuildArray(8,m.Zero),this.minimumWorld=m.Zero(),this.maximumWorld=m.Zero(),this.minimum=m.Zero(),this.maximum=m.Zero(),this._drawWrapperFront=null,this._drawWrapperBack=null,this.reConstruct(e,t,r)}return i.prototype.reConstruct=function(e,t,r){var n=e.x,a=e.y,s=e.z,o=t.x,l=t.y,u=t.z,f=this.vectors;this.minimum.copyFromFloats(n,a,s),this.maximum.copyFromFloats(o,l,u),f[0].copyFromFloats(n,a,s),f[1].copyFromFloats(o,l,u),f[2].copyFromFloats(o,a,s),f[3].copyFromFloats(n,l,s),f[4].copyFromFloats(n,a,u),f[5].copyFromFloats(o,l,s),f[6].copyFromFloats(n,l,u),f[7].copyFromFloats(o,a,u),t.addToRef(e,this.center).scaleInPlace(.5),t.subtractToRef(e,this.extendSize).scaleInPlace(.5),this._worldMatrix=r||G.IdentityReadOnly,this._update(this._worldMatrix)},i.prototype.scale=function(e){var t=i._TmpVector3,r=this.maximum.subtractToRef(this.minimum,t[0]),n=r.length();r.normalizeFromLength(n);var a=n*e,s=r.scaleInPlace(a*.5),o=this.center.subtractToRef(s,t[1]),l=this.center.addToRef(s,t[2]);return this.reConstruct(o,l,this._worldMatrix),this},i.prototype.getWorldMatrix=function(){return this._worldMatrix},i.prototype._update=function(e){var t=this.minimumWorld,r=this.maximumWorld,n=this.directions,a=this.vectorsWorld,s=this.vectors;if(e.isIdentity()){t.copyFrom(this.minimum),r.copyFrom(this.maximum);for(var o=0;o<8;++o)a[o].copyFrom(s[o]);this.extendSizeWorld.copyFrom(this.extendSize),this.centerWorld.copyFrom(this.center)}else{t.setAll(Number.MAX_VALUE),r.setAll(-Number.MAX_VALUE);for(var o=0;o<8;++o){var l=a[o];m.TransformCoordinatesToRef(s[o],e,l),t.minimizeInPlace(l),r.maximizeInPlace(l)}r.subtractToRef(t,this.extendSizeWorld).scaleInPlace(.5),r.addToRef(t,this.centerWorld).scaleInPlace(.5)}m.FromArrayToRef(e.m,0,n[0]),m.FromArrayToRef(e.m,4,n[1]),m.FromArrayToRef(e.m,8,n[2]),this._worldMatrix=e},i.prototype.isInFrustum=function(e){return i.IsInFrustum(this.vectorsWorld,e)},i.prototype.isCompletelyInFrustum=function(e){return i.IsCompletelyInFrustum(this.vectorsWorld,e)},i.prototype.intersectsPoint=function(e){var t=this.minimumWorld,r=this.maximumWorld,n=t.x,a=t.y,s=t.z,o=r.x,l=r.y,u=r.z,f=e.x,h=e.y,c=e.z,d=-Me;return!(o-f<d||d>f-n||l-h<d||d>h-a||u-c<d||d>c-s)},i.prototype.intersectsSphere=function(e){return i.IntersectsSphere(this.minimumWorld,this.maximumWorld,e.centerWorld,e.radiusWorld)},i.prototype.intersectsMinMax=function(e,t){var r=this.minimumWorld,n=this.maximumWorld,a=r.x,s=r.y,o=r.z,l=n.x,u=n.y,f=n.z,h=e.x,c=e.y,d=e.z,p=t.x,_=t.y,g=t.z;return!(l<h||a>p||u<c||s>_||f<d||o>g)},i.prototype.dispose=function(){var e,t;(e=this._drawWrapperFront)===null||e===void 0||e.dispose(),(t=this._drawWrapperBack)===null||t===void 0||t.dispose()},i.Intersects=function(e,t){return e.intersectsMinMax(t.minimumWorld,t.maximumWorld)},i.IntersectsSphere=function(e,t,r,n){var a=i._TmpVector3[0];m.ClampToRef(r,e,t,a);var s=m.DistanceSquared(r,a);return s<=n*n},i.IsCompletelyInFrustum=function(e,t){for(var r=0;r<6;++r)for(var n=t[r],a=0;a<8;++a)if(n.dotCoordinate(e[a])<0)return!1;return!0},i.IsInFrustum=function(e,t){for(var r=0;r<6;++r){for(var n=!0,a=t[r],s=0;s<8;++s)if(a.dotCoordinate(e[s])>=0){n=!1;break}if(n)return!1}return!0},i._TmpVector3=je.BuildArray(3,m.Zero),i}(),Hn=function(){function i(e,t,r){this.center=m.Zero(),this.centerWorld=m.Zero(),this.minimum=m.Zero(),this.maximum=m.Zero(),this.reConstruct(e,t,r)}return i.prototype.reConstruct=function(e,t,r){this.minimum.copyFrom(e),this.maximum.copyFrom(t);var n=m.Distance(e,t);t.addToRef(e,this.center).scaleInPlace(.5),this.radius=n*.5,this._update(r||G.IdentityReadOnly)},i.prototype.scale=function(e){var t=this.radius*e,r=i._TmpVector3,n=r[0].setAll(t),a=this.center.subtractToRef(n,r[1]),s=this.center.addToRef(n,r[2]);return this.reConstruct(a,s,this._worldMatrix),this},i.prototype.getWorldMatrix=function(){return this._worldMatrix},i.prototype._update=function(e){if(e.isIdentity())this.centerWorld.copyFrom(this.center),this.radiusWorld=this.radius;else{m.TransformCoordinatesToRef(this.center,e,this.centerWorld);var t=i._TmpVector3[0];m.TransformNormalFromFloatsToRef(1,1,1,e,t),this.radiusWorld=Math.max(Math.abs(t.x),Math.abs(t.y),Math.abs(t.z))*this.radius}},i.prototype.isInFrustum=function(e){for(var t=this.centerWorld,r=this.radiusWorld,n=0;n<6;n++)if(e[n].dotCoordinate(t)<=-r)return!1;return!0},i.prototype.isCenterInFrustum=function(e){for(var t=this.centerWorld,r=0;r<6;r++)if(e[r].dotCoordinate(t)<0)return!1;return!0},i.prototype.intersectsPoint=function(e){var t=m.DistanceSquared(this.centerWorld,e);return!(this.radiusWorld*this.radiusWorld<t)},i.Intersects=function(e,t){var r=m.DistanceSquared(e.centerWorld,t.centerWorld),n=e.radiusWorld+t.radiusWorld;return!(n*n<r)},i.CreateFromCenterAndRadius=function(e,t,r){this._TmpVector3[0].copyFrom(e),this._TmpVector3[1].copyFromFloats(0,0,t),this._TmpVector3[2].copyFrom(e),this._TmpVector3[0].addInPlace(this._TmpVector3[1]),this._TmpVector3[2].subtractInPlace(this._TmpVector3[1]);var n=new i(this._TmpVector3[0],this._TmpVector3[2]);return r?n._worldMatrix=r:n._worldMatrix=G.Identity(),n},i._TmpVector3=je.BuildArray(3,m.Zero),i}(),pi={min:0,max:0},_i={min:0,max:0},Xn=function(i,e,t){var r=m.Dot(e.centerWorld,i),n=Math.abs(m.Dot(e.directions[0],i))*e.extendSize.x,a=Math.abs(m.Dot(e.directions[1],i))*e.extendSize.y,s=Math.abs(m.Dot(e.directions[2],i))*e.extendSize.z,o=n+a+s;t.min=r-o,t.max=r+o},et=function(i,e,t){return Xn(i,e,pi),Xn(i,t,_i),!(pi.min>_i.max||_i.min>pi.max)},lr=function(){function i(e,t,r){this._isLocked=!1,this.boundingBox=new Wn(e,t,r),this.boundingSphere=new Hn(e,t,r)}return i.prototype.reConstruct=function(e,t,r){this.boundingBox.reConstruct(e,t,r),this.boundingSphere.reConstruct(e,t,r)},Object.defineProperty(i.prototype,"minimum",{get:function(){return this.boundingBox.minimum},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"maximum",{get:function(){return this.boundingBox.maximum},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"isLocked",{get:function(){return this._isLocked},set:function(e){this._isLocked=e},enumerable:!1,configurable:!0}),i.prototype.update=function(e){this._isLocked||(this.boundingBox._update(e),this.boundingSphere._update(e))},i.prototype.centerOn=function(e,t){var r=i._TmpVector3[0].copyFrom(e).subtractInPlace(t),n=i._TmpVector3[1].copyFrom(e).addInPlace(t);return this.boundingBox.reConstruct(r,n,this.boundingBox.getWorldMatrix()),this.boundingSphere.reConstruct(r,n,this.boundingBox.getWorldMatrix()),this},i.prototype.encapsulate=function(e){var t=m.Minimize(this.minimum,e),r=m.Maximize(this.maximum,e);return this.reConstruct(t,r,this.boundingBox.getWorldMatrix()),this},i.prototype.encapsulateBoundingInfo=function(e){return this.encapsulate(e.boundingBox.centerWorld.subtract(e.boundingBox.extendSizeWorld)),this.encapsulate(e.boundingBox.centerWorld.add(e.boundingBox.extendSizeWorld)),this},i.prototype.scale=function(e){return this.boundingBox.scale(e),this.boundingSphere.scale(e),this},i.prototype.isInFrustum=function(e,t){t===void 0&&(t=0);var r=t===2||t===3;if(r&&this.boundingSphere.isCenterInFrustum(e))return!0;if(!this.boundingSphere.isInFrustum(e))return!1;var n=t===1||t===3;return n?!0:this.boundingBox.isInFrustum(e)},Object.defineProperty(i.prototype,"diagonalLength",{get:function(){var e=this.boundingBox,t=e.maximumWorld.subtractToRef(e.minimumWorld,i._TmpVector3[0]);return t.length()},enumerable:!1,configurable:!0}),i.prototype.isCompletelyInFrustum=function(e){return this.boundingBox.isCompletelyInFrustum(e)},i.prototype._checkCollision=function(e){return e._canDoCollision(this.boundingSphere.centerWorld,this.boundingSphere.radiusWorld,this.boundingBox.minimumWorld,this.boundingBox.maximumWorld)},i.prototype.intersectsPoint=function(e){return!(!this.boundingSphere.centerWorld||!this.boundingSphere.intersectsPoint(e)||!this.boundingBox.intersectsPoint(e))},i.prototype.intersects=function(e,t){if(!Hn.Intersects(this.boundingSphere,e.boundingSphere)||!Wn.Intersects(this.boundingBox,e.boundingBox))return!1;if(!t)return!0;var r=this.boundingBox,n=e.boundingBox;return!(!et(r.directions[0],r,n)||!et(r.directions[1],r,n)||!et(r.directions[2],r,n)||!et(n.directions[0],r,n)||!et(n.directions[1],r,n)||!et(n.directions[2],r,n)||!et(m.Cross(r.directions[0],n.directions[0]),r,n)||!et(m.Cross(r.directions[0],n.directions[1]),r,n)||!et(m.Cross(r.directions[0],n.directions[2]),r,n)||!et(m.Cross(r.directions[1],n.directions[0]),r,n)||!et(m.Cross(r.directions[1],n.directions[1]),r,n)||!et(m.Cross(r.directions[1],n.directions[2]),r,n)||!et(m.Cross(r.directions[2],n.directions[0]),r,n)||!et(m.Cross(r.directions[2],n.directions[1]),r,n)||!et(m.Cross(r.directions[2],n.directions[2]),r,n))},i._TmpVector3=je.BuildArray(2,m.Zero),i}(),Wa=function(){function i(){}return i.extractMinAndMaxIndexed=function(e,t,r,n,a,s){for(var o=r;o<r+n;o++){var l=t[o]*3,u=e[l],f=e[l+1],h=e[l+2];a.minimizeInPlaceFromFloats(u,f,h),s.maximizeInPlaceFromFloats(u,f,h)}},i.extractMinAndMax=function(e,t,r,n,a,s){for(var o=t,l=t*n;o<t+r;o++,l+=n){var u=e[l],f=e[l+1],h=e[l+2];a.minimizeInPlaceFromFloats(u,f,h),s.maximizeInPlaceFromFloats(u,f,h)}},C([Zt.filter(function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];var r=e[0],n=e[1];return!Array.isArray(r)&&!Array.isArray(n)})],i,"extractMinAndMaxIndexed",null),C([Zt.filter(function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];var r=e[0];return!Array.isArray(r)})],i,"extractMinAndMax",null),i}();function ll(i,e,t,r,n){n===void 0&&(n=null);var a=new m(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),s=new m(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE);return Wa.extractMinAndMaxIndexed(i,e,t,r,a,s),n&&(a.x-=a.x*n.x+n.y,a.y-=a.y*n.x+n.y,a.z-=a.z*n.x+n.y,s.x+=s.x*n.x+n.y,s.y+=s.y*n.x+n.y,s.z+=s.z*n.x+n.y),{minimum:a,maximum:s}}function Ha(i,e,t,r,n){r===void 0&&(r=null);var a=new m(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),s=new m(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE);return n||(n=3),Wa.extractMinAndMax(i,e,t,n,a,s),r&&(a.x-=a.x*r.x+r.y,a.y-=a.y*r.x+r.y,a.z-=a.z*r.x+r.y,s.x+=s.x*r.x+r.y,s.y+=s.y*r.x+r.y,s.z+=s.z*r.x+r.y),{minimum:a,maximum:s}}var qt=function(){function i(e,t,r,n,a,s,o,l,u){l===void 0&&(l=!0),u===void 0&&(u=!0),this.materialIndex=e,this.verticesStart=t,this.verticesCount=r,this.indexStart=n,this.indexCount=a,this._mainDrawWrapperOverride=null,this._linesIndexCount=0,this._linesIndexBuffer=null,this._lastColliderWorldVertices=null,this._lastColliderTransformMatrix=null,this._renderId=0,this._alphaIndex=0,this._distanceToCamera=0,this._currentMaterial=null,this._mesh=s,this._renderingMesh=o||s,u&&s.subMeshes.push(this),this._engine=this._mesh.getScene().getEngine(),this.resetDrawCache(),this._trianglePlanes=[],this._id=s.subMeshes.length-1,l&&(this.refreshBoundingInfo(),s.computeWorldMatrix(!0))}return Object.defineProperty(i.prototype,"materialDefines",{get:function(){var e;return this._mainDrawWrapperOverride?this._mainDrawWrapperOverride.defines:(e=this._getDrawWrapper())===null||e===void 0?void 0:e.defines},set:function(e){var t,r=(t=this._mainDrawWrapperOverride)!==null&&t!==void 0?t:this._getDrawWrapper(void 0,!0);r.defines=e},enumerable:!1,configurable:!0}),i.prototype._getDrawWrapper=function(e,t){t===void 0&&(t=!1),e=e!=null?e:this._engine.currentRenderPassId;var r=this._drawWrappers[e];return!r&&t&&(this._drawWrappers[e]=r=new Bt(this._mesh.getScene().getEngine())),r},i.prototype._removeDrawWrapper=function(e,t){var r;t===void 0&&(t=!0),t&&((r=this._drawWrappers[e])===null||r===void 0||r.dispose()),this._drawWrappers[e]=void 0},Object.defineProperty(i.prototype,"effect",{get:function(){var e,t;return this._mainDrawWrapperOverride?this._mainDrawWrapperOverride.effect:(t=(e=this._getDrawWrapper())===null||e===void 0?void 0:e.effect)!==null&&t!==void 0?t:null},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"_drawWrapper",{get:function(){var e;return(e=this._mainDrawWrapperOverride)!==null&&e!==void 0?e:this._getDrawWrapper(void 0,!0)},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"_drawWrapperOverride",{get:function(){return this._mainDrawWrapperOverride},enumerable:!1,configurable:!0}),i.prototype._setMainDrawWrapperOverride=function(e){this._mainDrawWrapperOverride=e},i.prototype.setEffect=function(e,t,r,n){t===void 0&&(t=null),n===void 0&&(n=!0);var a=this._drawWrapper;a.setEffect(e,t,n),r!==void 0&&(a.materialContext=r),e||(a.defines=null,a.materialContext=void 0)},i.prototype.resetDrawCache=function(e){if(this._drawWrappers)if(e!==void 0){this._removeDrawWrapper(e);return}else for(var t=0,r=this._drawWrappers;t<r.length;t++){var n=r[t];n==null||n.dispose()}this._drawWrappers=[]},i.AddToMesh=function(e,t,r,n,a,s,o,l){return l===void 0&&(l=!0),new i(e,t,r,n,a,s,o,l)},Object.defineProperty(i.prototype,"IsGlobal",{get:function(){return this.verticesStart===0&&this.verticesCount===this._mesh.getTotalVertices()},enumerable:!1,configurable:!0}),i.prototype.getBoundingInfo=function(){return this.IsGlobal?this._mesh.getBoundingInfo():this._boundingInfo},i.prototype.setBoundingInfo=function(e){return this._boundingInfo=e,this},i.prototype.getMesh=function(){return this._mesh},i.prototype.getRenderingMesh=function(){return this._renderingMesh},i.prototype.getReplacementMesh=function(){return this._mesh._internalAbstractMeshDataInfo._actAsRegularMesh?this._mesh:null},i.prototype.getEffectiveMesh=function(){var e=this._mesh._internalAbstractMeshDataInfo._actAsRegularMesh?this._mesh:null;return e||this._renderingMesh},i.prototype.getMaterial=function(){var e,t=(e=this._renderingMesh.getMaterialForRenderPass(this._engine.currentRenderPassId))!==null&&e!==void 0?e:this._renderingMesh.material;if(t==null)return this._mesh.getScene().defaultMaterial;if(this._isMultiMaterial(t)){var r=t.getSubMaterial(this.materialIndex);return this._currentMaterial!==r&&(this._currentMaterial=r,this.resetDrawCache()),r}return t},i.prototype._isMultiMaterial=function(e){return e.getSubMaterial!==void 0},i.prototype.refreshBoundingInfo=function(e){if(e===void 0&&(e=null),this._lastColliderWorldVertices=null,this.IsGlobal||!this._renderingMesh||!this._renderingMesh.geometry)return this;if(e||(e=this._renderingMesh.getVerticesData(R.PositionKind)),!e)return this._boundingInfo=this._mesh.getBoundingInfo(),this;var t=this._renderingMesh.getIndices(),r;if(this.indexStart===0&&this.indexCount===t.length){var n=this._renderingMesh.getBoundingInfo();r={minimum:n.minimum.clone(),maximum:n.maximum.clone()}}else r=ll(e,t,this.indexStart,this.indexCount,this._renderingMesh.geometry.boundingBias);return this._boundingInfo?this._boundingInfo.reConstruct(r.minimum,r.maximum):this._boundingInfo=new lr(r.minimum,r.maximum),this},i.prototype._checkCollision=function(e){var t=this.getBoundingInfo();return t._checkCollision(e)},i.prototype.updateBoundingInfo=function(e){var t=this.getBoundingInfo();return t||(this.refreshBoundingInfo(),t=this.getBoundingInfo()),t&&t.update(e),this},i.prototype.isInFrustum=function(e){var t=this.getBoundingInfo();return t?t.isInFrustum(e,this._mesh.cullingStrategy):!1},i.prototype.isCompletelyInFrustum=function(e){var t=this.getBoundingInfo();return t?t.isCompletelyInFrustum(e):!1},i.prototype.render=function(e){return this._renderingMesh.render(this,e,this._mesh._internalAbstractMeshDataInfo._actAsRegularMesh?this._mesh:void 0),this},i.prototype._getLinesIndexBuffer=function(e,t){if(!this._linesIndexBuffer){for(var r=[],n=this.indexStart;n<this.indexStart+this.indexCount;n+=3)r.push(e[n],e[n+1],e[n+1],e[n+2],e[n+2],e[n]);this._linesIndexBuffer=t.createIndexBuffer(r),this._linesIndexCount=r.length}return this._linesIndexBuffer},i.prototype.canIntersects=function(e){var t=this.getBoundingInfo();return t?e.intersectsBox(t.boundingBox):!1},i.prototype.intersects=function(e,t,r,n,a){var s=this.getMaterial();if(!s)return null;var o=3,l=!1;switch(s.fillMode){case 3:case 5:case 6:case 8:return null;case 7:o=1,l=!0;break}return s.fillMode===4?r.length?this._intersectLines(e,t,r,this._mesh.intersectionThreshold,n):this._intersectUnIndexedLines(e,t,r,this._mesh.intersectionThreshold,n):!r.length&&this._mesh._unIndexed?this._intersectUnIndexedTriangles(e,t,r,n,a):this._intersectTriangles(e,t,r,o,l,n,a)},i.prototype._intersectLines=function(e,t,r,n,a){for(var s=null,o=this.indexStart;o<this.indexStart+this.indexCount;o+=2){var l=t[r[o]],u=t[r[o+1]],f=e.intersectionSegment(l,u,n);if(!(f<0)&&(a||!s||f<s.distance)&&(s=new Vi(null,null,f),s.faceId=o/2,a))break}return s},i.prototype._intersectUnIndexedLines=function(e,t,r,n,a){for(var s=null,o=this.verticesStart;o<this.verticesStart+this.verticesCount;o+=2){var l=t[o],u=t[o+1],f=e.intersectionSegment(l,u,n);if(!(f<0)&&(a||!s||f<s.distance)&&(s=new Vi(null,null,f),s.faceId=o/2,a))break}return s},i.prototype._intersectTriangles=function(e,t,r,n,a,s,o){for(var l=null,u=-1,f=this.indexStart;f<this.indexStart+this.indexCount-(3-n);f+=n){u++;var h=r[f],c=r[f+1],d=r[f+2];if(a&&d===4294967295){f+=2;continue}var p=t[h],_=t[c],g=t[d];if(!(!p||!_||!g)&&!(o&&!o(p,_,g,e))){var v=e.intersectsTriangle(p,_,g);if(v){if(v.distance<0)continue;if((s||!l||v.distance<l.distance)&&(l=v,l.faceId=u,s))break}}}return l},i.prototype._intersectUnIndexedTriangles=function(e,t,r,n,a){for(var s=null,o=this.verticesStart;o<this.verticesStart+this.verticesCount;o+=3){var l=t[o],u=t[o+1],f=t[o+2];if(!(a&&!a(l,u,f,e))){var h=e.intersectsTriangle(l,u,f);if(h){if(h.distance<0)continue;if((n||!s||h.distance<s.distance)&&(s=h,s.faceId=o/3,n))break}}}return s},i.prototype._rebuild=function(){this._linesIndexBuffer&&(this._linesIndexBuffer=null)},i.prototype.clone=function(e,t){var r=new i(this.materialIndex,this.verticesStart,this.verticesCount,this.indexStart,this.indexCount,e,t,!1);if(!this.IsGlobal){var n=this.getBoundingInfo();if(!n)return r;r._boundingInfo=new lr(n.minimum,n.maximum)}return r},i.prototype.dispose=function(){this._linesIndexBuffer&&(this._mesh.getScene().getEngine()._releaseBuffer(this._linesIndexBuffer),this._linesIndexBuffer=null);var e=this._mesh.subMeshes.indexOf(this);this._mesh.subMeshes.splice(e,1),this.resetDrawCache()},i.prototype.getClassName=function(){return"SubMesh"},i.CreateFromIndices=function(e,t,r,n,a,s){s===void 0&&(s=!0);for(var o=Number.MAX_VALUE,l=-Number.MAX_VALUE,u=a||n,f=u.getIndices(),h=t;h<t+r;h++){var c=f[h];c<o&&(o=c),c>l&&(l=c)}return new i(e,o,l-o+1,t,r,n,a,s)},i}(),ul=function(){function i(){this.reset()}return i.prototype.reset=function(){this.enabled=!1,this.mask=255,this.func=519,this.funcRef=1,this.funcMask=255,this.opStencilFail=7680,this.opDepthFail=7680,this.opStencilDepthPass=7681},Object.defineProperty(i.prototype,"func",{get:function(){return this._func},set:function(e){this._func=e},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"funcRef",{get:function(){return this._funcRef},set:function(e){this._funcRef=e},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"funcMask",{get:function(){return this._funcMask},set:function(e){this._funcMask=e},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"opStencilFail",{get:function(){return this._opStencilFail},set:function(e){this._opStencilFail=e},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"opDepthFail",{get:function(){return this._opDepthFail},set:function(e){this._opDepthFail=e},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"opStencilDepthPass",{get:function(){return this._opStencilDepthPass},set:function(e){this._opStencilDepthPass=e},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"mask",{get:function(){return this._mask},set:function(e){this._mask=e},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"enabled",{get:function(){return this._enabled},set:function(e){this._enabled=e},enumerable:!1,configurable:!0}),i.prototype.getClassName=function(){return"MaterialStencilState"},i.prototype.copyTo=function(e){pe.Clone(function(){return e},this)},i.prototype.serialize=function(){return pe.Serialize(this)},i.prototype.parse=function(e,t,r){var n=this;pe.Parse(function(){return n},e,t,r)},C([I()],i.prototype,"func",null),C([I()],i.prototype,"funcRef",null),C([I()],i.prototype,"funcMask",null),C([I()],i.prototype,"opStencilFail",null),C([I()],i.prototype,"opDepthFail",null),C([I()],i.prototype,"opStencilDepthPass",null),C([I()],i.prototype,"mask",null),C([I()],i.prototype,"enabled",null),i}(),Qe;(function(i){i[i.Created=1]="Created",i[i.Disposed=2]="Disposed",i[i.GetDefineNames=4]="GetDefineNames",i[i.PrepareUniformBuffer=8]="PrepareUniformBuffer",i[i.IsReadyForSubMesh=16]="IsReadyForSubMesh",i[i.PrepareDefines=32]="PrepareDefines",i[i.BindForSubMesh=64]="BindForSubMesh",i[i.PrepareEffect=128]="PrepareEffect",i[i.GetAnimatables=256]="GetAnimatables",i[i.GetActiveTextures=512]="GetActiveTextures",i[i.HasTexture=1024]="HasTexture",i[i.FillRenderTargetTextures=2048]="FillRenderTargetTextures",i[i.HasRenderTargetTextures=4096]="HasRenderTargetTextures",i[i.HardBindForSubMesh=8192]="HardBindForSubMesh"})(Qe||(Qe={}));var He=function(){function i(e,t,r){this.shadowDepthWrapper=null,this.allowShaderHotSwapping=!0,this.metadata=null,this.reservedDataStore=null,this.checkReadyOnEveryCall=!1,this.checkReadyOnlyOnce=!1,this.state="",this._alpha=1,this._backFaceCulling=!0,this._cullBackFaces=!0,this.onCompiled=null,this.onError=null,this.getRenderTargetTextures=null,this.doNotSerialize=!1,this._storeEffectOnSubMeshes=!1,this.animations=null,this.onDisposeObservable=new X,this._onDisposeObserver=null,this._onUnBindObservable=null,this._onBindObserver=null,this._alphaMode=2,this._needDepthPrePass=!1,this.disableDepthWrite=!1,this.disableColorWrite=!1,this.forceDepthWrite=!1,this.depthFunction=0,this.separateCullingPass=!1,this._fogEnabled=!0,this.pointSize=1,this.zOffset=0,this.zOffsetUnits=0,this.stencil=new ul,this._useUBO=!1,this._fillMode=i.TriangleFillMode,this._cachedDepthWriteState=!1,this._cachedColorWriteState=!1,this._cachedDepthFunctionState=0,this._indexInSceneMaterialArray=-1,this.meshMap=null,this._parentContainer=null,this._uniformBufferLayoutBuilt=!1,this._eventInfo={},this._callbackPluginEventGeneric=function(){},this._callbackPluginEventIsReadyForSubMesh=function(){},this._callbackPluginEventPrepareDefines=function(){},this._callbackPluginEventHardBindForSubMesh=function(){},this._callbackPluginEventBindForSubMesh=function(){},this._callbackPluginEventHasRenderTargetTextures=function(){},this._callbackPluginEventFillRenderTargetTextures=function(){},this._forceAlphaTest=!1,this._transparencyMode=null,this.name=e;var n=t||ye.LastCreatedScene;!n||(this._scene=n,this._dirtyCallbacks={},this._dirtyCallbacks[1]=this._markAllSubMeshesAsTexturesDirty.bind(this),this._dirtyCallbacks[2]=this._markAllSubMeshesAsLightsDirty.bind(this),this._dirtyCallbacks[4]=this._markAllSubMeshesAsFresnelDirty.bind(this),this._dirtyCallbacks[8]=this._markAllSubMeshesAsAttributesDirty.bind(this),this._dirtyCallbacks[16]=this._markAllSubMeshesAsMiscDirty.bind(this),this._dirtyCallbacks[32]=this._markAllSubMeshesAsPrePassDirty.bind(this),this._dirtyCallbacks[63]=this._markAllSubMeshesAsAllDirty.bind(this),this.id=e||te.RandomId(),this.uniqueId=this._scene.getUniqueId(),this._materialContext=this._scene.getEngine().createMaterialContext(),this._drawWrapper=new Bt(this._scene.getEngine(),!1),this._drawWrapper.materialContext=this._materialContext,this._scene.useRightHandedSystem?this.sideOrientation=i.ClockWiseSideOrientation:this.sideOrientation=i.CounterClockWiseSideOrientation,this._uniformBuffer=new si(this._scene.getEngine(),void 0,void 0,e),this._useUBO=this.getScene().getEngine().supportsUniformBuffers,r||this._scene.addMaterial(this),this._scene.useMaterialMeshMap&&(this.meshMap={}),i.OnEventObservable.notifyObservers(this,Qe.Created))}return Object.defineProperty(i.prototype,"canRenderToMRT",{get:function(){return!1},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"alpha",{get:function(){return this._alpha},set:function(e){this._alpha!==e&&(this._alpha=e,this.markAsDirty(i.MiscDirtyFlag))},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"backFaceCulling",{get:function(){return this._backFaceCulling},set:function(e){this._backFaceCulling!==e&&(this._backFaceCulling=e,this.markAsDirty(i.TextureDirtyFlag))},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"cullBackFaces",{get:function(){return this._cullBackFaces},set:function(e){this._cullBackFaces!==e&&(this._cullBackFaces=e,this.markAsDirty(i.TextureDirtyFlag))},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"hasRenderTargetTextures",{get:function(){return this._eventInfo.hasRenderTargetTextures=!1,this._callbackPluginEventHasRenderTargetTextures(this._eventInfo),this._eventInfo.hasRenderTargetTextures},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"onDispose",{set:function(e){this._onDisposeObserver&&this.onDisposeObservable.remove(this._onDisposeObserver),this._onDisposeObserver=this.onDisposeObservable.add(e)},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"onBindObservable",{get:function(){return this._onBindObservable||(this._onBindObservable=new X),this._onBindObservable},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"onBind",{set:function(e){this._onBindObserver&&this.onBindObservable.remove(this._onBindObserver),this._onBindObserver=this.onBindObservable.add(e)},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"onUnBindObservable",{get:function(){return this._onUnBindObservable||(this._onUnBindObservable=new X),this._onUnBindObservable},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"onEffectCreatedObservable",{get:function(){return this._onEffectCreatedObservable||(this._onEffectCreatedObservable=new X),this._onEffectCreatedObservable},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"alphaMode",{get:function(){return this._alphaMode},set:function(e){this._alphaMode!==e&&(this._alphaMode=e,this.markAsDirty(i.TextureDirtyFlag))},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"needDepthPrePass",{get:function(){return this._needDepthPrePass},set:function(e){this._needDepthPrePass!==e&&(this._needDepthPrePass=e,this._needDepthPrePass&&(this.checkReadyOnEveryCall=!0))},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"isPrePassCapable",{get:function(){return!1},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"fogEnabled",{get:function(){return this._fogEnabled},set:function(e){this._fogEnabled!==e&&(this._fogEnabled=e,this.markAsDirty(i.MiscDirtyFlag))},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"wireframe",{get:function(){switch(this._fillMode){case i.WireFrameFillMode:case i.LineListDrawMode:case i.LineLoopDrawMode:case i.LineStripDrawMode:return!0}return this._scene.forceWireframe},set:function(e){this.fillMode=e?i.WireFrameFillMode:i.TriangleFillMode},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"pointsCloud",{get:function(){switch(this._fillMode){case i.PointFillMode:case i.PointListDrawMode:return!0}return this._scene.forcePointsCloud},set:function(e){this.fillMode=e?i.PointFillMode:i.TriangleFillMode},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"fillMode",{get:function(){return this._fillMode},set:function(e){this._fillMode!==e&&(this._fillMode=e,this.markAsDirty(i.MiscDirtyFlag))},enumerable:!1,configurable:!0}),i.prototype._getDrawWrapper=function(){return this._drawWrapper},i.prototype._setDrawWrapper=function(e){this._drawWrapper=e},i.prototype.toString=function(e){var t="Name: "+this.name;return t},i.prototype.getClassName=function(){return"Material"},Object.defineProperty(i.prototype,"isFrozen",{get:function(){return this.checkReadyOnlyOnce},enumerable:!1,configurable:!0}),i.prototype.freeze=function(){this.markDirty(),this.checkReadyOnlyOnce=!0},i.prototype.unfreeze=function(){this.markDirty(),this.checkReadyOnlyOnce=!1},i.prototype.isReady=function(e,t){return!0},i.prototype.isReadyForSubMesh=function(e,t,r){var n=t.materialDefines;return n?(this._eventInfo.isReadyForSubMesh=!0,this._eventInfo.defines=n,this._callbackPluginEventIsReadyForSubMesh(this._eventInfo),this._eventInfo.isReadyForSubMesh):!1},i.prototype.getEffect=function(){return this._drawWrapper.effect},i.prototype.getScene=function(){return this._scene},Object.defineProperty(i.prototype,"transparencyMode",{get:function(){return this._transparencyMode},set:function(e){this._transparencyMode!==e&&(this._transparencyMode=e,this._forceAlphaTest=e===i.MATERIAL_ALPHATESTANDBLEND,this._markAllSubMeshesAsTexturesAndMiscDirty())},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"_disableAlphaBlending",{get:function(){return this._transparencyMode===i.MATERIAL_OPAQUE||this._transparencyMode===i.MATERIAL_ALPHATEST},enumerable:!1,configurable:!0}),i.prototype.needAlphaBlending=function(){return this._disableAlphaBlending?!1:this.alpha<1},i.prototype.needAlphaBlendingForMesh=function(e){return this._disableAlphaBlending&&e.visibility>=1?!1:this.needAlphaBlending()||e.visibility<1||e.hasVertexAlpha},i.prototype.needAlphaTesting=function(){return!!this._forceAlphaTest},i.prototype._shouldTurnAlphaTestOn=function(e){return!this.needAlphaBlendingForMesh(e)&&this.needAlphaTesting()},i.prototype.getAlphaTestTexture=function(){return null},i.prototype.markDirty=function(){for(var e=this.getScene().meshes,t=0,r=e;t<r.length;t++){var n=r[t];if(!!n.subMeshes)for(var a=0,s=n.subMeshes;a<s.length;a++){var o=s[a];o.getMaterial()===this&&(!o.effect||(o.effect._wasPreviouslyReady=!1))}}},i.prototype._preBind=function(e,t){t===void 0&&(t=null);var r=this._scene.getEngine(),n=t==null?this.sideOrientation:t,a=n===i.ClockWiseSideOrientation;return r.enableEffect(e||this._getDrawWrapper()),r.setState(this.backFaceCulling,this.zOffset,!1,a,this.cullBackFaces,this.stencil,this.zOffsetUnits),a},i.prototype.bind=function(e,t){},i.prototype.buildUniformLayout=function(){var e=this._uniformBuffer;this._eventInfo.ubo=e,this._callbackPluginEventGeneric(Qe.PrepareUniformBuffer,this._eventInfo),e.create(),this._uniformBufferLayoutBuilt=!0},i.prototype.bindForSubMesh=function(e,t,r){var n=r.effect;!n||(this._eventInfo.subMesh=r,this._callbackPluginEventBindForSubMesh(this._eventInfo))},i.prototype.bindOnlyWorldMatrix=function(e){},i.prototype.bindView=function(e){this._useUBO?this._needToBindSceneUbo=!0:e.setMatrix("view",this.getScene().getViewMatrix())},i.prototype.bindViewProjection=function(e){this._useUBO?this._needToBindSceneUbo=!0:(e.setMatrix("viewProjection",this.getScene().getTransformMatrix()),e.setMatrix("projection",this.getScene().getProjectionMatrix()))},i.prototype.bindEyePosition=function(e,t){this._useUBO?this._needToBindSceneUbo=!0:this._scene.bindEyePosition(e,t)},i.prototype._afterBind=function(e,t){if(t===void 0&&(t=null),this._scene._cachedMaterial=this,this._needToBindSceneUbo&&t&&(this._needToBindSceneUbo=!1,le.BindSceneUniformBuffer(t,this.getScene().getSceneUniformBuffer()),this._scene.finalizeSceneUbo()),e?this._scene._cachedVisibility=e.visibility:this._scene._cachedVisibility=1,this._onBindObservable&&e&&this._onBindObservable.notifyObservers(e),this.disableDepthWrite){var r=this._scene.getEngine();this._cachedDepthWriteState=r.getDepthWrite(),r.setDepthWrite(!1)}if(this.disableColorWrite){var r=this._scene.getEngine();this._cachedColorWriteState=r.getColorWrite(),r.setColorWrite(!1)}if(this.depthFunction!==0){var r=this._scene.getEngine();this._cachedDepthFunctionState=r.getDepthFunction()||0,r.setDepthFunction(this.depthFunction)}},i.prototype.unbind=function(){if(this._onUnBindObservable&&this._onUnBindObservable.notifyObservers(this),this.depthFunction!==0){var e=this._scene.getEngine();e.setDepthFunction(this._cachedDepthFunctionState)}if(this.disableDepthWrite){var e=this._scene.getEngine();e.setDepthWrite(this._cachedDepthWriteState)}if(this.disableColorWrite){var e=this._scene.getEngine();e.setColorWrite(this._cachedColorWriteState)}},i.prototype.getAnimatables=function(){return this._eventInfo.animatables=[],this._callbackPluginEventGeneric(Qe.GetAnimatables,this._eventInfo),this._eventInfo.animatables},i.prototype.getActiveTextures=function(){return this._eventInfo.activeTextures=[],this._callbackPluginEventGeneric(Qe.GetActiveTextures,this._eventInfo),this._eventInfo.activeTextures},i.prototype.hasTexture=function(e){return this._eventInfo.hasTexture=!1,this._eventInfo.texture=e,this._callbackPluginEventGeneric(Qe.HasTexture,this._eventInfo),this._eventInfo.hasTexture},i.prototype.clone=function(e){return null},i.prototype.getBindedMeshes=function(){var e=this;if(this.meshMap){var t=new Array;for(var r in this.meshMap){var n=this.meshMap[r];n&&t.push(n)}return t}else{var a=this._scene.meshes;return a.filter(function(s){return s.material===e})}},i.prototype.forceCompilation=function(e,t,r,n){var a=this,s=Ue({clipPlane:!1,useInstances:!1},r),o=this.getScene(),l=this.allowShaderHotSwapping;this.allowShaderHotSwapping=!1;var u=function(){if(!(!a._scene||!a._scene.getEngine())){var f=o.clipPlane;if(s.clipPlane&&(o.clipPlane=new yr(0,0,0,1)),a._storeEffectOnSubMeshes){var h=!0,c=null;if(e.subMeshes){var d=new qt(0,0,0,0,0,e,void 0,!1,!1);d.materialDefines&&(d.materialDefines._renderId=-1),a.isReadyForSubMesh(e,d,s.useInstances)||(d.effect&&d.effect.getCompilationError()&&d.effect.allFallbacksProcessed()?c=d.effect.getCompilationError():(h=!1,setTimeout(u,16)))}h&&(a.allowShaderHotSwapping=l,c&&n&&n(c),t&&t(a))}else a.isReady()?(a.allowShaderHotSwapping=l,t&&t(a)):setTimeout(u,16);s.clipPlane&&(o.clipPlane=f)}};u()},i.prototype.forceCompilationAsync=function(e,t){var r=this;return new Promise(function(n,a){r.forceCompilation(e,function(){n()},t,function(s){a(s)})})},i.prototype.markAsDirty=function(e){this.getScene().blockMaterialDirtyMechanism||(i._DirtyCallbackArray.length=0,e&i.TextureDirtyFlag&&i._DirtyCallbackArray.push(i._TextureDirtyCallBack),e&i.LightDirtyFlag&&i._DirtyCallbackArray.push(i._LightsDirtyCallBack),e&i.FresnelDirtyFlag&&i._DirtyCallbackArray.push(i._FresnelDirtyCallBack),e&i.AttributesDirtyFlag&&i._DirtyCallbackArray.push(i._AttributeDirtyCallBack),e&i.MiscDirtyFlag&&i._DirtyCallbackArray.push(i._MiscDirtyCallBack),e&i.PrePassDirtyFlag&&i._DirtyCallbackArray.push(i._PrePassDirtyCallBack),i._DirtyCallbackArray.length&&this._markAllSubMeshesAsDirty(i._RunDirtyCallBacks),this.getScene().resetCachedMaterial())},i.prototype.resetDrawCache=function(){for(var e=this.getScene().meshes,t=0,r=e;t<r.length;t++){var n=r[t];if(!!n.subMeshes)for(var a=0,s=n.subMeshes;a<s.length;a++){var o=s[a];o.getMaterial()===this&&o.resetDrawCache()}}},i.prototype._markAllSubMeshesAsDirty=function(e){if(!this.getScene().blockMaterialDirtyMechanism)for(var t=this.getScene().meshes,r=0,n=t;r<n.length;r++){var a=n[r];if(!!a.subMeshes)for(var s=0,o=a.subMeshes;s<o.length;s++){var l=o[s];if(!(a._renderId===0||l.getMaterial()!==this))for(var u=0,f=l._drawWrappers;u<f.length;u++){var h=f[u];!h||!h.defines||!h.defines.markAllAsDirty||this._materialContext===h.materialContext&&e(h.defines)}}}},i.prototype._markScenePrePassDirty=function(){if(!this.getScene().blockMaterialDirtyMechanism){var e=this.getScene().enablePrePassRenderer();e&&e.markAsDirty()}},i.prototype._markAllSubMeshesAsAllDirty=function(){this._markAllSubMeshesAsDirty(i._AllDirtyCallBack)},i.prototype._markAllSubMeshesAsImageProcessingDirty=function(){this._markAllSubMeshesAsDirty(i._ImageProcessingDirtyCallBack)},i.prototype._markAllSubMeshesAsTexturesDirty=function(){this._markAllSubMeshesAsDirty(i._TextureDirtyCallBack)},i.prototype._markAllSubMeshesAsFresnelDirty=function(){this._markAllSubMeshesAsDirty(i._FresnelDirtyCallBack)},i.prototype._markAllSubMeshesAsFresnelAndMiscDirty=function(){this._markAllSubMeshesAsDirty(i._FresnelAndMiscDirtyCallBack)},i.prototype._markAllSubMeshesAsLightsDirty=function(){this._markAllSubMeshesAsDirty(i._LightsDirtyCallBack)},i.prototype._markAllSubMeshesAsAttributesDirty=function(){this._markAllSubMeshesAsDirty(i._AttributeDirtyCallBack)},i.prototype._markAllSubMeshesAsMiscDirty=function(){this._markAllSubMeshesAsDirty(i._MiscDirtyCallBack)},i.prototype._markAllSubMeshesAsPrePassDirty=function(){this._markAllSubMeshesAsDirty(i._MiscDirtyCallBack)},i.prototype._markAllSubMeshesAsTexturesAndMiscDirty=function(){this._markAllSubMeshesAsDirty(i._TextureAndMiscDirtyCallBack)},i.prototype.setPrePassRenderer=function(e){return!1},i.prototype.dispose=function(e,t,r){var n=this.getScene();if(n.stopAnimation(this),n.freeProcessedMaterials(),n.removeMaterial(this),this._eventInfo.forceDisposeTextures=t,this._callbackPluginEventGeneric(Qe.Disposed,this._eventInfo),this._parentContainer){var a=this._parentContainer.materials.indexOf(this);a>-1&&this._parentContainer.materials.splice(a,1),this._parentContainer=null}if(r!==!0)if(this.meshMap)for(var s in this.meshMap){var o=this.meshMap[s];o&&(o.material=null,this.releaseVertexArrayObject(o,e))}else for(var l=n.meshes,u=0,f=l;u<f.length;u++){var o=f[u];o.material===this&&!o.sourceMesh&&(o.material=null,this.releaseVertexArrayObject(o,e))}this._uniformBuffer.dispose(),e&&this._drawWrapper.effect&&(this._storeEffectOnSubMeshes||this._drawWrapper.effect.dispose(),this._drawWrapper.effect=null),this.metadata=null,this.onDisposeObservable.notifyObservers(this),this.onDisposeObservable.clear(),this._onBindObservable&&this._onBindObservable.clear(),this._onUnBindObservable&&this._onUnBindObservable.clear(),this._onEffectCreatedObservable&&this._onEffectCreatedObservable.clear()},i.prototype.releaseVertexArrayObject=function(e,t){if(e.geometry){var r=e.geometry;if(this._storeEffectOnSubMeshes)for(var n=0,a=e.subMeshes;n<a.length;n++){var s=a[n];r._releaseVertexArrayObject(s.effect),t&&s.effect&&s.effect.dispose()}else r._releaseVertexArrayObject(this._drawWrapper.effect)}},i.prototype.serialize=function(){var e=pe.Serialize(this);return e.stencil=this.stencil.serialize(),e.uniqueId=this.uniqueId,e},i.Parse=function(e,t,r){if(!e.customType)e.customType="BABYLON.StandardMaterial";else if(e.customType==="BABYLON.PBRMaterial"&&e.overloadedAlbedo&&(e.customType="BABYLON.LegacyPBRMaterial",!BABYLON.LegacyPBRMaterial))return Y.Error("Your scene is trying to load a legacy version of the PBRMaterial, please, include it from the materials library."),null;var n=te.Instantiate(e.customType),a=n.Parse(e,t,r);return a._loadedUniqueId=e.uniqueId,a},i.TriangleFillMode=0,i.WireFrameFillMode=1,i.PointFillMode=2,i.PointListDrawMode=3,i.LineListDrawMode=4,i.LineLoopDrawMode=5,i.LineStripDrawMode=6,i.TriangleStripDrawMode=7,i.TriangleFanDrawMode=8,i.ClockWiseSideOrientation=0,i.CounterClockWiseSideOrientation=1,i.TextureDirtyFlag=1,i.LightDirtyFlag=2,i.FresnelDirtyFlag=4,i.AttributesDirtyFlag=8,i.MiscDirtyFlag=16,i.PrePassDirtyFlag=32,i.AllDirtyFlag=63,i.MATERIAL_OPAQUE=0,i.MATERIAL_ALPHATEST=1,i.MATERIAL_ALPHABLEND=2,i.MATERIAL_ALPHATESTANDBLEND=3,i.MATERIAL_NORMALBLENDMETHOD_WHITEOUT=0,i.MATERIAL_NORMALBLENDMETHOD_RNM=1,i.OnEventObservable=new X,i._AllDirtyCallBack=function(e){return e.markAllAsDirty()},i._ImageProcessingDirtyCallBack=function(e){return e.markAsImageProcessingDirty()},i._TextureDirtyCallBack=function(e){return e.markAsTexturesDirty()},i._FresnelDirtyCallBack=function(e){return e.markAsFresnelDirty()},i._MiscDirtyCallBack=function(e){return e.markAsMiscDirty()},i._PrePassDirtyCallBack=function(e){return e.markAsPrePassDirty()},i._LightsDirtyCallBack=function(e){return e.markAsLightDirty()},i._AttributeDirtyCallBack=function(e){return e.markAsAttributesDirty()},i._FresnelAndMiscDirtyCallBack=function(e){i._FresnelDirtyCallBack(e),i._MiscDirtyCallBack(e)},i._TextureAndMiscDirtyCallBack=function(e){i._TextureDirtyCallBack(e),i._MiscDirtyCallBack(e)},i._DirtyCallbackArray=[],i._RunDirtyCallBacks=function(e){for(var t=0,r=i._DirtyCallbackArray;t<r.length;t++){var n=r[t];n(e)}},C([I()],i.prototype,"id",void 0),C([I()],i.prototype,"uniqueId",void 0),C([I()],i.prototype,"name",void 0),C([I()],i.prototype,"metadata",void 0),C([I()],i.prototype,"checkReadyOnEveryCall",void 0),C([I()],i.prototype,"checkReadyOnlyOnce",void 0),C([I()],i.prototype,"state",void 0),C([I("alpha")],i.prototype,"_alpha",void 0),C([I("backFaceCulling")],i.prototype,"_backFaceCulling",void 0),C([I("cullBackFaces")],i.prototype,"_cullBackFaces",void 0),C([I()],i.prototype,"sideOrientation",void 0),C([I("alphaMode")],i.prototype,"_alphaMode",void 0),C([I()],i.prototype,"_needDepthPrePass",void 0),C([I()],i.prototype,"disableDepthWrite",void 0),C([I()],i.prototype,"disableColorWrite",void 0),C([I()],i.prototype,"forceDepthWrite",void 0),C([I()],i.prototype,"depthFunction",void 0),C([I()],i.prototype,"separateCullingPass",void 0),C([I("fogEnabled")],i.prototype,"_fogEnabled",void 0),C([I()],i.prototype,"pointSize",void 0),C([I()],i.prototype,"zOffset",void 0),C([I()],i.prototype,"zOffsetUnits",void 0),C([I()],i.prototype,"pointsCloud",null),C([I()],i.prototype,"fillMode",null),C([I()],i.prototype,"transparencyMode",null),i}(),an=function(i){$(e,i);function e(t,r,n){n===void 0&&(n=!0);var a=i.call(this,t,r)||this;return a._normalMatrix=new G,a._storeEffectOnSubMeshes=n,a}return e.prototype.getEffect=function(){return this._storeEffectOnSubMeshes?this._activeEffect:i.prototype.getEffect.call(this)},e.prototype.isReady=function(t,r){return t?!this._storeEffectOnSubMeshes||!t.subMeshes||t.subMeshes.length===0?!0:this.isReadyForSubMesh(t,t.subMeshes[0],r):!1},e.prototype._isReadyForSubMesh=function(t){var r=t.materialDefines;return!!(!this.checkReadyOnEveryCall&&t.effect&&r&&r._renderId===this.getScene().getRenderId())},e.prototype.bindOnlyWorldMatrix=function(t){this._activeEffect.setMatrix("world",t)},e.prototype.bindOnlyNormalMatrix=function(t){this._activeEffect.setMatrix("normalMatrix",t)},e.prototype.bind=function(t,r){!r||this.bindForSubMesh(t,r,r.subMeshes[0])},e.prototype._afterBind=function(t,r){r===void 0&&(r=null),i.prototype._afterBind.call(this,t,r),this.getScene()._cachedEffect=r},e.prototype._mustRebind=function(t,r,n){return n===void 0&&(n=1),t.isCachedMaterialInvalid(this,r,n)},e}(He),vi={effect:null,subMesh:null},sn=function(i){$(e,i);function e(t,r,n,a,s){a===void 0&&(a={}),s===void 0&&(s=!0);var o=i.call(this,t,r,s)||this;return o._textures={},o._textureArrays={},o._externalTextures={},o._floats={},o._ints={},o._floatsArrays={},o._colors3={},o._colors3Arrays={},o._colors4={},o._colors4Arrays={},o._vectors2={},o._vectors3={},o._vectors4={},o._matrices={},o._matrixArrays={},o._matrices3x3={},o._matrices2x2={},o._vectors2Arrays={},o._vectors3Arrays={},o._vectors4Arrays={},o._uniformBuffers={},o._textureSamplers={},o._storageBuffers={},o._cachedWorldViewMatrix=new G,o._cachedWorldViewProjectionMatrix=new G,o._multiview=!1,o._shaderPath=n,o._options=Ue({needAlphaBlending:!1,needAlphaTesting:!1,attributes:["position","normal","uv"],uniforms:["worldViewProjection"],uniformBuffers:[],samplers:[],externalTextures:[],samplerObjects:[],storageBuffers:[],defines:[],useClipPlane:!1},a),o}return Object.defineProperty(e.prototype,"shaderPath",{get:function(){return this._shaderPath},set:function(t){this._shaderPath=t},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"options",{get:function(){return this._options},enumerable:!1,configurable:!0}),e.prototype.getClassName=function(){return"ShaderMaterial"},e.prototype.needAlphaBlending=function(){return this.alpha<1||this._options.needAlphaBlending},e.prototype.needAlphaTesting=function(){return this._options.needAlphaTesting},e.prototype._checkUniform=function(t){this._options.uniforms.indexOf(t)===-1&&this._options.uniforms.push(t)},e.prototype.setTexture=function(t,r){return this._options.samplers.indexOf(t)===-1&&this._options.samplers.push(t),this._textures[t]=r,this},e.prototype.setTextureArray=function(t,r){return this._options.samplers.indexOf(t)===-1&&this._options.samplers.push(t),this._checkUniform(t),this._textureArrays[t]=r,this},e.prototype.setExternalTexture=function(t,r){return this._options.externalTextures.indexOf(t)===-1&&this._options.externalTextures.push(t),this._externalTextures[t]=r,this},e.prototype.setFloat=function(t,r){return this._checkUniform(t),this._floats[t]=r,this},e.prototype.setInt=function(t,r){return this._checkUniform(t),this._ints[t]=r,this},e.prototype.setFloats=function(t,r){return this._checkUniform(t),this._floatsArrays[t]=r,this},e.prototype.setColor3=function(t,r){return this._checkUniform(t),this._colors3[t]=r,this},e.prototype.setColor3Array=function(t,r){return this._checkUniform(t),this._colors3Arrays[t]=r.reduce(function(n,a){return a.toArray(n,n.length),n},[]),this},e.prototype.setColor4=function(t,r){return this._checkUniform(t),this._colors4[t]=r,this},e.prototype.setColor4Array=function(t,r){return this._checkUniform(t),this._colors4Arrays[t]=r.reduce(function(n,a){return a.toArray(n,n.length),n},[]),this},e.prototype.setVector2=function(t,r){return this._checkUniform(t),this._vectors2[t]=r,this},e.prototype.setVector3=function(t,r){return this._checkUniform(t),this._vectors3[t]=r,this},e.prototype.setVector4=function(t,r){return this._checkUniform(t),this._vectors4[t]=r,this},e.prototype.setMatrix=function(t,r){return this._checkUniform(t),this._matrices[t]=r,this},e.prototype.setMatrices=function(t,r){this._checkUniform(t);for(var n=new Float32Array(r.length*16),a=0;a<r.length;a++){var s=r[a];s.copyToArray(n,a*16)}return this._matrixArrays[t]=n,this},e.prototype.setMatrix3x3=function(t,r){return this._checkUniform(t),this._matrices3x3[t]=r,this},e.prototype.setMatrix2x2=function(t,r){return this._checkUniform(t),this._matrices2x2[t]=r,this},e.prototype.setArray2=function(t,r){return this._checkUniform(t),this._vectors2Arrays[t]=r,this},e.prototype.setArray3=function(t,r){return this._checkUniform(t),this._vectors3Arrays[t]=r,this},e.prototype.setArray4=function(t,r){return this._checkUniform(t),this._vectors4Arrays[t]=r,this},e.prototype.setUniformBuffer=function(t,r){return this._options.uniformBuffers.indexOf(t)===-1&&this._options.uniformBuffers.push(t),this._uniformBuffers[t]=r,this},e.prototype.setTextureSampler=function(t,r){return this._options.samplerObjects.indexOf(t)===-1&&this._options.samplerObjects.push(t),this._textureSamplers[t]=r,this},e.prototype.setStorageBuffer=function(t,r){return this._options.storageBuffers.indexOf(t)===-1&&this._options.storageBuffers.push(t),this._storageBuffers[t]=r,this},e.prototype.isReadyForSubMesh=function(t,r,n){return this.isReady(t,n,r)},e.prototype.isReady=function(t,r,n){var a,s,o,l,u=n&&this._storeEffectOnSubMeshes;if(this.isFrozen)if(u){if(n.effect&&n.effect._wasPreviouslyReady)return!0}else{var f=this._drawWrapper.effect;if(f&&f._wasPreviouslyReady&&this._effectUsesInstances===r)return!0}var h=this.getScene(),c=h.getEngine(),d=[],p=[],_=new oi,g=this._shaderPath,v=this._options.uniforms,y=this._options.uniformBuffers,b=this._options.samplers;c.getCaps().multiview&&h.activeCamera&&h.activeCamera.outputRenderTarget&&h.activeCamera.outputRenderTarget.getViewCount()>1&&(this._multiview=!0,d.push("#define MULTIVIEW"),this._options.uniforms.indexOf("viewProjection")!==-1&&this._options.uniforms.indexOf("viewProjectionR")===-1&&this._options.uniforms.push("viewProjectionR"));for(var E=0;E<this._options.defines.length;E++){var A=this._options.defines[E].indexOf("#define")===0?this._options.defines[E]:"#define ".concat(this._options.defines[E]);d.push(A)}for(var E=0;E<this._options.attributes.length;E++)p.push(this._options.attributes[E]);if(t&&t.isVerticesDataPresent(R.ColorKind)&&(p.push(R.ColorKind),d.push("#define VERTEXCOLOR")),r&&(d.push("#define INSTANCES"),le.PushAttributesForInstances(p),t!=null&&t.hasThinInstances&&(d.push("#define THIN_INSTANCES"),t&&t.isVerticesDataPresent(R.ColorInstanceKind)&&(p.push(R.ColorInstanceKind),d.push("#define INSTANCESCOLOR")))),t&&t.useBones&&t.computeBonesUsingShaders&&t.skeleton){p.push(R.MatricesIndicesKind),p.push(R.MatricesWeightsKind),t.numBoneInfluencers>4&&(p.push(R.MatricesIndicesExtraKind),p.push(R.MatricesWeightsExtraKind));var S=t.skeleton;d.push("#define NUM_BONE_INFLUENCERS "+t.numBoneInfluencers),_.addCPUSkinningFallback(0,t),S.isUsingTextureForMatrices?(d.push("#define BONETEXTURE"),this._options.uniforms.indexOf("boneTextureWidth")===-1&&this._options.uniforms.push("boneTextureWidth"),this._options.samplers.indexOf("boneSampler")===-1&&this._options.samplers.push("boneSampler")):(d.push("#define BonesPerMesh "+(S.bones.length+1)),this._options.uniforms.indexOf("mBones")===-1&&this._options.uniforms.push("mBones"))}else d.push("#define NUM_BONE_INFLUENCERS 0");var T=0,M=t?t.morphTargetManager:null;if(M){var D=M.supportsUVs&&d.indexOf("#define UV1")!==-1,x=M.supportsTangents&&d.indexOf("#define TANGENT")!==-1,P=M.supportsNormals&&d.indexOf("#define NORMAL")!==-1;T=M.numInfluencers,D&&d.push("#define MORPHTARGETS_UV"),x&&d.push("#define MORPHTARGETS_TANGENT"),P&&d.push("#define MORPHTARGETS_NORMAL"),T>0&&d.push("#define MORPHTARGETS"),M.isUsingTextureForTargets&&(d.push("#define MORPHTARGETS_TEXTURE"),this._options.uniforms.indexOf("morphTargetTextureIndices")===-1&&this._options.uniforms.push("morphTargetTextureIndices"),this._options.samplers.indexOf("morphTargets")===-1&&this._options.samplers.push("morphTargets")),d.push("#define NUM_MORPH_INFLUENCERS "+T);for(var E=0;E<T;E++)p.push(R.PositionKind+E),P&&p.push(R.NormalKind+E),x&&p.push(R.TangentKind+E),D&&p.push(R.UVKind+"_"+E);T>0&&(v=v.slice(),v.push("morphTargetInfluences"),v.push("morphTargetTextureInfo"),v.push("morphTargetTextureIndices"))}else d.push("#define NUM_MORPH_INFLUENCERS 0");if(t){var w=t.bakedVertexAnimationManager;w&&w.isEnabled&&(d.push("#define BAKED_VERTEX_ANIMATION_TEXTURE"),this._options.uniforms.indexOf("bakedVertexAnimationSettings")===-1&&this._options.uniforms.push("bakedVertexAnimationSettings"),this._options.uniforms.indexOf("bakedVertexAnimationTextureSizeInverted")===-1&&this._options.uniforms.push("bakedVertexAnimationTextureSizeInverted"),this._options.uniforms.indexOf("bakedVertexAnimationTime")===-1&&this._options.uniforms.push("bakedVertexAnimationTime"),this._options.samplers.indexOf("bakedVertexAnimationTexture")===-1&&this._options.samplers.push("bakedVertexAnimationTexture")),le.PrepareAttributesForBakedVertexAnimation(p,t,d)}for(var k in this._textures)if(!this._textures[k].isReady())return!1;t&&this._shouldTurnAlphaTestOn(t)&&d.push("#define ALPHATEST"),(this._options.useClipPlane===null&&!!h.clipPlane||this._options.useClipPlane)&&(d.push("#define CLIPPLANE"),v.indexOf("vClipPlane")===-1&&v.push("vClipPlane")),(this._options.useClipPlane===null&&!!h.clipPlane2||this._options.useClipPlane)&&(d.push("#define CLIPPLANE2"),v.indexOf("vClipPlane2")===-1&&v.push("vClipPlane2")),(this._options.useClipPlane===null&&!!h.clipPlane3||this._options.useClipPlane)&&(d.push("#define CLIPPLANE3"),v.indexOf("vClipPlane3")===-1&&v.push("vClipPlane3")),(this._options.useClipPlane===null&&!!h.clipPlane4||this._options.useClipPlane)&&(d.push("#define CLIPPLANE4"),v.indexOf("vClipPlane4")===-1&&v.push("vClipPlane4")),(this._options.useClipPlane===null&&!!h.clipPlane5||this._options.useClipPlane)&&(d.push("#define CLIPPLANE5"),v.indexOf("vClipPlane5")===-1&&v.push("vClipPlane5")),(this._options.useClipPlane===null&&!!h.clipPlane6||this._options.useClipPlane)&&(d.push("#define CLIPPLANE6"),v.indexOf("vClipPlane6")===-1&&v.push("vClipPlane6")),this.customShaderNameResolve&&(v=v.slice(),y=y.slice(),b=b.slice(),g=this.customShaderNameResolve(g,v,y,b,d,p));var B=u?n._getDrawWrapper():this._drawWrapper,L=(a=B==null?void 0:B.effect)!==null&&a!==void 0?a:null,H=(s=B==null?void 0:B.defines)!==null&&s!==void 0?s:null,W=d.join(`
`),F=L;return H!==W&&(F=c.createEffect(g,{attributes:p,uniformsNames:v,uniformBuffersNames:y,samplers:b,defines:W,fallbacks:_,onCompiled:this.onCompiled,onError:this.onError,indexParameters:{maxSimultaneousMorphTargets:T},shaderLanguage:this._options.shaderLanguage},c),u?n.setEffect(F,W,this._materialContext):B&&B.setEffect(F,W),this._onEffectCreatedObservable&&(vi.effect=F,vi.subMesh=(o=n!=null?n:t==null?void 0:t.subMeshes[0])!==null&&o!==void 0?o:null,this._onEffectCreatedObservable.notifyObservers(vi))),this._effectUsesInstances=!!r,!((l=!(F!=null&&F.isReady()))!==null&&l!==void 0)||l?!1:(L!==F&&h.resetCachedMaterial(),F._wasPreviouslyReady=!0,!0)},e.prototype.bindOnlyWorldMatrix=function(t,r){var n=this.getScene(),a=r!=null?r:this.getEffect();!a||(this._options.uniforms.indexOf("world")!==-1&&a.setMatrix("world",t),this._options.uniforms.indexOf("worldView")!==-1&&(t.multiplyToRef(n.getViewMatrix(),this._cachedWorldViewMatrix),a.setMatrix("worldView",this._cachedWorldViewMatrix)),this._options.uniforms.indexOf("worldViewProjection")!==-1&&(t.multiplyToRef(n.getTransformMatrix(),this._cachedWorldViewProjectionMatrix),a.setMatrix("worldViewProjection",this._cachedWorldViewProjectionMatrix)))},e.prototype.bindForSubMesh=function(t,r,n){var a;this.bind(t,r,(a=n._drawWrapperOverride)===null||a===void 0?void 0:a.effect,n)},e.prototype.bind=function(t,r,n,a){var s,o=a&&this._storeEffectOnSubMeshes,l=n!=null?n:o?a.effect:this.getEffect();if(!!l){this._activeEffect=l,this.bindOnlyWorldMatrix(t,n);var u=this._options.uniformBuffers,f=!1;if(l&&u&&u.length>0&&this.getScene().getEngine().supportsUniformBuffers)for(var h=0;h<u.length;++h){var c=u[h];switch(c){case"Mesh":r&&(r.getMeshUniformBuffer().bindToEffect(l,"Mesh"),r.transferToEffect(t));break;case"Scene":le.BindSceneUniformBuffer(l,this.getScene().getSceneUniformBuffer()),this.getScene().finalizeSceneUbo(),f=!0;break}}var d=r&&o?this._mustRebind(this.getScene(),l,r.visibility):this.getScene().getCachedMaterial()!==this;if(l&&d){!f&&this._options.uniforms.indexOf("view")!==-1&&l.setMatrix("view",this.getScene().getViewMatrix()),!f&&this._options.uniforms.indexOf("projection")!==-1&&l.setMatrix("projection",this.getScene().getProjectionMatrix()),!f&&this._options.uniforms.indexOf("viewProjection")!==-1&&(l.setMatrix("viewProjection",this.getScene().getTransformMatrix()),this._multiview&&l.setMatrix("viewProjectionR",this.getScene()._transformMatrixR)),this.getScene().activeCamera&&this._options.uniforms.indexOf("cameraPosition")!==-1&&l.setVector3("cameraPosition",this.getScene().activeCamera.globalPosition),le.BindBonesParameters(r,l),le.BindClipPlane(l,this.getScene());var p;for(p in this._textures)l.setTexture(p,this._textures[p]);for(p in this._textureArrays)l.setTextureArray(p,this._textureArrays[p]);for(p in this._externalTextures)l.setExternalTexture(p,this._externalTextures[p]);for(p in this._ints)l.setInt(p,this._ints[p]);for(p in this._floats)l.setFloat(p,this._floats[p]);for(p in this._floatsArrays)l.setArray(p,this._floatsArrays[p]);for(p in this._colors3)l.setColor3(p,this._colors3[p]);for(p in this._colors3Arrays)l.setArray3(p,this._colors3Arrays[p]);for(p in this._colors4){var _=this._colors4[p];l.setFloat4(p,_.r,_.g,_.b,_.a)}for(p in this._colors4Arrays)l.setArray4(p,this._colors4Arrays[p]);for(p in this._vectors2)l.setVector2(p,this._vectors2[p]);for(p in this._vectors3)l.setVector3(p,this._vectors3[p]);for(p in this._vectors4)l.setVector4(p,this._vectors4[p]);for(p in this._matrices)l.setMatrix(p,this._matrices[p]);for(p in this._matrixArrays)l.setMatrices(p,this._matrixArrays[p]);for(p in this._matrices3x3)l.setMatrix3x3(p,this._matrices3x3[p]);for(p in this._matrices2x2)l.setMatrix2x2(p,this._matrices2x2[p]);for(p in this._vectors2Arrays)l.setArray2(p,this._vectors2Arrays[p]);for(p in this._vectors3Arrays)l.setArray3(p,this._vectors3Arrays[p]);for(p in this._vectors4Arrays)l.setArray4(p,this._vectors4Arrays[p]);for(p in this._uniformBuffers){var g=this._uniformBuffers[p].getBuffer();g&&l.bindUniformBuffer(g,p)}for(p in this._textureSamplers)l.setTextureSampler(p,this._textureSamplers[p]);for(p in this._storageBuffers)l.setStorageBuffer(p,this._storageBuffers[p])}if(l&&r&&(d||!this.isFrozen)){var v=r.morphTargetManager;v&&v.numInfluencers>0&&le.BindMorphTargetParameters(r,l);var y=r.bakedVertexAnimationManager;y&&y.isEnabled&&((s=r.bakedVertexAnimationManager)===null||s===void 0||s.bind(l,this._effectUsesInstances))}this._afterBind(r,l)}},e.prototype.getActiveTextures=function(){var t=i.prototype.getActiveTextures.call(this);for(var r in this._textures)t.push(this._textures[r]);for(var n in this._textureArrays)for(var a=this._textureArrays[n],s=0;s<a.length;s++)t.push(a[s]);return t},e.prototype.hasTexture=function(t){if(i.prototype.hasTexture.call(this,t))return!0;for(var r in this._textures)if(this._textures[r]===t)return!0;for(var n in this._textureArrays)for(var a=this._textureArrays[n],s=0;s<a.length;s++)if(a[s]===t)return!0;return!1},e.prototype.clone=function(t){var r=this,n=pe.Clone(function(){return new e(t,r.getScene(),r._shaderPath,r._options,r._storeEffectOnSubMeshes)},this);n.name=t,n.id=t,typeof n._shaderPath=="object"&&(n._shaderPath=Ue({},n._shaderPath)),this._options=Ue({},this._options),Object.keys(this._options).forEach(function(s){var o=r._options[s];Array.isArray(o)&&(r._options[s]=o.slice(0))}),this.stencil.copyTo(n.stencil);for(var a in this._textures)n.setTexture(a,this._textures[a]);for(var a in this._textureArrays)n.setTextureArray(a,this._textureArrays[a]);for(var a in this._externalTextures)n.setExternalTexture(a,this._externalTextures[a]);for(var a in this._ints)n.setInt(a,this._ints[a]);for(var a in this._floats)n.setFloat(a,this._floats[a]);for(var a in this._floatsArrays)n.setFloats(a,this._floatsArrays[a]);for(var a in this._colors3)n.setColor3(a,this._colors3[a]);for(var a in this._colors3Arrays)n._colors3Arrays[a]=this._colors3Arrays[a];for(var a in this._colors4)n.setColor4(a,this._colors4[a]);for(var a in this._colors4Arrays)n._colors4Arrays[a]=this._colors4Arrays[a];for(var a in this._vectors2)n.setVector2(a,this._vectors2[a]);for(var a in this._vectors3)n.setVector3(a,this._vectors3[a]);for(var a in this._vectors4)n.setVector4(a,this._vectors4[a]);for(var a in this._matrices)n.setMatrix(a,this._matrices[a]);for(var a in this._matrixArrays)n._matrixArrays[a]=this._matrixArrays[a].slice();for(var a in this._matrices3x3)n.setMatrix3x3(a,this._matrices3x3[a]);for(var a in this._matrices2x2)n.setMatrix2x2(a,this._matrices2x2[a]);for(var a in this._vectors2Arrays)n.setArray2(a,this._vectors2Arrays[a]);for(var a in this._vectors3Arrays)n.setArray3(a,this._vectors3Arrays[a]);for(var a in this._vectors4Arrays)n.setArray4(a,this._vectors4Arrays[a]);for(var a in this._uniformBuffers)n.setUniformBuffer(a,this._uniformBuffers[a]);for(var a in this._textureSamplers)n.setTextureSampler(a,this._textureSamplers[a]);for(var a in this._storageBuffers)n.setStorageBuffer(a,this._storageBuffers[a]);return n},e.prototype.dispose=function(t,r,n){if(r){var a;for(a in this._textures)this._textures[a].dispose();for(a in this._textureArrays)for(var s=this._textureArrays[a],o=0;o<s.length;o++)s[o].dispose()}this._textures={},i.prototype.dispose.call(this,t,r,n)},e.prototype.serialize=function(){var t=pe.Serialize(this);t.customType="BABYLON.ShaderMaterial",t.options=this._options,t.shaderPath=this._shaderPath,t.storeEffectOnSubMeshes=this._storeEffectOnSubMeshes;var r;t.stencil=this.stencil.serialize(),t.textures={};for(r in this._textures)t.textures[r]=this._textures[r].serialize();t.textureArrays={};for(r in this._textureArrays){t.textureArrays[r]=[];for(var n=this._textureArrays[r],a=0;a<n.length;a++)t.textureArrays[r].push(n[a].serialize())}t.ints={};for(r in this._ints)t.ints[r]=this._ints[r];t.floats={};for(r in this._floats)t.floats[r]=this._floats[r];t.FloatArrays={};for(r in this._floatsArrays)t.FloatArrays[r]=this._floatsArrays[r];t.colors3={};for(r in this._colors3)t.colors3[r]=this._colors3[r].asArray();t.colors3Arrays={};for(r in this._colors3Arrays)t.colors3Arrays[r]=this._colors3Arrays[r];t.colors4={};for(r in this._colors4)t.colors4[r]=this._colors4[r].asArray();t.colors4Arrays={};for(r in this._colors4Arrays)t.colors4Arrays[r]=this._colors4Arrays[r];t.vectors2={};for(r in this._vectors2)t.vectors2[r]=this._vectors2[r].asArray();t.vectors3={};for(r in this._vectors3)t.vectors3[r]=this._vectors3[r].asArray();t.vectors4={};for(r in this._vectors4)t.vectors4[r]=this._vectors4[r].asArray();t.matrices={};for(r in this._matrices)t.matrices[r]=this._matrices[r].asArray();t.matrixArray={};for(r in this._matrixArrays)t.matrixArray[r]=this._matrixArrays[r];t.matrices3x3={};for(r in this._matrices3x3)t.matrices3x3[r]=this._matrices3x3[r];t.matrices2x2={};for(r in this._matrices2x2)t.matrices2x2[r]=this._matrices2x2[r];t.vectors2Arrays={};for(r in this._vectors2Arrays)t.vectors2Arrays[r]=this._vectors2Arrays[r];t.vectors3Arrays={};for(r in this._vectors3Arrays)t.vectors3Arrays[r]=this._vectors3Arrays[r];t.vectors4Arrays={};for(r in this._vectors4Arrays)t.vectors4Arrays[r]=this._vectors4Arrays[r];return t},e.Parse=function(t,r,n){var a=pe.Parse(function(){return new e(t.name,r,t.shaderPath,t.options,t.storeEffectOnSubMeshes)},t,r,n),s;t.stencil&&a.stencil.parse(t.stencil,r,n);for(s in t.textures)a.setTexture(s,re.Parse(t.textures[s],r,n));for(s in t.textureArrays){for(var o=t.textureArrays[s],l=new Array,u=0;u<o.length;u++)l.push(re.Parse(o[u],r,n));a.setTextureArray(s,l)}for(s in t.ints)a.setInt(s,t.ints[s]);for(s in t.floats)a.setFloat(s,t.floats[s]);for(s in t.floatsArrays)a.setFloats(s,t.floatsArrays[s]);for(s in t.colors3)a.setColor3(s,me.FromArray(t.colors3[s]));for(s in t.colors3Arrays){var f=t.colors3Arrays[s].reduce(function(h,c,d){return d%3===0?h.push([c]):h[h.length-1].push(c),h},[]).map(function(h){return me.FromArray(h)});a.setColor3Array(s,f)}for(s in t.colors4)a.setColor4(s,ce.FromArray(t.colors4[s]));for(s in t.colors4Arrays){var f=t.colors4Arrays[s].reduce(function(c,d,p){return p%4===0?c.push([d]):c[c.length-1].push(d),c},[]).map(function(c){return ce.FromArray(c)});a.setColor4Array(s,f)}for(s in t.vectors2)a.setVector2(s,se.FromArray(t.vectors2[s]));for(s in t.vectors3)a.setVector3(s,m.FromArray(t.vectors3[s]));for(s in t.vectors4)a.setVector4(s,Ke.FromArray(t.vectors4[s]));for(s in t.matrices)a.setMatrix(s,G.FromArray(t.matrices[s]));for(s in t.matrixArray)a._matrixArrays[s]=new Float32Array(t.matrixArray[s]);for(s in t.matrices3x3)a.setMatrix3x3(s,t.matrices3x3[s]);for(s in t.matrices2x2)a.setMatrix2x2(s,t.matrices2x2[s]);for(s in t.vectors2Arrays)a.setArray2(s,t.vectors2Arrays[s]);for(s in t.vectors3Arrays)a.setArray3(s,t.vectors3Arrays[s]);for(s in t.vectors4Arrays)a.setArray4(s,t.vectors4Arrays[s]);return a},e.ParseFromFileAsync=function(t,r,n,a){var s=this;return a===void 0&&(a=""),new Promise(function(o,l){var u=new Jt;u.addEventListener("readystatechange",function(){if(u.readyState==4)if(u.status==200){var f=JSON.parse(u.responseText),h=s.Parse(f,n||ye.LastCreatedScene,a);t&&(h.name=t),o(h)}else l("Unable to load the ShaderMaterial")}),u.open("GET",r),u.send()})},e.CreateFromSnippetAsync=function(t,r,n){var a=this;return n===void 0&&(n=""),new Promise(function(s,o){var l=new Jt;l.addEventListener("readystatechange",function(){if(l.readyState==4)if(l.status==200){var u=JSON.parse(JSON.parse(l.responseText).jsonPayload),f=JSON.parse(u.shaderMaterial),h=a.Parse(f,r||ye.LastCreatedScene,n);h.snippetId=t,s(h)}else o("Unable to load the snippet "+t)}),l.open("GET",a.SnippetUrl+"/"+t.replace(/#/g,"/")),l.send()})},e.SnippetUrl="https://snippet.babylonjs.com",e}(an);We("BABYLON.ShaderMaterial",sn);var fl=`precision highp float;

attribute vec3 position;
attribute vec3 normal;
attribute vec2 uv;

uniform mat4 worldView;
uniform mat4 view;
uniform mat4 worldViewProjection;
uniform mat4 projection;

uniform float width;
uniform float height;
uniform float farClip;
uniform float nearClip;
uniform vec4 crop;
uniform vec2 imageDimensions;
uniform vec2 principalPoint;
uniform vec2 focalLength;
uniform mat4 extrinsics;
uniform sampler2D map;
uniform float meshScalar;

varying vec4 vPosition;
varying vec3 vNormal;

varying vec2 vUv;
varying vec2 vUvDepth;
varying float vDepth;

float _DepthBrightnessThreshold = 0.5;  

#define BRIGHTNESS_THRESHOLD_OFFSET 0.01
#define FLOAT_EPS 0.00001
#define CLIP_EPSILON 0.005

vec3 rgb2hsv(vec3 c)
{
  vec4 K = vec4(0.0, -1.0 / 3.0, 2.0 / 3.0, -1.0);
  vec4 p = mix(vec4(c.bg, K.wz), vec4(c.gb, K.xy), step(c.b, c.g));
  vec4 q = mix(vec4(p.xyw, c.r), vec4(c.r, p.yzx), step(p.x, c.r));
  float d = q.x - min(q.w, q.y);
  return vec3(abs(q.z + (q.w - q.y) / (6.0 * d + FLOAT_EPS)), d / (q.x + FLOAT_EPS), q.x);
}

float depthForPoint(vec2 texturePoint)
{
  vec2 centerpix = vec2(.5/width, .5/height);

  texturePoint += centerpix;
  
  texturePoint = clamp(texturePoint, centerpix, vec2(1.0, 0.5) - centerpix);
  vec4 depthsample = texture2D(map, texturePoint);
  vec3 depthsamplehsv = rgb2hsv(depthsample.rgb);
  return depthsamplehsv.b > _DepthBrightnessThreshold + BRIGHTNESS_THRESHOLD_OFFSET ? depthsamplehsv.r : 0.0;
}

void main() {
    vec4 texSize = vec4(1.0 / width, 1.0 / height, width, height);
    vec2 basetex = position.xy;

    vec4 p = vec4( position, 1. );

    vPosition = p;
    vNormal = normal;

    vec2 depthTexCoord = basetex * vec2(1.0, 0.5) + vec2(0.5, 0.25);
    vec2 colorTexCoord = basetex * vec2(1.0, 0.5) - vec2(0.5, 0.25);
    

    float depth = depthForPoint(depthTexCoord);

    
    
      if (depth <= CLIP_EPSILON || ((1.0 - CLIP_EPSILON) >= depth))
      {
        
        
        vec2 textureStep = vec2(texSize.x * meshScalar, texSize.y * meshScalar);   

        vec2 neighbors[8];
        neighbors[0] = vec2(-textureStep.x, -textureStep.y);
        neighbors[1] = vec2(0, -textureStep.y);
        neighbors[2] = vec2(textureStep.x, -textureStep.y);
        neighbors[3] = vec2(-textureStep.x, 0);
        neighbors[4] = vec2(textureStep.x, 0);
        neighbors[5] = vec2(-textureStep.x, textureStep.y);
        neighbors[6] = vec2(0, textureStep.y);
        neighbors[7] = vec2(textureStep.x, textureStep.y);

        
        int validNeighbors = 0;
        float maxDepth = 0.0;
        for (int i = 0; i < 8; i++)
        {
          float depthNeighbor = depthForPoint(depthTexCoord + neighbors[i]);
          maxDepth = max(maxDepth, depthNeighbor);
          validNeighbors += (depthNeighbor > CLIP_EPSILON || ((1.0 - CLIP_EPSILON) < depthNeighbor)) ? 1 : 0;
        }

        
        depth = validNeighbors > 0 ? maxDepth : 0.0;
      }
    

    vec2 imageCoordinates = crop.xy + (basetex * crop.zw);
    float z = depth * (farClip - nearClip) + nearClip; 
    vec2 ortho = imageCoordinates * imageDimensions - principalPoint;
    vec2 proj = ortho * z / focalLength;
    vec4 worldPos = extrinsics *  vec4(proj.xy, z, 1.0);
    worldPos.w = 1.0;

      worldPos.z = depth;

    
    gl_Position = worldViewProjection * worldPos;

    mat4 modelViewMatrix = worldView * view;
    gl_Position = projection * modelViewMatrix * worldPos;
    
    gl_Position = worldViewProjection * worldPos;

    vUv = colorTexCoord;
    vUvDepth = depthTexCoord;
    vDepth = depth;

    

}`,hl=`precision highp float;

varying vec2 vUv;
varying vec2 vUvDepth;
varying vec4 vPosition;

varying float vDepth;

uniform sampler2D map;

uniform float width;
uniform float height;
uniform float opacity;

float _DepthBrightnessThreshold = 0.8;  
float _SheerAngleThreshold = 0.04;       

#define BRIGHTNESS_THRESHOLD_OFFSET 0.01
#define FLOAT_EPS 0.00001
#define CLIP_EPSILON 0.005

vec3 rgb2hsv(vec3 c)
{
  vec4 K = vec4(0.0, -1.0 / 3.0, 2.0 / 3.0, -1.0);
  vec4 p = mix(vec4(c.bg, K.wz), vec4(c.gb, K.xy), step(c.b, c.g));
  vec4 q = mix(vec4(p.xyw, c.r), vec4(c.r, p.yzx), step(p.x, c.r));
  float d = q.x - min(q.w, q.y);
  return vec3(abs(q.z + (q.w - q.y) / (6.0 * d + FLOAT_EPS)), d / (q.x + FLOAT_EPS), q.x);
}

float depthForPoint(vec2 texturePoint)
{
  vec2 centerpix = vec2(.5/width, .5/height);
  texturePoint += centerpix;
  
  texturePoint = clamp(texturePoint, centerpix, vec2(1.0, 0.5) - centerpix);
  vec4 depthsample = texture2D(map, texturePoint);
  vec3 depthsamplehsv = rgb2hsv(depthsample.rgb);
  return depthsamplehsv.b > _DepthBrightnessThreshold + BRIGHTNESS_THRESHOLD_OFFSET ? depthsamplehsv.r : 0.0;
}

void main(void) {
  vec2 centerpix = vec2(.5/width, .5/height);
  vec2 centerDepthSampleCoord = vUvDepth - mod(vUvDepth, vec2(1.0/width, 1.0/height) ); 

  float depth = depthForPoint(centerDepthSampleCoord);
  if (depth > CLIP_EPSILON) {
    depth = vDepth;
  }

  
  
  
  vec4 localPos = vPosition;
  
  localPos.xy /= localPos.z;
  
  vec3 dx = dFdx(localPos.xyz);
  vec3 dy = dFdy(localPos.xyz);
  vec3 n = normalize(cross(dx, dy));

  
  float sheerAngle = abs(dot(n, vec3(0.0, 0.0, 1.0)));

  
  vec2 colorTexCoord = clamp(vUv, vec2(0.0, 0.5) + centerpix, vec2(1.0, 1.0) - centerpix);
  vec4 color = texture2D(map, vUv);
  
  color.w = opacity;

  if ( depth < CLIP_EPSILON  ||
  depth > (1.0 - CLIP_EPSILON) ||
  sheerAngle < (_SheerAngleThreshold + FLOAT_EPS))
  {
    discard;
  }

  gl_FragColor = color;
}`;ge.prototype.updateVideoTexture=function(i,e,t){if(!(!i||i._isDisabled)){var r=this._bindTextureDirectly(this._gl.TEXTURE_2D,i,!0);this._unpackFlipY(!t);try{if(this._videoTextureSupported===void 0&&(this._gl.getError(),this._gl.texImage2D(this._gl.TEXTURE_2D,0,this._gl.RGBA,this._gl.RGBA,this._gl.UNSIGNED_BYTE,e),this._gl.getError()!==0?this._videoTextureSupported=!1:this._videoTextureSupported=!0),this._videoTextureSupported)this._gl.texImage2D(this._gl.TEXTURE_2D,0,this._gl.RGBA,this._gl.RGBA,this._gl.UNSIGNED_BYTE,e);else{if(!i._workingCanvas){i._workingCanvas=this.createCanvas(i.width,i.height);var n=i._workingCanvas.getContext("2d");if(!n)throw new Error("Unable to get 2d context");i._workingContext=n,i._workingCanvas.width=i.width,i._workingCanvas.height=i.height}i._workingContext.clearRect(0,0,i.width,i.height),i._workingContext.drawImage(e,0,0,e.videoWidth,e.videoHeight,0,0,i.width,i.height),this._gl.texImage2D(this._gl.TEXTURE_2D,0,this._gl.RGBA,this._gl.RGBA,this._gl.UNSIGNED_BYTE,i._workingCanvas)}i.generateMipMaps&&this._gl.generateMipmap(this._gl.TEXTURE_2D),r||this._bindTextureDirectly(this._gl.TEXTURE_2D,null),i.isReady=!0}catch{i._isDisabled=!0}}};ge.prototype.createDynamicTexture=function(i,e,t,r){var n=new at(this,Ie.Dynamic);return n.baseWidth=i,n.baseHeight=e,t&&(i=this.needPOTTextures?ge.GetExponentOfTwo(i,this._caps.maxTextureSize):i,e=this.needPOTTextures?ge.GetExponentOfTwo(e,this._caps.maxTextureSize):e),n.width=i,n.height=e,n.isReady=!1,n.generateMipMaps=t,n.samplingMode=r,this.updateTextureSamplingMode(r,n),this._internalTexturesCache.push(n),n};ge.prototype.updateDynamicTexture=function(i,e,t,r,n,a,s){if(r===void 0&&(r=!1),a===void 0&&(a=!1),!!i){var o=this._gl,l=o.TEXTURE_2D,u=this._bindTextureDirectly(l,i,!0,a);this._unpackFlipY(t===void 0?i.invertY:t),r&&o.pixelStorei(o.UNPACK_PREMULTIPLY_ALPHA_WEBGL,1);var f=this._getWebGLTextureType(i.type),h=this._getInternalFormat(n||i.format),c=this._getRGBABufferInternalSizedFormat(i.type,h);o.texImage2D(l,0,c,h,f,e),i.generateMipMaps&&o.generateMipmap(l),u||this._bindTextureDirectly(l,null),r&&o.pixelStorei(o.UNPACK_PREMULTIPLY_ALPHA_WEBGL,0),i.isReady=!0}};function jn(i){for(;i.firstChild;)i.removeChild(i.firstChild);i.srcObject=null,i.src="",i.removeAttribute("src")}var cl=function(i){$(e,i);function e(t,r,n,a,s,o,l,u){a===void 0&&(a=!1),s===void 0&&(s=!1),o===void 0&&(o=re.TRILINEAR_SAMPLINGMODE),l===void 0&&(l={});var f=i.call(this,null,n,!a,s)||this;f._onUserActionRequestedObservable=null,f._stillImageCaptured=!1,f._displayingPosterTexture=!1,f._frameId=-1,f._currentSrc=null,f._errorFound=!1,f._createInternalTexture=function(){if(f._texture!=null)if(f._displayingPosterTexture)f._texture.dispose(),f._displayingPosterTexture=!1;else return;if(!f._getEngine().needPOTTextures||te.IsExponentOfTwo(f.video.videoWidth)&&te.IsExponentOfTwo(f.video.videoHeight)?(f.wrapU=re.WRAP_ADDRESSMODE,f.wrapV=re.WRAP_ADDRESSMODE):(f.wrapU=re.CLAMP_ADDRESSMODE,f.wrapV=re.CLAMP_ADDRESSMODE,f._generateMipMaps=!1),f._texture=f._getEngine().createDynamicTexture(f.video.videoWidth,f.video.videoHeight,f._generateMipMaps,f.samplingMode),!f.video.autoplay&&!f._settings.poster){var c=f.video.onplaying,d=f.video.muted;f.video.muted=!0,f.video.onplaying=function(){f.video.muted=d,f.video.onplaying=c,f._updateInternalTexture(),f._errorFound||f.video.pause(),f.onLoadObservable.hasObservers()&&f.onLoadObservable.notifyObservers(f)},f._handlePlay()}else f._updateInternalTexture(),f.onLoadObservable.hasObservers()&&f.onLoadObservable.notifyObservers(f)},f._reset=function(){f._texture!=null&&(f._displayingPosterTexture||(f._texture.dispose(),f._texture=null))},f._updateInternalTexture=function(){if(f._texture!=null&&!(f.video.readyState<f.video.HAVE_CURRENT_DATA)&&!f._displayingPosterTexture){var c=f.getScene().getFrameId();f._frameId!==c&&(f._frameId=c,f._getEngine().updateVideoTexture(f._texture,f.video,f._invertY))}},f._settings=Ue({autoPlay:!0,loop:!0,autoUpdateTexture:!0},l),f._onError=u,f._generateMipMaps=a,f._initialSamplingMode=o,f.autoUpdateTexture=f._settings.autoUpdateTexture,f._currentSrc=r,f.name=t||f._getName(r),f.video=f._getVideo(r),l.poster&&(f.video.poster=l.poster),l.autoPlay!==void 0&&(f.video.autoplay=l.autoPlay),l.loop!==void 0&&(f.video.loop=l.loop),l.muted!==void 0&&(f.video.muted=l.muted),f.video.setAttribute("playsinline",""),f.video.addEventListener("paused",f._updateInternalTexture),f.video.addEventListener("seeked",f._updateInternalTexture),f.video.addEventListener("emptied",f._reset),f._createInternalTextureOnEvent=l.poster&&!l.autoPlay?"play":"canplay",f.video.addEventListener(f._createInternalTextureOnEvent,f._createInternalTexture),l.autoPlay&&f._handlePlay();var h=f.video.readyState>=f.video.HAVE_CURRENT_DATA;return l.poster&&(!l.autoPlay||!h)?(f._texture=f._getEngine().createTexture(l.poster,!1,!f.invertY,n),f._displayingPosterTexture=!0):h&&f._createInternalTexture(),f}return Object.defineProperty(e.prototype,"onUserActionRequestedObservable",{get:function(){return this._onUserActionRequestedObservable||(this._onUserActionRequestedObservable=new X),this._onUserActionRequestedObservable},enumerable:!1,configurable:!0}),e.prototype._processError=function(t){this._errorFound=!0,this._onError?this._onError(t==null?void 0:t.message):Y.Error(t==null?void 0:t.message)},e.prototype._handlePlay=function(){var t=this;this._errorFound=!1,this.video.play().catch(function(r){if((r==null?void 0:r.name)==="NotAllowedError"){if(t._onUserActionRequestedObservable&&t._onUserActionRequestedObservable.hasObservers()){t._onUserActionRequestedObservable.notifyObservers(t);return}else if(!t.video.muted){Y.Warn("Unable to autoplay a video with sound. Trying again with muted turned true"),t.video.muted=!0,t._errorFound=!1,t.video.play().catch(function(n){t._processError(n)});return}}t._processError(r)})},e.prototype.getClassName=function(){return"VideoTexture"},e.prototype._getName=function(t){return t instanceof HTMLVideoElement?t.currentSrc:typeof t=="object"?t.toString():t},e.prototype._getVideo=function(t){if(t.isNative)return t;if(t instanceof HTMLVideoElement)return te.SetCorsBehavior(t.currentSrc,t),t;var r=document.createElement("video");return typeof t=="string"?(te.SetCorsBehavior(t,r),r.src=t):(te.SetCorsBehavior(t[0],r),t.forEach(function(n){var a=document.createElement("source");a.src=n,r.appendChild(a)})),this.onDisposeObservable.addOnce(function(){jn(r)}),r},e.prototype._rebuild=function(){this.update()},e.prototype.update=function(){!this.autoUpdateTexture||this.updateTexture(!0)},e.prototype.updateTexture=function(t){!t||this.video.paused&&this._stillImageCaptured||(this._stillImageCaptured=!0,this._updateInternalTexture())},e.prototype.updateURL=function(t){this.video.src=t,this._currentSrc=t},e.prototype.clone=function(){return new e(this.name,this._currentSrc,this.getScene(),this._generateMipMaps,this.invertY,this.samplingMode,this._settings)},e.prototype.dispose=function(){i.prototype.dispose.call(this),this._currentSrc=null,this._onUserActionRequestedObservable&&(this._onUserActionRequestedObservable.clear(),this._onUserActionRequestedObservable=null),this.video.removeEventListener(this._createInternalTextureOnEvent,this._createInternalTexture),this.video.removeEventListener("paused",this._updateInternalTexture),this.video.removeEventListener("seeked",this._updateInternalTexture),this.video.removeEventListener("emptied",this._reset),this.video.pause()},e.CreateFromStreamAsync=function(t,r,n,a){a===void 0&&(a=!0);var s=t.getEngine().createVideoElement(n);return t.getEngine()._badOS&&(document.body.appendChild(s),s.style.transform="scale(0.0001, 0.0001)",s.style.opacity="0",s.style.position="fixed",s.style.bottom="0px",s.style.right="0px"),s.setAttribute("autoplay",""),s.setAttribute("muted","true"),s.setAttribute("playsinline",""),s.muted=!0,s.mozSrcObject!==void 0?s.mozSrcObject=r:typeof s.srcObject=="object"?s.srcObject=r:(window.URL=window.URL||window.webkitURL||window.mozURL||window.msURL,s.src=window.URL&&window.URL.createObjectURL(r)),new Promise(function(o){var l=function(){var u=new e("video",s,t,!0,a);t.getEngine()._badOS&&u.onDisposeObservable.addOnce(function(){s.remove()}),u.onDisposeObservable.addOnce(function(){jn(s)}),o(u),s.removeEventListener("playing",l)};s.addEventListener("playing",l),s.play()})},e.CreateFromWebCamAsync=function(t,r,n,a){var s=this;n===void 0&&(n=!1),a===void 0&&(a=!0);var o;if(r&&r.deviceId&&(o={exact:r.deviceId}),navigator.mediaDevices)return navigator.mediaDevices.getUserMedia({video:r,audio:n}).then(function(u){return s.CreateFromStreamAsync(t,u,r,a)});var l=navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia||navigator.msGetUserMedia;return l&&l({video:{deviceId:o,width:{min:r&&r.minWidth||256,max:r&&r.maxWidth||640},height:{min:r&&r.minHeight||256,max:r&&r.maxHeight||480}},audio:n},function(u){return s.CreateFromStreamAsync(t,u,r,a)},function(u){Y.Error(u.name)}),Promise.reject("No support for userMedia on this device")},e.CreateFromWebCam=function(t,r,n,a,s){a===void 0&&(a=!1),s===void 0&&(s=!0),this.CreateFromWebCamAsync(t,n,a,s).then(function(o){r&&r(o)}).catch(function(o){Y.Error(o.name)})},e}(re);Kt.ShadersStore.depthkitVertexShader=fl;Kt.ShadersStore.depthkitFragmentShader=hl;class dl extends sn{constructor(e,t,r,n,a="DepthKitMaterial"){super(a,n,"depthkit",{attributes:["position","normal","uv"],samplers:["map"],uniforms:["world","worldView","worldViewProjection","view","projection","time","direction","time","nearClip","farClip","meshScalar","focalLength","principalPoint","imageDimensions","extrinsics","extrinsics","extrinsicsInv","crop","width","height","opacity"]});ft(this,"videoTexture");this.props=e,this.video=t,this.meshScalar=r,this.videoTexture=this._createVideoTexture(n),this._bindShaderInputs(n,e,this.videoTexture,r),this.backFaceCulling=!1}setMeshScalar(e){this.setFloat("meshScalar",this.meshScalar)}dispose(){super.dispose(),this.videoTexture.dispose()}_createVideoTexture(e){return new cl("DepthKitVideoTexture",this.video,e)}_bindShaderInputs(e,t,r,n){const a=this._setupExtrinsics(t);this.setTexture("map",r),this.setFloat("time",0),this.setFloat("nearClip",this.props.nearClip),this.setFloat("farClip",this.props.farClip),this.setFloat("meshScalar",n),this.setVector2("focalLength",new se(this.props.depthFocalLength.x,this.props.depthFocalLength.y)),this.setVector2("principalPoint",new se(this.props.depthPrincipalPoint.x,this.props.depthPrincipalPoint.y)),this.setVector2("imageDimensions",new se(this.props.depthImageSize.x,this.props.depthImageSize.y)),this.setMatrix("extrinsics",a),this.setMatrix("extrinsicsInv",a.clone().invert()),this.setVector4("crop",new Ke(this.props.crop.x,this.props.crop.y,this.props.crop.z,this.props.crop.w)),this.setFloat("width",this.props.textureWidth),this.setFloat("height",this.props.textureHeight),this.setFloat("opacity",1)}_setupExtrinsics(e){const t=e.extrinsics;return G.FromArray([t.e00,t.e10,t.e20,t.e30,t.e01,t.e11,t.e21,t.e31,t.e02,t.e12,t.e22,t.e32,t.e03,t.e13,t.e23,t.e33])}}var Ce;(function(i){i[i.LOCAL=0]="LOCAL",i[i.WORLD=1]="WORLD",i[i.BONE=2]="BONE"})(Ce||(Ce={}));var ei=function(){function i(){}return i.X=new m(1,0,0),i.Y=new m(0,1,0),i.Z=new m(0,0,1),i}(),Kn;(function(i){i[i.X=0]="X",i[i.Y=1]="Y",i[i.Z=2]="Z"})(Kn||(Kn={}));var ht=function(i){$(e,i);function e(t,r,n){r===void 0&&(r=null),n===void 0&&(n=!0);var a=i.call(this,t,r)||this;return a._forward=new m(0,0,1),a._up=new m(0,1,0),a._right=new m(1,0,0),a._position=m.Zero(),a._rotation=m.Zero(),a._rotationQuaternion=null,a._scaling=m.One(),a._transformToBoneReferal=null,a._isAbsoluteSynced=!1,a._billboardMode=e.BILLBOARDMODE_NONE,a._preserveParentRotationForBillboard=!1,a.scalingDeterminant=1,a._infiniteDistance=!1,a.ignoreNonUniformScaling=!1,a.reIntegrateRotationIntoRotationQuaternion=!1,a._poseMatrix=null,a._localMatrix=G.Zero(),a._usePivotMatrix=!1,a._absolutePosition=m.Zero(),a._absoluteScaling=m.Zero(),a._absoluteRotationQuaternion=de.Identity(),a._pivotMatrix=G.Identity(),a._postMultiplyPivotMatrix=!1,a._isWorldMatrixFrozen=!1,a._indexInSceneTransformNodesArray=-1,a.onAfterWorldMatrixUpdateObservable=new X,a._nonUniformScaling=!1,n&&a.getScene().addTransformNode(a),a}return Object.defineProperty(e.prototype,"billboardMode",{get:function(){return this._billboardMode},set:function(t){this._billboardMode!==t&&(this._billboardMode=t)},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"preserveParentRotationForBillboard",{get:function(){return this._preserveParentRotationForBillboard},set:function(t){t!==this._preserveParentRotationForBillboard&&(this._preserveParentRotationForBillboard=t)},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"infiniteDistance",{get:function(){return this._infiniteDistance},set:function(t){this._infiniteDistance!==t&&(this._infiniteDistance=t)},enumerable:!1,configurable:!0}),e.prototype.getClassName=function(){return"TransformNode"},Object.defineProperty(e.prototype,"position",{get:function(){return this._position},set:function(t){this._position=t,this._isDirty=!0},enumerable:!1,configurable:!0}),e.prototype.isUsingPivotMatrix=function(){return this._usePivotMatrix},Object.defineProperty(e.prototype,"rotation",{get:function(){return this._rotation},set:function(t){this._rotation=t,this._rotationQuaternion=null,this._isDirty=!0},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"scaling",{get:function(){return this._scaling},set:function(t){this._scaling=t,this._isDirty=!0},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"rotationQuaternion",{get:function(){return this._rotationQuaternion},set:function(t){this._rotationQuaternion=t,t&&this._rotation.setAll(0),this._isDirty=!0},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"forward",{get:function(){return m.TransformNormalFromFloatsToRef(0,0,this.getScene().useRightHandedSystem?-1:1,this.getWorldMatrix(),this._forward),this._forward.normalize()},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"up",{get:function(){return m.TransformNormalFromFloatsToRef(0,1,0,this.getWorldMatrix(),this._up),this._up.normalize()},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"right",{get:function(){return m.TransformNormalFromFloatsToRef(this.getScene().useRightHandedSystem?-1:1,0,0,this.getWorldMatrix(),this._right),this._right.normalize()},enumerable:!1,configurable:!0}),e.prototype.updatePoseMatrix=function(t){return this._poseMatrix?(this._poseMatrix.copyFrom(t),this):(this._poseMatrix=t.clone(),this)},e.prototype.getPoseMatrix=function(){return this._poseMatrix||(this._poseMatrix=G.Identity()),this._poseMatrix},e.prototype._isSynchronized=function(){var t=this._cache;return!(this.billboardMode!==t.billboardMode||this.billboardMode!==e.BILLBOARDMODE_NONE||t.pivotMatrixUpdated||this.infiniteDistance||this.position._isDirty||this.scaling._isDirty||this._rotationQuaternion&&this._rotationQuaternion._isDirty||this.rotation._isDirty)},e.prototype._initCache=function(){i.prototype._initCache.call(this);var t=this._cache;t.localMatrixUpdated=!1,t.billboardMode=-1,t.infiniteDistance=!1},Object.defineProperty(e.prototype,"absolutePosition",{get:function(){return this.getAbsolutePosition()},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"absoluteScaling",{get:function(){return this._syncAbsoluteScalingAndRotation(),this._absoluteScaling},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"absoluteRotationQuaternion",{get:function(){return this._syncAbsoluteScalingAndRotation(),this._absoluteRotationQuaternion},enumerable:!1,configurable:!0}),e.prototype.setPreTransformMatrix=function(t){return this.setPivotMatrix(t,!1)},e.prototype.setPivotMatrix=function(t,r){return r===void 0&&(r=!0),this._pivotMatrix.copyFrom(t),this._usePivotMatrix=!this._pivotMatrix.isIdentity(),this._cache.pivotMatrixUpdated=!0,this._postMultiplyPivotMatrix=r,this._postMultiplyPivotMatrix&&(this._pivotMatrixInverse?this._pivotMatrix.invertToRef(this._pivotMatrixInverse):this._pivotMatrixInverse=G.Invert(this._pivotMatrix)),this},e.prototype.getPivotMatrix=function(){return this._pivotMatrix},e.prototype.instantiateHierarchy=function(t,r,n){t===void 0&&(t=null);var a=this.clone("Clone of "+(this.name||this.id),t||this.parent,!0);a&&n&&n(this,a);for(var s=0,o=this.getChildTransformNodes(!0);s<o.length;s++){var l=o[s];l.instantiateHierarchy(a,r,n)}return a},e.prototype.freezeWorldMatrix=function(t,r){return t===void 0&&(t=null),r===void 0&&(r=!1),t?r?(this._rotation.setAll(0),this._rotationQuaternion=this._rotationQuaternion||de.Identity(),t.decompose(this._scaling,this._rotationQuaternion,this._position),this.computeWorldMatrix(!0)):(this._worldMatrix=t,this._absolutePosition.copyFromFloats(this._worldMatrix.m[12],this._worldMatrix.m[13],this._worldMatrix.m[14]),this._afterComputeWorldMatrix()):(this._isWorldMatrixFrozen=!1,this.computeWorldMatrix(!0)),this._isDirty=!1,this._isWorldMatrixFrozen=!0,this},e.prototype.unfreezeWorldMatrix=function(){return this._isWorldMatrixFrozen=!1,this.computeWorldMatrix(!0),this},Object.defineProperty(e.prototype,"isWorldMatrixFrozen",{get:function(){return this._isWorldMatrixFrozen},enumerable:!1,configurable:!0}),e.prototype.getAbsolutePosition=function(){return this.computeWorldMatrix(),this._absolutePosition},e.prototype.setAbsolutePosition=function(t){if(!t)return this;var r,n,a;if(t.x===void 0){if(arguments.length<3)return this;r=arguments[0],n=arguments[1],a=arguments[2]}else r=t.x,n=t.y,a=t.z;if(this.parent){var s=U.Matrix[0];this.parent.getWorldMatrix().invertToRef(s),m.TransformCoordinatesFromFloatsToRef(r,n,a,s,this.position)}else this.position.x=r,this.position.y=n,this.position.z=a;return this._absolutePosition.copyFrom(t),this},e.prototype.setPositionWithLocalVector=function(t){return this.computeWorldMatrix(),this.position=m.TransformNormal(t,this._localMatrix),this},e.prototype.getPositionExpressedInLocalSpace=function(){this.computeWorldMatrix();var t=U.Matrix[0];return this._localMatrix.invertToRef(t),m.TransformNormal(this.position,t)},e.prototype.locallyTranslate=function(t){return this.computeWorldMatrix(!0),this.position=m.TransformCoordinates(t,this._localMatrix),this},e.prototype.lookAt=function(t,r,n,a,s){r===void 0&&(r=0),n===void 0&&(n=0),a===void 0&&(a=0),s===void 0&&(s=Ce.LOCAL);var o=e._LookAtVectorCache,l=s===Ce.LOCAL?this.position:this.getAbsolutePosition();if(t.subtractToRef(l,o),this.setDirection(o,r,n,a),s===Ce.WORLD&&this.parent)if(this.rotationQuaternion){var u=U.Matrix[0];this.rotationQuaternion.toRotationMatrix(u);var f=U.Matrix[1];this.parent.getWorldMatrix().getRotationMatrixToRef(f),f.invert(),u.multiplyToRef(f,u),this.rotationQuaternion.fromRotationMatrix(u)}else{var h=U.Quaternion[0];de.FromEulerVectorToRef(this.rotation,h);var u=U.Matrix[0];h.toRotationMatrix(u);var f=U.Matrix[1];this.parent.getWorldMatrix().getRotationMatrixToRef(f),f.invert(),u.multiplyToRef(f,u),h.fromRotationMatrix(u),h.toEulerAnglesToRef(this.rotation)}return this},e.prototype.getDirection=function(t){var r=m.Zero();return this.getDirectionToRef(t,r),r},e.prototype.getDirectionToRef=function(t,r){return m.TransformNormalToRef(t,this.getWorldMatrix(),r),this},e.prototype.setDirection=function(t,r,n,a){r===void 0&&(r=0),n===void 0&&(n=0),a===void 0&&(a=0);var s=-Math.atan2(t.z,t.x)+Math.PI/2,o=Math.sqrt(t.x*t.x+t.z*t.z),l=-Math.atan2(t.y,o);return this.rotationQuaternion?de.RotationYawPitchRollToRef(s+r,l+n,a,this.rotationQuaternion):(this.rotation.x=l+n,this.rotation.y=s+r,this.rotation.z=a),this},e.prototype.setPivotPoint=function(t,r){r===void 0&&(r=Ce.LOCAL),this.getScene().getRenderId()==0&&this.computeWorldMatrix(!0);var n=this.getWorldMatrix();if(r==Ce.WORLD){var a=U.Matrix[0];n.invertToRef(a),t=m.TransformCoordinates(t,a)}return this.setPivotMatrix(G.Translation(-t.x,-t.y,-t.z),!0)},e.prototype.getPivotPoint=function(){var t=m.Zero();return this.getPivotPointToRef(t),t},e.prototype.getPivotPointToRef=function(t){return t.x=-this._pivotMatrix.m[12],t.y=-this._pivotMatrix.m[13],t.z=-this._pivotMatrix.m[14],this},e.prototype.getAbsolutePivotPoint=function(){var t=m.Zero();return this.getAbsolutePivotPointToRef(t),t},e.prototype.getAbsolutePivotPointToRef=function(t){return this.getPivotPointToRef(t),m.TransformCoordinatesToRef(t,this.getWorldMatrix(),t),this},e.prototype.markAsDirty=function(t){if(this._children)for(var r=0,n=this._children;r<n.length;r++){var a=n[r];a.markAsDirty(t)}return i.prototype.markAsDirty.call(this,t)},e.prototype.setParent=function(t,r){if(r===void 0&&(r=!1),!t&&!this.parent)return this;var n=U.Quaternion[0],a=U.Vector3[0],s=U.Vector3[1],o=U.Matrix[1];G.IdentityToRef(o);var l=U.Matrix[0];this.computeWorldMatrix(!0);var u=this.rotationQuaternion;return u||(u=e._TmpRotation,de.RotationYawPitchRollToRef(this._rotation.y,this._rotation.x,this._rotation.z,u)),G.ComposeToRef(this.scaling,u,this.position,l),this.parent&&l.multiplyToRef(this.parent.computeWorldMatrix(!0),l),t&&(t.computeWorldMatrix(!0).invertToRef(o),l.multiplyToRef(o,l)),l.decompose(s,n,a,r?this:void 0),this.rotationQuaternion?this.rotationQuaternion.copyFrom(n):n.toEulerAnglesToRef(this.rotation),this.scaling.copyFrom(s),this.position.copyFrom(a),this.parent=t,this},Object.defineProperty(e.prototype,"nonUniformScaling",{get:function(){return this._nonUniformScaling},enumerable:!1,configurable:!0}),e.prototype._updateNonUniformScalingState=function(t){return this._nonUniformScaling===t?!1:(this._nonUniformScaling=t,!0)},e.prototype.attachToBone=function(t,r){return this._currentParentWhenAttachingToBone=this.parent,this._transformToBoneReferal=r,this.parent=t,t.getSkeleton().prepare(),t.getWorldMatrix().determinant()<0&&(this.scalingDeterminant*=-1),this},e.prototype.detachFromBone=function(t){return t===void 0&&(t=!1),this.parent?(this.parent.getWorldMatrix().determinant()<0&&(this.scalingDeterminant*=-1),this._transformToBoneReferal=null,t?this.parent=this._currentParentWhenAttachingToBone:this.parent=null,this):(t&&(this.parent=this._currentParentWhenAttachingToBone),this)},e.prototype.rotate=function(t,r,n){t.normalize(),this.rotationQuaternion||(this.rotationQuaternion=this.rotation.toQuaternion(),this.rotation.setAll(0));var a;if(!n||n===Ce.LOCAL)a=de.RotationAxisToRef(t,r,e._RotationAxisCache),this.rotationQuaternion.multiplyToRef(a,this.rotationQuaternion);else{if(this.parent){var s=U.Matrix[0];this.parent.getWorldMatrix().invertToRef(s),t=m.TransformNormal(t,s)}a=de.RotationAxisToRef(t,r,e._RotationAxisCache),a.multiplyToRef(this.rotationQuaternion,this.rotationQuaternion)}return this},e.prototype.rotateAround=function(t,r,n){r.normalize(),this.rotationQuaternion||(this.rotationQuaternion=de.RotationYawPitchRoll(this.rotation.y,this.rotation.x,this.rotation.z),this.rotation.setAll(0));var a=U.Vector3[0],s=U.Vector3[1],o=U.Vector3[2],l=U.Quaternion[0],u=U.Matrix[0],f=U.Matrix[1],h=U.Matrix[2],c=U.Matrix[3];return t.subtractToRef(this.position,a),G.TranslationToRef(a.x,a.y,a.z,u),G.TranslationToRef(-a.x,-a.y,-a.z,f),G.RotationAxisToRef(r,n,h),f.multiplyToRef(h,c),c.multiplyToRef(u,c),c.decompose(s,l,o),this.position.addInPlace(o),l.multiplyToRef(this.rotationQuaternion,this.rotationQuaternion),this},e.prototype.translate=function(t,r,n){var a=t.scale(r);if(!n||n===Ce.LOCAL){var s=this.getPositionExpressedInLocalSpace().add(a);this.setPositionWithLocalVector(s)}else this.setAbsolutePosition(this.getAbsolutePosition().add(a));return this},e.prototype.addRotation=function(t,r,n){var a;this.rotationQuaternion?a=this.rotationQuaternion:(a=U.Quaternion[1],de.RotationYawPitchRollToRef(this.rotation.y,this.rotation.x,this.rotation.z,a));var s=U.Quaternion[0];return de.RotationYawPitchRollToRef(r,t,n,s),a.multiplyInPlace(s),this.rotationQuaternion||a.toEulerAnglesToRef(this.rotation),this},e.prototype._getEffectiveParent=function(){return this.parent},e.prototype.computeWorldMatrix=function(t){if(this._isWorldMatrixFrozen&&!this._isDirty)return this._worldMatrix;var r=this.getScene().getRenderId();if(!this._isDirty&&!t&&this.isSynchronized())return this._currentRenderId=r,this._worldMatrix;var n=this.getScene().activeCamera,a=(this._billboardMode&e.BILLBOARDMODE_USE_POSITION)!==0,s=this._billboardMode!==e.BILLBOARDMODE_NONE&&!this.preserveParentRotationForBillboard;this._updateCache();var o=this._cache;o.pivotMatrixUpdated=!1,o.billboardMode=this.billboardMode,o.infiniteDistance=this.infiniteDistance,o.parent=this._parentNode,this._currentRenderId=r,this._childUpdateId+=1,this._isDirty=!1,this._position._isDirty=!1,this._rotation._isDirty=!1,this._scaling._isDirty=!1;var l=this._getEffectiveParent(),u=e._TmpScaling,f=this._position;if(this._infiniteDistance&&!this.parent&&n){var h=n.getWorldMatrix(),c=new m(h.m[12],h.m[13],h.m[14]);f=e._TmpTranslation,f.copyFromFloats(this._position.x+c.x,this._position.y+c.y,this._position.z+c.z)}u.copyFromFloats(this._scaling.x*this.scalingDeterminant,this._scaling.y*this.scalingDeterminant,this._scaling.z*this.scalingDeterminant);var d;if(this._rotationQuaternion){if(this._rotationQuaternion._isDirty=!1,d=this._rotationQuaternion,this.reIntegrateRotationIntoRotationQuaternion){var p=this.rotation.lengthSquared();p&&(this._rotationQuaternion.multiplyInPlace(de.RotationYawPitchRoll(this._rotation.y,this._rotation.x,this._rotation.z)),this._rotation.copyFromFloats(0,0,0))}}else d=e._TmpRotation,de.RotationYawPitchRollToRef(this._rotation.y,this._rotation.x,this._rotation.z,d);if(this._usePivotMatrix){var _=U.Matrix[1];G.ScalingToRef(u.x,u.y,u.z,_);var g=U.Matrix[0];d.toRotationMatrix(g),this._pivotMatrix.multiplyToRef(_,U.Matrix[4]),U.Matrix[4].multiplyToRef(g,this._localMatrix),this._postMultiplyPivotMatrix&&this._localMatrix.multiplyToRef(this._pivotMatrixInverse,this._localMatrix),this._localMatrix.addTranslationFromFloats(f.x,f.y,f.z)}else G.ComposeToRef(u,d,f,this._localMatrix);if(l&&l.getWorldMatrix){if(t&&l.computeWorldMatrix(t),s){this._transformToBoneReferal?l.getWorldMatrix().multiplyToRef(this._transformToBoneReferal.getWorldMatrix(),U.Matrix[7]):U.Matrix[7].copyFrom(l.getWorldMatrix());var v=U.Vector3[5],y=U.Vector3[6];U.Matrix[7].decompose(y,void 0,v),G.ScalingToRef(y.x,y.y,y.z,U.Matrix[7]),U.Matrix[7].setTranslation(v),this._localMatrix.multiplyToRef(U.Matrix[7],this._worldMatrix)}else this._transformToBoneReferal?(this._localMatrix.multiplyToRef(l.getWorldMatrix(),U.Matrix[6]),U.Matrix[6].multiplyToRef(this._transformToBoneReferal.getWorldMatrix(),this._worldMatrix)):this._localMatrix.multiplyToRef(l.getWorldMatrix(),this._worldMatrix);this._markSyncedWithParent()}else this._worldMatrix.copyFrom(this._localMatrix);if(s&&n&&this.billboardMode&&!a){var b=U.Vector3[0];if(this._worldMatrix.getTranslationToRef(b),U.Matrix[1].copyFrom(n.getViewMatrix()),U.Matrix[1].setTranslationFromFloats(0,0,0),U.Matrix[1].invertToRef(U.Matrix[0]),(this.billboardMode&e.BILLBOARDMODE_ALL)!==e.BILLBOARDMODE_ALL){U.Matrix[0].decompose(void 0,U.Quaternion[0],void 0);var E=U.Vector3[1];U.Quaternion[0].toEulerAnglesToRef(E),(this.billboardMode&e.BILLBOARDMODE_X)!==e.BILLBOARDMODE_X&&(E.x=0),(this.billboardMode&e.BILLBOARDMODE_Y)!==e.BILLBOARDMODE_Y&&(E.y=0),(this.billboardMode&e.BILLBOARDMODE_Z)!==e.BILLBOARDMODE_Z&&(E.z=0),G.RotationYawPitchRollToRef(E.y,E.x,E.z,U.Matrix[0])}this._worldMatrix.setTranslationFromFloats(0,0,0),this._worldMatrix.multiplyToRef(U.Matrix[0],this._worldMatrix),this._worldMatrix.setTranslation(U.Vector3[0])}else if(s&&n&&this.billboardMode&&a){var b=U.Vector3[0];this._worldMatrix.getTranslationToRef(b);var A=n.globalPosition;this._worldMatrix.invertToRef(U.Matrix[1]);var S=U.Vector3[1];m.TransformCoordinatesToRef(A,U.Matrix[1],S),S.normalize();var T=-Math.atan2(S.z,S.x)+Math.PI/2,p=Math.sqrt(S.x*S.x+S.z*S.z),M=-Math.atan2(S.y,p);if(de.RotationYawPitchRollToRef(T,M,0,U.Quaternion[0]),(this.billboardMode&e.BILLBOARDMODE_ALL)!==e.BILLBOARDMODE_ALL){var E=U.Vector3[1];U.Quaternion[0].toEulerAnglesToRef(E),(this.billboardMode&e.BILLBOARDMODE_X)!==e.BILLBOARDMODE_X&&(E.x=0),(this.billboardMode&e.BILLBOARDMODE_Y)!==e.BILLBOARDMODE_Y&&(E.y=0),(this.billboardMode&e.BILLBOARDMODE_Z)!==e.BILLBOARDMODE_Z&&(E.z=0),G.RotationYawPitchRollToRef(E.y,E.x,E.z,U.Matrix[0])}else G.FromQuaternionToRef(U.Quaternion[0],U.Matrix[0]);this._worldMatrix.setTranslationFromFloats(0,0,0),this._worldMatrix.multiplyToRef(U.Matrix[0],this._worldMatrix),this._worldMatrix.setTranslation(U.Vector3[0])}return this.ignoreNonUniformScaling?this._updateNonUniformScalingState(!1):this._scaling.isNonUniformWithinEpsilon(1e-6)?this._updateNonUniformScalingState(!0):l&&l._nonUniformScaling?this._updateNonUniformScalingState(l._nonUniformScaling):this._updateNonUniformScalingState(!1),this._afterComputeWorldMatrix(),this._absolutePosition.copyFromFloats(this._worldMatrix.m[12],this._worldMatrix.m[13],this._worldMatrix.m[14]),this._isAbsoluteSynced=!1,this.onAfterWorldMatrixUpdateObservable.notifyObservers(this),this._poseMatrix||(this._poseMatrix=G.Invert(this._worldMatrix)),this._worldMatrixDeterminantIsDirty=!0,this._worldMatrix},e.prototype.resetLocalMatrix=function(t){if(t===void 0&&(t=!0),this.computeWorldMatrix(),t)for(var r=this.getChildren(),n=0;n<r.length;++n){var a=r[n];if(a){a.computeWorldMatrix();var s=U.Matrix[0];a._localMatrix.multiplyToRef(this._localMatrix,s);var o=U.Quaternion[0];s.decompose(a.scaling,o,a.position),a.rotationQuaternion?a.rotationQuaternion.copyFrom(o):o.toEulerAnglesToRef(a.rotation)}}this.scaling.copyFromFloats(1,1,1),this.position.copyFromFloats(0,0,0),this.rotation.copyFromFloats(0,0,0),this.rotationQuaternion&&(this.rotationQuaternion=de.Identity()),this._worldMatrix=G.Identity()},e.prototype._afterComputeWorldMatrix=function(){},e.prototype.registerAfterWorldMatrixUpdate=function(t){return this.onAfterWorldMatrixUpdateObservable.add(t),this},e.prototype.unregisterAfterWorldMatrixUpdate=function(t){return this.onAfterWorldMatrixUpdateObservable.removeCallback(t),this},e.prototype.getPositionInCameraSpace=function(t){return t===void 0&&(t=null),t||(t=this.getScene().activeCamera),m.TransformCoordinates(this.getAbsolutePosition(),t.getViewMatrix())},e.prototype.getDistanceToCamera=function(t){return t===void 0&&(t=null),t||(t=this.getScene().activeCamera),this.getAbsolutePosition().subtract(t.globalPosition).length()},e.prototype.clone=function(t,r,n){var a=this,s=pe.Clone(function(){return new e(t,a.getScene())},this);if(s.name=t,s.id=t,r&&(s.parent=r),!n)for(var o=this.getDescendants(!0),l=0;l<o.length;l++){var u=o[l];u.clone&&u.clone(t+"."+u.name,s)}return s},e.prototype.serialize=function(t){var r=pe.Serialize(this,t);return r.type=this.getClassName(),r.uniqueId=this.uniqueId,this.parent&&(r.parentId=this.parent.uniqueId),r.localMatrix=this.getPivotMatrix().asArray(),r.isEnabled=this.isEnabled(),this.parent&&(r.parentId=this.parent.uniqueId),r},e.Parse=function(t,r,n){var a=pe.Parse(function(){return new e(t.name,r)},t,r,n);return t.localMatrix?a.setPreTransformMatrix(G.FromArray(t.localMatrix)):t.pivotMatrix&&a.setPivotMatrix(G.FromArray(t.pivotMatrix)),a.setEnabled(t.isEnabled),t.parentId!==void 0&&(a._waitingParentId=t.parentId),a},e.prototype.getChildTransformNodes=function(t,r){var n=[];return this._getDescendants(n,t,function(a){return(!r||r(a))&&a instanceof e}),n},e.prototype.dispose=function(t,r){if(r===void 0&&(r=!1),this.getScene().stopAnimation(this),this.getScene().removeTransformNode(this),this._parentContainer){var n=this._parentContainer.transformNodes.indexOf(this);n>-1&&this._parentContainer.transformNodes.splice(n,1),this._parentContainer=null}if(this.onAfterWorldMatrixUpdateObservable.clear(),t)for(var a=this.getChildTransformNodes(!0),s=0,o=a;s<o.length;s++){var l=o[s];l.parent=null,l.computeWorldMatrix(!0)}i.prototype.dispose.call(this,t,r)},e.prototype.normalizeToUnitCube=function(t,r,n){t===void 0&&(t=!0),r===void 0&&(r=!1);var a=null,s=null;r&&(this.rotationQuaternion?(s=this.rotationQuaternion.clone(),this.rotationQuaternion.copyFromFloats(0,0,0,1)):this.rotation&&(a=this.rotation.clone(),this.rotation.copyFromFloats(0,0,0)));var o=this.getHierarchyBoundingVectors(t,n),l=o.max.subtract(o.min),u=Math.max(l.x,l.y,l.z);if(u===0)return this;var f=1/u;return this.scaling.scaleInPlace(f),r&&(this.rotationQuaternion&&s?this.rotationQuaternion.copyFrom(s):this.rotation&&a&&this.rotation.copyFrom(a)),this},e.prototype._syncAbsoluteScalingAndRotation=function(){this._isAbsoluteSynced||(this._worldMatrix.decompose(this._absoluteScaling,this._absoluteRotationQuaternion),this._isAbsoluteSynced=!0)},e.BILLBOARDMODE_NONE=0,e.BILLBOARDMODE_X=1,e.BILLBOARDMODE_Y=2,e.BILLBOARDMODE_Z=4,e.BILLBOARDMODE_ALL=7,e.BILLBOARDMODE_USE_POSITION=128,e._TmpRotation=de.Zero(),e._TmpScaling=m.Zero(),e._TmpTranslation=m.Zero(),e._LookAtVectorCache=new m(0,0,0),e._RotationAxisCache=new de,C([xt("position")],e.prototype,"_position",void 0),C([xt("rotation")],e.prototype,"_rotation",void 0),C([mo("rotationQuaternion")],e.prototype,"_rotationQuaternion",void 0),C([xt("scaling")],e.prototype,"_scaling",void 0),C([I("billboardMode")],e.prototype,"_billboardMode",void 0),C([I()],e.prototype,"scalingDeterminant",void 0),C([I("infiniteDistance")],e.prototype,"_infiniteDistance",void 0),C([I()],e.prototype,"ignoreNonUniformScaling",void 0),C([I()],e.prototype,"reIntegrateRotationIntoRotationQuaternion",void 0),e}(ct);function ti(i,e,t){try{var r=i.next();r.done?e(r):r.value?r.value.then(function(){r.value=void 0,e(r)},t):e(r)}catch(n){t(n)}}function pl(i){i===void 0&&(i=25);var e;return function(t,r,n){var a=performance.now();e===void 0||a-e>i?(e=a,setTimeout(function(){ti(t,r,n)},0)):ti(t,r,n)}}function Xa(i,e,t,r,n){var a=function(){var s,o=function(l){l.done?t(l.value):s===void 0?s=!0:a()};do s=void 0,!n||!n.aborted?e(i,o,r):r(new Error("Aborted")),s===void 0&&(s=!1);while(s)};a()}function on(i,e){var t;return Xa(i,ti,function(r){return t=r},function(r){throw r},e),t}function ja(i,e,t){return new Promise(function(r,n){Xa(i,e,r,n,t)})}function _l(i,e){return function(){for(var t=[],r=0;r<arguments.length;r++)t[r]=arguments[r];return on(i.apply(void 0,t),e)}}var J=function(){function i(){this._applyTo=_l(this._applyToCoroutine.bind(this))}return i.prototype.set=function(e,t){switch(e.length||Y.Warn("Setting vertex data kind '".concat(t,"' with an empty array")),t){case R.PositionKind:this.positions=e;break;case R.NormalKind:this.normals=e;break;case R.TangentKind:this.tangents=e;break;case R.UVKind:this.uvs=e;break;case R.UV2Kind:this.uvs2=e;break;case R.UV3Kind:this.uvs3=e;break;case R.UV4Kind:this.uvs4=e;break;case R.UV5Kind:this.uvs5=e;break;case R.UV6Kind:this.uvs6=e;break;case R.ColorKind:this.colors=e;break;case R.MatricesIndicesKind:this.matricesIndices=e;break;case R.MatricesWeightsKind:this.matricesWeights=e;break;case R.MatricesIndicesExtraKind:this.matricesIndicesExtra=e;break;case R.MatricesWeightsExtraKind:this.matricesWeightsExtra=e;break}},i.prototype.applyToMesh=function(e,t){return this._applyTo(e,t,!1),this},i.prototype.applyToGeometry=function(e,t){return this._applyTo(e,t,!1),this},i.prototype.updateMesh=function(e){return this._update(e),this},i.prototype.updateGeometry=function(e){return this._update(e),this},i.prototype._applyToCoroutine=function(e,t,r){return t===void 0&&(t=!1),gr(this,function(n){switch(n.label){case 0:return this.positions?(e.setVerticesData(R.PositionKind,this.positions,t),r?[4]:[3,2]):[3,2];case 1:n.sent(),n.label=2;case 2:return this.normals?(e.setVerticesData(R.NormalKind,this.normals,t),r?[4]:[3,4]):[3,4];case 3:n.sent(),n.label=4;case 4:return this.tangents?(e.setVerticesData(R.TangentKind,this.tangents,t),r?[4]:[3,6]):[3,6];case 5:n.sent(),n.label=6;case 6:return this.uvs?(e.setVerticesData(R.UVKind,this.uvs,t),r?[4]:[3,8]):[3,8];case 7:n.sent(),n.label=8;case 8:return this.uvs2?(e.setVerticesData(R.UV2Kind,this.uvs2,t),r?[4]:[3,10]):[3,10];case 9:n.sent(),n.label=10;case 10:return this.uvs3?(e.setVerticesData(R.UV3Kind,this.uvs3,t),r?[4]:[3,12]):[3,12];case 11:n.sent(),n.label=12;case 12:return this.uvs4?(e.setVerticesData(R.UV4Kind,this.uvs4,t),r?[4]:[3,14]):[3,14];case 13:n.sent(),n.label=14;case 14:return this.uvs5?(e.setVerticesData(R.UV5Kind,this.uvs5,t),r?[4]:[3,16]):[3,16];case 15:n.sent(),n.label=16;case 16:return this.uvs6?(e.setVerticesData(R.UV6Kind,this.uvs6,t),r?[4]:[3,18]):[3,18];case 17:n.sent(),n.label=18;case 18:return this.colors?(e.setVerticesData(R.ColorKind,this.colors,t),r?[4]:[3,20]):[3,20];case 19:n.sent(),n.label=20;case 20:return this.matricesIndices?(e.setVerticesData(R.MatricesIndicesKind,this.matricesIndices,t),r?[4]:[3,22]):[3,22];case 21:n.sent(),n.label=22;case 22:return this.matricesWeights?(e.setVerticesData(R.MatricesWeightsKind,this.matricesWeights,t),r?[4]:[3,24]):[3,24];case 23:n.sent(),n.label=24;case 24:return this.matricesIndicesExtra?(e.setVerticesData(R.MatricesIndicesExtraKind,this.matricesIndicesExtra,t),r?[4]:[3,26]):[3,26];case 25:n.sent(),n.label=26;case 26:return this.matricesWeightsExtra?(e.setVerticesData(R.MatricesWeightsExtraKind,this.matricesWeightsExtra,t),r?[4]:[3,28]):[3,28];case 27:n.sent(),n.label=28;case 28:return this.indices?(e.setIndices(this.indices,null,t),r?[4]:[3,30]):[3,31];case 29:n.sent(),n.label=30;case 30:return[3,32];case 31:e.setIndices([],null),n.label=32;case 32:return[2,this]}})},i.prototype._update=function(e,t,r){return this.positions&&e.updateVerticesData(R.PositionKind,this.positions,t,r),this.normals&&e.updateVerticesData(R.NormalKind,this.normals,t,r),this.tangents&&e.updateVerticesData(R.TangentKind,this.tangents,t,r),this.uvs&&e.updateVerticesData(R.UVKind,this.uvs,t,r),this.uvs2&&e.updateVerticesData(R.UV2Kind,this.uvs2,t,r),this.uvs3&&e.updateVerticesData(R.UV3Kind,this.uvs3,t,r),this.uvs4&&e.updateVerticesData(R.UV4Kind,this.uvs4,t,r),this.uvs5&&e.updateVerticesData(R.UV5Kind,this.uvs5,t,r),this.uvs6&&e.updateVerticesData(R.UV6Kind,this.uvs6,t,r),this.colors&&e.updateVerticesData(R.ColorKind,this.colors,t,r),this.matricesIndices&&e.updateVerticesData(R.MatricesIndicesKind,this.matricesIndices,t,r),this.matricesWeights&&e.updateVerticesData(R.MatricesWeightsKind,this.matricesWeights,t,r),this.matricesIndicesExtra&&e.updateVerticesData(R.MatricesIndicesExtraKind,this.matricesIndicesExtra,t,r),this.matricesWeightsExtra&&e.updateVerticesData(R.MatricesWeightsExtraKind,this.matricesWeightsExtra,t,r),this.indices&&e.setIndices(this.indices,null),this},i._TransformVector3Coordinates=function(e,t,r,n){r===void 0&&(r=0),n===void 0&&(n=e.length);for(var a=U.Vector3[0],s=U.Vector3[1],o=r;o<r+n;o+=3)m.FromArrayToRef(e,o,a),m.TransformCoordinatesToRef(a,t,s),e[o]=s.x,e[o+1]=s.y,e[o+2]=s.z},i._TransformVector3Normals=function(e,t,r,n){r===void 0&&(r=0),n===void 0&&(n=e.length);for(var a=U.Vector3[0],s=U.Vector3[1],o=r;o<r+n;o+=3)m.FromArrayToRef(e,o,a),m.TransformNormalToRef(a,t,s),e[o]=s.x,e[o+1]=s.y,e[o+2]=s.z},i._TransformVector4Normals=function(e,t,r,n){r===void 0&&(r=0),n===void 0&&(n=e.length);for(var a=U.Vector4[0],s=U.Vector4[1],o=r;o<r+n;o+=4)Ke.FromArrayToRef(e,o,a),Ke.TransformNormalToRef(a,t,s),e[o]=s.x,e[o+1]=s.y,e[o+2]=s.z,e[o+3]=s.w},i._FlipFaces=function(e,t,r){t===void 0&&(t=0),r===void 0&&(r=e.length);for(var n=t;n<t+r;n+=3){var a=e[n+1];e[n+1]=e[n+2],e[n+2]=a}},i.prototype.transform=function(e){var t=e.determinant()<0;return this.positions&&i._TransformVector3Coordinates(this.positions,e),this.normals&&i._TransformVector3Normals(this.normals,e),this.tangents&&i._TransformVector4Normals(this.tangents,e),t&&this.indices&&i._FlipFaces(this.indices),this},i.prototype.merge=function(e,t,r){t===void 0&&(t=!1),r===void 0&&(r=!1);var n=Array.isArray(e)?e.map(function(a){return[a,void 0]}):[[e,void 0]];return on(this._mergeCoroutine(void 0,n,t,!1,r))},i.prototype._mergeCoroutine=function(e,t,r,n,a){var s,o,l,y,u,f,h,c,d,p,_,g,v,y,b,E,A=this,S,T,M,D;return r===void 0&&(r=!1),gr(this,function(x){switch(x.label){case 0:for(this._validate(),s=t.map(function(P){return P[0]}),o=0,l=s;o<l.length;o++)if(y=l[o],y._validate(),!this.normals!=!y.normals||!this.tangents!=!y.tangents||!this.uvs!=!y.uvs||!this.uvs2!=!y.uvs2||!this.uvs3!=!y.uvs3||!this.uvs4!=!y.uvs4||!this.uvs5!=!y.uvs5||!this.uvs6!=!y.uvs6||!this.colors!=!y.colors||!this.matricesIndices!=!y.matricesIndices||!this.matricesWeights!=!y.matricesWeights||!this.matricesIndicesExtra!=!y.matricesIndicesExtra||!this.matricesWeightsExtra!=!y.matricesWeightsExtra)throw new Error("Cannot merge vertex data that do not have the same set of attributes");if(u=s.reduce(function(P,w){var k,B;return P+((B=(k=w.indices)===null||k===void 0?void 0:k.length)!==null&&B!==void 0?B:0)},(T=(S=this.indices)===null||S===void 0?void 0:S.length)!==null&&T!==void 0?T:0),f=a||s.some(function(P){return P.indices===A.indices}),h=f?(M=this.indices)===null||M===void 0?void 0:M.slice():this.indices,!(u>0))return[3,4];c=(D=h==null?void 0:h.length)!==null&&D!==void 0?D:0,h||(h=new Array(u)),h.length!==u&&(Array.isArray(h)?h.length=u:(d=r||h instanceof Uint32Array?new Uint32Array(u):new Uint16Array(u),d.set(h),h=d),e&&e.determinant()<0&&i._FlipFaces(h,0,c)),p=this.positions?this.positions.length/3:0,_=0,g=t,x.label=1;case 1:if(!(_<g.length))return[3,4];if(v=g[_],y=v[0],b=v[1],!y.indices)return[3,3];for(E=0;E<y.indices.length;E++)h[c+E]=y.indices[E]+p;return b&&b.determinant()<0&&i._FlipFaces(h,c,y.indices.length),p+=y.positions.length/3,c+=y.indices.length,n?[4]:[3,3];case 2:x.sent(),x.label=3;case 3:return _++,[3,1];case 4:return this.indices=h,this.positions=i._MergeElement(R.PositionKind,this.positions,e,t.map(function(P){return[P[0].positions,P[1]]})),n?[4]:[3,6];case 5:x.sent(),x.label=6;case 6:return this.normals=i._MergeElement(R.NormalKind,this.normals,e,t.map(function(P){return[P[0].normals,P[1]]})),n?[4]:[3,8];case 7:x.sent(),x.label=8;case 8:return this.tangents=i._MergeElement(R.TangentKind,this.tangents,e,t.map(function(P){return[P[0].tangents,P[1]]})),n?[4]:[3,10];case 9:x.sent(),x.label=10;case 10:return this.uvs=i._MergeElement(R.UVKind,this.uvs,e,t.map(function(P){return[P[0].uvs,P[1]]})),n?[4]:[3,12];case 11:x.sent(),x.label=12;case 12:return this.uvs2=i._MergeElement(R.UV2Kind,this.uvs2,e,t.map(function(P){return[P[0].uvs2,P[1]]})),n?[4]:[3,14];case 13:x.sent(),x.label=14;case 14:return this.uvs3=i._MergeElement(R.UV3Kind,this.uvs3,e,t.map(function(P){return[P[0].uvs3,P[1]]})),n?[4]:[3,16];case 15:x.sent(),x.label=16;case 16:return this.uvs4=i._MergeElement(R.UV4Kind,this.uvs4,e,t.map(function(P){return[P[0].uvs4,P[1]]})),n?[4]:[3,18];case 17:x.sent(),x.label=18;case 18:return this.uvs5=i._MergeElement(R.UV5Kind,this.uvs5,e,t.map(function(P){return[P[0].uvs5,P[1]]})),n?[4]:[3,20];case 19:x.sent(),x.label=20;case 20:return this.uvs6=i._MergeElement(R.UV6Kind,this.uvs6,e,t.map(function(P){return[P[0].uvs6,P[1]]})),n?[4]:[3,22];case 21:x.sent(),x.label=22;case 22:return this.colors=i._MergeElement(R.ColorKind,this.colors,e,t.map(function(P){return[P[0].colors,P[1]]})),n?[4]:[3,24];case 23:x.sent(),x.label=24;case 24:return this.matricesIndices=i._MergeElement(R.MatricesIndicesKind,this.matricesIndices,e,t.map(function(P){return[P[0].matricesIndices,P[1]]})),n?[4]:[3,26];case 25:x.sent(),x.label=26;case 26:return this.matricesWeights=i._MergeElement(R.MatricesWeightsKind,this.matricesWeights,e,t.map(function(P){return[P[0].matricesWeights,P[1]]})),n?[4]:[3,28];case 27:x.sent(),x.label=28;case 28:return this.matricesIndicesExtra=i._MergeElement(R.MatricesIndicesExtraKind,this.matricesIndicesExtra,e,t.map(function(P){return[P[0].matricesIndicesExtra,P[1]]})),n?[4]:[3,30];case 29:x.sent(),x.label=30;case 30:return this.matricesWeightsExtra=i._MergeElement(R.MatricesWeightsExtraKind,this.matricesWeightsExtra,e,t.map(function(P){return[P[0].matricesWeightsExtra,P[1]]})),[2,this]}})},i._MergeElement=function(e,t,r,n){var a=n.filter(function(A){return A[0]!==null&&A[0]!==void 0});if(!t&&a.length==0)return t;if(!t)return this._MergeElement(e,a[0][0],a[0][1],a.slice(1));var s=a.reduce(function(A,S){return A+S[0].length},t.length),o=e===R.PositionKind?i._TransformVector3Coordinates:e===R.NormalKind?i._TransformVector3Normals:e===R.TangentKind?i._TransformVector4Normals:function(){};if(t instanceof Float32Array){var l=new Float32Array(s);l.set(t),r&&o(l,r,0,t.length);for(var u=t.length,f=0,h=a;f<h.length;f++){var c=h[f],d=c[0],p=c[1];l.set(d,u),p&&o(l,p,u,d.length),u+=d.length}return l}else{for(var _=new Array(s),g=0;g<t.length;g++)_[g]=t[g];r&&o(_,r,0,t.length);for(var u=t.length,v=0,y=a;v<y.length;v++){for(var b=y[v],d=b[0],E=b[1],g=0;g<d.length;g++)_[u+g]=d[g];E&&o(_,E,u,d.length),u+=d.length}return _}},i.prototype._validate=function(){if(!this.positions)throw new or("Positions are required",sr.MeshInvalidPositionsError);var e=function(n,a){var s=R.DeduceStride(n);if(a.length%s!==0)throw new Error("The "+n+"s array count must be a multiple of "+s);return a.length/s},t=e(R.PositionKind,this.positions),r=function(n,a){var s=e(n,a);if(s!==t)throw new Error("The "+n+"s element count ("+s+") does not match the positions count ("+t+")")};this.normals&&r(R.NormalKind,this.normals),this.tangents&&r(R.TangentKind,this.tangents),this.uvs&&r(R.UVKind,this.uvs),this.uvs2&&r(R.UV2Kind,this.uvs2),this.uvs3&&r(R.UV3Kind,this.uvs3),this.uvs4&&r(R.UV4Kind,this.uvs4),this.uvs5&&r(R.UV5Kind,this.uvs5),this.uvs6&&r(R.UV6Kind,this.uvs6),this.colors&&r(R.ColorKind,this.colors),this.matricesIndices&&r(R.MatricesIndicesKind,this.matricesIndices),this.matricesWeights&&r(R.MatricesWeightsKind,this.matricesWeights),this.matricesIndicesExtra&&r(R.MatricesIndicesExtraKind,this.matricesIndicesExtra),this.matricesWeightsExtra&&r(R.MatricesWeightsExtraKind,this.matricesWeightsExtra)},i.prototype.serialize=function(){var e={};return this.positions&&(e.positions=this.positions),this.normals&&(e.normals=this.normals),this.tangents&&(e.tangents=this.tangents),this.uvs&&(e.uvs=this.uvs),this.uvs2&&(e.uvs2=this.uvs2),this.uvs3&&(e.uvs3=this.uvs3),this.uvs4&&(e.uvs4=this.uvs4),this.uvs5&&(e.uvs5=this.uvs5),this.uvs6&&(e.uvs6=this.uvs6),this.colors&&(e.colors=this.colors),this.matricesIndices&&(e.matricesIndices=this.matricesIndices,e.matricesIndices._isExpanded=!0),this.matricesWeights&&(e.matricesWeights=this.matricesWeights),this.matricesIndicesExtra&&(e.matricesIndicesExtra=this.matricesIndicesExtra,e.matricesIndicesExtra._isExpanded=!0),this.matricesWeightsExtra&&(e.matricesWeightsExtra=this.matricesWeightsExtra),e.indices=this.indices,e},i.ExtractFromMesh=function(e,t,r){return i._ExtractFrom(e,t,r)},i.ExtractFromGeometry=function(e,t,r){return i._ExtractFrom(e,t,r)},i._ExtractFrom=function(e,t,r){var n=new i;return e.isVerticesDataPresent(R.PositionKind)&&(n.positions=e.getVerticesData(R.PositionKind,t,r)),e.isVerticesDataPresent(R.NormalKind)&&(n.normals=e.getVerticesData(R.NormalKind,t,r)),e.isVerticesDataPresent(R.TangentKind)&&(n.tangents=e.getVerticesData(R.TangentKind,t,r)),e.isVerticesDataPresent(R.UVKind)&&(n.uvs=e.getVerticesData(R.UVKind,t,r)),e.isVerticesDataPresent(R.UV2Kind)&&(n.uvs2=e.getVerticesData(R.UV2Kind,t,r)),e.isVerticesDataPresent(R.UV3Kind)&&(n.uvs3=e.getVerticesData(R.UV3Kind,t,r)),e.isVerticesDataPresent(R.UV4Kind)&&(n.uvs4=e.getVerticesData(R.UV4Kind,t,r)),e.isVerticesDataPresent(R.UV5Kind)&&(n.uvs5=e.getVerticesData(R.UV5Kind,t,r)),e.isVerticesDataPresent(R.UV6Kind)&&(n.uvs6=e.getVerticesData(R.UV6Kind,t,r)),e.isVerticesDataPresent(R.ColorKind)&&(n.colors=e.getVerticesData(R.ColorKind,t,r)),e.isVerticesDataPresent(R.MatricesIndicesKind)&&(n.matricesIndices=e.getVerticesData(R.MatricesIndicesKind,t,r)),e.isVerticesDataPresent(R.MatricesWeightsKind)&&(n.matricesWeights=e.getVerticesData(R.MatricesWeightsKind,t,r)),e.isVerticesDataPresent(R.MatricesIndicesExtraKind)&&(n.matricesIndicesExtra=e.getVerticesData(R.MatricesIndicesExtraKind,t,r)),e.isVerticesDataPresent(R.MatricesWeightsExtraKind)&&(n.matricesWeightsExtra=e.getVerticesData(R.MatricesWeightsExtraKind,t,r)),n.indices=e.getIndices(t,r),n},i.CreateRibbon=function(e){throw he("ribbonBuilder")},i.CreateBox=function(e){throw he("boxBuilder")},i.CreateTiledBox=function(e){throw he("tiledBoxBuilder")},i.CreateTiledPlane=function(e){throw he("tiledPlaneBuilder")},i.CreateSphere=function(e){throw he("sphereBuilder")},i.CreateCylinder=function(e){throw he("cylinderBuilder")},i.CreateTorus=function(e){throw he("torusBuilder")},i.CreateLineSystem=function(e){throw he("linesBuilder")},i.CreateDashedLines=function(e){throw he("linesBuilder")},i.CreateGround=function(e){throw he("groundBuilder")},i.CreateTiledGround=function(e){throw he("groundBuilder")},i.CreateGroundFromHeightMap=function(e){throw he("groundBuilder")},i.CreatePlane=function(e){throw he("planeBuilder")},i.CreateDisc=function(e){throw he("discBuilder")},i.CreatePolygon=function(e,t,r,n,a,s,o){throw he("polygonBuilder")},i.CreateIcoSphere=function(e){throw he("icoSphereBuilder")},i.CreatePolyhedron=function(e){throw he("polyhedronBuilder")},i.CreateCapsule=function(e){throw e===void 0&&(e={orientation:m.Up(),subdivisions:2,tessellation:16,height:1,radius:.25,capSubdivisions:6}),he("capsuleBuilder")},i.CreateTorusKnot=function(e){throw he("torusKnotBuilder")},i.ComputeNormals=function(e,t,r,n){var a=0,s=0,o=0,l=0,u=0,f=0,h=0,c=0,d=0,p=0,_=0,g=0,v=0,y=0,b=0,E=0,A=0,S=0,T=0,M=0,D=!1,x=!1,P=!1,w=!1,k=1,B=0,L=null;n&&(D=!!n.facetNormals,x=!!n.facetPositions,P=!!n.facetPartitioning,k=n.useRightHandedSystem===!0?-1:1,B=n.ratio||0,w=!!n.depthSort,L=n.distanceTo,w&&L===void 0&&(L=m.Zero()));var H=0,W=0,F=0,V=0;for(P&&n&&n.bbSize&&(H=n.subDiv.X*B/n.bbSize.x,W=n.subDiv.Y*B/n.bbSize.y,F=n.subDiv.Z*B/n.bbSize.z,V=n.subDiv.max*n.subDiv.max,n.facetPartitioning.length=0),a=0;a<e.length;a++)r[a]=0;var z=t.length/3|0;for(a=0;a<z;a++){if(g=t[a*3]*3,v=g+1,y=g+2,b=t[a*3+1]*3,E=b+1,A=b+2,S=t[a*3+2]*3,T=S+1,M=S+2,s=e[g]-e[b],o=e[v]-e[E],l=e[y]-e[A],u=e[S]-e[b],f=e[T]-e[E],h=e[M]-e[A],c=k*(o*h-l*f),d=k*(l*u-s*h),p=k*(s*f-o*u),_=Math.sqrt(c*c+d*d+p*p),_=_===0?1:_,c/=_,d/=_,p/=_,D&&n&&(n.facetNormals[a].x=c,n.facetNormals[a].y=d,n.facetNormals[a].z=p),x&&n&&(n.facetPositions[a].x=(e[g]+e[b]+e[S])/3,n.facetPositions[a].y=(e[v]+e[E]+e[T])/3,n.facetPositions[a].z=(e[y]+e[A]+e[M])/3),P&&n){var N=Math.floor((n.facetPositions[a].x-n.bInfo.minimum.x*B)*H),Q=Math.floor((n.facetPositions[a].y-n.bInfo.minimum.y*B)*W),Z=Math.floor((n.facetPositions[a].z-n.bInfo.minimum.z*B)*F),ee=Math.floor((e[g]-n.bInfo.minimum.x*B)*H),ne=Math.floor((e[v]-n.bInfo.minimum.y*B)*W),Te=Math.floor((e[y]-n.bInfo.minimum.z*B)*F),j=Math.floor((e[b]-n.bInfo.minimum.x*B)*H),oe=Math.floor((e[E]-n.bInfo.minimum.y*B)*W),be=Math.floor((e[A]-n.bInfo.minimum.z*B)*F),Ee=Math.floor((e[S]-n.bInfo.minimum.x*B)*H),Pe=Math.floor((e[T]-n.bInfo.minimum.y*B)*W),Fe=Math.floor((e[M]-n.bInfo.minimum.z*B)*F),Ae=ee+n.subDiv.max*ne+V*Te,xe=j+n.subDiv.max*oe+V*be,_e=Ee+n.subDiv.max*Pe+V*Fe,we=N+n.subDiv.max*Q+V*Z;n.facetPartitioning[we]=n.facetPartitioning[we]?n.facetPartitioning[we]:new Array,n.facetPartitioning[Ae]=n.facetPartitioning[Ae]?n.facetPartitioning[Ae]:new Array,n.facetPartitioning[xe]=n.facetPartitioning[xe]?n.facetPartitioning[xe]:new Array,n.facetPartitioning[_e]=n.facetPartitioning[_e]?n.facetPartitioning[_e]:new Array,n.facetPartitioning[Ae].push(a),xe!=Ae&&n.facetPartitioning[xe].push(a),_e==xe||_e==Ae||n.facetPartitioning[_e].push(a),we==Ae||we==xe||we==_e||n.facetPartitioning[we].push(a)}if(w&&n&&n.facetPositions){var Ve=n.depthSortedFacets[a];Ve.ind=a*3,Ve.sqDistance=m.DistanceSquared(n.facetPositions[a],L)}r[g]+=c,r[v]+=d,r[y]+=p,r[b]+=c,r[E]+=d,r[A]+=p,r[S]+=c,r[T]+=d,r[M]+=p}for(a=0;a<r.length/3;a++)c=r[a*3],d=r[a*3+1],p=r[a*3+2],_=Math.sqrt(c*c+d*d+p*p),_=_===0?1:_,c/=_,d/=_,p/=_,r[a*3]=c,r[a*3+1]=d,r[a*3+2]=p},i._ComputeSides=function(e,t,r,n,a,s,o){var l=r.length,u=n.length,f,h;switch(e=e||i.DEFAULTSIDE,e){case i.FRONTSIDE:break;case i.BACKSIDE:for(f=0;f<l;f+=3){var c=r[f];r[f]=r[f+2],r[f+2]=c}for(h=0;h<u;h++)n[h]=-n[h];break;case i.DOUBLESIDE:{for(var d=t.length,p=d/3,_=0;_<d;_++)t[d+_]=t[_];for(f=0;f<l;f+=3)r[f+l]=r[f+2]+p,r[f+1+l]=r[f+1]+p,r[f+2+l]=r[f]+p;for(h=0;h<u;h++)n[u+h]=-n[h];var g=a.length,v=0;for(v=0;v<g;v++)a[v+g]=a[v];for(s=s||new Ke(0,0,1,1),o=o||new Ke(0,0,1,1),v=0,f=0;f<g/2;f++)a[v]=s.x+(s.z-s.x)*a[v],a[v+1]=s.y+(s.w-s.y)*a[v+1],a[v+g]=o.x+(o.z-o.x)*a[v+g],a[v+g+1]=o.y+(o.w-o.y)*a[v+g+1],v+=2;break}}},i.ImportVertexData=function(e,t){var r=new i,n=e.positions;n&&r.set(n,R.PositionKind);var a=e.normals;a&&r.set(a,R.NormalKind);var s=e.tangents;s&&r.set(s,R.TangentKind);var o=e.uvs;o&&r.set(o,R.UVKind);var l=e.uv2s;l&&r.set(l,R.UV2Kind);var u=e.uv3s;u&&r.set(u,R.UV3Kind);var f=e.uv4s;f&&r.set(f,R.UV4Kind);var h=e.uv5s;h&&r.set(h,R.UV5Kind);var c=e.uv6s;c&&r.set(c,R.UV6Kind);var d=e.colors;d&&r.set(ce.CheckColors4(d,n.length/3),R.ColorKind);var p=e.matricesIndices;p&&r.set(p,R.MatricesIndicesKind);var _=e.matricesWeights;_&&r.set(_,R.MatricesWeightsKind);var g=e.indices;g&&(r.indices=g),t.setAllVerticesData(r,e.updatable)},i.FRONTSIDE=0,i.BACKSIDE=1,i.DOUBLESIDE=2,i.DEFAULTSIDE=0,C([Zt.filter(function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];var r=e[0];return!Array.isArray(r)})],i,"_TransformVector3Coordinates",null),C([Zt.filter(function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];var r=e[0];return!Array.isArray(r)})],i,"_TransformVector3Normals",null),C([Zt.filter(function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];var r=e[0];return!Array.isArray(r)})],i,"_TransformVector4Normals",null),C([Zt.filter(function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];var r=e[0];return!Array.isArray(r)})],i,"_FlipFaces",null),i}(),Mt=function(){function i(){}return Object.defineProperty(i,"ForceFullSceneLoadingForIncremental",{get:function(){return i._ForceFullSceneLoadingForIncremental},set:function(e){i._ForceFullSceneLoadingForIncremental=e},enumerable:!1,configurable:!0}),Object.defineProperty(i,"ShowLoadingScreen",{get:function(){return i._ShowLoadingScreen},set:function(e){i._ShowLoadingScreen=e},enumerable:!1,configurable:!0}),Object.defineProperty(i,"loggingLevel",{get:function(){return i._LoggingLevel},set:function(e){i._LoggingLevel=e},enumerable:!1,configurable:!0}),Object.defineProperty(i,"CleanBoneMatrixWeights",{get:function(){return i._CleanBoneMatrixWeights},set:function(e){i._CleanBoneMatrixWeights=e},enumerable:!1,configurable:!0}),i._ForceFullSceneLoadingForIncremental=!1,i._ShowLoadingScreen=!0,i._CleanBoneMatrixWeights=!1,i._LoggingLevel=0,i}(),zt=function(){function i(e,t,r,n,a){n===void 0&&(n=!1),a===void 0&&(a=null),this.delayLoadState=0,this._totalVertices=0,this._isDisposed=!1,this._indexBufferIsUpdatable=!1,this._positionsCache=[],this._parentContainer=null,this.useBoundingInfoFromGeometry=!1,this._scene=t||ye.LastCreatedScene,this._scene&&(this.id=e,this.uniqueId=this._scene.getUniqueId(),this._engine=this._scene.getEngine(),this._meshes=[],this._vertexBuffers={},this._indices=[],this._updatable=n,r?this.setAllVerticesData(r,n):(this._totalVertices=0,this._indices=[]),this._engine.getCaps().vertexArrayObject&&(this._vertexArrayObjects={}),a&&(this.applyToMesh(a),a.computeWorldMatrix(!0)))}return Object.defineProperty(i.prototype,"boundingBias",{get:function(){return this._boundingBias},set:function(e){this._boundingBias?this._boundingBias.copyFrom(e):this._boundingBias=e.clone(),this._updateBoundingInfo(!0,null)},enumerable:!1,configurable:!0}),i.CreateGeometryForMesh=function(e){var t=new i(i.RandomId(),e.getScene());return t.applyToMesh(e),t},Object.defineProperty(i.prototype,"meshes",{get:function(){return this._meshes},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"extend",{get:function(){return this._extend},enumerable:!1,configurable:!0}),i.prototype.getScene=function(){return this._scene},i.prototype.getEngine=function(){return this._engine},i.prototype.isReady=function(){return this.delayLoadState===1||this.delayLoadState===0},Object.defineProperty(i.prototype,"doNotSerialize",{get:function(){for(var e=0;e<this._meshes.length;e++)if(!this._meshes[e].doNotSerialize)return!1;return!0},enumerable:!1,configurable:!0}),i.prototype._rebuild=function(){this._vertexArrayObjects&&(this._vertexArrayObjects={}),this._meshes.length!==0&&this._indices&&(this._indexBuffer=this._engine.createIndexBuffer(this._indices,this._updatable));for(var e in this._vertexBuffers){var t=this._vertexBuffers[e];t._rebuild()}},i.prototype.setAllVerticesData=function(e,t){e.applyToGeometry(this,t),this._notifyUpdate()},i.prototype.setVerticesData=function(e,t,r,n){r===void 0&&(r=!1),r&&Array.isArray(t)&&(t=new Float32Array(t));var a=new R(this._engine,t,e,r,this._meshes.length===0,n);this.setVerticesBuffer(a)},i.prototype.removeVerticesData=function(e){this._vertexBuffers[e]&&(this._vertexBuffers[e].dispose(),delete this._vertexBuffers[e]),this._vertexArrayObjects&&this._disposeVertexArrayObjects()},i.prototype.setVerticesBuffer=function(e,t,r){t===void 0&&(t=null),r===void 0&&(r=!0);var n=e.getKind();this._vertexBuffers[n]&&r&&this._vertexBuffers[n].dispose(),e._buffer&&e._buffer._increaseReferences(),this._vertexBuffers[n]=e;var a=this._meshes,s=a.length;if(n===R.PositionKind){var o=e.getData();t!=null?this._totalVertices=t:o!=null&&(this._totalVertices=o.length/(e.type===R.BYTE?e.byteStride:e.byteStride/4)),this._updateExtend(o),this._resetPointsArrayCache();for(var l=0;l<s;l++){var u=a[l];u.buildBoundingInfo(this._extend.minimum,this._extend.maximum),u._createGlobalSubMesh(!1),u.computeWorldMatrix(!0),u.synchronizeInstances()}}this._notifyUpdate(n)},i.prototype.updateVerticesDataDirectly=function(e,t,r,n){n===void 0&&(n=!1);var a=this.getVertexBuffer(e);!a||(a.updateDirectly(t,r,n),this._notifyUpdate(e))},i.prototype.updateVerticesData=function(e,t,r){r===void 0&&(r=!1);var n=this.getVertexBuffer(e);!n||(n.update(t),e===R.PositionKind&&this._updateBoundingInfo(r,t),this._notifyUpdate(e))},i.prototype._updateBoundingInfo=function(e,t){if(e&&this._updateExtend(t),this._resetPointsArrayCache(),e)for(var r=this._meshes,n=0,a=r;n<a.length;n++){var s=a[n];s.hasBoundingInfo?s.getBoundingInfo().reConstruct(this._extend.minimum,this._extend.maximum):s.buildBoundingInfo(this._extend.minimum,this._extend.maximum);for(var o=s.subMeshes,l=0,u=o;l<u.length;l++){var f=u[l];f.refreshBoundingInfo()}}},i.prototype._bind=function(e,t,r,n){if(!!e){t===void 0&&(t=this._indexBuffer);var a=this.getVertexBuffers();if(!!a){if(t!=this._indexBuffer||!this._vertexArrayObjects&&!n){this._engine.bindBuffers(a,t,e,r);return}var s=n||this._vertexArrayObjects;s[e.key]||(s[e.key]=this._engine.recordVertexArrayObject(a,t,e,r)),this._engine.bindVertexArrayObject(s[e.key],t)}}},i.prototype.getTotalVertices=function(){return this.isReady()?this._totalVertices:0},i.prototype.getVerticesData=function(e,t,r){var n=this.getVertexBuffer(e);return n?n.getFloatData(this._totalVertices,r||t&&this._meshes.length!==1):null},i.prototype.isVertexBufferUpdatable=function(e){var t=this._vertexBuffers[e];return t?t.isUpdatable():!1},i.prototype.getVertexBuffer=function(e){return this.isReady()?this._vertexBuffers[e]:null},i.prototype.getVertexBuffers=function(){return this.isReady()?this._vertexBuffers:null},i.prototype.isVerticesDataPresent=function(e){return this._vertexBuffers?this._vertexBuffers[e]!==void 0:this._delayInfo?this._delayInfo.indexOf(e)!==-1:!1},i.prototype.getVerticesDataKinds=function(){var e=[],t;if(!this._vertexBuffers&&this._delayInfo)for(t in this._delayInfo)e.push(t);else for(t in this._vertexBuffers)e.push(t);return e},i.prototype.updateIndices=function(e,t,r){if(r===void 0&&(r=!1),!!this._indexBuffer)if(!this._indexBufferIsUpdatable)this.setIndices(e,null,!0);else{var n=e.length!==this._indices.length;if(r||(this._indices=e.slice()),this._engine.updateDynamicIndexBuffer(this._indexBuffer,e,t),n)for(var a=0,s=this._meshes;a<s.length;a++){var o=s[a];o._createGlobalSubMesh(!0)}}},i.prototype.setIndices=function(e,t,r){t===void 0&&(t=null),r===void 0&&(r=!1),this._indexBuffer&&this._engine._releaseBuffer(this._indexBuffer),this._indices=e,this._indexBufferIsUpdatable=r,this._meshes.length!==0&&this._indices&&(this._indexBuffer=this._engine.createIndexBuffer(this._indices,r)),t!=null&&(this._totalVertices=t);for(var n=0,a=this._meshes;n<a.length;n++){var s=a[n];s._createGlobalSubMesh(!0),s.synchronizeInstances()}this._notifyUpdate()},i.prototype.getTotalIndices=function(){return this.isReady()?this._indices.length:0},i.prototype.getIndices=function(e,t){if(!this.isReady())return null;var r=this._indices;return!t&&(!e||this._meshes.length===1)?r:te.Slice(r)},i.prototype.getIndexBuffer=function(){return this.isReady()?this._indexBuffer:null},i.prototype._releaseVertexArrayObject=function(e){e===void 0&&(e=null),!(!e||!this._vertexArrayObjects)&&this._vertexArrayObjects[e.key]&&(this._engine.releaseVertexArrayObject(this._vertexArrayObjects[e.key]),delete this._vertexArrayObjects[e.key])},i.prototype.releaseForMesh=function(e,t){var r=this._meshes,n=r.indexOf(e);n!==-1&&(r.splice(n,1),this._vertexArrayObjects&&e._invalidateInstanceVertexArrayObject(),e._geometry=null,r.length===0&&t&&this.dispose())},i.prototype.applyToMesh=function(e){if(e._geometry!==this){var t=e._geometry;t&&t.releaseForMesh(e),this._vertexArrayObjects&&e._invalidateInstanceVertexArrayObject();var r=this._meshes;e._geometry=this,e._internalAbstractMeshDataInfo._positions=null,this._scene.pushGeometry(this),r.push(e),this.isReady()?this._applyToMesh(e):this._boundingInfo&&e.setBoundingInfo(this._boundingInfo)}},i.prototype._updateExtend=function(e){if(e===void 0&&(e=null),this.useBoundingInfoFromGeometry&&this._boundingInfo)this._extend={minimum:this._boundingInfo.minimum.clone(),maximum:this._boundingInfo.maximum.clone()};else{if(!e&&(e=this.getVerticesData(R.PositionKind),!e))return;this._extend=Ha(e,0,this._totalVertices,this.boundingBias,3)}},i.prototype._applyToMesh=function(e){var t=this._meshes.length;for(var r in this._vertexBuffers)t===1&&this._vertexBuffers[r].create(),r===R.PositionKind&&(this._extend||this._updateExtend(),e.buildBoundingInfo(this._extend.minimum,this._extend.maximum),e._createGlobalSubMesh(!1),e._updateBoundingInfo());t===1&&this._indices&&this._indices.length>0&&(this._indexBuffer=this._engine.createIndexBuffer(this._indices,this._updatable)),e._syncGeometryWithMorphTargetManager(),e.synchronizeInstances()},i.prototype._notifyUpdate=function(e){this.onGeometryUpdated&&this.onGeometryUpdated(this,e),this._vertexArrayObjects&&this._disposeVertexArrayObjects();for(var t=0,r=this._meshes;t<r.length;t++){var n=r[t];n._markSubMeshesAsAttributesDirty()}},i.prototype.load=function(e,t){if(this.delayLoadState!==2){if(this.isReady()){t&&t();return}this.delayLoadState=2,this._queueLoad(e,t)}},i.prototype._queueLoad=function(e,t){var r=this;!this.delayLoadingFile||(e._addPendingData(this),e._loadFile(this.delayLoadingFile,function(n){if(!!r._delayLoadingFunction){r._delayLoadingFunction(JSON.parse(n),r),r.delayLoadState=1,r._delayInfo=[],e._removePendingData(r);for(var a=r._meshes,s=a.length,o=0;o<s;o++)r._applyToMesh(a[o]);t&&t()}},void 0,!0))},i.prototype.toLeftHanded=function(){var e=this.getIndices(!1);if(e!=null&&e.length>0){for(var t=0;t<e.length;t+=3){var r=e[t+0];e[t+0]=e[t+2],e[t+2]=r}this.setIndices(e)}var n=this.getVerticesData(R.PositionKind,!1);if(n!=null&&n.length>0){for(var t=0;t<n.length;t+=3)n[t+2]=-n[t+2];this.setVerticesData(R.PositionKind,n,!1)}var a=this.getVerticesData(R.NormalKind,!1);if(a!=null&&a.length>0){for(var t=0;t<a.length;t+=3)a[t+2]=-a[t+2];this.setVerticesData(R.NormalKind,a,!1)}},i.prototype._resetPointsArrayCache=function(){this._positions=null},i.prototype._generatePointsArray=function(){if(this._positions)return!0;var e=this.getVerticesData(R.PositionKind);if(!e||e.length===0)return!1;for(var t=this._positionsCache.length*3,r=this._positionsCache.length;t<e.length;t+=3,++r)this._positionsCache[r]=m.FromArray(e,t);for(var t=0,r=0;t<e.length;t+=3,++r)this._positionsCache[r].set(e[0+t],e[1+t],e[2+t]);return this._positionsCache.length=e.length/3,this._positions=this._positionsCache,!0},i.prototype.isDisposed=function(){return this._isDisposed},i.prototype._disposeVertexArrayObjects=function(){if(this._vertexArrayObjects){for(var e in this._vertexArrayObjects)this._engine.releaseVertexArrayObject(this._vertexArrayObjects[e]);this._vertexArrayObjects={};for(var t=this._meshes,r=t.length,n=0;n<r;n++)t[n]._invalidateInstanceVertexArrayObject()}},i.prototype.dispose=function(){var e=this._meshes,t=e.length,r;for(r=0;r<t;r++)this.releaseForMesh(e[r]);this._meshes=[],this._disposeVertexArrayObjects();for(var n in this._vertexBuffers)this._vertexBuffers[n].dispose();if(this._vertexBuffers={},this._totalVertices=0,this._indexBuffer&&this._engine._releaseBuffer(this._indexBuffer),this._indexBuffer=null,this._indices=[],this.delayLoadState=0,this.delayLoadingFile=null,this._delayLoadingFunction=null,this._delayInfo=[],this._boundingInfo=null,this._scene.removeGeometry(this),this._parentContainer){var a=this._parentContainer.geometries.indexOf(this);a>-1&&this._parentContainer.geometries.splice(a,1),this._parentContainer=null}this._isDisposed=!0},i.prototype.copy=function(e){var t=new J;t.indices=[];var r=this.getIndices();if(r)for(var n=0;n<r.length;n++)t.indices.push(r[n]);var a=!1,s=!1,o;for(o in this._vertexBuffers){var l=this.getVerticesData(o);if(l&&(l instanceof Float32Array?t.set(new Float32Array(l),o):t.set(l.slice(0),o),!s)){var u=this.getVertexBuffer(o);u&&(a=u.isUpdatable(),s=!a)}}var f=new i(e,this._scene,t,a);f.delayLoadState=this.delayLoadState,f.delayLoadingFile=this.delayLoadingFile,f._delayLoadingFunction=this._delayLoadingFunction;for(o in this._delayInfo)f._delayInfo=f._delayInfo||[],f._delayInfo.push(o);return f._boundingInfo=new lr(this._extend.minimum,this._extend.maximum),f},i.prototype.serialize=function(){var e={};return e.id=this.id,e.uniqueId=this.uniqueId,e.updatable=this._updatable,Le&&Le.HasTags(this)&&(e.tags=Le.GetTags(this)),e},i.prototype._toNumberArray=function(e){return Array.isArray(e)?e:Array.prototype.slice.call(e)},i.prototype.clearCachedData=function(){this._indices=[],this._resetPointsArrayCache();for(var e in this._vertexBuffers)!Object.prototype.hasOwnProperty.call(this._vertexBuffers,e)||(this._vertexBuffers[e]._buffer._data=null)},i.prototype.serializeVerticeData=function(){var e=this.serialize();return this.isVerticesDataPresent(R.PositionKind)&&(e.positions=this._toNumberArray(this.getVerticesData(R.PositionKind)),this.isVertexBufferUpdatable(R.PositionKind)&&(e.positions._updatable=!0)),this.isVerticesDataPresent(R.NormalKind)&&(e.normals=this._toNumberArray(this.getVerticesData(R.NormalKind)),this.isVertexBufferUpdatable(R.NormalKind)&&(e.normals._updatable=!0)),this.isVerticesDataPresent(R.TangentKind)&&(e.tangents=this._toNumberArray(this.getVerticesData(R.TangentKind)),this.isVertexBufferUpdatable(R.TangentKind)&&(e.tangents._updatable=!0)),this.isVerticesDataPresent(R.UVKind)&&(e.uvs=this._toNumberArray(this.getVerticesData(R.UVKind)),this.isVertexBufferUpdatable(R.UVKind)&&(e.uvs._updatable=!0)),this.isVerticesDataPresent(R.UV2Kind)&&(e.uv2s=this._toNumberArray(this.getVerticesData(R.UV2Kind)),this.isVertexBufferUpdatable(R.UV2Kind)&&(e.uv2s._updatable=!0)),this.isVerticesDataPresent(R.UV3Kind)&&(e.uv3s=this._toNumberArray(this.getVerticesData(R.UV3Kind)),this.isVertexBufferUpdatable(R.UV3Kind)&&(e.uv3s._updatable=!0)),this.isVerticesDataPresent(R.UV4Kind)&&(e.uv4s=this._toNumberArray(this.getVerticesData(R.UV4Kind)),this.isVertexBufferUpdatable(R.UV4Kind)&&(e.uv4s._updatable=!0)),this.isVerticesDataPresent(R.UV5Kind)&&(e.uv5s=this._toNumberArray(this.getVerticesData(R.UV5Kind)),this.isVertexBufferUpdatable(R.UV5Kind)&&(e.uv5s._updatable=!0)),this.isVerticesDataPresent(R.UV6Kind)&&(e.uv6s=this._toNumberArray(this.getVerticesData(R.UV6Kind)),this.isVertexBufferUpdatable(R.UV6Kind)&&(e.uv6s._updatable=!0)),this.isVerticesDataPresent(R.ColorKind)&&(e.colors=this._toNumberArray(this.getVerticesData(R.ColorKind)),this.isVertexBufferUpdatable(R.ColorKind)&&(e.colors._updatable=!0)),this.isVerticesDataPresent(R.MatricesIndicesKind)&&(e.matricesIndices=this._toNumberArray(this.getVerticesData(R.MatricesIndicesKind)),e.matricesIndices._isExpanded=!0,this.isVertexBufferUpdatable(R.MatricesIndicesKind)&&(e.matricesIndices._updatable=!0)),this.isVerticesDataPresent(R.MatricesWeightsKind)&&(e.matricesWeights=this._toNumberArray(this.getVerticesData(R.MatricesWeightsKind)),this.isVertexBufferUpdatable(R.MatricesWeightsKind)&&(e.matricesWeights._updatable=!0)),e.indices=this._toNumberArray(this.getIndices()),e},i.ExtractFromMesh=function(e,t){var r=e._geometry;return r?r.copy(t):null},i.RandomId=function(){return te.RandomId()},i._GetGeometryByLoadedUniqueId=function(e,t){for(var r=0;r<t.geometries.length;r++)if(t.geometries[r]._loadedUniqueId===e)return t.geometries[r];return null},i._ImportGeometry=function(e,t){var r=t.getScene(),n=e.geometryUniqueId,a=e.geometryId;if(n||a){var s=n?this._GetGeometryByLoadedUniqueId(n,r):r.getGeometryById(a);s&&s.applyToMesh(t)}else if(e instanceof ArrayBuffer){var o=t._binaryInfo;if(o.positionsAttrDesc&&o.positionsAttrDesc.count>0){var l=new Float32Array(e,o.positionsAttrDesc.offset,o.positionsAttrDesc.count);t.setVerticesData(R.PositionKind,l,!1)}if(o.normalsAttrDesc&&o.normalsAttrDesc.count>0){var u=new Float32Array(e,o.normalsAttrDesc.offset,o.normalsAttrDesc.count);t.setVerticesData(R.NormalKind,u,!1)}if(o.tangetsAttrDesc&&o.tangetsAttrDesc.count>0){var f=new Float32Array(e,o.tangetsAttrDesc.offset,o.tangetsAttrDesc.count);t.setVerticesData(R.TangentKind,f,!1)}if(o.uvsAttrDesc&&o.uvsAttrDesc.count>0){var h=new Float32Array(e,o.uvsAttrDesc.offset,o.uvsAttrDesc.count);if(Se.UseOpenGLOrientationForUV)for(var c=1;c<h.length;c+=2)h[c]=1-h[c];t.setVerticesData(R.UVKind,h,!1)}if(o.uvs2AttrDesc&&o.uvs2AttrDesc.count>0){var d=new Float32Array(e,o.uvs2AttrDesc.offset,o.uvs2AttrDesc.count);if(Se.UseOpenGLOrientationForUV)for(var c=1;c<d.length;c+=2)d[c]=1-d[c];t.setVerticesData(R.UV2Kind,d,!1)}if(o.uvs3AttrDesc&&o.uvs3AttrDesc.count>0){var p=new Float32Array(e,o.uvs3AttrDesc.offset,o.uvs3AttrDesc.count);if(Se.UseOpenGLOrientationForUV)for(var c=1;c<p.length;c+=2)p[c]=1-p[c];t.setVerticesData(R.UV3Kind,p,!1)}if(o.uvs4AttrDesc&&o.uvs4AttrDesc.count>0){var _=new Float32Array(e,o.uvs4AttrDesc.offset,o.uvs4AttrDesc.count);if(Se.UseOpenGLOrientationForUV)for(var c=1;c<_.length;c+=2)_[c]=1-_[c];t.setVerticesData(R.UV4Kind,_,!1)}if(o.uvs5AttrDesc&&o.uvs5AttrDesc.count>0){var g=new Float32Array(e,o.uvs5AttrDesc.offset,o.uvs5AttrDesc.count);if(Se.UseOpenGLOrientationForUV)for(var c=1;c<g.length;c+=2)g[c]=1-g[c];t.setVerticesData(R.UV5Kind,g,!1)}if(o.uvs6AttrDesc&&o.uvs6AttrDesc.count>0){var v=new Float32Array(e,o.uvs6AttrDesc.offset,o.uvs6AttrDesc.count);if(Se.UseOpenGLOrientationForUV)for(var c=1;c<v.length;c+=2)v[c]=1-v[c];t.setVerticesData(R.UV6Kind,v,!1)}if(o.colorsAttrDesc&&o.colorsAttrDesc.count>0){var y=new Float32Array(e,o.colorsAttrDesc.offset,o.colorsAttrDesc.count);t.setVerticesData(R.ColorKind,y,!1,o.colorsAttrDesc.stride)}if(o.matricesIndicesAttrDesc&&o.matricesIndicesAttrDesc.count>0){for(var b=new Int32Array(e,o.matricesIndicesAttrDesc.offset,o.matricesIndicesAttrDesc.count),E=[],A=0;A<b.length;A++){var c=b[A];E.push(c&255),E.push((c&65280)>>8),E.push((c&16711680)>>16),E.push(c>>24&255)}t.setVerticesData(R.MatricesIndicesKind,E,!1)}if(o.matricesIndicesExtraAttrDesc&&o.matricesIndicesExtraAttrDesc.count>0){for(var b=new Int32Array(e,o.matricesIndicesExtraAttrDesc.offset,o.matricesIndicesExtraAttrDesc.count),E=[],A=0;A<b.length;A++){var c=b[A];E.push(c&255),E.push((c&65280)>>8),E.push((c&16711680)>>16),E.push(c>>24&255)}t.setVerticesData(R.MatricesIndicesExtraKind,E,!1)}if(o.matricesWeightsAttrDesc&&o.matricesWeightsAttrDesc.count>0){var S=new Float32Array(e,o.matricesWeightsAttrDesc.offset,o.matricesWeightsAttrDesc.count);t.setVerticesData(R.MatricesWeightsKind,S,!1)}if(o.indicesAttrDesc&&o.indicesAttrDesc.count>0){var T=new Int32Array(e,o.indicesAttrDesc.offset,o.indicesAttrDesc.count);t.setIndices(T,null)}if(o.subMeshesAttrDesc&&o.subMeshesAttrDesc.count>0){var M=new Int32Array(e,o.subMeshesAttrDesc.offset,o.subMeshesAttrDesc.count*5);t.subMeshes=[];for(var A=0;A<o.subMeshesAttrDesc.count;A++){var D=M[A*5+0],x=M[A*5+1],P=M[A*5+2],w=M[A*5+3],k=M[A*5+4];qt.AddToMesh(D,x,P,w,k,t)}}}else if(e.positions&&e.normals&&e.indices){if(t.setVerticesData(R.PositionKind,e.positions,e.positions._updatable),t.setVerticesData(R.NormalKind,e.normals,e.normals._updatable),e.tangents&&t.setVerticesData(R.TangentKind,e.tangents,e.tangents._updatable),e.uvs&&t.setVerticesData(R.UVKind,e.uvs,e.uvs._updatable),e.uvs2&&t.setVerticesData(R.UV2Kind,e.uvs2,e.uvs2._updatable),e.uvs3&&t.setVerticesData(R.UV3Kind,e.uvs3,e.uvs3._updatable),e.uvs4&&t.setVerticesData(R.UV4Kind,e.uvs4,e.uvs4._updatable),e.uvs5&&t.setVerticesData(R.UV5Kind,e.uvs5,e.uvs5._updatable),e.uvs6&&t.setVerticesData(R.UV6Kind,e.uvs6,e.uvs6._updatable),e.colors&&t.setVerticesData(R.ColorKind,ce.CheckColors4(e.colors,e.positions.length/3),e.colors._updatable),e.matricesIndices)if(e.matricesIndices._isExpanded)delete e.matricesIndices._isExpanded,t.setVerticesData(R.MatricesIndicesKind,e.matricesIndices,e.matricesIndices._updatable);else{for(var E=[],A=0;A<e.matricesIndices.length;A++){var B=e.matricesIndices[A];E.push(B&255),E.push((B&65280)>>8),E.push((B&16711680)>>16),E.push(B>>24&255)}t.setVerticesData(R.MatricesIndicesKind,E,e.matricesIndices._updatable)}if(e.matricesIndicesExtra)if(e.matricesIndicesExtra._isExpanded)delete e.matricesIndices._isExpanded,t.setVerticesData(R.MatricesIndicesExtraKind,e.matricesIndicesExtra,e.matricesIndicesExtra._updatable);else{for(var E=[],A=0;A<e.matricesIndicesExtra.length;A++){var B=e.matricesIndicesExtra[A];E.push(B&255),E.push((B&65280)>>8),E.push((B&16711680)>>16),E.push(B>>24&255)}t.setVerticesData(R.MatricesIndicesExtraKind,E,e.matricesIndicesExtra._updatable)}e.matricesWeights&&(i._CleanMatricesWeights(e,t),t.setVerticesData(R.MatricesWeightsKind,e.matricesWeights,e.matricesWeights._updatable)),e.matricesWeightsExtra&&t.setVerticesData(R.MatricesWeightsExtraKind,e.matricesWeightsExtra,e.matricesWeights._updatable),t.setIndices(e.indices,null)}if(e.subMeshes){t.subMeshes=[];for(var L=0;L<e.subMeshes.length;L++){var H=e.subMeshes[L];qt.AddToMesh(H.materialIndex,H.verticesStart,H.verticesCount,H.indexStart,H.indexCount,t)}}t._shouldGenerateFlatShading&&(t.convertToFlatShadedMesh(),t._shouldGenerateFlatShading=!1),t.computeWorldMatrix(!0),r.onMeshImportedObservable.notifyObservers(t)},i._CleanMatricesWeights=function(e,t){var r=.001;if(!!Mt.CleanBoneMatrixWeights){var n=0;if(e.skeletonId>-1){var a=t.getScene().getLastSkeletonById(e.skeletonId);if(!a)return;n=a.bones.length}else return;for(var s=t.getVerticesData(R.MatricesIndicesKind),o=t.getVerticesData(R.MatricesIndicesExtraKind),l=e.matricesWeights,u=e.matricesWeightsExtra,f=e.numBoneInfluencer,h=l.length,c=0;c<h;c+=4){for(var d=0,p=-1,_=0;_<4;_++){var g=l[c+_];d+=g,g<r&&p<0&&(p=_)}if(u)for(var _=0;_<4;_++){var g=u[c+_];d+=g,g<r&&p<0&&(p=_+4)}if((p<0||p>f-1)&&(p=f-1),d>r){for(var v=1/d,_=0;_<4;_++)l[c+_]*=v;if(u)for(var _=0;_<4;_++)u[c+_]*=v}else p>=4?(u[c+p-4]=1-d,o[c+p-4]=n):(l[c+p]=1-d,s[c+p]=n)}t.setVerticesData(R.MatricesIndicesKind,s),e.matricesWeightsExtra&&t.setVerticesData(R.MatricesIndicesExtraKind,o)}},i.Parse=function(e,t,r){var n=new i(e.id,t,void 0,e.updatable);return n._loadedUniqueId=e.uniqueId,Le&&Le.AddTagsTo(n,e.tags),e.delayLoadingFile?(n.delayLoadState=4,n.delayLoadingFile=r+e.delayLoadingFile,n._boundingInfo=new lr(m.FromArray(e.boundingBoxMinimum),m.FromArray(e.boundingBoxMaximum)),n._delayInfo=[],e.hasUVs&&n._delayInfo.push(R.UVKind),e.hasUVs2&&n._delayInfo.push(R.UV2Kind),e.hasUVs3&&n._delayInfo.push(R.UV3Kind),e.hasUVs4&&n._delayInfo.push(R.UV4Kind),e.hasUVs5&&n._delayInfo.push(R.UV5Kind),e.hasUVs6&&n._delayInfo.push(R.UV6Kind),e.hasColors&&n._delayInfo.push(R.ColorKind),e.hasMatricesIndices&&n._delayInfo.push(R.MatricesIndicesKind),e.hasMatricesWeights&&n._delayInfo.push(R.MatricesWeightsKind),n._delayLoadingFunction=J.ImportVertexData):J.ImportVertexData(e,n),t.pushGeometry(n,!0),n},i}(),vl=function(){function i(e){e===void 0&&(e=30),this._enabled=!0,this._rollingFrameTime=new gl(e)}return i.prototype.sampleFrame=function(e){if(e===void 0&&(e=nt.Now),!!this._enabled){if(this._lastFrameTimeMs!=null){var t=e-this._lastFrameTimeMs;this._rollingFrameTime.add(t)}this._lastFrameTimeMs=e}},Object.defineProperty(i.prototype,"averageFrameTime",{get:function(){return this._rollingFrameTime.average},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"averageFrameTimeVariance",{get:function(){return this._rollingFrameTime.variance},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"instantaneousFrameTime",{get:function(){return this._rollingFrameTime.history(0)},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"averageFPS",{get:function(){return 1e3/this._rollingFrameTime.average},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"instantaneousFPS",{get:function(){var e=this._rollingFrameTime.history(0);return e===0?0:1e3/e},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"isSaturated",{get:function(){return this._rollingFrameTime.isSaturated()},enumerable:!1,configurable:!0}),i.prototype.enable=function(){this._enabled=!0},i.prototype.disable=function(){this._enabled=!1,this._lastFrameTimeMs=null},Object.defineProperty(i.prototype,"isEnabled",{get:function(){return this._enabled},enumerable:!1,configurable:!0}),i.prototype.reset=function(){this._lastFrameTimeMs=null,this._rollingFrameTime.reset()},i}(),gl=function(){function i(e){this._samples=new Array(e),this.reset()}return i.prototype.add=function(e){var t;if(this.isSaturated()){var r=this._samples[this._pos];t=r-this.average,this.average-=t/(this._sampleCount-1),this._m2-=t*(r-this.average)}else this._sampleCount++;t=e-this.average,this.average+=t/this._sampleCount,this._m2+=t*(e-this.average),this.variance=this._m2/(this._sampleCount-1),this._samples[this._pos]=e,this._pos++,this._pos%=this._samples.length},i.prototype.history=function(e){if(e>=this._sampleCount||e>=this._samples.length)return 0;var t=this._wrapPosition(this._pos-1);return this._samples[this._wrapPosition(t-e)]},i.prototype.isSaturated=function(){return this._sampleCount>=this._samples.length},i.prototype.reset=function(){this.average=0,this.variance=0,this._sampleCount=0,this._pos=0,this._m2=0},i.prototype._wrapPosition=function(e){var t=this._samples.length;return(e%t+t)%t},i}();ge.prototype.setAlphaConstants=function(i,e,t,r){this._alphaState.setAlphaBlendConstants(i,e,t,r)};ge.prototype.setAlphaMode=function(i,e){if(e===void 0&&(e=!1),this._alphaMode!==i){switch(i){case 0:this._alphaState.alphaBlend=!1;break;case 7:this._alphaState.setAlphaBlendFunctionParameters(this._gl.ONE,this._gl.ONE_MINUS_SRC_ALPHA,this._gl.ONE,this._gl.ONE),this._alphaState.alphaBlend=!0;break;case 8:this._alphaState.setAlphaBlendFunctionParameters(this._gl.ONE,this._gl.ONE_MINUS_SRC_ALPHA,this._gl.ONE,this._gl.ONE_MINUS_SRC_ALPHA),this._alphaState.alphaBlend=!0;break;case 2:this._alphaState.setAlphaBlendFunctionParameters(this._gl.SRC_ALPHA,this._gl.ONE_MINUS_SRC_ALPHA,this._gl.ONE,this._gl.ONE),this._alphaState.alphaBlend=!0;break;case 6:this._alphaState.setAlphaBlendFunctionParameters(this._gl.ONE,this._gl.ONE,this._gl.ZERO,this._gl.ONE),this._alphaState.alphaBlend=!0;break;case 1:this._alphaState.setAlphaBlendFunctionParameters(this._gl.SRC_ALPHA,this._gl.ONE,this._gl.ZERO,this._gl.ONE),this._alphaState.alphaBlend=!0;break;case 3:this._alphaState.setAlphaBlendFunctionParameters(this._gl.ZERO,this._gl.ONE_MINUS_SRC_COLOR,this._gl.ONE,this._gl.ONE),this._alphaState.alphaBlend=!0;break;case 4:this._alphaState.setAlphaBlendFunctionParameters(this._gl.DST_COLOR,this._gl.ZERO,this._gl.ONE,this._gl.ONE),this._alphaState.alphaBlend=!0;break;case 5:this._alphaState.setAlphaBlendFunctionParameters(this._gl.SRC_ALPHA,this._gl.ONE_MINUS_SRC_COLOR,this._gl.ONE,this._gl.ONE),this._alphaState.alphaBlend=!0;break;case 9:this._alphaState.setAlphaBlendFunctionParameters(this._gl.CONSTANT_COLOR,this._gl.ONE_MINUS_CONSTANT_COLOR,this._gl.CONSTANT_ALPHA,this._gl.ONE_MINUS_CONSTANT_ALPHA),this._alphaState.alphaBlend=!0;break;case 10:this._alphaState.setAlphaBlendFunctionParameters(this._gl.ONE,this._gl.ONE_MINUS_SRC_COLOR,this._gl.ONE,this._gl.ONE_MINUS_SRC_ALPHA),this._alphaState.alphaBlend=!0;break;case 11:this._alphaState.setAlphaBlendFunctionParameters(this._gl.ONE,this._gl.ONE,this._gl.ONE,this._gl.ONE),this._alphaState.alphaBlend=!0;break;case 12:this._alphaState.setAlphaBlendFunctionParameters(this._gl.DST_ALPHA,this._gl.ONE,this._gl.ZERO,this._gl.ZERO),this._alphaState.alphaBlend=!0;break;case 13:this._alphaState.setAlphaBlendFunctionParameters(this._gl.ONE_MINUS_DST_COLOR,this._gl.ONE_MINUS_SRC_COLOR,this._gl.ONE_MINUS_DST_ALPHA,this._gl.ONE_MINUS_SRC_ALPHA),this._alphaState.alphaBlend=!0;break;case 14:this._alphaState.setAlphaBlendFunctionParameters(this._gl.ONE,this._gl.ONE_MINUS_SRC_ALPHA,this._gl.ONE,this._gl.ONE_MINUS_SRC_ALPHA),this._alphaState.alphaBlend=!0;break;case 15:this._alphaState.setAlphaBlendFunctionParameters(this._gl.ONE,this._gl.ONE,this._gl.ONE,this._gl.ZERO),this._alphaState.alphaBlend=!0;break;case 16:this._alphaState.setAlphaBlendFunctionParameters(this._gl.ONE_MINUS_DST_COLOR,this._gl.ONE_MINUS_SRC_COLOR,this._gl.ZERO,this._gl.ONE),this._alphaState.alphaBlend=!0;break;case 17:this._alphaState.setAlphaBlendFunctionParameters(this._gl.SRC_ALPHA,this._gl.ONE_MINUS_SRC_ALPHA,this._gl.ONE,this._gl.ONE_MINUS_SRC_ALPHA),this._alphaState.alphaBlend=!0;break}e||(this.depthCullingState.depthMask=i===0),this._alphaMode=i}};ge.prototype.getAlphaMode=function(){return this._alphaMode};ge.prototype.setAlphaEquation=function(i){if(this._alphaEquation!==i){switch(i){case 0:this._alphaState.setAlphaEquationParameters(32774,32774);break;case 1:this._alphaState.setAlphaEquationParameters(32778,32778);break;case 2:this._alphaState.setAlphaEquationParameters(32779,32779);break;case 3:this._alphaState.setAlphaEquationParameters(32776,32776);break;case 4:this._alphaState.setAlphaEquationParameters(32775,32775);break;case 5:this._alphaState.setAlphaEquationParameters(32775,32774);break}this._alphaEquation=i}};ge.prototype.getAlphaEquation=function(){return this._alphaEquation};function ml(i,e,t,r){switch(t===void 0&&(t=!1),i){case 3:{var n=e instanceof ArrayBuffer?new Int8Array(e):new Int8Array(e);return r&&n.set(new Int8Array(r)),n}case 0:{var a=e instanceof ArrayBuffer?new Uint8Array(e):new Uint8Array(e);return r&&a.set(new Uint8Array(r)),a}case 4:{var s=e instanceof ArrayBuffer?new Int16Array(e):new Int16Array(t?e/2:e);return r&&s.set(new Int16Array(r)),s}case 5:case 8:case 9:case 10:case 2:{var o=e instanceof ArrayBuffer?new Uint16Array(e):new Uint16Array(t?e/2:e);return r&&o.set(new Uint16Array(r)),o}case 6:{var l=e instanceof ArrayBuffer?new Int32Array(e):new Int32Array(t?e/4:e);return r&&l.set(new Int32Array(r)),l}case 7:case 11:case 12:case 13:case 14:case 15:{var u=e instanceof ArrayBuffer?new Uint32Array(e):new Uint32Array(t?e/4:e);return r&&u.set(new Uint32Array(r)),u}case 1:{var f=e instanceof ArrayBuffer?new Float32Array(e):new Float32Array(t?e/4:e);return r&&f.set(new Float32Array(r)),f}}var h=e instanceof ArrayBuffer?new Uint8Array(e):new Uint8Array(e);return r&&h.set(new Uint8Array(r)),h}ge.prototype._readTexturePixelsSync=function(i,e,t,r,n,a,s,o,l,u){var f,h;r===void 0&&(r=-1),n===void 0&&(n=0),a===void 0&&(a=null),s===void 0&&(s=!0),o===void 0&&(o=!1),l===void 0&&(l=0),u===void 0&&(u=0);var c=this._gl;if(!c)throw new Error("Engine does not have gl rendering context.");if(!this._dummyFramebuffer){var d=c.createFramebuffer();if(!d)throw new Error("Unable to create dummy framebuffer");this._dummyFramebuffer=d}c.bindFramebuffer(c.FRAMEBUFFER,this._dummyFramebuffer),r>-1?c.framebufferTexture2D(c.FRAMEBUFFER,c.COLOR_ATTACHMENT0,c.TEXTURE_CUBE_MAP_POSITIVE_X+r,(f=i._hardwareTexture)===null||f===void 0?void 0:f.underlyingResource,n):c.framebufferTexture2D(c.FRAMEBUFFER,c.COLOR_ATTACHMENT0,c.TEXTURE_2D,(h=i._hardwareTexture)===null||h===void 0?void 0:h.underlyingResource,n);var p=i.type!==void 0?this._getWebGLTextureType(i.type):c.UNSIGNED_BYTE;if(o)a||(a=ml(i.type,4*e*t));else switch(p){case c.UNSIGNED_BYTE:a||(a=new Uint8Array(4*e*t)),p=c.UNSIGNED_BYTE;break;default:a||(a=new Float32Array(4*e*t)),p=c.FLOAT;break}return s&&this.flushFramebuffer(),c.readPixels(l,u,e,t,c.RGBA,p,a),c.bindFramebuffer(c.FRAMEBUFFER,this._currentFramebuffer),a};ge.prototype._readTexturePixels=function(i,e,t,r,n,a,s,o,l,u){return r===void 0&&(r=-1),n===void 0&&(n=0),a===void 0&&(a=null),s===void 0&&(s=!0),o===void 0&&(o=!1),l===void 0&&(l=0),u===void 0&&(u=0),Promise.resolve(this._readTexturePixelsSync(i,e,t,r,n,a,s,o,l,u))};ge.prototype.updateDynamicIndexBuffer=function(i,e,t){this._currentBoundBuffer[this._gl.ELEMENT_ARRAY_BUFFER]=null,this.bindIndexBuffer(i);var r;e instanceof Uint16Array||e instanceof Uint32Array?r=e:r=i.is32Bits?new Uint32Array(e):new Uint16Array(e),this._gl.bufferData(this._gl.ELEMENT_ARRAY_BUFFER,r,this._gl.DYNAMIC_DRAW),this._resetIndexBufferBinding()};ge.prototype.updateDynamicVertexBuffer=function(i,e,t,r){this.bindArrayBuffer(i),t===void 0&&(t=0);var n=e.byteLength||e.length;r===void 0||r>=n&&t===0?e instanceof Array?this._gl.bufferSubData(this._gl.ARRAY_BUFFER,t,new Float32Array(e)):this._gl.bufferSubData(this._gl.ARRAY_BUFFER,t,e):e instanceof Array?this._gl.bufferSubData(this._gl.ARRAY_BUFFER,0,new Float32Array(e).subarray(t,t+r)):(e instanceof ArrayBuffer?e=new Uint8Array(e,t,r):e=new Uint8Array(e.buffer,e.byteOffset+t,r),this._gl.bufferSubData(this._gl.ARRAY_BUFFER,0,e)),this._resetVertexBufferBinding()};var De=function(i){$(e,i);function e(t,r,n,a){a===void 0&&(a=!1);var s=i.call(this,t,r,n,a)||this;if(s.enableOfflineSupport=!1,s.disableManifestCheck=!1,s.scenes=new Array,s._virtualScenes=new Array,s.onNewSceneAddedObservable=new X,s.postProcesses=new Array,s.isPointerLock=!1,s.onResizeObservable=new X,s.onCanvasBlurObservable=new X,s.onCanvasFocusObservable=new X,s.onCanvasPointerOutObservable=new X,s.onBeginFrameObservable=new X,s.customAnimationFrameRequester=null,s.onEndFrameObservable=new X,s.onBeforeShaderCompilationObservable=new X,s.onAfterShaderCompilationObservable=new X,s._deterministicLockstep=!1,s._lockstepMaxSteps=4,s._timeStep=1/60,s._fps=60,s._deltaTime=0,s._drawCalls=new $e,s.canvasTabIndex=1,s.disablePerformanceMonitorInBackground=!1,s._performanceMonitor=new vl,s._compatibilityMode=!0,s.currentRenderPassId=0,s._renderPassNames=["main"],e.Instances.push(s),!t)return s;if(s._features.supportRenderPasses=!0,n=s._creationOptions,t.getContext){var o=t;if(s._sharedInit(o,!!n.doNotHandleTouchAction,n.audioEngine),ze()){var l=document;s._onFullscreenChange=function(){l.fullscreen!==void 0?s.isFullscreen=l.fullscreen:l.mozFullScreen!==void 0?s.isFullscreen=l.mozFullScreen:l.webkitIsFullScreen!==void 0?s.isFullscreen=l.webkitIsFullScreen:l.msIsFullScreen!==void 0&&(s.isFullscreen=l.msIsFullScreen),s.isFullscreen&&s._pointerLockRequested&&o&&e._RequestPointerlock(o)},document.addEventListener("fullscreenchange",s._onFullscreenChange,!1),document.addEventListener("mozfullscreenchange",s._onFullscreenChange,!1),document.addEventListener("webkitfullscreenchange",s._onFullscreenChange,!1),document.addEventListener("msfullscreenchange",s._onFullscreenChange,!1),s._onPointerLockChange=function(){s.isPointerLock=l.mozPointerLockElement===o||l.webkitPointerLockElement===o||l.msPointerLockElement===o||l.pointerLockElement===o},document.addEventListener("pointerlockchange",s._onPointerLockChange,!1),document.addEventListener("mspointerlockchange",s._onPointerLockChange,!1),document.addEventListener("mozpointerlockchange",s._onPointerLockChange,!1),document.addEventListener("webkitpointerlockchange",s._onPointerLockChange,!1),!e.audioEngine&&n.audioEngine&&e.AudioEngineFactory&&(e.audioEngine=e.AudioEngineFactory(s.getRenderingCanvas(),s.getAudioContext(),s.getAudioDestination()))}s._connectVREvents(),s.enableOfflineSupport=e.OfflineProviderFactory!==void 0,s._deterministicLockstep=!!n.deterministicLockstep,s._lockstepMaxSteps=n.lockstepMaxSteps||0,s._timeStep=n.timeStep||1/60}return s._prepareVRComponent(),n.autoEnableWebVR&&s.initWebVR(),s}return Object.defineProperty(e,"NpmPackage",{get:function(){return ge.NpmPackage},enumerable:!1,configurable:!0}),Object.defineProperty(e,"Version",{get:function(){return ge.Version},enumerable:!1,configurable:!0}),Object.defineProperty(e,"Instances",{get:function(){return ye.Instances},enumerable:!1,configurable:!0}),Object.defineProperty(e,"LastCreatedEngine",{get:function(){return ye.LastCreatedEngine},enumerable:!1,configurable:!0}),Object.defineProperty(e,"LastCreatedScene",{get:function(){return ye.LastCreatedScene},enumerable:!1,configurable:!0}),e.prototype.createImageBitmapFromSource=function(t,r){var n=this,a=new Promise(function(s,o){var l=new Image;l.onload=function(){l.decode().then(function(){n.createImageBitmap(l,r).then(function(u){s(u)})})},l.onerror=function(){o("Error loading image ".concat(l.src))},l.src=t});return a},e.prototype.createImageBitmap=function(t,r){return createImageBitmap(t,r)},e.prototype.resizeImageBitmap=function(t,r,n){var a=this.createCanvas(r,n),s=a.getContext("2d");if(!s)throw new Error("Unable to get 2d context for resizeImageBitmap");s.drawImage(t,0,0);var o=s.getImageData(0,0,r,n).data;return o},e.MarkAllMaterialsAsDirty=function(t,r){for(var n=0;n<e.Instances.length;n++)for(var a=e.Instances[n],s=0;s<a.scenes.length;s++)a.scenes[s].markAllMaterialsAsDirty(t,r)},e.DefaultLoadingScreenFactory=function(t){throw he("LoadingScreen")},Object.defineProperty(e.prototype,"_supportsHardwareTextureRescaling",{get:function(){return!!e._RescalePostProcessFactory},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"performanceMonitor",{get:function(){return this._performanceMonitor},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"compatibilityMode",{get:function(){return this._compatibilityMode},set:function(t){this._compatibilityMode=!0},enumerable:!1,configurable:!0}),e.prototype.getInputElement=function(){return this._renderingCanvas},e.prototype._sharedInit=function(t,r,n){var a=this;if(i.prototype._sharedInit.call(this,t,r,n),this._onCanvasFocus=function(){a.onCanvasFocusObservable.notifyObservers(a)},this._onCanvasBlur=function(){a.onCanvasBlurObservable.notifyObservers(a)},t.addEventListener("focus",this._onCanvasFocus),t.addEventListener("blur",this._onCanvasBlur),this._onBlur=function(){a.disablePerformanceMonitorInBackground&&a._performanceMonitor.disable(),a._windowIsBackground=!0},this._onFocus=function(){a.disablePerformanceMonitorInBackground&&a._performanceMonitor.enable(),a._windowIsBackground=!1},this._onCanvasPointerOut=function(o){document.elementFromPoint(o.clientX,o.clientY)!==t&&a.onCanvasPointerOutObservable.notifyObservers(o)},ze()){var s=this.getHostWindow();s&&(s.addEventListener("blur",this._onBlur),s.addEventListener("focus",this._onFocus))}t.addEventListener("pointerout",this._onCanvasPointerOut),r||this._disableTouchAction(),!e.audioEngine&&n&&e.AudioEngineFactory&&(e.audioEngine=e.AudioEngineFactory(this.getRenderingCanvas(),this.getAudioContext(),this.getAudioDestination()))},e.prototype.getAspectRatio=function(t,r){r===void 0&&(r=!1);var n=t.viewport;return this.getRenderWidth(r)*n.width/(this.getRenderHeight(r)*n.height)},e.prototype.getScreenAspectRatio=function(){return this.getRenderWidth(!0)/this.getRenderHeight(!0)},e.prototype.getRenderingCanvasClientRect=function(){return this._renderingCanvas?this._renderingCanvas.getBoundingClientRect():null},e.prototype.getInputElementClientRect=function(){return this._renderingCanvas?this.getInputElement().getBoundingClientRect():null},e.prototype.isDeterministicLockStep=function(){return this._deterministicLockstep},e.prototype.getLockstepMaxSteps=function(){return this._lockstepMaxSteps},e.prototype.getTimeStep=function(){return this._timeStep*1e3},e.prototype.generateMipMapsForCubemap=function(t,r){if(r===void 0&&(r=!0),t.generateMipMaps){var n=this._gl;this._bindTextureDirectly(n.TEXTURE_CUBE_MAP,t,!0),n.generateMipmap(n.TEXTURE_CUBE_MAP),r&&this._bindTextureDirectly(n.TEXTURE_CUBE_MAP,null)}},e.prototype.getDepthBuffer=function(){return this._depthCullingState.depthTest},e.prototype.setDepthBuffer=function(t){this._depthCullingState.depthTest=t},e.prototype.getDepthWrite=function(){return this._depthCullingState.depthMask},e.prototype.setDepthWrite=function(t){this._depthCullingState.depthMask=t},e.prototype.getStencilBuffer=function(){return this._stencilState.stencilTest},e.prototype.setStencilBuffer=function(t){this._stencilState.stencilTest=t},e.prototype.getStencilMask=function(){return this._stencilState.stencilMask},e.prototype.setStencilMask=function(t){this._stencilState.stencilMask=t},e.prototype.getStencilFunction=function(){return this._stencilState.stencilFunc},e.prototype.getStencilFunctionReference=function(){return this._stencilState.stencilFuncRef},e.prototype.getStencilFunctionMask=function(){return this._stencilState.stencilFuncMask},e.prototype.setStencilFunction=function(t){this._stencilState.stencilFunc=t},e.prototype.setStencilFunctionReference=function(t){this._stencilState.stencilFuncRef=t},e.prototype.setStencilFunctionMask=function(t){this._stencilState.stencilFuncMask=t},e.prototype.getStencilOperationFail=function(){return this._stencilState.stencilOpStencilFail},e.prototype.getStencilOperationDepthFail=function(){return this._stencilState.stencilOpDepthFail},e.prototype.getStencilOperationPass=function(){return this._stencilState.stencilOpStencilDepthPass},e.prototype.setStencilOperationFail=function(t){this._stencilState.stencilOpStencilFail=t},e.prototype.setStencilOperationDepthFail=function(t){this._stencilState.stencilOpDepthFail=t},e.prototype.setStencilOperationPass=function(t){this._stencilState.stencilOpStencilDepthPass=t},e.prototype.setDitheringState=function(t){t?this._gl.enable(this._gl.DITHER):this._gl.disable(this._gl.DITHER)},e.prototype.setRasterizerState=function(t){t?this._gl.disable(this._gl.RASTERIZER_DISCARD):this._gl.enable(this._gl.RASTERIZER_DISCARD)},e.prototype.getDepthFunction=function(){return this._depthCullingState.depthFunc},e.prototype.setDepthFunction=function(t){this._depthCullingState.depthFunc=t},e.prototype.setDepthFunctionToGreater=function(){this.setDepthFunction(516)},e.prototype.setDepthFunctionToGreaterOrEqual=function(){this.setDepthFunction(518)},e.prototype.setDepthFunctionToLess=function(){this.setDepthFunction(513)},e.prototype.setDepthFunctionToLessOrEqual=function(){this.setDepthFunction(515)},e.prototype.cacheStencilState=function(){this._cachedStencilBuffer=this.getStencilBuffer(),this._cachedStencilFunction=this.getStencilFunction(),this._cachedStencilMask=this.getStencilMask(),this._cachedStencilOperationPass=this.getStencilOperationPass(),this._cachedStencilOperationFail=this.getStencilOperationFail(),this._cachedStencilOperationDepthFail=this.getStencilOperationDepthFail(),this._cachedStencilReference=this.getStencilFunctionReference()},e.prototype.restoreStencilState=function(){this.setStencilFunction(this._cachedStencilFunction),this.setStencilMask(this._cachedStencilMask),this.setStencilBuffer(this._cachedStencilBuffer),this.setStencilOperationPass(this._cachedStencilOperationPass),this.setStencilOperationFail(this._cachedStencilOperationFail),this.setStencilOperationDepthFail(this._cachedStencilOperationDepthFail),this.setStencilFunctionReference(this._cachedStencilReference)},e.prototype.setDirectViewport=function(t,r,n,a){var s=this._cachedViewport;return this._cachedViewport=null,this._viewport(t,r,n,a),s},e.prototype.scissorClear=function(t,r,n,a,s){this.enableScissor(t,r,n,a),this.clear(s,!0,!0,!0),this.disableScissor()},e.prototype.enableScissor=function(t,r,n,a){var s=this._gl;s.enable(s.SCISSOR_TEST),s.scissor(t,r,n,a)},e.prototype.disableScissor=function(){var t=this._gl;t.disable(t.SCISSOR_TEST)},e.prototype._reportDrawCall=function(t){t===void 0&&(t=1),this._drawCalls.addCount(t,!1)},e.prototype.initWebVR=function(){throw he("WebVRCamera")},e.prototype._prepareVRComponent=function(){},e.prototype._connectVREvents=function(t,r){},e.prototype._submitVRFrame=function(){},e.prototype.disableVR=function(){},e.prototype.isVRPresenting=function(){return!1},e.prototype._requestVRFrame=function(){},e.prototype._loadFileAsync=function(t,r,n){var a=this;return new Promise(function(s,o){a._loadFile(t,function(l){s(l)},void 0,r,n,function(l,u){o(u)})})},e.prototype.getVertexShaderSource=function(t){var r=this._gl.getAttachedShaders(t);return r?this._gl.getShaderSource(r[0]):null},e.prototype.getFragmentShaderSource=function(t){var r=this._gl.getAttachedShaders(t);return r?this._gl.getShaderSource(r[1]):null},e.prototype.setDepthStencilTexture=function(t,r,n,a){t!==void 0&&(r&&(this._boundUniforms[t]=r),!n||!n.depthStencilTexture?this._setTexture(t,null,void 0,void 0,a):this._setTexture(t,n,!1,!0,a))},e.prototype.setTextureFromPostProcess=function(t,r,n){var a,s=null;r&&(r._textures.data[r._currentRenderTextureInd]?s=r._textures.data[r._currentRenderTextureInd]:r._forcedOutputTexture&&(s=r._forcedOutputTexture)),this._bindTexture(t,(a=s==null?void 0:s.texture)!==null&&a!==void 0?a:null,n)},e.prototype.setTextureFromPostProcessOutput=function(t,r,n){var a,s;this._bindTexture(t,(s=(a=r==null?void 0:r._outputTexture)===null||a===void 0?void 0:a.texture)!==null&&s!==void 0?s:null,n)},e.prototype._rebuildBuffers=function(){for(var t=0,r=this.scenes;t<r.length;t++){var n=r[t];n.resetCachedMaterial(),n._rebuildGeometries(),n._rebuildTextures()}for(var a=0,s=this._virtualScenes;a<s.length;a++){var n=s[a];n.resetCachedMaterial(),n._rebuildGeometries(),n._rebuildTextures()}i.prototype._rebuildBuffers.call(this)},e.prototype._renderFrame=function(){for(var t=0;t<this._activeRenderLoops.length;t++){var r=this._activeRenderLoops[t];r()}},e.prototype._renderLoop=function(){if(!this._contextWasLost){var t=!0;!this.renderEvenInBackground&&this._windowIsBackground&&(t=!1),t&&(this.beginFrame(),this._renderViews()||this._renderFrame(),this.endFrame())}this._activeRenderLoops.length>0?this.customAnimationFrameRequester?(this.customAnimationFrameRequester.requestID=this._queueNewFrame(this.customAnimationFrameRequester.renderFunction||this._boundRenderFunction,this.customAnimationFrameRequester),this._frameHandler=this.customAnimationFrameRequester.requestID):this.isVRPresenting()?this._requestVRFrame():this._frameHandler=this._queueNewFrame(this._boundRenderFunction,this.getHostWindow()):this._renderingQueueLaunched=!1},e.prototype._renderViews=function(){return!1},e.prototype.switchFullscreen=function(t){this.isFullscreen?this.exitFullscreen():this.enterFullscreen(t)},e.prototype.enterFullscreen=function(t){this.isFullscreen||(this._pointerLockRequested=t,this._renderingCanvas&&e._RequestFullscreen(this._renderingCanvas))},e.prototype.exitFullscreen=function(){this.isFullscreen&&e._ExitFullscreen()},e.prototype.enterPointerlock=function(){this._renderingCanvas&&e._RequestPointerlock(this._renderingCanvas)},e.prototype.exitPointerlock=function(){e._ExitPointerlock()},e.prototype.beginFrame=function(){this._measureFps(),this.onBeginFrameObservable.notifyObservers(this),i.prototype.beginFrame.call(this)},e.prototype.endFrame=function(){i.prototype.endFrame.call(this),this._submitVRFrame(),this.onEndFrameObservable.notifyObservers(this)},e.prototype.resize=function(t){t===void 0&&(t=!1),!this.isVRPresenting()&&i.prototype.resize.call(this,t)},e.prototype.setSize=function(t,r,n){if(n===void 0&&(n=!1),!this._renderingCanvas||!i.prototype.setSize.call(this,t,r,n))return!1;if(this.scenes){for(var a=0;a<this.scenes.length;a++)for(var s=this.scenes[a],o=0;o<s.cameras.length;o++){var l=s.cameras[o];l._currentRenderId=0}this.onResizeObservable.hasObservers()&&this.onResizeObservable.notifyObservers(this)}return!0},e.prototype._deletePipelineContext=function(t){var r=t;r&&r.program&&r.transformFeedback&&(this.deleteTransformFeedback(r.transformFeedback),r.transformFeedback=null),i.prototype._deletePipelineContext.call(this,t)},e.prototype.createShaderProgram=function(t,r,n,a,s,o){o===void 0&&(o=null),s=s||this._gl,this.onBeforeShaderCompilationObservable.notifyObservers(this);var l=i.prototype.createShaderProgram.call(this,t,r,n,a,s,o);return this.onAfterShaderCompilationObservable.notifyObservers(this),l},e.prototype._createShaderProgram=function(t,r,n,a,s){s===void 0&&(s=null);var o=a.createProgram();if(t.program=o,!o)throw new Error("Unable to create program");if(a.attachShader(o,r),a.attachShader(o,n),this.webGLVersion>1&&s){var l=this.createTransformFeedback();this.bindTransformFeedback(l),this.setTranformFeedbackVaryings(o,s),t.transformFeedback=l}return a.linkProgram(o),this.webGLVersion>1&&s&&this.bindTransformFeedback(null),t.context=a,t.vertexShader=r,t.fragmentShader=n,t.isParallelCompiled||this._finalizePipelineContext(t),o},e.prototype._releaseTexture=function(t){i.prototype._releaseTexture.call(this,t)},e.prototype._releaseRenderTargetWrapper=function(t){i.prototype._releaseRenderTargetWrapper.call(this,t),this.scenes.forEach(function(r){r.postProcesses.forEach(function(n){n._outputTexture===t&&(n._outputTexture=null)}),r.cameras.forEach(function(n){n._postProcesses.forEach(function(a){a&&a._outputTexture===t&&(a._outputTexture=null)})})})},e.prototype.getRenderPassNames=function(){return this._renderPassNames},e.prototype.getCurrentRenderPassName=function(){return this._renderPassNames[this.currentRenderPassId]},e.prototype.createRenderPassId=function(t){var r=++e._RenderPassIdCounter;return this._renderPassNames[r]=t!=null?t:"NONAME",r},e.prototype.releaseRenderPassId=function(t){this._renderPassNames[t]=void 0;for(var r=0;r<this.scenes.length;++r)for(var n=this.scenes[r],a=0;a<n.meshes.length;++a){var s=n.meshes[a];if(s.subMeshes)for(var o=0;o<s.subMeshes.length;++o){var l=s.subMeshes[o];l._removeDrawWrapper(t)}}},e.prototype._rescaleTexture=function(t,r,n,a,s){var o=this;this._gl.texParameteri(this._gl.TEXTURE_2D,this._gl.TEXTURE_MAG_FILTER,this._gl.LINEAR),this._gl.texParameteri(this._gl.TEXTURE_2D,this._gl.TEXTURE_MIN_FILTER,this._gl.LINEAR),this._gl.texParameteri(this._gl.TEXTURE_2D,this._gl.TEXTURE_WRAP_S,this._gl.CLAMP_TO_EDGE),this._gl.texParameteri(this._gl.TEXTURE_2D,this._gl.TEXTURE_WRAP_T,this._gl.CLAMP_TO_EDGE);var l=this.createRenderTargetTexture({width:r.width,height:r.height},{generateMipMaps:!1,type:0,samplingMode:2,generateDepthBuffer:!1,generateStencilBuffer:!1});!this._rescalePostProcess&&e._RescalePostProcessFactory&&(this._rescalePostProcess=e._RescalePostProcessFactory(this)),this._rescalePostProcess.externalTextureSamplerBinding=!0,this._rescalePostProcess.getEffect().executeWhenCompiled(function(){o._rescalePostProcess.onApply=function(f){f._bindTexture("textureSampler",t)};var u=n;u||(u=o.scenes[o.scenes.length-1]),u.postProcessManager.directRender([o._rescalePostProcess],l,!0),o._bindTextureDirectly(o._gl.TEXTURE_2D,r,!0),o._gl.copyTexImage2D(o._gl.TEXTURE_2D,0,a,0,0,r.width,r.height,0),o.unBindFramebuffer(l),l.dispose(),s&&s()})},e.prototype.getFps=function(){return this._fps},e.prototype.getDeltaTime=function(){return this._deltaTime},e.prototype._measureFps=function(){this._performanceMonitor.sampleFrame(),this._fps=this._performanceMonitor.averageFPS,this._deltaTime=this._performanceMonitor.instantaneousFrameTime||0},e.prototype.wrapWebGLTexture=function(t){var r=new wa(t,this._gl),n=new at(this,Ie.Unknown,!0);return n._hardwareTexture=r,n.isReady=!0,n},e.prototype._uploadImageToTexture=function(t,r,n,a){n===void 0&&(n=0),a===void 0&&(a=0);var s=this._gl,o=this._getWebGLTextureType(t.type),l=this._getInternalFormat(t.format),u=this._getRGBABufferInternalSizedFormat(t.type,l),f=t.isCube?s.TEXTURE_CUBE_MAP:s.TEXTURE_2D;this._bindTextureDirectly(f,t,!0),this._unpackFlipY(t.invertY);var h=s.TEXTURE_2D;t.isCube&&(h=s.TEXTURE_CUBE_MAP_POSITIVE_X+n),s.texImage2D(h,a,u,l,o,r),this._bindTextureDirectly(f,null,!0)},e.prototype.updateTextureComparisonFunction=function(t,r){if(this.webGLVersion===1){Y.Error("WebGL 1 does not support texture comparison.");return}var n=this._gl;t.isCube?(this._bindTextureDirectly(this._gl.TEXTURE_CUBE_MAP,t,!0),r===0?(n.texParameteri(n.TEXTURE_CUBE_MAP,n.TEXTURE_COMPARE_FUNC,515),n.texParameteri(n.TEXTURE_CUBE_MAP,n.TEXTURE_COMPARE_MODE,n.NONE)):(n.texParameteri(n.TEXTURE_CUBE_MAP,n.TEXTURE_COMPARE_FUNC,r),n.texParameteri(n.TEXTURE_CUBE_MAP,n.TEXTURE_COMPARE_MODE,n.COMPARE_REF_TO_TEXTURE)),this._bindTextureDirectly(this._gl.TEXTURE_CUBE_MAP,null)):(this._bindTextureDirectly(this._gl.TEXTURE_2D,t,!0),r===0?(n.texParameteri(n.TEXTURE_2D,n.TEXTURE_COMPARE_FUNC,515),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_COMPARE_MODE,n.NONE)):(n.texParameteri(n.TEXTURE_2D,n.TEXTURE_COMPARE_FUNC,r),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_COMPARE_MODE,n.COMPARE_REF_TO_TEXTURE)),this._bindTextureDirectly(this._gl.TEXTURE_2D,null)),t._comparisonFunction=r},e.prototype.createInstancesBuffer=function(t){var r=this._gl.createBuffer();if(!r)throw new Error("Unable to create instance buffer");var n=new Ir(r);return n.capacity=t,this.bindArrayBuffer(n),this._gl.bufferData(this._gl.ARRAY_BUFFER,t,this._gl.DYNAMIC_DRAW),n.references=1,n},e.prototype.deleteInstancesBuffer=function(t){this._gl.deleteBuffer(t)},e.prototype._clientWaitAsync=function(t,r,n){r===void 0&&(r=0),n===void 0&&(n=10);var a=this._gl;return new Promise(function(s,o){var l=function(){var u=a.clientWaitSync(t,r,0);if(u==a.WAIT_FAILED){o();return}if(u==a.TIMEOUT_EXPIRED){setTimeout(l,n);return}s()};l()})},e.prototype._readPixelsAsync=function(t,r,n,a,s,o,l){if(this._webGLVersion<2)throw new Error("_readPixelsAsync only work on WebGL2+");var u=this._gl,f=u.createBuffer();u.bindBuffer(u.PIXEL_PACK_BUFFER,f),u.bufferData(u.PIXEL_PACK_BUFFER,l.byteLength,u.STREAM_READ),u.readPixels(t,r,n,a,s,o,0),u.bindBuffer(u.PIXEL_PACK_BUFFER,null);var h=u.fenceSync(u.SYNC_GPU_COMMANDS_COMPLETE,0);return h?(u.flush(),this._clientWaitAsync(h,0,10).then(function(){return u.deleteSync(h),u.bindBuffer(u.PIXEL_PACK_BUFFER,f),u.getBufferSubData(u.PIXEL_PACK_BUFFER,0,l),u.bindBuffer(u.PIXEL_PACK_BUFFER,null),u.deleteBuffer(f),l})):null},e.prototype.dispose=function(){for(this.hideLoadingUI(),this.onNewSceneAddedObservable.clear();this.postProcesses.length;)this.postProcesses[0].dispose();for(this._rescalePostProcess&&this._rescalePostProcess.dispose();this.scenes.length;)this.scenes[0].dispose();for(;this._virtualScenes.length;)this._virtualScenes[0].dispose();e.Instances.length===1&&e.audioEngine&&(e.audioEngine.dispose(),e.audioEngine=null),this.disableVR(),ze()&&(window.removeEventListener("blur",this._onBlur),window.removeEventListener("focus",this._onFocus),this._renderingCanvas&&(this._renderingCanvas.removeEventListener("focus",this._onCanvasFocus),this._renderingCanvas.removeEventListener("blur",this._onCanvasBlur),this._renderingCanvas.removeEventListener("pointerout",this._onCanvasPointerOut)),Qi()&&(document.removeEventListener("fullscreenchange",this._onFullscreenChange),document.removeEventListener("mozfullscreenchange",this._onFullscreenChange),document.removeEventListener("webkitfullscreenchange",this._onFullscreenChange),document.removeEventListener("msfullscreenchange",this._onFullscreenChange),document.removeEventListener("pointerlockchange",this._onPointerLockChange),document.removeEventListener("mspointerlockchange",this._onPointerLockChange),document.removeEventListener("mozpointerlockchange",this._onPointerLockChange),document.removeEventListener("webkitpointerlockchange",this._onPointerLockChange))),i.prototype.dispose.call(this);var t=e.Instances.indexOf(this);t>=0&&e.Instances.splice(t,1),this.onResizeObservable.clear(),this.onCanvasBlurObservable.clear(),this.onCanvasFocusObservable.clear(),this.onCanvasPointerOutObservable.clear(),this.onBeginFrameObservable.clear(),this.onEndFrameObservable.clear()},e.prototype._disableTouchAction=function(){!this._renderingCanvas||!this._renderingCanvas.setAttribute||(this._renderingCanvas.setAttribute("touch-action","none"),this._renderingCanvas.style.touchAction="none",this._renderingCanvas.style.msTouchAction="none")},e.prototype.displayLoadingUI=function(){if(!!ze()){var t=this.loadingScreen;t&&t.displayLoadingUI()}},e.prototype.hideLoadingUI=function(){if(!!ze()){var t=this._loadingScreen;t&&t.hideLoadingUI()}},Object.defineProperty(e.prototype,"loadingScreen",{get:function(){return!this._loadingScreen&&this._renderingCanvas&&(this._loadingScreen=e.DefaultLoadingScreenFactory(this._renderingCanvas)),this._loadingScreen},set:function(t){this._loadingScreen=t},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"loadingUIText",{set:function(t){this.loadingScreen.loadingUIText=t},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"loadingUIBackgroundColor",{set:function(t){this.loadingScreen.loadingUIBackgroundColor=t},enumerable:!1,configurable:!0}),e.prototype.createVideoElement=function(t){return document.createElement("video")},e._RequestPointerlock=function(t){t.requestPointerLock=t.requestPointerLock||t.msRequestPointerLock||t.mozRequestPointerLock||t.webkitRequestPointerLock,t.requestPointerLock&&t.requestPointerLock()},e._ExitPointerlock=function(){var t=document;document.exitPointerLock=document.exitPointerLock||t.msExitPointerLock||t.mozExitPointerLock||t.webkitExitPointerLock,document.exitPointerLock&&document.exitPointerLock()},e._RequestFullscreen=function(t){var r=t.requestFullscreen||t.msRequestFullscreen||t.webkitRequestFullscreen||t.mozRequestFullScreen;!r||r.call(t)},e._ExitFullscreen=function(){var t=document;document.exitFullscreen?document.exitFullscreen():t.mozCancelFullScreen?t.mozCancelFullScreen():t.webkitCancelFullScreen?t.webkitCancelFullScreen():t.msCancelFullScreen&&t.msCancelFullScreen()},e.prototype.getFontOffset=function(t){var r=document.createElement("span");r.innerHTML="Hg",r.setAttribute("style","font: ".concat(t," !important"));var n=document.createElement("div");n.style.display="inline-block",n.style.width="1px",n.style.height="0px",n.style.verticalAlign="bottom";var a=document.createElement("div");a.style.whiteSpace="nowrap",a.appendChild(r),a.appendChild(n),document.body.appendChild(a);var s=0,o=0;try{o=n.getBoundingClientRect().top-r.getBoundingClientRect().top,n.style.verticalAlign="baseline",s=n.getBoundingClientRect().top-r.getBoundingClientRect().top}finally{document.body.removeChild(a)}return{ascent:s,height:o,descent:o-s}},e.ALPHA_DISABLE=0,e.ALPHA_ADD=1,e.ALPHA_COMBINE=2,e.ALPHA_SUBTRACT=3,e.ALPHA_MULTIPLY=4,e.ALPHA_MAXIMIZED=5,e.ALPHA_ONEONE=6,e.ALPHA_PREMULTIPLIED=7,e.ALPHA_PREMULTIPLIED_PORTERDUFF=8,e.ALPHA_INTERPOLATE=9,e.ALPHA_SCREENMODE=10,e.DELAYLOADSTATE_NONE=0,e.DELAYLOADSTATE_LOADED=1,e.DELAYLOADSTATE_LOADING=2,e.DELAYLOADSTATE_NOTLOADED=4,e.NEVER=512,e.ALWAYS=519,e.LESS=513,e.EQUAL=514,e.LEQUAL=515,e.GREATER=516,e.GEQUAL=518,e.NOTEQUAL=517,e.KEEP=7680,e.REPLACE=7681,e.INCR=7682,e.DECR=7683,e.INVERT=5386,e.INCR_WRAP=34055,e.DECR_WRAP=34056,e.TEXTURE_CLAMP_ADDRESSMODE=0,e.TEXTURE_WRAP_ADDRESSMODE=1,e.TEXTURE_MIRROR_ADDRESSMODE=2,e.TEXTUREFORMAT_ALPHA=0,e.TEXTUREFORMAT_LUMINANCE=1,e.TEXTUREFORMAT_LUMINANCE_ALPHA=2,e.TEXTUREFORMAT_RGB=4,e.TEXTUREFORMAT_RGBA=5,e.TEXTUREFORMAT_RED=6,e.TEXTUREFORMAT_R=6,e.TEXTUREFORMAT_RG=7,e.TEXTUREFORMAT_RED_INTEGER=8,e.TEXTUREFORMAT_R_INTEGER=8,e.TEXTUREFORMAT_RG_INTEGER=9,e.TEXTUREFORMAT_RGB_INTEGER=10,e.TEXTUREFORMAT_RGBA_INTEGER=11,e.TEXTURETYPE_UNSIGNED_BYTE=0,e.TEXTURETYPE_UNSIGNED_INT=0,e.TEXTURETYPE_FLOAT=1,e.TEXTURETYPE_HALF_FLOAT=2,e.TEXTURETYPE_BYTE=3,e.TEXTURETYPE_SHORT=4,e.TEXTURETYPE_UNSIGNED_SHORT=5,e.TEXTURETYPE_INT=6,e.TEXTURETYPE_UNSIGNED_INTEGER=7,e.TEXTURETYPE_UNSIGNED_SHORT_4_4_4_4=8,e.TEXTURETYPE_UNSIGNED_SHORT_5_5_5_1=9,e.TEXTURETYPE_UNSIGNED_SHORT_5_6_5=10,e.TEXTURETYPE_UNSIGNED_INT_2_10_10_10_REV=11,e.TEXTURETYPE_UNSIGNED_INT_24_8=12,e.TEXTURETYPE_UNSIGNED_INT_10F_11F_11F_REV=13,e.TEXTURETYPE_UNSIGNED_INT_5_9_9_9_REV=14,e.TEXTURETYPE_FLOAT_32_UNSIGNED_INT_24_8_REV=15,e.TEXTURE_NEAREST_SAMPLINGMODE=1,e.TEXTURE_BILINEAR_SAMPLINGMODE=2,e.TEXTURE_TRILINEAR_SAMPLINGMODE=3,e.TEXTURE_NEAREST_NEAREST_MIPLINEAR=8,e.TEXTURE_LINEAR_LINEAR_MIPNEAREST=11,e.TEXTURE_LINEAR_LINEAR_MIPLINEAR=3,e.TEXTURE_NEAREST_NEAREST_MIPNEAREST=4,e.TEXTURE_NEAREST_LINEAR_MIPNEAREST=5,e.TEXTURE_NEAREST_LINEAR_MIPLINEAR=6,e.TEXTURE_NEAREST_LINEAR=7,e.TEXTURE_NEAREST_NEAREST=1,e.TEXTURE_LINEAR_NEAREST_MIPNEAREST=9,e.TEXTURE_LINEAR_NEAREST_MIPLINEAR=10,e.TEXTURE_LINEAR_LINEAR=2,e.TEXTURE_LINEAR_NEAREST=12,e.TEXTURE_EXPLICIT_MODE=0,e.TEXTURE_SPHERICAL_MODE=1,e.TEXTURE_PLANAR_MODE=2,e.TEXTURE_CUBIC_MODE=3,e.TEXTURE_PROJECTION_MODE=4,e.TEXTURE_SKYBOX_MODE=5,e.TEXTURE_INVCUBIC_MODE=6,e.TEXTURE_EQUIRECTANGULAR_MODE=7,e.TEXTURE_FIXED_EQUIRECTANGULAR_MODE=8,e.TEXTURE_FIXED_EQUIRECTANGULAR_MIRRORED_MODE=9,e.SCALEMODE_FLOOR=1,e.SCALEMODE_NEAREST=2,e.SCALEMODE_CEILING=3,e._RescalePostProcessFactory=null,e._RenderPassIdCounter=0,e}(ge),yl=function(){function i(){this._checkCollisions=!1,this._collisionMask=-1,this._collisionGroup=-1,this._surroundingMeshes=null,this._collider=null,this._oldPositionForCollisions=new m(0,0,0),this._diffPositionForCollisions=new m(0,0,0),this._collisionResponse=!0}return i}(),bl=function(){function i(){this.facetNb=0,this.partitioningSubdivisions=10,this.partitioningBBoxRatio=1.01,this.facetDataEnabled=!1,this.facetParameters={},this.bbSize=m.Zero(),this.subDiv={max:1,X:1,Y:1,Z:1},this.facetDepthSort=!1,this.facetDepthSortEnabled=!1}return i}(),Tl=function(){function i(){this._hasVertexAlpha=!1,this._useVertexColors=!0,this._numBoneInfluencers=4,this._applyFog=!0,this._receiveShadows=!1,this._facetData=new bl,this._visibility=1,this._skeleton=null,this._layerMask=268435455,this._computeBonesUsingShaders=!0,this._isActive=!1,this._onlyForInstances=!1,this._isActiveIntermediate=!1,this._onlyForInstancesIntermediate=!1,this._actAsRegularMesh=!1,this._currentLOD=null,this._currentLODIsUpToDate=!1,this._collisionRetryCount=3,this._morphTargetManager=null,this._renderingGroupId=0,this._bakedVertexAnimationManager=null,this._material=null,this._positions=null,this._meshCollisionData=new yl,this._enableDistantPicking=!1}return i}(),ln=function(i){$(e,i);function e(t,r){r===void 0&&(r=null);var n=i.call(this,t,r,!1)||this;return n._internalAbstractMeshDataInfo=new Tl,n._waitingMaterialId=null,n.cullingStrategy=e.CULLINGSTRATEGY_BOUNDINGSPHERE_ONLY,n.onCollideObservable=new X,n.onCollisionPositionChangeObservable=new X,n.onMaterialChangedObservable=new X,n.definedFacingForward=!0,n._occlusionQuery=null,n._renderingGroup=null,n.alphaIndex=Number.MAX_VALUE,n.isVisible=!0,n.isPickable=!0,n.isNearPickable=!1,n.isNearGrabbable=!1,n.showSubMeshesBoundingBox=!1,n.isBlocker=!1,n.enablePointerMoveEvents=!1,n.outlineColor=me.Red(),n.outlineWidth=.02,n.overlayColor=me.Red(),n.overlayAlpha=.5,n.useOctreeForRenderingSelection=!0,n.useOctreeForPicking=!0,n.useOctreeForCollisions=!0,n.alwaysSelectAsActiveMesh=!1,n.doNotSyncBoundingInfo=!1,n.actionManager=null,n.ellipsoid=new m(.5,1,.5),n.ellipsoidOffset=new m(0,0,0),n.edgesWidth=1,n.edgesColor=new ce(1,0,0,1),n._edgesRenderer=null,n._masterMesh=null,n._boundingInfo=null,n._boundingInfoIsDirty=!0,n._renderId=0,n._intersectionsInProgress=new Array,n._unIndexed=!1,n._lightSources=new Array,n._waitingData={lods:null,actions:null,freezeWorldMatrix:null},n._bonesTransformMatrices=null,n._transformMatrixTexture=null,n.onRebuildObservable=new X,n._onCollisionPositionChange=function(a,s,o){o===void 0&&(o=null),s.subtractToRef(n._internalAbstractMeshDataInfo._meshCollisionData._oldPositionForCollisions,n._internalAbstractMeshDataInfo._meshCollisionData._diffPositionForCollisions),n._internalAbstractMeshDataInfo._meshCollisionData._diffPositionForCollisions.length()>De.CollisionsEpsilon&&n.position.addInPlace(n._internalAbstractMeshDataInfo._meshCollisionData._diffPositionForCollisions),o&&n.onCollideObservable.notifyObservers(o),n.onCollisionPositionChangeObservable.notifyObservers(n.position)},n.getScene().addMesh(n),n._resyncLightSources(),n._uniformBuffer=new si(n.getScene().getEngine(),void 0,void 0,t,!n.getScene().getEngine().isWebGPU),n._buildUniformLayout(),n}return Object.defineProperty(e,"BILLBOARDMODE_NONE",{get:function(){return ht.BILLBOARDMODE_NONE},enumerable:!1,configurable:!0}),Object.defineProperty(e,"BILLBOARDMODE_X",{get:function(){return ht.BILLBOARDMODE_X},enumerable:!1,configurable:!0}),Object.defineProperty(e,"BILLBOARDMODE_Y",{get:function(){return ht.BILLBOARDMODE_Y},enumerable:!1,configurable:!0}),Object.defineProperty(e,"BILLBOARDMODE_Z",{get:function(){return ht.BILLBOARDMODE_Z},enumerable:!1,configurable:!0}),Object.defineProperty(e,"BILLBOARDMODE_ALL",{get:function(){return ht.BILLBOARDMODE_ALL},enumerable:!1,configurable:!0}),Object.defineProperty(e,"BILLBOARDMODE_USE_POSITION",{get:function(){return ht.BILLBOARDMODE_USE_POSITION},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"facetNb",{get:function(){return this._internalAbstractMeshDataInfo._facetData.facetNb},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"partitioningSubdivisions",{get:function(){return this._internalAbstractMeshDataInfo._facetData.partitioningSubdivisions},set:function(t){this._internalAbstractMeshDataInfo._facetData.partitioningSubdivisions=t},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"partitioningBBoxRatio",{get:function(){return this._internalAbstractMeshDataInfo._facetData.partitioningBBoxRatio},set:function(t){this._internalAbstractMeshDataInfo._facetData.partitioningBBoxRatio=t},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"mustDepthSortFacets",{get:function(){return this._internalAbstractMeshDataInfo._facetData.facetDepthSort},set:function(t){this._internalAbstractMeshDataInfo._facetData.facetDepthSort=t},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"facetDepthSortFrom",{get:function(){return this._internalAbstractMeshDataInfo._facetData.facetDepthSortFrom},set:function(t){this._internalAbstractMeshDataInfo._facetData.facetDepthSortFrom=t},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"collisionRetryCount",{get:function(){return this._internalAbstractMeshDataInfo._collisionRetryCount},set:function(t){this._internalAbstractMeshDataInfo._collisionRetryCount=t},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"isFacetDataEnabled",{get:function(){return this._internalAbstractMeshDataInfo._facetData.facetDataEnabled},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"morphTargetManager",{get:function(){return this._internalAbstractMeshDataInfo._morphTargetManager},set:function(t){this._internalAbstractMeshDataInfo._morphTargetManager!==t&&(this._internalAbstractMeshDataInfo._morphTargetManager=t,this._syncGeometryWithMorphTargetManager())},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"bakedVertexAnimationManager",{get:function(){return this._internalAbstractMeshDataInfo._bakedVertexAnimationManager},set:function(t){this._internalAbstractMeshDataInfo._bakedVertexAnimationManager!==t&&(this._internalAbstractMeshDataInfo._bakedVertexAnimationManager=t,this._markSubMeshesAsAttributesDirty())},enumerable:!1,configurable:!0}),e.prototype._syncGeometryWithMorphTargetManager=function(){},e.prototype._updateNonUniformScalingState=function(t){return i.prototype._updateNonUniformScalingState.call(this,t)?(this._markSubMeshesAsMiscDirty(),!0):!1},Object.defineProperty(e.prototype,"onCollide",{set:function(t){this._internalAbstractMeshDataInfo._meshCollisionData._onCollideObserver&&this.onCollideObservable.remove(this._internalAbstractMeshDataInfo._meshCollisionData._onCollideObserver),this._internalAbstractMeshDataInfo._meshCollisionData._onCollideObserver=this.onCollideObservable.add(t)},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"onCollisionPositionChange",{set:function(t){this._internalAbstractMeshDataInfo._meshCollisionData._onCollisionPositionChangeObserver&&this.onCollisionPositionChangeObservable.remove(this._internalAbstractMeshDataInfo._meshCollisionData._onCollisionPositionChangeObserver),this._internalAbstractMeshDataInfo._meshCollisionData._onCollisionPositionChangeObserver=this.onCollisionPositionChangeObservable.add(t)},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"visibility",{get:function(){return this._internalAbstractMeshDataInfo._visibility},set:function(t){if(this._internalAbstractMeshDataInfo._visibility!==t){var r=this._internalAbstractMeshDataInfo._visibility;this._internalAbstractMeshDataInfo._visibility=t,(r===1&&t!==1||r!==1&&t===1)&&this._markSubMeshesAsMiscDirty()}},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"renderingGroupId",{get:function(){return this._internalAbstractMeshDataInfo._renderingGroupId},set:function(t){this._internalAbstractMeshDataInfo._renderingGroupId=t},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"material",{get:function(){return this._internalAbstractMeshDataInfo._material},set:function(t){this._internalAbstractMeshDataInfo._material!==t&&(this._internalAbstractMeshDataInfo._material&&this._internalAbstractMeshDataInfo._material.meshMap&&(this._internalAbstractMeshDataInfo._material.meshMap[this.uniqueId]=void 0),this._internalAbstractMeshDataInfo._material=t,t&&t.meshMap&&(t.meshMap[this.uniqueId]=this),this.onMaterialChangedObservable.hasObservers()&&this.onMaterialChangedObservable.notifyObservers(this),this.subMeshes&&(this.resetDrawCache(),this._unBindEffect()))},enumerable:!1,configurable:!0}),e.prototype.getMaterialForRenderPass=function(t){var r;return(r=this._internalAbstractMeshDataInfo._materialForRenderPass)===null||r===void 0?void 0:r[t]},e.prototype.setMaterialForRenderPass=function(t,r){this._internalAbstractMeshDataInfo._materialForRenderPass||(this._internalAbstractMeshDataInfo._materialForRenderPass=[]),this._internalAbstractMeshDataInfo._materialForRenderPass[t]=r},Object.defineProperty(e.prototype,"receiveShadows",{get:function(){return this._internalAbstractMeshDataInfo._receiveShadows},set:function(t){this._internalAbstractMeshDataInfo._receiveShadows!==t&&(this._internalAbstractMeshDataInfo._receiveShadows=t,this._markSubMeshesAsLightDirty())},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"hasVertexAlpha",{get:function(){return this._internalAbstractMeshDataInfo._hasVertexAlpha},set:function(t){this._internalAbstractMeshDataInfo._hasVertexAlpha!==t&&(this._internalAbstractMeshDataInfo._hasVertexAlpha=t,this._markSubMeshesAsAttributesDirty(),this._markSubMeshesAsMiscDirty())},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"useVertexColors",{get:function(){return this._internalAbstractMeshDataInfo._useVertexColors},set:function(t){this._internalAbstractMeshDataInfo._useVertexColors!==t&&(this._internalAbstractMeshDataInfo._useVertexColors=t,this._markSubMeshesAsAttributesDirty())},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"computeBonesUsingShaders",{get:function(){return this._internalAbstractMeshDataInfo._computeBonesUsingShaders},set:function(t){this._internalAbstractMeshDataInfo._computeBonesUsingShaders!==t&&(this._internalAbstractMeshDataInfo._computeBonesUsingShaders=t,this._markSubMeshesAsAttributesDirty())},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"numBoneInfluencers",{get:function(){return this._internalAbstractMeshDataInfo._numBoneInfluencers},set:function(t){this._internalAbstractMeshDataInfo._numBoneInfluencers!==t&&(this._internalAbstractMeshDataInfo._numBoneInfluencers=t,this._markSubMeshesAsAttributesDirty())},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"applyFog",{get:function(){return this._internalAbstractMeshDataInfo._applyFog},set:function(t){this._internalAbstractMeshDataInfo._applyFog!==t&&(this._internalAbstractMeshDataInfo._applyFog=t,this._markSubMeshesAsMiscDirty())},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"enableDistantPicking",{get:function(){return this._internalAbstractMeshDataInfo._enableDistantPicking},set:function(t){this._internalAbstractMeshDataInfo._enableDistantPicking=t},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"layerMask",{get:function(){return this._internalAbstractMeshDataInfo._layerMask},set:function(t){t!==this._internalAbstractMeshDataInfo._layerMask&&(this._internalAbstractMeshDataInfo._layerMask=t,this._resyncLightSources())},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"collisionMask",{get:function(){return this._internalAbstractMeshDataInfo._meshCollisionData._collisionMask},set:function(t){this._internalAbstractMeshDataInfo._meshCollisionData._collisionMask=isNaN(t)?-1:t},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"collisionResponse",{get:function(){return this._internalAbstractMeshDataInfo._meshCollisionData._collisionResponse},set:function(t){this._internalAbstractMeshDataInfo._meshCollisionData._collisionResponse=t},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"collisionGroup",{get:function(){return this._internalAbstractMeshDataInfo._meshCollisionData._collisionGroup},set:function(t){this._internalAbstractMeshDataInfo._meshCollisionData._collisionGroup=isNaN(t)?-1:t},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"surroundingMeshes",{get:function(){return this._internalAbstractMeshDataInfo._meshCollisionData._surroundingMeshes},set:function(t){this._internalAbstractMeshDataInfo._meshCollisionData._surroundingMeshes=t},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"lightSources",{get:function(){return this._lightSources},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"_positions",{get:function(){return null},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"skeleton",{get:function(){return this._internalAbstractMeshDataInfo._skeleton},set:function(t){var r=this._internalAbstractMeshDataInfo._skeleton;r&&r.needInitialSkinMatrix&&r._unregisterMeshWithPoseMatrix(this),t&&t.needInitialSkinMatrix&&t._registerMeshWithPoseMatrix(this),this._internalAbstractMeshDataInfo._skeleton=t,this._internalAbstractMeshDataInfo._skeleton||(this._bonesTransformMatrices=null),this._markSubMeshesAsAttributesDirty()},enumerable:!1,configurable:!0}),e.prototype._buildUniformLayout=function(){this._uniformBuffer.addUniform("world",16),this._uniformBuffer.addUniform("visibility",1),this._uniformBuffer.create()},e.prototype.transferToEffect=function(t){var r=this._uniformBuffer;r.updateMatrix("world",t),r.updateFloat("visibility",this._internalAbstractMeshDataInfo._visibility),r.update()},e.prototype.getMeshUniformBuffer=function(){return this._uniformBuffer},e.prototype.getClassName=function(){return"AbstractMesh"},e.prototype.toString=function(t){var r="Name: "+this.name+", isInstance: "+(this.getClassName()!=="InstancedMesh"?"YES":"NO");r+=", # of submeshes: "+(this.subMeshes?this.subMeshes.length:0);var n=this._internalAbstractMeshDataInfo._skeleton;return n&&(r+=", skeleton: "+n.name),t&&(r+=", billboard mode: "+["NONE","X","Y",null,"Z",null,null,"ALL"][this.billboardMode],r+=", freeze wrld mat: "+(this._isWorldMatrixFrozen||this._waitingData.freezeWorldMatrix?"YES":"NO")),r},e.prototype._getEffectiveParent=function(){return this._masterMesh&&this.billboardMode!==ht.BILLBOARDMODE_NONE?this._masterMesh:i.prototype._getEffectiveParent.call(this)},e.prototype._getActionManagerForTrigger=function(t,r){if(r===void 0&&(r=!0),this.actionManager&&(r||this.actionManager.isRecursive))if(t){if(this.actionManager.hasSpecificTrigger(t))return this.actionManager}else return this.actionManager;return this.parent?this.parent._getActionManagerForTrigger(t,!1):null},e.prototype._rebuild=function(t){if(this.onRebuildObservable.notifyObservers(this),this._occlusionQuery!==null&&(this._occlusionQuery=null),!!this.subMeshes)for(var r=0,n=this.subMeshes;r<n.length;r++){var a=n[r];a._rebuild()}},e.prototype._resyncLightSources=function(){this._lightSources.length=0;for(var t=0,r=this.getScene().lights;t<r.length;t++){var n=r[t];!n.isEnabled()||n.canAffectMesh(this)&&this._lightSources.push(n)}this._markSubMeshesAsLightDirty()},e.prototype._resyncLightSource=function(t){var r=t.isEnabled()&&t.canAffectMesh(this),n=this._lightSources.indexOf(t),a=!1;if(n===-1){if(!r)return;this._lightSources.push(t)}else{if(r)return;a=!0,this._lightSources.splice(n,1)}this._markSubMeshesAsLightDirty(a)},e.prototype._unBindEffect=function(){for(var t=0,r=this.subMeshes;t<r.length;t++){var n=r[t];n.setEffect(null)}},e.prototype._removeLightSource=function(t,r){var n=this._lightSources.indexOf(t);n!==-1&&(this._lightSources.splice(n,1),this._markSubMeshesAsLightDirty(r))},e.prototype._markSubMeshesAsDirty=function(t){if(!!this.subMeshes)for(var r=0,n=this.subMeshes;r<n.length;r++)for(var a=n[r],s=0;s<a._drawWrappers.length;++s){var o=a._drawWrappers[s];!o||!o.defines||!o.defines.markAllAsDirty||t(o.defines)}},e.prototype._markSubMeshesAsLightDirty=function(t){t===void 0&&(t=!1),this._markSubMeshesAsDirty(function(r){return r.markAsLightDirty(t)})},e.prototype._markSubMeshesAsAttributesDirty=function(){this._markSubMeshesAsDirty(function(t){return t.markAsAttributesDirty()})},e.prototype._markSubMeshesAsMiscDirty=function(){this._markSubMeshesAsDirty(function(t){return t.markAsMiscDirty()})},e.prototype.markAsDirty=function(t){return this._currentRenderId=Number.MAX_VALUE,this._isDirty=!0,this},e.prototype.resetDrawCache=function(t){if(!!this.subMeshes)for(var r=0,n=this.subMeshes;r<n.length;r++){var a=n[r];a.resetDrawCache(t)}},Object.defineProperty(e.prototype,"scaling",{get:function(){return this._scaling},set:function(t){this._scaling=t},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"isBlocked",{get:function(){return!1},enumerable:!1,configurable:!0}),e.prototype.getLOD=function(t){return this},e.prototype.getTotalVertices=function(){return 0},e.prototype.getTotalIndices=function(){return 0},e.prototype.getIndices=function(){return null},e.prototype.getVerticesData=function(t){return null},e.prototype.setVerticesData=function(t,r,n,a){return this},e.prototype.updateVerticesData=function(t,r,n,a){return this},e.prototype.setIndices=function(t,r){return this},e.prototype.isVerticesDataPresent=function(t){return!1},e.prototype.getBoundingInfo=function(){return this._masterMesh?this._masterMesh.getBoundingInfo():(this._boundingInfoIsDirty&&(this._boundingInfoIsDirty=!1,this._updateBoundingInfo()),this._boundingInfo)},e.prototype.setBoundingInfo=function(t){return this._boundingInfo=t,this},Object.defineProperty(e.prototype,"hasBoundingInfo",{get:function(){return this._boundingInfo!==null},enumerable:!1,configurable:!0}),e.prototype.buildBoundingInfo=function(t,r,n){return this._boundingInfo=new lr(t,r,n),this._boundingInfo},e.prototype.normalizeToUnitCube=function(t,r,n){return t===void 0&&(t=!0),r===void 0&&(r=!1),i.prototype.normalizeToUnitCube.call(this,t,r,n)},Object.defineProperty(e.prototype,"useBones",{get:function(){return this.skeleton&&this.getScene().skeletonsEnabled&&this.isVerticesDataPresent(R.MatricesIndicesKind)&&this.isVerticesDataPresent(R.MatricesWeightsKind)},enumerable:!1,configurable:!0}),e.prototype._preActivate=function(){},e.prototype._preActivateForIntermediateRendering=function(t){},e.prototype._activate=function(t,r){return this._renderId=t,!0},e.prototype._postActivate=function(){},e.prototype._freeze=function(){},e.prototype._unFreeze=function(){},e.prototype.getWorldMatrix=function(){return this._masterMesh&&this.billboardMode===ht.BILLBOARDMODE_NONE?this._masterMesh.getWorldMatrix():i.prototype.getWorldMatrix.call(this)},e.prototype._getWorldMatrixDeterminant=function(){return this._masterMesh?this._masterMesh._getWorldMatrixDeterminant():i.prototype._getWorldMatrixDeterminant.call(this)},Object.defineProperty(e.prototype,"isAnInstance",{get:function(){return!1},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"hasInstances",{get:function(){return!1},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"hasThinInstances",{get:function(){return!1},enumerable:!1,configurable:!0}),e.prototype.movePOV=function(t,r,n){return this.position.addInPlace(this.calcMovePOV(t,r,n)),this},e.prototype.calcMovePOV=function(t,r,n){var a=new G,s=this.rotationQuaternion?this.rotationQuaternion:de.RotationYawPitchRoll(this.rotation.y,this.rotation.x,this.rotation.z);s.toRotationMatrix(a);var o=m.Zero(),l=this.definedFacingForward?-1:1;return m.TransformCoordinatesFromFloatsToRef(t*l,r,n*l,a,o),o},e.prototype.rotatePOV=function(t,r,n){return this.rotation.addInPlace(this.calcRotatePOV(t,r,n)),this},e.prototype.calcRotatePOV=function(t,r,n){var a=this.definedFacingForward?1:-1;return new m(t*a,r,n*a)},e.prototype.refreshBoundingInfo=function(t,r){return t===void 0&&(t=!1),r===void 0&&(r=!1),this._boundingInfo&&this._boundingInfo.isLocked?this:(this._refreshBoundingInfo(this._getPositionData(t,r),null),this)},e.prototype._refreshBoundingInfo=function(t,r){if(t){var n=Ha(t,0,this.getTotalVertices(),r);this._boundingInfo?this._boundingInfo.reConstruct(n.minimum,n.maximum):this._boundingInfo=new lr(n.minimum,n.maximum)}if(this.subMeshes)for(var a=0;a<this.subMeshes.length;a++)this.subMeshes[a].refreshBoundingInfo(t);this._updateBoundingInfo()},e.prototype.getPositionData=function(t,r,n){if(n=n!=null?n:this.getVerticesData(R.PositionKind),n&&r&&this.morphTargetManager)for(var a=0,s=0,o=0;o<n.length;o++){for(var l=0;l<this.morphTargetManager.numTargets;l++){var u=this.morphTargetManager.getTarget(l),f=u.influence;if(f>0){var h=u.getPositions();h&&(n[o]+=(h[o]-n[o])*f)}}if(a++,this._positions&&a===3){a=0;var c=s*3;this._positions[s++].copyFromFloats(n[c],n[c+1],n[c+2])}}if(n&&t&&this.skeleton){var d=this.getVerticesData(R.MatricesIndicesKind),p=this.getVerticesData(R.MatricesWeightsKind);if(p&&d)for(var _=this.numBoneInfluencers>4,g=_?this.getVerticesData(R.MatricesIndicesExtraKind):null,v=_?this.getVerticesData(R.MatricesWeightsExtraKind):null,y=this.skeleton.getTransformMatrices(this),b=U.Vector3[0],E=U.Matrix[0],A=U.Matrix[1],S=0,c=0;c<n.length;c+=3,S+=4){E.reset();var T=void 0,M=void 0;for(T=0;T<4;T++)M=p[S+T],M>0&&(G.FromFloat32ArrayToRefScaled(y,Math.floor(d[S+T]*16),M,A),E.addToSelf(A));if(_)for(T=0;T<4;T++)M=v[S+T],M>0&&(G.FromFloat32ArrayToRefScaled(y,Math.floor(g[S+T]*16),M,A),E.addToSelf(A));m.TransformCoordinatesFromFloatsToRef(n[c],n[c+1],n[c+2],E,b),b.toArray(n,c),this._positions&&this._positions[c/3].copyFrom(b)}}return n},e.prototype._getPositionData=function(t,r){var n,a=this.getVerticesData(R.PositionKind);if(this._internalAbstractMeshDataInfo._positions&&(this._internalAbstractMeshDataInfo._positions=null),a&&(t&&this.skeleton||r&&this.morphTargetManager)&&(a=te.Slice(a),this._generatePointsArray(),this._positions)){var s=this._positions;this._internalAbstractMeshDataInfo._positions=new Array(s.length);for(var o=0;o<s.length;o++)this._internalAbstractMeshDataInfo._positions[o]=((n=s[o])===null||n===void 0?void 0:n.clone())||new m}return this.getPositionData(t,r,a)},e.prototype._updateBoundingInfo=function(){return this._boundingInfo?this._boundingInfo.update(this.worldMatrixFromCache):this._boundingInfo=new lr(this.position,this.position,this.worldMatrixFromCache),this._updateSubMeshesBoundingInfo(this.worldMatrixFromCache),this},e.prototype._updateSubMeshesBoundingInfo=function(t){if(!this.subMeshes)return this;for(var r=this.subMeshes.length,n=0;n<r;n++){var a=this.subMeshes[n];(r>1||!a.IsGlobal)&&a.updateBoundingInfo(t)}return this},e.prototype._afterComputeWorldMatrix=function(){this.doNotSyncBoundingInfo||(this._boundingInfoIsDirty=!0)},e.prototype.isInFrustum=function(t){return this.getBoundingInfo().isInFrustum(t,this.cullingStrategy)},e.prototype.isCompletelyInFrustum=function(t){return this.getBoundingInfo().isCompletelyInFrustum(t)},e.prototype.intersectsMesh=function(t,r,n){r===void 0&&(r=!1);var a=this.getBoundingInfo(),s=t.getBoundingInfo();if(a.intersects(s,r))return!0;if(n)for(var o=0,l=this.getChildMeshes();o<l.length;o++){var u=l[o];if(u.intersectsMesh(t,r,!0))return!0}return!1},e.prototype.intersectsPoint=function(t){return this.getBoundingInfo().intersectsPoint(t)},Object.defineProperty(e.prototype,"checkCollisions",{get:function(){return this._internalAbstractMeshDataInfo._meshCollisionData._checkCollisions},set:function(t){this._internalAbstractMeshDataInfo._meshCollisionData._checkCollisions=t},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"collider",{get:function(){return this._internalAbstractMeshDataInfo._meshCollisionData._collider},enumerable:!1,configurable:!0}),e.prototype.moveWithCollisions=function(t){var r=this.getAbsolutePosition();r.addToRef(this.ellipsoidOffset,this._internalAbstractMeshDataInfo._meshCollisionData._oldPositionForCollisions);var n=this.getScene().collisionCoordinator;return this._internalAbstractMeshDataInfo._meshCollisionData._collider||(this._internalAbstractMeshDataInfo._meshCollisionData._collider=n.createCollider()),this._internalAbstractMeshDataInfo._meshCollisionData._collider._radius=this.ellipsoid,n.getNewPosition(this._internalAbstractMeshDataInfo._meshCollisionData._oldPositionForCollisions,t,this._internalAbstractMeshDataInfo._meshCollisionData._collider,this.collisionRetryCount,this,this._onCollisionPositionChange,this.uniqueId),this},e.prototype._collideForSubMesh=function(t,r,n){var a;if(this._generatePointsArray(),!this._positions)return this;if(!t._lastColliderWorldVertices||!t._lastColliderTransformMatrix.equals(r)){t._lastColliderTransformMatrix=r.clone(),t._lastColliderWorldVertices=[],t._trianglePlanes=[];for(var s=t.verticesStart,o=t.verticesStart+t.verticesCount,l=s;l<o;l++)t._lastColliderWorldVertices.push(m.TransformCoordinates(this._positions[l],r))}return n._collide(t._trianglePlanes,t._lastColliderWorldVertices,this.getIndices(),t.indexStart,t.indexStart+t.indexCount,t.verticesStart,!!t.getMaterial(),this,this._shouldConvertRHS(),((a=t.getMaterial())===null||a===void 0?void 0:a.fillMode)===7),this},e.prototype._processCollisionsForSubMeshes=function(t,r){for(var n=this._scene.getCollidingSubMeshCandidates(this,t),a=n.length,s=0;s<a;s++){var o=n.data[s];a>1&&!o._checkCollision(t)||this._collideForSubMesh(o,r,t)}return this},e.prototype._shouldConvertRHS=function(){return!1},e.prototype._checkCollision=function(t){if(!this.getBoundingInfo()._checkCollision(t))return this;var r=U.Matrix[0],n=U.Matrix[1];return G.ScalingToRef(1/t._radius.x,1/t._radius.y,1/t._radius.z,r),this.worldMatrixFromCache.multiplyToRef(r,n),this._processCollisionsForSubMeshes(t,n),this},e.prototype._generatePointsArray=function(){return!1},e.prototype.intersects=function(t,r,n,a,s,o){a===void 0&&(a=!1),o===void 0&&(o=!1);var l=new Et,u=this.getClassName()==="InstancedLinesMesh"||this.getClassName()==="LinesMesh"?this.intersectionThreshold:0,f=this.getBoundingInfo();if(!this.subMeshes||!o&&(!t.intersectsSphere(f.boundingSphere,u)||!t.intersectsBox(f.boundingBox,u)))return l;if(a)return l.hit=!o,l.pickedMesh=o?null:this,l.distance=o?0:m.Distance(t.origin,f.boundingSphere.center),l.subMeshId=0,l;if(!this._generatePointsArray())return l;for(var h=null,c=this._scene.getIntersectingSubMeshCandidates(this,t),d=c.length,p=!1,_=0;_<d;_++){var g=c.data[_],v=g.getMaterial();if(!!v&&(v.fillMode==7||v.fillMode==0||v.fillMode==1||v.fillMode==2||v.fillMode==4)){p=!0;break}}if(!p)return l.hit=!0,l.pickedMesh=this,l.distance=m.Distance(t.origin,f.boundingSphere.center),l.subMeshId=-1,l;for(var _=0;_<d;_++){var g=c.data[_];if(!(d>1&&!g.canIntersects(t))){var y=g.intersects(t,this._positions,this.getIndices(),r,n);if(y&&(r||!h||y.distance<h.distance)&&(h=y,h.subMeshId=_,r))break}}if(h){var b=s!=null?s:this.getWorldMatrix(),E=U.Vector3[0],A=U.Vector3[1];m.TransformCoordinatesToRef(t.origin,b,E),t.direction.scaleToRef(h.distance,A);var S=m.TransformNormal(A,b),T=S.addInPlace(E);return l.hit=!0,l.distance=m.Distance(E,T),l.pickedPoint=T,l.pickedMesh=this,l.bu=h.bu||0,l.bv=h.bv||0,l.subMeshFaceId=h.faceId,l.faceId=h.faceId+c.data[h.subMeshId].indexStart/(this.getClassName().indexOf("LinesMesh")!==-1?2:3),l.subMeshId=h.subMeshId,l}return l},e.prototype.clone=function(t,r,n){return null},e.prototype.releaseSubMeshes=function(){if(this.subMeshes)for(;this.subMeshes.length;)this.subMeshes[0].dispose();else this.subMeshes=new Array;return this},e.prototype.dispose=function(t,r){var n=this;r===void 0&&(r=!1);var a;for(this._scene.useMaterialMeshMap&&this._internalAbstractMeshDataInfo._material&&this._internalAbstractMeshDataInfo._material.meshMap&&(this._internalAbstractMeshDataInfo._material.meshMap[this.uniqueId]=void 0),this.getScene().freeActiveMeshes(),this.getScene().freeRenderingGroups(),this.actionManager!==void 0&&this.actionManager!==null&&(this.actionManager.dispose(),this.actionManager=null),this._internalAbstractMeshDataInfo._skeleton=null,this._transformMatrixTexture&&(this._transformMatrixTexture.dispose(),this._transformMatrixTexture=null),a=0;a<this._intersectionsInProgress.length;a++){var s=this._intersectionsInProgress[a],o=s._intersectionsInProgress.indexOf(this);s._intersectionsInProgress.splice(o,1)}this._intersectionsInProgress=[];var l=this.getScene().lights;l.forEach(function(h){var c=h.includedOnlyMeshes.indexOf(n);c!==-1&&h.includedOnlyMeshes.splice(c,1),c=h.excludedMeshes.indexOf(n),c!==-1&&h.excludedMeshes.splice(c,1);var d=h.getShadowGenerator();if(d){var p=d.getShadowMap();p&&p.renderList&&(c=p.renderList.indexOf(n),c!==-1&&p.renderList.splice(c,1))}}),(this.getClassName()!=="InstancedMesh"||this.getClassName()!=="InstancedLinesMesh")&&this.releaseSubMeshes();var u=this.getScene().getEngine();if(this._occlusionQuery!==null&&(this.isOcclusionQueryInProgress=!1,u.deleteQuery(this._occlusionQuery),this._occlusionQuery=null),u.wipeCaches(),this.getScene().removeMesh(this),this._parentContainer){var f=this._parentContainer.meshes.indexOf(this);f>-1&&this._parentContainer.meshes.splice(f,1),this._parentContainer=null}if(r&&this.material&&(this.material.getClassName()==="MultiMaterial"?this.material.dispose(!1,!0,!0):this.material.dispose(!1,!0)),!t)for(a=0;a<this.getScene().particleSystems.length;a++)this.getScene().particleSystems[a].emitter===this&&(this.getScene().particleSystems[a].dispose(),a--);this._internalAbstractMeshDataInfo._facetData.facetDataEnabled&&this.disableFacetData(),this._uniformBuffer.dispose(),this.onAfterWorldMatrixUpdateObservable.clear(),this.onCollideObservable.clear(),this.onCollisionPositionChangeObservable.clear(),this.onRebuildObservable.clear(),i.prototype.dispose.call(this,t,r)},e.prototype.addChild=function(t,r){return r===void 0&&(r=!1),t.setParent(this,r),this},e.prototype.removeChild=function(t,r){return r===void 0&&(r=!1),t.setParent(null,r),this},e.prototype._initFacetData=function(){var t=this._internalAbstractMeshDataInfo._facetData;t.facetNormals||(t.facetNormals=new Array),t.facetPositions||(t.facetPositions=new Array),t.facetPartitioning||(t.facetPartitioning=new Array),t.facetNb=this.getIndices().length/3|0,t.partitioningSubdivisions=t.partitioningSubdivisions?t.partitioningSubdivisions:10,t.partitioningBBoxRatio=t.partitioningBBoxRatio?t.partitioningBBoxRatio:1.01;for(var r=0;r<t.facetNb;r++)t.facetNormals[r]=m.Zero(),t.facetPositions[r]=m.Zero();return t.facetDataEnabled=!0,this},e.prototype.updateFacetData=function(){var t=this._internalAbstractMeshDataInfo._facetData;t.facetDataEnabled||this._initFacetData();var r=this.getVerticesData(R.PositionKind),n=this.getIndices(),a=this.getVerticesData(R.NormalKind),s=this.getBoundingInfo();if(t.facetDepthSort&&!t.facetDepthSortEnabled){if(t.facetDepthSortEnabled=!0,n instanceof Uint16Array)t.depthSortedIndices=new Uint16Array(n);else if(n instanceof Uint32Array)t.depthSortedIndices=new Uint32Array(n);else{for(var o=!1,l=0;l<n.length;l++)if(n[l]>65535){o=!0;break}o?t.depthSortedIndices=new Uint32Array(n):t.depthSortedIndices=new Uint16Array(n)}if(t.facetDepthSortFunction=function(_,g){return g.sqDistance-_.sqDistance},!t.facetDepthSortFrom){var u=this.getScene().activeCamera;t.facetDepthSortFrom=u?u.position:m.Zero()}t.depthSortedFacets=[];for(var f=0;f<t.facetNb;f++){var h={ind:f*3,sqDistance:0};t.depthSortedFacets.push(h)}t.invertedMatrix=G.Identity(),t.facetDepthSortOrigin=m.Zero()}t.bbSize.x=s.maximum.x-s.minimum.x>Me?s.maximum.x-s.minimum.x:Me,t.bbSize.y=s.maximum.y-s.minimum.y>Me?s.maximum.y-s.minimum.y:Me,t.bbSize.z=s.maximum.z-s.minimum.z>Me?s.maximum.z-s.minimum.z:Me;var c=t.bbSize.x>t.bbSize.y?t.bbSize.x:t.bbSize.y;if(c=c>t.bbSize.z?c:t.bbSize.z,t.subDiv.max=t.partitioningSubdivisions,t.subDiv.X=Math.floor(t.subDiv.max*t.bbSize.x/c),t.subDiv.Y=Math.floor(t.subDiv.max*t.bbSize.y/c),t.subDiv.Z=Math.floor(t.subDiv.max*t.bbSize.z/c),t.subDiv.X=t.subDiv.X<1?1:t.subDiv.X,t.subDiv.Y=t.subDiv.Y<1?1:t.subDiv.Y,t.subDiv.Z=t.subDiv.Z<1?1:t.subDiv.Z,t.facetParameters.facetNormals=this.getFacetLocalNormals(),t.facetParameters.facetPositions=this.getFacetLocalPositions(),t.facetParameters.facetPartitioning=this.getFacetLocalPartitioning(),t.facetParameters.bInfo=s,t.facetParameters.bbSize=t.bbSize,t.facetParameters.subDiv=t.subDiv,t.facetParameters.ratio=this.partitioningBBoxRatio,t.facetParameters.depthSort=t.facetDepthSort,t.facetDepthSort&&t.facetDepthSortEnabled&&(this.computeWorldMatrix(!0),this._worldMatrix.invertToRef(t.invertedMatrix),m.TransformCoordinatesToRef(t.facetDepthSortFrom,t.invertedMatrix,t.facetDepthSortOrigin),t.facetParameters.distanceTo=t.facetDepthSortOrigin),t.facetParameters.depthSortedFacets=t.depthSortedFacets,a&&J.ComputeNormals(r,n,a,t.facetParameters),t.facetDepthSort&&t.facetDepthSortEnabled){t.depthSortedFacets.sort(t.facetDepthSortFunction);for(var d=t.depthSortedIndices.length/3|0,f=0;f<d;f++){var p=t.depthSortedFacets[f].ind;t.depthSortedIndices[f*3]=n[p],t.depthSortedIndices[f*3+1]=n[p+1],t.depthSortedIndices[f*3+2]=n[p+2]}this.updateIndices(t.depthSortedIndices,void 0,!0)}return this},e.prototype.getFacetLocalNormals=function(){var t=this._internalAbstractMeshDataInfo._facetData;return t.facetNormals||this.updateFacetData(),t.facetNormals},e.prototype.getFacetLocalPositions=function(){var t=this._internalAbstractMeshDataInfo._facetData;return t.facetPositions||this.updateFacetData(),t.facetPositions},e.prototype.getFacetLocalPartitioning=function(){var t=this._internalAbstractMeshDataInfo._facetData;return t.facetPartitioning||this.updateFacetData(),t.facetPartitioning},e.prototype.getFacetPosition=function(t){var r=m.Zero();return this.getFacetPositionToRef(t,r),r},e.prototype.getFacetPositionToRef=function(t,r){var n=this.getFacetLocalPositions()[t],a=this.getWorldMatrix();return m.TransformCoordinatesToRef(n,a,r),this},e.prototype.getFacetNormal=function(t){var r=m.Zero();return this.getFacetNormalToRef(t,r),r},e.prototype.getFacetNormalToRef=function(t,r){var n=this.getFacetLocalNormals()[t];return m.TransformNormalToRef(n,this.getWorldMatrix(),r),this},e.prototype.getFacetsAtLocalCoordinates=function(t,r,n){var a=this.getBoundingInfo(),s=this._internalAbstractMeshDataInfo._facetData,o=Math.floor((t-a.minimum.x*s.partitioningBBoxRatio)*s.subDiv.X*s.partitioningBBoxRatio/s.bbSize.x),l=Math.floor((r-a.minimum.y*s.partitioningBBoxRatio)*s.subDiv.Y*s.partitioningBBoxRatio/s.bbSize.y),u=Math.floor((n-a.minimum.z*s.partitioningBBoxRatio)*s.subDiv.Z*s.partitioningBBoxRatio/s.bbSize.z);return o<0||o>s.subDiv.max||l<0||l>s.subDiv.max||u<0||u>s.subDiv.max?null:s.facetPartitioning[o+s.subDiv.max*l+s.subDiv.max*s.subDiv.max*u]},e.prototype.getClosestFacetAtCoordinates=function(t,r,n,a,s,o){s===void 0&&(s=!1),o===void 0&&(o=!0);var l=this.getWorldMatrix(),u=U.Matrix[5];l.invertToRef(u);var f=U.Vector3[8];m.TransformCoordinatesFromFloatsToRef(t,r,n,u,f);var h=this.getClosestFacetAtLocalCoordinates(f.x,f.y,f.z,a,s,o);return a&&m.TransformCoordinatesFromFloatsToRef(a.x,a.y,a.z,l,a),h},e.prototype.getClosestFacetAtLocalCoordinates=function(t,r,n,a,s,o){s===void 0&&(s=!1),o===void 0&&(o=!0);var l=null,u=0,f=0,h=0,c=0,d=0,p=0,_=0,g=0,v=this.getFacetLocalPositions(),y=this.getFacetLocalNormals(),b=this.getFacetsAtLocalCoordinates(t,r,n);if(!b)return null;for(var E=Number.MAX_VALUE,A=E,S,T,M,D=0;D<b.length;D++)S=b[D],T=y[S],M=v[S],c=(t-M.x)*T.x+(r-M.y)*T.y+(n-M.z)*T.z,(!s||s&&o&&c>=0||s&&!o&&c<=0)&&(c=T.x*M.x+T.y*M.y+T.z*M.z,d=-(T.x*t+T.y*r+T.z*n-c)/(T.x*T.x+T.y*T.y+T.z*T.z),p=t+T.x*d,_=r+T.y*d,g=n+T.z*d,u=p-t,f=_-r,h=g-n,A=u*u+f*f+h*h,A<E&&(E=A,l=S,a&&(a.x=p,a.y=_,a.z=g)));return l},e.prototype.getFacetDataParameters=function(){return this._internalAbstractMeshDataInfo._facetData.facetParameters},e.prototype.disableFacetData=function(){var t=this._internalAbstractMeshDataInfo._facetData;return t.facetDataEnabled&&(t.facetDataEnabled=!1,t.facetPositions=new Array,t.facetNormals=new Array,t.facetPartitioning=new Array,t.facetParameters=null,t.depthSortedIndices=new Uint32Array(0)),this},e.prototype.updateIndices=function(t,r,n){return this},e.prototype.createNormals=function(t){var r=this.getVerticesData(R.PositionKind),n=this.getIndices(),a;return this.isVerticesDataPresent(R.NormalKind)?a=this.getVerticesData(R.NormalKind):a=[],J.ComputeNormals(r,n,a,{useRightHandedSystem:this.getScene().useRightHandedSystem}),this.setVerticesData(R.NormalKind,a,t),this},e.prototype.alignWithNormal=function(t,r){r||(r=ei.Y);var n=U.Vector3[0],a=U.Vector3[1];return m.CrossToRef(r,t,a),m.CrossToRef(t,a,n),this.rotationQuaternion?de.RotationQuaternionFromAxisToRef(n,t,a,this.rotationQuaternion):m.RotationFromAxisToRef(n,t,a,this.rotation),this},e.prototype._checkOcclusionQuery=function(){return!1},e.prototype.disableEdgesRendering=function(){throw he("EdgesRenderer")},e.prototype.enableEdgesRendering=function(t,r,n){throw he("EdgesRenderer")},e.prototype.getConnectedParticleSystems=function(){var t=this;return this._scene.particleSystems.filter(function(r){return r.emitter===t})},e.OCCLUSION_TYPE_NONE=0,e.OCCLUSION_TYPE_OPTIMISTIC=1,e.OCCLUSION_TYPE_STRICT=2,e.OCCLUSION_ALGORITHM_TYPE_ACCURATE=0,e.OCCLUSION_ALGORITHM_TYPE_CONSERVATIVE=1,e.CULLINGSTRATEGY_STANDARD=0,e.CULLINGSTRATEGY_BOUNDINGSPHERE_ONLY=1,e.CULLINGSTRATEGY_OPTIMISTIC_INCLUSION=2,e.CULLINGSTRATEGY_OPTIMISTIC_INCLUSION_THEN_BSPHERE_ONLY=3,e}(ht);We("BABYLON.AbstractMesh",ln);var ki=function(i){$(e,i);function e(t,r){var n=i.call(this,t,r,!0)||this;return n._waitingSubMaterialsUniqueIds=[],n.getScene().multiMaterials.push(n),n.subMaterials=new Array,n._storeEffectOnSubMeshes=!0,n}return Object.defineProperty(e.prototype,"subMaterials",{get:function(){return this._subMaterials},set:function(t){this._subMaterials=t,this._hookArray(t)},enumerable:!1,configurable:!0}),e.prototype.getChildren=function(){return this.subMaterials},e.prototype._hookArray=function(t){var r=this,n=t.push;t.push=function(){for(var s=[],o=0;o<arguments.length;o++)s[o]=arguments[o];var l=n.apply(t,s);return r._markAllSubMeshesAsTexturesDirty(),l};var a=t.splice;t.splice=function(s,o){var l=a.apply(t,[s,o]);return r._markAllSubMeshesAsTexturesDirty(),l}},e.prototype.getSubMaterial=function(t){return t<0||t>=this.subMaterials.length?this.getScene().defaultMaterial:this.subMaterials[t]},e.prototype.getActiveTextures=function(){var t;return(t=i.prototype.getActiveTextures.call(this)).concat.apply(t,this.subMaterials.map(function(r){return r?r.getActiveTextures():[]}))},e.prototype.hasTexture=function(t){var r;if(i.prototype.hasTexture.call(this,t))return!0;for(var n=0;n<this.subMaterials.length;n++)if(!((r=this.subMaterials[n])===null||r===void 0)&&r.hasTexture(t))return!0;return!1},e.prototype.getClassName=function(){return"MultiMaterial"},e.prototype.isReadyForSubMesh=function(t,r,n){for(var a=0;a<this.subMaterials.length;a++){var s=this.subMaterials[a];if(s){if(s._storeEffectOnSubMeshes){if(!s.isReadyForSubMesh(t,r,n))return!1;continue}if(!s.isReady(t))return!1}}return!0},e.prototype.clone=function(t,r){for(var n=new e(t,this.getScene()),a=0;a<this.subMaterials.length;a++){var s=null,o=this.subMaterials[a];r&&o?s=o.clone(t+"-"+o.name):s=this.subMaterials[a],n.subMaterials.push(s)}return n},e.prototype.serialize=function(){var t={};t.name=this.name,t.id=this.id,t.uniqueId=this.uniqueId,Le&&(t.tags=Le.GetTags(this)),t.materialsUniqueIds=[],t.materials=[];for(var r=0;r<this.subMaterials.length;r++){var n=this.subMaterials[r];n?(t.materialsUniqueIds.push(n.uniqueId),t.materials.push(n.id)):(t.materialsUniqueIds.push(null),t.materials.push(null))}return t},e.prototype.dispose=function(t,r,n){var a=this.getScene();if(!!a){if(n)for(var s=0;s<this.subMaterials.length;s++){var o=this.subMaterials[s];o&&o.dispose(t,r)}var l=a.multiMaterials.indexOf(this);l>=0&&a.multiMaterials.splice(l,1),i.prototype.dispose.call(this,t,r)}},e.ParseMultiMaterial=function(t,r){var n=new e(t.name,r);return n.id=t.id,n._loadedUniqueId=t.uniqueId,Le&&Le.AddTagsTo(n,t.tags),t.materialsUniqueIds?n._waitingSubMaterialsUniqueIds=t.materialsUniqueIds:t.materials.forEach(function(a){return n.subMaterials.push(r.getLastMaterialById(a))}),n},e}(He);We("BABYLON.MultiMaterial",ki);var El=function(){function i(e,t){this.distanceOrScreenCoverage=e,this.mesh=t}return i}(),Ka=function(){function i(){}return i}(),Al=function(){function i(){this.visibleInstances={},this.batchCache=new Yn,this.batchCacheReplacementModeInFrozenMode=new Yn,this.instancesBufferSize=32*16*4}return i}(),Yn=function(){function i(){this.mustReturn=!1,this.visibleInstances=new Array,this.renderSelf=new Array,this.hardwareInstancedRendering=new Array}return i}(),Sl=function(){function i(){this.instancesCount=0,this.matrixBuffer=null,this.previousMatrixBuffer=null,this.matrixBufferSize=32*16,this.matrixData=null,this.boundingVectors=[],this.worldMatrices=null}return i}(),Rl=function(){function i(){this._areNormalsFrozen=!1,this._source=null,this.meshMap=null,this._preActivateId=-1,this._LODLevels=new Array,this._useLODScreenCoverage=!1,this._effectiveMaterial=null,this._forcedInstanceCount=0}return i}(),O=function(i){$(e,i);function e(t,r,n,a,s,o){r===void 0&&(r=null),n===void 0&&(n=null),a===void 0&&(a=null),o===void 0&&(o=!0);var l=i.call(this,t,r)||this;if(l._internalMeshDataInfo=new Rl,l.delayLoadState=0,l.instances=new Array,l._creationDataStorage=null,l._geometry=null,l._instanceDataStorage=new Al,l._thinInstanceDataStorage=new Sl,l._shouldGenerateFlatShading=!1,l._originalBuilderSideOrientation=e.DEFAULTSIDE,l.overrideMaterialSideOrientation=null,l.ignoreCameraMaxZ=!1,r=l.getScene(),l._onBeforeDraw=function(v,y,b){v&&b&&(l._uniformBuffer?l.transferToEffect(y):b.bindOnlyWorldMatrix(y))},a){if(a._geometry&&a._geometry.applyToMesh(l),dt.DeepCopy(a,l,["name","material","skeleton","instances","parent","uniqueId","source","metadata","morphTargetManager","hasInstances","worldMatrixInstancedBuffer","previousWorldMatrixInstancedBuffer","hasLODLevels","geometry","isBlocked","areNormalsFrozen","facetNb","isFacetDataEnabled","lightSources","useBones","isAnInstance","collider","edgesRenderer","forward","up","right","absolutePosition","absoluteScaling","absoluteRotationQuaternion","isWorldMatrixFrozen","nonUniformScaling","behaviors","worldMatrixFromCache","hasThinInstances","cloneMeshMap","hasBoundingInfo"],["_poseMatrix"]),l._internalMeshDataInfo._source=a,r.useClonedMeshMap&&(a._internalMeshDataInfo.meshMap||(a._internalMeshDataInfo.meshMap={}),a._internalMeshDataInfo.meshMap[l.uniqueId]=l),l._originalBuilderSideOrientation=a._originalBuilderSideOrientation,l._creationDataStorage=a._creationDataStorage,a._ranges){var u=a._ranges;for(var f in u)!Object.prototype.hasOwnProperty.call(u,f)||!u[f]||l.createAnimationRange(f,u[f].from,u[f].to)}if(a.metadata&&a.metadata.clone?l.metadata=a.metadata.clone():l.metadata=a.metadata,Le&&Le.HasTags(a)&&Le.AddTagsTo(l,Le.GetTags(a,!0)),l.setEnabled(a.isEnabled()),l.parent=a.parent,l.setPivotMatrix(a.getPivotMatrix()),l.id=t+"."+a.id,l.material=a.material,!s)for(var h=a.getDescendants(!0),c=0;c<h.length;c++){var d=h[c];d.clone&&d.clone(t+"."+d.name,l)}if(a.morphTargetManager&&(l.morphTargetManager=a.morphTargetManager),r.getPhysicsEngine){var p=r.getPhysicsEngine();if(o&&p){var _=p.getImpostorForPhysicsObject(a);_&&(l.physicsImpostor=_.clone(l))}}for(var c=0;c<r.particleSystems.length;c++){var g=r.particleSystems[c];g.emitter===a&&g.clone(g.name,l)}l.skeleton=a.skeleton,l.refreshBoundingInfo(!0,!0),l.computeWorldMatrix(!0)}return n!==null&&(l.parent=n),l._instanceDataStorage.hardwareInstancedRendering=l.getEngine().getCaps().instancedArrays,l._internalMeshDataInfo._onMeshReadyObserverAdded=function(v){v.unregisterOnNextCall=!0,l.isReady(!0)?l.onMeshReadyObservable.notifyObservers(l):l._internalMeshDataInfo._checkReadinessObserver||(l._internalMeshDataInfo._checkReadinessObserver=l._scene.onBeforeRenderObservable.add(function(){l.isReady(!0)&&(l._scene.onBeforeRenderObservable.remove(l._internalMeshDataInfo._checkReadinessObserver),l._internalMeshDataInfo._checkReadinessObserver=null,l.onMeshReadyObservable.notifyObservers(l))}))},l.onMeshReadyObservable=new X(l._internalMeshDataInfo._onMeshReadyObserverAdded),a&&a.onClonedObservable.notifyObservers(l),l}return e._GetDefaultSideOrientation=function(t){return t||e.FRONTSIDE},Object.defineProperty(e.prototype,"useLODScreenCoverage",{get:function(){return this._internalMeshDataInfo._useLODScreenCoverage},set:function(t){this._internalMeshDataInfo._useLODScreenCoverage=t},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"computeBonesUsingShaders",{get:function(){return this._internalAbstractMeshDataInfo._computeBonesUsingShaders},set:function(t){this._internalAbstractMeshDataInfo._computeBonesUsingShaders!==t&&(t&&this._internalMeshDataInfo._sourcePositions&&(this.setVerticesData(R.PositionKind,this._internalMeshDataInfo._sourcePositions.slice(),!0),this._internalMeshDataInfo._sourceNormals&&this.setVerticesData(R.NormalKind,this._internalMeshDataInfo._sourceNormals.slice(),!0)),this._internalAbstractMeshDataInfo._computeBonesUsingShaders=t,this._markSubMeshesAsAttributesDirty())},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"onBeforeRenderObservable",{get:function(){return this._internalMeshDataInfo._onBeforeRenderObservable||(this._internalMeshDataInfo._onBeforeRenderObservable=new X),this._internalMeshDataInfo._onBeforeRenderObservable},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"onBeforeBindObservable",{get:function(){return this._internalMeshDataInfo._onBeforeBindObservable||(this._internalMeshDataInfo._onBeforeBindObservable=new X),this._internalMeshDataInfo._onBeforeBindObservable},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"onAfterRenderObservable",{get:function(){return this._internalMeshDataInfo._onAfterRenderObservable||(this._internalMeshDataInfo._onAfterRenderObservable=new X),this._internalMeshDataInfo._onAfterRenderObservable},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"onBetweenPassObservable",{get:function(){return this._internalMeshDataInfo._onBetweenPassObservable||(this._internalMeshDataInfo._onBetweenPassObservable=new X),this._internalMeshDataInfo._onBetweenPassObservable},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"onBeforeDrawObservable",{get:function(){return this._internalMeshDataInfo._onBeforeDrawObservable||(this._internalMeshDataInfo._onBeforeDrawObservable=new X),this._internalMeshDataInfo._onBeforeDrawObservable},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"onBeforeDraw",{set:function(t){this._onBeforeDrawObserver&&this.onBeforeDrawObservable.remove(this._onBeforeDrawObserver),this._onBeforeDrawObserver=this.onBeforeDrawObservable.add(t)},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"hasInstances",{get:function(){return this.instances.length>0},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"hasThinInstances",{get:function(){var t;return((t=this._thinInstanceDataStorage.instancesCount)!==null&&t!==void 0?t:0)>0},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"forcedInstanceCount",{get:function(){return this._internalMeshDataInfo._forcedInstanceCount},set:function(t){this._internalMeshDataInfo._forcedInstanceCount=t},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"source",{get:function(){return this._internalMeshDataInfo._source},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"cloneMeshMap",{get:function(){return this._internalMeshDataInfo.meshMap},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"isUnIndexed",{get:function(){return this._unIndexed},set:function(t){this._unIndexed!==t&&(this._unIndexed=t,this._markSubMeshesAsAttributesDirty())},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"worldMatrixInstancedBuffer",{get:function(){return this._instanceDataStorage.instancesData},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"previousWorldMatrixInstancedBuffer",{get:function(){return this._instanceDataStorage.instancesPreviousData},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"manualUpdateOfWorldMatrixInstancedBuffer",{get:function(){return this._instanceDataStorage.manualUpdate},set:function(t){this._instanceDataStorage.manualUpdate=t},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"manualUpdateOfPreviousWorldMatrixInstancedBuffer",{get:function(){return this._instanceDataStorage.previousManualUpdate},set:function(t){this._instanceDataStorage.previousManualUpdate=t},enumerable:!1,configurable:!0}),e.prototype.instantiateHierarchy=function(t,r,n){t===void 0&&(t=null);var a=this.getTotalVertices()>0&&(!r||!r.doNotInstantiate)?this.createInstance("instance of "+(this.name||this.id)):this.clone("Clone of "+(this.name||this.id),t||this.parent,!0);a.parent=t||this.parent,a.position=this.position.clone(),a.scaling=this.scaling.clone(),this.rotationQuaternion?a.rotationQuaternion=this.rotationQuaternion.clone():a.rotation=this.rotation.clone(),n&&n(this,a);for(var s=0,o=this.getChildTransformNodes(!0);s<o.length;s++){var l=o[s];l.instantiateHierarchy(a,r,n)}return a},e.prototype.getClassName=function(){return"Mesh"},Object.defineProperty(e.prototype,"_isMesh",{get:function(){return!0},enumerable:!1,configurable:!0}),e.prototype.toString=function(t){var r=i.prototype.toString.call(this,t);if(r+=", n vertices: "+this.getTotalVertices(),r+=", parent: "+(this._waitingParentId?this._waitingParentId:this.parent?this.parent.name:"NONE"),this.animations)for(var n=0;n<this.animations.length;n++)r+=", animation[0]: "+this.animations[n].toString(t);if(t)if(this._geometry){var a=this.getIndices(),s=this.getVerticesData(R.PositionKind);s&&a&&(r+=", flat shading: "+(s.length/3===a.length?"YES":"NO"))}else r+=", flat shading: UNKNOWN";return r},e.prototype._unBindEffect=function(){i.prototype._unBindEffect.call(this);for(var t=0,r=this.instances;t<r.length;t++){var n=r[t];n._unBindEffect()}},Object.defineProperty(e.prototype,"hasLODLevels",{get:function(){return this._internalMeshDataInfo._LODLevels.length>0},enumerable:!1,configurable:!0}),e.prototype.getLODLevels=function(){return this._internalMeshDataInfo._LODLevels},e.prototype._sortLODLevels=function(){var t=this._internalMeshDataInfo._useLODScreenCoverage?-1:1;this._internalMeshDataInfo._LODLevels.sort(function(r,n){return r.distanceOrScreenCoverage<n.distanceOrScreenCoverage?t:r.distanceOrScreenCoverage>n.distanceOrScreenCoverage?-t:0})},e.prototype.addLODLevel=function(t,r){if(r&&r._masterMesh)return Y.Warn("You cannot use a mesh as LOD level twice"),this;var n=new El(t,r);return this._internalMeshDataInfo._LODLevels.push(n),r&&(r._masterMesh=this),this._sortLODLevels(),this},e.prototype.getLODLevelAtDistance=function(t){for(var r=this._internalMeshDataInfo,n=0;n<r._LODLevels.length;n++){var a=r._LODLevels[n];if(a.distanceOrScreenCoverage===t)return a.mesh}return null},e.prototype.removeLODLevel=function(t){for(var r=this._internalMeshDataInfo,n=0;n<r._LODLevels.length;n++)r._LODLevels[n].mesh===t&&(r._LODLevels.splice(n,1),t&&(t._masterMesh=null));return this._sortLODLevels(),this},e.prototype.getLOD=function(t,r){var n=this._internalMeshDataInfo;if(!n._LODLevels||n._LODLevels.length===0)return this;var a;if(r)a=r;else{var s=this.getBoundingInfo();a=s.boundingSphere}var o=a.centerWorld.subtract(t.globalPosition).length(),l=n._useLODScreenCoverage,u=o,f=1;if(l){var h=t.screenArea,c=a.radiusWorld*t.minZ/o;c=c*c*Math.PI,u=c/h,f=-1}if(f*n._LODLevels[n._LODLevels.length-1].distanceOrScreenCoverage>f*u)return this.onLODLevelSelection&&this.onLODLevelSelection(u,this,this),this;for(var d=0;d<n._LODLevels.length;d++){var p=n._LODLevels[d];if(f*p.distanceOrScreenCoverage<f*u){if(p.mesh){if(p.mesh.delayLoadState===4)return p.mesh._checkDelayState(),this;if(p.mesh.delayLoadState===2)return this;p.mesh._preActivate(),p.mesh._updateSubMeshesBoundingInfo(this.worldMatrixFromCache)}return this.onLODLevelSelection&&this.onLODLevelSelection(u,this,p.mesh),p.mesh}}return this.onLODLevelSelection&&this.onLODLevelSelection(u,this,this),this},Object.defineProperty(e.prototype,"geometry",{get:function(){return this._geometry},enumerable:!1,configurable:!0}),e.prototype.getTotalVertices=function(){return this._geometry===null||this._geometry===void 0?0:this._geometry.getTotalVertices()},e.prototype.getVerticesData=function(t,r,n){var a,s;if(!this._geometry)return null;var o=(s=(a=this._userInstancedBuffersStorage)===null||a===void 0?void 0:a.vertexBuffers[t])===null||s===void 0?void 0:s.getFloatData(this._geometry.getTotalVertices(),n||r&&this._geometry.meshes.length!==1);return o||(o=this._geometry.getVerticesData(t,r,n)),o},e.prototype.getVertexBuffer=function(t){var r,n;return this._geometry?(n=(r=this._userInstancedBuffersStorage)===null||r===void 0?void 0:r.vertexBuffers[t])!==null&&n!==void 0?n:this._geometry.getVertexBuffer(t):null},e.prototype.isVerticesDataPresent=function(t){var r;return this._geometry?((r=this._userInstancedBuffersStorage)===null||r===void 0?void 0:r.vertexBuffers[t])!==void 0||this._geometry.isVerticesDataPresent(t):this._delayInfo?this._delayInfo.indexOf(t)!==-1:!1},e.prototype.isVertexBufferUpdatable=function(t){var r,n;return this._geometry?((n=(r=this._userInstancedBuffersStorage)===null||r===void 0?void 0:r.vertexBuffers[t])===null||n===void 0?void 0:n.isUpdatable())||this._geometry.isVertexBufferUpdatable(t):this._delayInfo?this._delayInfo.indexOf(t)!==-1:!1},e.prototype.getVerticesDataKinds=function(){if(!this._geometry){var t=new Array;return this._delayInfo&&this._delayInfo.forEach(function(a){t.push(a)}),t}var r=this._geometry.getVerticesDataKinds();if(this._userInstancedBuffersStorage)for(var n in this._userInstancedBuffersStorage.vertexBuffers)r.push(n);return r},e.prototype.getTotalIndices=function(){return this._geometry?this._geometry.getTotalIndices():0},e.prototype.getIndices=function(t,r){return this._geometry?this._geometry.getIndices(t,r):[]},Object.defineProperty(e.prototype,"isBlocked",{get:function(){return this._masterMesh!==null&&this._masterMesh!==void 0},enumerable:!1,configurable:!0}),e.prototype.isReady=function(t,r){var n,a,s,o,l,u;if(t===void 0&&(t=!1),r===void 0&&(r=!1),this.delayLoadState===2||!i.prototype.isReady.call(this,t))return!1;if(!this.subMeshes||this.subMeshes.length===0||!t)return!0;var f=this.getEngine(),h=this.getScene(),c=r||f.getCaps().instancedArrays&&(this.instances.length>0||this.hasThinInstances);this.computeWorldMatrix();var d=this.material||h.defaultMaterial;if(d){if(d._storeEffectOnSubMeshes)for(var p=0,_=this.subMeshes;p<_.length;p++){var g=_[p],v=g.getMaterial();if(v){if(v._storeEffectOnSubMeshes){if(!v.isReadyForSubMesh(this,g,c))return!1}else if(!v.isReady(this,c))return!1}}else if(!d.isReady(this,c))return!1}for(var y=f.currentRenderPassId,b=0,E=this.lightSources;b<E.length;b++){var A=E[b],S=A.getShadowGenerator();if(S&&(!(!((n=S.getShadowMap())===null||n===void 0)&&n.renderList)||((a=S.getShadowMap())===null||a===void 0?void 0:a.renderList)&&((o=(s=S.getShadowMap())===null||s===void 0?void 0:s.renderList)===null||o===void 0?void 0:o.indexOf(this))!==-1)){S.getShadowMap()&&(f.currentRenderPassId=S.getShadowMap().renderPassId);for(var T=0,M=this.subMeshes;T<M.length;T++){var g=M[T];if(!S.isReady(g,c,(u=(l=g.getMaterial())===null||l===void 0?void 0:l.needAlphaBlendingForMesh(this))!==null&&u!==void 0?u:!1))return f.currentRenderPassId=y,!1}f.currentRenderPassId=y}}for(var D=0,x=this._internalMeshDataInfo._LODLevels;D<x.length;D++){var P=x[D];if(P.mesh&&!P.mesh.isReady(c))return!1}return!0},Object.defineProperty(e.prototype,"areNormalsFrozen",{get:function(){return this._internalMeshDataInfo._areNormalsFrozen},enumerable:!1,configurable:!0}),e.prototype.freezeNormals=function(){return this._internalMeshDataInfo._areNormalsFrozen=!0,this},e.prototype.unfreezeNormals=function(){return this._internalMeshDataInfo._areNormalsFrozen=!1,this},Object.defineProperty(e.prototype,"overridenInstanceCount",{set:function(t){this._instanceDataStorage.overridenInstanceCount=t},enumerable:!1,configurable:!0}),e.prototype._preActivate=function(){var t=this._internalMeshDataInfo,r=this.getScene().getRenderId();return t._preActivateId===r?this:(t._preActivateId=r,this._instanceDataStorage.visibleInstances=null,this)},e.prototype._preActivateForIntermediateRendering=function(t){return this._instanceDataStorage.visibleInstances&&(this._instanceDataStorage.visibleInstances.intermediateDefaultRenderId=t),this},e.prototype._registerInstanceForRenderId=function(t,r){return this._instanceDataStorage.visibleInstances||(this._instanceDataStorage.visibleInstances={defaultRenderId:r,selfDefaultRenderId:this._renderId}),this._instanceDataStorage.visibleInstances[r]||(this._instanceDataStorage.previousRenderId!==void 0&&this._instanceDataStorage.isFrozen&&(this._instanceDataStorage.visibleInstances[this._instanceDataStorage.previousRenderId]=null),this._instanceDataStorage.previousRenderId=r,this._instanceDataStorage.visibleInstances[r]=new Array),this._instanceDataStorage.visibleInstances[r].push(t),this},e.prototype._afterComputeWorldMatrix=function(){i.prototype._afterComputeWorldMatrix.call(this),this.hasThinInstances&&(this.doNotSyncBoundingInfo||this.thinInstanceRefreshBoundingInfo(!1))},e.prototype._postActivate=function(){this.edgesShareWithInstances&&this.edgesRenderer&&this.edgesRenderer.isEnabled&&this._renderingGroup&&(this._renderingGroup._edgesRenderers.pushNoDuplicate(this.edgesRenderer),this.edgesRenderer.customInstances.push(this.getWorldMatrix()))},e.prototype.refreshBoundingInfo=function(t,r){if(t===void 0&&(t=!1),r===void 0&&(r=!1),this.hasBoundingInfo&&this.getBoundingInfo().isLocked)return this;var n=this.geometry?this.geometry.boundingBias:null;return this._refreshBoundingInfo(this._getPositionData(t,r),n),this},e.prototype._createGlobalSubMesh=function(t){var r=this.getTotalVertices();if(!r||!this.getIndices())return null;if(this.subMeshes&&this.subMeshes.length>0){var n=this.getIndices();if(!n)return null;var a=n.length,s=!1;if(t)s=!0;else for(var o=0,l=this.subMeshes;o<l.length;o++){var u=l[o];if(u.indexStart+u.indexCount>a){s=!0;break}if(u.verticesStart+u.verticesCount>r){s=!0;break}}if(!s)return this.subMeshes[0]}return this.releaseSubMeshes(),new qt(0,0,r,0,this.getTotalIndices(),this)},e.prototype.subdivide=function(t){if(!(t<1)){for(var r=this.getTotalIndices(),n=r/t|0,a=0;n%3!==0;)n++;this.releaseSubMeshes();for(var s=0;s<t&&!(a>=r);s++)qt.CreateFromIndices(0,a,s===t-1?r-a:n,this),a+=n;this.synchronizeInstances()}},e.prototype.setVerticesData=function(t,r,n,a){if(n===void 0&&(n=!1),this._geometry)this._geometry.setVerticesData(t,r,n,a);else{var s=new J;s.set(r,t);var o=this.getScene();new zt(zt.RandomId(),o,s,n,this)}return this},e.prototype.removeVerticesData=function(t){!this._geometry||this._geometry.removeVerticesData(t)},e.prototype.markVerticesDataAsUpdatable=function(t,r){r===void 0&&(r=!0);var n=this.getVertexBuffer(t);!n||n.isUpdatable()===r||this.setVerticesData(t,this.getVerticesData(t),r)},e.prototype.setVerticesBuffer=function(t,r){return r===void 0&&(r=!0),this._geometry||(this._geometry=zt.CreateGeometryForMesh(this)),this._geometry.setVerticesBuffer(t,null,r),this},e.prototype.updateVerticesData=function(t,r,n,a){return this._geometry?(a?(this.makeGeometryUnique(),this.updateVerticesData(t,r,n,!1)):this._geometry.updateVerticesData(t,r,n),this):this},e.prototype.updateMeshPositions=function(t,r){r===void 0&&(r=!0);var n=this.getVerticesData(R.PositionKind);if(!n)return this;if(t(n),this.updateVerticesData(R.PositionKind,n,!1,!1),r){var a=this.getIndices(),s=this.getVerticesData(R.NormalKind);if(!s)return this;J.ComputeNormals(n,a,s),this.updateVerticesData(R.NormalKind,s,!1,!1)}return this},e.prototype.makeGeometryUnique=function(){if(!this._geometry)return this;if(this._geometry.meshes.length===1)return this;var t=this._geometry,r=this._geometry.copy(zt.RandomId());return t.releaseForMesh(this,!0),r.applyToMesh(this),this},e.prototype.setIndices=function(t,r,n){if(r===void 0&&(r=null),n===void 0&&(n=!1),this._geometry)this._geometry.setIndices(t,r,n);else{var a=new J;a.indices=t;var s=this.getScene();new zt(zt.RandomId(),s,a,n,this)}return this},e.prototype.updateIndices=function(t,r,n){return n===void 0&&(n=!1),this._geometry?(this._geometry.updateIndices(t,r,n),this):this},e.prototype.toLeftHanded=function(){return this._geometry?(this._geometry.toLeftHanded(),this):this},e.prototype._bind=function(t,r,n){if(!this._geometry)return this;var a=this.getScene().getEngine();this.morphTargetManager&&this.morphTargetManager.isUsingTextureForTargets&&this.morphTargetManager._bind(r);var s;if(this._unIndexed)s=null;else switch(n){case He.PointFillMode:s=null;break;case He.WireFrameFillMode:s=t._getLinesIndexBuffer(this.getIndices(),a);break;default:case He.TriangleFillMode:s=this._geometry.getIndexBuffer();break}return!this._userInstancedBuffersStorage||this.hasThinInstances?this._geometry._bind(r,s):this._geometry._bind(r,s,this._userInstancedBuffersStorage.vertexBuffers,this._userInstancedBuffersStorage.vertexArrayObjects),this},e.prototype._draw=function(t,r,n){if(!this._geometry||!this._geometry.getVertexBuffers()||!this._unIndexed&&!this._geometry.getIndexBuffer())return this;this._internalMeshDataInfo._onBeforeDrawObservable&&this._internalMeshDataInfo._onBeforeDrawObservable.notifyObservers(this);var a=this.getScene(),s=a.getEngine();return this._unIndexed||r==He.PointFillMode?s.drawArraysType(r,t.verticesStart,t.verticesCount,this.forcedInstanceCount||n):r==He.WireFrameFillMode?s.drawElementsType(r,0,t._linesIndexCount,this.forcedInstanceCount||n):s.drawElementsType(r,t.indexStart,t.indexCount,this.forcedInstanceCount||n),this},e.prototype.registerBeforeRender=function(t){return this.onBeforeRenderObservable.add(t),this},e.prototype.unregisterBeforeRender=function(t){return this.onBeforeRenderObservable.removeCallback(t),this},e.prototype.registerAfterRender=function(t){return this.onAfterRenderObservable.add(t),this},e.prototype.unregisterAfterRender=function(t){return this.onAfterRenderObservable.removeCallback(t),this},e.prototype._getInstancesRenderList=function(t,r){if(r===void 0&&(r=!1),this._instanceDataStorage.isFrozen){if(r)return this._instanceDataStorage.batchCacheReplacementModeInFrozenMode.hardwareInstancedRendering[t]=!1,this._instanceDataStorage.batchCacheReplacementModeInFrozenMode.renderSelf[t]=!0,this._instanceDataStorage.batchCacheReplacementModeInFrozenMode;if(this._instanceDataStorage.previousBatch)return this._instanceDataStorage.previousBatch}var n=this.getScene(),a=n._isInIntermediateRendering(),s=a?this._internalAbstractMeshDataInfo._onlyForInstancesIntermediate:this._internalAbstractMeshDataInfo._onlyForInstances,o=this._instanceDataStorage.batchCache;if(o.mustReturn=!1,o.renderSelf[t]=r||!s&&this.isEnabled()&&this.isVisible,o.visibleInstances[t]=null,this._instanceDataStorage.visibleInstances&&!r){var l=this._instanceDataStorage.visibleInstances,u=n.getRenderId(),f=a?l.intermediateDefaultRenderId:l.defaultRenderId;o.visibleInstances[t]=l[u],!o.visibleInstances[t]&&f&&(o.visibleInstances[t]=l[f])}return o.hardwareInstancedRendering[t]=!r&&this._instanceDataStorage.hardwareInstancedRendering&&o.visibleInstances[t]!==null&&o.visibleInstances[t]!==void 0,this._instanceDataStorage.previousBatch=o,o},e.prototype._renderWithInstances=function(t,r,n,a,s){var o,l=n.visibleInstances[t._id];if(!l)return this;for(var u=this._instanceDataStorage,f=u.instancesBufferSize,h=u.instancesBuffer,c=u.instancesPreviousBuffer,d=l.length+1,p=d*16*4;u.instancesBufferSize<p;)u.instancesBufferSize*=2;(!u.instancesData||f!=u.instancesBufferSize)&&(u.instancesData=new Float32Array(u.instancesBufferSize/4)),(this._scene.needsPreviousWorldMatrices&&!u.instancesPreviousData||f!=u.instancesBufferSize)&&(u.instancesPreviousData=new Float32Array(u.instancesBufferSize/4));var _=0,g=0,v=n.renderSelf[t._id],y=!h||f!==u.instancesBufferSize||this._scene.needsPreviousWorldMatrices&&!u.instancesPreviousBuffer;if(!this._instanceDataStorage.manualUpdate&&(!u.isFrozen||y)){var b=this.getWorldMatrix();if(v&&(this._scene.needsPreviousWorldMatrices&&(u.masterMeshPreviousWorldMatrix?(u.masterMeshPreviousWorldMatrix.copyToArray(u.instancesPreviousData,_),u.masterMeshPreviousWorldMatrix.copyFrom(b)):(u.masterMeshPreviousWorldMatrix=b.clone(),u.masterMeshPreviousWorldMatrix.copyToArray(u.instancesPreviousData,_))),b.copyToArray(u.instancesData,_),_+=16,g++),l){if(e.INSTANCEDMESH_SORT_TRANSPARENT&&this._scene.activeCamera&&((o=t.getMaterial())===null||o===void 0?void 0:o.needAlphaBlendingForMesh(t.getRenderingMesh()))){for(var E=this._scene.activeCamera.globalPosition,A=0;A<l.length;A++){var S=l[A];S._distanceToCamera=m.Distance(S.getBoundingInfo().boundingSphere.centerWorld,E)}l.sort(function(D,x){return D._distanceToCamera>x._distanceToCamera?-1:D._distanceToCamera<x._distanceToCamera?1:0})}for(var A=0;A<l.length;A++){var T=l[A],M=T.getWorldMatrix();M.copyToArray(u.instancesData,_),this._scene.needsPreviousWorldMatrices&&(T._previousWorldMatrix?(T._previousWorldMatrix.copyToArray(u.instancesPreviousData,_),T._previousWorldMatrix.copyFrom(M)):(T._previousWorldMatrix=M.clone(),T._previousWorldMatrix.copyToArray(u.instancesPreviousData,_))),_+=16,g++}}}else g=(v?1:0)+l.length;return y?(h&&h.dispose(),c&&c.dispose(),h=new mr(s,u.instancesData,!0,16,!1,!0),u.instancesBuffer=h,this._userInstancedBuffersStorage||(this._userInstancedBuffersStorage={data:{},vertexBuffers:{},strides:{},sizes:{},vertexArrayObjects:this.getEngine().getCaps().vertexArrayObject?{}:void 0}),this._userInstancedBuffersStorage.vertexBuffers.world0=h.createVertexBuffer("world0",0,4),this._userInstancedBuffersStorage.vertexBuffers.world1=h.createVertexBuffer("world1",4,4),this._userInstancedBuffersStorage.vertexBuffers.world2=h.createVertexBuffer("world2",8,4),this._userInstancedBuffersStorage.vertexBuffers.world3=h.createVertexBuffer("world3",12,4),this._scene.needsPreviousWorldMatrices&&(c=new mr(s,u.instancesPreviousData,!0,16,!1,!0),u.instancesPreviousBuffer=c,this._userInstancedBuffersStorage.vertexBuffers.previousWorld0=c.createVertexBuffer("previousWorld0",0,4),this._userInstancedBuffersStorage.vertexBuffers.previousWorld1=c.createVertexBuffer("previousWorld1",4,4),this._userInstancedBuffersStorage.vertexBuffers.previousWorld2=c.createVertexBuffer("previousWorld2",8,4),this._userInstancedBuffersStorage.vertexBuffers.previousWorld3=c.createVertexBuffer("previousWorld3",12,4)),this._invalidateInstanceVertexArrayObject()):this._instanceDataStorage.isFrozen||(h.updateDirectly(u.instancesData,0,g),this._scene.needsPreviousWorldMatrices&&(!this._instanceDataStorage.manualUpdate||this._instanceDataStorage.previousManualUpdate)&&c.updateDirectly(u.instancesPreviousData,0,g)),this._processInstancedBuffers(l,v),this.getScene()._activeIndices.addCount(t.indexCount*g,!1),s._currentDrawContext&&(s._currentDrawContext.useInstancing=!0),this._bind(t,a,r),this._draw(t,r,g),this._scene.needsPreviousWorldMatrices&&!y&&this._instanceDataStorage.manualUpdate&&!this._instanceDataStorage.isFrozen&&!this._instanceDataStorage.previousManualUpdate&&c.updateDirectly(u.instancesData,0,g),s.unbindInstanceAttributes(),this},e.prototype._renderWithThinInstances=function(t,r,n,a){var s,o,l=(o=(s=this._thinInstanceDataStorage)===null||s===void 0?void 0:s.instancesCount)!==null&&o!==void 0?o:0;this.getScene()._activeIndices.addCount(t.indexCount*l,!1),a._currentDrawContext&&(a._currentDrawContext.useInstancing=!0),this._bind(t,n,r),this._draw(t,r,l),this._scene.needsPreviousWorldMatrices&&!this._thinInstanceDataStorage.previousMatrixData&&this._thinInstanceDataStorage.matrixData&&(this._thinInstanceDataStorage.previousMatrixBuffer?this._thinInstanceDataStorage.previousMatrixBuffer.updateDirectly(this._thinInstanceDataStorage.matrixData,0,l):this._thinInstanceDataStorage.previousMatrixBuffer=this._thinInstanceCreateMatrixBuffer("previousWorld",this._thinInstanceDataStorage.matrixData,!1)),a.unbindInstanceAttributes()},e.prototype._processInstancedBuffers=function(t,r){},e.prototype._processRendering=function(t,r,n,a,s,o,l,u){var f=this.getScene(),h=f.getEngine();if(o&&r.getRenderingMesh().hasThinInstances)return this._renderWithThinInstances(r,a,n,h),this;if(o)this._renderWithInstances(r,a,s,n,h);else{h._currentDrawContext&&(h._currentDrawContext.useInstancing=!1);var c=0;s.renderSelf[r._id]&&(l&&l(!1,t.getWorldMatrix(),u),c++,this._draw(r,a,this._instanceDataStorage.overridenInstanceCount));var d=s.visibleInstances[r._id];if(d){var p=d.length;c+=p;for(var _=0;_<p;_++){var g=d[_],v=g.getWorldMatrix();l&&l(!0,v,u),this._draw(r,a)}}f._activeIndices.addCount(r.indexCount*c,!1)}return this},e.prototype._rebuild=function(t){if(t===void 0&&(t=!1),this._instanceDataStorage.instancesBuffer&&(t&&this._instanceDataStorage.instancesBuffer.dispose(),this._instanceDataStorage.instancesBuffer=null),this._userInstancedBuffersStorage){for(var r in this._userInstancedBuffersStorage.vertexBuffers){var n=this._userInstancedBuffersStorage.vertexBuffers[r];n&&(t&&n.dispose(),this._userInstancedBuffersStorage.vertexBuffers[r]=null)}this._userInstancedBuffersStorage.vertexArrayObjects&&(this._userInstancedBuffersStorage.vertexArrayObjects={})}this._internalMeshDataInfo._effectiveMaterial=null,i.prototype._rebuild.call(this,t)},e.prototype._freeze=function(){if(!!this.subMeshes){for(var t=0;t<this.subMeshes.length;t++)this._getInstancesRenderList(t);this._internalMeshDataInfo._effectiveMaterial=null,this._instanceDataStorage.isFrozen=!0}},e.prototype._unFreeze=function(){this._instanceDataStorage.isFrozen=!1,this._instanceDataStorage.previousBatch=null},e.prototype.render=function(t,r,n){var a,s,o,l=this.getScene();if(this._internalAbstractMeshDataInfo._isActiveIntermediate?this._internalAbstractMeshDataInfo._isActiveIntermediate=!1:this._internalAbstractMeshDataInfo._isActive=!1,this._checkOcclusionQuery()&&!this._occlusionDataStorage.forceRenderingWhenOccluded)return this;var u=this._getInstancesRenderList(t._id,!!n);if(u.mustReturn)return this;if(!this._geometry||!this._geometry.getVertexBuffers()||!this._unIndexed&&!this._geometry.getIndexBuffer())return this;var f=l.getEngine(),h=0,c=null;this.ignoreCameraMaxZ&&l.activeCamera&&!l._isInIntermediateRendering()&&(h=l.activeCamera.maxZ,c=l.activeCamera,l.activeCamera.maxZ=0,l.updateTransformMatrix(!0)),this._internalMeshDataInfo._onBeforeRenderObservable&&this._internalMeshDataInfo._onBeforeRenderObservable.notifyObservers(this);var d=u.hardwareInstancedRendering[t._id]||t.getRenderingMesh().hasThinInstances,p=this._instanceDataStorage,_=t.getMaterial();if(!_)return c&&(c.maxZ=h,l.updateTransformMatrix(!0)),this;if(!p.isFrozen||!this._internalMeshDataInfo._effectiveMaterial||this._internalMeshDataInfo._effectiveMaterial!==_){if(_._storeEffectOnSubMeshes){if(!_.isReadyForSubMesh(this,t,d))return c&&(c.maxZ=h,l.updateTransformMatrix(!0)),this}else if(!_.isReady(this,d))return c&&(c.maxZ=h,l.updateTransformMatrix(!0)),this;this._internalMeshDataInfo._effectiveMaterial=_}else if(_._storeEffectOnSubMeshes&&!(!((a=t.effect)===null||a===void 0)&&a._wasPreviouslyReady)||!_._storeEffectOnSubMeshes&&!(!((s=_.getEffect())===null||s===void 0)&&s._wasPreviouslyReady))return c&&(c.maxZ=h,l.updateTransformMatrix(!0)),this;r&&f.setAlphaMode(this._internalMeshDataInfo._effectiveMaterial.alphaMode);var g;this._internalMeshDataInfo._effectiveMaterial._storeEffectOnSubMeshes?g=t._drawWrapper:g=this._internalMeshDataInfo._effectiveMaterial._getDrawWrapper();for(var v=(o=g==null?void 0:g.effect)!==null&&o!==void 0?o:null,y=0,b=l._beforeRenderingMeshStage;y<b.length;y++){var E=b[y];E.action(this,t,u,v)}if(!g||!v)return c&&(c.maxZ=h,l.updateTransformMatrix(!0)),this;var A=n||this,S;if(!p.isFrozen&&(this._internalMeshDataInfo._effectiveMaterial.backFaceCulling||this.overrideMaterialSideOrientation!==null)){var T=A._getWorldMatrixDeterminant();S=this.overrideMaterialSideOrientation,S==null&&(S=this._internalMeshDataInfo._effectiveMaterial.sideOrientation),T<0&&(S=S===He.ClockWiseSideOrientation?He.CounterClockWiseSideOrientation:He.ClockWiseSideOrientation),p.sideOrientation=S}else S=p.sideOrientation;var M=this._internalMeshDataInfo._effectiveMaterial._preBind(g,S);this._internalMeshDataInfo._effectiveMaterial.forceDepthWrite&&f.setDepthWrite(!0);var D=l.forcePointsCloud?He.PointFillMode:l.forceWireframe?He.WireFrameFillMode:this._internalMeshDataInfo._effectiveMaterial.fillMode;this._internalMeshDataInfo._onBeforeBindObservable&&this._internalMeshDataInfo._onBeforeBindObservable.notifyObservers(this),d||this._bind(t,v,D);var x=this._internalMeshDataInfo._effectiveMaterial,P=A.getWorldMatrix();x._storeEffectOnSubMeshes?x.bindForSubMesh(P,this,t):x.bind(P,this),!x.backFaceCulling&&x.separateCullingPass&&(f.setState(!0,x.zOffset,!1,!M,x.cullBackFaces,x.stencil,x.zOffsetUnits),this._processRendering(this,t,v,D,u,d,this._onBeforeDraw,this._internalMeshDataInfo._effectiveMaterial),f.setState(!0,x.zOffset,!1,M,x.cullBackFaces,x.stencil,x.zOffsetUnits),this._internalMeshDataInfo._onBetweenPassObservable&&this._internalMeshDataInfo._onBetweenPassObservable.notifyObservers(t)),this._processRendering(this,t,v,D,u,d,this._onBeforeDraw,this._internalMeshDataInfo._effectiveMaterial),this._internalMeshDataInfo._effectiveMaterial.unbind();for(var w=0,k=l._afterRenderingMeshStage;w<k.length;w++){var E=k[w];E.action(this,t,u,v)}return this._internalMeshDataInfo._onAfterRenderObservable&&this._internalMeshDataInfo._onAfterRenderObservable.notifyObservers(this),c&&(c.maxZ=h,l.updateTransformMatrix(!0)),this},e.prototype.cleanMatrixWeights=function(){this.isVerticesDataPresent(R.MatricesWeightsKind)&&(this.isVerticesDataPresent(R.MatricesWeightsExtraKind)?this._normalizeSkinWeightsAndExtra():this._normalizeSkinFourWeights())},e.prototype._normalizeSkinFourWeights=function(){for(var t=this.getVerticesData(R.MatricesWeightsKind),r=t.length,n=0;n<r;n+=4){var a=t[n]+t[n+1]+t[n+2]+t[n+3];if(a===0)t[n]=1;else{var s=1/a;t[n]*=s,t[n+1]*=s,t[n+2]*=s,t[n+3]*=s}}this.setVerticesData(R.MatricesWeightsKind,t)},e.prototype._normalizeSkinWeightsAndExtra=function(){for(var t=this.getVerticesData(R.MatricesWeightsExtraKind),r=this.getVerticesData(R.MatricesWeightsKind),n=r.length,a=0;a<n;a+=4){var s=r[a]+r[a+1]+r[a+2]+r[a+3];if(s+=t[a]+t[a+1]+t[a+2]+t[a+3],s===0)r[a]=1;else{var o=1/s;r[a]*=o,r[a+1]*=o,r[a+2]*=o,r[a+3]*=o,t[a]*=o,t[a+1]*=o,t[a+2]*=o,t[a+3]*=o}}this.setVerticesData(R.MatricesWeightsKind,r),this.setVerticesData(R.MatricesWeightsKind,t)},e.prototype.validateSkinning=function(){var t=this.getVerticesData(R.MatricesWeightsExtraKind),r=this.getVerticesData(R.MatricesWeightsKind);if(r===null||this.skeleton==null)return{skinned:!1,valid:!0,report:"not skinned"};for(var n=r.length,a=0,s=0,o=0,l=0,u=t===null?4:8,f=new Array,h=0;h<=u;h++)f[h]=0;for(var c=.001,h=0;h<n;h+=4){for(var d=r[h],p=d,_=p===0?0:1,g=1;g<u;g++){var v=g<4?r[h+g]:t[h+g-4];v>d&&a++,v!==0&&_++,p+=v,d=v}if(f[_]++,_>o&&(o=_),p===0)s++;else{for(var y=1/p,b=0,g=0;g<u;g++)g<4?b+=Math.abs(r[h+g]-r[h+g]*y):b+=Math.abs(t[h+g-4]-t[h+g-4]*y);b>c&&l++}}for(var E=this.skeleton.bones.length,A=this.getVerticesData(R.MatricesIndicesKind),S=this.getVerticesData(R.MatricesIndicesExtraKind),T=0,h=0;h<n;h+=4)for(var g=0;g<u;g++){var M=g<4?A[h+g]:S[h+g-4];(M>=E||M<0)&&T++}var D="Number of Weights = "+n/4+`
Maximum influences = `+o+`
Missing Weights = `+s+`
Not Sorted = `+a+`
Not Normalized = `+l+`
WeightCounts = [`+f+`]
Number of bones = `+E+`
Bad Bone Indices = `+T;return{skinned:!0,valid:s===0&&l===0&&T===0,report:D}},e.prototype._checkDelayState=function(){var t=this.getScene();return this._geometry?this._geometry.load(t):this.delayLoadState===4&&(this.delayLoadState=2,this._queueLoad(t)),this},e.prototype._queueLoad=function(t){var r=this;t._addPendingData(this);var n=this.delayLoadingFile.indexOf(".babylonbinarymeshdata")!==-1;return te.LoadFile(this.delayLoadingFile,function(a){a instanceof ArrayBuffer?r._delayLoadingFunction(a,r):r._delayLoadingFunction(JSON.parse(a),r),r.instances.forEach(function(s){s.refreshBoundingInfo(),s._syncSubMeshes()}),r.delayLoadState=1,t._removePendingData(r)},function(){},t.offlineProvider,n),this},e.prototype.isInFrustum=function(t){return this.delayLoadState===2||!i.prototype.isInFrustum.call(this,t)?!1:(this._checkDelayState(),!0)},e.prototype.setMaterialById=function(t){var r=this.getScene().materials,n;for(n=r.length-1;n>-1;n--)if(r[n].id===t)return this.material=r[n],this;var a=this.getScene().multiMaterials;for(n=a.length-1;n>-1;n--)if(a[n].id===t)return this.material=a[n],this;return this},e.prototype.getAnimatables=function(){var t=new Array;return this.material&&t.push(this.material),this.skeleton&&t.push(this.skeleton),t},e.prototype.bakeTransformIntoVertices=function(t){if(!this.isVerticesDataPresent(R.PositionKind))return this;var r=this.subMeshes.splice(0);this._resetPointsArrayCache();var n=this.getVerticesData(R.PositionKind),a=new Array,s;for(s=0;s<n.length;s+=3)m.TransformCoordinates(m.FromArray(n,s),t).toArray(a,s);if(this.setVerticesData(R.PositionKind,a,this.getVertexBuffer(R.PositionKind).isUpdatable()),this.isVerticesDataPresent(R.NormalKind)){for(n=this.getVerticesData(R.NormalKind),a=[],s=0;s<n.length;s+=3)m.TransformNormal(m.FromArray(n,s),t).normalize().toArray(a,s);this.setVerticesData(R.NormalKind,a,this.getVertexBuffer(R.NormalKind).isUpdatable())}return t.determinant()<0&&this.flipFaces(),this.releaseSubMeshes(),this.subMeshes=r,this},e.prototype.bakeCurrentTransformIntoVertices=function(t){return t===void 0&&(t=!0),this.bakeTransformIntoVertices(this.computeWorldMatrix(!0)),this.resetLocalMatrix(t),this},Object.defineProperty(e.prototype,"_positions",{get:function(){return this._internalAbstractMeshDataInfo._positions?this._internalAbstractMeshDataInfo._positions:this._geometry?this._geometry._positions:null},enumerable:!1,configurable:!0}),e.prototype._resetPointsArrayCache=function(){return this._geometry&&this._geometry._resetPointsArrayCache(),this},e.prototype._generatePointsArray=function(){return this._geometry?this._geometry._generatePointsArray():!1},e.prototype.clone=function(t,r,n,a){return t===void 0&&(t=""),r===void 0&&(r=null),a===void 0&&(a=!0),new e(t,this.getScene(),r,this,n,a)},e.prototype.dispose=function(t,r){r===void 0&&(r=!1),this.morphTargetManager=null,this._geometry&&this._geometry.releaseForMesh(this,!0);var n=this._internalMeshDataInfo;if(n._onBeforeDrawObservable&&n._onBeforeDrawObservable.clear(),n._onBeforeBindObservable&&n._onBeforeBindObservable.clear(),n._onBeforeRenderObservable&&n._onBeforeRenderObservable.clear(),n._onAfterRenderObservable&&n._onAfterRenderObservable.clear(),n._onBetweenPassObservable&&n._onBetweenPassObservable.clear(),this._scene.useClonedMeshMap){if(n.meshMap)for(var a in n.meshMap){var s=n.meshMap[a];s&&(s._internalMeshDataInfo._source=null,n.meshMap[a]=void 0)}n._source&&n._source._internalMeshDataInfo.meshMap&&(n._source._internalMeshDataInfo.meshMap[this.uniqueId]=void 0)}else for(var o=this.getScene().meshes,l=0,u=o;l<u.length;l++){var f=u[l],s=f;s._internalMeshDataInfo&&s._internalMeshDataInfo._source&&s._internalMeshDataInfo._source===this&&(s._internalMeshDataInfo._source=null)}n._source=null,this._disposeInstanceSpecificData(),this._disposeThinInstanceSpecificData(),this._internalMeshDataInfo._checkReadinessObserver&&this._scene.onBeforeRenderObservable.remove(this._internalMeshDataInfo._checkReadinessObserver),i.prototype.dispose.call(this,t,r)},e.prototype._disposeInstanceSpecificData=function(){},e.prototype._disposeThinInstanceSpecificData=function(){},e.prototype._invalidateInstanceVertexArrayObject=function(){},e.prototype.applyDisplacementMap=function(t,r,n,a,s,o,l){var u=this;l===void 0&&(l=!1);var f=this.getScene(),h=function(c){var d=c.width,p=c.height,_=u.getEngine().createCanvas(d,p),g=_.getContext("2d");g.drawImage(c,0,0);var v=g.getImageData(0,0,d,p).data;u.applyDisplacementMapFromBuffer(v,d,p,r,n,s,o,l),a&&a(u)};return te.LoadImage(t,h,function(){},f.offlineProvider),this},e.prototype.applyDisplacementMapFromBuffer=function(t,r,n,a,s,o,l,u){if(u===void 0&&(u=!1),!this.isVerticesDataPresent(R.PositionKind)||!this.isVerticesDataPresent(R.NormalKind)||!this.isVerticesDataPresent(R.UVKind))return Y.Warn("Cannot call applyDisplacementMap: Given mesh is not complete. Position, Normal or UV are missing"),this;var f=this.getVerticesData(R.PositionKind,!0,!0),h=this.getVerticesData(R.NormalKind),c=this.getVerticesData(R.UVKind),d=m.Zero(),p=m.Zero(),_=se.Zero();o=o||se.Zero(),l=l||new se(1,1);for(var g=0;g<f.length;g+=3){m.FromArrayToRef(f,g,d),m.FromArrayToRef(h,g,p),se.FromArrayToRef(c,g/3*2,_);var v=Math.abs(_.x*l.x+o.x%1)*(r-1)%r|0,y=Math.abs(_.y*l.y+o.y%1)*(n-1)%n|0,b=(v+y*r)*4,E=t[b]/255,A=t[b+1]/255,S=t[b+2]/255,T=E*.3+A*.59+S*.11;p.normalize(),p.scaleInPlace(a+(s-a)*T),d=d.add(p),d.toArray(f,g)}return J.ComputeNormals(f,this.getIndices(),h),u?(this.setVerticesData(R.PositionKind,f),this.setVerticesData(R.NormalKind,h),this.setVerticesData(R.UVKind,c)):(this.updateVerticesData(R.PositionKind,f),this.updateVerticesData(R.NormalKind,h)),this},e.prototype.convertToFlatShadedMesh=function(){var t=this.getVerticesDataKinds(),r={},n={},a={},s=!1,o,l;for(o=0;o<t.length;o++){l=t[o];var u=this.getVertexBuffer(l),f=u.getData();if(!((f instanceof Array||f instanceof Float32Array)&&f.length===0)){if(l===R.NormalKind){s=u.isUpdatable(),t.splice(o,1),o--;continue}r[l]=u,n[l]=this.getVerticesData(l),a[l]=[]}}var h=this.subMeshes.slice(0),c=this.getIndices(),d=this.getTotalIndices(),p;for(p=0;p<d;p++){var _=c[p];for(o=0;o<t.length;o++)if(l=t[o],!!r[l])for(var g=r[l].getStrideSize(),v=0;v<g;v++)a[l].push(n[l][_*g+v])}var y=[],b=a[R.PositionKind],E=this.getScene().useRightHandedSystem,A;for(E?A=this.overrideMaterialSideOrientation===1:A=this.overrideMaterialSideOrientation===0,p=0;p<d;p+=3){c[p]=p,c[p+1]=p+1,c[p+2]=p+2;var S=m.FromArray(b,p*3),T=m.FromArray(b,(p+1)*3),M=m.FromArray(b,(p+2)*3),D=S.subtract(T),x=M.subtract(T),P=m.Normalize(m.Cross(D,x));A&&P.scaleInPlace(-1);for(var w=0;w<3;w++)y.push(P.x),y.push(P.y),y.push(P.z)}for(this.setIndices(c),this.setVerticesData(R.NormalKind,y,s),o=0;o<t.length;o++)l=t[o],a[l]&&this.setVerticesData(l,a[l],r[l].isUpdatable());this.releaseSubMeshes();for(var k=0;k<h.length;k++){var B=h[k];qt.AddToMesh(B.materialIndex,B.indexStart,B.indexCount,B.indexStart,B.indexCount,this)}return this.synchronizeInstances(),this},e.prototype.convertToUnIndexedMesh=function(){var t=this.getVerticesDataKinds(),r={},n={},a={},s,o;for(s=0;s<t.length;s++){o=t[s];var l=this.getVertexBuffer(o);r[o]=l,n[o]=r[o].getData(),a[o]=[]}var u=this.subMeshes.slice(0),f=this.getIndices(),h=this.getTotalIndices(),c;for(c=0;c<h;c++){var d=f[c];for(s=0;s<t.length;s++){o=t[s];for(var p=r[o].getStrideSize(),_=0;_<p;_++)a[o].push(n[o][d*p+_])}}for(c=0;c<h;c+=3)f[c]=c,f[c+1]=c+1,f[c+2]=c+2;for(this.setIndices(f),s=0;s<t.length;s++)o=t[s],this.setVerticesData(o,a[o],r[o].isUpdatable());this.releaseSubMeshes();for(var g=0;g<u.length;g++){var v=u[g];qt.AddToMesh(v.materialIndex,v.indexStart,v.indexCount,v.indexStart,v.indexCount,this)}return this._unIndexed=!0,this.synchronizeInstances(),this},e.prototype.flipFaces=function(t){t===void 0&&(t=!1);var r=J.ExtractFromMesh(this),n;if(t&&this.isVerticesDataPresent(R.NormalKind)&&r.normals)for(n=0;n<r.normals.length;n++)r.normals[n]*=-1;if(r.indices){var a=void 0;for(n=0;n<r.indices.length;n+=3)a=r.indices[n+1],r.indices[n+1]=r.indices[n+2],r.indices[n+2]=a}return r.applyToMesh(this,this.isVertexBufferUpdatable(R.PositionKind)),this},e.prototype.increaseVertices=function(t){var r=J.ExtractFromMesh(this),n=r.uvs&&!Array.isArray(r.uvs)&&Array.from?Array.from(r.uvs):r.uvs,a=r.indices&&!Array.isArray(r.indices)&&Array.from?Array.from(r.indices):r.indices,s=r.positions&&!Array.isArray(r.positions)&&Array.from?Array.from(r.positions):r.positions,o=r.normals&&!Array.isArray(r.normals)&&Array.from?Array.from(r.normals):r.normals;if(!a||!s||!o||!n)Y.Warn("VertexData contains null entries");else{r.indices=a,r.positions=s,r.normals=o,r.uvs=n;for(var l=t+1,u=new Array,f=0;f<l+1;f++)u[f]=new Array;for(var h=void 0,c=void 0,d=new m(0,0,0),p=new m(0,0,0),_=new se(0,0),g=new Array,v=new Array,y=new Array,b=void 0,E=s.length,A=n.length,f=0;f<a.length;f+=3){v[0]=a[f],v[1]=a[f+1],v[2]=a[f+2];for(var S=0;S<3;S++)if(h=v[S],c=v[(S+1)%3],y[h]===void 0&&y[c]===void 0?(y[h]=new Array,y[c]=new Array):(y[h]===void 0&&(y[h]=new Array),y[c]===void 0&&(y[c]=new Array)),y[h][c]===void 0&&y[c][h]===void 0){y[h][c]=[],d.x=(s[3*c]-s[3*h])/l,d.y=(s[3*c+1]-s[3*h+1])/l,d.z=(s[3*c+2]-s[3*h+2])/l,p.x=(o[3*c]-o[3*h])/l,p.y=(o[3*c+1]-o[3*h+1])/l,p.z=(o[3*c+2]-o[3*h+2])/l,_.x=(n[2*c]-n[2*h])/l,_.y=(n[2*c+1]-n[2*h+1])/l,y[h][c].push(h);for(var T=1;T<l;T++)y[h][c].push(s.length/3),s[E]=s[3*h]+T*d.x,o[E++]=o[3*h]+T*p.x,s[E]=s[3*h+1]+T*d.y,o[E++]=o[3*h+1]+T*p.y,s[E]=s[3*h+2]+T*d.z,o[E++]=o[3*h+2]+T*p.z,n[A++]=n[2*h]+T*_.x,n[A++]=n[2*h+1]+T*_.y;y[h][c].push(c),y[c][h]=new Array,b=y[h][c].length;for(var M=0;M<b;M++)y[c][h][M]=y[h][c][b-1-M]}u[0][0]=a[f],u[1][0]=y[a[f]][a[f+1]][1],u[1][1]=y[a[f]][a[f+2]][1];for(var T=2;T<l;T++){u[T][0]=y[a[f]][a[f+1]][T],u[T][T]=y[a[f]][a[f+2]][T],d.x=(s[3*u[T][T]]-s[3*u[T][0]])/T,d.y=(s[3*u[T][T]+1]-s[3*u[T][0]+1])/T,d.z=(s[3*u[T][T]+2]-s[3*u[T][0]+2])/T,p.x=(o[3*u[T][T]]-o[3*u[T][0]])/T,p.y=(o[3*u[T][T]+1]-o[3*u[T][0]+1])/T,p.z=(o[3*u[T][T]+2]-o[3*u[T][0]+2])/T,_.x=(n[2*u[T][T]]-n[2*u[T][0]])/T,_.y=(n[2*u[T][T]+1]-n[2*u[T][0]+1])/T;for(var S=1;S<T;S++)u[T][S]=s.length/3,s[E]=s[3*u[T][0]]+S*d.x,o[E++]=o[3*u[T][0]]+S*p.x,s[E]=s[3*u[T][0]+1]+S*d.y,o[E++]=o[3*u[T][0]+1]+S*p.y,s[E]=s[3*u[T][0]+2]+S*d.z,o[E++]=o[3*u[T][0]+2]+S*p.z,n[A++]=n[2*u[T][0]]+S*_.x,n[A++]=n[2*u[T][0]+1]+S*_.y}u[l]=y[a[f+1]][a[f+2]],g.push(u[0][0],u[1][0],u[1][1]);for(var T=1;T<l;T++){var S=void 0;for(S=0;S<T;S++)g.push(u[T][S],u[T+1][S],u[T+1][S+1]),g.push(u[T][S],u[T+1][S+1],u[T][S+1]);g.push(u[T][S],u[T+1][S],u[T+1][S+1])}}r.indices=g,r.applyToMesh(this,this.isVertexBufferUpdatable(R.PositionKind))}},e.prototype.forceSharedVertices=function(){var t=J.ExtractFromMesh(this),r=t.uvs,n=t.indices,a=t.positions,s=t.colors;if(n===void 0||a===void 0||n===null||a===null)Y.Warn("VertexData contains empty entries");else{for(var o=new Array,l=new Array,u=new Array,f=new Array,h=new Array,c=0,d={},p=void 0,_=void 0,g=0;g<n.length;g+=3){_=[n[g],n[g+1],n[g+2]],h=new Array;for(var v=0;v<3;v++){h[v]="";for(var y=0;y<3;y++)Math.abs(a[3*_[v]+y])<1e-8&&(a[3*_[v]+y]=0),h[v]+=a[3*_[v]+y]+"|"}if(!(h[0]==h[1]||h[0]==h[2]||h[1]==h[2]))for(var v=0;v<3;v++){if(p=d[h[v]],p===void 0){d[h[v]]=c,p=c++;for(var y=0;y<3;y++)o.push(a[3*_[v]+y]);if(s!=null)for(var y=0;y<4;y++)f.push(s[4*_[v]+y]);if(r!=null)for(var y=0;y<2;y++)u.push(r[2*_[v]+y])}l.push(p)}}var b=new Array;J.ComputeNormals(o,l,b),t.positions=o,t.indices=l,t.normals=b,r!=null&&(t.uvs=u),s!=null&&(t.colors=f),t.applyToMesh(this,this.isVertexBufferUpdatable(R.PositionKind))}},e._instancedMeshFactory=function(t,r){throw he("InstancedMesh")},e._PhysicsImpostorParser=function(t,r,n){throw he("PhysicsImpostor")},e.prototype.createInstance=function(t){return e._instancedMeshFactory(t,this)},e.prototype.synchronizeInstances=function(){for(var t=0;t<this.instances.length;t++){var r=this.instances[t];r._syncSubMeshes()}return this},e.prototype.optimizeIndices=function(t){var r=this,n=this.getIndices(),a=this.getVerticesData(R.PositionKind);if(!a||!n)return this;for(var s=new Array,o=0;o<a.length;o=o+3)s.push(m.FromArray(a,o));var l=new Array;return Zo.SyncAsyncForLoop(s.length,40,function(u){for(var f=s.length-1-u,h=s[f],c=0;c<f;++c){var d=s[c];if(h.equals(d)){l[f]=c;break}}},function(){for(var u=0;u<n.length;++u)n[u]=l[n[u]]||n[u];var f=r.subMeshes.slice(0);r.setIndices(n),r.subMeshes=f,t&&t(r)}),this},e.prototype.serialize=function(t){t.name=this.name,t.id=this.id,t.uniqueId=this.uniqueId,t.type=this.getClassName(),Le&&Le.HasTags(this)&&(t.tags=Le.GetTags(this)),t.position=this.position.asArray(),this.rotationQuaternion?t.rotationQuaternion=this.rotationQuaternion.asArray():this.rotation&&(t.rotation=this.rotation.asArray()),t.scaling=this.scaling.asArray(),this._postMultiplyPivotMatrix?t.pivotMatrix=this.getPivotMatrix().asArray():t.localMatrix=this.getPivotMatrix().asArray(),t.isEnabled=this.isEnabled(!1),t.isVisible=this.isVisible,t.infiniteDistance=this.infiniteDistance,t.pickable=this.isPickable,t.receiveShadows=this.receiveShadows,t.billboardMode=this.billboardMode,t.visibility=this.visibility,t.checkCollisions=this.checkCollisions,t.isBlocker=this.isBlocker,t.overrideMaterialSideOrientation=this.overrideMaterialSideOrientation,this.parent&&(t.parentId=this.parent.uniqueId),t.isUnIndexed=this.isUnIndexed;var r=this._geometry;if(r&&this.subMeshes){t.geometryUniqueId=r.uniqueId,t.geometryId=r.id,t.subMeshes=[];for(var n=0;n<this.subMeshes.length;n++){var a=this.subMeshes[n];t.subMeshes.push({materialIndex:a.materialIndex,verticesStart:a.verticesStart,verticesCount:a.verticesCount,indexStart:a.indexStart,indexCount:a.indexCount})}}if(this.material?this.material.doNotSerialize||(t.materialUniqueId=this.material.uniqueId,t.materialId=this.material.id):(this.material=null,t.materialUniqueId=this._scene.defaultMaterial.uniqueId,t.materialId=this._scene.defaultMaterial.id),this.morphTargetManager&&(t.morphTargetManagerId=this.morphTargetManager.uniqueId),this.skeleton&&(t.skeletonId=this.skeleton.id,t.numBoneInfluencers=this.numBoneInfluencers),this.getScene()._getComponent(On.NAME_PHYSICSENGINE)){var s=this.getPhysicsImpostor();s&&(t.physicsMass=s.getParam("mass"),t.physicsFriction=s.getParam("friction"),t.physicsRestitution=s.getParam("mass"),t.physicsImpostor=s.type)}this.metadata&&(t.metadata=this.metadata),t.instances=[];for(var o=0;o<this.instances.length;o++){var l=this.instances[o];if(!l.doNotSerialize){var u={name:l.name,id:l.id,isEnabled:l.isEnabled(!1),isVisible:l.isVisible,isPickable:l.isPickable,checkCollisions:l.checkCollisions,position:l.position.asArray(),scaling:l.scaling.asArray()};if(l.parent&&(u.parentId=l.parent.uniqueId),l.rotationQuaternion?u.rotationQuaternion=l.rotationQuaternion.asArray():l.rotation&&(u.rotation=l.rotation.asArray()),this.getScene()._getComponent(On.NAME_PHYSICSENGINE)){var s=l.getPhysicsImpostor();s&&(u.physicsMass=s.getParam("mass"),u.physicsFriction=s.getParam("friction"),u.physicsRestitution=s.getParam("mass"),u.physicsImpostor=s.type)}l.metadata&&(u.metadata=l.metadata),t.instances.push(u),pe.AppendSerializedAnimations(l,u),u.ranges=l.serializeAnimationRanges()}}if(this._thinInstanceDataStorage.instancesCount&&this._thinInstanceDataStorage.matrixData&&(t.thinInstances={instancesCount:this._thinInstanceDataStorage.instancesCount,matrixData:te.SliceToArray(this._thinInstanceDataStorage.matrixData),matrixBufferSize:this._thinInstanceDataStorage.matrixBufferSize,enablePicking:this.thinInstanceEnablePicking},this._userThinInstanceBuffersStorage)){var f={data:{},sizes:{},strides:{}};for(var h in this._userThinInstanceBuffersStorage.data)f.data[h]=te.SliceToArray(this._userThinInstanceBuffersStorage.data[h]),f.sizes[h]=this._userThinInstanceBuffersStorage.sizes[h],f.strides[h]=this._userThinInstanceBuffersStorage.strides[h];t.thinInstances.userThinInstance=f}pe.AppendSerializedAnimations(this,t),t.ranges=this.serializeAnimationRanges(),t.layerMask=this.layerMask,t.alphaIndex=this.alphaIndex,t.hasVertexAlpha=this.hasVertexAlpha,t.overlayAlpha=this.overlayAlpha,t.overlayColor=this.overlayColor.asArray(),t.renderOverlay=this.renderOverlay,t.applyFog=this.applyFog,this.actionManager&&(t.actions=this.actionManager.serialize(this.name))},e.prototype._syncGeometryWithMorphTargetManager=function(){if(!!this.geometry){this._markSubMeshesAsAttributesDirty();var t=this._internalAbstractMeshDataInfo._morphTargetManager;if(t&&t.vertexCount){if(t.vertexCount!==this.getTotalVertices()){Y.Error("Mesh is incompatible with morph targets. Targets and mesh must all have the same vertices count."),this.morphTargetManager=null;return}if(t.isUsingTextureForTargets)return;for(var r=0;r<t.numInfluencers;r++){var n=t.getActiveTarget(r),a=n.getPositions();if(!a){Y.Error("Invalid morph target. Target must have positions.");return}this.geometry.setVerticesData(R.PositionKind+r,a,!1,3);var s=n.getNormals();s&&this.geometry.setVerticesData(R.NormalKind+r,s,!1,3);var o=n.getTangents();o&&this.geometry.setVerticesData(R.TangentKind+r,o,!1,3);var l=n.getUVs();l&&this.geometry.setVerticesData(R.UVKind+"_"+r,l,!1,2)}}else for(var r=0;this.geometry.isVerticesDataPresent(R.PositionKind+r);)this.geometry.removeVerticesData(R.PositionKind+r),this.geometry.isVerticesDataPresent(R.NormalKind+r)&&this.geometry.removeVerticesData(R.NormalKind+r),this.geometry.isVerticesDataPresent(R.TangentKind+r)&&this.geometry.removeVerticesData(R.TangentKind+r),this.geometry.isVerticesDataPresent(R.UVKind+r)&&this.geometry.removeVerticesData(R.UVKind+"_"+r),r++}},e.Parse=function(t,r,n){var a;if(t.type&&t.type==="LinesMesh"?a=e._LinesMeshParser(t,r):t.type&&t.type==="GroundMesh"?a=e._GroundMeshParser(t,r):t.type&&t.type==="GoldbergMesh"?a=e._GoldbergMeshParser(t,r):a=new e(t.name,r),a.id=t.id,Le&&Le.AddTagsTo(a,t.tags),a.position=m.FromArray(t.position),t.metadata!==void 0&&(a.metadata=t.metadata),t.rotationQuaternion?a.rotationQuaternion=de.FromArray(t.rotationQuaternion):t.rotation&&(a.rotation=m.FromArray(t.rotation)),a.scaling=m.FromArray(t.scaling),t.localMatrix?a.setPreTransformMatrix(G.FromArray(t.localMatrix)):t.pivotMatrix&&a.setPivotMatrix(G.FromArray(t.pivotMatrix)),a.setEnabled(t.isEnabled),a.isVisible=t.isVisible,a.infiniteDistance=t.infiniteDistance,a.showBoundingBox=t.showBoundingBox,a.showSubMeshesBoundingBox=t.showSubMeshesBoundingBox,t.applyFog!==void 0&&(a.applyFog=t.applyFog),t.pickable!==void 0&&(a.isPickable=t.pickable),t.alphaIndex!==void 0&&(a.alphaIndex=t.alphaIndex),a.receiveShadows=t.receiveShadows,a.billboardMode=t.billboardMode,t.visibility!==void 0&&(a.visibility=t.visibility),a.checkCollisions=t.checkCollisions,a.overrideMaterialSideOrientation=t.overrideMaterialSideOrientation,t.isBlocker!==void 0&&(a.isBlocker=t.isBlocker),a._shouldGenerateFlatShading=t.useFlatShading,t.freezeWorldMatrix&&(a._waitingData.freezeWorldMatrix=t.freezeWorldMatrix),t.parentId!==void 0&&(a._waitingParentId=t.parentId),t.actions!==void 0&&(a._waitingData.actions=t.actions),t.overlayAlpha!==void 0&&(a.overlayAlpha=t.overlayAlpha),t.overlayColor!==void 0&&(a.overlayColor=me.FromArray(t.overlayColor)),t.renderOverlay!==void 0&&(a.renderOverlay=t.renderOverlay),a.isUnIndexed=!!t.isUnIndexed,a.hasVertexAlpha=t.hasVertexAlpha,t.delayLoadingFile?(a.delayLoadState=4,a.delayLoadingFile=n+t.delayLoadingFile,a.buildBoundingInfo(m.FromArray(t.boundingBoxMinimum),m.FromArray(t.boundingBoxMaximum)),t._binaryInfo&&(a._binaryInfo=t._binaryInfo),a._delayInfo=[],t.hasUVs&&a._delayInfo.push(R.UVKind),t.hasUVs2&&a._delayInfo.push(R.UV2Kind),t.hasUVs3&&a._delayInfo.push(R.UV3Kind),t.hasUVs4&&a._delayInfo.push(R.UV4Kind),t.hasUVs5&&a._delayInfo.push(R.UV5Kind),t.hasUVs6&&a._delayInfo.push(R.UV6Kind),t.hasColors&&a._delayInfo.push(R.ColorKind),t.hasMatricesIndices&&a._delayInfo.push(R.MatricesIndicesKind),t.hasMatricesWeights&&a._delayInfo.push(R.MatricesWeightsKind),a._delayLoadingFunction=zt._ImportGeometry,Mt.ForceFullSceneLoadingForIncremental&&a._checkDelayState()):zt._ImportGeometry(t,a),t.materialUniqueId?a._waitingMaterialId=t.materialUniqueId:t.materialId&&(a._waitingMaterialId=t.materialId),t.morphTargetManagerId>-1&&(a.morphTargetManager=r.getMorphTargetManagerById(t.morphTargetManagerId)),t.skeletonId!==void 0&&t.skeletonId!==null&&(a.skeleton=r.getLastSkeletonById(t.skeletonId),t.numBoneInfluencers&&(a.numBoneInfluencers=t.numBoneInfluencers)),t.animations){for(var s=0;s<t.animations.length;s++){var o=t.animations[s],l=lt("BABYLON.Animation");l&&a.animations.push(l.Parse(o))}ct.ParseAnimationRanges(a,t,r)}if(t.autoAnimate&&r.beginAnimation(a,t.autoAnimateFrom,t.autoAnimateTo,t.autoAnimateLoop,t.autoAnimateSpeed||1),t.layerMask&&!isNaN(t.layerMask)?a.layerMask=Math.abs(parseInt(t.layerMask)):a.layerMask=268435455,t.physicsImpostor&&e._PhysicsImpostorParser(r,a,t),t.lodMeshIds&&(a._waitingData.lods={ids:t.lodMeshIds,distances:t.lodDistances?t.lodDistances:null,coverages:t.lodCoverages?t.lodCoverages:null}),t.instances)for(var u=0;u<t.instances.length;u++){var f=t.instances[u],h=a.createInstance(f.name);if(f.id&&(h.id=f.id),Le&&(f.tags?Le.AddTagsTo(h,f.tags):Le.AddTagsTo(h,t.tags)),h.position=m.FromArray(f.position),f.metadata!==void 0&&(h.metadata=f.metadata),f.parentId!==void 0&&(h._waitingParentId=f.parentId),f.isEnabled!==void 0&&f.isEnabled!==null&&h.setEnabled(f.isEnabled),f.isVisible!==void 0&&f.isVisible!==null&&(h.isVisible=f.isVisible),f.isPickable!==void 0&&f.isPickable!==null&&(h.isPickable=f.isPickable),f.rotationQuaternion?h.rotationQuaternion=de.FromArray(f.rotationQuaternion):f.rotation&&(h.rotation=m.FromArray(f.rotation)),h.scaling=m.FromArray(f.scaling),f.checkCollisions!=null&&f.checkCollisions!=null&&(h.checkCollisions=f.checkCollisions),f.pickable!=null&&f.pickable!=null&&(h.isPickable=f.pickable),f.showBoundingBox!=null&&f.showBoundingBox!=null&&(h.showBoundingBox=f.showBoundingBox),f.showSubMeshesBoundingBox!=null&&f.showSubMeshesBoundingBox!=null&&(h.showSubMeshesBoundingBox=f.showSubMeshesBoundingBox),f.alphaIndex!=null&&f.showSubMeshesBoundingBox!=null&&(h.alphaIndex=f.alphaIndex),f.physicsImpostor&&e._PhysicsImpostorParser(r,h,f),f.animations){for(var s=0;s<f.animations.length;s++){var o=f.animations[s],l=lt("BABYLON.Animation");l&&h.animations.push(l.Parse(o))}ct.ParseAnimationRanges(h,f,r),f.autoAnimate&&r.beginAnimation(h,f.autoAnimateFrom,f.autoAnimateTo,f.autoAnimateLoop,f.autoAnimateSpeed||1)}}if(t.thinInstances){var c=t.thinInstances;if(a.thinInstanceEnablePicking=!!c.enablePicking,c.matrixData?(a.thinInstanceSetBuffer("matrix",new Float32Array(c.matrixData),16,!1),a._thinInstanceDataStorage.matrixBufferSize=c.matrixBufferSize,a._thinInstanceDataStorage.instancesCount=c.instancesCount):a._thinInstanceDataStorage.matrixBufferSize=c.matrixBufferSize,t.thinInstances.userThinInstance){var d=t.thinInstances.userThinInstance;for(var p in d.data)a.thinInstanceSetBuffer(p,new Float32Array(d.data[p]),d.strides[p],!1),a._userThinInstanceBuffersStorage.sizes[p]=d.sizes[p]}}return a},e.prototype.setPositionsForCPUSkinning=function(){var t=this._internalMeshDataInfo;if(!t._sourcePositions){var r=this.getVerticesData(R.PositionKind);if(!r)return t._sourcePositions;t._sourcePositions=new Float32Array(r),this.isVertexBufferUpdatable(R.PositionKind)||this.setVerticesData(R.PositionKind,r,!0)}return t._sourcePositions},e.prototype.setNormalsForCPUSkinning=function(){var t=this._internalMeshDataInfo;if(!t._sourceNormals){var r=this.getVerticesData(R.NormalKind);if(!r)return t._sourceNormals;t._sourceNormals=new Float32Array(r),this.isVertexBufferUpdatable(R.NormalKind)||this.setVerticesData(R.NormalKind,r,!0)}return t._sourceNormals},e.prototype.applySkeleton=function(t){if(!this.geometry)return this;if(this.geometry._softwareSkinningFrameId==this.getScene().getFrameId())return this;if(this.geometry._softwareSkinningFrameId=this.getScene().getFrameId(),!this.isVerticesDataPresent(R.PositionKind))return this;if(!this.isVerticesDataPresent(R.MatricesIndicesKind))return this;if(!this.isVerticesDataPresent(R.MatricesWeightsKind))return this;var r=this.isVerticesDataPresent(R.NormalKind),n=this._internalMeshDataInfo;if(!n._sourcePositions){var a=this.subMeshes.slice();this.setPositionsForCPUSkinning(),this.subMeshes=a}r&&!n._sourceNormals&&this.setNormalsForCPUSkinning();var s=this.getVerticesData(R.PositionKind);if(!s)return this;s instanceof Float32Array||(s=new Float32Array(s));var o=this.getVerticesData(R.NormalKind);if(r){if(!o)return this;o instanceof Float32Array||(o=new Float32Array(o))}var l=this.getVerticesData(R.MatricesIndicesKind),u=this.getVerticesData(R.MatricesWeightsKind);if(!u||!l)return this;for(var f=this.numBoneInfluencers>4,h=f?this.getVerticesData(R.MatricesIndicesExtraKind):null,c=f?this.getVerticesData(R.MatricesWeightsExtraKind):null,d=t.getTransformMatrices(this),p=m.Zero(),_=new G,g=new G,v=0,y,b=0;b<s.length;b+=3,v+=4){var E=void 0;for(y=0;y<4;y++)E=u[v+y],E>0&&(G.FromFloat32ArrayToRefScaled(d,Math.floor(l[v+y]*16),E,g),_.addToSelf(g));if(f)for(y=0;y<4;y++)E=c[v+y],E>0&&(G.FromFloat32ArrayToRefScaled(d,Math.floor(h[v+y]*16),E,g),_.addToSelf(g));m.TransformCoordinatesFromFloatsToRef(n._sourcePositions[b],n._sourcePositions[b+1],n._sourcePositions[b+2],_,p),p.toArray(s,b),r&&(m.TransformNormalFromFloatsToRef(n._sourceNormals[b],n._sourceNormals[b+1],n._sourceNormals[b+2],_,p),p.toArray(o,b)),_.reset()}return this.updateVerticesData(R.PositionKind,s),r&&this.updateVerticesData(R.NormalKind,o),this},e.MinMax=function(t){var r=null,n=null;return t.forEach(function(a){var s=a.getBoundingInfo(),o=s.boundingBox;!r||!n?(r=o.minimumWorld,n=o.maximumWorld):(r.minimizeInPlace(o.minimumWorld),n.maximizeInPlace(o.maximumWorld))}),!r||!n?{min:m.Zero(),max:m.Zero()}:{min:r,max:n}},e.Center=function(t){var r=t instanceof Array?e.MinMax(t):t;return m.Center(r.min,r.max)},e.MergeMeshes=function(t,r,n,a,s,o){return r===void 0&&(r=!0),on(e._MergeMeshesCoroutine(t,r,n,a,s,o,!1))},e.MergeMeshesAsync=function(t,r,n,a,s,o){return r===void 0&&(r=!0),ja(e._MergeMeshesCoroutine(t,r,n,a,s,o,!0),pl())},e._MergeMeshesCoroutine=function(t,r,n,a,s,o,l){var u,f,h,c,d,p,_,g,F,F,F,v,y,b,E,A,S,T,M,D,x,P,w,k,B,L,H,W,F;return r===void 0&&(r=!0),gr(this,function(V){switch(V.label){case 0:if(t=t.filter(Boolean),t.length===0)return[2,null];if(!n){for(f=0,u=0;u<t.length;u++)if(f+=t[u].getTotalVertices(),f>=65536)return Y.Warn("Cannot merge meshes because resulting mesh will have more than 65536 vertices. Please use allow32BitsIndices = true to use 32 bits indices"),[2,null]}for(o&&(s=!1),h=new Array,c=new Array,d=new Array,u=0;u<t.length;u++){if(p=t[u],p.isAnInstance)return Y.Warn("Cannot merge instance meshes."),[2,null];if(s&&d.push(p.getTotalIndices()),o)if(p.material)if(_=p.material,_ instanceof ki){for(g=0;g<_.subMaterials.length;g++)h.indexOf(_.subMaterials[g])<0&&h.push(_.subMaterials[g]);for(F=0;F<p.subMeshes.length;F++)c.push(h.indexOf(_.subMaterials[p.subMeshes[F].materialIndex])),d.push(p.subMeshes[F].indexCount)}else for(h.indexOf(_)<0&&h.push(_),F=0;F<p.subMeshes.length;F++)c.push(h.indexOf(_)),d.push(p.subMeshes[F].indexCount);else for(F=0;F<p.subMeshes.length;F++)c.push(0),d.push(p.subMeshes[F].indexCount)}return v=t[0],y=function(z){var N=z.computeWorldMatrix(!0),Q=J.ExtractFromMesh(z,!1,!1);return[Q,N]},b=y(v),E=b[0],A=b[1],l?[4]:[3,2];case 1:V.sent(),V.label=2;case 2:S=new Array(t.length-1),T=1,V.label=3;case 3:return T<t.length?(S[T-1]=y(t[T]),l?[4]:[3,5]):[3,6];case 4:V.sent(),V.label=5;case 5:return T++,[3,3];case 6:M=E._mergeCoroutine(A,S,n,l,!r),D=M.next(),V.label=7;case 7:return D.done?[3,10]:l?[4]:[3,9];case 8:V.sent(),V.label=9;case 9:return D=M.next(),[3,7];case 10:x=D.value,a||(a=new e(v.name+"_merged",v.getScene())),P=x._applyToCoroutine(a,void 0,l),w=P.next(),V.label=11;case 11:return w.done?[3,14]:l?[4]:[3,13];case 12:V.sent(),V.label=13;case 13:return w=P.next(),[3,11];case 14:if(a.checkCollisions=v.checkCollisions,r)for(u=0;u<t.length;u++)t[u].dispose();if(s||o){for(a.releaseSubMeshes(),u=0,k=0;u<d.length;)qt.CreateFromIndices(0,k,d[u],a,void 0,!1),k+=d[u],u++;for(B=0,L=a.subMeshes;B<L.length;B++)H=L[B],H.refreshBoundingInfo();a.computeWorldMatrix(!0)}if(o){for(W=new ki(v.name+"_merged",v.getScene()),W.subMaterials=h,F=0;F<a.subMeshes.length;F++)a.subMeshes[F].materialIndex=c[F];a.material=W}else a.material=v.material;return[2,a]}})},e.prototype.addInstance=function(t){t._indexInSourceMeshInstanceArray=this.instances.length,this.instances.push(t)},e.prototype.removeInstance=function(t){var r=t._indexInSourceMeshInstanceArray;if(r!=-1){if(r!==this.instances.length-1){var n=this.instances[this.instances.length-1];this.instances[r]=n,n._indexInSourceMeshInstanceArray=r}t._indexInSourceMeshInstanceArray=-1,this.instances.pop()}},e.prototype._shouldConvertRHS=function(){return this.overrideMaterialSideOrientation===He.CounterClockWiseSideOrientation},e.FRONTSIDE=J.FRONTSIDE,e.BACKSIDE=J.BACKSIDE,e.DOUBLESIDE=J.DOUBLESIDE,e.DEFAULTSIDE=J.DEFAULTSIDE,e.NO_CAP=0,e.CAP_START=1,e.CAP_END=2,e.CAP_ALL=3,e.NO_FLIP=0,e.FLIP_TILE=1,e.ROTATE_TILE=2,e.FLIP_ROW=3,e.ROTATE_ROW=4,e.FLIP_N_ROTATE_TILE=5,e.FLIP_N_ROTATE_ROW=6,e.CENTER=0,e.LEFT=1,e.RIGHT=2,e.TOP=3,e.BOTTOM=4,e.INSTANCEDMESH_SORT_TRANSPARENT=!1,e._GroundMeshParser=function(t,r){throw he("GroundMesh")},e._GoldbergMeshParser=function(t,r){throw he("GoldbergMesh")},e._LinesMeshParser=function(t,r){throw he("LinesMesh")},e}(ln);We("BABYLON.Mesh",O);O.prototype.setMaterialByID=function(i){return this.setMaterialById(i)};O.CreateDisc=O.CreateDisc||function(){throw new Error("Import MeshBuilder to populate this function")};O.CreateBox=O.CreateBox||function(){throw new Error("Import MeshBuilder to populate this function")};O.CreateSphere=O.CreateSphere||function(){throw new Error("Import MeshBuilder to populate this function")};O.CreateCylinder=O.CreateCylinder||function(){throw new Error("Import MeshBuilder to populate this function")};O.CreateTorusKnot=O.CreateTorusKnot||function(){throw new Error("Import MeshBuilder to populate this function")};O.CreateTorus=O.CreateTorus||function(){throw new Error("Import MeshBuilder to populate this function")};O.CreatePlane=O.CreatePlane||function(){throw new Error("Import MeshBuilder to populate this function")};O.CreateGround=O.CreateGround||function(){throw new Error("Import MeshBuilder to populate this function")};O.CreateTiledGround=O.CreateTiledGround||function(){throw new Error("Import MeshBuilder to populate this function")};O.CreateGroundFromHeightMap=O.CreateGroundFromHeightMap||function(){throw new Error("Import MeshBuilder to populate this function")};O.CreateTube=O.CreateTube||function(){throw new Error("Import MeshBuilder to populate this function")};O.CreatePolyhedron=O.CreatePolyhedron||function(){throw new Error("Import MeshBuilder to populate this function")};O.CreateIcoSphere=O.CreateIcoSphere||function(){throw new Error("Import MeshBuilder to populate this function")};O.CreateDecal=O.CreateDecal||function(){throw new Error("Import MeshBuilder to populate this function")};O.CreateCapsule=O.CreateCapsule||function(){throw new Error("Import MeshBuilder to populate this function")};O.ExtendToGoldberg=O.ExtendToGoldberg||function(){throw new Error("Import MeshBuilder to populate this function")};function Ya(i){var e=i.pathArray,t=i.closeArray||!1,r=i.closePath||!1,n=i.invertUV||!1,a=Math.floor(e[0].length/2),s=i.offset||a;s=s>a?a:Math.floor(s);var o=i.sideOrientation===0?0:i.sideOrientation||J.DEFAULTSIDE,l=i.uvs,u=i.colors,f=[],h=[],c=[],d=[],p=[],_=[],g=[],v=[],y,b=[],E=[],A,S,T;if(e.length<2){var M=[],D=[];for(S=0;S<e[0].length-s;S++)M.push(e[0][S]),D.push(e[0][S+s]);e=[M,D]}var x=0,P=r?1:0,w,k;y=e[0].length;var B,L;for(A=0;A<e.length;A++){for(g[A]=0,p[A]=[0],w=e[A],k=w.length,y=y<k?y:k,T=0;T<k;)f.push(w[T].x,w[T].y,w[T].z),T>0&&(B=w[T].subtract(w[T-1]).length(),L=B+g[A],p[A].push(L),g[A]=L),T++;r&&(T--,f.push(w[0].x,w[0].y,w[0].z),B=w[T].subtract(w[0]).length(),L=B+g[A],p[A].push(L),g[A]=L),b[A]=k+P,E[A]=x,x+=k+P}var H,W,F=null,V=null;for(S=0;S<y+P;S++){for(v[S]=0,_[S]=[0],A=0;A<e.length-1;A++)H=e[A],W=e[A+1],S===y?(F=H[0],V=W[0]):(F=H[S],V=W[S]),B=V.subtract(F).length(),L=B+v[S],_[S].push(L),v[S]=L;t&&V&&F&&(H=e[A],W=e[0],S===y&&(V=W[0]),B=V.subtract(F).length(),L=B+v[S],v[S]=L)}var z,N;if(l)for(A=0;A<l.length;A++)d.push(l[A].x,Se.UseOpenGLOrientationForUV?1-l[A].y:l[A].y);else for(A=0;A<e.length;A++)for(S=0;S<y+P;S++)z=g[A]!=0?p[A][S]/g[A]:0,N=v[S]!=0?_[S][A]/v[S]:0,n?d.push(N,z):d.push(z,Se.UseOpenGLOrientationForUV?1-N:N);A=0;for(var Q=0,Z=b[A]-1,ee=b[A+1]-1,ne=Z<ee?Z:ee,Te=E[1]-E[0],j=t?b.length:b.length-1;Q<=ne&&A<j;)h.push(Q,Q+Te,Q+1),h.push(Q+Te+1,Q+1,Q+Te),Q+=1,Q===ne&&(A++,A===b.length-1?(Te=E[0]-E[A],Z=b[A]-1,ee=b[0]-1):(Te=E[A+1]-E[A],Z=b[A]-1,ee=b[A+1]-1),Q=E[A],ne=Z<ee?Z+Q:ee+Q);if(J.ComputeNormals(f,h,c),r){var oe=0,be=0;for(A=0;A<e.length;A++)oe=E[A]*3,A+1<e.length?be=(E[A+1]-1)*3:be=c.length-3,c[oe]=(c[oe]+c[be])*.5,c[oe+1]=(c[oe+1]+c[be+1])*.5,c[oe+2]=(c[oe+2]+c[be+2])*.5,c[be]=c[oe],c[be+1]=c[oe+1],c[be+2]=c[oe+2]}J._ComputeSides(o,f,h,c,d,i.frontUVs,i.backUVs);var Ee=null;if(u){Ee=new Float32Array(u.length*4);for(var Pe=0;Pe<u.length;Pe++)Ee[Pe*4]=u[Pe].r,Ee[Pe*4+1]=u[Pe].g,Ee[Pe*4+2]=u[Pe].b,Ee[Pe*4+3]=u[Pe].a}var Fe=new J,Ae=new Float32Array(f),xe=new Float32Array(c),_e=new Float32Array(d);return Fe.indices=h,Fe.positions=Ae,Fe.normals=xe,Fe.uvs=_e,Ee&&Fe.set(Ee,R.ColorKind),r&&(Fe._idx=E),Fe}function hr(i,e,t){t===void 0&&(t=null);var r=e.pathArray,n=e.closeArray,a=e.closePath,s=O._GetDefaultSideOrientation(e.sideOrientation),o=e.instance,l=e.updatable;if(o){var u=U.Vector3[0].setAll(Number.MAX_VALUE),f=U.Vector3[1].setAll(-Number.MAX_VALUE),h=function(P){for(var w=r[0].length,k=o,B=0,L=k._originalBuilderSideOrientation===O.DOUBLESIDE?2:1,H=1;H<=L;++H)for(var W=0;W<r.length;++W){var F=r[W],V=F.length;w=w<V?w:V;for(var z=0;z<w;++z){var N=F[z];P[B]=N.x,P[B+1]=N.y,P[B+2]=N.z,u.minimizeInPlaceFromFloats(N.x,N.y,N.z),f.maximizeInPlaceFromFloats(N.x,N.y,N.z),B+=3}if(k._creationDataStorage&&k._creationDataStorage.closePath){var N=F[0];P[B]=N.x,P[B+1]=N.y,P[B+2]=N.z,B+=3}}},c=o.getVerticesData(R.PositionKind);if(h(c),o.hasBoundingInfo?o.getBoundingInfo().reConstruct(u,f,o._worldMatrix):o.buildBoundingInfo(u,f,o._worldMatrix),o.updateVerticesData(R.PositionKind,c,!1,!1),e.colors){for(var d=o.getVerticesData(R.ColorKind),p=0,_=0;p<e.colors.length;p++,_+=4){var g=e.colors[p];d[_]=g.r,d[_+1]=g.g,d[_+2]=g.b,d[_+3]=g.a}o.updateVerticesData(R.ColorKind,d,!1,!1)}if(e.uvs){for(var v=o.getVerticesData(R.UVKind),y=0;y<e.uvs.length;y++)v[y*2]=e.uvs[y].x,v[y*2+1]=Se.UseOpenGLOrientationForUV?1-e.uvs[y].y:e.uvs[y].y;o.updateVerticesData(R.UVKind,v,!1,!1)}if(!o.areNormalsFrozen||o.isFacetDataEnabled){var b=o.getIndices(),E=o.getVerticesData(R.NormalKind),A=o.isFacetDataEnabled?o.getFacetDataParameters():null;if(J.ComputeNormals(c,b,E,A),o._creationDataStorage&&o._creationDataStorage.closePath)for(var S=0,T=0,M=0;M<r.length;M++)S=o._creationDataStorage.idx[M]*3,M+1<r.length?T=(o._creationDataStorage.idx[M+1]-1)*3:T=E.length-3,E[S]=(E[S]+E[T])*.5,E[S+1]=(E[S+1]+E[T+1])*.5,E[S+2]=(E[S+2]+E[T+2])*.5,E[T]=E[S],E[T+1]=E[S+1],E[T+2]=E[S+2];o.areNormalsFrozen||o.updateVerticesData(R.NormalKind,E,!1,!1)}return o}else{var D=new O(i,t);D._originalBuilderSideOrientation=s,D._creationDataStorage=new Ka;var x=Ya(e);return a&&(D._creationDataStorage.idx=x._idx),D._creationDataStorage.closePath=a,D._creationDataStorage.closeArray=n,x.applyToMesh(D,l),D}}J.CreateRibbon=Ya;O.CreateRibbon=function(i,e,t,r,n,a,s,o,l){return t===void 0&&(t=!1),s===void 0&&(s=!1),hr(i,{pathArray:e,closeArray:t,closePath:r,offset:n,updatable:s,sideOrientation:o,instance:l},a)};function qa(i){var e=new Array,t=new Array,r=new Array,n=new Array,a=i.radius||.5,s=i.tessellation||64,o=i.arc&&(i.arc<=0||i.arc>1)?1:i.arc||1,l=i.sideOrientation===0?0:i.sideOrientation||J.DEFAULTSIDE;e.push(0,0,0),n.push(.5,.5);for(var u=Math.PI*2*o,f=o===1?u/s:u/(s-1),h=0,c=0;c<s;c++){var d=Math.cos(h),p=Math.sin(h),_=(d+1)/2,g=(1-p)/2;e.push(a*d,a*p,0),n.push(_,Se.UseOpenGLOrientationForUV?1-g:g),h+=f}o===1&&(e.push(e[3],e[4],e[5]),n.push(n[2],Se.UseOpenGLOrientationForUV?1-n[3]:n[3]));for(var v=e.length/3,y=1;y<v-1;y++)t.push(y+1,0,y);J.ComputeNormals(e,t,r),J._ComputeSides(l,e,t,r,n,i.frontUVs,i.backUVs);var b=new J;return b.indices=t,b.positions=e,b.normals=r,b.uvs=n,b}function Za(i,e,t){e===void 0&&(e={}),t===void 0&&(t=null);var r=new O(i,t);e.sideOrientation=O._GetDefaultSideOrientation(e.sideOrientation),r._originalBuilderSideOrientation=e.sideOrientation;var n=qa(e);return n.applyToMesh(r,e.updatable),r}J.CreateDisc=qa;O.CreateDisc=function(i,e,t,r,n,a){r===void 0&&(r=null);var s={radius:e,tessellation:t,sideOrientation:a,updatable:n};return Za(i,s,r)};function Qa(i){var e=6,t=[0,1,2,0,2,3,4,5,6,4,6,7,8,9,10,8,10,11,12,13,14,12,14,15,16,17,18,16,18,19,20,21,22,20,22,23],r=[0,0,1,0,0,1,0,0,1,0,0,1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,1,0,0,1,0,0,1,0,0,1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,0,1,0,0,1,0,0,1,0,0,1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0],n=[],a=[],s=i.width||i.size||1,o=i.height||i.size||1,l=i.depth||i.size||1,u=i.wrap||!1,f=i.topBaseAt===void 0?1:i.topBaseAt,h=i.bottomBaseAt===void 0?0:i.bottomBaseAt;f=(f+4)%4,h=(h+4)%4;var c=[2,0,3,1],d=[2,0,1,3],p=c[f],_=d[h],g=[1,-1,1,-1,-1,1,-1,1,1,1,1,1,1,1,-1,-1,1,-1,-1,-1,-1,1,-1,-1,1,1,-1,1,-1,-1,1,-1,1,1,1,1,-1,1,1,-1,-1,1,-1,-1,-1,-1,1,-1,-1,1,1,-1,1,-1,1,1,-1,1,1,1,1,-1,1,1,-1,-1,-1,-1,-1,-1,-1,1];if(u){t=[2,3,0,2,0,1,4,5,6,4,6,7,9,10,11,9,11,8,12,14,15,12,13,14],g=[-1,1,1,1,1,1,1,-1,1,-1,-1,1,1,1,-1,-1,1,-1,-1,-1,-1,1,-1,-1,1,1,1,1,1,-1,1,-1,-1,1,-1,1,-1,1,-1,-1,1,1,-1,-1,1,-1,-1,-1];for(var v=[[1,1,1],[-1,1,1],[-1,1,-1],[1,1,-1]],y=[[-1,-1,1],[1,-1,1],[1,-1,-1],[-1,-1,-1]],b=[17,18,19,16],E=[22,23,20,21];p>0;)v.unshift(v.pop()),b.unshift(b.pop()),p--;for(;_>0;)y.unshift(y.pop()),E.unshift(E.pop()),_--;v=v.flat(),y=y.flat(),g=g.concat(v).concat(y),t.push(b[0],b[2],b[3],b[0],b[1],b[2]),t.push(E[0],E[2],E[3],E[0],E[1],E[2])}var A=[s/2,o/2,l/2];a=g.reduce(function(L,H,W){return L.concat(H*A[W%3])},[]);for(var S=i.sideOrientation===0?0:i.sideOrientation||J.DEFAULTSIDE,T=i.faceUV||new Array(6),M=i.faceColors,D=[],x=0;x<6;x++)T[x]===void 0&&(T[x]=new Ke(0,0,1,1)),M&&M[x]===void 0&&(M[x]=new ce(1,1,1,1));for(var P=0;P<e;P++)if(n.push(T[P].z,Se.UseOpenGLOrientationForUV?1-T[P].w:T[P].w),n.push(T[P].x,Se.UseOpenGLOrientationForUV?1-T[P].w:T[P].w),n.push(T[P].x,Se.UseOpenGLOrientationForUV?1-T[P].y:T[P].y),n.push(T[P].z,Se.UseOpenGLOrientationForUV?1-T[P].y:T[P].y),M)for(var w=0;w<4;w++)D.push(M[P].r,M[P].g,M[P].b,M[P].a);J._ComputeSides(S,a,t,r,n,i.frontUVs,i.backUVs);var k=new J;if(k.indices=t,k.positions=a,k.normals=r,k.uvs=n,M){var B=S===J.DOUBLESIDE?D.concat(D):D;k.colors=B}return k}function un(i,e,t){e===void 0&&(e={}),t===void 0&&(t=null);var r=new O(i,t);e.sideOrientation=O._GetDefaultSideOrientation(e.sideOrientation),r._originalBuilderSideOrientation=e.sideOrientation;var n=Qa(e);return n.applyToMesh(r,e.updatable),r}J.CreateBox=Qa;O.CreateBox=function(i,e,t,r,n){t===void 0&&(t=null);var a={size:e,sideOrientation:n,updatable:r};return un(i,a,t)};function Mr(i){var e=i.pattern||O.NO_FLIP,t=i.tileWidth||i.tileSize||1,r=i.tileHeight||i.tileSize||1,n=i.alignHorizontal||0,a=i.alignVertical||0,s=i.width||i.size||1,o=Math.floor(s/t),l=s-o*t,u=i.height||i.size||1,f=Math.floor(u/r),h=u-f*r,c=t*o/2,d=r*f/2,p=0,_=0,g=0,v=0,y=0,b=0;if(l>0||h>0){switch(g=-c,v=-d,y=c,b=d,n){case O.CENTER:l/=2,g-=l,y+=l;break;case O.LEFT:y+=l,p=-l/2;break;case O.RIGHT:g-=l,p=l/2;break}switch(a){case O.CENTER:h/=2,v-=h,b+=h;break;case O.BOTTOM:b+=h,_=-h/2;break;case O.TOP:v-=h,_=h/2;break}}var E=[],A=[],S=[];S[0]=[0,0,1,0,1,1,0,1],S[1]=[0,0,1,0,1,1,0,1],(e===O.ROTATE_TILE||e===O.ROTATE_ROW)&&(S[1]=[1,1,0,1,0,0,1,0]),(e===O.FLIP_TILE||e===O.FLIP_ROW)&&(S[1]=[1,0,0,0,0,1,1,1]),(e===O.FLIP_N_ROTATE_TILE||e===O.FLIP_N_ROTATE_ROW)&&(S[1]=[0,1,1,1,1,0,0,0]);for(var T=[],M=[],D=[],x=0,P=0;P<f;P++)for(var w=0;w<o;w++)E.push(-c+w*t+p,-d+P*r+_,0),E.push(-c+(w+1)*t+p,-d+P*r+_,0),E.push(-c+(w+1)*t+p,-d+(P+1)*r+_,0),E.push(-c+w*t+p,-d+(P+1)*r+_,0),D.push(x,x+1,x+3,x+1,x+2,x+3),e===O.FLIP_TILE||e===O.ROTATE_TILE||e===O.FLIP_N_ROTATE_TILE?T=T.concat(S[(w%2+P%2)%2]):e===O.FLIP_ROW||e===O.ROTATE_ROW||e===O.FLIP_N_ROTATE_ROW?T=T.concat(S[P%2]):T=T.concat(S[0]),M.push(1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1),A.push(0,0,-1,0,0,-1,0,0,-1,0,0,-1),x+=4;if(l>0||h>0){var k=h>0&&(a===O.CENTER||a===O.TOP),B=h>0&&(a===O.CENTER||a===O.BOTTOM),L=l>0&&(n===O.CENTER||n===O.RIGHT),H=l>0&&(n===O.CENTER||n===O.LEFT),W=[],F=void 0,V=void 0,z=void 0,N=void 0;if(k&&L&&(E.push(g+p,v+_,0),E.push(-c+p,v+_,0),E.push(-c+p,v+h+_,0),E.push(g+p,v+h+_,0),D.push(x,x+1,x+3,x+1,x+2,x+3),x+=4,F=1-l/t,V=1-h/r,z=1,N=1,W=[F,V,z,V,z,N,F,N],e===O.ROTATE_ROW&&(W=[1-F,1-V,1-z,1-V,1-z,1-N,1-F,1-N]),e===O.FLIP_ROW&&(W=[1-F,V,1-z,V,1-z,N,1-F,N]),e===O.FLIP_N_ROTATE_ROW&&(W=[F,1-V,z,1-V,z,1-N,F,1-N]),T=T.concat(W),M.push(1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1),A.push(0,0,-1,0,0,-1,0,0,-1,0,0,-1)),k&&H&&(E.push(c+p,v+_,0),E.push(y+p,v+_,0),E.push(y+p,v+h+_,0),E.push(c+p,v+h+_,0),D.push(x,x+1,x+3,x+1,x+2,x+3),x+=4,F=0,V=1-h/r,z=l/t,N=1,W=[F,V,z,V,z,N,F,N],(e===O.ROTATE_ROW||e===O.ROTATE_TILE&&o%2===0)&&(W=[1-F,1-V,1-z,1-V,1-z,1-N,1-F,1-N]),(e===O.FLIP_ROW||e===O.FLIP_TILE&&o%2===0)&&(W=[1-F,V,1-z,V,1-z,N,1-F,N]),(e===O.FLIP_N_ROTATE_ROW||e===O.FLIP_N_ROTATE_TILE&&o%2===0)&&(W=[F,1-V,z,1-V,z,1-N,F,1-N]),T=T.concat(W),M.push(1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1),A.push(0,0,-1,0,0,-1,0,0,-1,0,0,-1)),B&&L&&(E.push(g+p,d+_,0),E.push(-c+p,d+_,0),E.push(-c+p,b+_,0),E.push(g+p,b+_,0),D.push(x,x+1,x+3,x+1,x+2,x+3),x+=4,F=1-l/t,V=0,z=1,N=h/r,W=[F,V,z,V,z,N,F,N],(e===O.ROTATE_ROW&&f%2===1||e===O.ROTATE_TILE&&f%1===0)&&(W=[1-F,1-V,1-z,1-V,1-z,1-N,1-F,1-N]),(e===O.FLIP_ROW&&f%2===1||e===O.FLIP_TILE&&f%2===0)&&(W=[1-F,V,1-z,V,1-z,N,1-F,N]),(e===O.FLIP_N_ROTATE_ROW&&f%2===1||e===O.FLIP_N_ROTATE_TILE&&f%2===0)&&(W=[F,1-V,z,1-V,z,1-N,F,1-N]),T=T.concat(W),M.push(1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1),A.push(0,0,-1,0,0,-1,0,0,-1,0,0,-1)),B&&H&&(E.push(c+p,d+_,0),E.push(y+p,d+_,0),E.push(y+p,b+_,0),E.push(c+p,b+_,0),D.push(x,x+1,x+3,x+1,x+2,x+3),x+=4,F=0,V=0,z=l/t,N=h/r,W=[F,V,z,V,z,N,F,N],(e===O.ROTATE_ROW&&f%2===1||e===O.ROTATE_TILE&&(f+o)%2===1)&&(W=[1-F,1-V,1-z,1-V,1-z,1-N,1-F,1-N]),(e===O.FLIP_ROW&&f%2===1||e===O.FLIP_TILE&&(f+o)%2===1)&&(W=[1-F,V,1-z,V,1-z,N,1-F,N]),(e===O.FLIP_N_ROTATE_ROW&&f%2===1||e===O.FLIP_N_ROTATE_TILE&&(f+o)%2===1)&&(W=[F,1-V,z,1-V,z,1-N,F,1-N]),T=T.concat(W),M.push(1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1),A.push(0,0,-1,0,0,-1,0,0,-1,0,0,-1)),k){var Q=[];F=0,V=1-h/r,z=1,N=1,Q[0]=[F,V,z,V,z,N,F,N],Q[1]=[F,V,z,V,z,N,F,N],(e===O.ROTATE_TILE||e===O.ROTATE_ROW)&&(Q[1]=[1-F,1-V,1-z,1-V,1-z,1-N,1-F,1-N]),(e===O.FLIP_TILE||e===O.FLIP_ROW)&&(Q[1]=[1-F,V,1-z,V,1-z,N,1-F,N]),(e===O.FLIP_N_ROTATE_TILE||e===O.FLIP_N_ROTATE_ROW)&&(Q[1]=[F,1-V,z,1-V,z,1-N,F,1-N]);for(var w=0;w<o;w++)E.push(-c+w*t+p,v+_,0),E.push(-c+(w+1)*t+p,v+_,0),E.push(-c+(w+1)*t+p,v+h+_,0),E.push(-c+w*t+p,v+h+_,0),D.push(x,x+1,x+3,x+1,x+2,x+3),x+=4,e===O.FLIP_TILE||e===O.ROTATE_TILE||e===O.FLIP_N_ROTATE_TILE?T=T.concat(Q[(w+1)%2]):e===O.FLIP_ROW||e===O.ROTATE_ROW||e===O.FLIP_N_ROTATE_ROW?T=T.concat(Q[1]):T=T.concat(Q[0]),M.push(1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1),A.push(0,0,-1,0,0,-1,0,0,-1,0,0,-1)}if(B){var Z=[];F=0,V=0,z=1,N=h/r,Z[0]=[F,V,z,V,z,N,F,N],Z[1]=[F,V,z,V,z,N,F,N],(e===O.ROTATE_TILE||e===O.ROTATE_ROW)&&(Z[1]=[1-F,1-V,1-z,1-V,1-z,1-N,1-F,1-N]),(e===O.FLIP_TILE||e===O.FLIP_ROW)&&(Z[1]=[1-F,V,1-z,V,1-z,N,1-F,N]),(e===O.FLIP_N_ROTATE_TILE||e===O.FLIP_N_ROTATE_ROW)&&(Z[1]=[F,1-V,z,1-V,z,1-N,F,1-N]);for(var w=0;w<o;w++)E.push(-c+w*t+p,b-h+_,0),E.push(-c+(w+1)*t+p,b-h+_,0),E.push(-c+(w+1)*t+p,b+_,0),E.push(-c+w*t+p,b+_,0),D.push(x,x+1,x+3,x+1,x+2,x+3),x+=4,e===O.FLIP_TILE||e===O.ROTATE_TILE||e===O.FLIP_N_ROTATE_TILE?T=T.concat(Z[(w+f)%2]):e===O.FLIP_ROW||e===O.ROTATE_ROW||e===O.FLIP_N_ROTATE_ROW?T=T.concat(Z[f%2]):T=T.concat(Z[0]),M.push(1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1),A.push(0,0,-1,0,0,-1,0,0,-1,0,0,-1)}if(L){var ee=[];F=1-l/t,V=0,z=1,N=1,ee[0]=[F,V,z,V,z,N,F,N],ee[1]=[F,V,z,V,z,N,F,N],(e===O.ROTATE_TILE||e===O.ROTATE_ROW)&&(ee[1]=[1-F,1-V,1-z,1-V,1-z,1-N,1-F,1-N]),(e===O.FLIP_TILE||e===O.FLIP_ROW)&&(ee[1]=[1-F,V,1-z,V,1-z,N,1-F,N]),(e===O.FLIP_N_ROTATE_TILE||e===O.FLIP_N_ROTATE_ROW)&&(ee[1]=[F,1-V,z,1-V,z,1-N,F,1-N]);for(var P=0;P<f;P++)E.push(g+p,-d+P*r+_,0),E.push(g+l+p,-d+P*r+_,0),E.push(g+l+p,-d+(P+1)*r+_,0),E.push(g+p,-d+(P+1)*r+_,0),D.push(x,x+1,x+3,x+1,x+2,x+3),x+=4,e===O.FLIP_TILE||e===O.ROTATE_TILE||e===O.FLIP_N_ROTATE_TILE?T=T.concat(ee[(P+1)%2]):e===O.FLIP_ROW||e===O.ROTATE_ROW||e===O.FLIP_N_ROTATE_ROW?T=T.concat(ee[P%2]):T=T.concat(ee[0]),M.push(1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1),A.push(0,0,-1,0,0,-1,0,0,-1,0,0,-1)}if(H){var ne=[];F=0,V=0,z=l/r,N=1,ne[0]=[F,V,z,V,z,N,F,N],ne[1]=[F,V,z,V,z,N,F,N],(e===O.ROTATE_TILE||e===O.ROTATE_ROW)&&(ne[1]=[1-F,1-V,1-z,1-V,1-z,1-N,1-F,1-N]),(e===O.FLIP_TILE||e===O.FLIP_ROW)&&(ne[1]=[1-F,V,1-z,V,1-z,N,1-F,N]),(e===O.FLIP_N_ROTATE_TILE||e===O.FLIP_N_ROTATE_ROW)&&(ne[1]=[F,1-V,z,1-V,z,1-N,F,1-N]);for(var P=0;P<f;P++)E.push(y-l+p,-d+P*r+_,0),E.push(y+p,-d+P*r+_,0),E.push(y+p,-d+(P+1)*r+_,0),E.push(y-l+p,-d+(P+1)*r+_,0),D.push(x,x+1,x+3,x+1,x+2,x+3),x+=4,e===O.FLIP_TILE||e===O.ROTATE_TILE||e===O.FLIP_N_ROTATE_TILE?T=T.concat(ne[(P+o)%2]):e===O.FLIP_ROW||e===O.ROTATE_ROW||e===O.FLIP_N_ROTATE_ROW?T=T.concat(ne[P%2]):T=T.concat(ne[0]),M.push(1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1),A.push(0,0,-1,0,0,-1,0,0,-1,0,0,-1)}}var Te=i.sideOrientation===0?0:i.sideOrientation||J.DEFAULTSIDE;J._ComputeSides(Te,E,D,A,T,i.frontUVs,i.backUVs);var j=new J;j.indices=D,j.positions=E,j.normals=A,j.uvs=T;var oe=Te===J.DOUBLESIDE?M.concat(M):M;return j.colors=oe,j}function Pl(i,e,t){t===void 0&&(t=null);var r=new O(i,t);e.sideOrientation=O._GetDefaultSideOrientation(e.sideOrientation),r._originalBuilderSideOrientation=e.sideOrientation;var n=Mr(e);return n.applyToMesh(r,e.updatable),r}J.CreateTiledPlane=Mr;function $a(i){for(var e=6,t=i.faceUV||new Array(6),r=i.faceColors,n=i.pattern||O.NO_FLIP,a=i.width||i.size||1,s=i.height||i.size||1,o=i.depth||i.size||1,l=i.tileWidth||i.tileSize||1,u=i.tileHeight||i.tileSize||1,f=i.alignHorizontal||0,h=i.alignVertical||0,c=i.sideOrientation===0?0:i.sideOrientation||J.DEFAULTSIDE,d=0;d<e;d++)t[d]===void 0&&(t[d]=new Ke(0,0,1,1)),r&&r[d]===void 0&&(r[d]=new ce(1,1,1,1));for(var p=a/2,_=s/2,g=o/2,v=[],d=0;d<2;d++)v[d]=Mr({pattern:n,tileWidth:l,tileHeight:u,width:a,height:s,alignVertical:h,alignHorizontal:f,sideOrientation:c});for(var d=2;d<4;d++)v[d]=Mr({pattern:n,tileWidth:l,tileHeight:u,width:o,height:s,alignVertical:h,alignHorizontal:f,sideOrientation:c});var y=h;h===O.BOTTOM?y=O.TOP:h===O.TOP&&(y=O.BOTTOM);for(var d=4;d<6;d++)v[d]=Mr({pattern:n,tileWidth:l,tileHeight:u,width:a,height:o,alignVertical:y,alignHorizontal:f,sideOrientation:c});for(var b=[],E=[],A=[],S=[],T=[],M=[],D=[],x=[],P=0,w=0,d=0;d<e;d++){var k=v[d].positions.length;M[d]=[],D[d]=[];for(var B=0;B<k/3;B++)M[d].push(new m(v[d].positions[3*B],v[d].positions[3*B+1],v[d].positions[3*B+2])),D[d].push(new m(v[d].normals[3*B],v[d].normals[3*B+1],v[d].normals[3*B+2]));P=v[d].uvs.length,x[d]=[];for(var L=0;L<P;L+=2)x[d][L]=t[d].x+(t[d].z-t[d].x)*v[d].uvs[L],x[d][L+1]=t[d].y+(t[d].w-t[d].y)*v[d].uvs[L+1],Se.UseOpenGLOrientationForUV&&(x[d][L+1]=1-x[d][L+1]);if(A=A.concat(x[d]),S=S.concat(v[d].indices.map(function(oe){return oe+w})),w+=M[d].length,r)for(var H=0;H<4;H++)T.push(r[d].r,r[d].g,r[d].b,r[d].a)}var W=new m(0,0,g),F=G.RotationY(Math.PI);b=M[0].map(function(j){return m.TransformNormal(j,F).add(W)}).map(function(j){return[j.x,j.y,j.z]}).reduce(function(j,oe){return j.concat(oe)},[]),E=D[0].map(function(j){return m.TransformNormal(j,F)}).map(function(j){return[j.x,j.y,j.z]}).reduce(function(j,oe){return j.concat(oe)},[]),b=b.concat(M[1].map(function(j){return j.subtract(W)}).map(function(j){return[j.x,j.y,j.z]}).reduce(function(j,oe){return j.concat(oe)},[])),E=E.concat(D[1].map(function(j){return[j.x,j.y,j.z]}).reduce(function(j,oe){return j.concat(oe)},[]));var V=new m(p,0,0),z=G.RotationY(-Math.PI/2);b=b.concat(M[2].map(function(j){return m.TransformNormal(j,z).add(V)}).map(function(j){return[j.x,j.y,j.z]}).reduce(function(j,oe){return j.concat(oe)},[])),E=E.concat(D[2].map(function(j){return m.TransformNormal(j,z)}).map(function(j){return[j.x,j.y,j.z]}).reduce(function(j,oe){return j.concat(oe)},[]));var N=G.RotationY(Math.PI/2);b=b.concat(M[3].map(function(j){return m.TransformNormal(j,N).subtract(V)}).map(function(j){return[j.x,j.y,j.z]}).reduce(function(j,oe){return j.concat(oe)},[])),E=E.concat(D[3].map(function(j){return m.TransformNormal(j,N)}).map(function(j){return[j.x,j.y,j.z]}).reduce(function(j,oe){return j.concat(oe)},[]));var Q=new m(0,_,0),Z=G.RotationX(Math.PI/2);b=b.concat(M[4].map(function(j){return m.TransformNormal(j,Z).add(Q)}).map(function(j){return[j.x,j.y,j.z]}).reduce(function(j,oe){return j.concat(oe)},[])),E=E.concat(D[4].map(function(j){return m.TransformNormal(j,Z)}).map(function(j){return[j.x,j.y,j.z]}).reduce(function(j,oe){return j.concat(oe)},[]));var ee=G.RotationX(-Math.PI/2);b=b.concat(M[5].map(function(j){return m.TransformNormal(j,ee).subtract(Q)}).map(function(j){return[j.x,j.y,j.z]}).reduce(function(j,oe){return j.concat(oe)},[])),E=E.concat(D[5].map(function(j){return m.TransformNormal(j,ee)}).map(function(j){return[j.x,j.y,j.z]}).reduce(function(j,oe){return j.concat(oe)},[])),J._ComputeSides(c,b,S,E,A);var ne=new J;if(ne.indices=S,ne.positions=b,ne.normals=E,ne.uvs=A,r){var Te=c===J.DOUBLESIDE?T.concat(T):T;ne.colors=Te}return ne}function Ml(i,e,t){t===void 0&&(t=null);var r=new O(i,t);e.sideOrientation=O._GetDefaultSideOrientation(e.sideOrientation),r._originalBuilderSideOrientation=e.sideOrientation;var n=$a(e);return n.applyToMesh(r,e.updatable),r}J.CreateTiledBox=$a;function Ja(i){for(var e=i.segments||32,t=i.diameterX||i.diameter||1,r=i.diameterY||i.diameter||1,n=i.diameterZ||i.diameter||1,a=i.arc&&(i.arc<=0||i.arc>1)?1:i.arc||1,s=i.slice&&i.slice<=0?1:i.slice||1,o=i.sideOrientation===0?0:i.sideOrientation||J.DEFAULTSIDE,l=!!i.dedupTopBottomIndices,u=new m(t/2,r/2,n/2),f=2+e,h=2*f,c=[],d=[],p=[],_=[],g=0;g<=f;g++){for(var v=g/f,y=v*Math.PI*s,b=0;b<=h;b++){var E=b/h,A=E*Math.PI*2*a,S=G.RotationZ(-y),T=G.RotationY(A),M=m.TransformCoordinates(m.Up(),S),D=m.TransformCoordinates(M,T),x=D.multiply(u),P=D.divide(u).normalize();d.push(x.x,x.y,x.z),p.push(P.x,P.y,P.z),_.push(E,Se.UseOpenGLOrientationForUV?1-v:v)}if(g>0)for(var w=d.length/3,k=w-2*(h+1);k+h+2<w;k++)l?(g>1&&(c.push(k),c.push(k+1),c.push(k+h+1)),(g<f||s<1)&&(c.push(k+h+1),c.push(k+1),c.push(k+h+2))):(c.push(k),c.push(k+1),c.push(k+h+1),c.push(k+h+1),c.push(k+1),c.push(k+h+2))}J._ComputeSides(o,d,c,p,_,i.frontUVs,i.backUVs);var B=new J;return B.indices=c,B.positions=d,B.normals=p,B.uvs=_,B}function es(i,e,t){e===void 0&&(e={}),t===void 0&&(t=null);var r=new O(i,t);e.sideOrientation=O._GetDefaultSideOrientation(e.sideOrientation),r._originalBuilderSideOrientation=e.sideOrientation;var n=Ja(e);return n.applyToMesh(r,e.updatable),r}J.CreateSphere=Ja;O.CreateSphere=function(i,e,t,r,n,a){var s={segments:e,diameterX:t,diameterY:t,diameterZ:t,sideOrientation:a,updatable:n};return es(i,s,r)};function ts(i){var e=i.height||2,t=i.diameterTop===0?0:i.diameterTop||i.diameter||1,r=i.diameterBottom===0?0:i.diameterBottom||i.diameter||1;t=t||1e-5,r=r||1e-5;var n=i.tessellation||24,a=i.subdivisions||1,s=!!i.hasRings,o=!!i.enclose,l=i.cap===0?0:i.cap||O.CAP_ALL,u=i.arc&&(i.arc<=0||i.arc>1)?1:i.arc||1,f=i.sideOrientation===0?0:i.sideOrientation||J.DEFAULTSIDE,h=i.faceUV||new Array(3),c=i.faceColors,d=u!==1&&o?2:0,p=s?a:1,_=2+(1+d)*p,g;for(g=0;g<_;g++)c&&c[g]===void 0&&(c[g]=new ce(1,1,1,1));for(g=0;g<_;g++)h&&h[g]===void 0&&(h[g]=new Ke(0,0,1,1));var v=new Array,y=new Array,b=new Array,E=new Array,A=new Array,S=Math.PI*2*u/n,T,M,D,x=(r-t)/2/e,P=m.Zero(),w=m.Zero(),k=m.Zero(),B=m.Zero(),L=m.Zero(),H=ei.Y,W,F,V,z=1,N=1,Q=0,Z=0;for(W=0;W<=a;W++)for(M=W/a,D=(M*(t-r)+r)/2,z=s&&W!==0&&W!==a?2:1,V=0;V<z;V++){for(s&&(N+=V),o&&(N+=2*V),F=0;F<=n;F++)T=F*S,P.x=Math.cos(-T)*D,P.y=-e/2+M*e,P.z=Math.sin(-T)*D,t===0&&W===a?(w.x=b[b.length-(n+1)*3],w.y=b[b.length-(n+1)*3+1],w.z=b[b.length-(n+1)*3+2]):(w.x=P.x,w.z=P.z,w.y=Math.sqrt(w.x*w.x+w.z*w.z)*x,w.normalize()),F===0&&(k.copyFrom(P),B.copyFrom(w)),y.push(P.x,P.y,P.z),b.push(w.x,w.y,w.z),s?Z=Q!==N?h[N].y:h[N].w:Z=h[N].y+(h[N].w-h[N].y)*M,E.push(h[N].x+(h[N].z-h[N].x)*F/n,Se.UseOpenGLOrientationForUV?1-Z:Z),c&&A.push(c[N].r,c[N].g,c[N].b,c[N].a);u!==1&&o&&(y.push(P.x,P.y,P.z),y.push(0,P.y,0),y.push(0,P.y,0),y.push(k.x,k.y,k.z),m.CrossToRef(H,w,L),L.normalize(),b.push(L.x,L.y,L.z,L.x,L.y,L.z),m.CrossToRef(B,H,L),L.normalize(),b.push(L.x,L.y,L.z,L.x,L.y,L.z),s?Z=Q!==N?h[N+1].y:h[N+1].w:Z=h[N+1].y+(h[N+1].w-h[N+1].y)*M,E.push(h[N+1].x,Se.UseOpenGLOrientationForUV?1-Z:Z),E.push(h[N+1].z,Se.UseOpenGLOrientationForUV?1-Z:Z),s?Z=Q!==N?h[N+2].y:h[N+2].w:Z=h[N+2].y+(h[N+2].w-h[N+2].y)*M,E.push(h[N+2].x,Se.UseOpenGLOrientationForUV?1-Z:Z),E.push(h[N+2].z,Se.UseOpenGLOrientationForUV?1-Z:Z),c&&(A.push(c[N+1].r,c[N+1].g,c[N+1].b,c[N+1].a),A.push(c[N+1].r,c[N+1].g,c[N+1].b,c[N+1].a),A.push(c[N+2].r,c[N+2].g,c[N+2].b,c[N+2].a),A.push(c[N+2].r,c[N+2].g,c[N+2].b,c[N+2].a))),Q!==N&&(Q=N)}var ee=u!==1&&o?n+4:n;for(W=0,N=0;N<a;N++){var ne=0,Te=0,j=0,oe=0;for(F=0;F<n;F++)ne=W*(ee+1)+F,Te=(W+1)*(ee+1)+F,j=W*(ee+1)+(F+1),oe=(W+1)*(ee+1)+(F+1),v.push(ne,Te,j),v.push(oe,j,Te);u!==1&&o&&(v.push(ne+2,Te+2,j+2),v.push(oe+2,j+2,Te+2),v.push(ne+4,Te+4,j+4),v.push(oe+4,j+4,Te+4)),W=s?W+2:W+1}var be=function(Pe){var Fe=Pe?t/2:r/2;if(Fe!==0){var Ae,xe,_e,we=Pe?h[_-1]:h[0],Ve=null;c&&(Ve=Pe?c[_-1]:c[0]);var st=y.length/3,pt=Pe?e/2:-e/2,yt=new m(0,pt,0);y.push(yt.x,yt.y,yt.z),b.push(0,Pe?1:-1,0);var Tn=we.y+(we.w-we.y)*.5;E.push(we.x+(we.z-we.x)*.5,Se.UseOpenGLOrientationForUV?1-Tn:Tn),Ve&&A.push(Ve.r,Ve.g,Ve.b,Ve.a);var En=new se(.5,.5);for(_e=0;_e<=n;_e++){Ae=Math.PI*2*_e*u/n;var An=Math.cos(-Ae),Sn=Math.sin(-Ae);xe=new m(An*Fe,pt,Sn*Fe);var Rn=new se(An*En.x+.5,Sn*En.y+.5);y.push(xe.x,xe.y,xe.z),b.push(0,Pe?1:-1,0);var Pn=we.y+(we.w-we.y)*Rn.y;E.push(we.x+(we.z-we.x)*Rn.x,Se.UseOpenGLOrientationForUV?1-Pn:Pn),Ve&&A.push(Ve.r,Ve.g,Ve.b,Ve.a)}for(_e=0;_e<n;_e++)Pe?(v.push(st),v.push(st+(_e+2)),v.push(st+(_e+1))):(v.push(st),v.push(st+(_e+1)),v.push(st+(_e+2)))}};(l===O.CAP_START||l===O.CAP_ALL)&&be(!1),(l===O.CAP_END||l===O.CAP_ALL)&&be(!0),J._ComputeSides(f,y,v,b,E,i.frontUVs,i.backUVs);var Ee=new J;return Ee.indices=v,Ee.positions=y,Ee.normals=b,Ee.uvs=E,c&&(Ee.colors=A),Ee}function ri(i,e,t){e===void 0&&(e={});var r=new O(i,t);e.sideOrientation=O._GetDefaultSideOrientation(e.sideOrientation),r._originalBuilderSideOrientation=e.sideOrientation;var n=ts(e);return n.applyToMesh(r,e.updatable),r}J.CreateCylinder=ts;O.CreateCylinder=function(i,e,t,r,n,a,s,o,l){(s===void 0||!(s instanceof Re))&&(s!==void 0&&(l=o||O.DEFAULTSIDE,o=s),s=a,a=1);var u={height:e,diameterTop:t,diameterBottom:r,tessellation:n,subdivisions:a,sideOrientation:l,updatable:o};return ri(i,u,s)};function rs(i){for(var e=[],t=[],r=[],n=[],a=i.diameter||1,s=i.thickness||.5,o=i.tessellation||16,l=i.sideOrientation===0?0:i.sideOrientation||J.DEFAULTSIDE,u=o+1,f=0;f<=o;f++)for(var h=f/o,c=f*Math.PI*2/o-Math.PI/2,d=G.Translation(a/2,0,0).multiply(G.RotationY(c)),p=0;p<=o;p++){var _=1-p/o,g=p*Math.PI*2/o+Math.PI,v=Math.cos(g),y=Math.sin(g),b=new m(v,y,0),E=b.scale(s/2),A=new se(h,_);E=m.TransformCoordinates(E,d),b=m.TransformNormal(b,d),t.push(E.x,E.y,E.z),r.push(b.x,b.y,b.z),n.push(A.x,Se.UseOpenGLOrientationForUV?1-A.y:A.y);var S=(f+1)%u,T=(p+1)%u;e.push(f*u+p),e.push(f*u+T),e.push(S*u+p),e.push(f*u+T),e.push(S*u+T),e.push(S*u+p)}J._ComputeSides(l,t,e,r,n,i.frontUVs,i.backUVs);var M=new J;return M.indices=e,M.positions=t,M.normals=r,M.uvs=n,M}function is(i,e,t){e===void 0&&(e={});var r=new O(i,t);e.sideOrientation=O._GetDefaultSideOrientation(e.sideOrientation),r._originalBuilderSideOrientation=e.sideOrientation;var n=rs(e);return n.applyToMesh(r,e.updatable),r}J.CreateTorus=rs;O.CreateTorus=function(i,e,t,r,n,a,s){var o={diameter:e,thickness:t,tessellation:r,sideOrientation:s,updatable:a};return is(i,o,n)};function ns(i){var e=new Array,t=new Array,r=new Array,n=new Array,a=i.radius||2,s=i.tube||.5,o=i.radialSegments||32,l=i.tubularSegments||32,u=i.p||2,f=i.q||3,h=i.sideOrientation===0?0:i.sideOrientation||J.DEFAULTSIDE,c=function(H){var W=Math.cos(H),F=Math.sin(H),V=f/u*H,z=Math.cos(V),N=a*(2+z)*.5*W,Q=a*(2+z)*F*.5,Z=a*Math.sin(V)*.5;return new m(N,Q,Z)},d,p;for(d=0;d<=o;d++){var _=d%o,g=_/o*2*u*Math.PI,v=c(g),y=c(g+.01),b=y.subtract(v),E=y.add(v),A=m.Cross(b,E);for(E=m.Cross(A,b),A.normalize(),E.normalize(),p=0;p<l;p++){var S=p%l,T=S/l*2*Math.PI,M=-s*Math.cos(T),D=s*Math.sin(T);t.push(v.x+M*E.x+D*A.x),t.push(v.y+M*E.y+D*A.y),t.push(v.z+M*E.z+D*A.z),n.push(d/o),n.push(Se.UseOpenGLOrientationForUV?1-p/l:p/l)}}for(d=0;d<o;d++)for(p=0;p<l;p++){var x=(p+1)%l,P=d*l+p,w=(d+1)*l+p,k=(d+1)*l+x,B=d*l+x;e.push(B),e.push(w),e.push(P),e.push(B),e.push(k),e.push(w)}J.ComputeNormals(t,e,r),J._ComputeSides(h,t,e,r,n,i.frontUVs,i.backUVs);var L=new J;return L.indices=e,L.positions=t,L.normals=r,L.uvs=n,L}function as(i,e,t){e===void 0&&(e={});var r=new O(i,t);e.sideOrientation=O._GetDefaultSideOrientation(e.sideOrientation),r._originalBuilderSideOrientation=e.sideOrientation;var n=ns(e);return n.applyToMesh(r,e.updatable),r}J.CreateTorusKnot=ns;O.CreateTorusKnot=function(i,e,t,r,n,a,s,o,l,u){var f={radius:e,tube:t,radialSegments:r,tubularSegments:n,p:a,q:s,sideOrientation:u,updatable:l};return as(i,f,o)};O._instancedMeshFactory=function(i,e){var t=new ss(i,e);if(e.instancedBuffers){t.instancedBuffers={};for(var r in e.instancedBuffers)t.instancedBuffers[r]=e.instancedBuffers[r]}return t};var ss=function(i){$(e,i);function e(t,r){var n=i.call(this,t,r.getScene())||this;n._indexInSourceMeshInstanceArray=-1,n._distanceToCamera=0,r.addInstance(n),n._sourceMesh=r,n._unIndexed=r._unIndexed,n.position.copyFrom(r.position),n.rotation.copyFrom(r.rotation),n.scaling.copyFrom(r.scaling),r.rotationQuaternion&&(n.rotationQuaternion=r.rotationQuaternion.clone()),n.animations=te.Slice(r.animations);for(var a=0,s=r.getAnimationRanges();a<s.length;a++){var o=s[a];o!=null&&n.createAnimationRange(o.name,o.from,o.to)}return n.infiniteDistance=r.infiniteDistance,n.setPivotMatrix(r.getPivotMatrix()),n.refreshBoundingInfo(!0,!0),n._syncSubMeshes(),n}return e.prototype.getClassName=function(){return"InstancedMesh"},Object.defineProperty(e.prototype,"lightSources",{get:function(){return this._sourceMesh._lightSources},enumerable:!1,configurable:!0}),e.prototype._resyncLightSources=function(){},e.prototype._resyncLightSource=function(){},e.prototype._removeLightSource=function(){},Object.defineProperty(e.prototype,"receiveShadows",{get:function(){return this._sourceMesh.receiveShadows},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"material",{get:function(){return this._sourceMesh.material},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"visibility",{get:function(){return this._sourceMesh.visibility},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"skeleton",{get:function(){return this._sourceMesh.skeleton},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"renderingGroupId",{get:function(){return this._sourceMesh.renderingGroupId},set:function(t){!this._sourceMesh||t===this._sourceMesh.renderingGroupId||Y.Warn("Note - setting renderingGroupId of an instanced mesh has no effect on the scene")},enumerable:!1,configurable:!0}),e.prototype.getTotalVertices=function(){return this._sourceMesh?this._sourceMesh.getTotalVertices():0},e.prototype.getTotalIndices=function(){return this._sourceMesh.getTotalIndices()},Object.defineProperty(e.prototype,"sourceMesh",{get:function(){return this._sourceMesh},enumerable:!1,configurable:!0}),e.prototype.createInstance=function(t){return this._sourceMesh.createInstance(t)},e.prototype.isReady=function(t){return t===void 0&&(t=!1),this._sourceMesh.isReady(t,!0)},e.prototype.getVerticesData=function(t,r){return this._sourceMesh.getVerticesData(t,r)},e.prototype.setVerticesData=function(t,r,n,a){return this.sourceMesh&&this.sourceMesh.setVerticesData(t,r,n,a),this.sourceMesh},e.prototype.updateVerticesData=function(t,r,n,a){return this.sourceMesh&&this.sourceMesh.updateVerticesData(t,r,n,a),this.sourceMesh},e.prototype.setIndices=function(t,r){return r===void 0&&(r=null),this.sourceMesh&&this.sourceMesh.setIndices(t,r),this.sourceMesh},e.prototype.isVerticesDataPresent=function(t){return this._sourceMesh.isVerticesDataPresent(t)},e.prototype.getIndices=function(){return this._sourceMesh.getIndices()},Object.defineProperty(e.prototype,"_positions",{get:function(){return this._sourceMesh._positions},enumerable:!1,configurable:!0}),e.prototype.refreshBoundingInfo=function(t,r){if(t===void 0&&(t=!1),r===void 0&&(r=!1),this.hasBoundingInfo&&this.getBoundingInfo().isLocked)return this;var n=this._sourceMesh.geometry?this._sourceMesh.geometry.boundingBias:null;return this._refreshBoundingInfo(this._sourceMesh._getPositionData(t,r),n),this},e.prototype._preActivate=function(){return this._currentLOD&&this._currentLOD._preActivate(),this},e.prototype._activate=function(t,r){if(this._sourceMesh.subMeshes||Y.Warn("Instances should only be created for meshes with geometry."),this._currentLOD){var n=this._currentLOD._getWorldMatrixDeterminant()>=0!=this._getWorldMatrixDeterminant()>=0;if(n)return this._internalAbstractMeshDataInfo._actAsRegularMesh=!0,!0;if(this._internalAbstractMeshDataInfo._actAsRegularMesh=!1,this._currentLOD._registerInstanceForRenderId(this,t),r){if(!this._currentLOD._internalAbstractMeshDataInfo._isActiveIntermediate)return this._currentLOD._internalAbstractMeshDataInfo._onlyForInstancesIntermediate=!0,!0}else if(!this._currentLOD._internalAbstractMeshDataInfo._isActive)return this._currentLOD._internalAbstractMeshDataInfo._onlyForInstances=!0,!0}return!1},e.prototype._postActivate=function(){this._sourceMesh.edgesShareWithInstances&&this._sourceMesh._edgesRenderer&&this._sourceMesh._edgesRenderer.isEnabled&&this._sourceMesh._renderingGroup?(this._sourceMesh._renderingGroup._edgesRenderers.pushNoDuplicate(this._sourceMesh._edgesRenderer),this._sourceMesh._edgesRenderer.customInstances.push(this.getWorldMatrix())):this._edgesRenderer&&this._edgesRenderer.isEnabled&&this._sourceMesh._renderingGroup&&this._sourceMesh._renderingGroup._edgesRenderers.push(this._edgesRenderer)},e.prototype.getWorldMatrix=function(){if(this._currentLOD&&this._currentLOD.billboardMode!==ht.BILLBOARDMODE_NONE&&this._currentLOD._masterMesh!==this){this._billboardWorldMatrix||(this._billboardWorldMatrix=new G);var t=this._currentLOD._masterMesh;return this._currentLOD._masterMesh=this,U.Vector3[7].copyFrom(this._currentLOD.position),this._currentLOD.position.set(0,0,0),this._billboardWorldMatrix.copyFrom(this._currentLOD.computeWorldMatrix(!0)),this._currentLOD.position.copyFrom(U.Vector3[7]),this._currentLOD._masterMesh=t,this._billboardWorldMatrix}return i.prototype.getWorldMatrix.call(this)},Object.defineProperty(e.prototype,"isAnInstance",{get:function(){return!0},enumerable:!1,configurable:!0}),e.prototype.getLOD=function(t){if(!t)return this;var r=this.sourceMesh.getLODLevels();if(!r||r.length===0)this._currentLOD=this.sourceMesh;else{var n=this.getBoundingInfo();this._currentLOD=this.sourceMesh.getLOD(t,n.boundingSphere)}return this._currentLOD},e.prototype._preActivateForIntermediateRendering=function(t){return this.sourceMesh._preActivateForIntermediateRendering(t)},e.prototype._syncSubMeshes=function(){if(this.releaseSubMeshes(),this._sourceMesh.subMeshes)for(var t=0;t<this._sourceMesh.subMeshes.length;t++)this._sourceMesh.subMeshes[t].clone(this,this._sourceMesh);return this},e.prototype._generatePointsArray=function(){return this._sourceMesh._generatePointsArray()},e.prototype._updateBoundingInfo=function(){return this.hasBoundingInfo?this.getBoundingInfo().update(this.worldMatrixFromCache):this.buildBoundingInfo(this.absolutePosition,this.absolutePosition,this.worldMatrixFromCache),this._updateSubMeshesBoundingInfo(this.worldMatrixFromCache),this},e.prototype.clone=function(t,r,n){r===void 0&&(r=null);var a=this._sourceMesh.createInstance(t);if(dt.DeepCopy(this,a,["name","subMeshes","uniqueId","parent","lightSources","receiveShadows","material","visibility","skeleton","sourceMesh","isAnInstance","facetNb","isFacetDataEnabled","isBlocked","useBones","hasInstances","collider","edgesRenderer","forward","up","right","absolutePosition","absoluteScaling","absoluteRotationQuaternion","isWorldMatrixFrozen","nonUniformScaling","behaviors","worldMatrixFromCache","hasThinInstances"],[]),this.refreshBoundingInfo(),r&&(a.parent=r),!n)for(var s=0;s<this.getScene().meshes.length;s++){var o=this.getScene().meshes[s];o.parent===this&&o.clone(o.name,a)}return a.computeWorldMatrix(!0),this.onClonedObservable.notifyObservers(a),a},e.prototype.dispose=function(t,r){r===void 0&&(r=!1),this._sourceMesh.removeInstance(this),i.prototype.dispose.call(this,t,r)},e}(ln);O.prototype.edgesShareWithInstances=!1;O.prototype.registerInstancedBuffer=function(i,e){var t,r;if((r=(t=this._userInstancedBuffersStorage)===null||t===void 0?void 0:t.vertexBuffers[i])===null||r===void 0||r.dispose(),!this.instancedBuffers){this.instancedBuffers={};for(var n=0,a=this.instances;n<a.length;n++){var s=a[n];s.instancedBuffers={}}this._userInstancedBuffersStorage={data:{},vertexBuffers:{},strides:{},sizes:{},vertexArrayObjects:this.getEngine().getCaps().vertexArrayObject?{}:void 0}}this.instancedBuffers[i]=null,this._userInstancedBuffersStorage.strides[i]=e,this._userInstancedBuffersStorage.sizes[i]=e*32,this._userInstancedBuffersStorage.data[i]=new Float32Array(this._userInstancedBuffersStorage.sizes[i]),this._userInstancedBuffersStorage.vertexBuffers[i]=new R(this.getEngine(),this._userInstancedBuffersStorage.data[i],i,!0,!1,e,!0);for(var o=0,l=this.instances;o<l.length;o++){var s=l[o];s.instancedBuffers[i]=null}this._invalidateInstanceVertexArrayObject()};O.prototype._processInstancedBuffers=function(i,e){var t=i.length;for(var r in this.instancedBuffers){for(var n=this._userInstancedBuffersStorage.sizes[r],a=this._userInstancedBuffersStorage.strides[r],s=(t+1)*a;n<s;)n*=2;this._userInstancedBuffersStorage.data[r].length!=n&&(this._userInstancedBuffersStorage.data[r]=new Float32Array(n),this._userInstancedBuffersStorage.sizes[r]=n,this._userInstancedBuffersStorage.vertexBuffers[r]&&(this._userInstancedBuffersStorage.vertexBuffers[r].dispose(),this._userInstancedBuffersStorage.vertexBuffers[r]=null));var o=this._userInstancedBuffersStorage.data[r],l=0;if(e){var u=this.instancedBuffers[r];u.toArray?u.toArray(o,l):u.copyToArray?u.copyToArray(o,l):o[l]=u,l+=a}for(var f=0;f<t;f++){var h=i[f],u=h.instancedBuffers[r];u.toArray?u.toArray(o,l):u.copyToArray?u.copyToArray(o,l):o[l]=u,l+=a}this._userInstancedBuffersStorage.vertexBuffers[r]?this._userInstancedBuffersStorage.vertexBuffers[r].updateDirectly(o,0):(this._userInstancedBuffersStorage.vertexBuffers[r]=new R(this.getEngine(),this._userInstancedBuffersStorage.data[r],r,!0,!1,a,!0),this._invalidateInstanceVertexArrayObject())}};O.prototype._invalidateInstanceVertexArrayObject=function(){if(!(!this._userInstancedBuffersStorage||this._userInstancedBuffersStorage.vertexArrayObjects===void 0)){for(var i in this._userInstancedBuffersStorage.vertexArrayObjects)this.getEngine().releaseVertexArrayObject(this._userInstancedBuffersStorage.vertexArrayObjects[i]);this._userInstancedBuffersStorage.vertexArrayObjects={}}};O.prototype._disposeInstanceSpecificData=function(){for(this._instanceDataStorage.instancesBuffer&&(this._instanceDataStorage.instancesBuffer.dispose(),this._instanceDataStorage.instancesBuffer=null);this.instances.length;)this.instances[0].dispose();for(var i in this.instancedBuffers)this._userInstancedBuffersStorage.vertexBuffers[i]&&this._userInstancedBuffersStorage.vertexBuffers[i].dispose();this._invalidateInstanceVertexArrayObject(),this.instancedBuffers={}};var Cl="clipPlaneFragmentDeclaration",xl=`#ifdef CLIPPLANE
varying float fClipDistance;
#endif
#ifdef CLIPPLANE2
varying float fClipDistance2;
#endif
#ifdef CLIPPLANE3
varying float fClipDistance3;
#endif
#ifdef CLIPPLANE4
varying float fClipDistance4;
#endif
#ifdef CLIPPLANE5
varying float fClipDistance5;
#endif
#ifdef CLIPPLANE6
varying float fClipDistance6;
#endif
`;q.IncludesShadersStore[Cl]=xl;var Dl="clipPlaneFragment",Ol=`#if defined(CLIPPLANE) || defined(CLIPPLANE2) || defined(CLIPPLANE3) || defined(CLIPPLANE4) || defined(CLIPPLANE5) || defined(CLIPPLANE6)
if (false) {}
#endif
#ifdef CLIPPLANE
else if (fClipDistance>0.0)
{
discard;
}
#endif
#ifdef CLIPPLANE2
else if (fClipDistance2>0.0)
{
discard;
}
#endif
#ifdef CLIPPLANE3
else if (fClipDistance3>0.0)
{
discard;
}
#endif
#ifdef CLIPPLANE4
else if (fClipDistance4>0.0)
{
discard;
}
#endif
#ifdef CLIPPLANE5
else if (fClipDistance5>0.0)
{
discard;
}
#endif
#ifdef CLIPPLANE6
else if (fClipDistance6>0.0)
{
discard;
}
#endif
`;q.IncludesShadersStore[Dl]=Ol;var Il="colorPixelShader",Fl=`#if defined(VERTEXCOLOR) || defined(INSTANCESCOLOR)
varying vec4 vColor;
#else
uniform vec4 color;
#endif
#include<clipPlaneFragmentDeclaration>
#define CUSTOM_FRAGMENT_DEFINITIONS
void main(void) {
#define CUSTOM_FRAGMENT_MAIN_BEGIN
#include<clipPlaneFragment>
#if defined(VERTEXCOLOR) || defined(INSTANCESCOLOR)
gl_FragColor=vColor;
#else
gl_FragColor=color;
#endif
#define CUSTOM_FRAGMENT_MAIN_END
}`;q.ShadersStore[Il]=Fl;var wl="bonesDeclaration",Ll=`#if NUM_BONE_INFLUENCERS>0
attribute vec4 matricesIndices;
attribute vec4 matricesWeights;
#if NUM_BONE_INFLUENCERS>4
attribute vec4 matricesIndicesExtra;
attribute vec4 matricesWeightsExtra;
#endif
#ifndef BAKED_VERTEX_ANIMATION_TEXTURE
#ifdef BONETEXTURE
uniform sampler2D boneSampler;
uniform float boneTextureWidth;
#else
uniform mat4 mBones[BonesPerMesh];
#ifdef BONES_VELOCITY_ENABLED
uniform mat4 mPreviousBones[BonesPerMesh];
#endif
#endif
#ifdef BONETEXTURE
#define inline
mat4 readMatrixFromRawSampler(sampler2D smp,float index)
{
float offset=index *4.0;
float dx=1.0/boneTextureWidth;
vec4 m0=texture2D(smp,vec2(dx*(offset+0.5),0.));
vec4 m1=texture2D(smp,vec2(dx*(offset+1.5),0.));
vec4 m2=texture2D(smp,vec2(dx*(offset+2.5),0.));
vec4 m3=texture2D(smp,vec2(dx*(offset+3.5),0.));
return mat4(m0,m1,m2,m3);
}
#endif
#endif
#endif
`;q.IncludesShadersStore[wl]=Ll;var Nl="bakedVertexAnimationDeclaration",Bl=`#ifdef BAKED_VERTEX_ANIMATION_TEXTURE
uniform float bakedVertexAnimationTime;
uniform vec2 bakedVertexAnimationTextureSizeInverted;
uniform vec4 bakedVertexAnimationSettings;
uniform sampler2D bakedVertexAnimationTexture;
#ifdef INSTANCES
attribute vec4 bakedVertexAnimationSettingsInstanced;
#endif
#define inline
mat4 readMatrixFromRawSamplerVAT(sampler2D smp,float index,float frame)
{
float offset=index*4.0;
float frameUV=(frame+0.5)*bakedVertexAnimationTextureSizeInverted.y;
float dx=bakedVertexAnimationTextureSizeInverted.x;
vec4 m0=texture2D(smp,vec2(dx*(offset+0.5),frameUV));
vec4 m1=texture2D(smp,vec2(dx*(offset+1.5),frameUV));
vec4 m2=texture2D(smp,vec2(dx*(offset+2.5),frameUV));
vec4 m3=texture2D(smp,vec2(dx*(offset+3.5),frameUV));
return mat4(m0,m1,m2,m3);
}
#endif
`;q.IncludesShadersStore[Nl]=Bl;var Ul="clipPlaneVertexDeclaration",Vl=`#ifdef CLIPPLANE
uniform vec4 vClipPlane;
varying float fClipDistance;
#endif
#ifdef CLIPPLANE2
uniform vec4 vClipPlane2;
varying float fClipDistance2;
#endif
#ifdef CLIPPLANE3
uniform vec4 vClipPlane3;
varying float fClipDistance3;
#endif
#ifdef CLIPPLANE4
uniform vec4 vClipPlane4;
varying float fClipDistance4;
#endif
#ifdef CLIPPLANE5
uniform vec4 vClipPlane5;
varying float fClipDistance5;
#endif
#ifdef CLIPPLANE6
uniform vec4 vClipPlane6;
varying float fClipDistance6;
#endif
`;q.IncludesShadersStore[Ul]=Vl;var kl="instancesDeclaration",Gl=`#ifdef INSTANCES
attribute vec4 world0;
attribute vec4 world1;
attribute vec4 world2;
attribute vec4 world3;
#ifdef INSTANCESCOLOR
attribute vec4 instanceColor;
#endif
#if defined(THIN_INSTANCES) && !defined(WORLD_UBO)
uniform mat4 world;
#endif
#if defined(VELOCITY) || defined(PREPASS_VELOCITY)
attribute vec4 previousWorld0;
attribute vec4 previousWorld1;
attribute vec4 previousWorld2;
attribute vec4 previousWorld3;
#ifdef THIN_INSTANCES
uniform mat4 previousWorld;
#endif
#endif
#else
#if !defined(WORLD_UBO)
uniform mat4 world;
#endif
#if defined(VELOCITY) || defined(PREPASS_VELOCITY)
uniform mat4 previousWorld;
#endif
#endif
`;q.IncludesShadersStore[kl]=Gl;var zl="instancesVertex",Wl=`#ifdef INSTANCES
mat4 finalWorld=mat4(world0,world1,world2,world3);
#if defined(PREPASS_VELOCITY) || defined(VELOCITY)
mat4 finalPreviousWorld=mat4(previousWorld0,previousWorld1,previousWorld2,previousWorld3);
#endif
#ifdef THIN_INSTANCES
finalWorld=world*finalWorld;
#if defined(PREPASS_VELOCITY) || defined(VELOCITY)
finalPreviousWorld=previousWorld*finalPreviousWorld;
#endif
#endif
#else
mat4 finalWorld=world;
#if defined(PREPASS_VELOCITY) || defined(VELOCITY)
mat4 finalPreviousWorld=previousWorld;
#endif
#endif
`;q.IncludesShadersStore[zl]=Wl;var Hl="bonesVertex",Xl=`#ifndef BAKED_VERTEX_ANIMATION_TEXTURE
#if NUM_BONE_INFLUENCERS>0
mat4 influence;
#ifdef BONETEXTURE
influence=readMatrixFromRawSampler(boneSampler,matricesIndices[0])*matricesWeights[0];
#if NUM_BONE_INFLUENCERS>1
influence+=readMatrixFromRawSampler(boneSampler,matricesIndices[1])*matricesWeights[1];
#endif
#if NUM_BONE_INFLUENCERS>2
influence+=readMatrixFromRawSampler(boneSampler,matricesIndices[2])*matricesWeights[2];
#endif
#if NUM_BONE_INFLUENCERS>3
influence+=readMatrixFromRawSampler(boneSampler,matricesIndices[3])*matricesWeights[3];
#endif
#if NUM_BONE_INFLUENCERS>4
influence+=readMatrixFromRawSampler(boneSampler,matricesIndicesExtra[0])*matricesWeightsExtra[0];
#endif
#if NUM_BONE_INFLUENCERS>5
influence+=readMatrixFromRawSampler(boneSampler,matricesIndicesExtra[1])*matricesWeightsExtra[1];
#endif
#if NUM_BONE_INFLUENCERS>6
influence+=readMatrixFromRawSampler(boneSampler,matricesIndicesExtra[2])*matricesWeightsExtra[2];
#endif
#if NUM_BONE_INFLUENCERS>7
influence+=readMatrixFromRawSampler(boneSampler,matricesIndicesExtra[3])*matricesWeightsExtra[3];
#endif
#else
influence=mBones[int(matricesIndices[0])]*matricesWeights[0];
#if NUM_BONE_INFLUENCERS>1
influence+=mBones[int(matricesIndices[1])]*matricesWeights[1];
#endif
#if NUM_BONE_INFLUENCERS>2
influence+=mBones[int(matricesIndices[2])]*matricesWeights[2];
#endif
#if NUM_BONE_INFLUENCERS>3
influence+=mBones[int(matricesIndices[3])]*matricesWeights[3];
#endif
#if NUM_BONE_INFLUENCERS>4
influence+=mBones[int(matricesIndicesExtra[0])]*matricesWeightsExtra[0];
#endif
#if NUM_BONE_INFLUENCERS>5
influence+=mBones[int(matricesIndicesExtra[1])]*matricesWeightsExtra[1];
#endif
#if NUM_BONE_INFLUENCERS>6
influence+=mBones[int(matricesIndicesExtra[2])]*matricesWeightsExtra[2];
#endif
#if NUM_BONE_INFLUENCERS>7
influence+=mBones[int(matricesIndicesExtra[3])]*matricesWeightsExtra[3];
#endif
#endif
finalWorld=finalWorld*influence;
#endif
#endif
`;q.IncludesShadersStore[Hl]=Xl;var jl="bakedVertexAnimation",Kl=`#ifdef BAKED_VERTEX_ANIMATION_TEXTURE
{
#ifdef INSTANCES
#define BVASNAME bakedVertexAnimationSettingsInstanced
#else
#define BVASNAME bakedVertexAnimationSettings
#endif
float VATStartFrame=BVASNAME.x;
float VATEndFrame=BVASNAME.y;
float VATOffsetFrame=BVASNAME.z;
float VATSpeed=BVASNAME.w;
float totalFrames=VATEndFrame-VATStartFrame+1.0;
float time=bakedVertexAnimationTime*VATSpeed/totalFrames;
float frameCorrection=time<1.0 ? 0.0 : 1.0;
float numOfFrames=totalFrames-frameCorrection;
float VATFrameNum=fract(time)*numOfFrames;
VATFrameNum=mod(VATFrameNum+VATOffsetFrame,numOfFrames);
VATFrameNum=floor(VATFrameNum);
VATFrameNum+=VATStartFrame+frameCorrection;
mat4 VATInfluence;
VATInfluence=readMatrixFromRawSamplerVAT(bakedVertexAnimationTexture,matricesIndices[0],VATFrameNum)*matricesWeights[0];
#if NUM_BONE_INFLUENCERS>1
VATInfluence+=readMatrixFromRawSamplerVAT(bakedVertexAnimationTexture,matricesIndices[1],VATFrameNum)*matricesWeights[1];
#endif
#if NUM_BONE_INFLUENCERS>2
VATInfluence+=readMatrixFromRawSamplerVAT(bakedVertexAnimationTexture,matricesIndices[2],VATFrameNum)*matricesWeights[2];
#endif
#if NUM_BONE_INFLUENCERS>3
VATInfluence+=readMatrixFromRawSamplerVAT(bakedVertexAnimationTexture,matricesIndices[3],VATFrameNum)*matricesWeights[3];
#endif
#if NUM_BONE_INFLUENCERS>4
VATInfluence+=readMatrixFromRawSamplerVAT(bakedVertexAnimationTexture,matricesIndicesExtra[0],VATFrameNum)*matricesWeightsExtra[0];
#endif
#if NUM_BONE_INFLUENCERS>5
VATInfluence+=readMatrixFromRawSamplerVAT(bakedVertexAnimationTexture,matricesIndicesExtra[1],VATFrameNum)*matricesWeightsExtra[1];
#endif
#if NUM_BONE_INFLUENCERS>6
VATInfluence+=readMatrixFromRawSamplerVAT(bakedVertexAnimationTexture,matricesIndicesExtra[2],VATFrameNum)*matricesWeightsExtra[2];
#endif
#if NUM_BONE_INFLUENCERS>7
VATInfluence+=readMatrixFromRawSamplerVAT(bakedVertexAnimationTexture,matricesIndicesExtra[3],VATFrameNum)*matricesWeightsExtra[3];
#endif
finalWorld=finalWorld*VATInfluence;
}
#endif
`;q.IncludesShadersStore[jl]=Kl;var Yl="clipPlaneVertex",ql=`#ifdef CLIPPLANE
fClipDistance=dot(worldPos,vClipPlane);
#endif
#ifdef CLIPPLANE2
fClipDistance2=dot(worldPos,vClipPlane2);
#endif
#ifdef CLIPPLANE3
fClipDistance3=dot(worldPos,vClipPlane3);
#endif
#ifdef CLIPPLANE4
fClipDistance4=dot(worldPos,vClipPlane4);
#endif
#ifdef CLIPPLANE5
fClipDistance5=dot(worldPos,vClipPlane5);
#endif
#ifdef CLIPPLANE6
fClipDistance6=dot(worldPos,vClipPlane6);
#endif
`;q.IncludesShadersStore[Yl]=ql;var Zl="colorVertexShader",Ql=`attribute vec3 position;
#ifdef VERTEXCOLOR
attribute vec4 color;
#endif
#include<bonesDeclaration>
#include<bakedVertexAnimationDeclaration>
#include<clipPlaneVertexDeclaration>
#include<instancesDeclaration>
uniform mat4 viewProjection;
#ifdef MULTIVIEW
uniform mat4 viewProjectionR;
#endif
#if defined(VERTEXCOLOR) || defined(INSTANCESCOLOR)
varying vec4 vColor;
#endif
#define CUSTOM_VERTEX_DEFINITIONS
void main(void) {
#define CUSTOM_VERTEX_MAIN_BEGIN
#include<instancesVertex>
#include<bonesVertex>
#include<bakedVertexAnimation>
vec4 worldPos=finalWorld*vec4(position,1.0);
#ifdef MULTIVIEW
if (gl_ViewID_OVR==0u) {
gl_Position=viewProjection*worldPos;
} else {
gl_Position=viewProjectionR*worldPos;
}
#else
gl_Position=viewProjection*worldPos;
#endif
#include<clipPlaneVertex>
#ifdef VERTEXCOLOR
vColor=color;
#elif INSTANCESCOLOR
vColor=instanceColor;
#endif
#define CUSTOM_VERTEX_MAIN_END
}`;q.ShadersStore[Zl]=Ql;O._LinesMeshParser=function(i,e){return fn.Parse(i,e)};var fn=function(i){$(e,i);function e(t,r,n,a,s,o,l,u){r===void 0&&(r=null),n===void 0&&(n=null),a===void 0&&(a=null);var f=i.call(this,t,r,n,a,s)||this;f.useVertexColor=o,f.useVertexAlpha=l,f.color=new me(1,1,1),f.alpha=1,a&&(f.color=a.color.clone(),f.alpha=a.alpha,f.useVertexColor=a.useVertexColor,f.useVertexAlpha=a.useVertexAlpha),f.intersectionThreshold=.1;var h=[],c={attributes:[R.PositionKind],uniforms:["vClipPlane","vClipPlane2","vClipPlane3","vClipPlane4","vClipPlane5","vClipPlane6","world","viewProjection"],needAlphaBlending:!0,defines:h,useClipPlane:null};return l===!1&&(c.needAlphaBlending=!1),o?(c.defines.push("#define VERTEXCOLOR"),c.attributes.push(R.ColorKind)):(c.uniforms.push("color"),f._color4=new ce),u?f.material=u:f.material=new sn("colorShader",f.getScene(),"color",c,!1),f}return e.prototype._isShaderMaterial=function(t){return t.getClassName()==="ShaderMaterial"},e.prototype.isReady=function(){return this._lineMaterial.isReady(this,!!this._userInstancedBuffersStorage)?i.prototype.isReady.call(this):!1},e.prototype.getClassName=function(){return"LinesMesh"},Object.defineProperty(e.prototype,"material",{get:function(){return this._lineMaterial},set:function(t){this._lineMaterial=t,this._lineMaterial.fillMode=He.LineListDrawMode},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"checkCollisions",{get:function(){return!1},set:function(t){},enumerable:!1,configurable:!0}),e.prototype._bind=function(){if(!this._geometry)return this;var t=this._lineMaterial.getEffect(),r=this.isUnIndexed?null:this._geometry.getIndexBuffer();if(this._userInstancedBuffersStorage?this._geometry._bind(t,r,this._userInstancedBuffersStorage.vertexBuffers,this._userInstancedBuffersStorage.vertexArrayObjects):this._geometry._bind(t,r),!this.useVertexColor&&this._isShaderMaterial(this._lineMaterial)){var n=this.color,a=n.r,s=n.g,o=n.b;this._color4.set(a,s,o,this.alpha),this._lineMaterial.setColor4("color",this._color4)}return this},e.prototype._draw=function(t,r,n){if(!this._geometry||!this._geometry.getVertexBuffers()||!this._unIndexed&&!this._geometry.getIndexBuffer())return this;var a=this.getScene().getEngine();return this._unIndexed?a.drawArraysType(He.LineListDrawMode,t.verticesStart,t.verticesCount,n):a.drawElementsType(He.LineListDrawMode,t.indexStart,t.indexCount,n),this},e.prototype.dispose=function(t){this._lineMaterial.dispose(!1,!1,!0),i.prototype.dispose.call(this,t)},e.prototype.clone=function(t,r,n){return r===void 0&&(r=null),new e(t,this.getScene(),r,this,n)},e.prototype.createInstance=function(t){var r=new $l(t,this);if(this.instancedBuffers){r.instancedBuffers={};for(var n in this.instancedBuffers)r.instancedBuffers[n]=this.instancedBuffers[n]}return r},e.prototype.serialize=function(t){i.prototype.serialize.call(this,t),t.color=this.color.asArray(),t.alpha=this.alpha},e.Parse=function(t,r){var n=new e(t.name,r);return n.color=me.FromArray(t.color),n.alpha=t.alpha,n},e}(O),$l=function(i){$(e,i);function e(t,r){var n=i.call(this,t,r)||this;return n.intersectionThreshold=r.intersectionThreshold,n}return e.prototype.getClassName=function(){return"InstancedLinesMesh"},e}(ss);function os(i){for(var e=[],t=[],r=i.lines,n=i.colors,a=[],s=0,o=0;o<r.length;o++)for(var l=r[o],u=0;u<l.length;u++){if(t.push(l[u].x,l[u].y,l[u].z),n){var f=n[o];a.push(f[u].r,f[u].g,f[u].b,f[u].a)}u>0&&(e.push(s-1),e.push(s)),s++}var h=new J;return h.indices=e,h.positions=t,n&&(h.colors=a),h}function ls(i){var e=i.dashSize||3,t=i.gapSize||1,r=i.dashNb||200,n=i.points,a=new Array,s=new Array,o=m.Zero(),l=0,u=0,f=0,h=0,c=0,d=0,p=0;for(p=0;p<n.length-1;p++)n[p+1].subtractToRef(n[p],o),l+=o.length();for(f=l/r,h=e*f/(e+t),p=0;p<n.length-1;p++){n[p+1].subtractToRef(n[p],o),u=Math.floor(o.length()/f),o.normalize();for(var _=0;_<u;_++)c=f*_,a.push(n[p].x+c*o.x,n[p].y+c*o.y,n[p].z+c*o.z),a.push(n[p].x+(c+h)*o.x,n[p].y+(c+h)*o.y,n[p].z+(c+h)*o.z),s.push(d,d+1),d+=2}var g=new J;return g.positions=a,g.indices=s,g}function us(i,e,t){var r=e.instance,n=e.lines,a=e.colors;if(r){var s=r.getVerticesData(R.PositionKind),o=void 0,l=void 0;a&&(o=r.getVerticesData(R.ColorKind));for(var u=0,f=0,h=0;h<n.length;h++)for(var c=n[h],d=0;d<c.length;d++)s[u]=c[d].x,s[u+1]=c[d].y,s[u+2]=c[d].z,a&&o&&(l=a[h],o[f]=l[d].r,o[f+1]=l[d].g,o[f+2]=l[d].b,o[f+3]=l[d].a,f+=4),u+=3;return r.updateVerticesData(R.PositionKind,s,!1,!1),a&&o&&r.updateVerticesData(R.ColorKind,o,!1,!1),r}var p=!!a,_=new fn(i,t,null,void 0,void 0,p,e.useVertexAlpha,e.material),g=os(e);return g.applyToMesh(_,e.updatable),_}function fs(i,e,t){t===void 0&&(t=null);var r=e.colors?[e.colors]:null,n=us(i,{lines:[e.points],updatable:e.updatable,instance:e.instance,colors:r,useVertexAlpha:e.useVertexAlpha,material:e.material},t);return n}function hs(i,e,t){t===void 0&&(t=null);var r=e.points,n=e.instance,a=e.gapSize||1,s=e.dashSize||3;if(n){var o=function(f){var h=m.Zero(),c=f.length/6,d=0,p=0,_=0,g=0,v=0,y=0,b=0,E=0;for(b=0;b<r.length-1;b++)r[b+1].subtractToRef(r[b],h),d+=h.length();_=d/c;var A=n._creationDataStorage.dashSize,S=n._creationDataStorage.gapSize;for(g=A*_/(A+S),b=0;b<r.length-1;b++)for(r[b+1].subtractToRef(r[b],h),p=Math.floor(h.length()/_),h.normalize(),E=0;E<p&&y<f.length;)v=_*E,f[y]=r[b].x+v*h.x,f[y+1]=r[b].y+v*h.y,f[y+2]=r[b].z+v*h.z,f[y+3]=r[b].x+(v+g)*h.x,f[y+4]=r[b].y+(v+g)*h.y,f[y+5]=r[b].z+(v+g)*h.z,y+=6,E++;for(;y<f.length;)f[y]=r[b].x,f[y+1]=r[b].y,f[y+2]=r[b].z,y+=3};return n.updateMeshPositions(o,!1),n}var l=new fn(i,t,null,void 0,void 0,void 0,e.useVertexAlpha,e.material),u=ls(e);return u.applyToMesh(l,e.updatable),l._creationDataStorage=new Ka,l._creationDataStorage.dashSize=s,l._creationDataStorage.gapSize=a,l}J.CreateLineSystem=os;J.CreateDashedLines=ls;O.CreateLines=function(i,e,t,r,n){t===void 0&&(t=null),r===void 0&&(r=!1),n===void 0&&(n=null);var a={points:e,updatable:r,instance:n};return fs(i,a,t)};O.CreateDashedLines=function(i,e,t,r,n,a,s,o){a===void 0&&(a=null);var l={points:e,dashSize:t,gapSize:r,dashNb:n,updatable:s,instance:o};return hs(i,l,a)};var vr;(function(i){i[i.CW=0]="CW",i[i.CCW=1]="CCW"})(vr||(vr={}));var Jl=function(){function i(){}return i.Interpolate=function(e,t,r,n,a){for(var s=1-3*n+3*t,o=3*n-6*t,l=3*t,u=e,f=0;f<5;f++){var h=u*u,c=h*u,d=s*c+o*h+l*u,p=1/(3*s*h+2*o*u+l);u-=(d-e)*p,u=Math.min(1,Math.max(0,u))}return 3*Math.pow(1-u,2)*u*r+3*(1-u)*Math.pow(u,2)*a+Math.pow(u,3)},i}(),zr=function(){function i(e){this._radians=e,this._radians<0&&(this._radians+=2*Math.PI)}return i.prototype.degrees=function(){return this._radians*180/Math.PI},i.prototype.radians=function(){return this._radians},i.BetweenTwoPoints=function(e,t){var r=t.subtract(e),n=Math.atan2(r.y,r.x);return new i(n)},i.FromRadians=function(e){return new i(e)},i.FromDegrees=function(e){return new i(e*Math.PI/180)},i}(),eu=function(){function i(e,t,r){this.startPoint=e,this.midPoint=t,this.endPoint=r;var n=Math.pow(t.x,2)+Math.pow(t.y,2),a=(Math.pow(e.x,2)+Math.pow(e.y,2)-n)/2,s=(n-Math.pow(r.x,2)-Math.pow(r.y,2))/2,o=(e.x-t.x)*(t.y-r.y)-(t.x-r.x)*(e.y-t.y);this.centerPoint=new se((a*(t.y-r.y)-s*(e.y-t.y))/o,((e.x-t.x)*s-(t.x-r.x)*a)/o),this.radius=this.centerPoint.subtract(this.startPoint).length(),this.startAngle=zr.BetweenTwoPoints(this.centerPoint,this.startPoint);var l=this.startAngle.degrees(),u=zr.BetweenTwoPoints(this.centerPoint,this.midPoint).degrees(),f=zr.BetweenTwoPoints(this.centerPoint,this.endPoint).degrees();u-l>180&&(u-=360),u-l<-180&&(u+=360),f-u>180&&(f-=360),f-u<-180&&(f+=360),this.orientation=u-l<0?vr.CW:vr.CCW,this.angle=zr.FromDegrees(this.orientation===vr.CW?l-f:f-l)}return i}(),tu=function(){function i(e,t){this._points=new Array,this._length=0,this.closed=!1,this._points.push(new se(e,t))}return i.prototype.addLineTo=function(e,t){if(this.closed)return this;var r=new se(e,t),n=this._points[this._points.length-1];return this._points.push(r),this._length+=r.subtract(n).length(),this},i.prototype.addArcTo=function(e,t,r,n,a){if(a===void 0&&(a=36),this.closed)return this;var s=this._points[this._points.length-1],o=new se(e,t),l=new se(r,n),u=new eu(s,o,l),f=u.angle.radians()/a;u.orientation===vr.CW&&(f*=-1);for(var h=u.startAngle.radians()+f,c=0;c<a;c++){var d=Math.cos(h)*u.radius+u.centerPoint.x,p=Math.sin(h)*u.radius+u.centerPoint.y;this.addLineTo(d,p),h+=f}return this},i.prototype.close=function(){return this.closed=!0,this},i.prototype.length=function(){var e=this._length;if(this.closed){var t=this._points[this._points.length-1],r=this._points[0];e+=r.subtract(t).length()}return e},i.prototype.getPoints=function(){return this._points},i.prototype.getPointAtLengthPosition=function(e){if(e<0||e>1)return se.Zero();for(var t=e*this.length(),r=0,n=0;n<this._points.length;n++){var a=(n+1)%this._points.length,s=this._points[n],o=this._points[a],l=o.subtract(s),u=l.length()+r;if(t>=r&&t<=u){var f=l.normalize(),h=t-r;return new se(s.x+f.x*h,s.y+f.y*h)}r=u}return se.Zero()},i.StartingAt=function(e,t){return new i(e,t)},i}(),cs=function(){function i(e,t,r,n){t===void 0&&(t=null),n===void 0&&(n=!1),this.path=e,this._curve=new Array,this._distances=new Array,this._tangents=new Array,this._normals=new Array,this._binormals=new Array,this._pointAtData={id:0,point:m.Zero(),previousPointArrayIndex:0,position:0,subPosition:0,interpolateReady:!1,interpolationMatrix:G.Identity()};for(var a=0;a<e.length;a++)this._curve[a]=e[a].clone();this._raw=r||!1,this._alignTangentsWithPath=n,this._compute(t,n)}return i.prototype.getCurve=function(){return this._curve},i.prototype.getPoints=function(){return this._curve},i.prototype.length=function(){return this._distances[this._distances.length-1]},i.prototype.getTangents=function(){return this._tangents},i.prototype.getNormals=function(){return this._normals},i.prototype.getBinormals=function(){return this._binormals},i.prototype.getDistances=function(){return this._distances},i.prototype.getPointAt=function(e){return this._updatePointAtData(e).point},i.prototype.getTangentAt=function(e,t){return t===void 0&&(t=!1),this._updatePointAtData(e,t),t?m.TransformCoordinates(m.Forward(),this._pointAtData.interpolationMatrix):this._tangents[this._pointAtData.previousPointArrayIndex]},i.prototype.getNormalAt=function(e,t){return t===void 0&&(t=!1),this._updatePointAtData(e,t),t?m.TransformCoordinates(m.Right(),this._pointAtData.interpolationMatrix):this._normals[this._pointAtData.previousPointArrayIndex]},i.prototype.getBinormalAt=function(e,t){return t===void 0&&(t=!1),this._updatePointAtData(e,t),t?m.TransformCoordinates(m.UpReadOnly,this._pointAtData.interpolationMatrix):this._binormals[this._pointAtData.previousPointArrayIndex]},i.prototype.getDistanceAt=function(e){return this.length()*e},i.prototype.getPreviousPointIndexAt=function(e){return this._updatePointAtData(e),this._pointAtData.previousPointArrayIndex},i.prototype.getSubPositionAt=function(e){return this._updatePointAtData(e),this._pointAtData.subPosition},i.prototype.getClosestPositionTo=function(e){for(var t=Number.MAX_VALUE,r=0,n=0;n<this._curve.length-1;n++){var a=this._curve[n+0],s=this._curve[n+1].subtract(a).normalize(),o=this._distances[n+1]-this._distances[n+0],l=Math.min(Math.max(m.Dot(s,e.subtract(a).normalize()),0)*m.Distance(a,e)/o,1),u=m.Distance(a.add(s.scale(l*o)),e);u<t&&(t=u,r=(this._distances[n+0]+o*l)/this.length())}return r},i.prototype.slice=function(e,t){if(e===void 0&&(e=0),t===void 0&&(t=1),e<0&&(e=1-e*-1%1),t<0&&(t=1-t*-1%1),e>t){var r=e;e=t,t=r}var n=this.getCurve(),a=this.getPointAt(e),s=this.getPreviousPointIndexAt(e),o=this.getPointAt(t),l=this.getPreviousPointIndexAt(t)+1,u=[];return e!==0&&(s++,u.push(a)),u.push.apply(u,n.slice(s,l)),(t!==1||e===1)&&u.push(o),new i(u,this.getNormalAt(e),this._raw,this._alignTangentsWithPath)},i.prototype.update=function(e,t,r){t===void 0&&(t=null),r===void 0&&(r=!1);for(var n=0;n<e.length;n++)this._curve[n].x=e[n].x,this._curve[n].y=e[n].y,this._curve[n].z=e[n].z;return this._compute(t,r),this},i.prototype._compute=function(e,t){t===void 0&&(t=!1);var r=this._curve.length;if(!(r<2)){this._tangents[0]=this._getFirstNonNullVector(0),this._raw||this._tangents[0].normalize(),this._tangents[r-1]=this._curve[r-1].subtract(this._curve[r-2]),this._raw||this._tangents[r-1].normalize();var n=this._tangents[0],a=this._normalVector(n,e);this._normals[0]=a,this._raw||this._normals[0].normalize(),this._binormals[0]=m.Cross(n,this._normals[0]),this._raw||this._binormals[0].normalize(),this._distances[0]=0;for(var s,o,l,u,f,h=1;h<r;h++)s=this._getLastNonNullVector(h),h<r-1&&(o=this._getFirstNonNullVector(h),this._tangents[h]=t?o:s.add(o),this._tangents[h].normalize()),this._distances[h]=this._distances[h-1]+this._curve[h].subtract(this._curve[h-1]).length(),l=this._tangents[h],f=this._binormals[h-1],this._normals[h]=m.Cross(f,l),this._raw||(this._normals[h].length()===0?(u=this._normals[h-1],this._normals[h]=u.clone()):this._normals[h].normalize()),this._binormals[h]=m.Cross(l,this._normals[h]),this._raw||this._binormals[h].normalize();this._pointAtData.id=NaN}},i.prototype._getFirstNonNullVector=function(e){for(var t=1,r=this._curve[e+t].subtract(this._curve[e]);r.length()===0&&e+t+1<this._curve.length;)t++,r=this._curve[e+t].subtract(this._curve[e]);return r},i.prototype._getLastNonNullVector=function(e){for(var t=1,r=this._curve[e].subtract(this._curve[e-t]);r.length()===0&&e>t+1;)t++,r=this._curve[e].subtract(this._curve[e-t]);return r},i.prototype._normalVector=function(e,t){var r,n=e.length();if(n===0&&(n=1),t==null){var a=void 0;K.WithinEpsilon(Math.abs(e.y)/n,1,Me)?K.WithinEpsilon(Math.abs(e.x)/n,1,Me)?K.WithinEpsilon(Math.abs(e.z)/n,1,Me)?a=m.Zero():a=new m(0,0,1):a=new m(1,0,0):a=new m(0,-1,0),r=m.Cross(e,a)}else r=m.Cross(e,t),m.CrossToRef(r,e,r);return r.normalize(),r},i.prototype._updatePointAtData=function(e,t){if(t===void 0&&(t=!1),this._pointAtData.id===e)return this._pointAtData.interpolateReady||this._updateInterpolationMatrix(),this._pointAtData;this._pointAtData.id=e;var r=this.getPoints();if(e<=0)return this._setPointAtData(0,0,r[0],0,t);if(e>=1)return this._setPointAtData(1,1,r[r.length-1],r.length-1,t);for(var n=r[0],a,s=0,o=e*this.length(),l=1;l<r.length;l++){a=r[l];var u=m.Distance(n,a);if(s+=u,s===o)return this._setPointAtData(e,1,a,l,t);if(s>o){var f=s-o,h=f/u,c=n.subtract(a),d=a.add(c.scaleInPlace(h));return this._setPointAtData(e,1-h,d,l-1,t)}n=a}return this._pointAtData},i.prototype._setPointAtData=function(e,t,r,n,a){return this._pointAtData.point=r,this._pointAtData.position=e,this._pointAtData.subPosition=t,this._pointAtData.previousPointArrayIndex=n,this._pointAtData.interpolateReady=a,a&&this._updateInterpolationMatrix(),this._pointAtData},i.prototype._updateInterpolationMatrix=function(){this._pointAtData.interpolationMatrix=G.Identity();var e=this._pointAtData.previousPointArrayIndex;if(e!==this._tangents.length-1){var t=e+1,r=this._tangents[e].clone(),n=this._normals[e].clone(),a=this._binormals[e].clone(),s=this._tangents[t].clone(),o=this._normals[t].clone(),l=this._binormals[t].clone(),u=de.RotationQuaternionFromAxis(n,a,r),f=de.RotationQuaternionFromAxis(o,l,s),h=de.Slerp(u,f,this._pointAtData.subPosition);h.toRotationMatrix(this._pointAtData.interpolationMatrix)}},i}(),Rp=function(){function i(e){this._length=0,this._points=e,this._length=this._computeLength(e)}return i.CreateQuadraticBezier=function(e,t,r,n){n=n>2?n:3;for(var a=new Array,s=function(l,u,f,h){var c=(1-l)*(1-l)*u+2*l*(1-l)*f+l*l*h;return c},o=0;o<=n;o++)a.push(new m(s(o/n,e.x,t.x,r.x),s(o/n,e.y,t.y,r.y),s(o/n,e.z,t.z,r.z)));return new i(a)},i.CreateCubicBezier=function(e,t,r,n,a){a=a>3?a:4;for(var s=new Array,o=function(u,f,h,c,d){var p=(1-u)*(1-u)*(1-u)*f+3*u*(1-u)*(1-u)*h+3*u*u*(1-u)*c+u*u*u*d;return p},l=0;l<=a;l++)s.push(new m(o(l/a,e.x,t.x,r.x,n.x),o(l/a,e.y,t.y,r.y,n.y),o(l/a,e.z,t.z,r.z,n.z)));return new i(s)},i.CreateHermiteSpline=function(e,t,r,n,a){for(var s=new Array,o=1/a,l=0;l<=a;l++)s.push(m.Hermite(e,t,r,n,l*o));return new i(s)},i.CreateCatmullRomSpline=function(e,t,r){var n=new Array,a=1/t,s=0;if(r){for(var o=e.length,l=0;l<o;l++){s=0;for(var u=0;u<t;u++)n.push(m.CatmullRom(e[l%o],e[(l+1)%o],e[(l+2)%o],e[(l+3)%o],s)),s+=a}n.push(n[0])}else{var f=new Array;f.push(e[0].clone()),Array.prototype.push.apply(f,e),f.push(e[e.length-1].clone());for(var l=0;l<f.length-3;l++){s=0;for(var u=0;u<t;u++)n.push(m.CatmullRom(f[l],f[l+1],f[l+2],f[l+3],s)),s+=a}l--,n.push(m.CatmullRom(f[l],f[l+1],f[l+2],f[l+3],s))}return new i(n)},i.ArcThru3Points=function(e,t,r,n,a,s){n===void 0&&(n=32),a===void 0&&(a=!1),s===void 0&&(s=!1);var o=new Array,l=t.subtract(e),u=r.subtract(t),f=e.subtract(r),h=m.Cross(l,u),c=h.length();if(c<Math.pow(10,-8))return new i(o);var d=l.lengthSquared(),p=u.lengthSquared(),_=f.lengthSquared(),g=h.lengthSquared(),v=l.length(),y=u.length(),b=f.length(),E=.5*v*y*b/c,A=m.Dot(l,f),S=m.Dot(l,u),T=m.Dot(u,f),M=-.5*p*A/g,D=-.5*_*S/g,x=-.5*d*T/g,P=e.scale(M).add(t.scale(D)).add(r.scale(x)),w=e.subtract(P),k=w.normalize(),B=m.Cross(h,k).normalize();if(s){for(var L=2*Math.PI/n,H=0;H<=2*Math.PI;H+=L)o.push(P.add(k.scale(E*Math.cos(H)).add(B.scale(E*Math.sin(H)))));o.push(e)}else{var L=1/n,H=0,W=m.Zero();do W=P.add(k.scale(E*Math.cos(H)).add(B.scale(E*Math.sin(H)))),o.push(W),H+=L;while(!W.equalsWithEpsilon(r,E*L*1.1));o.push(r),a&&o.push(e)}return new i(o)},i.prototype.getPoints=function(){return this._points},i.prototype.length=function(){return this._length},i.prototype.continue=function(e){for(var t=this._points[this._points.length-1],r=this._points.slice(),n=e.getPoints(),a=1;a<n.length;a++)r.push(n[a].subtract(n[0]).add(t));var s=new i(r);return s},i.prototype._computeLength=function(e){for(var t=0,r=1;r<e.length;r++)t+=e[r].subtract(e[r-1]).length();return t},i}(),ru=function(i){$(e,i);function e(t,r){var n=i.call(this,t.x,t.y)||this;return n.index=r,n}return e}(se),gi=function(){function i(){this.elements=new Array}return i.prototype.add=function(e){var t=this,r=new Array;return e.forEach(function(n){var a=new ru(n,t.elements.length);r.push(a),t.elements.push(a)}),r},i.prototype.computeBounds=function(){var e=new se(this.elements[0].x,this.elements[0].y),t=new se(this.elements[0].x,this.elements[0].y);return this.elements.forEach(function(r){r.x<e.x?e.x=r.x:r.x>t.x&&(t.x=r.x),r.y<e.y?e.y=r.y:r.y>t.y&&(t.y=r.y)}),{min:e,max:t,width:t.x-e.x,height:t.y-e.y}},i}(),iu=function(){function i(e,t,r,n){n===void 0&&(n=earcut),this._points=new gi,this._outlinepoints=new gi,this._holes=new Array,this._epoints=new Array,this._eholes=new Array,this.bjsEarcut=n,this._name=e,this._scene=r||ye.LastCreatedScene;var a;t instanceof tu?a=t.getPoints():a=t,this._addToepoint(a),this._points.add(a),this._outlinepoints.add(a),typeof this.bjsEarcut=="undefined"&&Y.Warn("Earcut was not found, the polygon will not be built.")}return i.prototype._addToepoint=function(e){for(var t=0,r=e;t<r.length;t++){var n=r[t];this._epoints.push(n.x,n.y)}},i.prototype.addHole=function(e){this._points.add(e);var t=new gi;return t.add(e),this._holes.push(t),this._eholes.push(this._epoints.length/2),this._addToepoint(e),this},i.prototype.build=function(e,t,r){e===void 0&&(e=!1),t===void 0&&(t=0),r===void 0&&(r=2);var n=new O(this._name,this._scene),a=this.buildVertexData(t,r);return n.setVerticesData(R.PositionKind,a.positions,e),n.setVerticesData(R.NormalKind,a.normals,e),n.setVerticesData(R.UVKind,a.uvs,e),n.setIndices(a.indices),n},i.prototype.buildVertexData=function(e,t){var r=this;e===void 0&&(e=0),t===void 0&&(t=2);var n=new J,a=new Array,s=new Array,o=new Array,l=this._points.computeBounds();this._points.elements.forEach(function(v){a.push(0,1,0),s.push(v.x,0,v.y),o.push((v.x-l.min.x)/l.width,(v.y-l.min.y)/l.height)});for(var u=new Array,f=this.bjsEarcut(this._epoints,this._eholes,2),h=0;h<f.length;h++)u.push(f[h]);if(e>0){var c=s.length/3;this._points.elements.forEach(function(v){a.push(0,-1,0),s.push(v.x,-e,v.y),o.push(1-(v.x-l.min.x)/l.width,1-(v.y-l.min.y)/l.height)});for(var d=u.length,h=0;h<d;h+=3){var p=u[h+0],_=u[h+1],g=u[h+2];u.push(g+c),u.push(_+c),u.push(p+c)}this._addSide(s,a,o,u,l,this._outlinepoints,e,!1,t),this._holes.forEach(function(v){r._addSide(s,a,o,u,l,v,e,!0,t)})}return n.indices=u,n.positions=s,n.normals=a,n.uvs=o,n},i.prototype._addSide=function(e,t,r,n,a,s,o,l,u){for(var f=e.length/3,h=0,c=0;c<s.elements.length;c++){var d=s.elements[c],p=s.elements[(c+1)%s.elements.length];e.push(d.x,0,d.y),e.push(d.x,-o,d.y),e.push(p.x,0,p.y),e.push(p.x,-o,p.y);var _=s.elements[(c+s.elements.length-1)%s.elements.length],g=s.elements[(c+2)%s.elements.length],v=new m(-(p.y-d.y),0,p.x-d.x),y=new m(-(d.y-_.y),0,d.x-_.x),b=new m(-(g.y-p.y),0,g.x-p.x);l||(v=v.scale(-1),y=y.scale(-1),b=b.scale(-1));var E=v.normalizeToNew(),A=y.normalizeToNew(),S=b.normalizeToNew(),T=m.Dot(A,E);T>u?T<Me-1?A=new m(d.x,0,d.y).subtract(new m(p.x,0,p.y)).normalize():A=y.add(v).normalize():A=E;var M=m.Dot(b,v);M>u?M<Me-1?S=new m(p.x,0,p.y).subtract(new m(d.x,0,d.y)).normalize():S=b.add(v).normalize():S=E,r.push(h/a.width,0),r.push(h/a.width,1),h+=v.length(),r.push(h/a.width,0),r.push(h/a.width,1),t.push(A.x,A.y,A.z),t.push(A.x,A.y,A.z),t.push(S.x,S.y,S.z),t.push(S.x,S.y,S.z),l?(n.push(f),n.push(f+2),n.push(f+1),n.push(f+1),n.push(f+2),n.push(f+3)):(n.push(f),n.push(f+1),n.push(f+2),n.push(f+1),n.push(f+3),n.push(f+2)),f+=4}},i}();function ds(i,e,t,r,n,a,s){for(var o=t||new Array(3),l=r,u=[],f=s||!1,h=0;h<3;h++)o[h]===void 0&&(o[h]=new Ke(0,0,1,1)),l&&l[h]===void 0&&(l[h]=new ce(1,1,1,1));var c=i.getVerticesData(R.PositionKind),d=i.getVerticesData(R.NormalKind),p=i.getVerticesData(R.UVKind),_=i.getIndices(),g=c.length/9,v=0,y=0,b=0,E=0,A=0,S=[0];if(f)for(var T=g;T<c.length/3;T+=4)y=c[3*(T+2)]-c[3*T],b=c[3*(T+2)+2]-c[3*T+2],E=Math.sqrt(y*y+b*b),A+=E,S.push(A);for(var M=0,D=0,x=0;x<d.length;x+=3)Math.abs(d[x+1])<.001&&(D=1),Math.abs(d[x+1]-1)<.001&&(D=0),Math.abs(d[x+1]+1)<.001&&(D=2),M=x/3,D===1?(v=M-g,v%4<1.5?f?p[2*M]=o[D].x+(o[D].z-o[D].x)*S[Math.floor(v/4)]/A:p[2*M]=o[D].x:f?p[2*M]=o[D].x+(o[D].z-o[D].x)*S[Math.floor(v/4)+1]/A:p[2*M]=o[D].z,v%2===0?p[2*M+1]=Se.UseOpenGLOrientationForUV?1-o[D].w:o[D].w:p[2*M+1]=Se.UseOpenGLOrientationForUV?1-o[D].y:o[D].y):(p[2*M]=(1-p[2*M])*o[D].x+p[2*M]*o[D].z,p[2*M+1]=(1-p[2*M+1])*o[D].y+p[2*M+1]*o[D].w,Se.UseOpenGLOrientationForUV&&(p[2*M+1]=1-p[2*M+1])),l&&u.push(l[D].r,l[D].g,l[D].b,l[D].a);J._ComputeSides(e,c,_,d,p,n,a);var P=new J;if(P.indices=_,P.positions=c,P.normals=d,P.uvs=p,l){var w=e===J.DOUBLESIDE?u.concat(u):u;P.colors=w}return P}function hn(i,e,t,r){t===void 0&&(t=null),r===void 0&&(r=earcut),e.sideOrientation=O._GetDefaultSideOrientation(e.sideOrientation);for(var n=e.shape,a=e.holes||[],s=e.depth||0,o=e.smoothingThreshold||2,l=[],u=[],f=0;f<n.length;f++)l[f]=new se(n[f].x,n[f].z);var h=1e-8;l[0].equalsWithEpsilon(l[l.length-1],h)&&l.pop();for(var c=new iu(i,l,t||ye.LastCreatedScene,r),d=0;d<a.length;d++){u=[];for(var p=0;p<a[d].length;p++)u.push(new se(a[d][p].x,a[d][p].z));c.addHole(u)}var _=c.build(!1,s,o);_._originalBuilderSideOrientation=e.sideOrientation;var g=ds(_,e.sideOrientation,e.faceUV,e.faceColors,e.frontUVs,e.backUVs,e.wrap);return g.applyToMesh(_,e.updatable),_}function ps(i,e,t,r){return t===void 0&&(t=null),r===void 0&&(r=earcut),hn(i,e,t,r)}J.CreatePolygon=ds;O.CreatePolygon=function(i,e,t,r,n,a,s){s===void 0&&(s=earcut);var o={shape:e,holes:r,updatable:n,sideOrientation:a};return hn(i,o,t,s)};O.ExtrudePolygon=function(i,e,t,r,n,a,s,o){o===void 0&&(o=earcut);var l={shape:e,holes:n,depth:t,updatable:a,sideOrientation:s};return ps(i,l,r,o)};function _s(i,e,t){t===void 0&&(t=null);var r=e.path,n=e.shape,a=e.scale||1,s=e.rotation||0,o=e.cap===0?0:e.cap||O.NO_CAP,l=e.updatable,u=O._GetDefaultSideOrientation(e.sideOrientation),f=e.instance||null,h=e.invertUV||!1,c=e.closeShape||!1,d=e.closePath||!1;return gs(i,n,r,a,s,null,null,d,c,o,!1,t,!!l,u,f,h,e.frontUVs||null,e.backUVs||null)}function vs(i,e,t){t===void 0&&(t=null);var r=e.path,n=e.shape,a=e.scaleFunction||function(){return 1},s=e.rotationFunction||function(){return 0},o=e.closePath||e.ribbonCloseArray||!1,l=e.closeShape||e.ribbonClosePath||!1,u=e.cap===0?0:e.cap||O.NO_CAP,f=e.updatable,h=O._GetDefaultSideOrientation(e.sideOrientation),c=e.instance,d=e.invertUV||!1;return gs(i,n,r,null,null,a,s,o,l,u,!0,t,!!f,h,c||null,d,e.frontUVs||null,e.backUVs||null)}function gs(i,e,t,r,n,a,s,o,l,u,f,h,c,d,p,_,g,v){var y=function(M,D,x,P,w,k,B,L,H,W){for(var F=x.getTangents(),V=x.getNormals(),z=x.getBinormals(),N=x.getDistances(),Q=0,Z=function(){return w!==null?w:1},ee=function(){return k!==null?k:0},ne=W&&L?L:ee,Te=W&&B?B:Z,j=H===O.NO_CAP||H===O.CAP_END?0:2,oe=U.Matrix[0],be=0;be<D.length;be++){for(var Ee=new Array,Pe=ne(be,N[be]),Fe=Te(be,N[be]),Ae=0;Ae<M.length;Ae++){G.RotationAxisToRef(F[be],Q,oe);var xe=F[be].scale(M[Ae].z).add(V[be].scale(M[Ae].x)).add(z[be].scale(M[Ae].y)),_e=Ee[Ae]?Ee[Ae]:m.Zero();m.TransformCoordinatesToRef(xe,oe,_e),_e.scaleInPlace(Fe).addInPlace(D[be]),Ee[Ae]=_e}P[j]=Ee,Q+=Pe,j++}var we=function(Ve){var st=Array(),pt=m.Zero(),yt;for(yt=0;yt<Ve.length;yt++)pt.addInPlace(Ve[yt]);for(pt.scaleInPlace(1/Ve.length),yt=0;yt<Ve.length;yt++)st.push(pt);return st};switch(H){case O.NO_CAP:break;case O.CAP_START:P[0]=we(P[2]),P[1]=P[2];break;case O.CAP_END:P[j]=P[j-1],P[j+1]=we(P[j-1]);break;case O.CAP_ALL:P[0]=we(P[2]),P[1]=P[2],P[j]=P[j-1],P[j+1]=we(P[j-1]);break}return P},b,E;if(p){var A=p._creationDataStorage;return b=A.path3D.update(t),E=y(e,t,A.path3D,A.pathArray,r,n,a,s,A.cap,f),p=hr("",{pathArray:E,closeArray:!1,closePath:!1,offset:0,updatable:!1,sideOrientation:0,instance:p},h||void 0),p}b=new cs(t);var S=new Array;u=u<0||u>3?0:u,E=y(e,t,b,S,r,n,a,s,u,f);var T=hr(i,{pathArray:E,closeArray:o,closePath:l,updatable:c,sideOrientation:d,invertUV:_,frontUVs:g||void 0,backUVs:v||void 0},h);return T._creationDataStorage.pathArray=E,T._creationDataStorage.path3D=b,T._creationDataStorage.cap=u,T}O.ExtrudeShape=function(i,e,t,r,n,a,s,o,l,u){s===void 0&&(s=null);var f={shape:e,path:t,scale:r,rotation:n,cap:a===0?0:a||O.NO_CAP,sideOrientation:l,instance:u,updatable:o};return _s(i,f,s)};O.ExtrudeShapeCustom=function(i,e,t,r,n,a,s,o,l,u,f,h){var c={shape:e,path:t,scaleFunction:r,rotationFunction:n,ribbonCloseArray:a,ribbonClosePath:s,cap:o===0?0:o||O.NO_CAP,sideOrientation:f,instance:h,updatable:u};return vs(i,c,l)};function ms(i,e,t){t===void 0&&(t=null);var r=e.arc?e.arc<=0||e.arc>1?1:e.arc:1,n=e.closed===void 0?!0:e.closed,a=e.shape,s=e.radius||1,o=e.tessellation||64,l=e.clip||0,u=e.updatable,f=O._GetDefaultSideOrientation(e.sideOrientation),h=e.cap||O.NO_CAP,c=Math.PI*2,d=new Array,p=e.invertUV||!1,_=0,g=0,v=c/o*r,y,b;for(_=0;_<=o-l;_++){for(b=[],(h==O.CAP_START||h==O.CAP_ALL)&&(b.push(new m(0,a[0].y,0)),b.push(new m(Math.cos(_*v)*a[0].x*s,a[0].y,Math.sin(_*v)*a[0].x*s))),g=0;g<a.length;g++)y=new m(Math.cos(_*v)*a[g].x*s,a[g].y,Math.sin(_*v)*a[g].x*s),b.push(y);(h==O.CAP_END||h==O.CAP_ALL)&&(b.push(new m(Math.cos(_*v)*a[a.length-1].x*s,a[a.length-1].y,Math.sin(_*v)*a[a.length-1].x*s)),b.push(new m(0,a[a.length-1].y,0))),d.push(b)}var E=hr(i,{pathArray:d,closeArray:n,sideOrientation:f,updatable:u,invertUV:p,frontUVs:e.frontUVs,backUVs:e.backUVs},t);return E}O.CreateLathe=function(i,e,t,r,n,a,s){var o={shape:e,radius:t,tessellation:r,sideOrientation:s,updatable:a};return ms(i,o,n)};function ys(i){var e=[],t=[],r=[],n=[],a=i.width||i.size||1,s=i.height||i.size||1,o=i.sideOrientation===0?0:i.sideOrientation||J.DEFAULTSIDE,l=a/2,u=s/2;t.push(-l,-u,0),r.push(0,0,-1),n.push(0,Se.UseOpenGLOrientationForUV?1:0),t.push(l,-u,0),r.push(0,0,-1),n.push(1,Se.UseOpenGLOrientationForUV?1:0),t.push(l,u,0),r.push(0,0,-1),n.push(1,Se.UseOpenGLOrientationForUV?0:1),t.push(-l,u,0),r.push(0,0,-1),n.push(0,Se.UseOpenGLOrientationForUV?0:1),e.push(0),e.push(1),e.push(2),e.push(0),e.push(2),e.push(3),J._ComputeSides(o,t,e,r,n,i.frontUVs,i.backUVs);var f=new J;return f.indices=e,f.positions=t,f.normals=r,f.uvs=n,f}function li(i,e,t){e===void 0&&(e={}),t===void 0&&(t=null);var r=new O(i,t);e.sideOrientation=O._GetDefaultSideOrientation(e.sideOrientation),r._originalBuilderSideOrientation=e.sideOrientation;var n=ys(e);return n.applyToMesh(r,e.updatable),e.sourcePlane&&(r.translate(e.sourcePlane.normal,-e.sourcePlane.d),r.setDirection(e.sourcePlane.normal.scale(-1))),r}J.CreatePlane=ys;O.CreatePlane=function(i,e,t,r,n){var a={size:e,width:e,height:e,sideOrientation:n,updatable:r};return li(i,a,t)};O._GroundMeshParser=function(i,e){return cn.Parse(i,e)};var cn=function(i){$(e,i);function e(t,r){var n=i.call(this,t,r)||this;return n.generateOctree=!1,n}return e.prototype.getClassName=function(){return"GroundMesh"},Object.defineProperty(e.prototype,"subdivisions",{get:function(){return Math.min(this._subdivisionsX,this._subdivisionsY)},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"subdivisionsX",{get:function(){return this._subdivisionsX},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"subdivisionsY",{get:function(){return this._subdivisionsY},enumerable:!1,configurable:!0}),e.prototype.optimize=function(t,r){r===void 0&&(r=32),this._subdivisionsX=t,this._subdivisionsY=t,this.subdivide(t);var n=this;n.createOrUpdateSubmeshesOctree&&n.createOrUpdateSubmeshesOctree(r)},e.prototype.getHeightAtCoordinates=function(t,r){var n=this.getWorldMatrix(),a=U.Matrix[5];n.invertToRef(a);var s=U.Vector3[8];if(m.TransformCoordinatesFromFloatsToRef(t,0,r,a,s),t=s.x,r=s.z,t<this._minX||t>this._maxX||r<this._minZ||r>this._maxZ)return this.position.y;(!this._heightQuads||this._heightQuads.length==0)&&(this._initHeightQuads(),this._computeHeightQuads());var o=this._getFacetAt(t,r),l=-(o.x*t+o.z*r+o.w)/o.y;return m.TransformCoordinatesFromFloatsToRef(0,l,0,n,s),s.y},e.prototype.getNormalAtCoordinates=function(t,r){var n=new m(0,1,0);return this.getNormalAtCoordinatesToRef(t,r,n),n},e.prototype.getNormalAtCoordinatesToRef=function(t,r,n){var a=this.getWorldMatrix(),s=U.Matrix[5];a.invertToRef(s);var o=U.Vector3[8];if(m.TransformCoordinatesFromFloatsToRef(t,0,r,s,o),t=o.x,r=o.z,t<this._minX||t>this._maxX||r<this._minZ||r>this._maxZ)return this;(!this._heightQuads||this._heightQuads.length==0)&&(this._initHeightQuads(),this._computeHeightQuads());var l=this._getFacetAt(t,r);return m.TransformNormalFromFloatsToRef(l.x,l.y,l.z,a,n),this},e.prototype.updateCoordinateHeights=function(){return(!this._heightQuads||this._heightQuads.length==0)&&this._initHeightQuads(),this._computeHeightQuads(),this},e.prototype._getFacetAt=function(t,r){var n=Math.floor((t+this._maxX)*this._subdivisionsX/this._width),a=Math.floor(-(r+this._maxZ)*this._subdivisionsY/this._height+this._subdivisionsY),s=this._heightQuads[a*this._subdivisionsX+n],o;return r<s.slope.x*t+s.slope.y?o=s.facet1:o=s.facet2,o},e.prototype._initHeightQuads=function(){var t=this._subdivisionsX,r=this._subdivisionsY;this._heightQuads=new Array;for(var n=0;n<r;n++)for(var a=0;a<t;a++){var s={slope:se.Zero(),facet1:new Ke(0,0,0,0),facet2:new Ke(0,0,0,0)};this._heightQuads[n*t+a]=s}return this},e.prototype._computeHeightQuads=function(){var t=this.getVerticesData(R.PositionKind);if(!t)return this;for(var r=U.Vector3[3],n=U.Vector3[2],a=U.Vector3[1],s=U.Vector3[0],o=U.Vector3[4],l=U.Vector3[5],u=U.Vector3[6],f=U.Vector3[7],h=U.Vector3[8],c=0,d=0,p=0,_=0,g=0,v=0,y=0,b=this._subdivisionsX,E=this._subdivisionsY,A=0;A<E;A++)for(var S=0;S<b;S++){c=S*3,d=A*(b+1)*3,p=(A+1)*(b+1)*3,r.x=t[d+c],r.y=t[d+c+1],r.z=t[d+c+2],n.x=t[d+c+3],n.y=t[d+c+4],n.z=t[d+c+5],a.x=t[p+c],a.y=t[p+c+1],a.z=t[p+c+2],s.x=t[p+c+3],s.y=t[p+c+4],s.z=t[p+c+5],_=(s.z-r.z)/(s.x-r.x),g=r.z-_*r.x,n.subtractToRef(r,o),a.subtractToRef(r,l),s.subtractToRef(r,u),m.CrossToRef(u,l,f),m.CrossToRef(o,u,h),f.normalize(),h.normalize(),v=-(f.x*r.x+f.y*r.y+f.z*r.z),y=-(h.x*n.x+h.y*n.y+h.z*n.z);var T=this._heightQuads[A*b+S];T.slope.copyFromFloats(_,g),T.facet1.copyFromFloats(f.x,f.y,f.z,v),T.facet2.copyFromFloats(h.x,h.y,h.z,y)}return this},e.prototype.serialize=function(t){i.prototype.serialize.call(this,t),t.subdivisionsX=this._subdivisionsX,t.subdivisionsY=this._subdivisionsY,t.minX=this._minX,t.maxX=this._maxX,t.minZ=this._minZ,t.maxZ=this._maxZ,t.width=this._width,t.height=this._height},e.Parse=function(t,r){var n=new e(t.name,r);return n._subdivisionsX=t.subdivisionsX||1,n._subdivisionsY=t.subdivisionsY||1,n._minX=t.minX,n._maxX=t.maxX,n._minZ=t.minZ,n._maxZ=t.maxZ,n._width=t.width,n._height=t.height,n},e}(O);function bs(i){var e=[],t=[],r=[],n=[],a,s,o=i.width||1,l=i.height||1,u=i.subdivisionsX||i.subdivisions||1,f=i.subdivisionsY||i.subdivisions||1;for(a=0;a<=f;a++)for(s=0;s<=u;s++){var h=new m(s*o/u-o/2,0,(f-a)*l/f-l/2),c=new m(0,1,0);t.push(h.x,h.y,h.z),r.push(c.x,c.y,c.z),n.push(s/u,Se.UseOpenGLOrientationForUV?a/f:1-a/f)}for(a=0;a<f;a++)for(s=0;s<u;s++)e.push(s+1+(a+1)*(u+1)),e.push(s+1+a*(u+1)),e.push(s+a*(u+1)),e.push(s+(a+1)*(u+1)),e.push(s+1+(a+1)*(u+1)),e.push(s+a*(u+1));var d=new J;return d.indices=e,d.positions=t,d.normals=r,d.uvs=n,d}function Ts(i){var e=i.xmin!==void 0&&i.xmin!==null?i.xmin:-1,t=i.zmin!==void 0&&i.zmin!==null?i.zmin:-1,r=i.xmax!==void 0&&i.xmax!==null?i.xmax:1,n=i.zmax!==void 0&&i.zmax!==null?i.zmax:1,a=i.subdivisions||{w:1,h:1},s=i.precision||{w:1,h:1},o=new Array,l=new Array,u=new Array,f=new Array,h,c,d,p;a.h=a.h<1?1:a.h,a.w=a.w<1?1:a.w,s.w=s.w<1?1:s.w,s.h=s.h<1?1:s.h;var _={w:(r-e)/a.w,h:(n-t)/a.h};function g(y,b,E,A){var S=l.length/3,T=s.w+1;for(h=0;h<s.h;h++)for(c=0;c<s.w;c++){var M=[S+c+h*T,S+(c+1)+h*T,S+(c+1)+(h+1)*T,S+c+(h+1)*T];o.push(M[1]),o.push(M[2]),o.push(M[3]),o.push(M[0]),o.push(M[1]),o.push(M[3])}var D=m.Zero(),x=new m(0,1,0);for(h=0;h<=s.h;h++)for(D.z=h*(A-b)/s.h+b,c=0;c<=s.w;c++)D.x=c*(E-y)/s.w+y,D.y=0,l.push(D.x,D.y,D.z),u.push(x.x,x.y,x.z),f.push(c/s.w,h/s.h)}for(d=0;d<a.h;d++)for(p=0;p<a.w;p++)g(e+p*_.w,t+d*_.h,e+(p+1)*_.w,t+(d+1)*_.h);var v=new J;return v.indices=o,v.positions=l,v.normals=u,v.uvs=f,v}function Es(i){var e=[],t=[],r=[],n=[],a,s,o=i.colorFilter||new me(.3,.59,.11),l=i.alphaFilter||0,u=!1;if(i.minHeight>i.maxHeight){u=!0;var f=i.maxHeight;i.maxHeight=i.minHeight,i.minHeight=f}for(a=0;a<=i.subdivisions;a++)for(s=0;s<=i.subdivisions;s++){var h=new m(s*i.width/i.subdivisions-i.width/2,0,(i.subdivisions-a)*i.height/i.subdivisions-i.height/2),c=(h.x+i.width/2)/i.width*(i.bufferWidth-1)|0,d=(1-(h.z+i.height/2)/i.height)*(i.bufferHeight-1)|0,p=(c+d*i.bufferWidth)*4,_=i.buffer[p]/255,g=i.buffer[p+1]/255,v=i.buffer[p+2]/255,y=i.buffer[p+3]/255;u&&(_=1-_,g=1-g,v=1-v);var b=_*o.r+g*o.g+v*o.b;y>=l?h.y=i.minHeight+(i.maxHeight-i.minHeight)*b:h.y=i.minHeight-Me,t.push(h.x,h.y,h.z),r.push(0,0,0),n.push(s/i.subdivisions,1-a/i.subdivisions)}for(a=0;a<i.subdivisions;a++)for(s=0;s<i.subdivisions;s++){var E=s+1+(a+1)*(i.subdivisions+1),A=s+1+a*(i.subdivisions+1),S=s+a*(i.subdivisions+1),T=s+(a+1)*(i.subdivisions+1),M=t[E*3+1]>=i.minHeight,D=t[A*3+1]>=i.minHeight,x=t[S*3+1]>=i.minHeight;M&&D&&x&&(e.push(E),e.push(A),e.push(S));var P=t[T*3+1]>=i.minHeight;P&&M&&x&&(e.push(T),e.push(E),e.push(S))}J.ComputeNormals(t,e,r);var w=new J;return w.indices=e,w.positions=t,w.normals=r,w.uvs=n,w}function As(i,e,t){e===void 0&&(e={});var r=new cn(i,t);r._setReady(!1),r._subdivisionsX=e.subdivisionsX||e.subdivisions||1,r._subdivisionsY=e.subdivisionsY||e.subdivisions||1,r._width=e.width||1,r._height=e.height||1,r._maxX=r._width/2,r._maxZ=r._height/2,r._minX=-r._maxX,r._minZ=-r._maxZ;var n=bs(e);return n.applyToMesh(r,e.updatable),r._setReady(!0),r}function Ss(i,e,t){t===void 0&&(t=null);var r=new O(i,t),n=Ts(e);return n.applyToMesh(r,e.updatable),r}function Rs(i,e,t,r){t===void 0&&(t={}),r===void 0&&(r=null);var n=t.width||10,a=t.height||10,s=t.subdivisions||1,o=t.minHeight||0,l=t.maxHeight||1,u=t.colorFilter||new me(.3,.59,.11),f=t.alphaFilter||0,h=t.updatable,c=t.onReady;r=r||ye.LastCreatedScene;var d=new cn(i,r);d._subdivisionsX=s,d._subdivisionsY=s,d._width=n,d._height=a,d._maxX=d._width/2,d._maxZ=d._height/2,d._minX=-d._maxX,d._minZ=-d._maxZ,d._setReady(!1);var p=function(_){var g=_.width,v=_.height;if(!r.isDisposed){var y=r==null?void 0:r.getEngine().resizeImageBitmap(_,g,v),b=Es({width:n,height:a,subdivisions:s,minHeight:o,maxHeight:l,colorFilter:u,buffer:y,bufferWidth:g,bufferHeight:v,alphaFilter:f});b.applyToMesh(d,h),c&&c(d),d._setReady(!0)}};return te.LoadImage(e,p,function(){},r.offlineProvider),d}J.CreateGround=bs;J.CreateTiledGround=Ts;J.CreateGroundFromHeightMap=Es;O.CreateGround=function(i,e,t,r,n,a){var s={width:e,height:t,subdivisions:r,updatable:a};return As(i,s,n)};O.CreateTiledGround=function(i,e,t,r,n,a,s,o,l){var u={xmin:e,zmin:t,xmax:r,zmax:n,subdivisions:a,precision:s,updatable:l};return Ss(i,u,o)};O.CreateGroundFromHeightMap=function(i,e,t,r,n,a,s,o,l,u,f){var h={width:t,height:r,subdivisions:n,minHeight:a,maxHeight:s,updatable:l,onReady:u,alphaFilter:f};return Rs(i,e,h,o)};function Ps(i,e,t){t===void 0&&(t=null);var r=e.path,n=e.instance,a=1;e.radius!==void 0?a=e.radius:n&&(a=n._creationDataStorage.radius);var s=e.tessellation||64,o=e.radiusFunction||null,l=e.cap||O.NO_CAP,u=e.invertUV||!1,f=e.updatable,h=O._GetDefaultSideOrientation(e.sideOrientation);e.arc=e.arc&&(e.arc<=0||e.arc>1)?1:e.arc||1;var c=function(b,E,A,S,T,M,D,x){for(var P=E.getTangents(),w=E.getNormals(),k=E.getDistances(),B=Math.PI*2,L=B/T*x,H=function(){return S},W=M||H,F,V,z,N,Q=U.Matrix[0],Z=D===O.NO_CAP||D===O.CAP_END?0:2,ee=0;ee<b.length;ee++){V=W(ee,k[ee]),F=Array(),z=w[ee];for(var ne=0;ne<T;ne++)G.RotationAxisToRef(P[ee],L*ne,Q),N=F[ne]?F[ne]:m.Zero(),m.TransformCoordinatesToRef(z,Q,N),N.scaleInPlace(V).addInPlace(b[ee]),F[ne]=N;A[Z]=F,Z++}var Te=function(j,oe){for(var be=Array(),Ee=0;Ee<j;Ee++)be.push(b[oe]);return be};switch(D){case O.NO_CAP:break;case O.CAP_START:A[0]=Te(T,0),A[1]=A[2].slice(0);break;case O.CAP_END:A[Z]=A[Z-1].slice(0),A[Z+1]=Te(T,b.length-1);break;case O.CAP_ALL:A[0]=Te(T,0),A[1]=A[2].slice(0),A[Z]=A[Z-1].slice(0),A[Z+1]=Te(T,b.length-1);break}return A},d,p;if(n){var _=n._creationDataStorage,g=e.arc||_.arc;return d=_.path3D.update(r),p=c(r,d,_.pathArray,a,_.tessellation,o,_.cap,g),n=hr("",{pathArray:p,instance:n}),_.path3D=d,_.pathArray=p,_.arc=g,_.radius=a,n}d=new cs(r);var v=new Array;l=l<0||l>3?0:l,p=c(r,d,v,a,s,o,l,e.arc);var y=hr(i,{pathArray:p,closePath:!0,closeArray:!1,updatable:f,sideOrientation:h,invertUV:u,frontUVs:e.frontUVs,backUVs:e.backUVs},t);return y._creationDataStorage.pathArray=p,y._creationDataStorage.path3D=d,y._creationDataStorage.tessellation=s,y._creationDataStorage.cap=l,y._creationDataStorage.arc=e.arc,y._creationDataStorage.radius=a,y}O.CreateTube=function(i,e,t,r,n,a,s,o,l,u){var f={path:e,radius:t,tessellation:r,radiusFunction:n,arc:1,cap:a,updatable:o,sideOrientation:l,instance:u};return Ps(i,f,s)};function Ms(i){var e=[];e[0]={vertex:[[0,0,1.732051],[1.632993,0,-.5773503],[-.8164966,1.414214,-.5773503],[-.8164966,-1.414214,-.5773503]],face:[[0,1,2],[0,2,3],[0,3,1],[1,3,2]]},e[1]={vertex:[[0,0,1.414214],[1.414214,0,0],[0,1.414214,0],[-1.414214,0,0],[0,-1.414214,0],[0,0,-1.414214]],face:[[0,1,2],[0,2,3],[0,3,4],[0,4,1],[1,4,5],[1,5,2],[2,5,3],[3,5,4]]},e[2]={vertex:[[0,0,1.070466],[.7136442,0,.7978784],[-.3568221,.618034,.7978784],[-.3568221,-.618034,.7978784],[.7978784,.618034,.3568221],[.7978784,-.618034,.3568221],[-.9341724,.381966,.3568221],[.1362939,1,.3568221],[.1362939,-1,.3568221],[-.9341724,-.381966,.3568221],[.9341724,.381966,-.3568221],[.9341724,-.381966,-.3568221],[-.7978784,.618034,-.3568221],[-.1362939,1,-.3568221],[-.1362939,-1,-.3568221],[-.7978784,-.618034,-.3568221],[.3568221,.618034,-.7978784],[.3568221,-.618034,-.7978784],[-.7136442,0,-.7978784],[0,0,-1.070466]],face:[[0,1,4,7,2],[0,2,6,9,3],[0,3,8,5,1],[1,5,11,10,4],[2,7,13,12,6],[3,9,15,14,8],[4,10,16,13,7],[5,8,14,17,11],[6,12,18,15,9],[10,11,17,19,16],[12,13,16,19,18],[14,15,18,19,17]]},e[3]={vertex:[[0,0,1.175571],[1.051462,0,.5257311],[.3249197,1,.5257311],[-.8506508,.618034,.5257311],[-.8506508,-.618034,.5257311],[.3249197,-1,.5257311],[.8506508,.618034,-.5257311],[.8506508,-.618034,-.5257311],[-.3249197,1,-.5257311],[-1.051462,0,-.5257311],[-.3249197,-1,-.5257311],[0,0,-1.175571]],face:[[0,1,2],[0,2,3],[0,3,4],[0,4,5],[0,5,1],[1,5,7],[1,7,6],[1,6,2],[2,6,8],[2,8,3],[3,8,9],[3,9,4],[4,9,10],[4,10,5],[5,10,7],[6,7,11],[6,11,8],[7,10,11],[8,11,9],[9,11,10]]},e[4]={vertex:[[0,0,1.070722],[.7148135,0,.7971752],[-.104682,.7071068,.7971752],[-.6841528,.2071068,.7971752],[-.104682,-.7071068,.7971752],[.6101315,.7071068,.5236279],[1.04156,.2071068,.1367736],[.6101315,-.7071068,.5236279],[-.3574067,1,.1367736],[-.7888348,-.5,.5236279],[-.9368776,.5,.1367736],[-.3574067,-1,.1367736],[.3574067,1,-.1367736],[.9368776,-.5,-.1367736],[.7888348,.5,-.5236279],[.3574067,-1,-.1367736],[-.6101315,.7071068,-.5236279],[-1.04156,-.2071068,-.1367736],[-.6101315,-.7071068,-.5236279],[.104682,.7071068,-.7971752],[.6841528,-.2071068,-.7971752],[.104682,-.7071068,-.7971752],[-.7148135,0,-.7971752],[0,0,-1.070722]],face:[[0,2,3],[1,6,5],[4,9,11],[7,15,13],[8,16,10],[12,14,19],[17,22,18],[20,21,23],[0,1,5,2],[0,3,9,4],[0,4,7,1],[1,7,13,6],[2,5,12,8],[2,8,10,3],[3,10,17,9],[4,11,15,7],[5,6,14,12],[6,13,20,14],[8,12,19,16],[9,17,18,11],[10,16,22,17],[11,18,21,15],[13,15,21,20],[14,20,23,19],[16,19,23,22],[18,22,23,21]]},e[5]={vertex:[[0,0,1.322876],[1.309307,0,.1889822],[-.9819805,.8660254,.1889822],[.1636634,-1.299038,.1889822],[.3273268,.8660254,-.9449112],[-.8183171,-.4330127,-.9449112]],face:[[0,3,1],[2,4,5],[0,1,4,2],[0,2,5,3],[1,3,5,4]]},e[6]={vertex:[[0,0,1.159953],[1.013464,0,.5642542],[-.3501431,.9510565,.5642542],[-.7715208,-.6571639,.5642542],[.6633206,.9510565,-.03144481],[.8682979,-.6571639,-.3996071],[-1.121664,.2938926,-.03144481],[-.2348831,-1.063314,-.3996071],[.5181548,.2938926,-.9953061],[-.5850262,-.112257,-.9953061]],face:[[0,1,4,2],[0,2,6,3],[1,5,8,4],[3,6,9,7],[5,7,9,8],[0,3,7,5,1],[2,4,8,9,6]]},e[7]={vertex:[[0,0,1.118034],[.8944272,0,.6708204],[-.2236068,.8660254,.6708204],[-.7826238,-.4330127,.6708204],[.6708204,.8660254,.2236068],[1.006231,-.4330127,-.2236068],[-1.006231,.4330127,.2236068],[-.6708204,-.8660254,-.2236068],[.7826238,.4330127,-.6708204],[.2236068,-.8660254,-.6708204],[-.8944272,0,-.6708204],[0,0,-1.118034]],face:[[0,1,4,2],[0,2,6,3],[1,5,8,4],[3,6,10,7],[5,9,11,8],[7,10,11,9],[0,3,7,9,5,1],[2,4,8,11,10,6]]},e[8]={vertex:[[-.729665,.670121,.319155],[-.655235,-.29213,-.754096],[-.093922,-.607123,.537818],[.702196,.595691,.485187],[.776626,-.36656,-.588064]],face:[[1,4,2],[0,1,2],[3,0,2],[4,3,2],[4,1,0,3]]},e[9]={vertex:[[-.868849,-.100041,.61257],[-.329458,.976099,.28078],[-.26629,-.013796,-.477654],[-.13392,-1.034115,.229829],[.738834,.707117,-.307018],[.859683,-.535264,-.338508]],face:[[3,0,2],[5,3,2],[4,5,2],[1,4,2],[0,1,2],[0,3,5,4,1]]},e[10]={vertex:[[-.610389,.243975,.531213],[-.187812,-.48795,-.664016],[-.187812,.9759,-.664016],[.187812,-.9759,.664016],[.798201,.243975,.132803]],face:[[1,3,0],[3,4,0],[3,1,4],[0,2,1],[0,4,2],[2,4,1]]},e[11]={vertex:[[-1.028778,.392027,-.048786],[-.640503,-.646161,.621837],[-.125162,-.395663,-.540059],[.004683,.888447,-.651988],[.125161,.395663,.540059],[.632925,-.791376,.433102],[1.031672,.157063,-.354165]],face:[[3,2,0],[2,1,0],[2,5,1],[0,4,3],[0,1,4],[4,1,5],[2,3,6],[3,4,6],[5,2,6],[4,5,6]]},e[12]={vertex:[[-.669867,.334933,-.529576],[-.669867,.334933,.529577],[-.4043,1.212901,0],[-.334933,-.669867,-.529576],[-.334933,-.669867,.529577],[.334933,.669867,-.529576],[.334933,.669867,.529577],[.4043,-1.212901,0],[.669867,-.334933,-.529576],[.669867,-.334933,.529577]],face:[[8,9,7],[6,5,2],[3,8,7],[5,0,2],[4,3,7],[0,1,2],[9,4,7],[1,6,2],[9,8,5,6],[8,3,0,5],[3,4,1,0],[4,9,6,1]]},e[13]={vertex:[[-.931836,.219976,-.264632],[-.636706,.318353,.692816],[-.613483,-.735083,-.264632],[-.326545,.979634,0],[-.318353,-.636706,.692816],[-.159176,.477529,-.856368],[.159176,-.477529,-.856368],[.318353,.636706,.692816],[.326545,-.979634,0],[.613482,.735082,-.264632],[.636706,-.318353,.692816],[.931835,-.219977,-.264632]],face:[[11,10,8],[7,9,3],[6,11,8],[9,5,3],[2,6,8],[5,0,3],[4,2,8],[0,1,3],[10,4,8],[1,7,3],[10,11,9,7],[11,6,5,9],[6,2,0,5],[2,4,1,0],[4,10,7,1]]},e[14]={vertex:[[-.93465,.300459,-.271185],[-.838689,-.260219,-.516017],[-.711319,.717591,.128359],[-.710334,-.156922,.080946],[-.599799,.556003,-.725148],[-.503838,-.004675,-.969981],[-.487004,.26021,.48049],[-.460089,-.750282,-.512622],[-.376468,.973135,-.325605],[-.331735,-.646985,.084342],[-.254001,.831847,.530001],[-.125239,-.494738,-.966586],[.029622,.027949,.730817],[.056536,-.982543,-.262295],[.08085,1.087391,.076037],[.125583,-.532729,.485984],[.262625,.599586,.780328],[.391387,-.726999,-.716259],[.513854,-.868287,.139347],[.597475,.85513,.326364],[.641224,.109523,.783723],[.737185,-.451155,.538891],[.848705,-.612742,-.314616],[.976075,.365067,.32976],[1.072036,-.19561,.084927]],face:[[15,18,21],[12,20,16],[6,10,2],[3,0,1],[9,7,13],[2,8,4,0],[0,4,5,1],[1,5,11,7],[7,11,17,13],[13,17,22,18],[18,22,24,21],[21,24,23,20],[20,23,19,16],[16,19,14,10],[10,14,8,2],[15,9,13,18],[12,15,21,20],[6,12,16,10],[3,6,2,0],[9,3,1,7],[9,15,12,6,3],[22,17,11,5,4,8,14,19,23,24]]};var t=i.type&&(i.type<0||i.type>=e.length)?0:i.type||0,r=i.size,n=i.sizeX||r||1,a=i.sizeY||r||1,s=i.sizeZ||r||1,o=i.custom||e[t],l=o.face.length,u=i.faceUV||new Array(l),f=i.faceColors,h=i.flat===void 0?!0:i.flat,c=i.sideOrientation===0?0:i.sideOrientation||J.DEFAULTSIDE,d=new Array,p=new Array,_=new Array,g=new Array,v=new Array,y=0,b=0,E=new Array,A=0,S=0,T,M,D,x,P,w;if(h)for(S=0;S<l;S++)f&&f[S]===void 0&&(f[S]=new ce(1,1,1,1)),u&&u[S]===void 0&&(u[S]=new Ke(0,0,1,1));if(h)for(S=0;S<l;S++){var k=o.face[S].length;for(D=2*Math.PI/k,x=.5*Math.tan(D/2),P=.5,A=0;A<k;A++)d.push(o.vertex[o.face[S][A]][0]*n,o.vertex[o.face[S][A]][1]*a,o.vertex[o.face[S][A]][2]*s),E.push(y),y++,T=u[S].x+(u[S].z-u[S].x)*(.5+x),M=u[S].y+(u[S].w-u[S].y)*(P-.5),g.push(T,Se.UseOpenGLOrientationForUV?1-M:M),w=x*Math.cos(D)-P*Math.sin(D),P=x*Math.sin(D)+P*Math.cos(D),x=w,f&&v.push(f[S].r,f[S].g,f[S].b,f[S].a);for(A=0;A<k-2;A++)p.push(E[0+b],E[A+2+b],E[A+1+b]);b+=k}else{for(A=0;A<o.vertex.length;A++)d.push(o.vertex[A][0]*n,o.vertex[A][1]*a,o.vertex[A][2]*s),g.push(0,Se.UseOpenGLOrientationForUV?1:0);for(S=0;S<l;S++)for(A=0;A<o.face[S].length-2;A++)p.push(o.face[S][0],o.face[S][A+2],o.face[S][A+1])}J.ComputeNormals(d,p,_),J._ComputeSides(c,d,p,_,g,i.frontUVs,i.backUVs);var B=new J;return B.positions=d,B.indices=p,B.normals=_,B.uvs=g,f&&h&&(B.colors=v),B}function dn(i,e,t){e===void 0&&(e={}),t===void 0&&(t=null);var r=new O(i,t);e.sideOrientation=O._GetDefaultSideOrientation(e.sideOrientation),r._originalBuilderSideOrientation=e.sideOrientation;var n=Ms(e);return n.applyToMesh(r,e.updatable),r}J.CreatePolyhedron=Ms;O.CreatePolyhedron=function(i,e,t){return dn(i,e,t)};function Cs(i){var e=i.sideOrientation||J.DEFAULTSIDE,t=i.radius||1,r=i.flat===void 0?!0:i.flat,n=i.subdivisions||4,a=i.radiusX||t,s=i.radiusY||t,o=i.radiusZ||t,l=(1+Math.sqrt(5))/2,u=[-1,l,-0,1,l,0,-1,-l,0,1,-l,0,0,-1,-l,0,1,-l,0,-1,l,0,1,l,l,0,1,l,0,-1,-l,0,1,-l,0,-1],f=[0,11,5,0,5,1,0,1,7,0,7,10,12,22,23,1,5,20,5,11,4,23,22,13,22,18,6,7,1,8,14,21,4,14,4,2,16,13,6,15,6,19,3,8,9,4,21,5,13,17,23,6,13,22,19,6,18,9,8,1],h=[0,1,2,3,4,5,6,7,8,9,10,11,0,2,3,3,3,4,7,8,9,9,10,11],c=[5,1,3,1,6,4,0,0,5,3,4,2,2,2,4,0,2,0,1,1,6,0,6,2,0,4,3,3,4,4,3,1,4,2,4,4,0,2,1,1,2,2,3,3,1,3,2,4],d=138/1024,p=239/1024,_=60/1024,g=26/1024,v=-40/1024,y=20/1024,b=[0,0,0,0,1,0,0,1,1,0,0,0,1,1,0,0,1,1,1,0],E=new Array,A=new Array,S=new Array,T=new Array,M=0,D=new Array(3),x=new Array(3),P;for(P=0;P<3;P++)D[P]=m.Zero(),x[P]=se.Zero();for(var w=0;w<20;w++){for(P=0;P<3;P++){var k=f[3*w+P];D[P].copyFromFloats(u[3*h[k]],u[3*h[k]+1],u[3*h[k]+2]),D[P].normalize().scaleInPlace(t),x[P].copyFromFloats(c[2*k]*d+_+b[w]*v,c[2*k+1]*p+g+b[w]*y)}for(var B=function(F,V,z,N){var Q=m.Lerp(D[0],D[2],V/n),Z=m.Lerp(D[1],D[2],V/n),ee=n===V?D[2]:m.Lerp(Q,Z,F/(n-V));ee.normalize();var ne;if(r){var Te=m.Lerp(D[0],D[2],N/n),j=m.Lerp(D[1],D[2],N/n);ne=m.Lerp(Te,j,z/(n-N))}else ne=new m(ee.x,ee.y,ee.z);ne.x/=a,ne.y/=s,ne.z/=o,ne.normalize();var oe=se.Lerp(x[0],x[2],V/n),be=se.Lerp(x[1],x[2],V/n),Ee=n===V?x[2]:se.Lerp(oe,be,F/(n-V));A.push(ee.x*a,ee.y*s,ee.z*o),S.push(ne.x,ne.y,ne.z),T.push(Ee.x,Se.UseOpenGLOrientationForUV?1-Ee.y:Ee.y),E.push(M),M++},L=0;L<n;L++)for(var H=0;H+L<n;H++)B(H,L,H+1/3,L+1/3),B(H+1,L,H+1/3,L+1/3),B(H,L+1,H+1/3,L+1/3),H+L+1<n&&(B(H+1,L,H+2/3,L+2/3),B(H+1,L+1,H+2/3,L+2/3),B(H,L+1,H+2/3,L+2/3))}J._ComputeSides(e,A,E,S,T,i.frontUVs,i.backUVs);var W=new J;return W.indices=E,W.positions=A,W.normals=S,W.uvs=T,W}function xs(i,e,t){e===void 0&&(e={}),t===void 0&&(t=null);var r=new O(i,t);e.sideOrientation=O._GetDefaultSideOrientation(e.sideOrientation),r._originalBuilderSideOrientation=e.sideOrientation;var n=Cs(e);return n.applyToMesh(r,e.updatable),r}J.CreateIcoSphere=Cs;O.CreateIcoSphere=function(i,e,t){return xs(i,e,t)};var qn=function(){function i(e,t,r){e===void 0&&(e=m.Zero()),t===void 0&&(t=m.Up()),r===void 0&&(r=se.Zero()),this.position=e,this.normal=t,this.uv=r}return i.prototype.clone=function(){return new i(this.position.clone(),this.normal.clone(),this.uv.clone())},i}();function Ds(i,e,t){var r=e.getIndices(),n=e.getVerticesData(R.PositionKind),a=e.getVerticesData(R.NormalKind),s=e.getVerticesData(R.UVKind),o=t.position||m.Zero(),l=t.normal||m.Up(),u=t.size||m.One(),f=t.angle||0;if(!l){var h=new m(0,0,1),c=e.getScene().activeCamera,d=m.TransformCoordinates(h,c.getWorldMatrix());l=c.globalPosition.subtract(d)}var p=-Math.atan2(l.z,l.x)-Math.PI/2,_=Math.sqrt(l.x*l.x+l.z*l.z),g=Math.atan2(l.y,_),v=G.RotationYawPitchRoll(p,g,f).multiply(G.Translation(o.x,o.y,o.z)),y=G.Invert(v),b=e.getWorldMatrix(),E=b.multiply(y),A=new J;A.indices=[],A.positions=[],A.normals=[],A.uvs=[];for(var S=0,T=function(L){var H=new qn;if(!r||!n||!a)return H;var W=r[L];if(H.position=new m(n[W*3],n[W*3+1],n[W*3+2]),H.position=m.TransformCoordinates(H.position,E),H.normal=new m(a[W*3],a[W*3+1],a[W*3+2]),H.normal=m.TransformNormal(H.normal,E),t.captureUVS&&s){var F=s[W*2+1];H.uv=new se(s[W*2],Se.UseOpenGLOrientationForUV?1-F:F)}return H},M=function(L,H){if(L.length===0)return L;for(var W=.5*Math.abs(m.Dot(u,H)),F=function(Fe,Ae){var xe=m.GetClipFactor(Fe.position,Ae.position,H,W);return new qn(m.Lerp(Fe.position,Ae.position,xe),m.Lerp(Fe.normal,Ae.normal,xe))},V=new Array,z=0;z<L.length;z+=3){var N=0,Q=null,Z=null,ee=null,ne=null,Te=m.Dot(L[z].position,H)-W,j=m.Dot(L[z+1].position,H)-W,oe=m.Dot(L[z+2].position,H)-W,be=Te>0,Ee=j>0,Pe=oe>0;switch(N=(be?1:0)+(Ee?1:0)+(Pe?1:0),N){case 0:V.push(L[z]),V.push(L[z+1]),V.push(L[z+2]);break;case 1:if(be&&(Q=L[z+1],Z=L[z+2],ee=F(L[z],Q),ne=F(L[z],Z)),Ee){Q=L[z],Z=L[z+2],ee=F(L[z+1],Q),ne=F(L[z+1],Z),V.push(ee),V.push(Z.clone()),V.push(Q.clone()),V.push(Z.clone()),V.push(ee.clone()),V.push(ne);break}Pe&&(Q=L[z],Z=L[z+1],ee=F(L[z+2],Q),ne=F(L[z+2],Z)),Q&&Z&&ee&&ne&&(V.push(Q.clone()),V.push(Z.clone()),V.push(ee),V.push(ne),V.push(ee.clone()),V.push(Z.clone()));break;case 2:be||(Q=L[z].clone(),Z=F(Q,L[z+1]),ee=F(Q,L[z+2]),V.push(Q),V.push(Z),V.push(ee)),Ee||(Q=L[z+1].clone(),Z=F(Q,L[z+2]),ee=F(Q,L[z]),V.push(Q),V.push(Z),V.push(ee)),Pe||(Q=L[z+2].clone(),Z=F(Q,L[z]),ee=F(Q,L[z+1]),V.push(Q),V.push(Z),V.push(ee));break}}return V},D=0;D<r.length;D+=3){var x=new Array;if(x.push(T(D)),x.push(T(D+1)),x.push(T(D+2)),x=M(x,new m(1,0,0)),x=M(x,new m(-1,0,0)),x=M(x,new m(0,1,0)),x=M(x,new m(0,-1,0)),x=M(x,new m(0,0,1)),x=M(x,new m(0,0,-1)),x.length!==0)for(var P=0;P<x.length;P++){var w=x[P];if(A.indices.push(S),w.position.toArray(A.positions,S*3),w.normal.toArray(A.normals,S*3),t.captureUVS)w.uv.toArray(A.uvs,S*2);else{A.uvs.push(.5+w.position.x/u.x);var k=.5+w.position.y/u.y;A.uvs.push(Se.UseOpenGLOrientationForUV?1-k:k)}S++}}var B=new O(i,e.getScene());return A.applyToMesh(B),B.position=o.clone(),B.rotation=new m(g,p,f),B}O.CreateDecal=function(i,e,t,r,n,a){var s={position:t,normal:r,size:n,angle:a};return Ds(i,e,s)};function Os(i){i===void 0&&(i={subdivisions:2,tessellation:16,height:1,radius:.25,capSubdivisions:6});var e=Math.max(i.subdivisions?i.subdivisions:2,1),t=Math.max(i.tessellation?i.tessellation:16,3),r=Math.max(i.height?i.height:1,0),n=Math.max(i.radius?i.radius:.25,0),a=Math.max(i.capSubdivisions?i.capSubdivisions:6,1),s=t,o=e,l=Math.max(i.radiusTop?i.radiusTop:n,0),u=Math.max(i.radiusBottom?i.radiusBottom:n,0),f=r-(l+u),h=0,c=2*Math.PI,d=Math.max(i.topCapSubdivisions?i.topCapSubdivisions:a,1),p=Math.max(i.bottomCapSubdivisions?i.bottomCapSubdivisions:a,1),_=Math.acos((u-l)/r),g=[],v=[],y=[],b=[],E=0,A=[],S=f*.5,T=Math.PI*.5,M,D,x=m.Zero(),P=m.Zero(),w=Math.cos(_),k=Math.sin(_),B=new se(l*k,S+l*w).subtract(new se(u*k,-S+u*w)).length(),L=l*_+B+u*(T-_),H=0;for(D=0;D<=d;D++){var W=[],F=T-_*(D/d);H+=l*_/d;var V=Math.cos(F),z=Math.sin(F),N=V*l;for(M=0;M<=s;M++){var Q=M/s,Z=Q*c+h,ee=Math.sin(Z),ne=Math.cos(Z);P.x=N*ee,P.y=S+z*l,P.z=N*ne,v.push(P.x,P.y,P.z),x.set(V*ee,z,V*ne),y.push(x.x,x.y,x.z),b.push(Q,Se.UseOpenGLOrientationForUV?H/L:1-H/L),W.push(E),E++}A.push(W)}var Te=r-l-u+w*l-w*u,j=k*(u-l)/Te;for(D=1;D<=o;D++){var W=[];H+=B/o;var N=k*(D*(u-l)/o+l);for(M=0;M<=s;M++){var Q=M/s,Z=Q*c+h,ee=Math.sin(Z),ne=Math.cos(Z);P.x=N*ee,P.y=S+w*l-D*Te/o,P.z=N*ne,v.push(P.x,P.y,P.z),x.set(ee,j,ne).normalize(),y.push(x.x,x.y,x.z),b.push(Q,Se.UseOpenGLOrientationForUV?H/L:1-H/L),W.push(E),E++}A.push(W)}for(D=1;D<=p;D++){var W=[],F=T-_-(Math.PI-_)*(D/p);H+=u*_/p;var V=Math.cos(F),z=Math.sin(F),N=V*u;for(M=0;M<=s;M++){var Q=M/s,Z=Q*c+h,ee=Math.sin(Z),ne=Math.cos(Z);P.x=N*ee,P.y=-S+z*u,P.z=N*ne,v.push(P.x,P.y,P.z),x.set(V*ee,z,V*ne),y.push(x.x,x.y,x.z),b.push(Q,Se.UseOpenGLOrientationForUV?H/L:1-H/L),W.push(E),E++}A.push(W)}for(M=0;M<s;M++)for(D=0;D<d+o+p;D++){var oe=A[D][M],be=A[D+1][M],Ee=A[D+1][M+1],Pe=A[D][M+1];g.push(oe),g.push(be),g.push(Pe),g.push(be),g.push(Ee),g.push(Pe)}if(g=g.reverse(),i.orientation&&!i.orientation.equals(m.Up())){var Fe=new G;i.orientation.clone().scale(Math.PI*.5).cross(m.Up()).toQuaternion().toRotationMatrix(Fe);for(var Ae=m.Zero(),xe=0;xe<v.length;xe+=3)Ae.set(v[xe],v[xe+1],v[xe+2]),m.TransformCoordinatesToRef(Ae.clone(),Fe,Ae),v[xe]=Ae.x,v[xe+1]=Ae.y,v[xe+2]=Ae.z}var _e=new J;return _e.positions=v,_e.normals=y,_e.uvs=b,_e.indices=g,_e}function Is(i,e,t){e===void 0&&(e={orientation:m.Up(),subdivisions:2,tessellation:16,height:1,radius:.25,capSubdivisions:6,updatable:!1}),t===void 0&&(t=null);var r=new O(i,t),n=Os(e);return n.applyToMesh(r,e.updatable),r}O.CreateCapsule=function(i,e,t){return Is(i,e,t)};J.CreateCapsule=Os;var Be=function(){function i(e,t){e===void 0&&(e=0),t===void 0&&(t=0),this.x=e,this.y=t,e!==Math.floor(e)&&Y.Warn("x is not an integer, floor(x) used"),t!==Math.floor(t)&&Y.Warn("y is not an integer, floor(y) used")}return i.prototype.clone=function(){return new i(this.x,this.y)},i.prototype.rotate60About=function(e){var t=this.x;return this.x=e.x+e.y-this.y,this.y=t+this.y-e.x,this},i.prototype.rotateNeg60About=function(e){var t=this.x;return this.x=t+this.y-e.y,this.y=e.x+e.y-t,this},i.prototype.rotate120=function(e,t){e!==Math.floor(e)&&Y.Warn("m not an integer only floor(m) used"),t!==Math.floor(t)&&Y.Warn("n not an integer only floor(n) used");var r=this.x;return this.x=e-r-this.y,this.y=t+r,this},i.prototype.rotateNeg120=function(e,t){e!==Math.floor(e)&&Y.Warn("m is not an integer, floor(m) used"),t!==Math.floor(t)&&Y.Warn("n is not an integer,   floor(n) used");var r=this.x;return this.x=this.y-t,this.y=e+t-r-this.y,this},i.prototype.toCartesianOrigin=function(e,t){var r=m.Zero();return r.x=e.x+2*this.x*t+this.y*t,r.y=e.y+Math.sqrt(3)*this.y*t,r},i.Zero=function(){return new i(0,0)},i}(),Fs=function(){function i(){this.cartesian=[],this.vertices=[],this.max=[],this.min=[],this.closestTo=[],this.innerFacets=[],this.isoVecsABOB=[],this.isoVecsOBOA=[],this.isoVecsBAOA=[],this.vertexTypes=[],this.IDATA=new Gi("icosahedron","Regular",[[0,ke,-1],[-ke,1,0],[-1,0,-ke],[1,0,-ke],[ke,1,0],[0,ke,1],[-1,0,ke],[-ke,-1,0],[0,-ke,-1],[ke,-1,0],[1,0,ke],[0,-ke,1]],[[0,2,1],[0,3,2],[0,4,3],[0,5,4],[0,1,5],[7,6,1],[8,7,2],[9,8,3],[10,9,4],[6,10,5],[2,7,1],[3,8,2],[4,9,3],[5,10,4],[1,6,5],[11,6,7],[11,7,8],[11,8,9],[11,9,10],[11,10,6]])}return i.prototype.setIndices=function(){var e=12,t={},r=this.m,n=this.n,a=r,s=1,o=0;n!==0&&(a=K.HCF(r,n)),s=r/a,o=n/a;var l,u,f,h,c,d=Be.Zero(),p=new Be(r,n),_=new Be(-n,r+n),g=Be.Zero(),v=Be.Zero(),y=Be.Zero(),b=[],E,A,S,T,M=[],D=this.vertByDist,x=function(k,B,L,H){E=k+"|"+L,A=B+"|"+H,E in t||A in t?E in t&&!(A in t)?t[A]=t[E]:A in t&&!(E in t)&&(t[E]=t[A]):(t[E]=e,t[A]=e,e++),D[L][0]>2?M[t[E]]=[-D[L][0],D[L][1],t[E]]:M[t[E]]=[b[D[L][0]],D[L][1],t[E]]};this.IDATA.edgematch=[[1,"B"],[2,"B"],[3,"B"],[4,"B"],[0,"B"],[10,"O",14,"A"],[11,"O",10,"A"],[12,"O",11,"A"],[13,"O",12,"A"],[14,"O",13,"A"],[0,"O"],[1,"O"],[2,"O"],[3,"O"],[4,"O"],[19,"B",5,"A"],[15,"B",6,"A"],[16,"B",7,"A"],[17,"B",8,"A"],[18,"B",9,"A"]];for(var P=0;P<20;P++){if(b=this.IDATA.face[P],f=b[2],h=b[1],c=b[0],S=d.x+"|"+d.y,E=P+"|"+S,E in t||(t[E]=f,M[f]=[b[D[S][0]],D[S][1]]),S=p.x+"|"+p.y,E=P+"|"+S,E in t||(t[E]=h,M[h]=[b[D[S][0]],D[S][1]]),S=_.x+"|"+_.y,E=P+"|"+S,E in t||(t[E]=c,M[c]=[b[D[S][0]],D[S][1]]),l=this.IDATA.edgematch[P][0],u=this.IDATA.edgematch[P][1],u==="B")for(var w=1;w<a;w++)v.x=r-w*(s+o),v.y=n+w*s,y.x=-w*o,y.y=w*(s+o),S=v.x+"|"+v.y,T=y.x+"|"+y.y,x(P,l,S,T);if(u==="O")for(var w=1;w<a;w++)y.x=-w*o,y.y=w*(s+o),g.x=w*s,g.y=w*o,S=y.x+"|"+y.y,T=g.x+"|"+g.y,x(P,l,S,T);if(l=this.IDATA.edgematch[P][2],u=this.IDATA.edgematch[P][3],u&&u==="A")for(var w=1;w<a;w++)g.x=w*s,g.y=w*o,v.x=r-(a-w)*(s+o),v.y=n+(a-w)*s,S=g.x+"|"+g.y,T=v.x+"|"+v.y,x(P,l,S,T);for(var w=0;w<this.vertices.length;w++)S=this.vertices[w].x+"|"+this.vertices[w].y,E=P+"|"+S,E in t||(t[E]=e++,D[S][0]>2?M[t[E]]=[-D[S][0],D[S][1],t[E]]:M[t[E]]=[b[D[S][0]],D[S][1],t[E]])}this.closestTo=M,this.vecToidx=t},i.prototype.calcCoeffs=function(){var e=this.m,t=this.n,r=Math.sqrt(3)/3,n=e*e+t*t+e*t;this.coau=(e+t)/n,this.cobu=-t/n,this.coav=-r*(e-t)/n,this.cobv=r*(2*e+t)/n},i.prototype.createInnerFacets=function(){for(var e=this.m,t=this.n,r=0;r<t+e+1;r++)for(var n=this.min[r];n<this.max[r]+1;n++)n<this.max[r]&&n<this.max[r+1]+1&&this.innerFacets.push(["|"+n+"|"+r,"|"+n+"|"+(r+1),"|"+(n+1)+"|"+r]),r>0&&n<this.max[r-1]&&n+1<this.max[r]+1&&this.innerFacets.push(["|"+n+"|"+r,"|"+(n+1)+"|"+r,"|"+(n+1)+"|"+(r-1)])},i.prototype.edgeVecsABOB=function(){for(var e=this.m,t=this.n,r=new Be(-t,e+t),n=1;n<e+t;n++){var a=new Be(this.min[n],n),s=new Be(this.min[n-1],n-1),o=new Be(this.min[n+1],n+1),l=a.clone(),u=s.clone(),f=o.clone();l.rotate60About(r),u.rotate60About(r),f.rotate60About(r);var h=new Be(this.max[l.y],l.y),c=new Be(this.max[l.y-1],l.y-1),d=new Be(this.max[l.y-1]-1,l.y-1);(l.x!==h.x||l.y!==h.y)&&(l.x!==c.x?(this.vertexTypes.push([1,0,0]),this.isoVecsABOB.push([a,c,d]),this.vertexTypes.push([1,0,0]),this.isoVecsABOB.push([a,d,h])):l.y===f.y?(this.vertexTypes.push([1,1,0]),this.isoVecsABOB.push([a,s,c]),this.vertexTypes.push([1,0,1]),this.isoVecsABOB.push([a,c,o])):(this.vertexTypes.push([1,1,0]),this.isoVecsABOB.push([a,s,c]),this.vertexTypes.push([1,0,0]),this.isoVecsABOB.push([a,c,h])))}},i.prototype.mapABOBtoOBOA=function(){for(var e=new Be(0,0),t=0;t<this.isoVecsABOB.length;t++){for(var r=[],n=0;n<3;n++)e.x=this.isoVecsABOB[t][n].x,e.y=this.isoVecsABOB[t][n].y,this.vertexTypes[t][n]===0&&e.rotateNeg120(this.m,this.n),r.push(e.clone());this.isoVecsOBOA.push(r)}},i.prototype.mapABOBtoBAOA=function(){for(var e=new Be(0,0),t=0;t<this.isoVecsABOB.length;t++){for(var r=[],n=0;n<3;n++)e.x=this.isoVecsABOB[t][n].x,e.y=this.isoVecsABOB[t][n].y,this.vertexTypes[t][n]===1&&e.rotate120(this.m,this.n),r.push(e.clone());this.isoVecsBAOA.push(r)}},i.prototype.MapToFace=function(e,t){for(var r=this.IDATA.face[e],n=r[2],a=r[1],s=r[0],o=m.FromArray(this.IDATA.vertex[n]),l=m.FromArray(this.IDATA.vertex[a]),u=m.FromArray(this.IDATA.vertex[s]),f=l.subtract(o),h=u.subtract(o),c=f.scale(this.coau).add(h.scale(this.cobu)),d=f.scale(this.coav).add(h.scale(this.cobv)),p=[],_,g=U.Vector3[0],v=0;v<this.cartesian.length;v++)g=c.scale(this.cartesian[v].x).add(d.scale(this.cartesian[v].y)).add(o),p[v]=[g.x,g.y,g.z],_=e+"|"+this.vertices[v].x+"|"+this.vertices[v].y,t.vertex[this.vecToidx[_]]=[g.x,g.y,g.z]},i.prototype.build=function(e,t){var r=new Array,n=Be.Zero(),a=new Be(e,t),s=new Be(-t,e+t);r.push(n,a,s);for(var o=t;o<e+1;o++)for(var l=0;l<e+1-o;l++)r.push(new Be(l,o));if(t>0){for(var u=K.HCF(e,t),f=e/u,h=t/u,c=1;c<u;c++)r.push(new Be(c*f,c*h)),r.push(new Be(-c*h,c*(f+h))),r.push(new Be(e-c*(f+h),t+c*f));for(var d=e/t,p=1;p<t;p++)for(var _=0;_<p*d;_++)r.push(new Be(_,p)),r.push(new Be(_,p).rotate120(e,t)),r.push(new Be(_,p).rotateNeg120(e,t))}r.sort(function(L,H){return L.x-H.x}),r.sort(function(L,H){return L.y-H.y});for(var g=new Array(e+t+1),v=new Array(e+t+1),c=0;c<g.length;c++)g[c]=1/0,v[c]=-1/0;for(var y=0,b=0,E=r.length,c=0;c<E;c++)b=r[c].x,y=r[c].y,g[y]=Math.min(b,g[y]),v[y]=Math.max(b,v[y]);for(var A=function(L,H){var W=L.clone();return H==="A"&&W.rotateNeg120(e,t),H==="B"&&W.rotate120(e,t),W.x<0?W.y:W.x+W.y},S=[],T=[],M=[],D=[],x={},P=[],w=-1,k=-1,c=0;c<E;c++)S[c]=r[c].toCartesianOrigin(new Be(0,0),.5),T[c]=A(r[c],"O"),M[c]=A(r[c],"A"),D[c]=A(r[c],"B"),T[c]===M[c]&&M[c]===D[c]?(w=3,k=T[c]):T[c]===M[c]?(w=4,k=T[c]):M[c]===D[c]?(w=5,k=M[c]):D[c]===T[c]&&(w=6,k=T[c]),T[c]<M[c]&&T[c]<D[c]&&(w=2,k=T[c]),M[c]<T[c]&&M[c]<D[c]&&(w=1,k=M[c]),D[c]<M[c]&&D[c]<T[c]&&(w=0,k=D[c]),P.push([w,k,r[c].x,r[c].y]);P.sort(function(L,H){return L[2]-H[2]}),P.sort(function(L,H){return L[3]-H[3]}),P.sort(function(L,H){return L[1]-H[1]}),P.sort(function(L,H){return L[0]-H[0]});for(var B=0;B<P.length;B++)x[P[B][2]+"|"+P[B][3]]=[P[B][0],P[B][1],B];return this.m=e,this.n=t,this.vertices=r,this.vertByDist=x,this.cartesian=S,this.min=g,this.max=v,this},i}(),Gi=function(){function i(e,t,r,n){this.name=e,this.category=t,this.vertex=r,this.face=n}return i}(),ws=function(i){$(e,i);function e(){return i!==null&&i.apply(this,arguments)||this}return e.prototype.innerToData=function(t,r){for(var n=0;n<r.innerFacets.length;n++)this.face.push(r.innerFacets[n].map(function(a){return r.vecToidx[t+a]}))},e.prototype.mapABOBtoDATA=function(t,r){for(var n=r.IDATA.edgematch[t][0],a=0;a<r.isoVecsABOB.length;a++){for(var s=[],o=0;o<3;o++)r.vertexTypes[a][o]===0?s.push(t+"|"+r.isoVecsABOB[a][o].x+"|"+r.isoVecsABOB[a][o].y):s.push(n+"|"+r.isoVecsABOB[a][o].x+"|"+r.isoVecsABOB[a][o].y);this.face.push([r.vecToidx[s[0]],r.vecToidx[s[1]],r.vecToidx[s[2]]])}},e.prototype.mapOBOAtoDATA=function(t,r){for(var n=r.IDATA.edgematch[t][0],a=0;a<r.isoVecsOBOA.length;a++){for(var s=[],o=0;o<3;o++)r.vertexTypes[a][o]===1?s.push(t+"|"+r.isoVecsOBOA[a][o].x+"|"+r.isoVecsOBOA[a][o].y):s.push(n+"|"+r.isoVecsOBOA[a][o].x+"|"+r.isoVecsOBOA[a][o].y);this.face.push([r.vecToidx[s[0]],r.vecToidx[s[1]],r.vecToidx[s[2]]])}},e.prototype.mapBAOAtoDATA=function(t,r){for(var n=r.IDATA.edgematch[t][2],a=0;a<r.isoVecsBAOA.length;a++){for(var s=[],o=0;o<3;o++)r.vertexTypes[a][o]===1?s.push(t+"|"+r.isoVecsBAOA[a][o].x+"|"+r.isoVecsBAOA[a][o].y):s.push(n+"|"+r.isoVecsBAOA[a][o].x+"|"+r.isoVecsBAOA[a][o].y);this.face.push([r.vecToidx[s[0]],r.vecToidx[s[1]],r.vecToidx[s[2]]])}},e.prototype.orderData=function(t){for(var r=[],n=0;n<13;n++)r[n]=[];for(var a=t.closestTo,n=0;n<a.length;n++)a[n][0]>-1?a[n][1]>0&&r[a[n][0]].push([n,a[n][1]]):r[12].push([n,a[n][0]]);for(var s=[],n=0;n<12;n++)s[n]=n;for(var o=12,n=0;n<12;n++){r[n].sort(function(f,h){return f[1]-h[1]});for(var l=0;l<r[n].length;l++)s[r[n][l][0]]=o++}for(var l=0;l<r[12].length;l++)s[r[12][l][0]]=o++;for(var n=0;n<this.vertex.length;n++)this.vertex[n].push(s[n]);this.vertex.sort(function(u,f){return u[3]-f[3]});for(var n=0;n<this.vertex.length;n++)this.vertex[n].pop();for(var n=0;n<this.face.length;n++)for(var l=0;l<this.face[n].length;l++)this.face[n][l]=s[this.face[n][l]];this.sharedNodes=r[12].length,this.poleNodes=this.vertex.length-this.sharedNodes},e.prototype.setOrder=function(t,r){var n=[],a=[],s=r.pop();a.push(s);var o=this.face[s].indexOf(t);o=(o+2)%3;var l=this.face[s][o];n.push(l);for(var u=0;r.length>0;)s=r[u],this.face[s].indexOf(l)>-1?(o=(this.face[s].indexOf(l)+1)%3,l=this.face[s][o],n.push(l),a.push(s),r.splice(u,1),u=0):u++;return this.adjacentFaces.push(n),a},e.prototype.toGoldbergPolyhedronData=function(){var t=this,r=new Gi("GeoDual","Goldberg",[],[]);r.name="GD dual";for(var n=this.vertex.length,a=new Array(n),s=0;s<n;s++)a[s]=[];for(var o=0;o<this.face.length;o++)for(var l=0;l<3;l++)a[this.face[o][l]].push(o);var u=0,f=0,h=0,c=[],d=[];this.adjacentFaces=[];for(var p=0;p<a.length;p++)r.face[p]=this.setOrder(p,a[p].concat([])),a[p].forEach(function(_){u=0,f=0,h=0,c=t.face[_];for(var g=0;g<3;g++)d=t.vertex[c[g]],u+=d[0],f+=d[1],h+=d[2];r.vertex[_]=[u/3,f/3,h/3]});return r},e.BuildGeodesicData=function(t){var r=new e("Geodesic-m-n","Geodesic",[[0,ke,-1],[-ke,1,0],[-1,0,-ke],[1,0,-ke],[ke,1,0],[0,ke,1],[-1,0,ke],[-ke,-1,0],[0,-ke,-1],[ke,-1,0],[1,0,ke],[0,-ke,1]],[]);t.setIndices(),t.calcCoeffs(),t.createInnerFacets(),t.edgeVecsABOB(),t.mapABOBtoOBOA(),t.mapABOBtoBAOA();for(var n=0;n<t.IDATA.face.length;n++)t.MapToFace(n,r),r.innerToData(n,t),t.IDATA.edgematch[n][1]==="B"&&r.mapABOBtoDATA(n,t),t.IDATA.edgematch[n][1]==="O"&&r.mapOBOAtoDATA(n,t),t.IDATA.edgematch[n][3]==="A"&&r.mapBAOAtoDATA(n,t);r.orderData(t);var a=1;return r.vertex=r.vertex.map(function(s){var o=s[0],l=s[1],u=s[2],f=Math.sqrt(o*o+l*l+u*u);return s[0]*=a/f,s[1]*=a/f,s[2]*=a/f,s}),r},e}(Gi);function nu(i,e,t){t===void 0&&(t=null);var r=e.m||1;r!==Math.floor(r)&&Y.Warn("m not an integer only floor(m) used");var n=e.n||0;if(n!==Math.floor(n)&&Y.Warn("n not an integer only floor(n) used"),n>r){var a=n;n=r,r=a,Y.Warn("n > m therefore m and n swapped")}var s=new Fs;s.build(r,n);var o=ws.BuildGeodesicData(s),l={custom:o,size:e.size,sizeX:e.sizeX,sizeY:e.sizeY,sizeZ:e.sizeZ,faceUV:e.faceUV,faceColors:e.faceColors,flat:e.flat,updatable:e.updatable,sideOrientation:e.sideOrientation,frontUVs:e.frontUVs,backUVs:e.backUVs},u=dn(i,l,t);return u}O._GoldbergMeshParser=function(i,e){return Ls.Parse(i,e)};var Ls=function(i){$(e,i);function e(){var t=i!==null&&i.apply(this,arguments)||this;return t.goldbergData={faceColors:[],faceCenters:[],faceZaxis:[],faceXaxis:[],faceYaxis:[],nbSharedFaces:0,nbUnsharedFaces:0,nbFaces:0,nbFacesAtPole:0,adjacentFaces:[]},t}return e.prototype.relatedGoldbergFace=function(t,r){return r===void 0?(t>this.goldbergData.nbUnsharedFaces-1&&(Y.Warn("Maximum number of unshared faces used"),t=this.goldbergData.nbUnsharedFaces-1),this.goldbergData.nbUnsharedFaces+t):(t>11&&(Y.Warn("Last pole used"),t=11),r>this.goldbergData.nbFacesAtPole-1&&(Y.Warn("Maximum number of faces at a pole used"),r=this.goldbergData.nbFacesAtPole-1),12+t*this.goldbergData.nbFacesAtPole+r)},e.prototype._changeGoldbergFaceColors=function(t){for(var r=0;r<t.length;r++)for(var n=t[r][0],a=t[r][1],s=t[r][2],o=n;o<a+1;o++)this.goldbergData.faceColors[o]=s;for(var l=[],o=0;o<12;o++)for(var r=0;r<5;r++)l.push(this.goldbergData.faceColors[o].r,this.goldbergData.faceColors[o].g,this.goldbergData.faceColors[o].b,this.goldbergData.faceColors[o].a);for(var o=12;o<this.goldbergData.faceColors.length;o++)for(var r=0;r<6;r++)l.push(this.goldbergData.faceColors[o].r,this.goldbergData.faceColors[o].g,this.goldbergData.faceColors[o].b,this.goldbergData.faceColors[o].a);return l},e.prototype.setGoldbergFaceColors=function(t){var r=this._changeGoldbergFaceColors(t);this.setVerticesData(R.ColorKind,r)},e.prototype.updateGoldbergFaceColors=function(t){var r=this._changeGoldbergFaceColors(t);this.updateVerticesData(R.ColorKind,r)},e.prototype._changeGoldbergFaceUVs=function(t){for(var r=this.getVerticesData(R.UVKind),n=0;n<t.length;n++){for(var a=t[n][0],s=t[n][1],o=t[n][2],l=t[n][3],u=t[n][4],f=[],h=[],c=void 0,d=void 0,p=0;p<5;p++)c=o.x+l*Math.cos(u+p*Math.PI/2.5),d=o.y+l*Math.sin(u+p*Math.PI/2.5),c<0&&(c=0),c>1&&(c=1),f.push(c,d);for(var p=0;p<6;p++)c=o.x+l*Math.cos(u+p*Math.PI/3),d=o.y+l*Math.sin(u+p*Math.PI/3),c<0&&(c=0),c>1&&(c=1),h.push(c,d);for(var _=a;_<Math.min(12,s+1);_++)for(var p=0;p<5;p++)r[10*_+2*p]=f[2*p],r[10*_+2*p+1]=f[2*p+1];for(var _=Math.max(12,a);_<s+1;_++)for(var p=0;p<6;p++)r[12*_-24+2*p]=h[2*p],r[12*_-23+2*p]=h[2*p+1]}return r},e.prototype.setGoldbergFaceUVs=function(t){var r=this._changeGoldbergFaceUVs(t);this.setVerticesData(R.UVKind,r)},e.prototype.updateGoldbergFaceUVs=function(t){var r=this._changeGoldbergFaceUVs(t);this.updateVerticesData(R.UVKind,r)},e.prototype.placeOnGoldbergFaceAt=function(t,r,n){var a=m.RotationFromAxis(this.goldbergData.faceXaxis[r],this.goldbergData.faceYaxis[r],this.goldbergData.faceZaxis[r]);t.rotation=a,t.position=this.goldbergData.faceCenters[r].add(this.goldbergData.faceXaxis[r].scale(n.x)).add(this.goldbergData.faceYaxis[r].scale(n.y)).add(this.goldbergData.faceZaxis[r].scale(n.z))},e.prototype.serialize=function(t){i.prototype.serialize.call(this,t),t.type="GoldbergMesh";var r={};if(r.adjacentFaces=this.goldbergData.adjacentFaces,r.nbSharedFaces=this.goldbergData.nbSharedFaces,r.nbUnsharedFaces=this.goldbergData.nbUnsharedFaces,r.nbFaces=this.goldbergData.nbFaces,r.nbFacesAtPole=this.goldbergData.nbFacesAtPole,this.goldbergData.faceColors){r.faceColors=[];for(var n=0,a=this.goldbergData.faceColors;n<a.length;n++){var s=a[n];r.faceColors.push(s.asArray())}}if(this.goldbergData.faceCenters){r.faceCenters=[];for(var o=0,l=this.goldbergData.faceCenters;o<l.length;o++){var u=l[o];r.faceCenters.push(u.asArray())}}if(this.goldbergData.faceZaxis){r.faceZaxis=[];for(var f=0,h=this.goldbergData.faceZaxis;f<h.length;f++){var u=h[f];r.faceZaxis.push(u.asArray())}}if(this.goldbergData.faceYaxis){r.faceYaxis=[];for(var c=0,d=this.goldbergData.faceYaxis;c<d.length;c++){var u=d[c];r.faceYaxis.push(u.asArray())}}if(this.goldbergData.faceXaxis){r.faceXaxis=[];for(var p=0,_=this.goldbergData.faceXaxis;p<_.length;p++){var u=_[p];r.faceXaxis.push(u.asArray())}}t.goldbergData=r},e.Parse=function(t,r){var n=t.goldbergData;n.faceColors=n.faceColors.map(function(s){return ce.FromArray(s)}),n.faceCenters=n.faceCenters.map(function(s){return m.FromArray(s)}),n.faceZaxis=n.faceZaxis.map(function(s){return m.FromArray(s)}),n.faceXaxis=n.faceXaxis.map(function(s){return m.FromArray(s)}),n.faceYaxis=n.faceYaxis.map(function(s){return m.FromArray(s)});var a=new e(t.name,r);return a.goldbergData=n,a},e}(O);function au(i,e){for(var t=i.size,r=i.sizeX||t||1,n=i.sizeY||t||1,a=i.sizeZ||t||1,s=i.sideOrientation===0?0:i.sideOrientation||J.DEFAULTSIDE,o=new Array,l=new Array,u=new Array,f=new Array,h=1/0,c=-1/0,d=1/0,p=-1/0,_=0;_<e.vertex.length;_++)h=Math.min(h,e.vertex[_][0]*r),c=Math.max(c,e.vertex[_][0]*r),d=Math.min(d,e.vertex[_][1]*n),p=Math.max(p,e.vertex[_][1]*n);for(var g=0,v=0;v<e.face.length;v++){for(var y=e.face[v],b=m.FromArray(e.vertex[y[0]]),E=m.FromArray(e.vertex[y[2]]),A=m.FromArray(e.vertex[y[1]]),S=E.subtract(b),T=A.subtract(b),M=m.Cross(T,S).normalize(),_=0;_<y.length;_++){u.push(M.x,M.y,M.z);var D=e.vertex[y[_]];o.push(D[0]*r,D[1]*n,D[2]*a);var x=(D[1]*n-d)/(p-d);f.push((D[0]*r-h)/(c-h),Se.UseOpenGLOrientationForUV?1-x:x)}for(var _=0;_<y.length-2;_++)l.push(g,g+_+2,g+_+1);g+=y.length}J._ComputeSides(s,o,l,u,f);var P=new J;return P.positions=o,P.indices=l,P.normals=u,P.uvs=f,P}function Ns(i,e,t){t===void 0&&(t=null);var r=e.size,n=e.sizeX||r||1,a=e.sizeY||r||1,s=e.sizeZ||r||1,o=e.m||1;o!==Math.floor(o)&&Y.Warn("m not an integer only floor(m) used");var l=e.n||0;if(l!==Math.floor(l)&&Y.Warn("n not an integer only floor(n) used"),l>o){var u=l;l=o,o=u,Y.Warn("n > m therefore m and n swapped")}var f=new Fs;f.build(o,l);var h=ws.BuildGeodesicData(f),c=h.toGoldbergPolyhedronData(),d=new Ls(i,t);e.sideOrientation=O._GetDefaultSideOrientation(e.sideOrientation),d._originalBuilderSideOrientation=e.sideOrientation;var p=au(e,c);p.applyToMesh(d,e.updatable),d.goldbergData.nbSharedFaces=h.sharedNodes,d.goldbergData.nbUnsharedFaces=h.poleNodes,d.goldbergData.adjacentFaces=h.adjacentFaces,d.goldbergData.nbFaces=d.goldbergData.nbSharedFaces+d.goldbergData.nbUnsharedFaces,d.goldbergData.nbFacesAtPole=(d.goldbergData.nbUnsharedFaces-12)/12;for(var _=0;_<h.vertex.length;_++)d.goldbergData.faceCenters.push(m.FromArray(h.vertex[_])),d.goldbergData.faceCenters[_].x*=n,d.goldbergData.faceCenters[_].y*=a,d.goldbergData.faceCenters[_].z*=s,d.goldbergData.faceColors.push(new ce(1,1,1,1));for(var _=0;_<c.face.length;_++){var g=c.face[_],v=m.FromArray(c.vertex[g[0]]),y=m.FromArray(c.vertex[g[2]]),b=m.FromArray(c.vertex[g[1]]),E=y.subtract(v),A=b.subtract(v),S=m.Cross(A,E).normalize(),T=m.Cross(A,S).normalize();d.goldbergData.faceXaxis.push(A.normalize()),d.goldbergData.faceYaxis.push(S),d.goldbergData.faceZaxis.push(T)}return d}O.CreateGoldberg=Ns;var su={CreateBox:un,CreateTiledBox:Ml,CreateSphere:es,CreateDisc:Za,CreateIcoSphere:xs,CreateRibbon:hr,CreateCylinder:ri,CreateTorus:is,CreateTorusKnot:as,CreateLineSystem:us,CreateLines:fs,CreateDashedLines:hs,ExtrudeShape:_s,ExtrudeShapeCustom:vs,CreateLathe:ms,CreateTiledPlane:Pl,CreatePlane:li,CreateGround:As,CreateTiledGround:Ss,CreateGroundFromHeightMap:Rs,CreatePolygon:hn,ExtrudePolygon:ps,CreateTube:Ps,CreatePolyhedron:dn,CreateGeodesic:nu,CreateGoldberg:Ns,CreateDecal:Ds,CreateCapsule:Is};class ou extends ht{constructor(e,t,r,n="DepthKitMesh"){super(n,r);ft(this,"vertexMesh");this.props=e,this.meshScalar=t,this.scene=r,this.vertexMesh=this._createMesh(),this.vertexMesh.parent=this}setMeshScalar(e){throw new Error("Method not implemented.")}getVertexMesh(){return this.vertexMesh}_createMesh(){this.props.textureWidth/this.meshScalar+1,this.props.textureHeight/this.meshScalar+1;const e=su.CreatePlane(`${this.id}-depthkit-mesh`,{width:1,height:1,sideOrientation:O.DOUBLESIDE},this.scene);return e.increaseVertices(250),e}}class lu{constructor(e,t="depthkit"){ft(this,"props");ft(this,"video");ft(this,"dkShaderMat");ft(this,"dkMeshRoot");ft(this,"meshScalar",2);this.scene=e,this.id=t}async load(e,t){this.video=this._createVideo(t),this.props=await lo(e),this.dkShaderMat=new dl(this.props,this.video,this.meshScalar,this.scene),this.dkMeshRoot=new ou(this.props,this.meshScalar,this.scene);const r=this.dkMeshRoot.getVertexMesh();r.material=this.dkShaderMat,r.scaling=new m(1,1,1),r.rotate(m.Forward(),Math.PI/2),r.position.y=2,this.dkMeshRoot.position.z=(this.props.farClip-this.props.nearClip)/2-this.props.nearClip}setMeshScalar(e){const t=Math.pow(2,e);this.meshScalar!=t&&(this.meshScalar=t,this.dkShaderMat.setMeshScalar(this.meshScalar),this.dkMeshRoot.setMeshScalar(this.meshScalar))}dispose(){var e,t;(e=this.dkMeshRoot)==null||e.dispose(),(t=this.dkShaderMat)==null||t.dispose()}play(){var e;(e=this.video)==null||e.play().catch(t=>{console.error("Unable to play",t),alert("Unable to play: "+t)})}pause(){var e;(e=this.video)==null||e.pause()}_createVideo(e){const t=document.createElement("video");return t.id=`${this.id}-video`,t.src=e,t.crossOrigin="anonymous",t.removeAttribute("controls"),t.setAttribute("crossorigin","anonymous"),t.setAttribute("playsinline","playsinline"),t.muted=!0,t.autoplay=!1,t.loop=!0,t}}var uu=function(){function i(){this._zoomStopsAnimation=!1,this._idleRotationSpeed=.05,this._idleRotationWaitTime=2e3,this._idleRotationSpinupTime=2e3,this._isPointerDown=!1,this._lastFrameTime=null,this._lastInteractionTime=-1/0,this._cameraRotationSpeed=0,this._lastFrameRadius=0}return Object.defineProperty(i.prototype,"name",{get:function(){return"AutoRotation"},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"zoomStopsAnimation",{get:function(){return this._zoomStopsAnimation},set:function(e){this._zoomStopsAnimation=e},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"idleRotationSpeed",{get:function(){return this._idleRotationSpeed},set:function(e){this._idleRotationSpeed=e},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"idleRotationWaitTime",{get:function(){return this._idleRotationWaitTime},set:function(e){this._idleRotationWaitTime=e},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"idleRotationSpinupTime",{get:function(){return this._idleRotationSpinupTime},set:function(e){this._idleRotationSpinupTime=e},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"rotationInProgress",{get:function(){return Math.abs(this._cameraRotationSpeed)>0},enumerable:!1,configurable:!0}),i.prototype.init=function(){},i.prototype.attach=function(e){var t=this;this._attachedCamera=e;var r=this._attachedCamera.getScene();this._onPrePointerObservableObserver=r.onPrePointerObservable.add(function(n){if(n.type===fe.POINTERDOWN){t._isPointerDown=!0;return}n.type===fe.POINTERUP&&(t._isPointerDown=!1)}),this._onAfterCheckInputsObserver=e.onAfterCheckInputsObservable.add(function(){var n=nt.Now,a=0;t._lastFrameTime!=null&&(a=n-t._lastFrameTime),t._lastFrameTime=n,t._applyUserInteraction();var s=n-t._lastInteractionTime-t._idleRotationWaitTime,o=Math.max(Math.min(s/t._idleRotationSpinupTime,1),0);t._cameraRotationSpeed=t._idleRotationSpeed*o,t._attachedCamera&&(t._attachedCamera.alpha-=t._cameraRotationSpeed*(a/1e3))})},i.prototype.detach=function(){if(!!this._attachedCamera){var e=this._attachedCamera.getScene();this._onPrePointerObservableObserver&&e.onPrePointerObservable.remove(this._onPrePointerObservableObserver),this._attachedCamera.onAfterCheckInputsObservable.remove(this._onAfterCheckInputsObserver),this._attachedCamera=null}},i.prototype.resetLastInteractionTime=function(e){this._lastInteractionTime=e!=null?e:nt.Now},i.prototype._userIsZooming=function(){return this._attachedCamera?this._attachedCamera.inertialRadiusOffset!==0:!1},i.prototype._shouldAnimationStopForInteraction=function(){if(!this._attachedCamera)return!1;var e=!1;return this._lastFrameRadius===this._attachedCamera.radius&&this._attachedCamera.inertialRadiusOffset!==0&&(e=!0),this._lastFrameRadius=this._attachedCamera.radius,this._zoomStopsAnimation?e:this._userIsZooming()},i.prototype._applyUserInteraction=function(){this._userIsMoving()&&!this._shouldAnimationStopForInteraction()&&(this._lastInteractionTime=nt.Now)},i.prototype._userIsMoving=function(){return this._attachedCamera?this._attachedCamera.inertialAlphaOffset!==0||this._attachedCamera.inertialBetaOffset!==0||this._attachedCamera.inertialRadiusOffset!==0||this._attachedCamera.inertialPanningX!==0||this._attachedCamera.inertialPanningY!==0||this._isPointerDown:!1},i}(),ut=function(){function i(){this._easingMode=i.EASINGMODE_EASEIN}return i.prototype.setEasingMode=function(e){var t=Math.min(Math.max(e,0),2);this._easingMode=t},i.prototype.getEasingMode=function(){return this._easingMode},i.prototype.easeInCore=function(e){throw new Error("You must implement this method")},i.prototype.ease=function(e){switch(this._easingMode){case i.EASINGMODE_EASEIN:return this.easeInCore(e);case i.EASINGMODE_EASEOUT:return 1-this.easeInCore(1-e)}return e>=.5?(1-this.easeInCore((1-e)*2))*.5+.5:this.easeInCore(e*2)*.5},i.EASINGMODE_EASEIN=0,i.EASINGMODE_EASEOUT=1,i.EASINGMODE_EASEINOUT=2,i}();(function(i){$(e,i);function e(){return i!==null&&i.apply(this,arguments)||this}return e.prototype.easeInCore=function(t){return t=Math.max(0,Math.min(1,t)),1-Math.sqrt(1-t*t)},e})(ut);var fu=function(i){$(e,i);function e(t){t===void 0&&(t=1);var r=i.call(this)||this;return r.amplitude=t,r}return e.prototype.easeInCore=function(t){var r=Math.max(0,this.amplitude);return Math.pow(t,3)-t*r*Math.sin(3.141592653589793*t)},e}(ut);(function(i){$(e,i);function e(t,r){t===void 0&&(t=3),r===void 0&&(r=2);var n=i.call(this)||this;return n.bounces=t,n.bounciness=r,n}return e.prototype.easeInCore=function(t){var r=Math.max(0,this.bounces),n=this.bounciness;n<=1&&(n=1.001);var a=Math.pow(n,r),s=1-n,o=(1-a)/s+a*.5,l=t*o,u=Math.log(-l*(1-n)+1)/Math.log(n),f=Math.floor(u),h=f+1,c=(1-Math.pow(n,f))/(s*o),d=(1-Math.pow(n,h))/(s*o),p=(c+d)*.5,_=t-p,g=p-c;return-Math.pow(1/n,r-f)/(g*g)*(_-g)*(_+g)},e})(ut);(function(i){$(e,i);function e(){return i!==null&&i.apply(this,arguments)||this}return e.prototype.easeInCore=function(t){return t*t*t},e})(ut);(function(i){$(e,i);function e(t,r){t===void 0&&(t=3),r===void 0&&(r=3);var n=i.call(this)||this;return n.oscillations=t,n.springiness=r,n}return e.prototype.easeInCore=function(t){var r,n=Math.max(0,this.oscillations),a=Math.max(0,this.springiness);return a==0?r=t:r=(Math.exp(a*t)-1)/(Math.exp(a)-1),r*Math.sin((6.283185307179586*n+1.5707963267948966)*t)},e})(ut);var hu=function(i){$(e,i);function e(t){t===void 0&&(t=2);var r=i.call(this)||this;return r.exponent=t,r}return e.prototype.easeInCore=function(t){return this.exponent<=0?t:(Math.exp(this.exponent*t)-1)/(Math.exp(this.exponent)-1)},e}(ut);(function(i){$(e,i);function e(t){t===void 0&&(t=2);var r=i.call(this)||this;return r.power=t,r}return e.prototype.easeInCore=function(t){var r=Math.max(0,this.power);return Math.pow(t,r)},e})(ut);var Pp=function(i){$(e,i);function e(){return i!==null&&i.apply(this,arguments)||this}return e.prototype.easeInCore=function(t){return t*t},e}(ut);(function(i){$(e,i);function e(){return i!==null&&i.apply(this,arguments)||this}return e.prototype.easeInCore=function(t){return t*t*t*t},e})(ut);(function(i){$(e,i);function e(){return i!==null&&i.apply(this,arguments)||this}return e.prototype.easeInCore=function(t){return t*t*t*t*t},e})(ut);var Mp=function(i){$(e,i);function e(){return i!==null&&i.apply(this,arguments)||this}return e.prototype.easeInCore=function(t){return 1-Math.sin(1.5707963267948966*(1-t))},e}(ut);(function(i){$(e,i);function e(t,r,n,a){t===void 0&&(t=0),r===void 0&&(r=0),n===void 0&&(n=1),a===void 0&&(a=1);var s=i.call(this)||this;return s.x1=t,s.y1=r,s.x2=n,s.y2=a,s}return e.prototype.easeInCore=function(t){return Jl.Interpolate(t,this.x1,this.y1,this.x2,this.y2)},e})(ut);var zi;(function(i){i[i.NONE=0]="NONE",i[i.STEP=1]="STEP"})(zi||(zi={}));var ii=function(){function i(e,t,r){this.name=e,this.from=t,this.to=r}return i.prototype.clone=function(){return new i(this.name,this.from,this.to)},i}(),rt=function(){function i(e,t,r,n,a,s){this.name=e,this.targetProperty=t,this.framePerSecond=r,this.dataType=n,this.loopMode=a,this.enableBlending=s,this._easingFunction=null,this._runtimeAnimations=new Array,this._events=new Array,this.blendingSpeed=.01,this._ranges={},this.targetPropertyPath=t.split("."),this.dataType=n,this.loopMode=a===void 0?i.ANIMATIONLOOPMODE_CYCLE:a,this.uniqueId=i._UniqueIdGenerator++}return i._PrepareAnimation=function(e,t,r,n,a,s,o,l){var u=void 0;if(!isNaN(parseFloat(a))&&isFinite(a)?u=i.ANIMATIONTYPE_FLOAT:a instanceof de?u=i.ANIMATIONTYPE_QUATERNION:a instanceof m?u=i.ANIMATIONTYPE_VECTOR3:a instanceof se?u=i.ANIMATIONTYPE_VECTOR2:a instanceof me?u=i.ANIMATIONTYPE_COLOR3:a instanceof ce?u=i.ANIMATIONTYPE_COLOR4:a instanceof Zr&&(u=i.ANIMATIONTYPE_SIZE),u==null)return null;var f=new i(e,t,r,u,o),h=[{frame:0,value:a},{frame:n,value:s}];return f.setKeys(h),l!==void 0&&f.setEasingFunction(l),f},i.CreateAnimation=function(e,t,r,n){var a=new i(e+"Animation",e,r,t,i.ANIMATIONLOOPMODE_CONSTANT);return a.setEasingFunction(n),a},i.CreateAndStartAnimation=function(e,t,r,n,a,s,o,l,u,f,h){var c=i._PrepareAnimation(e,r,n,a,s,o,l,u);return!c||(t.getScene&&(h=t.getScene()),!h)?null:h.beginDirectAnimation(t,[c],0,a,c.loopMode===1,1,f)},i.CreateAndStartHierarchyAnimation=function(e,t,r,n,a,s,o,l,u,f,h){var c=i._PrepareAnimation(e,n,a,s,o,l,u,f);if(!c)return null;var d=t.getScene();return d.beginDirectHierarchyAnimation(t,r,[c],0,s,c.loopMode===1,1,h)},i.CreateMergeAndStartAnimation=function(e,t,r,n,a,s,o,l,u,f){var h=i._PrepareAnimation(e,r,n,a,s,o,l,u);return h?(t.animations.push(h),t.getScene().beginAnimation(t,0,a,h.loopMode===1,1,f)):null},i.MakeAnimationAdditive=function(e,t,r,n,a){t===void 0&&(t=0),n===void 0&&(n=!1);var s=e;if(n&&(s=e.clone(),s.name=a||s.name),!s._keys.length)return s;t=t>=0?t:0;var o=0,l=s._keys[0],u=s._keys.length-1,f=s._keys[u],h={referenceValue:l.value,referencePosition:U.Vector3[0],referenceQuaternion:U.Quaternion[0],referenceScaling:U.Vector3[1],keyPosition:U.Vector3[2],keyQuaternion:U.Quaternion[1],keyScaling:U.Vector3[3]},c=!1,d=l.frame,p=f.frame;if(r){var _=s.getRange(r);_&&(d=_.from,p=_.to)}var g=l.frame===d,v=f.frame===p;if(s._keys.length===1){var y=s._getKeyValue(s._keys[0]);h.referenceValue=y.clone?y.clone():y,c=!0}else if(t<=l.frame){var y=s._getKeyValue(l.value);h.referenceValue=y.clone?y.clone():y,c=!0}else if(t>=f.frame){var y=s._getKeyValue(f.value);h.referenceValue=y.clone?y.clone():y,c=!0}for(var b=0;!c||!g||!v&&b<s._keys.length-1;){var E=s._keys[b],A=s._keys[b+1];if(!c&&t>=E.frame&&t<=A.frame){var y=void 0;if(t===E.frame)y=s._getKeyValue(E.value);else if(t===A.frame)y=s._getKeyValue(A.value);else{var S={key:b,repeatCount:0,loopMode:this.ANIMATIONLOOPMODE_CONSTANT};y=s._interpolate(t,S)}h.referenceValue=y.clone?y.clone():y,c=!0}if(!g&&d>=E.frame&&d<=A.frame){if(d===E.frame)o=b;else if(d===A.frame)o=b+1;else{var S={key:b,repeatCount:0,loopMode:this.ANIMATIONLOOPMODE_CONSTANT},y=s._interpolate(d,S),T={frame:d,value:y.clone?y.clone():y};s._keys.splice(b+1,0,T),o=b+1}g=!0}if(!v&&p>=E.frame&&p<=A.frame){if(p===E.frame)u=b;else if(p===A.frame)u=b+1;else{var S={key:b,repeatCount:0,loopMode:this.ANIMATIONLOOPMODE_CONSTANT},y=s._interpolate(p,S),T={frame:p,value:y.clone?y.clone():y};s._keys.splice(b+1,0,T),u=b+1}v=!0}b++}for(s.dataType===i.ANIMATIONTYPE_QUATERNION?h.referenceValue.normalize().conjugateInPlace():s.dataType===i.ANIMATIONTYPE_MATRIX&&(h.referenceValue.decompose(h.referenceScaling,h.referenceQuaternion,h.referencePosition),h.referenceQuaternion.normalize().conjugateInPlace()),b=o;b<=u;b++){var T=s._keys[b];if(!(b&&s.dataType!==i.ANIMATIONTYPE_FLOAT&&T.value===l.value))switch(s.dataType){case i.ANIMATIONTYPE_MATRIX:T.value.decompose(h.keyScaling,h.keyQuaternion,h.keyPosition),h.keyPosition.subtractInPlace(h.referencePosition),h.keyScaling.divideInPlace(h.referenceScaling),h.referenceQuaternion.multiplyToRef(h.keyQuaternion,h.keyQuaternion),G.ComposeToRef(h.keyScaling,h.keyQuaternion,h.keyPosition,T.value);break;case i.ANIMATIONTYPE_QUATERNION:h.referenceValue.multiplyToRef(T.value,T.value);break;case i.ANIMATIONTYPE_VECTOR2:case i.ANIMATIONTYPE_VECTOR3:case i.ANIMATIONTYPE_COLOR3:case i.ANIMATIONTYPE_COLOR4:T.value.subtractToRef(h.referenceValue,T.value);break;case i.ANIMATIONTYPE_SIZE:T.value.width-=h.referenceValue.width,T.value.height-=h.referenceValue.height;break;default:T.value-=h.referenceValue}}return s},i.TransitionTo=function(e,t,r,n,a,s,o,l){if(l===void 0&&(l=null),o<=0)return r[e]=t,l&&l(),null;var u=a*(o/1e3);s.setKeys([{frame:0,value:r[e].clone?r[e].clone():r[e]},{frame:u,value:t}]),r.animations||(r.animations=[]),r.animations.push(s);var f=n.beginAnimation(r,0,u,!1);return f.onAnimationEnd=l,f},Object.defineProperty(i.prototype,"runtimeAnimations",{get:function(){return this._runtimeAnimations},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"hasRunningRuntimeAnimations",{get:function(){for(var e=0,t=this._runtimeAnimations;e<t.length;e++){var r=t[e];if(!r.isStopped())return!0}return!1},enumerable:!1,configurable:!0}),i.prototype.toString=function(e){var t="Name: "+this.name+", property: "+this.targetProperty;if(t+=", datatype: "+["Float","Vector3","Quaternion","Matrix","Color3","Vector2"][this.dataType],t+=", nKeys: "+(this._keys?this._keys.length:"none"),t+=", nRanges: "+(this._ranges?Object.keys(this._ranges).length:"none"),e){t+=", Ranges: {";var r=!0;for(var n in this._ranges)r&&(t+=", ",r=!1),t+=n;t+="}"}return t},i.prototype.addEvent=function(e){this._events.push(e),this._events.sort(function(t,r){return t.frame-r.frame})},i.prototype.removeEvents=function(e){for(var t=0;t<this._events.length;t++)this._events[t].frame===e&&(this._events.splice(t,1),t--)},i.prototype.getEvents=function(){return this._events},i.prototype.createRange=function(e,t,r){this._ranges[e]||(this._ranges[e]=new ii(e,t,r))},i.prototype.deleteRange=function(e,t){t===void 0&&(t=!0);var r=this._ranges[e];if(!!r){if(t)for(var n=r.from,a=r.to,s=this._keys.length-1;s>=0;s--)this._keys[s].frame>=n&&this._keys[s].frame<=a&&this._keys.splice(s,1);this._ranges[e]=null}},i.prototype.getRange=function(e){return this._ranges[e]},i.prototype.getKeys=function(){return this._keys},i.prototype.getHighestFrame=function(){for(var e=0,t=0,r=this._keys.length;t<r;t++)e<this._keys[t].frame&&(e=this._keys[t].frame);return e},i.prototype.getEasingFunction=function(){return this._easingFunction},i.prototype.setEasingFunction=function(e){this._easingFunction=e},i.prototype.floatInterpolateFunction=function(e,t,r){return K.Lerp(e,t,r)},i.prototype.floatInterpolateFunctionWithTangents=function(e,t,r,n,a){return K.Hermite(e,t,r,n,a)},i.prototype.quaternionInterpolateFunction=function(e,t,r){return de.Slerp(e,t,r)},i.prototype.quaternionInterpolateFunctionWithTangents=function(e,t,r,n,a){return de.Hermite(e,t,r,n,a).normalize()},i.prototype.vector3InterpolateFunction=function(e,t,r){return m.Lerp(e,t,r)},i.prototype.vector3InterpolateFunctionWithTangents=function(e,t,r,n,a){return m.Hermite(e,t,r,n,a)},i.prototype.vector2InterpolateFunction=function(e,t,r){return se.Lerp(e,t,r)},i.prototype.vector2InterpolateFunctionWithTangents=function(e,t,r,n,a){return se.Hermite(e,t,r,n,a)},i.prototype.sizeInterpolateFunction=function(e,t,r){return Zr.Lerp(e,t,r)},i.prototype.color3InterpolateFunction=function(e,t,r){return me.Lerp(e,t,r)},i.prototype.color3InterpolateFunctionWithTangents=function(e,t,r,n,a){return me.Hermite(e,t,r,n,a)},i.prototype.color4InterpolateFunction=function(e,t,r){return ce.Lerp(e,t,r)},i.prototype.color4InterpolateFunctionWithTangents=function(e,t,r,n,a){return ce.Hermite(e,t,r,n,a)},i.prototype._getKeyValue=function(e){return typeof e=="function"?e():e},i.prototype.evaluate=function(e){return this._interpolate(e,{key:0,repeatCount:0,loopMode:i.ANIMATIONLOOPMODE_CONSTANT})},i.prototype._interpolate=function(e,t){if(t.loopMode===i.ANIMATIONLOOPMODE_CONSTANT&&t.repeatCount>0)return t.highLimitValue.clone?t.highLimitValue.clone():t.highLimitValue;var r=this._keys;if(r.length===1)return this._getKeyValue(r[0].value);var n=t.key;if(r[n].frame>=e)for(;n-1>=0&&r[n].frame>=e;)n--;for(var a=n;a<r.length-1;a++){var s=r[a+1];if(s.frame>=e){t.key=a;var o=r[a],l=this._getKeyValue(o.value),u=this._getKeyValue(s.value);if(o.interpolation===zi.STEP)return s.frame>e?l:u;var f=o.outTangent!==void 0&&s.inTangent!==void 0,h=s.frame-o.frame,c=(e-o.frame)/h,d=this.getEasingFunction();switch(d!==null&&(c=d.ease(c)),this.dataType){case i.ANIMATIONTYPE_FLOAT:{var p=f?this.floatInterpolateFunctionWithTangents(l,o.outTangent*h,u,s.inTangent*h,c):this.floatInterpolateFunction(l,u,c);switch(t.loopMode){case i.ANIMATIONLOOPMODE_CYCLE:case i.ANIMATIONLOOPMODE_CONSTANT:return p;case i.ANIMATIONLOOPMODE_RELATIVE:return t.offsetValue*t.repeatCount+p}break}case i.ANIMATIONTYPE_QUATERNION:{var _=f?this.quaternionInterpolateFunctionWithTangents(l,o.outTangent.scale(h),u,s.inTangent.scale(h),c):this.quaternionInterpolateFunction(l,u,c);switch(t.loopMode){case i.ANIMATIONLOOPMODE_CYCLE:case i.ANIMATIONLOOPMODE_CONSTANT:return _;case i.ANIMATIONLOOPMODE_RELATIVE:return _.addInPlace(t.offsetValue.scale(t.repeatCount))}return _}case i.ANIMATIONTYPE_VECTOR3:{var g=f?this.vector3InterpolateFunctionWithTangents(l,o.outTangent.scale(h),u,s.inTangent.scale(h),c):this.vector3InterpolateFunction(l,u,c);switch(t.loopMode){case i.ANIMATIONLOOPMODE_CYCLE:case i.ANIMATIONLOOPMODE_CONSTANT:return g;case i.ANIMATIONLOOPMODE_RELATIVE:return g.add(t.offsetValue.scale(t.repeatCount))}break}case i.ANIMATIONTYPE_VECTOR2:{var v=f?this.vector2InterpolateFunctionWithTangents(l,o.outTangent.scale(h),u,s.inTangent.scale(h),c):this.vector2InterpolateFunction(l,u,c);switch(t.loopMode){case i.ANIMATIONLOOPMODE_CYCLE:case i.ANIMATIONLOOPMODE_CONSTANT:return v;case i.ANIMATIONLOOPMODE_RELATIVE:return v.add(t.offsetValue.scale(t.repeatCount))}break}case i.ANIMATIONTYPE_SIZE:{switch(t.loopMode){case i.ANIMATIONLOOPMODE_CYCLE:case i.ANIMATIONLOOPMODE_CONSTANT:return this.sizeInterpolateFunction(l,u,c);case i.ANIMATIONLOOPMODE_RELATIVE:return this.sizeInterpolateFunction(l,u,c).add(t.offsetValue.scale(t.repeatCount))}break}case i.ANIMATIONTYPE_COLOR3:{var y=f?this.color3InterpolateFunctionWithTangents(l,o.outTangent.scale(h),u,s.inTangent.scale(h),c):this.color3InterpolateFunction(l,u,c);switch(t.loopMode){case i.ANIMATIONLOOPMODE_CYCLE:case i.ANIMATIONLOOPMODE_CONSTANT:return y;case i.ANIMATIONLOOPMODE_RELATIVE:return y.add(t.offsetValue.scale(t.repeatCount))}break}case i.ANIMATIONTYPE_COLOR4:{var b=f?this.color4InterpolateFunctionWithTangents(l,o.outTangent.scale(h),u,s.inTangent.scale(h),c):this.color4InterpolateFunction(l,u,c);switch(t.loopMode){case i.ANIMATIONLOOPMODE_CYCLE:case i.ANIMATIONLOOPMODE_CONSTANT:return b;case i.ANIMATIONLOOPMODE_RELATIVE:return b.add(t.offsetValue.scale(t.repeatCount))}break}case i.ANIMATIONTYPE_MATRIX:{switch(t.loopMode){case i.ANIMATIONLOOPMODE_CYCLE:case i.ANIMATIONLOOPMODE_CONSTANT:return i.AllowMatricesInterpolation?this.matrixInterpolateFunction(l,u,c,t.workValue):l;case i.ANIMATIONLOOPMODE_RELATIVE:return l}break}}break}}return this._getKeyValue(r[r.length-1].value)},i.prototype.matrixInterpolateFunction=function(e,t,r,n){return i.AllowMatrixDecomposeForInterpolation?n?(G.DecomposeLerpToRef(e,t,r,n),n):G.DecomposeLerp(e,t,r):n?(G.LerpToRef(e,t,r,n),n):G.Lerp(e,t,r)},i.prototype.clone=function(){var e=new i(this.name,this.targetPropertyPath.join("."),this.framePerSecond,this.dataType,this.loopMode);if(e.enableBlending=this.enableBlending,e.blendingSpeed=this.blendingSpeed,this._keys&&e.setKeys(this._keys),this._ranges){e._ranges={};for(var t in this._ranges){var r=this._ranges[t];!r||(e._ranges[t]=r.clone())}}return e},i.prototype.setKeys=function(e){this._keys=e.slice(0)},i.prototype.serialize=function(){var e={};e.name=this.name,e.property=this.targetProperty,e.framePerSecond=this.framePerSecond,e.dataType=this.dataType,e.loopBehavior=this.loopMode,e.enableBlending=this.enableBlending,e.blendingSpeed=this.blendingSpeed;var t=this.dataType;e.keys=[];for(var r=this.getKeys(),n=0;n<r.length;n++){var a=r[n],s={};switch(s.frame=a.frame,t){case i.ANIMATIONTYPE_FLOAT:s.values=[a.value],a.inTangent!==void 0&&s.values.push(a.inTangent),a.outTangent!==void 0&&(a.inTangent===void 0&&s.values.push(void 0),s.values.push(a.outTangent)),a.interpolation!==void 0&&(a.inTangent===void 0&&s.values.push(void 0),a.outTangent===void 0&&s.values.push(void 0),s.values.push(a.interpolation));break;case i.ANIMATIONTYPE_QUATERNION:case i.ANIMATIONTYPE_MATRIX:case i.ANIMATIONTYPE_VECTOR3:case i.ANIMATIONTYPE_COLOR3:case i.ANIMATIONTYPE_COLOR4:s.values=a.value.asArray(),a.inTangent!=null&&s.values.push(a.inTangent.asArray()),a.outTangent!=null&&(a.inTangent===void 0&&s.values.push(void 0),s.values.push(a.outTangent.asArray())),a.interpolation!==void 0&&(a.inTangent===void 0&&s.values.push(void 0),a.outTangent===void 0&&s.values.push(void 0),s.values.push(a.interpolation));break}e.keys.push(s)}e.ranges=[];for(var o in this._ranges){var l=this._ranges[o];if(!!l){var u={};u.name=o,u.from=l.from,u.to=l.to,e.ranges.push(u)}}return e},i._UniversalLerp=function(e,t,r){var n=e.constructor;return n.Lerp?n.Lerp(e,t,r):n.Slerp?n.Slerp(e,t,r):e.toFixed?e*(1-r)+r*t:t},i.Parse=function(e){var t=new i(e.name,e.property,e.framePerSecond,e.dataType,e.loopBehavior),r=e.dataType,n=[],a,s;for(e.enableBlending&&(t.enableBlending=e.enableBlending),e.blendingSpeed&&(t.blendingSpeed=e.blendingSpeed),s=0;s<e.keys.length;s++){var o=e.keys[s],l=void 0,u=void 0,f=void 0;switch(r){case i.ANIMATIONTYPE_FLOAT:a=o.values[0],o.values.length>=2&&(l=o.values[1]),o.values.length>=3&&(u=o.values[2]),o.values.length>=4&&(f=o.values[3]);break;case i.ANIMATIONTYPE_QUATERNION:if(a=de.FromArray(o.values),o.values.length>=8){var h=de.FromArray(o.values.slice(4,8));h.equals(de.Zero())||(l=h)}if(o.values.length>=12){var c=de.FromArray(o.values.slice(8,12));c.equals(de.Zero())||(u=c)}o.values.length>=13&&(f=o.values[12]);break;case i.ANIMATIONTYPE_MATRIX:a=G.FromArray(o.values),o.values.length>=17&&(f=o.values[16]);break;case i.ANIMATIONTYPE_COLOR3:a=me.FromArray(o.values),o.values[3]&&(l=me.FromArray(o.values[3])),o.values[4]&&(u=me.FromArray(o.values[4])),o.values[5]&&(f=o.values[5]);break;case i.ANIMATIONTYPE_COLOR4:a=ce.FromArray(o.values),o.values[4]&&(l=ce.FromArray(o.values[4])),o.values[5]&&(u=ce.FromArray(o.values[5])),o.values[6]&&(f=ce.FromArray(o.values[6]));break;case i.ANIMATIONTYPE_VECTOR3:default:a=m.FromArray(o.values),o.values[3]&&(l=m.FromArray(o.values[3])),o.values[4]&&(u=m.FromArray(o.values[4])),o.values[5]&&(f=o.values[5]);break}var d={};d.frame=o.frame,d.value=a,l!=null&&(d.inTangent=l),u!=null&&(d.outTangent=u),f!=null&&(d.interpolation=f),n.push(d)}if(t.setKeys(n),e.ranges)for(s=0;s<e.ranges.length;s++)a=e.ranges[s],t.createRange(a.name,a.from,a.to);return t},i.AppendSerializedAnimations=function(e,t){pe.AppendSerializedAnimations(e,t)},i.ParseFromFileAsync=function(e,t){var r=this;return new Promise(function(n,a){var s=new Jt;s.addEventListener("readystatechange",function(){if(s.readyState==4)if(s.status==200){var o=JSON.parse(s.responseText);if(o.animations&&(o=o.animations),o.length){for(var l=new Array,u=0,f=o;u<f.length;u++){var h=f[u];l.push(r.Parse(h))}n(l)}else{var l=r.Parse(o);e&&(l.name=e),n(l)}}else a("Unable to load the animation")}),s.open("GET",t),s.send()})},i.CreateFromSnippetAsync=function(e){var t=this;return new Promise(function(r,n){var a=new Jt;a.addEventListener("readystatechange",function(){if(a.readyState==4)if(a.status==200){var s=JSON.parse(JSON.parse(a.responseText).jsonPayload);if(s.animations){for(var o=JSON.parse(s.animations),l=new Array,u=0,f=o.animations;u<f.length;u++){var h=f[u],c=t.Parse(h);c.snippetId=e,l.push(c)}r(l)}else{var o=JSON.parse(s.animation),c=t.Parse(o);c.snippetId=e,r(c)}}else n("Unable to load the snippet "+e)}),a.open("GET",t.SnippetUrl+"/"+e.replace(/#/g,"/")),a.send()})},i._UniqueIdGenerator=0,i.AllowMatricesInterpolation=!1,i.AllowMatrixDecomposeForInterpolation=!0,i.SnippetUrl="https://snippet.babylonjs.com",i.ANIMATIONTYPE_FLOAT=0,i.ANIMATIONTYPE_VECTOR3=1,i.ANIMATIONTYPE_QUATERNION=2,i.ANIMATIONTYPE_MATRIX=3,i.ANIMATIONTYPE_COLOR3=4,i.ANIMATIONTYPE_COLOR4=7,i.ANIMATIONTYPE_VECTOR2=5,i.ANIMATIONTYPE_SIZE=6,i.ANIMATIONLOOPMODE_RELATIVE=0,i.ANIMATIONLOOPMODE_CYCLE=1,i.ANIMATIONLOOPMODE_CONSTANT=2,i}();We("BABYLON.Animation",rt);ct._AnimationRangeFactory=function(i,e,t){return new ii(i,e,t)};var cu=function(){function i(){this.transitionDuration=450,this.lowerRadiusTransitionRange=2,this.upperRadiusTransitionRange=-2,this._autoTransitionRange=!1,this._radiusIsAnimating=!1,this._radiusBounceTransition=null,this._animatables=new Array}return Object.defineProperty(i.prototype,"name",{get:function(){return"Bouncing"},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"autoTransitionRange",{get:function(){return this._autoTransitionRange},set:function(e){var t=this;if(this._autoTransitionRange!==e){this._autoTransitionRange=e;var r=this._attachedCamera;!r||(e?this._onMeshTargetChangedObserver=r.onMeshTargetChangedObservable.add(function(n){if(!!n){n.computeWorldMatrix(!0);var a=n.getBoundingInfo().diagonalLength;t.lowerRadiusTransitionRange=a*.05,t.upperRadiusTransitionRange=a*.05}}):this._onMeshTargetChangedObserver&&r.onMeshTargetChangedObservable.remove(this._onMeshTargetChangedObserver))}},enumerable:!1,configurable:!0}),i.prototype.init=function(){},i.prototype.attach=function(e){var t=this;this._attachedCamera=e,this._onAfterCheckInputsObserver=e.onAfterCheckInputsObservable.add(function(){!t._attachedCamera||(t._isRadiusAtLimit(t._attachedCamera.lowerRadiusLimit)&&t._applyBoundRadiusAnimation(t.lowerRadiusTransitionRange),t._isRadiusAtLimit(t._attachedCamera.upperRadiusLimit)&&t._applyBoundRadiusAnimation(t.upperRadiusTransitionRange))})},i.prototype.detach=function(){!this._attachedCamera||(this._onAfterCheckInputsObserver&&this._attachedCamera.onAfterCheckInputsObservable.remove(this._onAfterCheckInputsObserver),this._onMeshTargetChangedObserver&&this._attachedCamera.onMeshTargetChangedObservable.remove(this._onMeshTargetChangedObserver),this._attachedCamera=null)},i.prototype._isRadiusAtLimit=function(e){return this._attachedCamera?this._attachedCamera.radius===e&&!this._radiusIsAnimating:!1},i.prototype._applyBoundRadiusAnimation=function(e){var t=this;if(!!this._attachedCamera){this._radiusBounceTransition||(i.EasingFunction.setEasingMode(i.EasingMode),this._radiusBounceTransition=rt.CreateAnimation("radius",rt.ANIMATIONTYPE_FLOAT,60,i.EasingFunction)),this._cachedWheelPrecision=this._attachedCamera.wheelPrecision,this._attachedCamera.wheelPrecision=1/0,this._attachedCamera.inertialRadiusOffset=0,this.stopAllAnimations(),this._radiusIsAnimating=!0;var r=rt.TransitionTo("radius",this._attachedCamera.radius+e,this._attachedCamera,this._attachedCamera.getScene(),60,this._radiusBounceTransition,this.transitionDuration,function(){return t._clearAnimationLocks()});r&&this._animatables.push(r)}},i.prototype._clearAnimationLocks=function(){this._radiusIsAnimating=!1,this._attachedCamera&&(this._attachedCamera.wheelPrecision=this._cachedWheelPrecision)},i.prototype.stopAllAnimations=function(){for(this._attachedCamera&&(this._attachedCamera.animations=[]);this._animatables.length;)this._animatables[0].onAnimationEnd=null,this._animatables[0].stop(),this._animatables.shift()},i.EasingFunction=new fu(.3),i.EasingMode=ut.EASINGMODE_EASEOUT,i}(),du=function(){function i(){this.onTargetFramingAnimationEndObservable=new X,this._mode=i.FitFrustumSidesMode,this._radiusScale=1,this._positionScale=.5,this._defaultElevation=.3,this._elevationReturnTime=1500,this._elevationReturnWaitTime=1e3,this._zoomStopsAnimation=!1,this._framingTime=1500,this.autoCorrectCameraLimitsAndSensibility=!0,this._isPointerDown=!1,this._lastInteractionTime=-1/0,this._animatables=new Array,this._betaIsAnimating=!1}return Object.defineProperty(i.prototype,"name",{get:function(){return"Framing"},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"mode",{get:function(){return this._mode},set:function(e){this._mode=e},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"radiusScale",{get:function(){return this._radiusScale},set:function(e){this._radiusScale=e},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"positionScale",{get:function(){return this._positionScale},set:function(e){this._positionScale=e},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"defaultElevation",{get:function(){return this._defaultElevation},set:function(e){this._defaultElevation=e},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"elevationReturnTime",{get:function(){return this._elevationReturnTime},set:function(e){this._elevationReturnTime=e},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"elevationReturnWaitTime",{get:function(){return this._elevationReturnWaitTime},set:function(e){this._elevationReturnWaitTime=e},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"zoomStopsAnimation",{get:function(){return this._zoomStopsAnimation},set:function(e){this._zoomStopsAnimation=e},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"framingTime",{get:function(){return this._framingTime},set:function(e){this._framingTime=e},enumerable:!1,configurable:!0}),i.prototype.init=function(){},i.prototype.attach=function(e){var t=this;this._attachedCamera=e;var r=this._attachedCamera.getScene();i.EasingFunction.setEasingMode(i.EasingMode),this._onPrePointerObservableObserver=r.onPrePointerObservable.add(function(n){if(n.type===fe.POINTERDOWN){t._isPointerDown=!0;return}n.type===fe.POINTERUP&&(t._isPointerDown=!1)}),this._onMeshTargetChangedObserver=e.onMeshTargetChangedObservable.add(function(n){n&&t.zoomOnMesh(n,void 0,function(){t.onTargetFramingAnimationEndObservable.notifyObservers()})}),this._onAfterCheckInputsObserver=e.onAfterCheckInputsObservable.add(function(){t._applyUserInteraction(),t._maintainCameraAboveGround()})},i.prototype.detach=function(){if(!!this._attachedCamera){var e=this._attachedCamera.getScene();this._onPrePointerObservableObserver&&e.onPrePointerObservable.remove(this._onPrePointerObservableObserver),this._onAfterCheckInputsObserver&&this._attachedCamera.onAfterCheckInputsObservable.remove(this._onAfterCheckInputsObserver),this._onMeshTargetChangedObserver&&this._attachedCamera.onMeshTargetChangedObservable.remove(this._onMeshTargetChangedObserver),this._attachedCamera=null}},i.prototype.zoomOnMesh=function(e,t,r){t===void 0&&(t=!1),r===void 0&&(r=null),e.computeWorldMatrix(!0);var n=e.getBoundingInfo().boundingBox;this.zoomOnBoundingInfo(n.minimumWorld,n.maximumWorld,t,r)},i.prototype.zoomOnMeshHierarchy=function(e,t,r){t===void 0&&(t=!1),r===void 0&&(r=null),e.computeWorldMatrix(!0);var n=e.getHierarchyBoundingVectors(!0);this.zoomOnBoundingInfo(n.min,n.max,t,r)},i.prototype.zoomOnMeshesHierarchy=function(e,t,r){t===void 0&&(t=!1),r===void 0&&(r=null);for(var n=new m(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),a=new m(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE),s=0;s<e.length;s++){var o=e[s].getHierarchyBoundingVectors(!0);m.CheckExtends(o.min,n,a),m.CheckExtends(o.max,n,a)}this.zoomOnBoundingInfo(n,a,t,r)},i.prototype.zoomOnBoundingInfo=function(e,t,r,n){var a=this;r===void 0&&(r=!1),n===void 0&&(n=null);var s;if(!!this._attachedCamera){var o=e.y,l=t.y,u=o+(l-o)*this._positionScale,f=t.subtract(e).scale(.5);if(r)s=new m(0,u,0);else{var h=e.add(f);s=new m(h.x,u,h.z)}this._vectorTransition||(this._vectorTransition=rt.CreateAnimation("target",rt.ANIMATIONTYPE_VECTOR3,60,i.EasingFunction)),this._betaIsAnimating=!0;var c=rt.TransitionTo("target",s,this._attachedCamera,this._attachedCamera.getScene(),60,this._vectorTransition,this._framingTime);c&&this._animatables.push(c);var d=0;if(this._mode===i.FitFrustumSidesMode){var p=this._calculateLowerRadiusFromModelBoundingSphere(e,t);this.autoCorrectCameraLimitsAndSensibility&&(this._attachedCamera.lowerRadiusLimit=f.length()+this._attachedCamera.minZ),d=p}else this._mode===i.IgnoreBoundsSizeMode&&(d=this._calculateLowerRadiusFromModelBoundingSphere(e,t),this.autoCorrectCameraLimitsAndSensibility&&this._attachedCamera.lowerRadiusLimit===null&&(this._attachedCamera.lowerRadiusLimit=this._attachedCamera.minZ));if(this.autoCorrectCameraLimitsAndSensibility){var _=t.subtract(e).length();this._attachedCamera.panningSensibility=5e3/_,this._attachedCamera.wheelPrecision=100/d}this._radiusTransition||(this._radiusTransition=rt.CreateAnimation("radius",rt.ANIMATIONTYPE_FLOAT,60,i.EasingFunction)),c=rt.TransitionTo("radius",d,this._attachedCamera,this._attachedCamera.getScene(),60,this._radiusTransition,this._framingTime,function(){a.stopAllAnimations(),n&&n(),a._attachedCamera&&a._attachedCamera.useInputToRestoreState&&a._attachedCamera.storeState()}),c&&this._animatables.push(c)}},i.prototype._calculateLowerRadiusFromModelBoundingSphere=function(e,t){var r=t.subtract(e),n=r.length(),a=this._getFrustumSlope(),s=n*.5,o=s*this._radiusScale,l=o*Math.sqrt(1+1/(a.x*a.x)),u=o*Math.sqrt(1+1/(a.y*a.y)),f=Math.max(l,u),h=this._attachedCamera;return h?(h.lowerRadiusLimit&&this._mode===i.IgnoreBoundsSizeMode&&(f=f<h.lowerRadiusLimit?h.lowerRadiusLimit:f),h.upperRadiusLimit&&(f=f>h.upperRadiusLimit?h.upperRadiusLimit:f),f):0},i.prototype._maintainCameraAboveGround=function(){var e=this;if(!(this._elevationReturnTime<0)){var t=nt.Now-this._lastInteractionTime,r=Math.PI*.5-this._defaultElevation,n=Math.PI*.5;if(this._attachedCamera&&!this._betaIsAnimating&&this._attachedCamera.beta>n&&t>=this._elevationReturnWaitTime){this._betaIsAnimating=!0,this.stopAllAnimations(),this._betaTransition||(this._betaTransition=rt.CreateAnimation("beta",rt.ANIMATIONTYPE_FLOAT,60,i.EasingFunction));var a=rt.TransitionTo("beta",r,this._attachedCamera,this._attachedCamera.getScene(),60,this._betaTransition,this._elevationReturnTime,function(){e._clearAnimationLocks(),e.stopAllAnimations()});a&&this._animatables.push(a)}}},i.prototype._getFrustumSlope=function(){var e=this._attachedCamera;if(!e)return se.Zero();var t=e.getScene().getEngine(),r=t.getAspectRatio(e),n=Math.tan(e.fov/2),a=n*r;return new se(a,n)},i.prototype._clearAnimationLocks=function(){this._betaIsAnimating=!1},i.prototype._applyUserInteraction=function(){this.isUserIsMoving&&(this._lastInteractionTime=nt.Now,this.stopAllAnimations(),this._clearAnimationLocks())},i.prototype.stopAllAnimations=function(){for(this._attachedCamera&&(this._attachedCamera.animations=[]);this._animatables.length;)this._animatables[0]&&(this._animatables[0].onAnimationEnd=null,this._animatables[0].stop()),this._animatables.shift()},Object.defineProperty(i.prototype,"isUserIsMoving",{get:function(){return this._attachedCamera?this._attachedCamera.inertialAlphaOffset!==0||this._attachedCamera.inertialBetaOffset!==0||this._attachedCamera.inertialRadiusOffset!==0||this._attachedCamera.inertialPanningX!==0||this._attachedCamera.inertialPanningY!==0||this._isPointerDown:!1},enumerable:!1,configurable:!0}),i.EasingFunction=new hu,i.EasingMode=ut.EASINGMODE_EASEINOUT,i.IgnoreBoundsSizeMode=0,i.FitFrustumSidesMode=1,i}(),pu=function(i){$(e,i);function e(t,r,n,a){a===void 0&&(a=!0);var s=i.call(this,t,r,n,a)||this;return s._tmpUpVector=m.Zero(),s._tmpTargetVector=m.Zero(),s.cameraDirection=new m(0,0,0),s.cameraRotation=new se(0,0),s.ignoreParentScaling=!1,s.updateUpVectorFromRotation=!1,s._tmpQuaternion=new de,s.rotation=new m(0,0,0),s.speed=2,s.noRotationConstraint=!1,s.invertRotation=!1,s.inverseRotationSpeed=.2,s.lockedTarget=null,s._currentTarget=m.Zero(),s._initialFocalDistance=1,s._viewMatrix=G.Zero(),s._camMatrix=G.Zero(),s._cameraTransformMatrix=G.Zero(),s._cameraRotationMatrix=G.Zero(),s._referencePoint=new m(0,0,1),s._transformedReferencePoint=m.Zero(),s._defaultUp=m.Up(),s._cachedRotationZ=0,s._cachedQuaternionRotationZ=0,s}return e.prototype.getFrontPosition=function(t){this.getWorldMatrix();var r=this.getTarget().subtract(this.position);return r.normalize(),r.scaleInPlace(t),this.globalPosition.add(r)},e.prototype._getLockedTargetPosition=function(){return this.lockedTarget?(this.lockedTarget.absolutePosition&&this.lockedTarget.computeWorldMatrix(),this.lockedTarget.absolutePosition||this.lockedTarget):null},e.prototype.storeState=function(){return this._storedPosition=this.position.clone(),this._storedRotation=this.rotation.clone(),this.rotationQuaternion&&(this._storedRotationQuaternion=this.rotationQuaternion.clone()),i.prototype.storeState.call(this)},e.prototype._restoreStateValues=function(){return i.prototype._restoreStateValues.call(this)?(this.position=this._storedPosition.clone(),this.rotation=this._storedRotation.clone(),this.rotationQuaternion&&(this.rotationQuaternion=this._storedRotationQuaternion.clone()),this.cameraDirection.copyFromFloats(0,0,0),this.cameraRotation.copyFromFloats(0,0),!0):!1},e.prototype._initCache=function(){i.prototype._initCache.call(this),this._cache.lockedTarget=new m(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),this._cache.rotation=new m(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),this._cache.rotationQuaternion=new de(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE)},e.prototype._updateCache=function(t){t||i.prototype._updateCache.call(this);var r=this._getLockedTargetPosition();r?this._cache.lockedTarget?this._cache.lockedTarget.copyFrom(r):this._cache.lockedTarget=r.clone():this._cache.lockedTarget=null,this._cache.rotation.copyFrom(this.rotation),this.rotationQuaternion&&this._cache.rotationQuaternion.copyFrom(this.rotationQuaternion)},e.prototype._isSynchronizedViewMatrix=function(){if(!i.prototype._isSynchronizedViewMatrix.call(this))return!1;var t=this._getLockedTargetPosition();return(this._cache.lockedTarget?this._cache.lockedTarget.equals(t):!t)&&(this.rotationQuaternion?this.rotationQuaternion.equals(this._cache.rotationQuaternion):this._cache.rotation.equals(this.rotation))},e.prototype._computeLocalCameraSpeed=function(){var t=this.getEngine();return this.speed*Math.sqrt(t.getDeltaTime()/(t.getFps()*100))},e.prototype.setTarget=function(t){this.upVector.normalize(),this._initialFocalDistance=t.subtract(this.position).length(),this.position.z===t.z&&(this.position.z+=Me),this._referencePoint.normalize().scaleInPlace(this._initialFocalDistance),G.LookAtLHToRef(this.position,t,this._defaultUp,this._camMatrix),this._camMatrix.invert(),this.rotation.x=Math.atan(this._camMatrix.m[6]/this._camMatrix.m[10]);var r=t.subtract(this.position);r.x>=0?this.rotation.y=-Math.atan(r.z/r.x)+Math.PI/2:this.rotation.y=-Math.atan(r.z/r.x)-Math.PI/2,this.rotation.z=0,isNaN(this.rotation.x)&&(this.rotation.x=0),isNaN(this.rotation.y)&&(this.rotation.y=0),isNaN(this.rotation.z)&&(this.rotation.z=0),this.rotationQuaternion&&de.RotationYawPitchRollToRef(this.rotation.y,this.rotation.x,this.rotation.z,this.rotationQuaternion)},Object.defineProperty(e.prototype,"target",{get:function(){return this.getTarget()},set:function(t){this.setTarget(t)},enumerable:!1,configurable:!0}),e.prototype.getTarget=function(){return this._currentTarget},e.prototype._decideIfNeedsToMove=function(){return Math.abs(this.cameraDirection.x)>0||Math.abs(this.cameraDirection.y)>0||Math.abs(this.cameraDirection.z)>0},e.prototype._updatePosition=function(){if(this.parent){this.parent.getWorldMatrix().invertToRef(U.Matrix[0]),m.TransformNormalToRef(this.cameraDirection,U.Matrix[0],U.Vector3[0]),this.position.addInPlace(U.Vector3[0]);return}this.position.addInPlace(this.cameraDirection)},e.prototype._checkInputs=function(){var t=this.invertRotation?-this.inverseRotationSpeed:1,r=this._decideIfNeedsToMove(),n=Math.abs(this.cameraRotation.x)>0||Math.abs(this.cameraRotation.y)>0;if(r&&this._updatePosition(),n){if(this.rotationQuaternion&&this.rotationQuaternion.toEulerAnglesToRef(this.rotation),this.rotation.x+=this.cameraRotation.x*t,this.rotation.y+=this.cameraRotation.y*t,!this.noRotationConstraint){var a=1.570796;this.rotation.x>a&&(this.rotation.x=a),this.rotation.x<-a&&(this.rotation.x=-a)}if(this.rotationQuaternion){var s=this.rotation.lengthSquared();s&&de.RotationYawPitchRollToRef(this.rotation.y,this.rotation.x,this.rotation.z,this.rotationQuaternion)}}r&&(Math.abs(this.cameraDirection.x)<this.speed*Me&&(this.cameraDirection.x=0),Math.abs(this.cameraDirection.y)<this.speed*Me&&(this.cameraDirection.y=0),Math.abs(this.cameraDirection.z)<this.speed*Me&&(this.cameraDirection.z=0),this.cameraDirection.scaleInPlace(this.inertia)),n&&(Math.abs(this.cameraRotation.x)<this.speed*Me&&(this.cameraRotation.x=0),Math.abs(this.cameraRotation.y)<this.speed*Me&&(this.cameraRotation.y=0),this.cameraRotation.scaleInPlace(this.inertia)),i.prototype._checkInputs.call(this)},e.prototype._updateCameraRotationMatrix=function(){this.rotationQuaternion?this.rotationQuaternion.toRotationMatrix(this._cameraRotationMatrix):G.RotationYawPitchRollToRef(this.rotation.y,this.rotation.x,this.rotation.z,this._cameraRotationMatrix)},e.prototype._rotateUpVectorWithCameraRotationMatrix=function(){return m.TransformNormalToRef(this._defaultUp,this._cameraRotationMatrix,this.upVector),this},e.prototype._getViewMatrix=function(){return this.lockedTarget&&this.setTarget(this._getLockedTargetPosition()),this._updateCameraRotationMatrix(),this.rotationQuaternion&&this._cachedQuaternionRotationZ!=this.rotationQuaternion.z?(this._rotateUpVectorWithCameraRotationMatrix(),this._cachedQuaternionRotationZ=this.rotationQuaternion.z):this._cachedRotationZ!==this.rotation.z&&(this._rotateUpVectorWithCameraRotationMatrix(),this._cachedRotationZ=this.rotation.z),m.TransformCoordinatesToRef(this._referencePoint,this._cameraRotationMatrix,this._transformedReferencePoint),this.position.addToRef(this._transformedReferencePoint,this._currentTarget),this.updateUpVectorFromRotation&&(this.rotationQuaternion?ei.Y.rotateByQuaternionToRef(this.rotationQuaternion,this.upVector):(de.FromEulerVectorToRef(this.rotation,this._tmpQuaternion),ei.Y.rotateByQuaternionToRef(this._tmpQuaternion,this.upVector))),this._computeViewMatrix(this.position,this._currentTarget,this.upVector),this._viewMatrix},e.prototype._computeViewMatrix=function(t,r,n){if(this.ignoreParentScaling){if(this.parent){var a=this.parent.getWorldMatrix();m.TransformCoordinatesToRef(t,a,this._globalPosition),m.TransformCoordinatesToRef(r,a,this._tmpTargetVector),m.TransformNormalToRef(n,a,this._tmpUpVector),this._markSyncedWithParent()}else this._globalPosition.copyFrom(t),this._tmpTargetVector.copyFrom(r),this._tmpUpVector.copyFrom(n);this.getScene().useRightHandedSystem?G.LookAtRHToRef(this._globalPosition,this._tmpTargetVector,this._tmpUpVector,this._viewMatrix):G.LookAtLHToRef(this._globalPosition,this._tmpTargetVector,this._tmpUpVector,this._viewMatrix);return}if(this.getScene().useRightHandedSystem?G.LookAtRHToRef(t,r,n,this._viewMatrix):G.LookAtLHToRef(t,r,n,this._viewMatrix),this.parent){var a=this.parent.getWorldMatrix();this._viewMatrix.invert(),this._viewMatrix.multiplyToRef(a,this._viewMatrix),this._viewMatrix.getTranslationToRef(this._globalPosition),this._viewMatrix.invert(),this._markSyncedWithParent()}else this._globalPosition.copyFrom(t)},e.prototype.createRigCamera=function(t,r){if(this.cameraRigMode!==Ne.RIG_MODE_NONE){var n=new e(t,this.position.clone(),this.getScene());return n.isRigCamera=!0,n.rigParent=this,(this.cameraRigMode===Ne.RIG_MODE_VR||this.cameraRigMode===Ne.RIG_MODE_WEBVR)&&(this.rotationQuaternion||(this.rotationQuaternion=new de),n._cameraRigParams={},n.rotationQuaternion=new de),n}return null},e.prototype._updateRigCameras=function(){var t=this._rigCameras[0],r=this._rigCameras[1];switch(this.computeWorldMatrix(),this.cameraRigMode){case Ne.RIG_MODE_STEREOSCOPIC_ANAGLYPH:case Ne.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_PARALLEL:case Ne.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_CROSSEYED:case Ne.RIG_MODE_STEREOSCOPIC_OVERUNDER:case Ne.RIG_MODE_STEREOSCOPIC_INTERLACED:{var n=this.cameraRigMode===Ne.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_CROSSEYED?1:-1,a=this.cameraRigMode===Ne.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_CROSSEYED?-1:1;this._getRigCamPositionAndTarget(this._cameraRigParams.stereoHalfAngle*n,t),this._getRigCamPositionAndTarget(this._cameraRigParams.stereoHalfAngle*a,r);break}case Ne.RIG_MODE_VR:t.rotationQuaternion?(t.rotationQuaternion.copyFrom(this.rotationQuaternion),r.rotationQuaternion.copyFrom(this.rotationQuaternion)):(t.rotation.copyFrom(this.rotation),r.rotation.copyFrom(this.rotation)),t.position.copyFrom(this.position),r.position.copyFrom(this.position);break}i.prototype._updateRigCameras.call(this)},e.prototype._getRigCamPositionAndTarget=function(t,r){var n=this.getTarget();n.subtractToRef(this.position,e._TargetFocalPoint),e._TargetFocalPoint.normalize().scaleInPlace(this._initialFocalDistance);var a=e._TargetFocalPoint.addInPlace(this.position);G.TranslationToRef(-a.x,-a.y,-a.z,e._TargetTransformMatrix),e._TargetTransformMatrix.multiplyToRef(G.RotationAxis(r.upVector,t),e._RigCamTransformMatrix),G.TranslationToRef(a.x,a.y,a.z,e._TargetTransformMatrix),e._RigCamTransformMatrix.multiplyToRef(e._TargetTransformMatrix,e._RigCamTransformMatrix),m.TransformCoordinatesToRef(this.position,e._RigCamTransformMatrix,r.position),r.setTarget(a)},e.prototype.getClassName=function(){return"TargetCamera"},e._RigCamTransformMatrix=new G,e._TargetTransformMatrix=new G,e._TargetFocalPoint=new m,C([xt()],e.prototype,"rotation",void 0),C([I()],e.prototype,"speed",void 0),C([Ma("lockedTargetId")],e.prototype,"lockedTarget",void 0),e}(Ne),wr={},_u=function(){function i(e){this.attachedToElement=!1,this.attached={},this.camera=e,this.checkInputs=function(){}}return i.prototype.add=function(e){var t=e.getSimpleName();if(this.attached[t]){Y.Warn("camera input of type "+t+" already exists on camera");return}this.attached[t]=e,e.camera=this.camera,e.checkInputs&&(this.checkInputs=this._addCheckInputs(e.checkInputs.bind(e))),this.attachedToElement&&e.attachControl()},i.prototype.remove=function(e){for(var t in this.attached){var r=this.attached[t];r===e&&(r.detachControl(),r.camera=null,delete this.attached[t],this.rebuildInputCheck())}},i.prototype.removeByType=function(e){for(var t in this.attached){var r=this.attached[t];r.getClassName()===e&&(r.detachControl(),r.camera=null,delete this.attached[t],this.rebuildInputCheck())}},i.prototype._addCheckInputs=function(e){var t=this.checkInputs;return function(){t(),e()}},i.prototype.attachInput=function(e){this.attachedToElement&&e.attachControl(this.noPreventDefault)},i.prototype.attachElement=function(e){if(e===void 0&&(e=!1),!this.attachedToElement){e=Ne.ForceAttachControlToAlwaysPreventDefault?!1:e,this.attachedToElement=!0,this.noPreventDefault=e;for(var t in this.attached)this.attached[t].attachControl(e)}},i.prototype.detachElement=function(e){e===void 0&&(e=!1);for(var t in this.attached)this.attached[t].detachControl(),e&&(this.attached[t].camera=null);this.attachedToElement=!1},i.prototype.rebuildInputCheck=function(){this.checkInputs=function(){};for(var e in this.attached){var t=this.attached[e];t.checkInputs&&(this.checkInputs=this._addCheckInputs(t.checkInputs.bind(t)))}},i.prototype.clear=function(){this.attachedToElement&&this.detachElement(!0),this.attached={},this.attachedToElement=!1,this.checkInputs=function(){}},i.prototype.serialize=function(e){var t={};for(var r in this.attached){var n=this.attached[r],a=pe.Serialize(n);t[n.getClassName()]=a}e.inputsmgr=t},i.prototype.parse=function(e){var t=e.inputsmgr;if(t){this.clear();var r=function(l){var u=wr[l];if(u){var f=t[l],h=pe.Parse(function(){return new u},f,null);n.add(h)}},n=this;for(var a in t)r(a)}else{var s=function(l){var u=wr[o.attached[l].getClassName()];if(u){var f=pe.Parse(function(){return new u},e,null);o.remove(o.attached[l]),o.add(f)}},o=this;for(var a in this.attached)s(a)}},i}(),vu=function(){function i(){this._currentActiveButton=-1,this.buttons=[0,1,2]}return i.prototype.attachControl=function(e){var t=this;e=te.BackCompatCameraNoPreventDefault(arguments);var r=this.camera.getEngine(),n=r.getInputElement(),a=0,s=null;this._pointA=null,this._pointB=null,this._altKey=!1,this._ctrlKey=!1,this._metaKey=!1,this._shiftKey=!1,this._buttonsPressed=0,this._pointerInput=function(l){var u=l.event,f=u.pointerType==="touch";if(!r.isInVRExclusivePointerMode&&!(l.type!==fe.POINTERMOVE&&t.buttons.indexOf(u.button)===-1)){var h=u.srcElement||u.target;if(t._altKey=u.altKey,t._ctrlKey=u.ctrlKey,t._metaKey=u.metaKey,t._shiftKey=u.shiftKey,t._buttonsPressed=u.buttons,r.isPointerLock){var c=u.movementX||u.mozMovementX||u.webkitMovementX||u.msMovementX||0,d=u.movementY||u.mozMovementY||u.webkitMovementY||u.msMovementY||0;t.onTouch(null,c,d),t._pointA=null,t._pointB=null}else if(l.type===fe.POINTERDOWN&&(t._currentActiveButton===-1||f)){try{h==null||h.setPointerCapture(u.pointerId)}catch{}t._pointA===null?t._pointA={x:u.clientX,y:u.clientY,pointerId:u.pointerId,type:u.pointerType}:t._pointB===null&&(t._pointB={x:u.clientX,y:u.clientY,pointerId:u.pointerId,type:u.pointerType}),t._currentActiveButton===-1&&!f&&(t._currentActiveButton=u.button),t.onButtonDown(u),e||(u.preventDefault(),n&&n.focus())}else if(l.type===fe.POINTERDOUBLETAP)t.onDoubleTap(u.pointerType);else if(l.type===fe.POINTERUP&&(t._currentActiveButton===u.button||f)){try{h==null||h.releasePointerCapture(u.pointerId)}catch{}f||(t._pointB=null),r._badOS?t._pointA=t._pointB=null:t._pointB&&t._pointA&&t._pointA.pointerId==u.pointerId?(t._pointA=t._pointB,t._pointB=null):t._pointA&&t._pointB&&t._pointB.pointerId==u.pointerId?t._pointB=null:t._pointA=t._pointB=null,(a!==0||s)&&(t.onMultiTouch(t._pointA,t._pointB,a,0,s,null),a=0,s=null),t._currentActiveButton=-1,t.onButtonUp(u),e||u.preventDefault()}else if(l.type===fe.POINTERMOVE){if(e||u.preventDefault(),t._pointA&&t._pointB===null){var c=u.clientX-t._pointA.x,d=u.clientY-t._pointA.y;t.onTouch(t._pointA,c,d),t._pointA.x=u.clientX,t._pointA.y=u.clientY}else if(t._pointA&&t._pointB){var p=t._pointA.pointerId===u.pointerId?t._pointA:t._pointB;p.x=u.clientX,p.y=u.clientY;var _=t._pointA.x-t._pointB.x,g=t._pointA.y-t._pointB.y,v=_*_+g*g,y={x:(t._pointA.x+t._pointB.x)/2,y:(t._pointA.y+t._pointB.y)/2,pointerId:u.pointerId,type:l.type};t.onMultiTouch(t._pointA,t._pointB,a,v,s,y),s=y,a=v}}}},this._observer=this.camera.getScene().onPointerObservable.add(this._pointerInput,fe.POINTERDOWN|fe.POINTERUP|fe.POINTERMOVE|fe.POINTERDOUBLETAP),this._onLostFocus=function(){t._pointA=t._pointB=null,a=0,s=null,t.onLostFocus()},this._contextMenuBind=this.onContextMenu.bind(this),n&&n.addEventListener("contextmenu",this._contextMenuBind,!1);var o=this.camera.getScene().getEngine().getHostWindow();o&&te.RegisterTopRootEvents(o,[{name:"blur",handler:this._onLostFocus}])},i.prototype.detachControl=function(){if(this._onLostFocus){var e=this.camera.getScene().getEngine().getHostWindow();e&&te.UnregisterTopRootEvents(e,[{name:"blur",handler:this._onLostFocus}])}if(this._observer){if(this.camera.getScene().onPointerObservable.remove(this._observer),this._observer=null,this._contextMenuBind){var t=this.camera.getScene().getEngine().getInputElement();t&&t.removeEventListener("contextmenu",this._contextMenuBind)}this._onLostFocus=null}this._altKey=!1,this._ctrlKey=!1,this._metaKey=!1,this._shiftKey=!1,this._buttonsPressed=0,this._currentActiveButton=-1},i.prototype.getClassName=function(){return"BaseCameraPointersInput"},i.prototype.getSimpleName=function(){return"pointers"},i.prototype.onDoubleTap=function(e){},i.prototype.onTouch=function(e,t,r){},i.prototype.onMultiTouch=function(e,t,r,n,a,s){},i.prototype.onContextMenu=function(e){e.preventDefault()},i.prototype.onButtonDown=function(e){},i.prototype.onButtonUp=function(e){},i.prototype.onLostFocus=function(){},C([I()],i.prototype,"buttons",void 0),i}(),Bs=function(i){$(e,i);function e(){var t=i!==null&&i.apply(this,arguments)||this;return t.buttons=[0,1,2],t.angularSensibilityX=1e3,t.angularSensibilityY=1e3,t.pinchPrecision=12,t.pinchDeltaPercentage=0,t.useNaturalPinchZoom=!1,t.pinchZoom=!0,t.panningSensibility=1e3,t.multiTouchPanning=!0,t.multiTouchPanAndZoom=!0,t.pinchInwards=!0,t._isPanClick=!1,t._twoFingerActivityCount=0,t._isPinching=!1,t}return e.prototype.getClassName=function(){return"ArcRotateCameraPointersInput"},e.prototype._computeMultiTouchPanning=function(t,r){if(this.panningSensibility!==0&&t&&r){var n=r.x-t.x,a=r.y-t.y;this.camera.inertialPanningX+=-n/this.panningSensibility,this.camera.inertialPanningY+=a/this.panningSensibility}},e.prototype._computePinchZoom=function(t,r){var n=this.camera.radius||e.MinimumRadiusForPinch;this.useNaturalPinchZoom?this.camera.radius=n*Math.sqrt(t)/Math.sqrt(r):this.pinchDeltaPercentage?this.camera.inertialRadiusOffset+=(r-t)*.001*n*this.pinchDeltaPercentage:this.camera.inertialRadiusOffset+=(r-t)/(this.pinchPrecision*(this.pinchInwards?1:-1)*(this.angularSensibilityX+this.angularSensibilityY)/2)},e.prototype.onTouch=function(t,r,n){this.panningSensibility!==0&&(this._ctrlKey&&this.camera._useCtrlForPanning||this._isPanClick)?(this.camera.inertialPanningX+=-r/this.panningSensibility,this.camera.inertialPanningY+=n/this.panningSensibility):(this.camera.inertialAlphaOffset-=r/this.angularSensibilityX,this.camera.inertialBetaOffset-=n/this.angularSensibilityY)},e.prototype.onDoubleTap=function(){this.camera.useInputToRestoreState&&this.camera.restoreState()},e.prototype.onMultiTouch=function(t,r,n,a,s,o){n===0&&s===null||a===0&&o===null||(this.multiTouchPanAndZoom?(this._computePinchZoom(n,a),this._computeMultiTouchPanning(s,o)):this.multiTouchPanning&&this.pinchZoom?(this._twoFingerActivityCount++,this._isPinching||this._twoFingerActivityCount<20&&Math.abs(Math.sqrt(a)-Math.sqrt(n))>this.camera.pinchToPanMaxDistance?(this._computePinchZoom(n,a),this._isPinching=!0):this._computeMultiTouchPanning(s,o)):this.multiTouchPanning?this._computeMultiTouchPanning(s,o):this.pinchZoom&&this._computePinchZoom(n,a))},e.prototype.onButtonDown=function(t){this._isPanClick=t.button===this.camera._panningMouseButton},e.prototype.onButtonUp=function(){this._twoFingerActivityCount=0,this._isPinching=!1},e.prototype.onLostFocus=function(){this._isPanClick=!1,this._twoFingerActivityCount=0,this._isPinching=!1},e.MinimumRadiusForPinch=.001,C([I()],e.prototype,"buttons",void 0),C([I()],e.prototype,"angularSensibilityX",void 0),C([I()],e.prototype,"angularSensibilityY",void 0),C([I()],e.prototype,"pinchPrecision",void 0),C([I()],e.prototype,"pinchDeltaPercentage",void 0),C([I()],e.prototype,"useNaturalPinchZoom",void 0),C([I()],e.prototype,"pinchZoom",void 0),C([I()],e.prototype,"panningSensibility",void 0),C([I()],e.prototype,"multiTouchPanning",void 0),C([I()],e.prototype,"multiTouchPanAndZoom",void 0),e}(vu);wr.ArcRotateCameraPointersInput=Bs;var Us=function(){function i(){this.keysUp=[38],this.keysDown=[40],this.keysLeft=[37],this.keysRight=[39],this.keysReset=[220],this.panningSensibility=50,this.zoomingSensibility=25,this.useAltToZoom=!0,this.angularSpeed=.01,this._keys=new Array}return i.prototype.attachControl=function(e){var t=this;e=te.BackCompatCameraNoPreventDefault(arguments),!this._onCanvasBlurObserver&&(this._scene=this.camera.getScene(),this._engine=this._scene.getEngine(),this._onCanvasBlurObserver=this._engine.onCanvasBlurObservable.add(function(){t._keys=[]}),this._onKeyboardObserver=this._scene.onKeyboardObservable.add(function(r){var n=r.event;if(!n.metaKey){if(r.type===Bi.KEYDOWN){if(t._ctrlPressed=n.ctrlKey,t._altPressed=n.altKey,t.keysUp.indexOf(n.keyCode)!==-1||t.keysDown.indexOf(n.keyCode)!==-1||t.keysLeft.indexOf(n.keyCode)!==-1||t.keysRight.indexOf(n.keyCode)!==-1||t.keysReset.indexOf(n.keyCode)!==-1){var a=t._keys.indexOf(n.keyCode);a===-1&&t._keys.push(n.keyCode),n.preventDefault&&(e||n.preventDefault())}}else if(t.keysUp.indexOf(n.keyCode)!==-1||t.keysDown.indexOf(n.keyCode)!==-1||t.keysLeft.indexOf(n.keyCode)!==-1||t.keysRight.indexOf(n.keyCode)!==-1||t.keysReset.indexOf(n.keyCode)!==-1){var a=t._keys.indexOf(n.keyCode);a>=0&&t._keys.splice(a,1),n.preventDefault&&(e||n.preventDefault())}}}))},i.prototype.detachControl=function(){this._scene&&(this._onKeyboardObserver&&this._scene.onKeyboardObservable.remove(this._onKeyboardObserver),this._onCanvasBlurObserver&&this._engine.onCanvasBlurObservable.remove(this._onCanvasBlurObserver),this._onKeyboardObserver=null,this._onCanvasBlurObserver=null),this._keys=[]},i.prototype.checkInputs=function(){if(this._onKeyboardObserver)for(var e=this.camera,t=0;t<this._keys.length;t++){var r=this._keys[t];this.keysLeft.indexOf(r)!==-1?this._ctrlPressed&&this.camera._useCtrlForPanning?e.inertialPanningX-=1/this.panningSensibility:e.inertialAlphaOffset-=this.angularSpeed:this.keysUp.indexOf(r)!==-1?this._ctrlPressed&&this.camera._useCtrlForPanning?e.inertialPanningY+=1/this.panningSensibility:this._altPressed&&this.useAltToZoom?e.inertialRadiusOffset+=1/this.zoomingSensibility:e.inertialBetaOffset-=this.angularSpeed:this.keysRight.indexOf(r)!==-1?this._ctrlPressed&&this.camera._useCtrlForPanning?e.inertialPanningX+=1/this.panningSensibility:e.inertialAlphaOffset+=this.angularSpeed:this.keysDown.indexOf(r)!==-1?this._ctrlPressed&&this.camera._useCtrlForPanning?e.inertialPanningY-=1/this.panningSensibility:this._altPressed&&this.useAltToZoom?e.inertialRadiusOffset-=1/this.zoomingSensibility:e.inertialBetaOffset+=this.angularSpeed:this.keysReset.indexOf(r)!==-1&&e.useInputToRestoreState&&e.restoreState()}},i.prototype.getClassName=function(){return"ArcRotateCameraKeyboardMoveInput"},i.prototype.getSimpleName=function(){return"keyboard"},C([I()],i.prototype,"keysUp",void 0),C([I()],i.prototype,"keysDown",void 0),C([I()],i.prototype,"keysLeft",void 0),C([I()],i.prototype,"keysRight",void 0),C([I()],i.prototype,"keysReset",void 0),C([I()],i.prototype,"panningSensibility",void 0),C([I()],i.prototype,"zoomingSensibility",void 0),C([I()],i.prototype,"useAltToZoom",void 0),C([I()],i.prototype,"angularSpeed",void 0),i}();wr.ArcRotateCameraKeyboardMoveInput=Us;var gu=40,Vs=function(){function i(){this.wheelPrecision=3,this.zoomToMouseLocation=!1,this.wheelDeltaPercentage=0,this.customComputeDeltaFromMouseWheel=null,this._inertialPanning=m.Zero()}return i.prototype._computeDeltaFromMouseWheelLegacyEvent=function(e,t){var r=0,n=e*.01*this.wheelDeltaPercentage*t;return e>0?r=n/(1+this.wheelDeltaPercentage):r=n*(1+this.wheelDeltaPercentage),r},i.prototype.attachControl=function(e){var t=this;e=te.BackCompatCameraNoPreventDefault(arguments),this._wheel=function(r){if(r.type===fe.POINTERWHEEL){var n=r.event,a=0,s=n,o=0,l=n.deltaMode===Ga.DOM_DELTA_LINE?gu:1;if(n.deltaY!==void 0?o=-(n.deltaY*l):n.wheelDeltaY!==void 0?o=-(n.wheelDeltaY*l):o=s.wheelDelta,t.customComputeDeltaFromMouseWheel)a=t.customComputeDeltaFromMouseWheel(o,t,n);else if(t.wheelDeltaPercentage){if(a=t._computeDeltaFromMouseWheelLegacyEvent(o,t.camera.radius),a>0){for(var u=t.camera.radius,f=t.camera.inertialRadiusOffset+a,h=0;h<20&&Math.abs(f)>.001;h++)u-=f,f*=t.camera.inertia;u=K.Clamp(u,0,Number.MAX_VALUE),a=t._computeDeltaFromMouseWheelLegacyEvent(o,u)}}else a=o/(t.wheelPrecision*40);a&&(t.zoomToMouseLocation&&t._hitPlane?t._zoomToMouse(a):t.camera.inertialRadiusOffset+=a),n.preventDefault&&(e||n.preventDefault())}},this._observer=this.camera.getScene().onPointerObservable.add(this._wheel,fe.POINTERWHEEL),this.zoomToMouseLocation&&this._inertialPanning.setAll(0)},i.prototype.detachControl=function(){this._observer&&(this.camera.getScene().onPointerObservable.remove(this._observer),this._observer=null,this._wheel=null)},i.prototype.checkInputs=function(){if(!!this.zoomToMouseLocation){var e=this.camera,t=0+e.inertialAlphaOffset+e.inertialBetaOffset+e.inertialRadiusOffset;t&&(this._updateHitPlane(),e.target.addInPlace(this._inertialPanning),this._inertialPanning.scaleInPlace(e.inertia),this._zeroIfClose(this._inertialPanning))}},i.prototype.getClassName=function(){return"ArcRotateCameraMouseWheelInput"},i.prototype.getSimpleName=function(){return"mousewheel"},i.prototype._updateHitPlane=function(){var e=this.camera,t=e.target.subtract(e.position);this._hitPlane=yr.FromPositionAndNormal(e.target,t)},i.prototype._getPosition=function(){var e,t=this.camera,r=t.getScene(),n=r.createPickingRay(r.pointerX,r.pointerY,G.Identity(),t,!1),a=0;return this._hitPlane&&(a=(e=n.intersectsPlane(this._hitPlane))!==null&&e!==void 0?e:0),n.origin.addInPlace(n.direction.scaleInPlace(a))},i.prototype._zoomToMouse=function(e){var t,r,n=this.camera,a=1-n.inertia;if(n.lowerRadiusLimit){var s=(t=n.lowerRadiusLimit)!==null&&t!==void 0?t:0;n.radius-(n.inertialRadiusOffset+e)/a<s&&(e=(n.radius-s)*a-n.inertialRadiusOffset)}if(n.upperRadiusLimit){var o=(r=n.upperRadiusLimit)!==null&&r!==void 0?r:0;n.radius-(n.inertialRadiusOffset+e)/a>o&&(e=(n.radius-o)*a-n.inertialRadiusOffset)}var l=e/a,u=l/n.radius,f=this._getPosition(),h=U.Vector3[6];f.subtractToRef(n.target,h),h.scaleInPlace(u),h.scaleInPlace(a),this._inertialPanning.addInPlace(h),n.inertialRadiusOffset+=e},i.prototype._zeroIfClose=function(e){Math.abs(e.x)<Me&&(e.x=0),Math.abs(e.y)<Me&&(e.y=0),Math.abs(e.z)<Me&&(e.z=0)},C([I()],i.prototype,"wheelPrecision",void 0),C([I()],i.prototype,"zoomToMouseLocation",void 0),C([I()],i.prototype,"wheelDeltaPercentage",void 0),i}();wr.ArcRotateCameraMouseWheelInput=Vs;var mu=function(i){$(e,i);function e(t){return i.call(this,t)||this}return e.prototype.addMouseWheel=function(){return this.add(new Vs),this},e.prototype.addPointers=function(){return this.add(new Bs),this},e.prototype.addKeyboard=function(){return this.add(new Us),this},e}(_u);ct.AddNodeConstructor("ArcRotateCamera",function(i,e){return function(){return new pn(i,0,0,1,m.Zero(),e)}});var pn=function(i){$(e,i);function e(t,r,n,a,s,o,l){l===void 0&&(l=!0);var u=i.call(this,t,m.Zero(),o,l)||this;return u.inertialAlphaOffset=0,u.inertialBetaOffset=0,u.inertialRadiusOffset=0,u.lowerAlphaLimit=null,u.upperAlphaLimit=null,u.lowerBetaLimit=.01,u.upperBetaLimit=Math.PI-.01,u.lowerRadiusLimit=null,u.upperRadiusLimit=null,u.inertialPanningX=0,u.inertialPanningY=0,u.pinchToPanMaxDistance=20,u.panningDistanceLimit=null,u.panningOriginTarget=m.Zero(),u.panningInertia=.9,u.zoomOnFactor=1,u.targetScreenOffset=se.Zero(),u.allowUpsideDown=!0,u.useInputToRestoreState=!0,u._viewMatrix=new G,u.panningAxis=new m(1,1,0),u._transformedDirection=new m,u.mapPanning=!1,u.onMeshTargetChangedObservable=new X,u.checkCollisions=!1,u.collisionRadius=new m(.5,.5,.5),u._previousPosition=m.Zero(),u._collisionVelocity=m.Zero(),u._newPosition=m.Zero(),u._computationVector=m.Zero(),u._onCollisionPositionChange=function(f,h,c){c===void 0&&(c=null),c?(u.setPosition(h),u.onCollide&&u.onCollide(c)):u._previousPosition.copyFrom(u._position);var d=Math.cos(u.alpha),p=Math.sin(u.alpha),_=Math.cos(u.beta),g=Math.sin(u.beta);g===0&&(g=1e-4);var v=u._getTargetPosition();u._computationVector.copyFromFloats(u.radius*d*g,u.radius*_,u.radius*p*g),v.addToRef(u._computationVector,u._newPosition),u._position.copyFrom(u._newPosition);var y=u.upVector;u.allowUpsideDown&&u.beta<0&&(y=y.clone(),y=y.negate()),u._computeViewMatrix(u._position,v,y),u._viewMatrix.addAtIndex(12,u.targetScreenOffset.x),u._viewMatrix.addAtIndex(13,u.targetScreenOffset.y),u._collisionTriggered=!1},u._target=m.Zero(),s&&u.setTarget(s),u.alpha=r,u.beta=n,u.radius=a,u.getViewMatrix(),u.inputs=new mu(u),u.inputs.addKeyboard().addMouseWheel().addPointers(),u}return Object.defineProperty(e.prototype,"target",{get:function(){return this._target},set:function(t){this.setTarget(t)},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"targetHost",{get:function(){return this._targetHost},set:function(t){t&&this.setTarget(t)},enumerable:!1,configurable:!0}),e.prototype.getTarget=function(){return this.target},Object.defineProperty(e.prototype,"position",{get:function(){return this._position},set:function(t){this.setPosition(t)},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"upVector",{get:function(){return this._upVector},set:function(t){this._upToYMatrix||(this._yToUpMatrix=new G,this._upToYMatrix=new G,this._upVector=m.Zero()),t.normalize(),this._upVector.copyFrom(t),this.setMatUp()},enumerable:!1,configurable:!0}),e.prototype.setMatUp=function(){G.RotationAlignToRef(m.UpReadOnly,this._upVector,this._yToUpMatrix),G.RotationAlignToRef(this._upVector,m.UpReadOnly,this._upToYMatrix)},Object.defineProperty(e.prototype,"angularSensibilityX",{get:function(){var t=this.inputs.attached.pointers;return t?t.angularSensibilityX:0},set:function(t){var r=this.inputs.attached.pointers;r&&(r.angularSensibilityX=t)},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"angularSensibilityY",{get:function(){var t=this.inputs.attached.pointers;return t?t.angularSensibilityY:0},set:function(t){var r=this.inputs.attached.pointers;r&&(r.angularSensibilityY=t)},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"pinchPrecision",{get:function(){var t=this.inputs.attached.pointers;return t?t.pinchPrecision:0},set:function(t){var r=this.inputs.attached.pointers;r&&(r.pinchPrecision=t)},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"pinchDeltaPercentage",{get:function(){var t=this.inputs.attached.pointers;return t?t.pinchDeltaPercentage:0},set:function(t){var r=this.inputs.attached.pointers;r&&(r.pinchDeltaPercentage=t)},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"useNaturalPinchZoom",{get:function(){var t=this.inputs.attached.pointers;return t?t.useNaturalPinchZoom:!1},set:function(t){var r=this.inputs.attached.pointers;r&&(r.useNaturalPinchZoom=t)},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"panningSensibility",{get:function(){var t=this.inputs.attached.pointers;return t?t.panningSensibility:0},set:function(t){var r=this.inputs.attached.pointers;r&&(r.panningSensibility=t)},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"keysUp",{get:function(){var t=this.inputs.attached.keyboard;return t?t.keysUp:[]},set:function(t){var r=this.inputs.attached.keyboard;r&&(r.keysUp=t)},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"keysDown",{get:function(){var t=this.inputs.attached.keyboard;return t?t.keysDown:[]},set:function(t){var r=this.inputs.attached.keyboard;r&&(r.keysDown=t)},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"keysLeft",{get:function(){var t=this.inputs.attached.keyboard;return t?t.keysLeft:[]},set:function(t){var r=this.inputs.attached.keyboard;r&&(r.keysLeft=t)},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"keysRight",{get:function(){var t=this.inputs.attached.keyboard;return t?t.keysRight:[]},set:function(t){var r=this.inputs.attached.keyboard;r&&(r.keysRight=t)},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"wheelPrecision",{get:function(){var t=this.inputs.attached.mousewheel;return t?t.wheelPrecision:0},set:function(t){var r=this.inputs.attached.mousewheel;r&&(r.wheelPrecision=t)},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"zoomToMouseLocation",{get:function(){var t=this.inputs.attached.mousewheel;return t?t.zoomToMouseLocation:!1},set:function(t){var r=this.inputs.attached.mousewheel;r&&(r.zoomToMouseLocation=t)},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"wheelDeltaPercentage",{get:function(){var t=this.inputs.attached.mousewheel;return t?t.wheelDeltaPercentage:0},set:function(t){var r=this.inputs.attached.mousewheel;r&&(r.wheelDeltaPercentage=t)},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"bouncingBehavior",{get:function(){return this._bouncingBehavior},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"useBouncingBehavior",{get:function(){return this._bouncingBehavior!=null},set:function(t){t!==this.useBouncingBehavior&&(t?(this._bouncingBehavior=new cu,this.addBehavior(this._bouncingBehavior)):this._bouncingBehavior&&(this.removeBehavior(this._bouncingBehavior),this._bouncingBehavior=null))},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"framingBehavior",{get:function(){return this._framingBehavior},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"useFramingBehavior",{get:function(){return this._framingBehavior!=null},set:function(t){t!==this.useFramingBehavior&&(t?(this._framingBehavior=new du,this.addBehavior(this._framingBehavior)):this._framingBehavior&&(this.removeBehavior(this._framingBehavior),this._framingBehavior=null))},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"autoRotationBehavior",{get:function(){return this._autoRotationBehavior},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"useAutoRotationBehavior",{get:function(){return this._autoRotationBehavior!=null},set:function(t){t!==this.useAutoRotationBehavior&&(t?(this._autoRotationBehavior=new uu,this.addBehavior(this._autoRotationBehavior)):this._autoRotationBehavior&&(this.removeBehavior(this._autoRotationBehavior),this._autoRotationBehavior=null))},enumerable:!1,configurable:!0}),e.prototype._initCache=function(){i.prototype._initCache.call(this),this._cache._target=new m(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),this._cache.alpha=void 0,this._cache.beta=void 0,this._cache.radius=void 0,this._cache.targetScreenOffset=se.Zero()},e.prototype._updateCache=function(t){t||i.prototype._updateCache.call(this),this._cache._target.copyFrom(this._getTargetPosition()),this._cache.alpha=this.alpha,this._cache.beta=this.beta,this._cache.radius=this.radius,this._cache.targetScreenOffset.copyFrom(this.targetScreenOffset)},e.prototype._getTargetPosition=function(){if(this._targetHost&&this._targetHost.getAbsolutePosition){var t=this._targetHost.getAbsolutePosition();this._targetBoundingCenter?t.addToRef(this._targetBoundingCenter,this._target):this._target.copyFrom(t)}var r=this._getLockedTargetPosition();return r||this._target},e.prototype.storeState=function(){return this._storedAlpha=this.alpha,this._storedBeta=this.beta,this._storedRadius=this.radius,this._storedTarget=this._getTargetPosition().clone(),this._storedTargetScreenOffset=this.targetScreenOffset.clone(),i.prototype.storeState.call(this)},e.prototype._restoreStateValues=function(){return i.prototype._restoreStateValues.call(this)?(this.setTarget(this._storedTarget.clone()),this.alpha=this._storedAlpha,this.beta=this._storedBeta,this.radius=this._storedRadius,this.targetScreenOffset=this._storedTargetScreenOffset.clone(),this.inertialAlphaOffset=0,this.inertialBetaOffset=0,this.inertialRadiusOffset=0,this.inertialPanningX=0,this.inertialPanningY=0,!0):!1},e.prototype._isSynchronizedViewMatrix=function(){return i.prototype._isSynchronizedViewMatrix.call(this)?this._cache._target.equals(this._getTargetPosition())&&this._cache.alpha===this.alpha&&this._cache.beta===this.beta&&this._cache.radius===this.radius&&this._cache.targetScreenOffset.equals(this.targetScreenOffset):!1},e.prototype.attachControl=function(t,r,n,a){var s=this;n===void 0&&(n=!0),a===void 0&&(a=2);var o=arguments;r=te.BackCompatCameraNoPreventDefault(o),this._useCtrlForPanning=n,this._panningMouseButton=a,typeof o[0]=="boolean"&&(o.length>1&&(this._useCtrlForPanning=o[1]),o.length>2&&(this._panningMouseButton=o[2])),this.inputs.attachElement(r),this._reset=function(){s.inertialAlphaOffset=0,s.inertialBetaOffset=0,s.inertialRadiusOffset=0,s.inertialPanningX=0,s.inertialPanningY=0}},e.prototype.detachControl=function(){this.inputs.detachElement(),this._reset&&this._reset()},e.prototype._checkInputs=function(){if(!this._collisionTriggered){if(this.inputs.checkInputs(),this.inertialAlphaOffset!==0||this.inertialBetaOffset!==0||this.inertialRadiusOffset!==0){var t=this.inertialAlphaOffset;this.beta<=0&&(t*=-1),this.getScene().useRightHandedSystem&&(t*=-1),this.parent&&this.parent._getWorldMatrixDeterminant()<0&&(t*=-1),this.alpha+=t,this.beta+=this.inertialBetaOffset,this.radius-=this.inertialRadiusOffset,this.inertialAlphaOffset*=this.inertia,this.inertialBetaOffset*=this.inertia,this.inertialRadiusOffset*=this.inertia,Math.abs(this.inertialAlphaOffset)<Me&&(this.inertialAlphaOffset=0),Math.abs(this.inertialBetaOffset)<Me&&(this.inertialBetaOffset=0),Math.abs(this.inertialRadiusOffset)<this.speed*Me&&(this.inertialRadiusOffset=0)}if(this.inertialPanningX!==0||this.inertialPanningY!==0){var r=new m(this.inertialPanningX,this.inertialPanningY,this.inertialPanningY);if(this._viewMatrix.invertToRef(this._cameraTransformMatrix),r.multiplyInPlace(this.panningAxis),m.TransformNormalToRef(r,this._cameraTransformMatrix,this._transformedDirection),(this.mapPanning||!this.panningAxis.y)&&(this._transformedDirection.y=0),!this._targetHost)if(this.panningDistanceLimit){this._transformedDirection.addInPlace(this._target);var n=m.DistanceSquared(this._transformedDirection,this.panningOriginTarget);n<=this.panningDistanceLimit*this.panningDistanceLimit&&this._target.copyFrom(this._transformedDirection)}else this._target.addInPlace(this._transformedDirection);this.inertialPanningX*=this.panningInertia,this.inertialPanningY*=this.panningInertia,Math.abs(this.inertialPanningX)<this.speed*Me&&(this.inertialPanningX=0),Math.abs(this.inertialPanningY)<this.speed*Me&&(this.inertialPanningY=0)}this._checkLimits(),i.prototype._checkInputs.call(this)}},e.prototype._checkLimits=function(){this.lowerBetaLimit===null||this.lowerBetaLimit===void 0?this.allowUpsideDown&&this.beta>Math.PI&&(this.beta=this.beta-2*Math.PI):this.beta<this.lowerBetaLimit&&(this.beta=this.lowerBetaLimit),this.upperBetaLimit===null||this.upperBetaLimit===void 0?this.allowUpsideDown&&this.beta<-Math.PI&&(this.beta=this.beta+2*Math.PI):this.beta>this.upperBetaLimit&&(this.beta=this.upperBetaLimit),this.lowerAlphaLimit!==null&&this.alpha<this.lowerAlphaLimit&&(this.alpha=this.lowerAlphaLimit),this.upperAlphaLimit!==null&&this.alpha>this.upperAlphaLimit&&(this.alpha=this.upperAlphaLimit),this.lowerRadiusLimit!==null&&this.radius<this.lowerRadiusLimit&&(this.radius=this.lowerRadiusLimit,this.inertialRadiusOffset=0),this.upperRadiusLimit!==null&&this.radius>this.upperRadiusLimit&&(this.radius=this.upperRadiusLimit,this.inertialRadiusOffset=0)},e.prototype.rebuildAnglesAndRadius=function(){this._position.subtractToRef(this._getTargetPosition(),this._computationVector),(this._upVector.x!==0||this._upVector.y!==1||this._upVector.z!==0)&&m.TransformCoordinatesToRef(this._computationVector,this._upToYMatrix,this._computationVector),this.radius=this._computationVector.length(),this.radius===0&&(this.radius=1e-4);var t=this.alpha;this._computationVector.x===0&&this._computationVector.z===0?this.alpha=Math.PI/2:this.alpha=Math.acos(this._computationVector.x/Math.sqrt(Math.pow(this._computationVector.x,2)+Math.pow(this._computationVector.z,2))),this._computationVector.z<0&&(this.alpha=2*Math.PI-this.alpha);var r=Math.round((t-this.alpha)/(2*Math.PI));this.alpha+=r*2*Math.PI,this.beta=Math.acos(this._computationVector.y/this.radius),this._checkLimits()},e.prototype.setPosition=function(t){this._position.equals(t)||(this._position.copyFrom(t),this.rebuildAnglesAndRadius())},e.prototype.setTarget=function(t,r,n,a){if(r===void 0&&(r=!1),n===void 0&&(n=!1),a===void 0&&(a=!1),t.getBoundingInfo)r?this._targetBoundingCenter=t.getBoundingInfo().boundingBox.centerWorld.clone():this._targetBoundingCenter=null,t.computeWorldMatrix(),this._targetHost=t,this._target=this._getTargetPosition(),this.onMeshTargetChangedObservable.notifyObservers(this._targetHost);else{var s=t,o=this._getTargetPosition();if(o&&!n&&o.equals(s))return;this._targetHost=null,this._target=s,this._targetBoundingCenter=null,this.onMeshTargetChangedObservable.notifyObservers(null)}a||this.rebuildAnglesAndRadius()},e.prototype._getViewMatrix=function(){var t=Math.cos(this.alpha),r=Math.sin(this.alpha),n=Math.cos(this.beta),a=Math.sin(this.beta);a===0&&(a=1e-4),this.radius===0&&(this.radius=1e-4);var s=this._getTargetPosition();if(this._computationVector.copyFromFloats(this.radius*t*a,this.radius*n,this.radius*r*a),(this._upVector.x!==0||this._upVector.y!==1||this._upVector.z!==0)&&m.TransformCoordinatesToRef(this._computationVector,this._yToUpMatrix,this._computationVector),s.addToRef(this._computationVector,this._newPosition),this.getScene().collisionsEnabled&&this.checkCollisions){var o=this.getScene().collisionCoordinator;this._collider||(this._collider=o.createCollider()),this._collider._radius=this.collisionRadius,this._newPosition.subtractToRef(this._position,this._collisionVelocity),this._collisionTriggered=!0,o.getNewPosition(this._position,this._collisionVelocity,this._collider,3,null,this._onCollisionPositionChange,this.uniqueId)}else{this._position.copyFrom(this._newPosition);var l=this.upVector;this.allowUpsideDown&&a<0&&(l=l.negate()),this._computeViewMatrix(this._position,s,l),this._viewMatrix.addAtIndex(12,this.targetScreenOffset.x),this._viewMatrix.addAtIndex(13,this.targetScreenOffset.y)}return this._currentTarget=s,this._viewMatrix},e.prototype.zoomOn=function(t,r){r===void 0&&(r=!1),t=t||this.getScene().meshes;var n=O.MinMax(t),a=m.Distance(n.min,n.max);this.radius=a*this.zoomOnFactor,this.focusOn({min:n.min,max:n.max,distance:a},r)},e.prototype.focusOn=function(t,r){r===void 0&&(r=!1);var n,a;if(t.min===void 0){var s=t||this.getScene().meshes;n=O.MinMax(s),a=m.Distance(n.min,n.max)}else{var o=t;n=o,a=o.distance}this._target=O.Center(n),r||(this.maxZ=a*2)},e.prototype.createRigCamera=function(t,r){var n=0;switch(this.cameraRigMode){case Ne.RIG_MODE_STEREOSCOPIC_ANAGLYPH:case Ne.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_PARALLEL:case Ne.RIG_MODE_STEREOSCOPIC_OVERUNDER:case Ne.RIG_MODE_STEREOSCOPIC_INTERLACED:case Ne.RIG_MODE_VR:n=this._cameraRigParams.stereoHalfAngle*(r===0?1:-1);break;case Ne.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_CROSSEYED:n=this._cameraRigParams.stereoHalfAngle*(r===0?-1:1);break}var a=new e(t,this.alpha+n,this.beta,this.radius,this._target,this.getScene());return a._cameraRigParams={},a.isRigCamera=!0,a.rigParent=this,a.upVector=this.upVector,a},e.prototype._updateRigCameras=function(){var t=this._rigCameras[0],r=this._rigCameras[1];switch(t.beta=r.beta=this.beta,this.cameraRigMode){case Ne.RIG_MODE_STEREOSCOPIC_ANAGLYPH:case Ne.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_PARALLEL:case Ne.RIG_MODE_STEREOSCOPIC_OVERUNDER:case Ne.RIG_MODE_STEREOSCOPIC_INTERLACED:case Ne.RIG_MODE_VR:t.alpha=this.alpha-this._cameraRigParams.stereoHalfAngle,r.alpha=this.alpha+this._cameraRigParams.stereoHalfAngle;break;case Ne.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_CROSSEYED:t.alpha=this.alpha+this._cameraRigParams.stereoHalfAngle,r.alpha=this.alpha-this._cameraRigParams.stereoHalfAngle;break}i.prototype._updateRigCameras.call(this)},e.prototype.dispose=function(){this.inputs.clear(),i.prototype.dispose.call(this)},e.prototype.getClassName=function(){return"ArcRotateCamera"},C([I()],e.prototype,"alpha",void 0),C([I()],e.prototype,"beta",void 0),C([I()],e.prototype,"radius",void 0),C([xt("target")],e.prototype,"_target",void 0),C([Ma("targetHost")],e.prototype,"_targetHost",void 0),C([I()],e.prototype,"inertialAlphaOffset",void 0),C([I()],e.prototype,"inertialBetaOffset",void 0),C([I()],e.prototype,"inertialRadiusOffset",void 0),C([I()],e.prototype,"lowerAlphaLimit",void 0),C([I()],e.prototype,"upperAlphaLimit",void 0),C([I()],e.prototype,"lowerBetaLimit",void 0),C([I()],e.prototype,"upperBetaLimit",void 0),C([I()],e.prototype,"lowerRadiusLimit",void 0),C([I()],e.prototype,"upperRadiusLimit",void 0),C([I()],e.prototype,"inertialPanningX",void 0),C([I()],e.prototype,"inertialPanningY",void 0),C([I()],e.prototype,"pinchToPanMaxDistance",void 0),C([I()],e.prototype,"panningDistanceLimit",void 0),C([xt()],e.prototype,"panningOriginTarget",void 0),C([I()],e.prototype,"panningInertia",void 0),C([I()],e.prototype,"zoomToMouseLocation",null),C([I()],e.prototype,"zoomOnFactor",void 0),C([Pa()],e.prototype,"targetScreenOffset",void 0),C([I()],e.prototype,"allowUpsideDown",void 0),C([I()],e.prototype,"useInputToRestoreState",void 0),e}(pu),mi=function(){function i(){this.previousWorldMatrices={},this.previousBones={}}return i.AddUniforms=function(e){e.push("previousWorld","previousViewProjection","mPreviousBones")},i.AddSamplers=function(e){},i.prototype.bindForSubMesh=function(e,t,r,n,a){if(t.prePassRenderer&&t.prePassRenderer.enabled&&t.prePassRenderer.currentRTisSceneRT&&t.prePassRenderer.getIndex(2)!==-1){this.previousWorldMatrices[r.uniqueId]||(this.previousWorldMatrices[r.uniqueId]=n.clone()),this.previousViewProjection||(this.previousViewProjection=t.getTransformMatrix().clone(),this.currentViewProjection=t.getTransformMatrix().clone());var s=t.getEngine();this.currentViewProjection.updateFlag!==t.getTransformMatrix().updateFlag?(this._lastUpdateFrameId=s.frameId,this.previousViewProjection.copyFrom(this.currentViewProjection),this.currentViewProjection.copyFrom(t.getTransformMatrix())):this._lastUpdateFrameId!==s.frameId&&(this._lastUpdateFrameId=s.frameId,this.previousViewProjection.copyFrom(this.currentViewProjection)),e.setMatrix("previousWorld",this.previousWorldMatrices[r.uniqueId]),e.setMatrix("previousViewProjection",this.previousViewProjection),this.previousWorldMatrices[r.uniqueId]=n.clone()}},i}(),Oe=function(){function i(){}return Object.defineProperty(i,"DiffuseTextureEnabled",{get:function(){return this._DiffuseTextureEnabled},set:function(e){this._DiffuseTextureEnabled!==e&&(this._DiffuseTextureEnabled=e,De.MarkAllMaterialsAsDirty(1))},enumerable:!1,configurable:!0}),Object.defineProperty(i,"DetailTextureEnabled",{get:function(){return this._DetailTextureEnabled},set:function(e){this._DetailTextureEnabled!==e&&(this._DetailTextureEnabled=e,De.MarkAllMaterialsAsDirty(1))},enumerable:!1,configurable:!0}),Object.defineProperty(i,"AmbientTextureEnabled",{get:function(){return this._AmbientTextureEnabled},set:function(e){this._AmbientTextureEnabled!==e&&(this._AmbientTextureEnabled=e,De.MarkAllMaterialsAsDirty(1))},enumerable:!1,configurable:!0}),Object.defineProperty(i,"OpacityTextureEnabled",{get:function(){return this._OpacityTextureEnabled},set:function(e){this._OpacityTextureEnabled!==e&&(this._OpacityTextureEnabled=e,De.MarkAllMaterialsAsDirty(1))},enumerable:!1,configurable:!0}),Object.defineProperty(i,"ReflectionTextureEnabled",{get:function(){return this._ReflectionTextureEnabled},set:function(e){this._ReflectionTextureEnabled!==e&&(this._ReflectionTextureEnabled=e,De.MarkAllMaterialsAsDirty(1))},enumerable:!1,configurable:!0}),Object.defineProperty(i,"EmissiveTextureEnabled",{get:function(){return this._EmissiveTextureEnabled},set:function(e){this._EmissiveTextureEnabled!==e&&(this._EmissiveTextureEnabled=e,De.MarkAllMaterialsAsDirty(1))},enumerable:!1,configurable:!0}),Object.defineProperty(i,"SpecularTextureEnabled",{get:function(){return this._SpecularTextureEnabled},set:function(e){this._SpecularTextureEnabled!==e&&(this._SpecularTextureEnabled=e,De.MarkAllMaterialsAsDirty(1))},enumerable:!1,configurable:!0}),Object.defineProperty(i,"BumpTextureEnabled",{get:function(){return this._BumpTextureEnabled},set:function(e){this._BumpTextureEnabled!==e&&(this._BumpTextureEnabled=e,De.MarkAllMaterialsAsDirty(1))},enumerable:!1,configurable:!0}),Object.defineProperty(i,"LightmapTextureEnabled",{get:function(){return this._LightmapTextureEnabled},set:function(e){this._LightmapTextureEnabled!==e&&(this._LightmapTextureEnabled=e,De.MarkAllMaterialsAsDirty(1))},enumerable:!1,configurable:!0}),Object.defineProperty(i,"RefractionTextureEnabled",{get:function(){return this._RefractionTextureEnabled},set:function(e){this._RefractionTextureEnabled!==e&&(this._RefractionTextureEnabled=e,De.MarkAllMaterialsAsDirty(1))},enumerable:!1,configurable:!0}),Object.defineProperty(i,"ColorGradingTextureEnabled",{get:function(){return this._ColorGradingTextureEnabled},set:function(e){this._ColorGradingTextureEnabled!==e&&(this._ColorGradingTextureEnabled=e,De.MarkAllMaterialsAsDirty(1))},enumerable:!1,configurable:!0}),Object.defineProperty(i,"FresnelEnabled",{get:function(){return this._FresnelEnabled},set:function(e){this._FresnelEnabled!==e&&(this._FresnelEnabled=e,De.MarkAllMaterialsAsDirty(4))},enumerable:!1,configurable:!0}),Object.defineProperty(i,"ClearCoatTextureEnabled",{get:function(){return this._ClearCoatTextureEnabled},set:function(e){this._ClearCoatTextureEnabled!==e&&(this._ClearCoatTextureEnabled=e,De.MarkAllMaterialsAsDirty(1))},enumerable:!1,configurable:!0}),Object.defineProperty(i,"ClearCoatBumpTextureEnabled",{get:function(){return this._ClearCoatBumpTextureEnabled},set:function(e){this._ClearCoatBumpTextureEnabled!==e&&(this._ClearCoatBumpTextureEnabled=e,De.MarkAllMaterialsAsDirty(1))},enumerable:!1,configurable:!0}),Object.defineProperty(i,"ClearCoatTintTextureEnabled",{get:function(){return this._ClearCoatTintTextureEnabled},set:function(e){this._ClearCoatTintTextureEnabled!==e&&(this._ClearCoatTintTextureEnabled=e,De.MarkAllMaterialsAsDirty(1))},enumerable:!1,configurable:!0}),Object.defineProperty(i,"SheenTextureEnabled",{get:function(){return this._SheenTextureEnabled},set:function(e){this._SheenTextureEnabled!==e&&(this._SheenTextureEnabled=e,De.MarkAllMaterialsAsDirty(1))},enumerable:!1,configurable:!0}),Object.defineProperty(i,"AnisotropicTextureEnabled",{get:function(){return this._AnisotropicTextureEnabled},set:function(e){this._AnisotropicTextureEnabled!==e&&(this._AnisotropicTextureEnabled=e,De.MarkAllMaterialsAsDirty(1))},enumerable:!1,configurable:!0}),Object.defineProperty(i,"ThicknessTextureEnabled",{get:function(){return this._ThicknessTextureEnabled},set:function(e){this._ThicknessTextureEnabled!==e&&(this._ThicknessTextureEnabled=e,De.MarkAllMaterialsAsDirty(1))},enumerable:!1,configurable:!0}),Object.defineProperty(i,"RefractionIntensityTextureEnabled",{get:function(){return this._ThicknessTextureEnabled},set:function(e){this._RefractionIntensityTextureEnabled!==e&&(this._RefractionIntensityTextureEnabled=e,De.MarkAllMaterialsAsDirty(1))},enumerable:!1,configurable:!0}),Object.defineProperty(i,"TranslucencyIntensityTextureEnabled",{get:function(){return this._ThicknessTextureEnabled},set:function(e){this._TranslucencyIntensityTextureEnabled!==e&&(this._TranslucencyIntensityTextureEnabled=e,De.MarkAllMaterialsAsDirty(1))},enumerable:!1,configurable:!0}),i._DiffuseTextureEnabled=!0,i._DetailTextureEnabled=!0,i._AmbientTextureEnabled=!0,i._OpacityTextureEnabled=!0,i._ReflectionTextureEnabled=!0,i._EmissiveTextureEnabled=!0,i._SpecularTextureEnabled=!0,i._BumpTextureEnabled=!0,i._LightmapTextureEnabled=!0,i._RefractionTextureEnabled=!0,i._ColorGradingTextureEnabled=!0,i._FresnelEnabled=!0,i._ClearCoatTextureEnabled=!0,i._ClearCoatBumpTextureEnabled=!0,i._ClearCoatTintTextureEnabled=!0,i._SheenTextureEnabled=!0,i._AnisotropicTextureEnabled=!0,i._ThicknessTextureEnabled=!0,i._RefractionIntensityTextureEnabled=!0,i._TranslucencyIntensityTextureEnabled=!0,i}(),yu="defaultFragmentDeclaration",bu=`uniform vec4 vEyePosition;
uniform vec4 vDiffuseColor;
#ifdef SPECULARTERM
uniform vec4 vSpecularColor;
#endif
uniform vec3 vEmissiveColor;
uniform vec3 vAmbientColor;
uniform float visibility;
#ifdef DIFFUSE
uniform vec2 vDiffuseInfos;
#endif
#ifdef AMBIENT
uniform vec2 vAmbientInfos;
#endif
#ifdef OPACITY 
uniform vec2 vOpacityInfos;
#endif
#ifdef EMISSIVE
uniform vec2 vEmissiveInfos;
#endif
#ifdef LIGHTMAP
uniform vec2 vLightmapInfos;
#endif
#ifdef BUMP
uniform vec3 vBumpInfos;
uniform vec2 vTangentSpaceParams;
#endif
#ifdef ALPHATEST
uniform float alphaCutOff;
#endif
#if defined(REFLECTIONMAP_SPHERICAL) || defined(REFLECTIONMAP_PROJECTION) || defined(REFRACTION)
uniform mat4 view;
#endif
#ifdef REFRACTION
uniform vec4 vRefractionInfos;
#ifndef REFRACTIONMAP_3D
uniform mat4 refractionMatrix;
#endif
#ifdef REFRACTIONFRESNEL
uniform vec4 refractionLeftColor;
uniform vec4 refractionRightColor;
#endif
#if defined(USE_LOCAL_REFRACTIONMAP_CUBIC) && defined(REFRACTIONMAP_3D)
uniform vec3 vRefractionPosition;
uniform vec3 vRefractionSize; 
#endif
#endif
#if defined(SPECULAR) && defined(SPECULARTERM)
uniform vec2 vSpecularInfos;
#endif
#ifdef DIFFUSEFRESNEL
uniform vec4 diffuseLeftColor;
uniform vec4 diffuseRightColor;
#endif
#ifdef OPACITYFRESNEL
uniform vec4 opacityParts;
#endif
#ifdef EMISSIVEFRESNEL
uniform vec4 emissiveLeftColor;
uniform vec4 emissiveRightColor;
#endif
#ifdef REFLECTION
uniform vec2 vReflectionInfos;
#if defined(REFLECTIONMAP_PLANAR) || defined(REFLECTIONMAP_CUBIC) || defined(REFLECTIONMAP_PROJECTION) || defined(REFLECTIONMAP_EQUIRECTANGULAR) || defined(REFLECTIONMAP_SPHERICAL) || defined(REFLECTIONMAP_SKYBOX)
uniform mat4 reflectionMatrix;
#endif
#ifndef REFLECTIONMAP_SKYBOX
#if defined(USE_LOCAL_REFLECTIONMAP_CUBIC) && defined(REFLECTIONMAP_CUBIC)
uniform vec3 vReflectionPosition;
uniform vec3 vReflectionSize; 
#endif
#endif
#ifdef REFLECTIONFRESNEL
uniform vec4 reflectionLeftColor;
uniform vec4 reflectionRightColor;
#endif
#endif
#ifdef DETAIL
uniform vec4 vDetailInfos;
#endif
#define ADDITIONAL_FRAGMENT_DECLARATION
`;q.IncludesShadersStore[yu]=bu;var Tu="sceneUboDeclaration",Eu=`layout(std140,column_major) uniform;
uniform Scene {
mat4 viewProjection;
#ifdef MULTIVIEW
mat4 viewProjectionR;
#endif 
mat4 view;
mat4 projection;
vec4 vEyePosition;
};
`;q.IncludesShadersStore[Tu]=Eu;var Au="meshUboDeclaration",Su=`#ifdef WEBGL2
uniform mat4 world;
uniform float visibility;
#else
layout(std140,column_major) uniform;
uniform Mesh
{
mat4 world;
float visibility;
};
#endif
#define WORLD_UBO
`;q.IncludesShadersStore[Au]=Su;var Ru="defaultUboDeclaration",Pu=`layout(std140,column_major) uniform;
uniform Material
{
vec4 diffuseLeftColor;
vec4 diffuseRightColor;
vec4 opacityParts;
vec4 reflectionLeftColor;
vec4 reflectionRightColor;
vec4 refractionLeftColor;
vec4 refractionRightColor;
vec4 emissiveLeftColor;
vec4 emissiveRightColor;
vec2 vDiffuseInfos;
vec2 vAmbientInfos;
vec2 vOpacityInfos;
vec2 vReflectionInfos;
vec3 vReflectionPosition;
vec3 vReflectionSize;
vec2 vEmissiveInfos;
vec2 vLightmapInfos;
vec2 vSpecularInfos;
vec3 vBumpInfos;
mat4 diffuseMatrix;
mat4 ambientMatrix;
mat4 opacityMatrix;
mat4 reflectionMatrix;
mat4 emissiveMatrix;
mat4 lightmapMatrix;
mat4 specularMatrix;
mat4 bumpMatrix;
vec2 vTangentSpaceParams;
float pointSize;
float alphaCutOff;
mat4 refractionMatrix;
vec4 vRefractionInfos;
vec3 vRefractionPosition;
vec3 vRefractionSize;
vec4 vSpecularColor;
vec3 vEmissiveColor;
vec4 vDiffuseColor;
vec3 vAmbientColor;
#define ADDITIONAL_UBO_DECLARATION
};
#include<sceneUboDeclaration>
#include<meshUboDeclaration>
`;q.IncludesShadersStore[Ru]=Pu;var Mu="prePassDeclaration",Cu=`#ifdef PREPASS
#extension GL_EXT_draw_buffers : require
layout(location=0) out highp vec4 glFragData[{X}];highp vec4 gl_FragColor;
#ifdef PREPASS_DEPTH
varying highp vec3 vViewPos;
#endif
#ifdef PREPASS_VELOCITY
varying highp vec4 vCurrentPosition;varying highp vec4 vPreviousPosition;
#endif
#endif
`;q.IncludesShadersStore[Mu]=Cu;var xu="oitDeclaration",Du=`#ifdef ORDER_INDEPENDENT_TRANSPARENCY
#extension GL_EXT_draw_buffers : require
layout(location=0) out vec2 depth; 
layout(location=1) out vec4 frontColor;
layout(location=2) out vec4 backColor;
#define MAX_DEPTH 99999.0
highp vec4 gl_FragColor;
uniform sampler2D oitDepthSampler;
uniform sampler2D oitFrontColorSampler;
#endif
`;q.IncludesShadersStore[xu]=Du;var Ou="mainUVVaryingDeclaration",Iu=`#ifdef MAINUV{X}
varying vec2 vMainUV{X};
#endif
`;q.IncludesShadersStore[Ou]=Iu;var Fu="helperFunctions",wu=`const float PI=3.1415926535897932384626433832795;
const float HALF_MIN=5.96046448e-08; 
const float LinearEncodePowerApprox=2.2;
const float GammaEncodePowerApprox=1.0/LinearEncodePowerApprox;
const vec3 LuminanceEncodeApprox=vec3(0.2126,0.7152,0.0722);
const float Epsilon=0.0000001;
#define saturate(x) clamp(x,0.0,1.0)
#define absEps(x) abs(x)+Epsilon
#define maxEps(x) max(x,Epsilon)
#define saturateEps(x) clamp(x,Epsilon,1.0)
mat3 transposeMat3(mat3 inMatrix) {
vec3 i0=inMatrix[0];
vec3 i1=inMatrix[1];
vec3 i2=inMatrix[2];
mat3 outMatrix=mat3(
vec3(i0.x,i1.x,i2.x),
vec3(i0.y,i1.y,i2.y),
vec3(i0.z,i1.z,i2.z)
);
return outMatrix;
}
mat3 inverseMat3(mat3 inMatrix) {
float a00=inMatrix[0][0],a01=inMatrix[0][1],a02=inMatrix[0][2];
float a10=inMatrix[1][0],a11=inMatrix[1][1],a12=inMatrix[1][2];
float a20=inMatrix[2][0],a21=inMatrix[2][1],a22=inMatrix[2][2];
float b01=a22*a11-a12*a21;
float b11=-a22*a10+a12*a20;
float b21=a21*a10-a11*a20;
float det=a00*b01+a01*b11+a02*b21;
return mat3(b01,(-a22*a01+a02*a21),(a12*a01-a02*a11),
b11,(a22*a00-a02*a20),(-a12*a00+a02*a10),
b21,(-a21*a00+a01*a20),(a11*a00-a01*a10))/det;
}
float toLinearSpace(float color)
{
return pow(color,LinearEncodePowerApprox);
}
vec3 toLinearSpace(vec3 color)
{
return pow(color,vec3(LinearEncodePowerApprox));
}
vec4 toLinearSpace(vec4 color)
{
return vec4(pow(color.rgb,vec3(LinearEncodePowerApprox)),color.a);
}
vec3 toGammaSpace(vec3 color)
{
return pow(color,vec3(GammaEncodePowerApprox));
}
vec4 toGammaSpace(vec4 color)
{
return vec4(pow(color.rgb,vec3(GammaEncodePowerApprox)),color.a);
}
float toGammaSpace(float color)
{
return pow(color,GammaEncodePowerApprox);
}
float square(float value)
{
return value*value;
}
float pow5(float value) {
float sq=value*value;
return sq*sq*value;
}
float getLuminance(vec3 color)
{
return clamp(dot(color,LuminanceEncodeApprox),0.,1.);
}
float getRand(vec2 seed) {
return fract(sin(dot(seed.xy ,vec2(12.9898,78.233)))*43758.5453);
}
float dither(vec2 seed,float varianceAmount) {
float rand=getRand(seed);
float dither=mix(-varianceAmount/255.0,varianceAmount/255.0,rand);
return dither;
}
const float rgbdMaxRange=255.0;
vec4 toRGBD(vec3 color) {
float maxRGB=maxEps(max(color.r,max(color.g,color.b)));
float D =max(rgbdMaxRange/maxRGB,1.);
D =clamp(floor(D)/255.0,0.,1.);
vec3 rgb=color.rgb*D;
rgb=toGammaSpace(rgb);
return vec4(clamp(rgb,0.,1.),D); 
}
vec3 fromRGBD(vec4 rgbd) {
rgbd.rgb=toLinearSpace(rgbd.rgb);
return rgbd.rgb/rgbd.a;
}
vec3 parallaxCorrectNormal( vec3 vertexPos,vec3 origVec,vec3 cubeSize,vec3 cubePos ) {
vec3 invOrigVec=vec3(1.0,1.0,1.0)/origVec;
vec3 halfSize=cubeSize*0.5;
vec3 intersecAtMaxPlane=(cubePos+halfSize-vertexPos)*invOrigVec;
vec3 intersecAtMinPlane=(cubePos-halfSize-vertexPos)*invOrigVec;
vec3 largestIntersec=max(intersecAtMaxPlane,intersecAtMinPlane);
float distance=min(min(largestIntersec.x,largestIntersec.y),largestIntersec.z);
vec3 intersectPositionWS=vertexPos+origVec*distance;
return intersectPositionWS-cubePos;
}
`;q.IncludesShadersStore[Fu]=wu;var Lu="lightFragmentDeclaration",Nu=`#ifdef LIGHT{X}
uniform vec4 vLightData{X};
uniform vec4 vLightDiffuse{X};
#ifdef SPECULARTERM
uniform vec4 vLightSpecular{X};
#else
vec4 vLightSpecular{X}=vec4(0.);
#endif
#ifdef SHADOW{X}
#ifdef SHADOWCSM{X}
uniform mat4 lightMatrix{X}[SHADOWCSMNUM_CASCADES{X}];
uniform float viewFrustumZ{X}[SHADOWCSMNUM_CASCADES{X}];
uniform float frustumLengths{X}[SHADOWCSMNUM_CASCADES{X}];
uniform float cascadeBlendFactor{X};
varying vec4 vPositionFromLight{X}[SHADOWCSMNUM_CASCADES{X}];
varying float vDepthMetric{X}[SHADOWCSMNUM_CASCADES{X}];
varying vec4 vPositionFromCamera{X};
#if defined(SHADOWPCSS{X})
uniform highp sampler2DArrayShadow shadowSampler{X};
uniform highp sampler2DArray depthSampler{X};
uniform vec2 lightSizeUVCorrection{X}[SHADOWCSMNUM_CASCADES{X}];
uniform float depthCorrection{X}[SHADOWCSMNUM_CASCADES{X}];
uniform float penumbraDarkness{X};
#elif defined(SHADOWPCF{X})
uniform highp sampler2DArrayShadow shadowSampler{X};
#else
uniform highp sampler2DArray shadowSampler{X};
#endif
#ifdef SHADOWCSMDEBUG{X}
const vec3 vCascadeColorsMultiplier{X}[8]=vec3[8]
(
vec3 ( 1.5,0.0,0.0 ),
vec3 ( 0.0,1.5,0.0 ),
vec3 ( 0.0,0.0,5.5 ),
vec3 ( 1.5,0.0,5.5 ),
vec3 ( 1.5,1.5,0.0 ),
vec3 ( 1.0,1.0,1.0 ),
vec3 ( 0.0,1.0,5.5 ),
vec3 ( 0.5,3.5,0.75 )
);
vec3 shadowDebug{X};
#endif
#ifdef SHADOWCSMUSESHADOWMAXZ{X}
int index{X}=-1;
#else
int index{X}=SHADOWCSMNUM_CASCADES{X}-1;
#endif
float diff{X}=0.;
#elif defined(SHADOWCUBE{X})
uniform samplerCube shadowSampler{X};
#else
varying vec4 vPositionFromLight{X};
varying float vDepthMetric{X};
#if defined(SHADOWPCSS{X})
uniform highp sampler2DShadow shadowSampler{X};
uniform highp sampler2D depthSampler{X};
#elif defined(SHADOWPCF{X})
uniform highp sampler2DShadow shadowSampler{X};
#else
uniform sampler2D shadowSampler{X};
#endif
uniform mat4 lightMatrix{X};
#endif
uniform vec4 shadowsInfo{X};
uniform vec2 depthValues{X};
#endif
#ifdef SPOTLIGHT{X}
uniform vec4 vLightDirection{X};
uniform vec4 vLightFalloff{X};
#elif defined(POINTLIGHT{X})
uniform vec4 vLightFalloff{X};
#elif defined(HEMILIGHT{X})
uniform vec3 vLightGround{X};
#endif
#ifdef PROJECTEDLIGHTTEXTURE{X}
uniform mat4 textureProjectionMatrix{X};
uniform sampler2D projectionLightSampler{X};
#endif
#endif
`;q.IncludesShadersStore[Lu]=Nu;var Bu="lightUboDeclaration",Uu=`#ifdef LIGHT{X}
uniform Light{X}
{
vec4 vLightData;
vec4 vLightDiffuse;
vec4 vLightSpecular;
#ifdef SPOTLIGHT{X}
vec4 vLightDirection;
vec4 vLightFalloff;
#elif defined(POINTLIGHT{X})
vec4 vLightFalloff;
#elif defined(HEMILIGHT{X})
vec3 vLightGround;
#endif
vec4 shadowsInfo;
vec2 depthValues;
} light{X};
#ifdef PROJECTEDLIGHTTEXTURE{X}
uniform mat4 textureProjectionMatrix{X};
uniform sampler2D projectionLightSampler{X};
#endif
#ifdef SHADOW{X}
#ifdef SHADOWCSM{X}
uniform mat4 lightMatrix{X}[SHADOWCSMNUM_CASCADES{X}];
uniform float viewFrustumZ{X}[SHADOWCSMNUM_CASCADES{X}];
uniform float frustumLengths{X}[SHADOWCSMNUM_CASCADES{X}];
uniform float cascadeBlendFactor{X};
varying vec4 vPositionFromLight{X}[SHADOWCSMNUM_CASCADES{X}];
varying float vDepthMetric{X}[SHADOWCSMNUM_CASCADES{X}];
varying vec4 vPositionFromCamera{X};
#if defined(SHADOWPCSS{X})
uniform highp sampler2DArrayShadow shadowSampler{X};
uniform highp sampler2DArray depthSampler{X};
uniform vec2 lightSizeUVCorrection{X}[SHADOWCSMNUM_CASCADES{X}];
uniform float depthCorrection{X}[SHADOWCSMNUM_CASCADES{X}];
uniform float penumbraDarkness{X};
#elif defined(SHADOWPCF{X})
uniform highp sampler2DArrayShadow shadowSampler{X};
#else
uniform highp sampler2DArray shadowSampler{X};
#endif
#ifdef SHADOWCSMDEBUG{X}
const vec3 vCascadeColorsMultiplier{X}[8]=vec3[8]
(
vec3 ( 1.5,0.0,0.0 ),
vec3 ( 0.0,1.5,0.0 ),
vec3 ( 0.0,0.0,5.5 ),
vec3 ( 1.5,0.0,5.5 ),
vec3 ( 1.5,1.5,0.0 ),
vec3 ( 1.0,1.0,1.0 ),
vec3 ( 0.0,1.0,5.5 ),
vec3 ( 0.5,3.5,0.75 )
);
vec3 shadowDebug{X};
#endif
#ifdef SHADOWCSMUSESHADOWMAXZ{X}
int index{X}=-1;
#else
int index{X}=SHADOWCSMNUM_CASCADES{X}-1;
#endif
float diff{X}=0.;
#elif defined(SHADOWCUBE{X})
uniform samplerCube shadowSampler{X}; 
#else
varying vec4 vPositionFromLight{X};
varying float vDepthMetric{X};
#if defined(SHADOWPCSS{X})
uniform highp sampler2DShadow shadowSampler{X};
uniform highp sampler2D depthSampler{X};
#elif defined(SHADOWPCF{X})
uniform highp sampler2DShadow shadowSampler{X};
#else
uniform sampler2D shadowSampler{X};
#endif
uniform mat4 lightMatrix{X};
#endif
#endif
#endif
`;q.IncludesShadersStore[Bu]=Uu;var Vu="lightsFragmentFunctions",ku=`struct lightingInfo
{
vec3 diffuse;
#ifdef SPECULARTERM
vec3 specular;
#endif
#ifdef NDOTL
float ndl;
#endif
};
lightingInfo computeLighting(vec3 viewDirectionW,vec3 vNormal,vec4 lightData,vec3 diffuseColor,vec3 specularColor,float range,float glossiness) {
lightingInfo result;
vec3 lightVectorW;
float attenuation=1.0;
if (lightData.w==0.)
{
vec3 direction=lightData.xyz-vPositionW;
attenuation=max(0.,1.0-length(direction)/range);
lightVectorW=normalize(direction);
}
else
{
lightVectorW=normalize(-lightData.xyz);
}
float ndl=max(0.,dot(vNormal,lightVectorW));
#ifdef NDOTL
result.ndl=ndl;
#endif
result.diffuse=ndl*diffuseColor*attenuation;
#ifdef SPECULARTERM
vec3 angleW=normalize(viewDirectionW+lightVectorW);
float specComp=max(0.,dot(vNormal,angleW));
specComp=pow(specComp,max(1.,glossiness));
result.specular=specComp*specularColor*attenuation;
#endif
return result;
}
lightingInfo computeSpotLighting(vec3 viewDirectionW,vec3 vNormal,vec4 lightData,vec4 lightDirection,vec3 diffuseColor,vec3 specularColor,float range,float glossiness) {
lightingInfo result;
vec3 direction=lightData.xyz-vPositionW;
vec3 lightVectorW=normalize(direction);
float attenuation=max(0.,1.0-length(direction)/range);
float cosAngle=max(0.,dot(lightDirection.xyz,-lightVectorW));
if (cosAngle>=lightDirection.w)
{
cosAngle=max(0.,pow(cosAngle,lightData.w));
attenuation*=cosAngle;
float ndl=max(0.,dot(vNormal,lightVectorW));
#ifdef NDOTL
result.ndl=ndl;
#endif
result.diffuse=ndl*diffuseColor*attenuation;
#ifdef SPECULARTERM
vec3 angleW=normalize(viewDirectionW+lightVectorW);
float specComp=max(0.,dot(vNormal,angleW));
specComp=pow(specComp,max(1.,glossiness));
result.specular=specComp*specularColor*attenuation;
#endif
return result;
}
result.diffuse=vec3(0.);
#ifdef SPECULARTERM
result.specular=vec3(0.);
#endif
#ifdef NDOTL
result.ndl=0.;
#endif
return result;
}
lightingInfo computeHemisphericLighting(vec3 viewDirectionW,vec3 vNormal,vec4 lightData,vec3 diffuseColor,vec3 specularColor,vec3 groundColor,float glossiness) {
lightingInfo result;
float ndl=dot(vNormal,lightData.xyz)*0.5+0.5;
#ifdef NDOTL
result.ndl=ndl;
#endif
result.diffuse=mix(groundColor,diffuseColor,ndl);
#ifdef SPECULARTERM
vec3 angleW=normalize(viewDirectionW+lightData.xyz);
float specComp=max(0.,dot(vNormal,angleW));
specComp=pow(specComp,max(1.,glossiness));
result.specular=specComp*specularColor;
#endif
return result;
}
#define inline
vec3 computeProjectionTextureDiffuseLighting(sampler2D projectionLightSampler,mat4 textureProjectionMatrix){
vec4 strq=textureProjectionMatrix*vec4(vPositionW,1.0);
strq/=strq.w;
vec3 textureColor=texture2D(projectionLightSampler,strq.xy).rgb;
return textureColor;
}`;q.IncludesShadersStore[Vu]=ku;var Gu="shadowsFragmentFunctions",zu=`#ifdef SHADOWS
#ifndef SHADOWFLOAT
float unpack(vec4 color)
{
const vec4 bit_shift=vec4(1.0/(255.0*255.0*255.0),1.0/(255.0*255.0),1.0/255.0,1.0);
return dot(color,bit_shift);
}
#endif
float computeFallOff(float value,vec2 clipSpace,float frustumEdgeFalloff)
{
float mask=smoothstep(1.0-frustumEdgeFalloff,1.00000012,clamp(dot(clipSpace,clipSpace),0.,1.));
return mix(value,1.0,mask);
}
#define inline
float computeShadowCube(vec3 lightPosition,samplerCube shadowSampler,float darkness,vec2 depthValues)
{
vec3 directionToLight=vPositionW-lightPosition;
float depth=length(directionToLight);
depth=(depth+depthValues.x)/(depthValues.y);
depth=clamp(depth,0.,1.0);
directionToLight=normalize(directionToLight);
directionToLight.y=-directionToLight.y;
#ifndef SHADOWFLOAT
float shadow=unpack(textureCube(shadowSampler,directionToLight));
#else
float shadow=textureCube(shadowSampler,directionToLight).x;
#endif
return depth>shadow ? darkness : 1.0;
}
#define inline
float computeShadowWithPoissonSamplingCube(vec3 lightPosition,samplerCube shadowSampler,float mapSize,float darkness,vec2 depthValues)
{
vec3 directionToLight=vPositionW-lightPosition;
float depth=length(directionToLight);
depth=(depth+depthValues.x)/(depthValues.y);
depth=clamp(depth,0.,1.0);
directionToLight=normalize(directionToLight);
directionToLight.y=-directionToLight.y;
float visibility=1.;
vec3 poissonDisk[4];
poissonDisk[0]=vec3(-1.0,1.0,-1.0);
poissonDisk[1]=vec3(1.0,-1.0,-1.0);
poissonDisk[2]=vec3(-1.0,-1.0,-1.0);
poissonDisk[3]=vec3(1.0,-1.0,1.0);
#ifndef SHADOWFLOAT
if (unpack(textureCube(shadowSampler,directionToLight+poissonDisk[0]*mapSize))<depth) visibility-=0.25;
if (unpack(textureCube(shadowSampler,directionToLight+poissonDisk[1]*mapSize))<depth) visibility-=0.25;
if (unpack(textureCube(shadowSampler,directionToLight+poissonDisk[2]*mapSize))<depth) visibility-=0.25;
if (unpack(textureCube(shadowSampler,directionToLight+poissonDisk[3]*mapSize))<depth) visibility-=0.25;
#else
if (textureCube(shadowSampler,directionToLight+poissonDisk[0]*mapSize).x<depth) visibility-=0.25;
if (textureCube(shadowSampler,directionToLight+poissonDisk[1]*mapSize).x<depth) visibility-=0.25;
if (textureCube(shadowSampler,directionToLight+poissonDisk[2]*mapSize).x<depth) visibility-=0.25;
if (textureCube(shadowSampler,directionToLight+poissonDisk[3]*mapSize).x<depth) visibility-=0.25;
#endif
return min(1.0,visibility+darkness);
}
#define inline
float computeShadowWithESMCube(vec3 lightPosition,samplerCube shadowSampler,float darkness,float depthScale,vec2 depthValues)
{
vec3 directionToLight=vPositionW-lightPosition;
float depth=length(directionToLight);
depth=(depth+depthValues.x)/(depthValues.y);
float shadowPixelDepth=clamp(depth,0.,1.0);
directionToLight=normalize(directionToLight);
directionToLight.y=-directionToLight.y;
#ifndef SHADOWFLOAT
float shadowMapSample=unpack(textureCube(shadowSampler,directionToLight));
#else
float shadowMapSample=textureCube(shadowSampler,directionToLight).x;
#endif
float esm=1.0-clamp(exp(min(87.,depthScale*shadowPixelDepth))*shadowMapSample,0.,1.-darkness); 
return esm;
}
#define inline
float computeShadowWithCloseESMCube(vec3 lightPosition,samplerCube shadowSampler,float darkness,float depthScale,vec2 depthValues)
{
vec3 directionToLight=vPositionW-lightPosition;
float depth=length(directionToLight);
depth=(depth+depthValues.x)/(depthValues.y);
float shadowPixelDepth=clamp(depth,0.,1.0);
directionToLight=normalize(directionToLight);
directionToLight.y=-directionToLight.y;
#ifndef SHADOWFLOAT
float shadowMapSample=unpack(textureCube(shadowSampler,directionToLight));
#else
float shadowMapSample=textureCube(shadowSampler,directionToLight).x;
#endif
float esm=clamp(exp(min(87.,-depthScale*(shadowPixelDepth-shadowMapSample))),darkness,1.);
return esm;
}
#if defined(WEBGL2) || defined(WEBGPU)
#define inline
float computeShadowCSM(float layer,vec4 vPositionFromLight,float depthMetric,highp sampler2DArray shadowSampler,float darkness,float frustumEdgeFalloff)
{
vec3 clipSpace=vPositionFromLight.xyz/vPositionFromLight.w;
vec2 uv=0.5*clipSpace.xy+vec2(0.5);
vec3 uvLayer=vec3(uv.x,uv.y,layer);
float shadowPixelDepth=clamp(depthMetric,0.,1.0);
#ifndef SHADOWFLOAT
float shadow=unpack(texture2D(shadowSampler,uvLayer));
#else
float shadow=texture2D(shadowSampler,uvLayer).x;
#endif
return shadowPixelDepth>shadow ? computeFallOff(darkness,clipSpace.xy,frustumEdgeFalloff) : 1.;
}
#endif
#define inline
float computeShadow(vec4 vPositionFromLight,float depthMetric,sampler2D shadowSampler,float darkness,float frustumEdgeFalloff)
{
vec3 clipSpace=vPositionFromLight.xyz/vPositionFromLight.w;
vec2 uv=0.5*clipSpace.xy+vec2(0.5);
if (uv.x<0. || uv.x>1.0 || uv.y<0. || uv.y>1.0)
{
return 1.0;
}
else
{
float shadowPixelDepth=clamp(depthMetric,0.,1.0);
#ifndef SHADOWFLOAT
float shadow=unpack(texture2D(shadowSampler,uv));
#else
float shadow=texture2D(shadowSampler,uv).x;
#endif
return shadowPixelDepth>shadow ? computeFallOff(darkness,clipSpace.xy,frustumEdgeFalloff) : 1.;
}
}
#define inline
float computeShadowWithPoissonSampling(vec4 vPositionFromLight,float depthMetric,sampler2D shadowSampler,float mapSize,float darkness,float frustumEdgeFalloff)
{
vec3 clipSpace=vPositionFromLight.xyz/vPositionFromLight.w;
vec2 uv=0.5*clipSpace.xy+vec2(0.5);
if (uv.x<0. || uv.x>1.0 || uv.y<0. || uv.y>1.0)
{
return 1.0;
}
else
{
float shadowPixelDepth=clamp(depthMetric,0.,1.0);
float visibility=1.;
vec2 poissonDisk[4];
poissonDisk[0]=vec2(-0.94201624,-0.39906216);
poissonDisk[1]=vec2(0.94558609,-0.76890725);
poissonDisk[2]=vec2(-0.094184101,-0.92938870);
poissonDisk[3]=vec2(0.34495938,0.29387760);
#ifndef SHADOWFLOAT
if (unpack(texture2D(shadowSampler,uv+poissonDisk[0]*mapSize))<shadowPixelDepth) visibility-=0.25;
if (unpack(texture2D(shadowSampler,uv+poissonDisk[1]*mapSize))<shadowPixelDepth) visibility-=0.25;
if (unpack(texture2D(shadowSampler,uv+poissonDisk[2]*mapSize))<shadowPixelDepth) visibility-=0.25;
if (unpack(texture2D(shadowSampler,uv+poissonDisk[3]*mapSize))<shadowPixelDepth) visibility-=0.25;
#else
if (texture2D(shadowSampler,uv+poissonDisk[0]*mapSize).x<shadowPixelDepth) visibility-=0.25;
if (texture2D(shadowSampler,uv+poissonDisk[1]*mapSize).x<shadowPixelDepth) visibility-=0.25;
if (texture2D(shadowSampler,uv+poissonDisk[2]*mapSize).x<shadowPixelDepth) visibility-=0.25;
if (texture2D(shadowSampler,uv+poissonDisk[3]*mapSize).x<shadowPixelDepth) visibility-=0.25;
#endif
return computeFallOff(min(1.0,visibility+darkness),clipSpace.xy,frustumEdgeFalloff);
}
}
#define inline
float computeShadowWithESM(vec4 vPositionFromLight,float depthMetric,sampler2D shadowSampler,float darkness,float depthScale,float frustumEdgeFalloff)
{
vec3 clipSpace=vPositionFromLight.xyz/vPositionFromLight.w;
vec2 uv=0.5*clipSpace.xy+vec2(0.5);
if (uv.x<0. || uv.x>1.0 || uv.y<0. || uv.y>1.0)
{
return 1.0;
}
else
{
float shadowPixelDepth=clamp(depthMetric,0.,1.0);
#ifndef SHADOWFLOAT
float shadowMapSample=unpack(texture2D(shadowSampler,uv));
#else
float shadowMapSample=texture2D(shadowSampler,uv).x;
#endif
float esm=1.0-clamp(exp(min(87.,depthScale*shadowPixelDepth))*shadowMapSample,0.,1.-darkness);
return computeFallOff(esm,clipSpace.xy,frustumEdgeFalloff);
}
}
#define inline
float computeShadowWithCloseESM(vec4 vPositionFromLight,float depthMetric,sampler2D shadowSampler,float darkness,float depthScale,float frustumEdgeFalloff)
{
vec3 clipSpace=vPositionFromLight.xyz/vPositionFromLight.w;
vec2 uv=0.5*clipSpace.xy+vec2(0.5);
if (uv.x<0. || uv.x>1.0 || uv.y<0. || uv.y>1.0)
{
return 1.0;
}
else
{
float shadowPixelDepth=clamp(depthMetric,0.,1.0); 
#ifndef SHADOWFLOAT
float shadowMapSample=unpack(texture2D(shadowSampler,uv));
#else
float shadowMapSample=texture2D(shadowSampler,uv).x;
#endif
float esm=clamp(exp(min(87.,-depthScale*(shadowPixelDepth-shadowMapSample))),darkness,1.);
return computeFallOff(esm,clipSpace.xy,frustumEdgeFalloff);
}
}
#ifdef IS_NDC_HALF_ZRANGE
#define ZINCLIP clipSpace.z
#else
#define ZINCLIP uvDepth.z
#endif
#if defined(WEBGL2) || defined(WEBGPU)
#define GREATEST_LESS_THAN_ONE 0.99999994
#define inline
float computeShadowWithCSMPCF1(float layer,vec4 vPositionFromLight,float depthMetric,highp sampler2DArrayShadow shadowSampler,float darkness,float frustumEdgeFalloff)
{
vec3 clipSpace=vPositionFromLight.xyz/vPositionFromLight.w;
vec3 uvDepth=vec3(0.5*clipSpace.xyz+vec3(0.5));
uvDepth.z=clamp(ZINCLIP,0.,GREATEST_LESS_THAN_ONE);
vec4 uvDepthLayer=vec4(uvDepth.x,uvDepth.y,layer,uvDepth.z);
float shadow=texture2D(shadowSampler,uvDepthLayer);
shadow=mix(darkness,1.,shadow);
return computeFallOff(shadow,clipSpace.xy,frustumEdgeFalloff);
}
#define inline
float computeShadowWithCSMPCF3(float layer,vec4 vPositionFromLight,float depthMetric,highp sampler2DArrayShadow shadowSampler,vec2 shadowMapSizeAndInverse,float darkness,float frustumEdgeFalloff)
{
vec3 clipSpace=vPositionFromLight.xyz/vPositionFromLight.w;
vec3 uvDepth=vec3(0.5*clipSpace.xyz+vec3(0.5));
uvDepth.z=clamp(ZINCLIP,0.,GREATEST_LESS_THAN_ONE);
vec2 uv=uvDepth.xy*shadowMapSizeAndInverse.x; 
uv+=0.5; 
vec2 st=fract(uv); 
vec2 base_uv=floor(uv)-0.5; 
base_uv*=shadowMapSizeAndInverse.y; 
vec2 uvw0=3.-2.*st;
vec2 uvw1=1.+2.*st;
vec2 u=vec2((2.-st.x)/uvw0.x-1.,st.x/uvw1.x+1.)*shadowMapSizeAndInverse.y;
vec2 v=vec2((2.-st.y)/uvw0.y-1.,st.y/uvw1.y+1.)*shadowMapSizeAndInverse.y;
float shadow=0.;
shadow+=uvw0.x*uvw0.y*texture2D(shadowSampler,vec4(base_uv.xy+vec2(u[0],v[0]),layer,uvDepth.z));
shadow+=uvw1.x*uvw0.y*texture2D(shadowSampler,vec4(base_uv.xy+vec2(u[1],v[0]),layer,uvDepth.z));
shadow+=uvw0.x*uvw1.y*texture2D(shadowSampler,vec4(base_uv.xy+vec2(u[0],v[1]),layer,uvDepth.z));
shadow+=uvw1.x*uvw1.y*texture2D(shadowSampler,vec4(base_uv.xy+vec2(u[1],v[1]),layer,uvDepth.z));
shadow=shadow/16.;
shadow=mix(darkness,1.,shadow);
return computeFallOff(shadow,clipSpace.xy,frustumEdgeFalloff);
}
#define inline
float computeShadowWithCSMPCF5(float layer,vec4 vPositionFromLight,float depthMetric,highp sampler2DArrayShadow shadowSampler,vec2 shadowMapSizeAndInverse,float darkness,float frustumEdgeFalloff)
{
vec3 clipSpace=vPositionFromLight.xyz/vPositionFromLight.w;
vec3 uvDepth=vec3(0.5*clipSpace.xyz+vec3(0.5));
uvDepth.z=clamp(ZINCLIP,0.,GREATEST_LESS_THAN_ONE);
vec2 uv=uvDepth.xy*shadowMapSizeAndInverse.x; 
uv+=0.5; 
vec2 st=fract(uv); 
vec2 base_uv=floor(uv)-0.5; 
base_uv*=shadowMapSizeAndInverse.y; 
vec2 uvw0=4.-3.*st;
vec2 uvw1=vec2(7.);
vec2 uvw2=1.+3.*st;
vec3 u=vec3((3.-2.*st.x)/uvw0.x-2.,(3.+st.x)/uvw1.x,st.x/uvw2.x+2.)*shadowMapSizeAndInverse.y;
vec3 v=vec3((3.-2.*st.y)/uvw0.y-2.,(3.+st.y)/uvw1.y,st.y/uvw2.y+2.)*shadowMapSizeAndInverse.y;
float shadow=0.;
shadow+=uvw0.x*uvw0.y*texture2D(shadowSampler,vec4(base_uv.xy+vec2(u[0],v[0]),layer,uvDepth.z));
shadow+=uvw1.x*uvw0.y*texture2D(shadowSampler,vec4(base_uv.xy+vec2(u[1],v[0]),layer,uvDepth.z));
shadow+=uvw2.x*uvw0.y*texture2D(shadowSampler,vec4(base_uv.xy+vec2(u[2],v[0]),layer,uvDepth.z));
shadow+=uvw0.x*uvw1.y*texture2D(shadowSampler,vec4(base_uv.xy+vec2(u[0],v[1]),layer,uvDepth.z));
shadow+=uvw1.x*uvw1.y*texture2D(shadowSampler,vec4(base_uv.xy+vec2(u[1],v[1]),layer,uvDepth.z));
shadow+=uvw2.x*uvw1.y*texture2D(shadowSampler,vec4(base_uv.xy+vec2(u[2],v[1]),layer,uvDepth.z));
shadow+=uvw0.x*uvw2.y*texture2D(shadowSampler,vec4(base_uv.xy+vec2(u[0],v[2]),layer,uvDepth.z));
shadow+=uvw1.x*uvw2.y*texture2D(shadowSampler,vec4(base_uv.xy+vec2(u[1],v[2]),layer,uvDepth.z));
shadow+=uvw2.x*uvw2.y*texture2D(shadowSampler,vec4(base_uv.xy+vec2(u[2],v[2]),layer,uvDepth.z));
shadow=shadow/144.;
shadow=mix(darkness,1.,shadow);
return computeFallOff(shadow,clipSpace.xy,frustumEdgeFalloff);
}
#define inline
float computeShadowWithPCF1(vec4 vPositionFromLight,float depthMetric,highp sampler2DShadow shadowSampler,float darkness,float frustumEdgeFalloff)
{
if (depthMetric>1.0 || depthMetric<0.0) {
return 1.0;
}
else
{
vec3 clipSpace=vPositionFromLight.xyz/vPositionFromLight.w;
vec3 uvDepth=vec3(0.5*clipSpace.xyz+vec3(0.5));
uvDepth.z=ZINCLIP;
float shadow=texture2D(shadowSampler,uvDepth);
shadow=mix(darkness,1.,shadow);
return computeFallOff(shadow,clipSpace.xy,frustumEdgeFalloff);
}
}
#define inline
float computeShadowWithPCF3(vec4 vPositionFromLight,float depthMetric,highp sampler2DShadow shadowSampler,vec2 shadowMapSizeAndInverse,float darkness,float frustumEdgeFalloff)
{
if (depthMetric>1.0 || depthMetric<0.0) {
return 1.0;
}
else
{
vec3 clipSpace=vPositionFromLight.xyz/vPositionFromLight.w;
vec3 uvDepth=vec3(0.5*clipSpace.xyz+vec3(0.5));
uvDepth.z=ZINCLIP;
vec2 uv=uvDepth.xy*shadowMapSizeAndInverse.x; 
uv+=0.5; 
vec2 st=fract(uv); 
vec2 base_uv=floor(uv)-0.5; 
base_uv*=shadowMapSizeAndInverse.y; 
vec2 uvw0=3.-2.*st;
vec2 uvw1=1.+2.*st;
vec2 u=vec2((2.-st.x)/uvw0.x-1.,st.x/uvw1.x+1.)*shadowMapSizeAndInverse.y;
vec2 v=vec2((2.-st.y)/uvw0.y-1.,st.y/uvw1.y+1.)*shadowMapSizeAndInverse.y;
float shadow=0.;
shadow+=uvw0.x*uvw0.y*texture2D(shadowSampler,vec3(base_uv.xy+vec2(u[0],v[0]),uvDepth.z));
shadow+=uvw1.x*uvw0.y*texture2D(shadowSampler,vec3(base_uv.xy+vec2(u[1],v[0]),uvDepth.z));
shadow+=uvw0.x*uvw1.y*texture2D(shadowSampler,vec3(base_uv.xy+vec2(u[0],v[1]),uvDepth.z));
shadow+=uvw1.x*uvw1.y*texture2D(shadowSampler,vec3(base_uv.xy+vec2(u[1],v[1]),uvDepth.z));
shadow=shadow/16.;
shadow=mix(darkness,1.,shadow);
return computeFallOff(shadow,clipSpace.xy,frustumEdgeFalloff);
}
}
#define inline
float computeShadowWithPCF5(vec4 vPositionFromLight,float depthMetric,highp sampler2DShadow shadowSampler,vec2 shadowMapSizeAndInverse,float darkness,float frustumEdgeFalloff)
{
if (depthMetric>1.0 || depthMetric<0.0) {
return 1.0;
}
else
{
vec3 clipSpace=vPositionFromLight.xyz/vPositionFromLight.w;
vec3 uvDepth=vec3(0.5*clipSpace.xyz+vec3(0.5));
uvDepth.z=ZINCLIP;
vec2 uv=uvDepth.xy*shadowMapSizeAndInverse.x; 
uv+=0.5; 
vec2 st=fract(uv); 
vec2 base_uv=floor(uv)-0.5; 
base_uv*=shadowMapSizeAndInverse.y; 
vec2 uvw0=4.-3.*st;
vec2 uvw1=vec2(7.);
vec2 uvw2=1.+3.*st;
vec3 u=vec3((3.-2.*st.x)/uvw0.x-2.,(3.+st.x)/uvw1.x,st.x/uvw2.x+2.)*shadowMapSizeAndInverse.y;
vec3 v=vec3((3.-2.*st.y)/uvw0.y-2.,(3.+st.y)/uvw1.y,st.y/uvw2.y+2.)*shadowMapSizeAndInverse.y;
float shadow=0.;
shadow+=uvw0.x*uvw0.y*texture2D(shadowSampler,vec3(base_uv.xy+vec2(u[0],v[0]),uvDepth.z));
shadow+=uvw1.x*uvw0.y*texture2D(shadowSampler,vec3(base_uv.xy+vec2(u[1],v[0]),uvDepth.z));
shadow+=uvw2.x*uvw0.y*texture2D(shadowSampler,vec3(base_uv.xy+vec2(u[2],v[0]),uvDepth.z));
shadow+=uvw0.x*uvw1.y*texture2D(shadowSampler,vec3(base_uv.xy+vec2(u[0],v[1]),uvDepth.z));
shadow+=uvw1.x*uvw1.y*texture2D(shadowSampler,vec3(base_uv.xy+vec2(u[1],v[1]),uvDepth.z));
shadow+=uvw2.x*uvw1.y*texture2D(shadowSampler,vec3(base_uv.xy+vec2(u[2],v[1]),uvDepth.z));
shadow+=uvw0.x*uvw2.y*texture2D(shadowSampler,vec3(base_uv.xy+vec2(u[0],v[2]),uvDepth.z));
shadow+=uvw1.x*uvw2.y*texture2D(shadowSampler,vec3(base_uv.xy+vec2(u[1],v[2]),uvDepth.z));
shadow+=uvw2.x*uvw2.y*texture2D(shadowSampler,vec3(base_uv.xy+vec2(u[2],v[2]),uvDepth.z));
shadow=shadow/144.;
shadow=mix(darkness,1.,shadow);
return computeFallOff(shadow,clipSpace.xy,frustumEdgeFalloff);
}
}
const vec3 PoissonSamplers32[64]=vec3[64](
vec3(0.06407013,0.05409927,0.),
vec3(0.7366577,0.5789394,0.),
vec3(-0.6270542,-0.5320278,0.),
vec3(-0.4096107,0.8411095,0.),
vec3(0.6849564,-0.4990818,0.),
vec3(-0.874181,-0.04579735,0.),
vec3(0.9989998,0.0009880066,0.),
vec3(-0.004920578,-0.9151649,0.),
vec3(0.1805763,0.9747483,0.),
vec3(-0.2138451,0.2635818,0.),
vec3(0.109845,0.3884785,0.),
vec3(0.06876755,-0.3581074,0.),
vec3(0.374073,-0.7661266,0.),
vec3(0.3079132,-0.1216763,0.),
vec3(-0.3794335,-0.8271583,0.),
vec3(-0.203878,-0.07715034,0.),
vec3(0.5912697,0.1469799,0.),
vec3(-0.88069,0.3031784,0.),
vec3(0.5040108,0.8283722,0.),
vec3(-0.5844124,0.5494877,0.),
vec3(0.6017799,-0.1726654,0.),
vec3(-0.5554981,0.1559997,0.),
vec3(-0.3016369,-0.3900928,0.),
vec3(-0.5550632,-0.1723762,0.),
vec3(0.925029,0.2995041,0.),
vec3(-0.2473137,0.5538505,0.),
vec3(0.9183037,-0.2862392,0.),
vec3(0.2469421,0.6718712,0.),
vec3(0.3916397,-0.4328209,0.),
vec3(-0.03576927,-0.6220032,0.),
vec3(-0.04661255,0.7995201,0.),
vec3(0.4402924,0.3640312,0.),
vec3(0.,0.,0.),
vec3(0.,0.,0.),
vec3(0.,0.,0.),
vec3(0.,0.,0.),
vec3(0.,0.,0.),
vec3(0.,0.,0.),
vec3(0.,0.,0.),
vec3(0.,0.,0.),
vec3(0.,0.,0.),
vec3(0.,0.,0.),
vec3(0.,0.,0.),
vec3(0.,0.,0.),
vec3(0.,0.,0.),
vec3(0.,0.,0.),
vec3(0.,0.,0.),
vec3(0.,0.,0.),
vec3(0.,0.,0.),
vec3(0.,0.,0.),
vec3(0.,0.,0.),
vec3(0.,0.,0.),
vec3(0.,0.,0.),
vec3(0.,0.,0.),
vec3(0.,0.,0.),
vec3(0.,0.,0.),
vec3(0.,0.,0.),
vec3(0.,0.,0.),
vec3(0.,0.,0.),
vec3(0.,0.,0.),
vec3(0.,0.,0.),
vec3(0.,0.,0.),
vec3(0.,0.,0.),
vec3(0.,0.,0.)
);
const vec3 PoissonSamplers64[64]=vec3[64](
vec3(-0.613392,0.617481,0.),
vec3(0.170019,-0.040254,0.),
vec3(-0.299417,0.791925,0.),
vec3(0.645680,0.493210,0.),
vec3(-0.651784,0.717887,0.),
vec3(0.421003,0.027070,0.),
vec3(-0.817194,-0.271096,0.),
vec3(-0.705374,-0.668203,0.),
vec3(0.977050,-0.108615,0.),
vec3(0.063326,0.142369,0.),
vec3(0.203528,0.214331,0.),
vec3(-0.667531,0.326090,0.),
vec3(-0.098422,-0.295755,0.),
vec3(-0.885922,0.215369,0.),
vec3(0.566637,0.605213,0.),
vec3(0.039766,-0.396100,0.),
vec3(0.751946,0.453352,0.),
vec3(0.078707,-0.715323,0.),
vec3(-0.075838,-0.529344,0.),
vec3(0.724479,-0.580798,0.),
vec3(0.222999,-0.215125,0.),
vec3(-0.467574,-0.405438,0.),
vec3(-0.248268,-0.814753,0.),
vec3(0.354411,-0.887570,0.),
vec3(0.175817,0.382366,0.),
vec3(0.487472,-0.063082,0.),
vec3(-0.084078,0.898312,0.),
vec3(0.488876,-0.783441,0.),
vec3(0.470016,0.217933,0.),
vec3(-0.696890,-0.549791,0.),
vec3(-0.149693,0.605762,0.),
vec3(0.034211,0.979980,0.),
vec3(0.503098,-0.308878,0.),
vec3(-0.016205,-0.872921,0.),
vec3(0.385784,-0.393902,0.),
vec3(-0.146886,-0.859249,0.),
vec3(0.643361,0.164098,0.),
vec3(0.634388,-0.049471,0.),
vec3(-0.688894,0.007843,0.),
vec3(0.464034,-0.188818,0.),
vec3(-0.440840,0.137486,0.),
vec3(0.364483,0.511704,0.),
vec3(0.034028,0.325968,0.),
vec3(0.099094,-0.308023,0.),
vec3(0.693960,-0.366253,0.),
vec3(0.678884,-0.204688,0.),
vec3(0.001801,0.780328,0.),
vec3(0.145177,-0.898984,0.),
vec3(0.062655,-0.611866,0.),
vec3(0.315226,-0.604297,0.),
vec3(-0.780145,0.486251,0.),
vec3(-0.371868,0.882138,0.),
vec3(0.200476,0.494430,0.),
vec3(-0.494552,-0.711051,0.),
vec3(0.612476,0.705252,0.),
vec3(-0.578845,-0.768792,0.),
vec3(-0.772454,-0.090976,0.),
vec3(0.504440,0.372295,0.),
vec3(0.155736,0.065157,0.),
vec3(0.391522,0.849605,0.),
vec3(-0.620106,-0.328104,0.),
vec3(0.789239,-0.419965,0.),
vec3(-0.545396,0.538133,0.),
vec3(-0.178564,-0.596057,0.)
);
#define inline
float computeShadowWithCSMPCSS(float layer,vec4 vPositionFromLight,float depthMetric,highp sampler2DArray depthSampler,highp sampler2DArrayShadow shadowSampler,float shadowMapSizeInverse,float lightSizeUV,float darkness,float frustumEdgeFalloff,int searchTapCount,int pcfTapCount,vec3[64] poissonSamplers,vec2 lightSizeUVCorrection,float depthCorrection,float penumbraDarkness)
{
vec3 clipSpace=vPositionFromLight.xyz/vPositionFromLight.w;
vec3 uvDepth=vec3(0.5*clipSpace.xyz+vec3(0.5));
uvDepth.z=clamp(ZINCLIP,0.,GREATEST_LESS_THAN_ONE);
vec4 uvDepthLayer=vec4(uvDepth.x,uvDepth.y,layer,uvDepth.z);
float blockerDepth=0.0;
float sumBlockerDepth=0.0;
float numBlocker=0.0;
for (int i=0; i<searchTapCount; i ++) {
blockerDepth=texture2D(depthSampler,vec3(uvDepth.xy+(lightSizeUV*lightSizeUVCorrection*shadowMapSizeInverse*PoissonSamplers32[i].xy),layer)).r;
if (blockerDepth<depthMetric) {
sumBlockerDepth+=blockerDepth;
numBlocker++;
}
}
if (numBlocker<1.0) {
return 1.0;
}
else
{
float avgBlockerDepth=sumBlockerDepth/numBlocker;
float AAOffset=shadowMapSizeInverse*10.;
float penumbraRatio=((depthMetric-avgBlockerDepth)*depthCorrection+AAOffset);
vec4 filterRadius=vec4(penumbraRatio*lightSizeUV*lightSizeUVCorrection*shadowMapSizeInverse,0.,0.);
float random=getRand(vPositionFromLight.xy);
float rotationAngle=random*3.1415926;
vec2 rotationVector=vec2(cos(rotationAngle),sin(rotationAngle));
float shadow=0.;
for (int i=0; i<pcfTapCount; i++) {
vec4 offset=vec4(poissonSamplers[i],0.);
offset=vec4(offset.x*rotationVector.x-offset.y*rotationVector.y,offset.y*rotationVector.x+offset.x*rotationVector.y,0.,0.);
shadow+=texture2D(shadowSampler,uvDepthLayer+offset*filterRadius);
}
shadow/=float(pcfTapCount);
shadow=mix(shadow,1.,min((depthMetric-avgBlockerDepth)*depthCorrection*penumbraDarkness,1.));
shadow=mix(darkness,1.,shadow);
return computeFallOff(shadow,clipSpace.xy,frustumEdgeFalloff);
}
}
#define inline
float computeShadowWithPCSS(vec4 vPositionFromLight,float depthMetric,sampler2D depthSampler,highp sampler2DShadow shadowSampler,float shadowMapSizeInverse,float lightSizeUV,float darkness,float frustumEdgeFalloff,int searchTapCount,int pcfTapCount,vec3[64] poissonSamplers)
{
if (depthMetric>1.0 || depthMetric<0.0) {
return 1.0;
}
else
{
vec3 clipSpace=vPositionFromLight.xyz/vPositionFromLight.w;
vec3 uvDepth=vec3(0.5*clipSpace.xyz+vec3(0.5));
uvDepth.z=ZINCLIP;
float blockerDepth=0.0;
float sumBlockerDepth=0.0;
float numBlocker=0.0;
for (int i=0; i<searchTapCount; i ++) {
blockerDepth=texture2D(depthSampler,uvDepth.xy+(lightSizeUV*shadowMapSizeInverse*PoissonSamplers32[i].xy)).r;
if (blockerDepth<depthMetric) {
sumBlockerDepth+=blockerDepth;
numBlocker++;
}
}
if (numBlocker<1.0) {
return 1.0;
}
else
{
float avgBlockerDepth=sumBlockerDepth/numBlocker;
float AAOffset=shadowMapSizeInverse*10.;
float penumbraRatio=((depthMetric-avgBlockerDepth)+AAOffset);
float filterRadius=penumbraRatio*lightSizeUV*shadowMapSizeInverse;
float random=getRand(vPositionFromLight.xy);
float rotationAngle=random*3.1415926;
vec2 rotationVector=vec2(cos(rotationAngle),sin(rotationAngle));
float shadow=0.;
for (int i=0; i<pcfTapCount; i++) {
vec3 offset=poissonSamplers[i];
offset=vec3(offset.x*rotationVector.x-offset.y*rotationVector.y,offset.y*rotationVector.x+offset.x*rotationVector.y,0.);
shadow+=texture2D(shadowSampler,uvDepth+offset*filterRadius);
}
shadow/=float(pcfTapCount);
shadow=mix(shadow,1.,depthMetric-avgBlockerDepth);
shadow=mix(darkness,1.,shadow);
return computeFallOff(shadow,clipSpace.xy,frustumEdgeFalloff);
}
}
}
#define inline
float computeShadowWithPCSS16(vec4 vPositionFromLight,float depthMetric,sampler2D depthSampler,highp sampler2DShadow shadowSampler,float shadowMapSizeInverse,float lightSizeUV,float darkness,float frustumEdgeFalloff)
{
return computeShadowWithPCSS(vPositionFromLight,depthMetric,depthSampler,shadowSampler,shadowMapSizeInverse,lightSizeUV,darkness,frustumEdgeFalloff,16,16,PoissonSamplers32);
}
#define inline
float computeShadowWithPCSS32(vec4 vPositionFromLight,float depthMetric,sampler2D depthSampler,highp sampler2DShadow shadowSampler,float shadowMapSizeInverse,float lightSizeUV,float darkness,float frustumEdgeFalloff)
{
return computeShadowWithPCSS(vPositionFromLight,depthMetric,depthSampler,shadowSampler,shadowMapSizeInverse,lightSizeUV,darkness,frustumEdgeFalloff,16,32,PoissonSamplers32);
}
#define inline
float computeShadowWithPCSS64(vec4 vPositionFromLight,float depthMetric,sampler2D depthSampler,highp sampler2DShadow shadowSampler,float shadowMapSizeInverse,float lightSizeUV,float darkness,float frustumEdgeFalloff)
{
return computeShadowWithPCSS(vPositionFromLight,depthMetric,depthSampler,shadowSampler,shadowMapSizeInverse,lightSizeUV,darkness,frustumEdgeFalloff,32,64,PoissonSamplers64);
}
#define inline
float computeShadowWithCSMPCSS16(float layer,vec4 vPositionFromLight,float depthMetric,highp sampler2DArray depthSampler,highp sampler2DArrayShadow shadowSampler,float shadowMapSizeInverse,float lightSizeUV,float darkness,float frustumEdgeFalloff,vec2 lightSizeUVCorrection,float depthCorrection,float penumbraDarkness)
{
return computeShadowWithCSMPCSS(layer,vPositionFromLight,depthMetric,depthSampler,shadowSampler,shadowMapSizeInverse,lightSizeUV,darkness,frustumEdgeFalloff,16,16,PoissonSamplers32,lightSizeUVCorrection,depthCorrection,penumbraDarkness);
}
#define inline
float computeShadowWithCSMPCSS32(float layer,vec4 vPositionFromLight,float depthMetric,highp sampler2DArray depthSampler,highp sampler2DArrayShadow shadowSampler,float shadowMapSizeInverse,float lightSizeUV,float darkness,float frustumEdgeFalloff,vec2 lightSizeUVCorrection,float depthCorrection,float penumbraDarkness)
{
return computeShadowWithCSMPCSS(layer,vPositionFromLight,depthMetric,depthSampler,shadowSampler,shadowMapSizeInverse,lightSizeUV,darkness,frustumEdgeFalloff,16,32,PoissonSamplers32,lightSizeUVCorrection,depthCorrection,penumbraDarkness);
}
#define inline
float computeShadowWithCSMPCSS64(float layer,vec4 vPositionFromLight,float depthMetric,highp sampler2DArray depthSampler,highp sampler2DArrayShadow shadowSampler,float shadowMapSizeInverse,float lightSizeUV,float darkness,float frustumEdgeFalloff,vec2 lightSizeUVCorrection,float depthCorrection,float penumbraDarkness)
{
return computeShadowWithCSMPCSS(layer,vPositionFromLight,depthMetric,depthSampler,shadowSampler,shadowMapSizeInverse,lightSizeUV,darkness,frustumEdgeFalloff,32,64,PoissonSamplers64,lightSizeUVCorrection,depthCorrection,penumbraDarkness);
}
#endif
#endif
`;q.IncludesShadersStore[Gu]=zu;var Wu="samplerFragmentDeclaration",Hu=`#ifdef _DEFINENAME_
#if _DEFINENAME_DIRECTUV==1
#define v_VARYINGNAME_UV vMainUV1
#elif _DEFINENAME_DIRECTUV==2
#define v_VARYINGNAME_UV vMainUV2
#elif _DEFINENAME_DIRECTUV==3
#define v_VARYINGNAME_UV vMainUV3
#elif _DEFINENAME_DIRECTUV==4
#define v_VARYINGNAME_UV vMainUV4
#elif _DEFINENAME_DIRECTUV==5
#define v_VARYINGNAME_UV vMainUV5
#elif _DEFINENAME_DIRECTUV==6
#define v_VARYINGNAME_UV vMainUV6
#else
varying vec2 v_VARYINGNAME_UV;
#endif
uniform sampler2D _SAMPLERNAME_Sampler;
#endif
`;q.IncludesShadersStore[Wu]=Hu;var Xu="fresnelFunction",ju=`#ifdef FRESNEL
float computeFresnelTerm(vec3 viewDirection,vec3 worldNormal,float bias,float power)
{
float fresnelTerm=pow(bias+abs(dot(viewDirection,worldNormal)),power);
return clamp(fresnelTerm,0.,1.);
}
#endif
`;q.IncludesShadersStore[Xu]=ju;var Ku="reflectionFunction",Yu=`vec3 computeFixedEquirectangularCoords(vec4 worldPos,vec3 worldNormal,vec3 direction)
{
float lon=atan(direction.z,direction.x);
float lat=acos(direction.y);
vec2 sphereCoords=vec2(lon,lat)*RECIPROCAL_PI2*2.0;
float s=sphereCoords.x*0.5+0.5;
float t=sphereCoords.y;
return vec3(s,t,0); 
}
vec3 computeMirroredFixedEquirectangularCoords(vec4 worldPos,vec3 worldNormal,vec3 direction)
{
float lon=atan(direction.z,direction.x);
float lat=acos(direction.y);
vec2 sphereCoords=vec2(lon,lat)*RECIPROCAL_PI2*2.0;
float s=sphereCoords.x*0.5+0.5;
float t=sphereCoords.y;
return vec3(1.0-s,t,0); 
}
vec3 computeEquirectangularCoords(vec4 worldPos,vec3 worldNormal,vec3 eyePosition,mat4 reflectionMatrix)
{
vec3 cameraToVertex=normalize(worldPos.xyz-eyePosition);
vec3 r=normalize(reflect(cameraToVertex,worldNormal));
r=vec3(reflectionMatrix*vec4(r,0));
float lon=atan(r.z,r.x);
float lat=acos(r.y);
vec2 sphereCoords=vec2(lon,lat)*RECIPROCAL_PI2*2.0;
float s=sphereCoords.x*0.5+0.5;
float t=sphereCoords.y;
return vec3(s,t,0);
}
vec3 computeSphericalCoords(vec4 worldPos,vec3 worldNormal,mat4 view,mat4 reflectionMatrix)
{
vec3 viewDir=normalize(vec3(view*worldPos));
vec3 viewNormal=normalize(vec3(view*vec4(worldNormal,0.0)));
vec3 r=reflect(viewDir,viewNormal);
r=vec3(reflectionMatrix*vec4(r,0));
r.z=r.z-1.0;
float m=2.0*length(r);
return vec3(r.x/m+0.5,1.0-r.y/m-0.5,0);
}
vec3 computePlanarCoords(vec4 worldPos,vec3 worldNormal,vec3 eyePosition,mat4 reflectionMatrix)
{
vec3 viewDir=worldPos.xyz-eyePosition;
vec3 coords=normalize(reflect(viewDir,worldNormal));
return vec3(reflectionMatrix*vec4(coords,1));
}
vec3 computeCubicCoords(vec4 worldPos,vec3 worldNormal,vec3 eyePosition,mat4 reflectionMatrix)
{
vec3 viewDir=normalize(worldPos.xyz-eyePosition);
vec3 coords=reflect(viewDir,worldNormal);
coords=vec3(reflectionMatrix*vec4(coords,0));
#ifdef INVERTCUBICMAP
coords.y*=-1.0;
#endif
return coords;
}
vec3 computeCubicLocalCoords(vec4 worldPos,vec3 worldNormal,vec3 eyePosition,mat4 reflectionMatrix,vec3 reflectionSize,vec3 reflectionPosition)
{
vec3 viewDir=normalize(worldPos.xyz-eyePosition);
vec3 coords=reflect(viewDir,worldNormal);
coords=parallaxCorrectNormal(worldPos.xyz,coords,reflectionSize,reflectionPosition);
coords=vec3(reflectionMatrix*vec4(coords,0));
#ifdef INVERTCUBICMAP
coords.y*=-1.0;
#endif
return coords;
}
vec3 computeProjectionCoords(vec4 worldPos,mat4 view,mat4 reflectionMatrix)
{
return vec3(reflectionMatrix*(view*worldPos));
}
vec3 computeSkyBoxCoords(vec3 positionW,mat4 reflectionMatrix)
{
return vec3(reflectionMatrix*vec4(positionW,1.));
}
#ifdef REFLECTION
vec3 computeReflectionCoords(vec4 worldPos,vec3 worldNormal)
{
#ifdef REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED
vec3 direction=normalize(vDirectionW);
return computeMirroredFixedEquirectangularCoords(worldPos,worldNormal,direction);
#endif
#ifdef REFLECTIONMAP_EQUIRECTANGULAR_FIXED
vec3 direction=normalize(vDirectionW);
return computeFixedEquirectangularCoords(worldPos,worldNormal,direction);
#endif
#ifdef REFLECTIONMAP_EQUIRECTANGULAR
return computeEquirectangularCoords(worldPos,worldNormal,vEyePosition.xyz,reflectionMatrix);
#endif
#ifdef REFLECTIONMAP_SPHERICAL
return computeSphericalCoords(worldPos,worldNormal,view,reflectionMatrix);
#endif
#ifdef REFLECTIONMAP_PLANAR
return computePlanarCoords(worldPos,worldNormal,vEyePosition.xyz,reflectionMatrix);
#endif
#ifdef REFLECTIONMAP_CUBIC
#ifdef USE_LOCAL_REFLECTIONMAP_CUBIC
return computeCubicLocalCoords(worldPos,worldNormal,vEyePosition.xyz,reflectionMatrix,vReflectionSize,vReflectionPosition);
#else
return computeCubicCoords(worldPos,worldNormal,vEyePosition.xyz,reflectionMatrix);
#endif
#endif
#ifdef REFLECTIONMAP_PROJECTION
return computeProjectionCoords(worldPos,view,reflectionMatrix);
#endif
#ifdef REFLECTIONMAP_SKYBOX
return computeSkyBoxCoords(vPositionUVW,reflectionMatrix);
#endif
#ifdef REFLECTIONMAP_EXPLICIT
return vec3(0,0,0);
#endif
}
#endif
`;q.IncludesShadersStore[Ku]=Yu;var qu="imageProcessingDeclaration",Zu=`#ifdef EXPOSURE
uniform float exposureLinear;
#endif
#ifdef CONTRAST
uniform float contrast;
#endif
#ifdef VIGNETTE
uniform vec2 vInverseScreenSize;
uniform vec4 vignetteSettings1;
uniform vec4 vignetteSettings2;
#endif
#ifdef COLORCURVES
uniform vec4 vCameraColorCurveNegative;
uniform vec4 vCameraColorCurveNeutral;
uniform vec4 vCameraColorCurvePositive;
#endif
#ifdef COLORGRADING
#ifdef COLORGRADING3D
uniform highp sampler3D txColorTransform;
#else
uniform sampler2D txColorTransform;
#endif
uniform vec4 colorTransformSettings;
#endif
`;q.IncludesShadersStore[qu]=Zu;var Qu="imageProcessingFunctions",$u=`#if defined(COLORGRADING) && !defined(COLORGRADING3D)
/** 
* Polyfill for SAMPLE_TEXTURE_3D,which is unsupported in WebGL.
* sampler3dSetting.x=textureOffset (0.5/textureSize).
* sampler3dSetting.y=textureSize.
*/
#define inline
vec3 sampleTexture3D(sampler2D colorTransform,vec3 color,vec2 sampler3dSetting)
{
float sliceSize=2.0*sampler3dSetting.x; 
#ifdef SAMPLER3DGREENDEPTH
float sliceContinuous=(color.g-sampler3dSetting.x)*sampler3dSetting.y;
#else
float sliceContinuous=(color.b-sampler3dSetting.x)*sampler3dSetting.y;
#endif
float sliceInteger=floor(sliceContinuous);
float sliceFraction=sliceContinuous-sliceInteger;
#ifdef SAMPLER3DGREENDEPTH
vec2 sliceUV=color.rb;
#else
vec2 sliceUV=color.rg;
#endif
sliceUV.x*=sliceSize;
sliceUV.x+=sliceInteger*sliceSize;
sliceUV=saturate(sliceUV);
vec4 slice0Color=texture2D(colorTransform,sliceUV);
sliceUV.x+=sliceSize;
sliceUV=saturate(sliceUV);
vec4 slice1Color=texture2D(colorTransform,sliceUV);
vec3 result=mix(slice0Color.rgb,slice1Color.rgb,sliceFraction);
#ifdef SAMPLER3DBGRMAP
color.rgb=result.rgb;
#else
color.rgb=result.bgr;
#endif
return color;
}
#endif
#ifdef TONEMAPPING_ACES
const mat3 ACESInputMat=mat3(
vec3(0.59719,0.07600,0.02840),
vec3(0.35458,0.90834,0.13383),
vec3(0.04823,0.01566,0.83777)
);
const mat3 ACESOutputMat=mat3(
vec3( 1.60475,-0.10208,-0.00327),
vec3(-0.53108, 1.10813,-0.07276),
vec3(-0.07367,-0.00605, 1.07602)
);
vec3 RRTAndODTFit(vec3 v)
{
vec3 a=v*(v+0.0245786)-0.000090537;
vec3 b=v*(0.983729*v+0.4329510)+0.238081;
return a/b;
}
vec3 ACESFitted(vec3 color)
{
color=ACESInputMat*color;
color=RRTAndODTFit(color);
color=ACESOutputMat*color;
color=saturate(color);
return color;
}
#endif
vec4 applyImageProcessing(vec4 result) {
#ifdef EXPOSURE
result.rgb*=exposureLinear;
#endif
#ifdef VIGNETTE
vec2 viewportXY=gl_FragCoord.xy*vInverseScreenSize;
viewportXY=viewportXY*2.0-1.0;
vec3 vignetteXY1=vec3(viewportXY*vignetteSettings1.xy+vignetteSettings1.zw,1.0);
float vignetteTerm=dot(vignetteXY1,vignetteXY1);
float vignette=pow(vignetteTerm,vignetteSettings2.w);
vec3 vignetteColor=vignetteSettings2.rgb;
#ifdef VIGNETTEBLENDMODEMULTIPLY
vec3 vignetteColorMultiplier=mix(vignetteColor,vec3(1,1,1),vignette);
result.rgb*=vignetteColorMultiplier;
#endif
#ifdef VIGNETTEBLENDMODEOPAQUE
result.rgb=mix(vignetteColor,result.rgb,vignette);
#endif
#endif
#ifdef TONEMAPPING
#ifdef TONEMAPPING_ACES
result.rgb=ACESFitted(result.rgb);
#else
const float tonemappingCalibration=1.590579;
result.rgb=1.0-exp2(-tonemappingCalibration*result.rgb);
#endif
#endif
result.rgb=toGammaSpace(result.rgb);
result.rgb=saturate(result.rgb);
#ifdef CONTRAST
vec3 resultHighContrast=result.rgb*result.rgb*(3.0-2.0*result.rgb);
if (contrast<1.0) {
result.rgb=mix(vec3(0.5,0.5,0.5),result.rgb,contrast);
} else {
result.rgb=mix(result.rgb,resultHighContrast,contrast-1.0);
}
#endif
#ifdef COLORGRADING
vec3 colorTransformInput=result.rgb*colorTransformSettings.xxx+colorTransformSettings.yyy;
#ifdef COLORGRADING3D
vec3 colorTransformOutput=texture(txColorTransform,colorTransformInput).rgb;
#else
vec3 colorTransformOutput=sampleTexture3D(txColorTransform,colorTransformInput,colorTransformSettings.yz).rgb;
#endif
result.rgb=mix(result.rgb,colorTransformOutput,colorTransformSettings.www);
#endif
#ifdef COLORCURVES
float luma=getLuminance(result.rgb);
vec2 curveMix=clamp(vec2(luma*3.0-1.5,luma*-3.0+1.5),vec2(0.0),vec2(1.0));
vec4 colorCurve=vCameraColorCurveNeutral+curveMix.x*vCameraColorCurvePositive-curveMix.y*vCameraColorCurveNegative;
result.rgb*=colorCurve.rgb;
result.rgb=mix(vec3(luma),result.rgb,colorCurve.a);
#endif
return result;
}`;q.IncludesShadersStore[Qu]=$u;var Ju="bumpFragmentMainFunctions",ef=`#if defined(BUMP) || defined(CLEARCOAT_BUMP) || defined(ANISOTROPIC) || defined(DETAIL)
#if defined(TANGENT) && defined(NORMAL) 
varying mat3 vTBN;
#endif
#ifdef OBJECTSPACE_NORMALMAP
uniform mat4 normalMatrix;
#endif
vec3 perturbNormalBase(mat3 cotangentFrame,vec3 normal,float scale)
{
#ifdef NORMALXYSCALE
normal=normalize(normal*vec3(scale,scale,1.0));
#endif
return normalize(cotangentFrame*normal);
}
vec3 perturbNormal(mat3 cotangentFrame,vec3 textureSample,float scale)
{
return perturbNormalBase(cotangentFrame,textureSample*2.0-1.0,scale);
}
mat3 cotangent_frame(vec3 normal,vec3 p,vec2 uv,vec2 tangentSpaceParams)
{
vec3 dp1=dFdx(p);
vec3 dp2=dFdy(p);
vec2 duv1=dFdx(uv);
vec2 duv2=dFdy(uv);
vec3 dp2perp=cross(dp2,normal);
vec3 dp1perp=cross(normal,dp1);
vec3 tangent=dp2perp*duv1.x+dp1perp*duv2.x;
vec3 bitangent=dp2perp*duv1.y+dp1perp*duv2.y;
tangent*=tangentSpaceParams.x;
bitangent*=tangentSpaceParams.y;
float invmax=inversesqrt(max(dot(tangent,tangent),dot(bitangent,bitangent)));
return mat3(tangent*invmax,bitangent*invmax,normal);
}
#endif
`;q.IncludesShadersStore[Ju]=ef;var tf="bumpFragmentFunctions",rf=`#if defined(BUMP)
#include<samplerFragmentDeclaration>(_DEFINENAME_,BUMP,_VARYINGNAME_,Bump,_SAMPLERNAME_,bump)
#endif
#if defined(DETAIL)
#include<samplerFragmentDeclaration>(_DEFINENAME_,DETAIL,_VARYINGNAME_,Detail,_SAMPLERNAME_,detail)
#endif
#if defined(BUMP) && defined(PARALLAX)
const float minSamples=4.;
const float maxSamples=15.;
const int iMaxSamples=15;
vec2 parallaxOcclusion(vec3 vViewDirCoT,vec3 vNormalCoT,vec2 texCoord,float parallaxScale) {
float parallaxLimit=length(vViewDirCoT.xy)/vViewDirCoT.z;
parallaxLimit*=parallaxScale;
vec2 vOffsetDir=normalize(vViewDirCoT.xy);
vec2 vMaxOffset=vOffsetDir*parallaxLimit;
float numSamples=maxSamples+(dot(vViewDirCoT,vNormalCoT)*(minSamples-maxSamples));
float stepSize=1.0/numSamples;
float currRayHeight=1.0;
vec2 vCurrOffset=vec2(0,0);
vec2 vLastOffset=vec2(0,0);
float lastSampledHeight=1.0;
float currSampledHeight=1.0;
for (int i=0; i<iMaxSamples; i++)
{
currSampledHeight=texture2D(bumpSampler,texCoord+vCurrOffset).w;
if (currSampledHeight>currRayHeight)
{
float delta1=currSampledHeight-currRayHeight;
float delta2=(currRayHeight+stepSize)-lastSampledHeight;
float ratio=delta1/(delta1+delta2);
vCurrOffset=(ratio)* vLastOffset+(1.0-ratio)*vCurrOffset;
break;
}
else
{
currRayHeight-=stepSize;
vLastOffset=vCurrOffset;
vCurrOffset+=stepSize*vMaxOffset;
lastSampledHeight=currSampledHeight;
}
}
return vCurrOffset;
}
vec2 parallaxOffset(vec3 viewDir,float heightScale)
{
float height=texture2D(bumpSampler,vBumpUV).w;
vec2 texCoordOffset=heightScale*viewDir.xy*height;
return -texCoordOffset;
}
#endif
`;q.IncludesShadersStore[tf]=rf;var nf="logDepthDeclaration",af=`#ifdef LOGARITHMICDEPTH
uniform float logarithmicDepthConstant;
varying float vFragmentDepth;
#endif
`;q.IncludesShadersStore[nf]=af;var sf="fogFragmentDeclaration",of=`#ifdef FOG
#define FOGMODE_NONE 0.
#define FOGMODE_EXP 1.
#define FOGMODE_EXP2 2.
#define FOGMODE_LINEAR 3.
#define E 2.71828
uniform vec4 vFogInfos;
uniform vec3 vFogColor;
varying vec3 vFogDistance;
float CalcFogFactor()
{
float fogCoeff=1.0;
float fogStart=vFogInfos.y;
float fogEnd=vFogInfos.z;
float fogDensity=vFogInfos.w;
float fogDistance=length(vFogDistance);
if (FOGMODE_LINEAR==vFogInfos.x)
{
fogCoeff=(fogEnd-fogDistance)/(fogEnd-fogStart);
}
else if (FOGMODE_EXP==vFogInfos.x)
{
fogCoeff=1.0/pow(E,fogDistance*fogDensity);
}
else if (FOGMODE_EXP2==vFogInfos.x)
{
fogCoeff=1.0/pow(E,fogDistance*fogDistance*fogDensity*fogDensity);
}
return clamp(fogCoeff,0.0,1.0);
}
#endif
`;q.IncludesShadersStore[sf]=of;var lf="oitFragment",uf=`#ifdef ORDER_INDEPENDENT_TRANSPARENCY
float fragDepth=gl_FragCoord.z; 
#ifdef ORDER_INDEPENDENT_TRANSPARENCY_16BITS
uint halfFloat=packHalf2x16(vec2(fragDepth));
vec2 full=unpackHalf2x16(halfFloat);
fragDepth=full.x;
#endif
ivec2 fragCoord=ivec2(gl_FragCoord.xy);
vec2 lastDepth=texelFetch(oitDepthSampler,fragCoord,0).rg;
vec4 lastFrontColor=texelFetch(oitFrontColorSampler,fragCoord,0);
depth.rg=vec2(-MAX_DEPTH);
frontColor=lastFrontColor;
backColor=vec4(0.0);
#ifdef USE_REVERSE_DEPTHBUFFER
float furthestDepth=-lastDepth.x;
float nearestDepth=lastDepth.y;
#else
float nearestDepth=-lastDepth.x;
float furthestDepth=lastDepth.y;
#endif
float alphaMultiplier=1.0-lastFrontColor.a;
#ifdef USE_REVERSE_DEPTHBUFFER
if (fragDepth>nearestDepth || fragDepth<furthestDepth) {
#else
if (fragDepth<nearestDepth || fragDepth>furthestDepth) {
#endif
return;
}
#ifdef USE_REVERSE_DEPTHBUFFER
if (fragDepth<nearestDepth && fragDepth>furthestDepth) {
#else
if (fragDepth>nearestDepth && fragDepth<furthestDepth) {
#endif
depth.rg=vec2(-fragDepth,fragDepth);
return;
}
#endif
`;q.IncludesShadersStore[lf]=uf;var ff="bumpFragment",hf=`vec2 uvOffset=vec2(0.0,0.0);
#if defined(BUMP) || defined(PARALLAX) || defined(DETAIL)
#ifdef NORMALXYSCALE
float normalScale=1.0;
#elif defined(BUMP)
float normalScale=vBumpInfos.y;
#else
float normalScale=1.0;
#endif
#if defined(TANGENT) && defined(NORMAL)
mat3 TBN=vTBN;
#elif defined(BUMP)
vec2 TBNUV=gl_FrontFacing ? vBumpUV : -vBumpUV;
mat3 TBN=cotangent_frame(normalW*normalScale,vPositionW,TBNUV,vTangentSpaceParams);
#else
vec2 TBNUV=gl_FrontFacing ? vDetailUV : -vDetailUV;
mat3 TBN=cotangent_frame(normalW*normalScale,vPositionW,TBNUV,vec2(1.,1.));
#endif
#elif defined(ANISOTROPIC)
#if defined(TANGENT) && defined(NORMAL)
mat3 TBN=vTBN;
#else
vec2 TBNUV=gl_FrontFacing ? vMainUV1 : -vMainUV1;
mat3 TBN=cotangent_frame(normalW,vPositionW,TBNUV,vec2(1.,1.));
#endif
#endif
#ifdef PARALLAX
mat3 invTBN=transposeMat3(TBN);
#ifdef PARALLAXOCCLUSION
uvOffset=parallaxOcclusion(invTBN*-viewDirectionW,invTBN*normalW,vBumpUV,vBumpInfos.z);
#else
uvOffset=parallaxOffset(invTBN*viewDirectionW,vBumpInfos.z);
#endif
#endif
#ifdef DETAIL
vec4 detailColor=texture2D(detailSampler,vDetailUV+uvOffset);
vec2 detailNormalRG=detailColor.wy*2.0-1.0;
float detailNormalB=sqrt(1.-saturate(dot(detailNormalRG,detailNormalRG)));
vec3 detailNormal=vec3(detailNormalRG,detailNormalB);
#endif
#ifdef BUMP
#ifdef OBJECTSPACE_NORMALMAP
normalW=normalize(texture2D(bumpSampler,vBumpUV).xyz *2.0-1.0);
normalW=normalize(mat3(normalMatrix)*normalW);
#elif !defined(DETAIL)
normalW=perturbNormal(TBN,texture2D(bumpSampler,vBumpUV+uvOffset).xyz,vBumpInfos.y);
#else
vec3 bumpNormal=texture2D(bumpSampler,vBumpUV+uvOffset).xyz*2.0-1.0;
#if DETAIL_NORMALBLENDMETHOD==0 
detailNormal.xy*=vDetailInfos.z;
vec3 blendedNormal=normalize(vec3(bumpNormal.xy+detailNormal.xy,bumpNormal.z*detailNormal.z));
#elif DETAIL_NORMALBLENDMETHOD==1 
detailNormal.xy*=vDetailInfos.z;
bumpNormal+=vec3(0.0,0.0,1.0);
detailNormal*=vec3(-1.0,-1.0,1.0);
vec3 blendedNormal=bumpNormal*dot(bumpNormal,detailNormal)/bumpNormal.z-detailNormal;
#endif
normalW=perturbNormalBase(TBN,blendedNormal,vBumpInfos.y);
#endif
#elif defined(DETAIL)
detailNormal.xy*=vDetailInfos.z;
normalW=perturbNormalBase(TBN,detailNormal,vDetailInfos.z);
#endif
`;q.IncludesShadersStore[ff]=hf;var cf="depthPrePass",df=`#ifdef DEPTHPREPASS
gl_FragColor=vec4(0.,0.,0.,1.0);
return;
#endif
`;q.IncludesShadersStore[cf]=df;var pf="lightFragment",_f=`#ifdef LIGHT{X}
#if defined(SHADOWONLY) || defined(LIGHTMAP) && defined(LIGHTMAPEXCLUDED{X}) && defined(LIGHTMAPNOSPECULAR{X})
#else
#ifdef PBR
#ifdef SPOTLIGHT{X}
preInfo=computePointAndSpotPreLightingInfo(light{X}.vLightData,viewDirectionW,normalW);
#elif defined(POINTLIGHT{X})
preInfo=computePointAndSpotPreLightingInfo(light{X}.vLightData,viewDirectionW,normalW);
#elif defined(HEMILIGHT{X})
preInfo=computeHemisphericPreLightingInfo(light{X}.vLightData,viewDirectionW,normalW);
#elif defined(DIRLIGHT{X})
preInfo=computeDirectionalPreLightingInfo(light{X}.vLightData,viewDirectionW,normalW);
#endif
preInfo.NdotV=NdotV;
#ifdef SPOTLIGHT{X}
#ifdef LIGHT_FALLOFF_GLTF{X}
preInfo.attenuation=computeDistanceLightFalloff_GLTF(preInfo.lightDistanceSquared,light{X}.vLightFalloff.y);
preInfo.attenuation*=computeDirectionalLightFalloff_GLTF(light{X}.vLightDirection.xyz,preInfo.L,light{X}.vLightFalloff.z,light{X}.vLightFalloff.w);
#elif defined(LIGHT_FALLOFF_PHYSICAL{X})
preInfo.attenuation=computeDistanceLightFalloff_Physical(preInfo.lightDistanceSquared);
preInfo.attenuation*=computeDirectionalLightFalloff_Physical(light{X}.vLightDirection.xyz,preInfo.L,light{X}.vLightDirection.w);
#elif defined(LIGHT_FALLOFF_STANDARD{X})
preInfo.attenuation=computeDistanceLightFalloff_Standard(preInfo.lightOffset,light{X}.vLightFalloff.x);
preInfo.attenuation*=computeDirectionalLightFalloff_Standard(light{X}.vLightDirection.xyz,preInfo.L,light{X}.vLightDirection.w,light{X}.vLightData.w);
#else
preInfo.attenuation=computeDistanceLightFalloff(preInfo.lightOffset,preInfo.lightDistanceSquared,light{X}.vLightFalloff.x,light{X}.vLightFalloff.y);
preInfo.attenuation*=computeDirectionalLightFalloff(light{X}.vLightDirection.xyz,preInfo.L,light{X}.vLightDirection.w,light{X}.vLightData.w,light{X}.vLightFalloff.z,light{X}.vLightFalloff.w);
#endif
#elif defined(POINTLIGHT{X})
#ifdef LIGHT_FALLOFF_GLTF{X}
preInfo.attenuation=computeDistanceLightFalloff_GLTF(preInfo.lightDistanceSquared,light{X}.vLightFalloff.y);
#elif defined(LIGHT_FALLOFF_PHYSICAL{X})
preInfo.attenuation=computeDistanceLightFalloff_Physical(preInfo.lightDistanceSquared);
#elif defined(LIGHT_FALLOFF_STANDARD{X})
preInfo.attenuation=computeDistanceLightFalloff_Standard(preInfo.lightOffset,light{X}.vLightFalloff.x);
#else
preInfo.attenuation=computeDistanceLightFalloff(preInfo.lightOffset,preInfo.lightDistanceSquared,light{X}.vLightFalloff.x,light{X}.vLightFalloff.y);
#endif
#else
preInfo.attenuation=1.0;
#endif
#ifdef HEMILIGHT{X}
preInfo.roughness=roughness;
#else
preInfo.roughness=adjustRoughnessFromLightProperties(roughness,light{X}.vLightSpecular.a,preInfo.lightDistance);
#endif
#ifdef HEMILIGHT{X}
info.diffuse=computeHemisphericDiffuseLighting(preInfo,light{X}.vLightDiffuse.rgb,light{X}.vLightGround);
#elif defined(SS_TRANSLUCENCY)
info.diffuse=computeDiffuseAndTransmittedLighting(preInfo,light{X}.vLightDiffuse.rgb,subSurfaceOut.transmittance);
#else
info.diffuse=computeDiffuseLighting(preInfo,light{X}.vLightDiffuse.rgb);
#endif
#ifdef SPECULARTERM
#ifdef ANISOTROPIC
info.specular=computeAnisotropicSpecularLighting(preInfo,viewDirectionW,normalW,anisotropicOut.anisotropicTangent,anisotropicOut.anisotropicBitangent,anisotropicOut.anisotropy,clearcoatOut.specularEnvironmentR0,specularEnvironmentR90,AARoughnessFactors.x,light{X}.vLightDiffuse.rgb);
#else
info.specular=computeSpecularLighting(preInfo,normalW,clearcoatOut.specularEnvironmentR0,specularEnvironmentR90,AARoughnessFactors.x,light{X}.vLightDiffuse.rgb);
#endif
#endif
#ifdef SHEEN
#ifdef SHEEN_LINKWITHALBEDO
preInfo.roughness=sheenOut.sheenIntensity;
#else
#ifdef HEMILIGHT{X}
preInfo.roughness=sheenOut.sheenRoughness;
#else
preInfo.roughness=adjustRoughnessFromLightProperties(sheenOut.sheenRoughness,light{X}.vLightSpecular.a,preInfo.lightDistance);
#endif
#endif
info.sheen=computeSheenLighting(preInfo,normalW,sheenOut.sheenColor,specularEnvironmentR90,AARoughnessFactors.x,light{X}.vLightDiffuse.rgb);
#endif
#ifdef CLEARCOAT
#ifdef HEMILIGHT{X}
preInfo.roughness=clearcoatOut.clearCoatRoughness;
#else
preInfo.roughness=adjustRoughnessFromLightProperties(clearcoatOut.clearCoatRoughness,light{X}.vLightSpecular.a,preInfo.lightDistance);
#endif
info.clearCoat=computeClearCoatLighting(preInfo,clearcoatOut.clearCoatNormalW,clearcoatOut.clearCoatAARoughnessFactors.x,clearcoatOut.clearCoatIntensity,light{X}.vLightDiffuse.rgb);
#ifdef CLEARCOAT_TINT
absorption=computeClearCoatLightingAbsorption(clearcoatOut.clearCoatNdotVRefract,preInfo.L,clearcoatOut.clearCoatNormalW,clearcoatOut.clearCoatColor,clearcoatOut.clearCoatThickness,clearcoatOut.clearCoatIntensity);
info.diffuse*=absorption;
#ifdef SPECULARTERM
info.specular*=absorption;
#endif
#endif
info.diffuse*=info.clearCoat.w;
#ifdef SPECULARTERM
info.specular*=info.clearCoat.w;
#endif
#ifdef SHEEN
info.sheen*=info.clearCoat.w;
#endif
#endif
#else
#ifdef SPOTLIGHT{X}
info=computeSpotLighting(viewDirectionW,normalW,light{X}.vLightData,light{X}.vLightDirection,light{X}.vLightDiffuse.rgb,light{X}.vLightSpecular.rgb,light{X}.vLightDiffuse.a,glossiness);
#elif defined(HEMILIGHT{X})
info=computeHemisphericLighting(viewDirectionW,normalW,light{X}.vLightData,light{X}.vLightDiffuse.rgb,light{X}.vLightSpecular.rgb,light{X}.vLightGround,glossiness);
#elif defined(POINTLIGHT{X}) || defined(DIRLIGHT{X})
info=computeLighting(viewDirectionW,normalW,light{X}.vLightData,light{X}.vLightDiffuse.rgb,light{X}.vLightSpecular.rgb,light{X}.vLightDiffuse.a,glossiness);
#endif
#endif
#ifdef PROJECTEDLIGHTTEXTURE{X}
info.diffuse*=computeProjectionTextureDiffuseLighting(projectionLightSampler{X},textureProjectionMatrix{X});
#endif
#endif
#ifdef SHADOW{X}
#ifdef SHADOWCSM{X}
for (int i=0; i<SHADOWCSMNUM_CASCADES{X}; i++) 
{
#ifdef SHADOWCSM_RIGHTHANDED{X}
diff{X}=viewFrustumZ{X}[i]+vPositionFromCamera{X}.z;
#else
diff{X}=viewFrustumZ{X}[i]-vPositionFromCamera{X}.z;
#endif
if (diff{X}>=0.) {
index{X}=i;
break;
}
}
#ifdef SHADOWCSMUSESHADOWMAXZ{X}
if (index{X}>=0)
#endif
{
#if defined(SHADOWPCF{X})
#if defined(SHADOWLOWQUALITY{X})
shadow=computeShadowWithCSMPCF1(float(index{X}),vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],shadowSampler{X},light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);
#elif defined(SHADOWMEDIUMQUALITY{X})
shadow=computeShadowWithCSMPCF3(float(index{X}),vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],shadowSampler{X},light{X}.shadowsInfo.yz,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);
#else
shadow=computeShadowWithCSMPCF5(float(index{X}),vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],shadowSampler{X},light{X}.shadowsInfo.yz,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);
#endif
#elif defined(SHADOWPCSS{X})
#if defined(SHADOWLOWQUALITY{X})
shadow=computeShadowWithCSMPCSS16(float(index{X}),vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],depthSampler{X},shadowSampler{X},light{X}.shadowsInfo.y,light{X}.shadowsInfo.z,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w,lightSizeUVCorrection{X}[index{X}],depthCorrection{X}[index{X}],penumbraDarkness{X});
#elif defined(SHADOWMEDIUMQUALITY{X})
shadow=computeShadowWithCSMPCSS32(float(index{X}),vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],depthSampler{X},shadowSampler{X},light{X}.shadowsInfo.y,light{X}.shadowsInfo.z,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w,lightSizeUVCorrection{X}[index{X}],depthCorrection{X}[index{X}],penumbraDarkness{X});
#else
shadow=computeShadowWithCSMPCSS64(float(index{X}),vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],depthSampler{X},shadowSampler{X},light{X}.shadowsInfo.y,light{X}.shadowsInfo.z,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w,lightSizeUVCorrection{X}[index{X}],depthCorrection{X}[index{X}],penumbraDarkness{X});
#endif
#else
shadow=computeShadowCSM(float(index{X}),vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],shadowSampler{X},light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);
#endif
#ifdef SHADOWCSMDEBUG{X}
shadowDebug{X}=vec3(shadow)*vCascadeColorsMultiplier{X}[index{X}];
#endif
#ifndef SHADOWCSMNOBLEND{X}
float frustumLength=frustumLengths{X}[index{X}];
float diffRatio=clamp(diff{X}/frustumLength,0.,1.)*cascadeBlendFactor{X};
if (index{X}<(SHADOWCSMNUM_CASCADES{X}-1) && diffRatio<1.)
{
index{X}+=1;
float nextShadow=0.;
#if defined(SHADOWPCF{X})
#if defined(SHADOWLOWQUALITY{X})
nextShadow=computeShadowWithCSMPCF1(float(index{X}),vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],shadowSampler{X},light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);
#elif defined(SHADOWMEDIUMQUALITY{X})
nextShadow=computeShadowWithCSMPCF3(float(index{X}),vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],shadowSampler{X},light{X}.shadowsInfo.yz,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);
#else
nextShadow=computeShadowWithCSMPCF5(float(index{X}),vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],shadowSampler{X},light{X}.shadowsInfo.yz,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);
#endif
#elif defined(SHADOWPCSS{X})
#if defined(SHADOWLOWQUALITY{X})
nextShadow=computeShadowWithCSMPCSS16(float(index{X}),vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],depthSampler{X},shadowSampler{X},light{X}.shadowsInfo.y,light{X}.shadowsInfo.z,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w,lightSizeUVCorrection{X}[index{X}],depthCorrection{X}[index{X}],penumbraDarkness{X});
#elif defined(SHADOWMEDIUMQUALITY{X})
nextShadow=computeShadowWithCSMPCSS32(float(index{X}),vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],depthSampler{X},shadowSampler{X},light{X}.shadowsInfo.y,light{X}.shadowsInfo.z,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w,lightSizeUVCorrection{X}[index{X}],depthCorrection{X}[index{X}],penumbraDarkness{X});
#else
nextShadow=computeShadowWithCSMPCSS64(float(index{X}),vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],depthSampler{X},shadowSampler{X},light{X}.shadowsInfo.y,light{X}.shadowsInfo.z,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w,lightSizeUVCorrection{X}[index{X}],depthCorrection{X}[index{X}],penumbraDarkness{X});
#endif
#else
nextShadow=computeShadowCSM(float(index{X}),vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],shadowSampler{X},light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);
#endif
shadow=mix(nextShadow,shadow,diffRatio);
#ifdef SHADOWCSMDEBUG{X}
shadowDebug{X}=mix(vec3(nextShadow)*vCascadeColorsMultiplier{X}[index{X}],shadowDebug{X},diffRatio);
#endif
}
#endif
}
#elif defined(SHADOWCLOSEESM{X})
#if defined(SHADOWCUBE{X})
shadow=computeShadowWithCloseESMCube(light{X}.vLightData.xyz,shadowSampler{X},light{X}.shadowsInfo.x,light{X}.shadowsInfo.z,light{X}.depthValues);
#else
shadow=computeShadowWithCloseESM(vPositionFromLight{X},vDepthMetric{X},shadowSampler{X},light{X}.shadowsInfo.x,light{X}.shadowsInfo.z,light{X}.shadowsInfo.w);
#endif
#elif defined(SHADOWESM{X})
#if defined(SHADOWCUBE{X})
shadow=computeShadowWithESMCube(light{X}.vLightData.xyz,shadowSampler{X},light{X}.shadowsInfo.x,light{X}.shadowsInfo.z,light{X}.depthValues);
#else
shadow=computeShadowWithESM(vPositionFromLight{X},vDepthMetric{X},shadowSampler{X},light{X}.shadowsInfo.x,light{X}.shadowsInfo.z,light{X}.shadowsInfo.w);
#endif
#elif defined(SHADOWPOISSON{X})
#if defined(SHADOWCUBE{X})
shadow=computeShadowWithPoissonSamplingCube(light{X}.vLightData.xyz,shadowSampler{X},light{X}.shadowsInfo.y,light{X}.shadowsInfo.x,light{X}.depthValues);
#else
shadow=computeShadowWithPoissonSampling(vPositionFromLight{X},vDepthMetric{X},shadowSampler{X},light{X}.shadowsInfo.y,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);
#endif
#elif defined(SHADOWPCF{X})
#if defined(SHADOWLOWQUALITY{X})
shadow=computeShadowWithPCF1(vPositionFromLight{X},vDepthMetric{X},shadowSampler{X},light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);
#elif defined(SHADOWMEDIUMQUALITY{X})
shadow=computeShadowWithPCF3(vPositionFromLight{X},vDepthMetric{X},shadowSampler{X},light{X}.shadowsInfo.yz,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);
#else
shadow=computeShadowWithPCF5(vPositionFromLight{X},vDepthMetric{X},shadowSampler{X},light{X}.shadowsInfo.yz,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);
#endif
#elif defined(SHADOWPCSS{X})
#if defined(SHADOWLOWQUALITY{X})
shadow=computeShadowWithPCSS16(vPositionFromLight{X},vDepthMetric{X},depthSampler{X},shadowSampler{X},light{X}.shadowsInfo.y,light{X}.shadowsInfo.z,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);
#elif defined(SHADOWMEDIUMQUALITY{X})
shadow=computeShadowWithPCSS32(vPositionFromLight{X},vDepthMetric{X},depthSampler{X},shadowSampler{X},light{X}.shadowsInfo.y,light{X}.shadowsInfo.z,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);
#else
shadow=computeShadowWithPCSS64(vPositionFromLight{X},vDepthMetric{X},depthSampler{X},shadowSampler{X},light{X}.shadowsInfo.y,light{X}.shadowsInfo.z,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);
#endif
#else
#if defined(SHADOWCUBE{X})
shadow=computeShadowCube(light{X}.vLightData.xyz,shadowSampler{X},light{X}.shadowsInfo.x,light{X}.depthValues);
#else
shadow=computeShadow(vPositionFromLight{X},vDepthMetric{X},shadowSampler{X},light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);
#endif
#endif
#ifdef SHADOWONLY
#ifndef SHADOWINUSE
#define SHADOWINUSE
#endif
globalShadow+=shadow;
shadowLightCount+=1.0;
#endif
#else
shadow=1.;
#endif
#ifndef SHADOWONLY
#ifdef CUSTOMUSERLIGHTING
diffuseBase+=computeCustomDiffuseLighting(info,diffuseBase,shadow);
#ifdef SPECULARTERM
specularBase+=computeCustomSpecularLighting(info,specularBase,shadow);
#endif
#elif defined(LIGHTMAP) && defined(LIGHTMAPEXCLUDED{X})
diffuseBase+=lightmapColor.rgb*shadow;
#ifdef SPECULARTERM
#ifndef LIGHTMAPNOSPECULAR{X}
specularBase+=info.specular*shadow*lightmapColor.rgb;
#endif
#endif
#ifdef CLEARCOAT
#ifndef LIGHTMAPNOSPECULAR{X}
clearCoatBase+=info.clearCoat.rgb*shadow*lightmapColor.rgb;
#endif
#endif
#ifdef SHEEN
#ifndef LIGHTMAPNOSPECULAR{X}
sheenBase+=info.sheen.rgb*shadow;
#endif
#endif
#else
#ifdef SHADOWCSMDEBUG{X}
diffuseBase+=info.diffuse*shadowDebug{X};
#else 
diffuseBase+=info.diffuse*shadow;
#endif
#ifdef SPECULARTERM
specularBase+=info.specular*shadow;
#endif
#ifdef CLEARCOAT
clearCoatBase+=info.clearCoat.rgb*shadow;
#endif
#ifdef SHEEN
sheenBase+=info.sheen.rgb*shadow;
#endif
#endif
#endif
#endif
`;q.IncludesShadersStore[pf]=_f;var vf="logDepthFragment",gf=`#ifdef LOGARITHMICDEPTH
gl_FragDepthEXT=log2(vFragmentDepth)*logarithmicDepthConstant*0.5;
#endif
`;q.IncludesShadersStore[vf]=gf;var mf="fogFragment",yf=`#ifdef FOG
float fog=CalcFogFactor();
#ifdef PBR
fog=toLinearSpace(fog);
#endif
color.rgb=mix(vFogColor,color.rgb,fog);
#endif
`;q.IncludesShadersStore[mf]=yf;var bf="defaultPixelShader",Tf=`#include<__decl__defaultFragment>
#if defined(BUMP) || !defined(NORMAL)
#extension GL_OES_standard_derivatives : enable
#endif
#include<prePassDeclaration>[SCENE_MRT_COUNT]
#include<oitDeclaration>
#define CUSTOM_FRAGMENT_BEGIN
#ifdef LOGARITHMICDEPTH
#extension GL_EXT_frag_depth : enable
#endif
#define RECIPROCAL_PI2 0.15915494
varying vec3 vPositionW;
#ifdef NORMAL
varying vec3 vNormalW;
#endif
#if defined(VERTEXCOLOR) || defined(INSTANCESCOLOR)
varying vec4 vColor;
#endif
#include<mainUVVaryingDeclaration>[1..7]
#include<helperFunctions>
#include<__decl__lightFragment>[0..maxSimultaneousLights]
#include<lightsFragmentFunctions>
#include<shadowsFragmentFunctions>
#include<samplerFragmentDeclaration>(_DEFINENAME_,DIFFUSE,_VARYINGNAME_,Diffuse,_SAMPLERNAME_,diffuse)
#include<samplerFragmentDeclaration>(_DEFINENAME_,AMBIENT,_VARYINGNAME_,Ambient,_SAMPLERNAME_,ambient)
#include<samplerFragmentDeclaration>(_DEFINENAME_,OPACITY,_VARYINGNAME_,Opacity,_SAMPLERNAME_,opacity)
#include<samplerFragmentDeclaration>(_DEFINENAME_,EMISSIVE,_VARYINGNAME_,Emissive,_SAMPLERNAME_,emissive)
#include<samplerFragmentDeclaration>(_DEFINENAME_,LIGHTMAP,_VARYINGNAME_,Lightmap,_SAMPLERNAME_,lightmap)
#ifdef REFRACTION
#ifdef REFRACTIONMAP_3D
uniform samplerCube refractionCubeSampler;
#else
uniform sampler2D refraction2DSampler;
#endif
#endif
#if defined(SPECULARTERM)
#include<samplerFragmentDeclaration>(_DEFINENAME_,SPECULAR,_VARYINGNAME_,Specular,_SAMPLERNAME_,specular)
#endif
#include<fresnelFunction>
#ifdef REFLECTION
#ifdef REFLECTIONMAP_3D
uniform samplerCube reflectionCubeSampler;
#else
uniform sampler2D reflection2DSampler;
#endif
#ifdef REFLECTIONMAP_SKYBOX
varying vec3 vPositionUVW;
#else
#if defined(REFLECTIONMAP_EQUIRECTANGULAR_FIXED) || defined(REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED)
varying vec3 vDirectionW;
#endif
#endif
#include<reflectionFunction>
#endif
#include<imageProcessingDeclaration>
#include<imageProcessingFunctions>
#include<bumpFragmentMainFunctions>
#include<bumpFragmentFunctions>
#include<clipPlaneFragmentDeclaration>
#include<logDepthDeclaration>
#include<fogFragmentDeclaration>
#define CUSTOM_FRAGMENT_DEFINITIONS
void main(void) {
#define CUSTOM_FRAGMENT_MAIN_BEGIN
#include<oitFragment>
#include<clipPlaneFragment>
vec3 viewDirectionW=normalize(vEyePosition.xyz-vPositionW);
vec4 baseColor=vec4(1.,1.,1.,1.);
vec3 diffuseColor=vDiffuseColor.rgb;
float alpha=vDiffuseColor.a;
#ifdef NORMAL
vec3 normalW=normalize(vNormalW);
#else
vec3 normalW=normalize(-cross(dFdx(vPositionW),dFdy(vPositionW)));
#endif
#include<bumpFragment>
#ifdef TWOSIDEDLIGHTING
normalW=gl_FrontFacing ? normalW : -normalW;
#endif
#ifdef DIFFUSE
baseColor=texture2D(diffuseSampler,vDiffuseUV+uvOffset);
#if defined(ALPHATEST) && !defined(ALPHATEST_AFTERALLALPHACOMPUTATIONS)
if (baseColor.a<alphaCutOff)
discard;
#endif
#ifdef ALPHAFROMDIFFUSE
alpha*=baseColor.a;
#endif
#define CUSTOM_FRAGMENT_UPDATE_ALPHA
baseColor.rgb*=vDiffuseInfos.y;
#endif
#include<depthPrePass>
#if defined(VERTEXCOLOR) || defined(INSTANCESCOLOR)
baseColor.rgb*=vColor.rgb;
#endif
#ifdef DETAIL
baseColor.rgb=baseColor.rgb*2.0*mix(0.5,detailColor.r,vDetailInfos.y);
#endif
#define CUSTOM_FRAGMENT_UPDATE_DIFFUSE
vec3 baseAmbientColor=vec3(1.,1.,1.);
#ifdef AMBIENT
baseAmbientColor=texture2D(ambientSampler,vAmbientUV+uvOffset).rgb*vAmbientInfos.y;
#endif
#define CUSTOM_FRAGMENT_BEFORE_LIGHTS
#ifdef SPECULARTERM
float glossiness=vSpecularColor.a;
vec3 specularColor=vSpecularColor.rgb;
#ifdef SPECULAR
vec4 specularMapColor=texture2D(specularSampler,vSpecularUV+uvOffset);
specularColor=specularMapColor.rgb;
#ifdef GLOSSINESS
glossiness=glossiness*specularMapColor.a;
#endif
#endif
#else
float glossiness=0.;
#endif
vec3 diffuseBase=vec3(0.,0.,0.);
lightingInfo info;
#ifdef SPECULARTERM
vec3 specularBase=vec3(0.,0.,0.);
#endif
float shadow=1.;
#ifdef LIGHTMAP
vec4 lightmapColor=texture2D(lightmapSampler,vLightmapUV+uvOffset);
#ifdef RGBDLIGHTMAP
lightmapColor.rgb=fromRGBD(lightmapColor);
#endif
lightmapColor.rgb*=vLightmapInfos.y;
#endif
#include<lightFragment>[0..maxSimultaneousLights]
vec4 refractionColor=vec4(0.,0.,0.,1.);
#ifdef REFRACTION
vec3 refractionVector=normalize(refract(-viewDirectionW,normalW,vRefractionInfos.y));
#ifdef REFRACTIONMAP_3D
#ifdef USE_LOCAL_REFRACTIONMAP_CUBIC
refractionVector=parallaxCorrectNormal(vPositionW,refractionVector,vRefractionSize,vRefractionPosition);
#endif
refractionVector.y=refractionVector.y*vRefractionInfos.w;
if (dot(refractionVector,viewDirectionW)<1.0) {
refractionColor=textureCube(refractionCubeSampler,refractionVector);
}
#else
vec3 vRefractionUVW=vec3(refractionMatrix*(view*vec4(vPositionW+refractionVector*vRefractionInfos.z,1.0)));
vec2 refractionCoords=vRefractionUVW.xy/vRefractionUVW.z;
refractionCoords.y=1.0-refractionCoords.y;
refractionColor=texture2D(refraction2DSampler,refractionCoords);
#endif
#ifdef RGBDREFRACTION
refractionColor.rgb=fromRGBD(refractionColor);
#endif
#ifdef IS_REFRACTION_LINEAR
refractionColor.rgb=toGammaSpace(refractionColor.rgb);
#endif
refractionColor.rgb*=vRefractionInfos.x;
#endif
vec4 reflectionColor=vec4(0.,0.,0.,1.);
#ifdef REFLECTION
vec3 vReflectionUVW=computeReflectionCoords(vec4(vPositionW,1.0),normalW);
#ifdef REFLECTIONMAP_OPPOSITEZ
vReflectionUVW.z*=-1.0;
#endif
#ifdef REFLECTIONMAP_3D
#ifdef ROUGHNESS
float bias=vReflectionInfos.y;
#ifdef SPECULARTERM
#ifdef SPECULAR
#ifdef GLOSSINESS
bias*=(1.0-specularMapColor.a);
#endif
#endif
#endif
reflectionColor=textureCube(reflectionCubeSampler,vReflectionUVW,bias);
#else
reflectionColor=textureCube(reflectionCubeSampler,vReflectionUVW);
#endif
#else
vec2 coords=vReflectionUVW.xy;
#ifdef REFLECTIONMAP_PROJECTION
coords/=vReflectionUVW.z;
#endif
coords.y=1.0-coords.y;
reflectionColor=texture2D(reflection2DSampler,coords);
#endif
#ifdef RGBDREFLECTION
reflectionColor.rgb=fromRGBD(reflectionColor);
#endif
#ifdef IS_REFLECTION_LINEAR
reflectionColor.rgb=toGammaSpace(reflectionColor.rgb);
#endif
reflectionColor.rgb*=vReflectionInfos.x;
#ifdef REFLECTIONFRESNEL
float reflectionFresnelTerm=computeFresnelTerm(viewDirectionW,normalW,reflectionRightColor.a,reflectionLeftColor.a);
#ifdef REFLECTIONFRESNELFROMSPECULAR
#ifdef SPECULARTERM
reflectionColor.rgb*=specularColor.rgb*(1.0-reflectionFresnelTerm)+reflectionFresnelTerm*reflectionRightColor.rgb;
#else
reflectionColor.rgb*=reflectionLeftColor.rgb*(1.0-reflectionFresnelTerm)+reflectionFresnelTerm*reflectionRightColor.rgb;
#endif
#else
reflectionColor.rgb*=reflectionLeftColor.rgb*(1.0-reflectionFresnelTerm)+reflectionFresnelTerm*reflectionRightColor.rgb;
#endif
#endif
#endif
#ifdef REFRACTIONFRESNEL
float refractionFresnelTerm=computeFresnelTerm(viewDirectionW,normalW,refractionRightColor.a,refractionLeftColor.a);
refractionColor.rgb*=refractionLeftColor.rgb*(1.0-refractionFresnelTerm)+refractionFresnelTerm*refractionRightColor.rgb;
#endif
#ifdef OPACITY
vec4 opacityMap=texture2D(opacitySampler,vOpacityUV+uvOffset);
#ifdef OPACITYRGB
opacityMap.rgb=opacityMap.rgb*vec3(0.3,0.59,0.11);
alpha*=(opacityMap.x+opacityMap.y+opacityMap.z)* vOpacityInfos.y;
#else
alpha*=opacityMap.a*vOpacityInfos.y;
#endif
#endif
#ifdef VERTEXALPHA
alpha*=vColor.a;
#endif
#ifdef OPACITYFRESNEL
float opacityFresnelTerm=computeFresnelTerm(viewDirectionW,normalW,opacityParts.z,opacityParts.w);
alpha+=opacityParts.x*(1.0-opacityFresnelTerm)+opacityFresnelTerm*opacityParts.y;
#endif
#ifdef ALPHATEST
#ifdef ALPHATEST_AFTERALLALPHACOMPUTATIONS
if (alpha<alphaCutOff)
discard;
#endif
#ifndef ALPHABLEND
alpha=1.0;
#endif
#endif
vec3 emissiveColor=vEmissiveColor;
#ifdef EMISSIVE
emissiveColor+=texture2D(emissiveSampler,vEmissiveUV+uvOffset).rgb*vEmissiveInfos.y;
#endif
#ifdef EMISSIVEFRESNEL
float emissiveFresnelTerm=computeFresnelTerm(viewDirectionW,normalW,emissiveRightColor.a,emissiveLeftColor.a);
emissiveColor*=emissiveLeftColor.rgb*(1.0-emissiveFresnelTerm)+emissiveFresnelTerm*emissiveRightColor.rgb;
#endif
#ifdef DIFFUSEFRESNEL
float diffuseFresnelTerm=computeFresnelTerm(viewDirectionW,normalW,diffuseRightColor.a,diffuseLeftColor.a);
diffuseBase*=diffuseLeftColor.rgb*(1.0-diffuseFresnelTerm)+diffuseFresnelTerm*diffuseRightColor.rgb;
#endif
#ifdef EMISSIVEASILLUMINATION
vec3 finalDiffuse=clamp(diffuseBase*diffuseColor+vAmbientColor,0.0,1.0)*baseColor.rgb;
#else
#ifdef LINKEMISSIVEWITHDIFFUSE
vec3 finalDiffuse=clamp((diffuseBase+emissiveColor)*diffuseColor+vAmbientColor,0.0,1.0)*baseColor.rgb;
#else
vec3 finalDiffuse=clamp(diffuseBase*diffuseColor+emissiveColor+vAmbientColor,0.0,1.0)*baseColor.rgb;
#endif
#endif
#ifdef SPECULARTERM
vec3 finalSpecular=specularBase*specularColor;
#ifdef SPECULAROVERALPHA
alpha=clamp(alpha+dot(finalSpecular,vec3(0.3,0.59,0.11)),0.,1.);
#endif
#else
vec3 finalSpecular=vec3(0.0);
#endif
#ifdef REFLECTIONOVERALPHA
alpha=clamp(alpha+dot(reflectionColor.rgb,vec3(0.3,0.59,0.11)),0.,1.);
#endif
#ifdef EMISSIVEASILLUMINATION
vec4 color=vec4(clamp(finalDiffuse*baseAmbientColor+finalSpecular+reflectionColor.rgb+emissiveColor+refractionColor.rgb,0.0,1.0),alpha);
#else
vec4 color=vec4(finalDiffuse*baseAmbientColor+finalSpecular+reflectionColor.rgb+refractionColor.rgb,alpha);
#endif
#ifdef LIGHTMAP
#ifndef LIGHTMAPEXCLUDED
#ifdef USELIGHTMAPASSHADOWMAP
color.rgb*=lightmapColor.rgb;
#else
color.rgb+=lightmapColor.rgb;
#endif
#endif
#endif
#define CUSTOM_FRAGMENT_BEFORE_FOG
color.rgb=max(color.rgb,0.);
#include<logDepthFragment>
#include<fogFragment>
#ifdef IMAGEPROCESSINGPOSTPROCESS
color.rgb=toLinearSpace(color.rgb);
#else
#ifdef IMAGEPROCESSING
color.rgb=toLinearSpace(color.rgb);
color=applyImageProcessing(color);
#endif
#endif
color.a*=visibility;
#ifdef PREMULTIPLYALPHA
color.rgb*=color.a;
#endif
#define CUSTOM_FRAGMENT_BEFORE_FRAGCOLOR
#ifdef PREPASS
float writeGeometryInfo=color.a>0.4 ? 1.0 : 0.0;
gl_FragData[0]=color; 
#ifdef PREPASS_POSITION
gl_FragData[PREPASS_POSITION_INDEX]=vec4(vPositionW,writeGeometryInfo);
#endif
#ifdef PREPASS_VELOCITY
vec2 a=(vCurrentPosition.xy/vCurrentPosition.w)*0.5+0.5;
vec2 b=(vPreviousPosition.xy/vPreviousPosition.w)*0.5+0.5;
vec2 velocity=abs(a-b);
velocity=vec2(pow(velocity.x,1.0/3.0),pow(velocity.y,1.0/3.0))*sign(a-b)*0.5+0.5;
gl_FragData[PREPASS_VELOCITY_INDEX]=vec4(velocity,0.0,writeGeometryInfo);
#endif
#ifdef PREPASS_IRRADIANCE
gl_FragData[PREPASS_IRRADIANCE_INDEX]=vec4(0.0,0.0,0.0,writeGeometryInfo); 
#endif
#ifdef PREPASS_DEPTH
gl_FragData[PREPASS_DEPTH_INDEX]=vec4(vViewPos.z,0.0,0.0,writeGeometryInfo); 
#endif
#ifdef PREPASS_NORMAL
gl_FragData[PREPASS_NORMAL_INDEX]=vec4((view*vec4(normalW,0.0)).rgb,writeGeometryInfo); 
#endif
#ifdef PREPASS_ALBEDO_SQRT
gl_FragData[PREPASS_ALBEDO_SQRT_INDEX]=vec4(0.0,0.0,0.0,writeGeometryInfo); 
#endif
#ifdef PREPASS_REFLECTIVITY
#if defined(SPECULAR)
gl_FragData[PREPASS_REFLECTIVITY_INDEX]=vec4(specularMapColor.rgb,specularMapColor.a*writeGeometryInfo);
#else
gl_FragData[PREPASS_REFLECTIVITY_INDEX]=vec4(0.0,0.0,0.0,writeGeometryInfo);
#endif
#endif
#endif
#if !defined(PREPASS) || defined(WEBGL2)
gl_FragColor=color;
#endif
#if ORDER_INDEPENDENT_TRANSPARENCY
if (fragDepth==nearestDepth) {
frontColor.rgb+=color.rgb*color.a*alphaMultiplier;
frontColor.a=1.0-alphaMultiplier*(1.0-color.a);
} else {
backColor+=color;
}
#endif
#define CUSTOM_FRAGMENT_MAIN_END
}
`;q.ShadersStore[bf]=Tf;var Ef="defaultVertexDeclaration",Af=`uniform mat4 viewProjection;
uniform mat4 view;
#ifdef DIFFUSE
uniform mat4 diffuseMatrix;
uniform vec2 vDiffuseInfos;
#endif
#ifdef AMBIENT
uniform mat4 ambientMatrix;
uniform vec2 vAmbientInfos;
#endif
#ifdef OPACITY
uniform mat4 opacityMatrix;
uniform vec2 vOpacityInfos;
#endif
#ifdef EMISSIVE
uniform vec2 vEmissiveInfos;
uniform mat4 emissiveMatrix;
#endif
#ifdef LIGHTMAP
uniform vec2 vLightmapInfos;
uniform mat4 lightmapMatrix;
#endif
#if defined(SPECULAR) && defined(SPECULARTERM)
uniform vec2 vSpecularInfos;
uniform mat4 specularMatrix;
#endif
#ifdef BUMP
uniform vec3 vBumpInfos;
uniform mat4 bumpMatrix;
#endif
#ifdef REFLECTION
uniform mat4 reflectionMatrix;
#endif
#ifdef POINTSIZE
uniform float pointSize;
#endif
#ifdef DETAIL
uniform vec4 vDetailInfos;
uniform mat4 detailMatrix;
#endif
#define ADDITIONAL_VERTEX_DECLARATION
`;q.IncludesShadersStore[Ef]=Af;var Sf="uvAttributeDeclaration",Rf=`#ifdef UV{X}
attribute vec2 uv{X};
#endif
`;q.IncludesShadersStore[Sf]=Rf;var Pf="prePassVertexDeclaration",Mf=`#ifdef PREPASS
#ifdef PREPASS_DEPTH
varying vec3 vViewPos;
#endif
#ifdef PREPASS_VELOCITY
uniform mat4 previousViewProjection;
varying vec4 vCurrentPosition;
varying vec4 vPreviousPosition;
#endif
#endif
`;q.IncludesShadersStore[Pf]=Mf;var Cf="samplerVertexDeclaration",xf=`#if defined(_DEFINENAME_) && _DEFINENAME_DIRECTUV==0
varying vec2 v_VARYINGNAME_UV;
#endif
`;q.IncludesShadersStore[Cf]=xf;var Df="bumpVertexDeclaration",Of=`#if defined(BUMP) || defined(PARALLAX) || defined(CLEARCOAT_BUMP) || defined(ANISOTROPIC)
#if defined(TANGENT) && defined(NORMAL) 
varying mat3 vTBN;
#endif
#endif
`;q.IncludesShadersStore[Df]=Of;var If="fogVertexDeclaration",Ff=`#ifdef FOG
varying vec3 vFogDistance;
#endif
`;q.IncludesShadersStore[If]=Ff;var wf="lightVxFragmentDeclaration",Lf=`#ifdef LIGHT{X}
uniform vec4 vLightData{X};
uniform vec4 vLightDiffuse{X};
#ifdef SPECULARTERM
uniform vec4 vLightSpecular{X};
#else
vec4 vLightSpecular{X}=vec4(0.);
#endif
#ifdef SHADOW{X}
#ifdef SHADOWCSM{X}
uniform mat4 lightMatrix{X}[SHADOWCSMNUM_CASCADES{X}];
varying vec4 vPositionFromLight{X}[SHADOWCSMNUM_CASCADES{X}];
varying float vDepthMetric{X}[SHADOWCSMNUM_CASCADES{X}];
varying vec4 vPositionFromCamera{X};
#elif defined(SHADOWCUBE{X})
#else
varying vec4 vPositionFromLight{X};
varying float vDepthMetric{X};
uniform mat4 lightMatrix{X};
#endif
uniform vec4 shadowsInfo{X};
uniform vec2 depthValues{X};
#endif
#ifdef SPOTLIGHT{X}
uniform vec4 vLightDirection{X};
uniform vec4 vLightFalloff{X};
#elif defined(POINTLIGHT{X})
uniform vec4 vLightFalloff{X};
#elif defined(HEMILIGHT{X})
uniform vec3 vLightGround{X};
#endif
#endif
`;q.IncludesShadersStore[wf]=Lf;var Nf="lightVxUboDeclaration",Bf=`#ifdef LIGHT{X}
uniform Light{X}
{
vec4 vLightData;
vec4 vLightDiffuse;
vec4 vLightSpecular;
#ifdef SPOTLIGHT{X}
vec4 vLightDirection;
vec4 vLightFalloff;
#elif defined(POINTLIGHT{X})
vec4 vLightFalloff;
#elif defined(HEMILIGHT{X})
vec3 vLightGround;
#endif
vec4 shadowsInfo;
vec2 depthValues;
} light{X};
#ifdef SHADOW{X}
#ifdef SHADOWCSM{X}
uniform mat4 lightMatrix{X}[SHADOWCSMNUM_CASCADES{X}];
varying vec4 vPositionFromLight{X}[SHADOWCSMNUM_CASCADES{X}];
varying float vDepthMetric{X}[SHADOWCSMNUM_CASCADES{X}];
varying vec4 vPositionFromCamera{X};
#elif defined(SHADOWCUBE{X})
#else
varying vec4 vPositionFromLight{X};
varying float vDepthMetric{X};
uniform mat4 lightMatrix{X};
#endif
#endif
#endif
`;q.IncludesShadersStore[Nf]=Bf;var Uf="morphTargetsVertexGlobalDeclaration",Vf=`#ifdef MORPHTARGETS
uniform float morphTargetInfluences[NUM_MORPH_INFLUENCERS];
#ifdef MORPHTARGETS_TEXTURE 
precision mediump sampler2DArray; 
uniform float morphTargetTextureIndices[NUM_MORPH_INFLUENCERS];
uniform vec3 morphTargetTextureInfo;
uniform sampler2DArray morphTargets;
vec3 readVector3FromRawSampler(int targetIndex,float vertexIndex)
{ 
float y=floor(vertexIndex/morphTargetTextureInfo.y);
float x=vertexIndex-y*morphTargetTextureInfo.y;
vec3 textureUV=vec3((x+0.5)/morphTargetTextureInfo.y,(y+0.5)/morphTargetTextureInfo.z,morphTargetTextureIndices[targetIndex]);
return texture(morphTargets,textureUV).xyz;
}
#endif
#endif
`;q.IncludesShadersStore[Uf]=Vf;var kf="morphTargetsVertexDeclaration",Gf=`#ifdef MORPHTARGETS
#ifndef MORPHTARGETS_TEXTURE
attribute vec3 position{X};
#ifdef MORPHTARGETS_NORMAL
attribute vec3 normal{X};
#endif
#ifdef MORPHTARGETS_TANGENT
attribute vec3 tangent{X};
#endif
#ifdef MORPHTARGETS_UV
attribute vec2 uv_{X};
#endif
#endif
#endif
`;q.IncludesShadersStore[kf]=Gf;var zf="morphTargetsVertexGlobal",Wf=`#ifdef MORPHTARGETS
#ifdef MORPHTARGETS_TEXTURE
float vertexID;
#endif
#endif
`;q.IncludesShadersStore[zf]=Wf;var Hf="morphTargetsVertex",Xf=`#ifdef MORPHTARGETS
#ifdef MORPHTARGETS_TEXTURE 
vertexID=float(gl_VertexID)*morphTargetTextureInfo.x;
positionUpdated+=(readVector3FromRawSampler({X},vertexID)-position)*morphTargetInfluences[{X}];
vertexID+=1.0;
#ifdef MORPHTARGETS_NORMAL
normalUpdated+=(readVector3FromRawSampler({X},vertexID) -normal)*morphTargetInfluences[{X}];
vertexID+=1.0;
#endif
#ifdef MORPHTARGETS_UV
uvUpdated+=(readVector3FromRawSampler({X},vertexID).xy-uv)*morphTargetInfluences[{X}];
vertexID+=1.0;
#endif
#ifdef MORPHTARGETS_TANGENT
tangentUpdated.xyz+=(readVector3FromRawSampler({X},vertexID) -tangent.xyz)*morphTargetInfluences[{X}];
#endif
#else
positionUpdated+=(position{X}-position)*morphTargetInfluences[{X}];
#ifdef MORPHTARGETS_NORMAL
normalUpdated+=(normal{X}-normal)*morphTargetInfluences[{X}];
#endif
#ifdef MORPHTARGETS_TANGENT
tangentUpdated.xyz+=(tangent{X}-tangent.xyz)*morphTargetInfluences[{X}];
#endif
#ifdef MORPHTARGETS_UV
uvUpdated+=(uv_{X}-uv)*morphTargetInfluences[{X}];
#endif
#endif
#endif
`;q.IncludesShadersStore[Hf]=Xf;var jf="prePassVertex",Kf=`#ifdef PREPASS_DEPTH
vViewPos=(view*worldPos).rgb;
#endif
#if defined(PREPASS_VELOCITY) && defined(BONES_VELOCITY_ENABLED)
vCurrentPosition=viewProjection*worldPos;
#if NUM_BONE_INFLUENCERS>0
mat4 previousInfluence;
previousInfluence=mPreviousBones[int(matricesIndices[0])]*matricesWeights[0];
#if NUM_BONE_INFLUENCERS>1
previousInfluence+=mPreviousBones[int(matricesIndices[1])]*matricesWeights[1];
#endif 
#if NUM_BONE_INFLUENCERS>2
previousInfluence+=mPreviousBones[int(matricesIndices[2])]*matricesWeights[2];
#endif 
#if NUM_BONE_INFLUENCERS>3
previousInfluence+=mPreviousBones[int(matricesIndices[3])]*matricesWeights[3];
#endif
#if NUM_BONE_INFLUENCERS>4
previousInfluence+=mPreviousBones[int(matricesIndicesExtra[0])]*matricesWeightsExtra[0];
#endif 
#if NUM_BONE_INFLUENCERS>5
previousInfluence+=mPreviousBones[int(matricesIndicesExtra[1])]*matricesWeightsExtra[1];
#endif 
#if NUM_BONE_INFLUENCERS>6
previousInfluence+=mPreviousBones[int(matricesIndicesExtra[2])]*matricesWeightsExtra[2];
#endif 
#if NUM_BONE_INFLUENCERS>7
previousInfluence+=mPreviousBones[int(matricesIndicesExtra[3])]*matricesWeightsExtra[3];
#endif
vPreviousPosition=previousViewProjection*finalPreviousWorld*previousInfluence*vec4(positionUpdated,1.0);
#else
vPreviousPosition=previousViewProjection*finalPreviousWorld*vec4(positionUpdated,1.0);
#endif
#endif
`;q.IncludesShadersStore[jf]=Kf;var Yf="uvVariableDeclaration",qf=`#if !defined(UV{X}) && defined(MAINUV{X})
vec2 uv{X}=vec2(0.,0.);
#endif
#ifdef MAINUV{X}
vMainUV{X}=uv{X};
#endif
`;q.IncludesShadersStore[Yf]=qf;var Zf="samplerVertexImplementation",Qf=`#if defined(_DEFINENAME_) && _DEFINENAME_DIRECTUV==0
if (v_INFONAME_==0.)
{
v_VARYINGNAME_UV=vec2(_MATRIXNAME_Matrix*vec4(uvUpdated,1.0,0.0));
}
#ifdef UV2
else if (v_INFONAME_==1.)
{
v_VARYINGNAME_UV=vec2(_MATRIXNAME_Matrix*vec4(uv2,1.0,0.0));
}
#endif
#ifdef UV3
else if (v_INFONAME_==2.)
{
v_VARYINGNAME_UV=vec2(_MATRIXNAME_Matrix*vec4(uv3,1.0,0.0));
}
#endif
#ifdef UV4
else if (v_INFONAME_==3.)
{
v_VARYINGNAME_UV=vec2(_MATRIXNAME_Matrix*vec4(uv4,1.0,0.0));
}
#endif
#ifdef UV5
else if (v_INFONAME_==4.)
{
v_VARYINGNAME_UV=vec2(_MATRIXNAME_Matrix*vec4(uv5,1.0,0.0));
}
#endif
#ifdef UV6
else if (v_INFONAME_==5.)
{
v_VARYINGNAME_UV=vec2(_MATRIXNAME_Matrix*vec4(uv6,1.0,0.0));
}
#endif
#endif
`;q.IncludesShadersStore[Zf]=Qf;var $f="bumpVertex",Jf=`#if defined(BUMP) || defined(PARALLAX) || defined(CLEARCOAT_BUMP) || defined(ANISOTROPIC)
#if defined(TANGENT) && defined(NORMAL)
vec3 tbnNormal=normalize(normalUpdated);
vec3 tbnTangent=normalize(tangentUpdated.xyz);
vec3 tbnBitangent=cross(tbnNormal,tbnTangent)*tangentUpdated.w;
vTBN=mat3(finalWorld)*mat3(tbnTangent,tbnBitangent,tbnNormal);
#endif
#endif
`;q.IncludesShadersStore[$f]=Jf;var eh="fogVertex",th=`#ifdef FOG
vFogDistance=(view*worldPos).xyz;
#endif
`;q.IncludesShadersStore[eh]=th;var rh="shadowsVertex",ih=`#ifdef SHADOWS
#if defined(SHADOWCSM{X})
vPositionFromCamera{X}=view*worldPos;
for (int i=0; i<SHADOWCSMNUM_CASCADES{X}; i++) {
vPositionFromLight{X}[i]=lightMatrix{X}[i]*worldPos;
#ifdef USE_REVERSE_DEPTHBUFFER
vDepthMetric{X}[i]=(-vPositionFromLight{X}[i].z+light{X}.depthValues.x)/light{X}.depthValues.y;
#else
vDepthMetric{X}[i]=(vPositionFromLight{X}[i].z+light{X}.depthValues.x)/light{X}.depthValues.y;
#endif
}
#elif defined(SHADOW{X}) && !defined(SHADOWCUBE{X})
vPositionFromLight{X}=lightMatrix{X}*worldPos;
#ifdef USE_REVERSE_DEPTHBUFFER
vDepthMetric{X}=(-vPositionFromLight{X}.z+light{X}.depthValues.x)/light{X}.depthValues.y;
#else
vDepthMetric{X}=(vPositionFromLight{X}.z+light{X}.depthValues.x)/light{X}.depthValues.y;
#endif
#endif
#endif
`;q.IncludesShadersStore[rh]=ih;var nh="pointCloudVertex",ah=`#if defined(POINTSIZE) && !defined(WEBGPU)
gl_PointSize=pointSize;
#endif
`;q.IncludesShadersStore[nh]=ah;var sh="logDepthVertex",oh=`#ifdef LOGARITHMICDEPTH
vFragmentDepth=1.0+gl_Position.w;
gl_Position.z=log2(max(0.000001,vFragmentDepth))*logarithmicDepthConstant;
#endif
`;q.IncludesShadersStore[sh]=oh;var lh="defaultVertexShader",uh=`#include<__decl__defaultVertex>
#define CUSTOM_VERTEX_BEGIN
attribute vec3 position;
#ifdef NORMAL
attribute vec3 normal;
#endif
#ifdef TANGENT
attribute vec4 tangent;
#endif
#ifdef UV1
attribute vec2 uv;
#endif
#include<uvAttributeDeclaration>[2..7]
#ifdef VERTEXCOLOR
attribute vec4 color;
#endif
#include<helperFunctions>
#include<bonesDeclaration>
#include<bakedVertexAnimationDeclaration>
#include<instancesDeclaration>
#include<prePassVertexDeclaration>
#include<mainUVVaryingDeclaration>[1..7]
#include<samplerVertexDeclaration>(_DEFINENAME_,DIFFUSE,_VARYINGNAME_,Diffuse)
#include<samplerVertexDeclaration>(_DEFINENAME_,DETAIL,_VARYINGNAME_,Detail)
#include<samplerVertexDeclaration>(_DEFINENAME_,AMBIENT,_VARYINGNAME_,Ambient)
#include<samplerVertexDeclaration>(_DEFINENAME_,OPACITY,_VARYINGNAME_,Opacity)
#include<samplerVertexDeclaration>(_DEFINENAME_,EMISSIVE,_VARYINGNAME_,Emissive)
#include<samplerVertexDeclaration>(_DEFINENAME_,LIGHTMAP,_VARYINGNAME_,Lightmap)
#if defined(SPECULARTERM)
#include<samplerVertexDeclaration>(_DEFINENAME_,SPECULAR,_VARYINGNAME_,Specular)
#endif
#include<samplerVertexDeclaration>(_DEFINENAME_,BUMP,_VARYINGNAME_,Bump)
varying vec3 vPositionW;
#ifdef NORMAL
varying vec3 vNormalW;
#endif
#if defined(VERTEXCOLOR) || defined(INSTANCESCOLOR)
varying vec4 vColor;
#endif
#include<bumpVertexDeclaration>
#include<clipPlaneVertexDeclaration>
#include<fogVertexDeclaration>
#include<__decl__lightVxFragment>[0..maxSimultaneousLights]
#include<morphTargetsVertexGlobalDeclaration>
#include<morphTargetsVertexDeclaration>[0..maxSimultaneousMorphTargets]
#ifdef REFLECTIONMAP_SKYBOX
varying vec3 vPositionUVW;
#endif
#if defined(REFLECTIONMAP_EQUIRECTANGULAR_FIXED) || defined(REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED)
varying vec3 vDirectionW;
#endif
#include<logDepthDeclaration>
#define CUSTOM_VERTEX_DEFINITIONS
void main(void) {
#define CUSTOM_VERTEX_MAIN_BEGIN
vec3 positionUpdated=position;
#ifdef NORMAL
vec3 normalUpdated=normal;
#endif
#ifdef TANGENT
vec4 tangentUpdated=tangent;
#endif
#ifdef UV1
vec2 uvUpdated=uv;
#endif
#include<morphTargetsVertexGlobal>
#include<morphTargetsVertex>[0..maxSimultaneousMorphTargets]
#ifdef REFLECTIONMAP_SKYBOX
vPositionUVW=positionUpdated;
#endif
#define CUSTOM_VERTEX_UPDATE_POSITION
#define CUSTOM_VERTEX_UPDATE_NORMAL
#include<instancesVertex>
#if defined(PREPASS) && defined(PREPASS_VELOCITY) && !defined(BONES_VELOCITY_ENABLED)
vCurrentPosition=viewProjection*finalWorld*vec4(positionUpdated,1.0);
vPreviousPosition=previousViewProjection*finalPreviousWorld*vec4(positionUpdated,1.0);
#endif
#include<bonesVertex>
#include<bakedVertexAnimation>
vec4 worldPos=finalWorld*vec4(positionUpdated,1.0);
#ifdef NORMAL
mat3 normalWorld=mat3(finalWorld);
#if defined(INSTANCES) && defined(THIN_INSTANCES)
vNormalW=normalUpdated/vec3(dot(normalWorld[0],normalWorld[0]),dot(normalWorld[1],normalWorld[1]),dot(normalWorld[2],normalWorld[2]));
vNormalW=normalize(normalWorld*vNormalW);
#else
#ifdef NONUNIFORMSCALING
normalWorld=transposeMat3(inverseMat3(normalWorld));
#endif
vNormalW=normalize(normalWorld*normalUpdated);
#endif
#endif
#define CUSTOM_VERTEX_UPDATE_WORLDPOS
#ifdef MULTIVIEW
if (gl_ViewID_OVR==0u) {
gl_Position=viewProjection*worldPos;
} else {
gl_Position=viewProjectionR*worldPos;
}
#else
gl_Position=viewProjection*worldPos;
#endif
vPositionW=vec3(worldPos);
#include<prePassVertex>
#if defined(REFLECTIONMAP_EQUIRECTANGULAR_FIXED) || defined(REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED)
vDirectionW=normalize(vec3(finalWorld*vec4(positionUpdated,0.0)));
#endif
#ifndef UV1
vec2 uvUpdated=vec2(0.,0.);
#endif
#ifdef MAINUV1
vMainUV1=uvUpdated;
#endif
#include<uvVariableDeclaration>[2..7]
#include<samplerVertexImplementation>(_DEFINENAME_,DIFFUSE,_VARYINGNAME_,Diffuse,_MATRIXNAME_,diffuse,_INFONAME_,DiffuseInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,DETAIL,_VARYINGNAME_,Detail,_MATRIXNAME_,detail,_INFONAME_,DetailInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,AMBIENT,_VARYINGNAME_,Ambient,_MATRIXNAME_,ambient,_INFONAME_,AmbientInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,OPACITY,_VARYINGNAME_,Opacity,_MATRIXNAME_,opacity,_INFONAME_,OpacityInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,EMISSIVE,_VARYINGNAME_,Emissive,_MATRIXNAME_,emissive,_INFONAME_,EmissiveInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,LIGHTMAP,_VARYINGNAME_,Lightmap,_MATRIXNAME_,lightmap,_INFONAME_,LightmapInfos.x)
#if defined(SPECULARTERM)
#include<samplerVertexImplementation>(_DEFINENAME_,SPECULAR,_VARYINGNAME_,Specular,_MATRIXNAME_,specular,_INFONAME_,SpecularInfos.x)
#endif
#include<samplerVertexImplementation>(_DEFINENAME_,BUMP,_VARYINGNAME_,Bump,_MATRIXNAME_,bump,_INFONAME_,BumpInfos.x)
#include<bumpVertex>
#include<clipPlaneVertex>
#include<fogVertex>
#include<shadowsVertex>[0..maxSimultaneousLights]
#ifdef VERTEXCOLOR
vColor=color;
#elif INSTANCESCOLOR
vColor=instanceColor;
#endif
#include<pointCloudVertex>
#include<logDepthVertex>
#define CUSTOM_VERTEX_MAIN_END
}
`;q.ShadersStore[lh]=uh;var fh=function(){function i(e){this._plugins=[],this._activePlugins=[],this._activePluginsForExtraEvents=[],this._material=e,this._scene=e.getScene(),this._engine=this._scene.getEngine()}return i.prototype._addPlugin=function(e){for(var t=0;t<this._plugins.length;++t)if(this._plugins[t].name===e.name)throw'Plugin "'.concat(e.name,'" already added to the material "').concat(this._material.name,'"!');if(this._material._uniformBufferLayoutBuilt)throw'The plugin "'.concat(e.name,`" can't be added to the material "`).concat(this._material.name,'" because this material has already been used for rendering! Please add plugins to materials before any rendering with this material occurs.');this._material._callbackPluginEventGeneric=this._handlePluginEvent.bind(this),this._plugins.push(e),this._plugins.sort(function(o,l){return o.priority-l.priority}),this._codeInjectionPoints={};for(var r={},n=0,a=this._plugins;n<a.length;n++){var s=a[n];s.collectDefines(r),this._collectPointNames("vertex",s.getCustomCode("vertex")),this._collectPointNames("fragment",s.getCustomCode("fragment"))}Object.keys(r).length>0?this._defineNamesFromPlugins=r:delete this._defineNamesFromPlugins},i.prototype._activatePlugin=function(e){this._activePlugins.indexOf(e)===-1&&(this._activePlugins.push(e),this._activePlugins.sort(function(t,r){return t.priority-r.priority}),this._material._callbackPluginEventIsReadyForSubMesh=this._handlePluginEventIsReadyForSubMesh.bind(this),this._material._callbackPluginEventPrepareDefines=this._handlePluginEventPrepareDefines.bind(this),this._material._callbackPluginEventBindForSubMesh=this._handlePluginEventBindForSubMesh.bind(this),e.registerForExtraEvents&&(this._activePluginsForExtraEvents.push(e),this._activePluginsForExtraEvents.sort(function(t,r){return t.priority-r.priority}),this._material._callbackPluginEventHasRenderTargetTextures=this._handlePluginEventHasRenderTargetTextures.bind(this),this._material._callbackPluginEventFillRenderTargetTextures=this._handlePluginEventFillRenderTargetTextures.bind(this),this._material._callbackPluginEventHardBindForSubMesh=this._handlePluginEventHardBindForSubMesh.bind(this)))},i.prototype.getPlugin=function(e){for(var t=0;t<this._plugins.length;++t)if(this._plugins[t].name===e)return this._plugins[t];return null},i.prototype._handlePluginEventIsReadyForSubMesh=function(e){for(var t=!0,r=0,n=this._activePlugins;r<n.length;r++){var a=n[r];t=t&&a.isReadyForSubMesh(e.defines,this._scene,this._engine,e.subMesh)}e.isReadyForSubMesh=t},i.prototype._handlePluginEventPrepareDefines=function(e){for(var t=0,r=this._activePlugins;t<r.length;t++){var n=r[t];n.prepareDefines(e.defines,this._scene,e.mesh)}},i.prototype._handlePluginEventHardBindForSubMesh=function(e){for(var t=0,r=this._activePluginsForExtraEvents;t<r.length;t++){var n=r[t];n.hardBindForSubMesh(this._material._uniformBuffer,this._scene,this._engine,e.subMesh)}},i.prototype._handlePluginEventBindForSubMesh=function(e){for(var t=0,r=this._activePlugins;t<r.length;t++){var n=r[t];n.bindForSubMesh(this._material._uniformBuffer,this._scene,this._engine,e.subMesh)}},i.prototype._handlePluginEventHasRenderTargetTextures=function(e){for(var t=!1,r=0,n=this._activePluginsForExtraEvents;r<n.length;r++){var a=n[r];if(t=a.hasRenderTargetTextures(),t)break}e.hasRenderTargetTextures=t},i.prototype._handlePluginEventFillRenderTargetTextures=function(e){for(var t=0,r=this._activePluginsForExtraEvents;t<r.length;t++){var n=r[t];n.fillRenderTargetTextures(e.renderTargets)}},i.prototype._handlePluginEvent=function(e,t){var r,n,a;switch(e){case Qe.GetActiveTextures:{for(var s=t,o=0,l=this._activePlugins;o<l.length;o++){var u=l[o];u.getActiveTextures(s.activeTextures)}break}case Qe.GetAnimatables:{for(var s=t,f=0,h=this._activePlugins;f<h.length;f++){var u=h[f];u.getAnimatables(s.animatables)}break}case Qe.HasTexture:{for(var s=t,c=!1,d=0,p=this._activePlugins;d<p.length;d++){var u=p[d];if(c=u.hasTexture(s.texture),c)break}s.hasTexture=c;break}case Qe.Disposed:{for(var s=t,_=0,g=this._plugins;_<g.length;_++){var u=g[_];u.dispose(s.forceDisposeTextures)}break}case Qe.GetDefineNames:{var s=t;s.defineNames=this._defineNamesFromPlugins;break}case Qe.PrepareEffect:{for(var s=t,v=0,y=this._activePlugins;v<y.length;v++){var u=y[v];s.fallbackRank=u.addFallbacks(s.defines,s.fallbacks,s.fallbackRank)}this._uniformList.length>0&&(r=s.uniforms).push.apply(r,this._uniformList),this._samplerList.length>0&&(n=s.samplers).push.apply(n,this._samplerList),this._uboList.length>0&&(a=s.uniformBuffersNames).push.apply(a,this._uboList),s.customCode=this._injectCustomCode(s.customCode);break}case Qe.PrepareUniformBuffer:{var s=t;this._uboDeclaration="",this._vertexDeclaration="",this._fragmentDeclaration="",this._uniformList=[],this._samplerList=[],this._uboList=[];for(var b=0,E=this._plugins;b<E.length;b++){var u=E[b],A=u.getUniforms();if(A){if(A.ubo)for(var S=0,T=A.ubo;S<T.length;S++){var M=T[S];s.ubo.addUniform(M.name,M.size),this._uboDeclaration+="".concat(M.type," ").concat(M.name,`;\r
`),this._uniformList.push(M.name)}A.vertex&&(this._vertexDeclaration+=A.vertex+`\r
`),A.fragment&&(this._fragmentDeclaration+=A.fragment+`\r
`)}u.getSamplers(this._samplerList),u.getUniformBuffersNames(this._uboList)}break}}},i.prototype._collectPointNames=function(e,t){if(!!t)for(var r in t)this._codeInjectionPoints[e]||(this._codeInjectionPoints[e]={}),this._codeInjectionPoints[e][r]=!0},i.prototype._injectCustomCode=function(e){var t=this;return function(r,n){var a;e&&(n=e(r,n)),t._uboDeclaration&&(n=n.replace("#define ADDITIONAL_UBO_DECLARATION",t._uboDeclaration)),t._vertexDeclaration&&(n=n.replace("#define ADDITIONAL_VERTEX_DECLARATION",t._vertexDeclaration)),t._fragmentDeclaration&&(n=n.replace("#define ADDITIONAL_FRAGMENT_DECLARATION",t._fragmentDeclaration));var s=(a=t._codeInjectionPoints)===null||a===void 0?void 0:a[r];if(!s)return n;for(var o in s){for(var l="",u=0,f=t._activePlugins;u<f.length;u++){var h=f[u],c=h.getCustomCode(r);c!=null&&c[o]&&(l+=c[o]+`\r
`)}if(l.length>0)if(o.charAt(0)==="!")for(var d=new RegExp(o.substring(1),"g"),p=d.exec(n);p!==null;)n=n.replace(p[0],l),p=d.exec(n);else{var _="#define "+o;n=n.replace(_,`\r
`+l+`\r
`+_)}}return n}},i}(),hh=function(){function i(e,t,r,n,a,s){a===void 0&&(a=!0),s===void 0&&(s=!1),this.priority=500,this.registerForExtraEvents=!1,this._material=e,this.name=t,this.priority=r,e.pluginManager||(e.pluginManager=new fh(e)),this._pluginDefineNames=n,this._pluginManager=e.pluginManager,a&&this._pluginManager._addPlugin(this),s&&this._enable(!0),this.markAllDefinesAsDirty=e._dirtyCallbacks[63]}return i.prototype._enable=function(e){e&&this._pluginManager._activatePlugin(this)},i.prototype.getClassName=function(){return"MaterialPluginBase"},i.prototype.isReadyForSubMesh=function(e,t,r,n){return!0},i.prototype.hardBindForSubMesh=function(e,t,r,n){},i.prototype.bindForSubMesh=function(e,t,r,n){},i.prototype.dispose=function(e){},i.prototype.getCustomCode=function(e){return null},i.prototype.collectDefines=function(e){if(!!this._pluginDefineNames)for(var t=0,r=Object.keys(this._pluginDefineNames);t<r.length;t++){var n=r[t];if(n[0]!=="_"){var a=typeof this._pluginDefineNames[n];e[n]={type:a==="number"?"number":a==="string"?"string":a==="boolean"?"boolean":"object",default:this._pluginDefineNames[n]}}}},i.prototype.prepareDefines=function(e,t,r){},i.prototype.hasTexture=function(e){return!1},i.prototype.hasRenderTargetTextures=function(){return!1},i.prototype.fillRenderTargetTextures=function(e){},i.prototype.getActiveTextures=function(e){},i.prototype.getAnimatables=function(e){},i.prototype.addFallbacks=function(e,t,r){return r},i.prototype.getSamplers=function(e){},i.prototype.getUniformBuffersNames=function(e){},i.prototype.getUniforms=function(){return{}},i.prototype.copyTo=function(e){pe.Clone(function(){return e},this)},i.prototype.serialize=function(){return pe.Serialize(this)},i.prototype.parse=function(e,t,r){var n=this;pe.Parse(function(){return n},e,t,r)},C([I()],i.prototype,"name",void 0),C([I()],i.prototype,"priority",void 0),C([I()],i.prototype,"registerForExtraEvents",void 0),i}(),ch=function(i){$(e,i);function e(){var t=i!==null&&i.apply(this,arguments)||this;return t.DETAIL=!1,t.DETAILDIRECTUV=0,t.DETAIL_NORMALBLENDMETHOD=0,t}return e}(ai),dh=function(i){$(e,i);function e(t,r){r===void 0&&(r=!0);var n=i.call(this,t,"DetailMap",140,new ch,r)||this;return n._texture=null,n.diffuseBlendLevel=1,n.roughnessBlendLevel=1,n.bumpLevel=1,n._normalBlendMethod=He.MATERIAL_NORMALBLENDMETHOD_WHITEOUT,n._isEnabled=!1,n.isEnabled=!1,n._internalMarkAllSubMeshesAsTexturesDirty=t._dirtyCallbacks[1],n}return e.prototype._markAllSubMeshesAsTexturesDirty=function(){this._enable(this._isEnabled),this._internalMarkAllSubMeshesAsTexturesDirty()},e.prototype.isReadyForSubMesh=function(t,r,n){return this._isEnabled?!(t._areTexturesDirty&&r.texturesEnabled&&n.getCaps().standardDerivatives&&this._texture&&Oe.DetailTextureEnabled&&!this._texture.isReady()):!0},e.prototype.prepareDefines=function(t,r){if(this._isEnabled){t.DETAIL_NORMALBLENDMETHOD=this._normalBlendMethod;var n=r.getEngine();t._areTexturesDirty&&(n.getCaps().standardDerivatives&&this._texture&&Oe.DetailTextureEnabled&&this._isEnabled?(le.PrepareDefinesForMergedUV(this._texture,t,"DETAIL"),t.DETAIL_NORMALBLENDMETHOD=this._normalBlendMethod):t.DETAIL=!1)}else t.DETAIL=!1},e.prototype.bindForSubMesh=function(t,r){if(!!this._isEnabled){var n=this._material.isFrozen;(!t.useUbo||!n||!t.isSync)&&this._texture&&Oe.DetailTextureEnabled&&(t.updateFloat4("vDetailInfos",this._texture.coordinatesIndex,this.diffuseBlendLevel,this.bumpLevel,this.roughnessBlendLevel),le.BindTextureMatrix(this._texture,t,"detail")),r.texturesEnabled&&this._texture&&Oe.DetailTextureEnabled&&t.setTexture("detailSampler",this._texture)}},e.prototype.hasTexture=function(t){return this._texture===t},e.prototype.getActiveTextures=function(t){this._texture&&t.push(this._texture)},e.prototype.getAnimatables=function(t){this._texture&&this._texture.animations&&this._texture.animations.length>0&&t.push(this._texture)},e.prototype.dispose=function(t){var r;t&&((r=this._texture)===null||r===void 0||r.dispose())},e.prototype.getClassName=function(){return"DetailMapConfiguration"},e.prototype.getSamplers=function(t){t.push("detailSampler")},e.prototype.getUniforms=function(){return{ubo:[{name:"vDetailInfos",size:4,type:"vec4"},{name:"detailMatrix",size:16,type:"mat4"}]}},C([ot("detailTexture"),ve("_markAllSubMeshesAsTexturesDirty")],e.prototype,"texture",void 0),C([I()],e.prototype,"diffuseBlendLevel",void 0),C([I()],e.prototype,"roughnessBlendLevel",void 0),C([I()],e.prototype,"bumpLevel",void 0),C([I(),ve("_markAllSubMeshesAsTexturesDirty")],e.prototype,"normalBlendMethod",void 0),C([I(),ve("_markAllSubMeshesAsTexturesDirty")],e.prototype,"isEnabled",void 0),e}(hh),yi={effect:null,subMesh:null},ph=function(i){$(e,i);function e(t){var r=i.call(this,t)||this;return r.MAINUV1=!1,r.MAINUV2=!1,r.MAINUV3=!1,r.MAINUV4=!1,r.MAINUV5=!1,r.MAINUV6=!1,r.DIFFUSE=!1,r.DIFFUSEDIRECTUV=0,r.BAKED_VERTEX_ANIMATION_TEXTURE=!1,r.AMBIENT=!1,r.AMBIENTDIRECTUV=0,r.OPACITY=!1,r.OPACITYDIRECTUV=0,r.OPACITYRGB=!1,r.REFLECTION=!1,r.EMISSIVE=!1,r.EMISSIVEDIRECTUV=0,r.SPECULAR=!1,r.SPECULARDIRECTUV=0,r.BUMP=!1,r.BUMPDIRECTUV=0,r.PARALLAX=!1,r.PARALLAXOCCLUSION=!1,r.SPECULAROVERALPHA=!1,r.CLIPPLANE=!1,r.CLIPPLANE2=!1,r.CLIPPLANE3=!1,r.CLIPPLANE4=!1,r.CLIPPLANE5=!1,r.CLIPPLANE6=!1,r.ALPHATEST=!1,r.DEPTHPREPASS=!1,r.ALPHAFROMDIFFUSE=!1,r.POINTSIZE=!1,r.FOG=!1,r.SPECULARTERM=!1,r.DIFFUSEFRESNEL=!1,r.OPACITYFRESNEL=!1,r.REFLECTIONFRESNEL=!1,r.REFRACTIONFRESNEL=!1,r.EMISSIVEFRESNEL=!1,r.FRESNEL=!1,r.NORMAL=!1,r.TANGENT=!1,r.UV1=!1,r.UV2=!1,r.UV3=!1,r.UV4=!1,r.UV5=!1,r.UV6=!1,r.VERTEXCOLOR=!1,r.VERTEXALPHA=!1,r.NUM_BONE_INFLUENCERS=0,r.BonesPerMesh=0,r.BONETEXTURE=!1,r.BONES_VELOCITY_ENABLED=!1,r.INSTANCES=!1,r.THIN_INSTANCES=!1,r.INSTANCESCOLOR=!1,r.GLOSSINESS=!1,r.ROUGHNESS=!1,r.EMISSIVEASILLUMINATION=!1,r.LINKEMISSIVEWITHDIFFUSE=!1,r.REFLECTIONFRESNELFROMSPECULAR=!1,r.LIGHTMAP=!1,r.LIGHTMAPDIRECTUV=0,r.OBJECTSPACE_NORMALMAP=!1,r.USELIGHTMAPASSHADOWMAP=!1,r.REFLECTIONMAP_3D=!1,r.REFLECTIONMAP_SPHERICAL=!1,r.REFLECTIONMAP_PLANAR=!1,r.REFLECTIONMAP_CUBIC=!1,r.USE_LOCAL_REFLECTIONMAP_CUBIC=!1,r.USE_LOCAL_REFRACTIONMAP_CUBIC=!1,r.REFLECTIONMAP_PROJECTION=!1,r.REFLECTIONMAP_SKYBOX=!1,r.REFLECTIONMAP_EXPLICIT=!1,r.REFLECTIONMAP_EQUIRECTANGULAR=!1,r.REFLECTIONMAP_EQUIRECTANGULAR_FIXED=!1,r.REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED=!1,r.REFLECTIONMAP_OPPOSITEZ=!1,r.INVERTCUBICMAP=!1,r.LOGARITHMICDEPTH=!1,r.REFRACTION=!1,r.REFRACTIONMAP_3D=!1,r.REFLECTIONOVERALPHA=!1,r.TWOSIDEDLIGHTING=!1,r.SHADOWFLOAT=!1,r.MORPHTARGETS=!1,r.MORPHTARGETS_NORMAL=!1,r.MORPHTARGETS_TANGENT=!1,r.MORPHTARGETS_UV=!1,r.NUM_MORPH_INFLUENCERS=0,r.MORPHTARGETS_TEXTURE=!1,r.NONUNIFORMSCALING=!1,r.PREMULTIPLYALPHA=!1,r.ALPHATEST_AFTERALLALPHACOMPUTATIONS=!1,r.ALPHABLEND=!0,r.PREPASS=!1,r.PREPASS_IRRADIANCE=!1,r.PREPASS_IRRADIANCE_INDEX=-1,r.PREPASS_ALBEDO_SQRT=!1,r.PREPASS_ALBEDO_SQRT_INDEX=-1,r.PREPASS_DEPTH=!1,r.PREPASS_DEPTH_INDEX=-1,r.PREPASS_NORMAL=!1,r.PREPASS_NORMAL_INDEX=-1,r.PREPASS_POSITION=!1,r.PREPASS_POSITION_INDEX=-1,r.PREPASS_VELOCITY=!1,r.PREPASS_VELOCITY_INDEX=-1,r.PREPASS_REFLECTIVITY=!1,r.PREPASS_REFLECTIVITY_INDEX=-1,r.SCENE_MRT_COUNT=0,r.RGBDLIGHTMAP=!1,r.RGBDREFLECTION=!1,r.RGBDREFRACTION=!1,r.IMAGEPROCESSING=!1,r.VIGNETTE=!1,r.VIGNETTEBLENDMODEMULTIPLY=!1,r.VIGNETTEBLENDMODEOPAQUE=!1,r.TONEMAPPING=!1,r.TONEMAPPING_ACES=!1,r.CONTRAST=!1,r.COLORCURVES=!1,r.COLORGRADING=!1,r.COLORGRADING3D=!1,r.SAMPLER3DGREENDEPTH=!1,r.SAMPLER3DBGRMAP=!1,r.IMAGEPROCESSINGPOSTPROCESS=!1,r.SKIPFINALCOLORCLAMP=!1,r.MULTIVIEW=!1,r.ORDER_INDEPENDENT_TRANSPARENCY=!1,r.ORDER_INDEPENDENT_TRANSPARENCY_16BITS=!1,r.IS_REFLECTION_LINEAR=!1,r.IS_REFRACTION_LINEAR=!1,r.EXPOSURE=!1,r.rebuild(),r}return e.prototype.setReflectionMode=function(t){for(var r=["REFLECTIONMAP_CUBIC","REFLECTIONMAP_EXPLICIT","REFLECTIONMAP_PLANAR","REFLECTIONMAP_PROJECTION","REFLECTIONMAP_PROJECTION","REFLECTIONMAP_SKYBOX","REFLECTIONMAP_SPHERICAL","REFLECTIONMAP_EQUIRECTANGULAR","REFLECTIONMAP_EQUIRECTANGULAR_FIXED","REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED"],n=0,a=r;n<a.length;n++){var s=a[n];this[s]=s===t}},e}(ai),$t=function(i){$(e,i);function e(t,r){var n=i.call(this,t,r)||this;return n._diffuseTexture=null,n._ambientTexture=null,n._opacityTexture=null,n._reflectionTexture=null,n._emissiveTexture=null,n._specularTexture=null,n._bumpTexture=null,n._lightmapTexture=null,n._refractionTexture=null,n.ambientColor=new me(0,0,0),n.diffuseColor=new me(1,1,1),n.specularColor=new me(1,1,1),n.emissiveColor=new me(0,0,0),n.specularPower=64,n._useAlphaFromDiffuseTexture=!1,n._useEmissiveAsIllumination=!1,n._linkEmissiveWithDiffuse=!1,n._useSpecularOverAlpha=!1,n._useReflectionOverAlpha=!1,n._disableLighting=!1,n._useObjectSpaceNormalMap=!1,n._useParallax=!1,n._useParallaxOcclusion=!1,n.parallaxScaleBias=.05,n._roughness=0,n.indexOfRefraction=.98,n.invertRefractionY=!0,n.alphaCutOff=.4,n._useLightmapAsShadowmap=!1,n._useReflectionFresnelFromSpecular=!1,n._useGlossinessFromSpecularMapAlpha=!1,n._maxSimultaneousLights=4,n._invertNormalMapX=!1,n._invertNormalMapY=!1,n._twoSidedLighting=!1,n._renderTargets=new Je(16),n._worldViewProjectionMatrix=G.Zero(),n._globalAmbientColor=new me(0,0,0),n._cacheHasRenderTargetTextures=!1,n.detailMap=new dh(n),n._attachImageProcessingConfiguration(null),n.prePassConfiguration=new mi,n.getRenderTargetTextures=function(){return n._renderTargets.reset(),e.ReflectionTextureEnabled&&n._reflectionTexture&&n._reflectionTexture.isRenderTarget&&n._renderTargets.push(n._reflectionTexture),e.RefractionTextureEnabled&&n._refractionTexture&&n._refractionTexture.isRenderTarget&&n._renderTargets.push(n._refractionTexture),n._eventInfo.renderTargets=n._renderTargets,n._callbackPluginEventFillRenderTargetTextures(n._eventInfo),n._renderTargets},n}return Object.defineProperty(e.prototype,"imageProcessingConfiguration",{get:function(){return this._imageProcessingConfiguration},set:function(t){this._attachImageProcessingConfiguration(t),this._markAllSubMeshesAsTexturesDirty()},enumerable:!1,configurable:!0}),e.prototype._attachImageProcessingConfiguration=function(t){var r=this;t!==this._imageProcessingConfiguration&&(this._imageProcessingConfiguration&&this._imageProcessingObserver&&this._imageProcessingConfiguration.onUpdateParameters.remove(this._imageProcessingObserver),t?this._imageProcessingConfiguration=t:this._imageProcessingConfiguration=this.getScene().imageProcessingConfiguration,this._imageProcessingConfiguration&&(this._imageProcessingObserver=this._imageProcessingConfiguration.onUpdateParameters.add(function(){r._markAllSubMeshesAsImageProcessingDirty()})))},Object.defineProperty(e.prototype,"isPrePassCapable",{get:function(){return!this.disableDepthWrite},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"cameraColorCurvesEnabled",{get:function(){return this.imageProcessingConfiguration.colorCurvesEnabled},set:function(t){this.imageProcessingConfiguration.colorCurvesEnabled=t},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"cameraColorGradingEnabled",{get:function(){return this.imageProcessingConfiguration.colorGradingEnabled},set:function(t){this.imageProcessingConfiguration.colorGradingEnabled=t},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"cameraToneMappingEnabled",{get:function(){return this._imageProcessingConfiguration.toneMappingEnabled},set:function(t){this._imageProcessingConfiguration.toneMappingEnabled=t},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"cameraExposure",{get:function(){return this._imageProcessingConfiguration.exposure},set:function(t){this._imageProcessingConfiguration.exposure=t},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"cameraContrast",{get:function(){return this._imageProcessingConfiguration.contrast},set:function(t){this._imageProcessingConfiguration.contrast=t},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"cameraColorGradingTexture",{get:function(){return this._imageProcessingConfiguration.colorGradingTexture},set:function(t){this._imageProcessingConfiguration.colorGradingTexture=t},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"cameraColorCurves",{get:function(){return this._imageProcessingConfiguration.colorCurves},set:function(t){this._imageProcessingConfiguration.colorCurves=t},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"canRenderToMRT",{get:function(){return!0},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"hasRenderTargetTextures",{get:function(){return e.ReflectionTextureEnabled&&this._reflectionTexture&&this._reflectionTexture.isRenderTarget||e.RefractionTextureEnabled&&this._refractionTexture&&this._refractionTexture.isRenderTarget?!0:this._cacheHasRenderTargetTextures},enumerable:!1,configurable:!0}),e.prototype.getClassName=function(){return"StandardMaterial"},Object.defineProperty(e.prototype,"useLogarithmicDepth",{get:function(){return this._useLogarithmicDepth},set:function(t){this._useLogarithmicDepth=t&&this.getScene().getEngine().getCaps().fragmentDepthSupported,this._markAllSubMeshesAsMiscDirty()},enumerable:!1,configurable:!0}),e.prototype.needAlphaBlending=function(){return this._disableAlphaBlending?!1:this.alpha<1||this._opacityTexture!=null||this._shouldUseAlphaFromDiffuseTexture()||this._opacityFresnelParameters&&this._opacityFresnelParameters.isEnabled},e.prototype.needAlphaTesting=function(){return this._forceAlphaTest?!0:this._hasAlphaChannel()&&(this._transparencyMode==null||this._transparencyMode===He.MATERIAL_ALPHATEST)},e.prototype._shouldUseAlphaFromDiffuseTexture=function(){return this._diffuseTexture!=null&&this._diffuseTexture.hasAlpha&&this._useAlphaFromDiffuseTexture&&this._transparencyMode!==He.MATERIAL_OPAQUE},e.prototype._hasAlphaChannel=function(){return this._diffuseTexture!=null&&this._diffuseTexture.hasAlpha||this._opacityTexture!=null},e.prototype.getAlphaTestTexture=function(){return this._diffuseTexture},e.prototype.isReadyForSubMesh=function(t,r,n){if(n===void 0&&(n=!1),this._uniformBufferLayoutBuilt||this.buildUniformLayout(),r.effect&&this.isFrozen&&r.effect._wasPreviouslyReady)return!0;r.materialDefines||(this._callbackPluginEventGeneric(Qe.GetDefineNames,this._eventInfo),r.materialDefines=new ph(this._eventInfo.defineNames));var a=this.getScene(),s=r.materialDefines;if(this._isReadyForSubMesh(r))return!0;var o=a.getEngine();s._needNormals=le.PrepareDefinesForLights(a,t,s,!0,this._maxSimultaneousLights,this._disableLighting),le.PrepareDefinesForMultiview(a,s);var l=this.needAlphaBlendingForMesh(t)&&this.getScene().useOrderIndependentTransparency;if(le.PrepareDefinesForPrePass(a,s,this.canRenderToMRT&&!l),le.PrepareDefinesForOIT(a,s,l),s._areTexturesDirty){this._eventInfo.hasRenderTargetTextures=!1,this._callbackPluginEventHasRenderTargetTextures(this._eventInfo),this._cacheHasRenderTargetTextures=this._eventInfo.hasRenderTargetTextures,s._needUVs=!1;for(var u=1;u<=6;++u)s["MAINUV"+u]=!1;if(a.texturesEnabled){if(this._diffuseTexture&&e.DiffuseTextureEnabled)if(this._diffuseTexture.isReadyOrNotBlocking())le.PrepareDefinesForMergedUV(this._diffuseTexture,s,"DIFFUSE");else return!1;else s.DIFFUSE=!1;if(this._ambientTexture&&e.AmbientTextureEnabled)if(this._ambientTexture.isReadyOrNotBlocking())le.PrepareDefinesForMergedUV(this._ambientTexture,s,"AMBIENT");else return!1;else s.AMBIENT=!1;if(this._opacityTexture&&e.OpacityTextureEnabled)if(this._opacityTexture.isReadyOrNotBlocking())le.PrepareDefinesForMergedUV(this._opacityTexture,s,"OPACITY"),s.OPACITYRGB=this._opacityTexture.getAlphaFromRGB;else return!1;else s.OPACITY=!1;if(this._reflectionTexture&&e.ReflectionTextureEnabled)if(this._reflectionTexture.isReadyOrNotBlocking()){switch(s._needNormals=!0,s.REFLECTION=!0,s.ROUGHNESS=this._roughness>0,s.REFLECTIONOVERALPHA=this._useReflectionOverAlpha,s.INVERTCUBICMAP=this._reflectionTexture.coordinatesMode===re.INVCUBIC_MODE,s.REFLECTIONMAP_3D=this._reflectionTexture.isCube,s.RGBDREFLECTION=this._reflectionTexture.isRGBD,s.REFLECTIONMAP_OPPOSITEZ=this.getScene().useRightHandedSystem?!this._reflectionTexture.invertZ:this._reflectionTexture.invertZ,this._reflectionTexture.coordinatesMode){case re.EXPLICIT_MODE:s.setReflectionMode("REFLECTIONMAP_EXPLICIT");break;case re.PLANAR_MODE:s.setReflectionMode("REFLECTIONMAP_PLANAR");break;case re.PROJECTION_MODE:s.setReflectionMode("REFLECTIONMAP_PROJECTION");break;case re.SKYBOX_MODE:s.setReflectionMode("REFLECTIONMAP_SKYBOX");break;case re.SPHERICAL_MODE:s.setReflectionMode("REFLECTIONMAP_SPHERICAL");break;case re.EQUIRECTANGULAR_MODE:s.setReflectionMode("REFLECTIONMAP_EQUIRECTANGULAR");break;case re.FIXED_EQUIRECTANGULAR_MODE:s.setReflectionMode("REFLECTIONMAP_EQUIRECTANGULAR_FIXED");break;case re.FIXED_EQUIRECTANGULAR_MIRRORED_MODE:s.setReflectionMode("REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED");break;case re.CUBIC_MODE:case re.INVCUBIC_MODE:default:s.setReflectionMode("REFLECTIONMAP_CUBIC");break}s.USE_LOCAL_REFLECTIONMAP_CUBIC=!!this._reflectionTexture.boundingBoxSize}else return!1;else s.REFLECTION=!1,s.REFLECTIONMAP_OPPOSITEZ=!1;if(this._emissiveTexture&&e.EmissiveTextureEnabled)if(this._emissiveTexture.isReadyOrNotBlocking())le.PrepareDefinesForMergedUV(this._emissiveTexture,s,"EMISSIVE");else return!1;else s.EMISSIVE=!1;if(this._lightmapTexture&&e.LightmapTextureEnabled)if(this._lightmapTexture.isReadyOrNotBlocking())le.PrepareDefinesForMergedUV(this._lightmapTexture,s,"LIGHTMAP"),s.USELIGHTMAPASSHADOWMAP=this._useLightmapAsShadowmap,s.RGBDLIGHTMAP=this._lightmapTexture.isRGBD;else return!1;else s.LIGHTMAP=!1;if(this._specularTexture&&e.SpecularTextureEnabled)if(this._specularTexture.isReadyOrNotBlocking())le.PrepareDefinesForMergedUV(this._specularTexture,s,"SPECULAR"),s.GLOSSINESS=this._useGlossinessFromSpecularMapAlpha;else return!1;else s.SPECULAR=!1;if(a.getEngine().getCaps().standardDerivatives&&this._bumpTexture&&e.BumpTextureEnabled){if(this._bumpTexture.isReady())le.PrepareDefinesForMergedUV(this._bumpTexture,s,"BUMP"),s.PARALLAX=this._useParallax,s.PARALLAXOCCLUSION=this._useParallaxOcclusion;else return!1;s.OBJECTSPACE_NORMALMAP=this._useObjectSpaceNormalMap}else s.BUMP=!1;if(this._refractionTexture&&e.RefractionTextureEnabled)if(this._refractionTexture.isReadyOrNotBlocking())s._needUVs=!0,s.REFRACTION=!0,s.REFRACTIONMAP_3D=this._refractionTexture.isCube,s.RGBDREFRACTION=this._refractionTexture.isRGBD,s.USE_LOCAL_REFRACTIONMAP_CUBIC=!!this._refractionTexture.boundingBoxSize;else return!1;else s.REFRACTION=!1;s.TWOSIDEDLIGHTING=!this._backFaceCulling&&this._twoSidedLighting}else s.DIFFUSE=!1,s.AMBIENT=!1,s.OPACITY=!1,s.REFLECTION=!1,s.EMISSIVE=!1,s.LIGHTMAP=!1,s.BUMP=!1,s.REFRACTION=!1;s.ALPHAFROMDIFFUSE=this._shouldUseAlphaFromDiffuseTexture(),s.EMISSIVEASILLUMINATION=this._useEmissiveAsIllumination,s.LINKEMISSIVEWITHDIFFUSE=this._linkEmissiveWithDiffuse,s.SPECULAROVERALPHA=this._useSpecularOverAlpha,s.PREMULTIPLYALPHA=this.alphaMode===7||this.alphaMode===8,s.ALPHATEST_AFTERALLALPHACOMPUTATIONS=this.transparencyMode!==null,s.ALPHABLEND=this.transparencyMode===null||this.needAlphaBlendingForMesh(t)}if(this._eventInfo.isReadyForSubMesh=!0,this._eventInfo.defines=s,this._callbackPluginEventIsReadyForSubMesh(this._eventInfo),!this._eventInfo.isReadyForSubMesh)return!1;if(s._areImageProcessingDirty&&this._imageProcessingConfiguration){if(!this._imageProcessingConfiguration.isReady())return!1;this._imageProcessingConfiguration.prepareDefines(s),s.IS_REFLECTION_LINEAR=this.reflectionTexture!=null&&!this.reflectionTexture.gammaSpace,s.IS_REFRACTION_LINEAR=this.refractionTexture!=null&&!this.refractionTexture.gammaSpace}if(s._areFresnelDirty&&(e.FresnelEnabled?(this._diffuseFresnelParameters||this._opacityFresnelParameters||this._emissiveFresnelParameters||this._refractionFresnelParameters||this._reflectionFresnelParameters)&&(s.DIFFUSEFRESNEL=this._diffuseFresnelParameters&&this._diffuseFresnelParameters.isEnabled,s.OPACITYFRESNEL=this._opacityFresnelParameters&&this._opacityFresnelParameters.isEnabled,s.REFLECTIONFRESNEL=this._reflectionFresnelParameters&&this._reflectionFresnelParameters.isEnabled,s.REFLECTIONFRESNELFROMSPECULAR=this._useReflectionFresnelFromSpecular,s.REFRACTIONFRESNEL=this._refractionFresnelParameters&&this._refractionFresnelParameters.isEnabled,s.EMISSIVEFRESNEL=this._emissiveFresnelParameters&&this._emissiveFresnelParameters.isEnabled,s._needNormals=!0,s.FRESNEL=!0):s.FRESNEL=!1),le.PrepareDefinesForMisc(t,a,this._useLogarithmicDepth,this.pointsCloud,this.fogEnabled,this._shouldTurnAlphaTestOn(t)||this._forceAlphaTest,s),le.PrepareDefinesForAttributes(t,s,!0,!0,!0),le.PrepareDefinesForFrameBoundValues(a,o,s,n,null,r.getRenderingMesh().hasThinInstances),this._eventInfo.defines=s,this._eventInfo.mesh=t,this._callbackPluginEventPrepareDefines(this._eventInfo),s.isDirty){var f=s._areLightsDisposed;s.markAsProcessed();var h=new oi;s.REFLECTION&&h.addFallback(0,"REFLECTION"),s.SPECULAR&&h.addFallback(0,"SPECULAR"),s.BUMP&&h.addFallback(0,"BUMP"),s.PARALLAX&&h.addFallback(1,"PARALLAX"),s.PARALLAXOCCLUSION&&h.addFallback(0,"PARALLAXOCCLUSION"),s.SPECULAROVERALPHA&&h.addFallback(0,"SPECULAROVERALPHA"),s.FOG&&h.addFallback(1,"FOG"),s.POINTSIZE&&h.addFallback(0,"POINTSIZE"),s.LOGARITHMICDEPTH&&h.addFallback(0,"LOGARITHMICDEPTH"),le.HandleFallbacksForShadows(s,h,this._maxSimultaneousLights),s.SPECULARTERM&&h.addFallback(0,"SPECULARTERM"),s.DIFFUSEFRESNEL&&h.addFallback(1,"DIFFUSEFRESNEL"),s.OPACITYFRESNEL&&h.addFallback(2,"OPACITYFRESNEL"),s.REFLECTIONFRESNEL&&h.addFallback(3,"REFLECTIONFRESNEL"),s.EMISSIVEFRESNEL&&h.addFallback(4,"EMISSIVEFRESNEL"),s.FRESNEL&&h.addFallback(4,"FRESNEL"),s.MULTIVIEW&&h.addFallback(0,"MULTIVIEW");var c=[R.PositionKind];s.NORMAL&&c.push(R.NormalKind),s.TANGENT&&c.push(R.TangentKind);for(var u=1;u<=6;++u)s["UV"+u]&&c.push("uv".concat(u===1?"":u));s.VERTEXCOLOR&&c.push(R.ColorKind),s.INSTANCESCOLOR&&c.push(R.ColorInstanceKind),le.PrepareAttributesForBones(c,t,s,h),le.PrepareAttributesForInstances(c,s),le.PrepareAttributesForMorphTargets(c,t,s),le.PrepareAttributesForBakedVertexAnimation(c,t,s);var d="default",p=["world","view","viewProjection","vEyePosition","vLightsType","vAmbientColor","vDiffuseColor","vSpecularColor","vEmissiveColor","visibility","vFogInfos","vFogColor","pointSize","vDiffuseInfos","vAmbientInfos","vOpacityInfos","vReflectionInfos","vEmissiveInfos","vSpecularInfos","vBumpInfos","vLightmapInfos","vRefractionInfos","mBones","vClipPlane","vClipPlane2","vClipPlane3","vClipPlane4","vClipPlane5","vClipPlane6","diffuseMatrix","ambientMatrix","opacityMatrix","reflectionMatrix","emissiveMatrix","specularMatrix","bumpMatrix","normalMatrix","lightmapMatrix","refractionMatrix","diffuseLeftColor","diffuseRightColor","opacityParts","reflectionLeftColor","reflectionRightColor","emissiveLeftColor","emissiveRightColor","refractionLeftColor","refractionRightColor","vReflectionPosition","vReflectionSize","vRefractionPosition","vRefractionSize","logarithmicDepthConstant","vTangentSpaceParams","alphaCutOff","boneTextureWidth","morphTargetTextureInfo","morphTargetTextureIndices"],_=["diffuseSampler","ambientSampler","opacitySampler","reflectionCubeSampler","reflection2DSampler","emissiveSampler","specularSampler","bumpSampler","lightmapSampler","refractionCubeSampler","refraction2DSampler","boneSampler","morphTargets","oitDepthSampler","oitFrontColorSampler"],g=["Material","Scene","Mesh"];this._eventInfo.fallbacks=h,this._eventInfo.fallbackRank=0,this._eventInfo.defines=s,this._eventInfo.uniforms=p,this._eventInfo.samplers=_,this._eventInfo.uniformBuffersNames=g,this._eventInfo.customCode=void 0,this._callbackPluginEventGeneric(Qe.PrepareEffect,this._eventInfo),mi.AddUniforms(p),mi.AddSamplers(_),Tt&&(Tt.PrepareUniforms(p,s),Tt.PrepareSamplers(_,s)),le.PrepareUniformsAndSamplersList({uniformsNames:p,uniformBuffersNames:g,samplers:_,defines:s,maxSimultaneousLights:this._maxSimultaneousLights});var v={};this.customShaderNameResolve&&(d=this.customShaderNameResolve(d,p,g,_,s,c,v));var y=s.toString(),b=r.effect,E=a.getEngine().createEffect(d,{attributes:c,uniformsNames:p,uniformBuffersNames:g,samplers:_,defines:y,fallbacks:h,onCompiled:this.onCompiled,onError:this.onError,indexParameters:{maxSimultaneousLights:this._maxSimultaneousLights,maxSimultaneousMorphTargets:s.NUM_MORPH_INFLUENCERS},processFinalCode:v.processFinalCode,processCodeAfterIncludes:this._eventInfo.customCode,multiTarget:s.PREPASS},o);if(E)if(this._onEffectCreatedObservable&&(yi.effect=E,yi.subMesh=r,this._onEffectCreatedObservable.notifyObservers(yi)),this.allowShaderHotSwapping&&b&&!E.isReady()){if(E=b,s.markAsUnprocessed(),f)return s._areLightsDisposed=!0,!1}else a.resetCachedMaterial(),r.setEffect(E,s,this._materialContext)}return!r.effect||!r.effect.isReady()?!1:(s._renderId=a.getRenderId(),r.effect._wasPreviouslyReady=!0,!0)},e.prototype.buildUniformLayout=function(){var t=this._uniformBuffer;t.addUniform("diffuseLeftColor",4),t.addUniform("diffuseRightColor",4),t.addUniform("opacityParts",4),t.addUniform("reflectionLeftColor",4),t.addUniform("reflectionRightColor",4),t.addUniform("refractionLeftColor",4),t.addUniform("refractionRightColor",4),t.addUniform("emissiveLeftColor",4),t.addUniform("emissiveRightColor",4),t.addUniform("vDiffuseInfos",2),t.addUniform("vAmbientInfos",2),t.addUniform("vOpacityInfos",2),t.addUniform("vReflectionInfos",2),t.addUniform("vReflectionPosition",3),t.addUniform("vReflectionSize",3),t.addUniform("vEmissiveInfos",2),t.addUniform("vLightmapInfos",2),t.addUniform("vSpecularInfos",2),t.addUniform("vBumpInfos",3),t.addUniform("diffuseMatrix",16),t.addUniform("ambientMatrix",16),t.addUniform("opacityMatrix",16),t.addUniform("reflectionMatrix",16),t.addUniform("emissiveMatrix",16),t.addUniform("lightmapMatrix",16),t.addUniform("specularMatrix",16),t.addUniform("bumpMatrix",16),t.addUniform("vTangentSpaceParams",2),t.addUniform("pointSize",1),t.addUniform("alphaCutOff",1),t.addUniform("refractionMatrix",16),t.addUniform("vRefractionInfos",4),t.addUniform("vRefractionPosition",3),t.addUniform("vRefractionSize",3),t.addUniform("vSpecularColor",4),t.addUniform("vEmissiveColor",3),t.addUniform("vDiffuseColor",4),t.addUniform("vAmbientColor",3),i.prototype.buildUniformLayout.call(this)},e.prototype.bindForSubMesh=function(t,r,n){var a,s=this.getScene(),o=n.materialDefines;if(!!o){var l=n.effect;if(!!l){this._activeEffect=l,r.getMeshUniformBuffer().bindToEffect(l,"Mesh"),r.transferToEffect(t),this._uniformBuffer.bindToEffect(l,"Material"),this.prePassConfiguration.bindForSubMesh(this._activeEffect,s,r,t,this.isFrozen),this._eventInfo.subMesh=n,this._callbackPluginEventHardBindForSubMesh(this._eventInfo),o.OBJECTSPACE_NORMALMAP&&(t.toNormalMatrix(this._normalMatrix),this.bindOnlyNormalMatrix(this._normalMatrix));var u=this._mustRebind(s,l,r.visibility);le.BindBonesParameters(r,l);var f=this._uniformBuffer;if(u){if(this.bindViewProjection(l),!f.useUbo||!this.isFrozen||!f.isSync){if(e.FresnelEnabled&&o.FRESNEL&&(this.diffuseFresnelParameters&&this.diffuseFresnelParameters.isEnabled&&(f.updateColor4("diffuseLeftColor",this.diffuseFresnelParameters.leftColor,this.diffuseFresnelParameters.power),f.updateColor4("diffuseRightColor",this.diffuseFresnelParameters.rightColor,this.diffuseFresnelParameters.bias)),this.opacityFresnelParameters&&this.opacityFresnelParameters.isEnabled&&f.updateColor4("opacityParts",new me(this.opacityFresnelParameters.leftColor.toLuminance(),this.opacityFresnelParameters.rightColor.toLuminance(),this.opacityFresnelParameters.bias),this.opacityFresnelParameters.power),this.reflectionFresnelParameters&&this.reflectionFresnelParameters.isEnabled&&(f.updateColor4("reflectionLeftColor",this.reflectionFresnelParameters.leftColor,this.reflectionFresnelParameters.power),f.updateColor4("reflectionRightColor",this.reflectionFresnelParameters.rightColor,this.reflectionFresnelParameters.bias)),this.refractionFresnelParameters&&this.refractionFresnelParameters.isEnabled&&(f.updateColor4("refractionLeftColor",this.refractionFresnelParameters.leftColor,this.refractionFresnelParameters.power),f.updateColor4("refractionRightColor",this.refractionFresnelParameters.rightColor,this.refractionFresnelParameters.bias)),this.emissiveFresnelParameters&&this.emissiveFresnelParameters.isEnabled&&(f.updateColor4("emissiveLeftColor",this.emissiveFresnelParameters.leftColor,this.emissiveFresnelParameters.power),f.updateColor4("emissiveRightColor",this.emissiveFresnelParameters.rightColor,this.emissiveFresnelParameters.bias))),s.texturesEnabled){if(this._diffuseTexture&&e.DiffuseTextureEnabled&&(f.updateFloat2("vDiffuseInfos",this._diffuseTexture.coordinatesIndex,this._diffuseTexture.level),le.BindTextureMatrix(this._diffuseTexture,f,"diffuse")),this._ambientTexture&&e.AmbientTextureEnabled&&(f.updateFloat2("vAmbientInfos",this._ambientTexture.coordinatesIndex,this._ambientTexture.level),le.BindTextureMatrix(this._ambientTexture,f,"ambient")),this._opacityTexture&&e.OpacityTextureEnabled&&(f.updateFloat2("vOpacityInfos",this._opacityTexture.coordinatesIndex,this._opacityTexture.level),le.BindTextureMatrix(this._opacityTexture,f,"opacity")),this._hasAlphaChannel()&&f.updateFloat("alphaCutOff",this.alphaCutOff),this._reflectionTexture&&e.ReflectionTextureEnabled&&(f.updateFloat2("vReflectionInfos",this._reflectionTexture.level,this.roughness),f.updateMatrix("reflectionMatrix",this._reflectionTexture.getReflectionTextureMatrix()),this._reflectionTexture.boundingBoxSize)){var h=this._reflectionTexture;f.updateVector3("vReflectionPosition",h.boundingBoxPosition),f.updateVector3("vReflectionSize",h.boundingBoxSize)}if(this._emissiveTexture&&e.EmissiveTextureEnabled&&(f.updateFloat2("vEmissiveInfos",this._emissiveTexture.coordinatesIndex,this._emissiveTexture.level),le.BindTextureMatrix(this._emissiveTexture,f,"emissive")),this._lightmapTexture&&e.LightmapTextureEnabled&&(f.updateFloat2("vLightmapInfos",this._lightmapTexture.coordinatesIndex,this._lightmapTexture.level),le.BindTextureMatrix(this._lightmapTexture,f,"lightmap")),this._specularTexture&&e.SpecularTextureEnabled&&(f.updateFloat2("vSpecularInfos",this._specularTexture.coordinatesIndex,this._specularTexture.level),le.BindTextureMatrix(this._specularTexture,f,"specular")),this._bumpTexture&&s.getEngine().getCaps().standardDerivatives&&e.BumpTextureEnabled&&(f.updateFloat3("vBumpInfos",this._bumpTexture.coordinatesIndex,1/this._bumpTexture.level,this.parallaxScaleBias),le.BindTextureMatrix(this._bumpTexture,f,"bump"),s._mirroredCameraPosition?f.updateFloat2("vTangentSpaceParams",this._invertNormalMapX?1:-1,this._invertNormalMapY?1:-1):f.updateFloat2("vTangentSpaceParams",this._invertNormalMapX?-1:1,this._invertNormalMapY?-1:1)),this._refractionTexture&&e.RefractionTextureEnabled){var c=1;if(this._refractionTexture.isCube||(f.updateMatrix("refractionMatrix",this._refractionTexture.getReflectionTextureMatrix()),this._refractionTexture.depth&&(c=this._refractionTexture.depth)),f.updateFloat4("vRefractionInfos",this._refractionTexture.level,this.indexOfRefraction,c,this.invertRefractionY?-1:1),this._refractionTexture.boundingBoxSize){var h=this._refractionTexture;f.updateVector3("vRefractionPosition",h.boundingBoxPosition),f.updateVector3("vRefractionSize",h.boundingBoxSize)}}}this.pointsCloud&&f.updateFloat("pointSize",this.pointSize),o.SPECULARTERM&&f.updateColor4("vSpecularColor",this.specularColor,this.specularPower),f.updateColor3("vEmissiveColor",e.EmissiveTextureEnabled?this.emissiveColor:me.BlackReadOnly),f.updateColor4("vDiffuseColor",this.diffuseColor,this.alpha),s.ambientColor.multiplyToRef(this.ambientColor,this._globalAmbientColor),f.updateColor3("vAmbientColor",this._globalAmbientColor)}s.texturesEnabled&&(this._diffuseTexture&&e.DiffuseTextureEnabled&&l.setTexture("diffuseSampler",this._diffuseTexture),this._ambientTexture&&e.AmbientTextureEnabled&&l.setTexture("ambientSampler",this._ambientTexture),this._opacityTexture&&e.OpacityTextureEnabled&&l.setTexture("opacitySampler",this._opacityTexture),this._reflectionTexture&&e.ReflectionTextureEnabled&&(this._reflectionTexture.isCube?l.setTexture("reflectionCubeSampler",this._reflectionTexture):l.setTexture("reflection2DSampler",this._reflectionTexture)),this._emissiveTexture&&e.EmissiveTextureEnabled&&l.setTexture("emissiveSampler",this._emissiveTexture),this._lightmapTexture&&e.LightmapTextureEnabled&&l.setTexture("lightmapSampler",this._lightmapTexture),this._specularTexture&&e.SpecularTextureEnabled&&l.setTexture("specularSampler",this._specularTexture),this._bumpTexture&&s.getEngine().getCaps().standardDerivatives&&e.BumpTextureEnabled&&l.setTexture("bumpSampler",this._bumpTexture),this._refractionTexture&&e.RefractionTextureEnabled&&(this._refractionTexture.isCube?l.setTexture("refractionCubeSampler",this._refractionTexture):l.setTexture("refraction2DSampler",this._refractionTexture))),this.getScene().useOrderIndependentTransparency&&this.needAlphaBlendingForMesh(r)&&this.getScene().depthPeelingRenderer.bind(l),this._eventInfo.subMesh=n,this._callbackPluginEventBindForSubMesh(this._eventInfo),le.BindClipPlane(l,s),this.bindEyePosition(l)}else s.getEngine()._features.needToAlwaysBindUniformBuffers&&(this._needToBindSceneUbo=!0);(u||!this.isFrozen)&&(s.lightsEnabled&&!this._disableLighting&&le.BindLights(s,r,l,o,this._maxSimultaneousLights),(s.fogEnabled&&r.applyFog&&s.fogMode!==Re.FOGMODE_NONE||this._reflectionTexture||this._refractionTexture||r.receiveShadows)&&this.bindView(l),le.BindFogParameters(s,r,l),o.NUM_MORPH_INFLUENCERS&&le.BindMorphTargetParameters(r,l),o.BAKED_VERTEX_ANIMATION_TEXTURE&&((a=r.bakedVertexAnimationManager)===null||a===void 0||a.bind(l,o.INSTANCES)),this.useLogarithmicDepth&&le.BindLogDepth(o,l,s),this._imageProcessingConfiguration&&!this._imageProcessingConfiguration.applyByPostProcess&&this._imageProcessingConfiguration.bind(this._activeEffect)),this._afterBind(r,this._activeEffect),f.update()}}},e.prototype.getAnimatables=function(){var t=i.prototype.getAnimatables.call(this);return this._diffuseTexture&&this._diffuseTexture.animations&&this._diffuseTexture.animations.length>0&&t.push(this._diffuseTexture),this._ambientTexture&&this._ambientTexture.animations&&this._ambientTexture.animations.length>0&&t.push(this._ambientTexture),this._opacityTexture&&this._opacityTexture.animations&&this._opacityTexture.animations.length>0&&t.push(this._opacityTexture),this._reflectionTexture&&this._reflectionTexture.animations&&this._reflectionTexture.animations.length>0&&t.push(this._reflectionTexture),this._emissiveTexture&&this._emissiveTexture.animations&&this._emissiveTexture.animations.length>0&&t.push(this._emissiveTexture),this._specularTexture&&this._specularTexture.animations&&this._specularTexture.animations.length>0&&t.push(this._specularTexture),this._bumpTexture&&this._bumpTexture.animations&&this._bumpTexture.animations.length>0&&t.push(this._bumpTexture),this._lightmapTexture&&this._lightmapTexture.animations&&this._lightmapTexture.animations.length>0&&t.push(this._lightmapTexture),this._refractionTexture&&this._refractionTexture.animations&&this._refractionTexture.animations.length>0&&t.push(this._refractionTexture),t},e.prototype.getActiveTextures=function(){var t=i.prototype.getActiveTextures.call(this);return this._diffuseTexture&&t.push(this._diffuseTexture),this._ambientTexture&&t.push(this._ambientTexture),this._opacityTexture&&t.push(this._opacityTexture),this._reflectionTexture&&t.push(this._reflectionTexture),this._emissiveTexture&&t.push(this._emissiveTexture),this._specularTexture&&t.push(this._specularTexture),this._bumpTexture&&t.push(this._bumpTexture),this._lightmapTexture&&t.push(this._lightmapTexture),this._refractionTexture&&t.push(this._refractionTexture),t},e.prototype.hasTexture=function(t){return!!(i.prototype.hasTexture.call(this,t)||this._diffuseTexture===t||this._ambientTexture===t||this._opacityTexture===t||this._reflectionTexture===t||this._emissiveTexture===t||this._specularTexture===t||this._bumpTexture===t||this._lightmapTexture===t||this._refractionTexture===t)},e.prototype.dispose=function(t,r){var n,a,s,o,l,u,f,h,c;r&&((n=this._diffuseTexture)===null||n===void 0||n.dispose(),(a=this._ambientTexture)===null||a===void 0||a.dispose(),(s=this._opacityTexture)===null||s===void 0||s.dispose(),(o=this._reflectionTexture)===null||o===void 0||o.dispose(),(l=this._emissiveTexture)===null||l===void 0||l.dispose(),(u=this._specularTexture)===null||u===void 0||u.dispose(),(f=this._bumpTexture)===null||f===void 0||f.dispose(),(h=this._lightmapTexture)===null||h===void 0||h.dispose(),(c=this._refractionTexture)===null||c===void 0||c.dispose()),this._imageProcessingConfiguration&&this._imageProcessingObserver&&this._imageProcessingConfiguration.onUpdateParameters.remove(this._imageProcessingObserver),i.prototype.dispose.call(this,t,r)},e.prototype.clone=function(t){var r=this,n=pe.Clone(function(){return new e(t,r.getScene())},this);return n.name=t,n.id=t,this.stencil.copyTo(n.stencil),n},e.Parse=function(t,r,n){var a=pe.Parse(function(){return new e(t.name,r)},t,r,n);return t.stencil&&a.stencil.parse(t.stencil,r,n),a},Object.defineProperty(e,"DiffuseTextureEnabled",{get:function(){return Oe.DiffuseTextureEnabled},set:function(t){Oe.DiffuseTextureEnabled=t},enumerable:!1,configurable:!0}),Object.defineProperty(e,"DetailTextureEnabled",{get:function(){return Oe.DetailTextureEnabled},set:function(t){Oe.DetailTextureEnabled=t},enumerable:!1,configurable:!0}),Object.defineProperty(e,"AmbientTextureEnabled",{get:function(){return Oe.AmbientTextureEnabled},set:function(t){Oe.AmbientTextureEnabled=t},enumerable:!1,configurable:!0}),Object.defineProperty(e,"OpacityTextureEnabled",{get:function(){return Oe.OpacityTextureEnabled},set:function(t){Oe.OpacityTextureEnabled=t},enumerable:!1,configurable:!0}),Object.defineProperty(e,"ReflectionTextureEnabled",{get:function(){return Oe.ReflectionTextureEnabled},set:function(t){Oe.ReflectionTextureEnabled=t},enumerable:!1,configurable:!0}),Object.defineProperty(e,"EmissiveTextureEnabled",{get:function(){return Oe.EmissiveTextureEnabled},set:function(t){Oe.EmissiveTextureEnabled=t},enumerable:!1,configurable:!0}),Object.defineProperty(e,"SpecularTextureEnabled",{get:function(){return Oe.SpecularTextureEnabled},set:function(t){Oe.SpecularTextureEnabled=t},enumerable:!1,configurable:!0}),Object.defineProperty(e,"BumpTextureEnabled",{get:function(){return Oe.BumpTextureEnabled},set:function(t){Oe.BumpTextureEnabled=t},enumerable:!1,configurable:!0}),Object.defineProperty(e,"LightmapTextureEnabled",{get:function(){return Oe.LightmapTextureEnabled},set:function(t){Oe.LightmapTextureEnabled=t},enumerable:!1,configurable:!0}),Object.defineProperty(e,"RefractionTextureEnabled",{get:function(){return Oe.RefractionTextureEnabled},set:function(t){Oe.RefractionTextureEnabled=t},enumerable:!1,configurable:!0}),Object.defineProperty(e,"ColorGradingTextureEnabled",{get:function(){return Oe.ColorGradingTextureEnabled},set:function(t){Oe.ColorGradingTextureEnabled=t},enumerable:!1,configurable:!0}),Object.defineProperty(e,"FresnelEnabled",{get:function(){return Oe.FresnelEnabled},set:function(t){Oe.FresnelEnabled=t},enumerable:!1,configurable:!0}),C([ot("diffuseTexture")],e.prototype,"_diffuseTexture",void 0),C([ve("_markAllSubMeshesAsTexturesAndMiscDirty")],e.prototype,"diffuseTexture",void 0),C([ot("ambientTexture")],e.prototype,"_ambientTexture",void 0),C([ve("_markAllSubMeshesAsTexturesDirty")],e.prototype,"ambientTexture",void 0),C([ot("opacityTexture")],e.prototype,"_opacityTexture",void 0),C([ve("_markAllSubMeshesAsTexturesAndMiscDirty")],e.prototype,"opacityTexture",void 0),C([ot("reflectionTexture")],e.prototype,"_reflectionTexture",void 0),C([ve("_markAllSubMeshesAsTexturesDirty")],e.prototype,"reflectionTexture",void 0),C([ot("emissiveTexture")],e.prototype,"_emissiveTexture",void 0),C([ve("_markAllSubMeshesAsTexturesDirty")],e.prototype,"emissiveTexture",void 0),C([ot("specularTexture")],e.prototype,"_specularTexture",void 0),C([ve("_markAllSubMeshesAsTexturesDirty")],e.prototype,"specularTexture",void 0),C([ot("bumpTexture")],e.prototype,"_bumpTexture",void 0),C([ve("_markAllSubMeshesAsTexturesDirty")],e.prototype,"bumpTexture",void 0),C([ot("lightmapTexture")],e.prototype,"_lightmapTexture",void 0),C([ve("_markAllSubMeshesAsTexturesDirty")],e.prototype,"lightmapTexture",void 0),C([ot("refractionTexture")],e.prototype,"_refractionTexture",void 0),C([ve("_markAllSubMeshesAsTexturesDirty")],e.prototype,"refractionTexture",void 0),C([wt("ambient")],e.prototype,"ambientColor",void 0),C([wt("diffuse")],e.prototype,"diffuseColor",void 0),C([wt("specular")],e.prototype,"specularColor",void 0),C([wt("emissive")],e.prototype,"emissiveColor",void 0),C([I()],e.prototype,"specularPower",void 0),C([I("useAlphaFromDiffuseTexture")],e.prototype,"_useAlphaFromDiffuseTexture",void 0),C([ve("_markAllSubMeshesAsTexturesAndMiscDirty")],e.prototype,"useAlphaFromDiffuseTexture",void 0),C([I("useEmissiveAsIllumination")],e.prototype,"_useEmissiveAsIllumination",void 0),C([ve("_markAllSubMeshesAsTexturesDirty")],e.prototype,"useEmissiveAsIllumination",void 0),C([I("linkEmissiveWithDiffuse")],e.prototype,"_linkEmissiveWithDiffuse",void 0),C([ve("_markAllSubMeshesAsTexturesDirty")],e.prototype,"linkEmissiveWithDiffuse",void 0),C([I("useSpecularOverAlpha")],e.prototype,"_useSpecularOverAlpha",void 0),C([ve("_markAllSubMeshesAsTexturesDirty")],e.prototype,"useSpecularOverAlpha",void 0),C([I("useReflectionOverAlpha")],e.prototype,"_useReflectionOverAlpha",void 0),C([ve("_markAllSubMeshesAsTexturesDirty")],e.prototype,"useReflectionOverAlpha",void 0),C([I("disableLighting")],e.prototype,"_disableLighting",void 0),C([ve("_markAllSubMeshesAsLightsDirty")],e.prototype,"disableLighting",void 0),C([I("useObjectSpaceNormalMap")],e.prototype,"_useObjectSpaceNormalMap",void 0),C([ve("_markAllSubMeshesAsTexturesDirty")],e.prototype,"useObjectSpaceNormalMap",void 0),C([I("useParallax")],e.prototype,"_useParallax",void 0),C([ve("_markAllSubMeshesAsTexturesDirty")],e.prototype,"useParallax",void 0),C([I("useParallaxOcclusion")],e.prototype,"_useParallaxOcclusion",void 0),C([ve("_markAllSubMeshesAsTexturesDirty")],e.prototype,"useParallaxOcclusion",void 0),C([I()],e.prototype,"parallaxScaleBias",void 0),C([I("roughness")],e.prototype,"_roughness",void 0),C([ve("_markAllSubMeshesAsTexturesDirty")],e.prototype,"roughness",void 0),C([I()],e.prototype,"indexOfRefraction",void 0),C([I()],e.prototype,"invertRefractionY",void 0),C([I()],e.prototype,"alphaCutOff",void 0),C([I("useLightmapAsShadowmap")],e.prototype,"_useLightmapAsShadowmap",void 0),C([ve("_markAllSubMeshesAsTexturesDirty")],e.prototype,"useLightmapAsShadowmap",void 0),C([br("diffuseFresnelParameters")],e.prototype,"_diffuseFresnelParameters",void 0),C([ve("_markAllSubMeshesAsFresnelDirty")],e.prototype,"diffuseFresnelParameters",void 0),C([br("opacityFresnelParameters")],e.prototype,"_opacityFresnelParameters",void 0),C([ve("_markAllSubMeshesAsFresnelAndMiscDirty")],e.prototype,"opacityFresnelParameters",void 0),C([br("reflectionFresnelParameters")],e.prototype,"_reflectionFresnelParameters",void 0),C([ve("_markAllSubMeshesAsFresnelDirty")],e.prototype,"reflectionFresnelParameters",void 0),C([br("refractionFresnelParameters")],e.prototype,"_refractionFresnelParameters",void 0),C([ve("_markAllSubMeshesAsFresnelDirty")],e.prototype,"refractionFresnelParameters",void 0),C([br("emissiveFresnelParameters")],e.prototype,"_emissiveFresnelParameters",void 0),C([ve("_markAllSubMeshesAsFresnelDirty")],e.prototype,"emissiveFresnelParameters",void 0),C([I("useReflectionFresnelFromSpecular")],e.prototype,"_useReflectionFresnelFromSpecular",void 0),C([ve("_markAllSubMeshesAsFresnelDirty")],e.prototype,"useReflectionFresnelFromSpecular",void 0),C([I("useGlossinessFromSpecularMapAlpha")],e.prototype,"_useGlossinessFromSpecularMapAlpha",void 0),C([ve("_markAllSubMeshesAsTexturesDirty")],e.prototype,"useGlossinessFromSpecularMapAlpha",void 0),C([I("maxSimultaneousLights")],e.prototype,"_maxSimultaneousLights",void 0),C([ve("_markAllSubMeshesAsLightsDirty")],e.prototype,"maxSimultaneousLights",void 0),C([I("invertNormalMapX")],e.prototype,"_invertNormalMapX",void 0),C([ve("_markAllSubMeshesAsTexturesDirty")],e.prototype,"invertNormalMapX",void 0),C([I("invertNormalMapY")],e.prototype,"_invertNormalMapY",void 0),C([ve("_markAllSubMeshesAsTexturesDirty")],e.prototype,"invertNormalMapY",void 0),C([I("twoSidedLighting")],e.prototype,"_twoSidedLighting",void 0),C([ve("_markAllSubMeshesAsTexturesDirty")],e.prototype,"twoSidedLighting",void 0),C([I()],e.prototype,"useLogarithmicDepth",null),e}(an);We("BABYLON.StandardMaterial",$t);Re.DefaultMaterialFactory=function(i){return new $t("default material",i)};var At=function(){function i(e,t,r){r===void 0&&(r=Number.MAX_VALUE),this.origin=e,this.direction=t,this.length=r}return i.prototype.clone=function(){return new i(this.origin.clone(),this.direction.clone(),this.length)},i.prototype.intersectsBoxMinMax=function(e,t,r){r===void 0&&(r=0);var n=i._TmpVector3[0].copyFromFloats(e.x-r,e.y-r,e.z-r),a=i._TmpVector3[1].copyFromFloats(t.x+r,t.y+r,t.z+r),s=0,o=Number.MAX_VALUE,l,u,f,h;if(Math.abs(this.direction.x)<1e-7){if(this.origin.x<n.x||this.origin.x>a.x)return!1}else if(l=1/this.direction.x,u=(n.x-this.origin.x)*l,f=(a.x-this.origin.x)*l,f===-1/0&&(f=1/0),u>f&&(h=u,u=f,f=h),s=Math.max(u,s),o=Math.min(f,o),s>o)return!1;if(Math.abs(this.direction.y)<1e-7){if(this.origin.y<n.y||this.origin.y>a.y)return!1}else if(l=1/this.direction.y,u=(n.y-this.origin.y)*l,f=(a.y-this.origin.y)*l,f===-1/0&&(f=1/0),u>f&&(h=u,u=f,f=h),s=Math.max(u,s),o=Math.min(f,o),s>o)return!1;if(Math.abs(this.direction.z)<1e-7){if(this.origin.z<n.z||this.origin.z>a.z)return!1}else if(l=1/this.direction.z,u=(n.z-this.origin.z)*l,f=(a.z-this.origin.z)*l,f===-1/0&&(f=1/0),u>f&&(h=u,u=f,f=h),s=Math.max(u,s),o=Math.min(f,o),s>o)return!1;return!0},i.prototype.intersectsBox=function(e,t){return t===void 0&&(t=0),this.intersectsBoxMinMax(e.minimum,e.maximum,t)},i.prototype.intersectsSphere=function(e,t){t===void 0&&(t=0);var r=e.center.x-this.origin.x,n=e.center.y-this.origin.y,a=e.center.z-this.origin.z,s=r*r+n*n+a*a,o=e.radius+t,l=o*o;if(s<=l)return!0;var u=r*this.direction.x+n*this.direction.y+a*this.direction.z;if(u<0)return!1;var f=s-u*u;return f<=l},i.prototype.intersectsTriangle=function(e,t,r){var n=i._TmpVector3[0],a=i._TmpVector3[1],s=i._TmpVector3[2],o=i._TmpVector3[3],l=i._TmpVector3[4];t.subtractToRef(e,n),r.subtractToRef(e,a),m.CrossToRef(this.direction,a,s);var u=m.Dot(n,s);if(u===0)return null;var f=1/u;this.origin.subtractToRef(e,o);var h=m.Dot(o,s)*f;if(h<0||h>1)return null;m.CrossToRef(o,n,l);var c=m.Dot(this.direction,l)*f;if(c<0||h+c>1)return null;var d=m.Dot(a,l)*f;return d>this.length?null:new Vi(1-h-c,h,d)},i.prototype.intersectsPlane=function(e){var t,r=m.Dot(e.normal,this.direction);if(Math.abs(r)<999999997475243e-21)return null;var n=m.Dot(e.normal,this.origin);return t=(-e.d-n)/r,t<0?t<-999999997475243e-21?null:0:t},i.prototype.intersectsAxis=function(e,t){switch(t===void 0&&(t=0),e){case"y":{var r=(this.origin.y-t)/this.direction.y;return r>0?null:new m(this.origin.x+this.direction.x*-r,t,this.origin.z+this.direction.z*-r)}case"x":{var r=(this.origin.x-t)/this.direction.x;return r>0?null:new m(t,this.origin.y+this.direction.y*-r,this.origin.z+this.direction.z*-r)}case"z":{var r=(this.origin.z-t)/this.direction.z;return r>0?null:new m(this.origin.x+this.direction.x*-r,this.origin.y+this.direction.y*-r,t)}default:return null}},i.prototype.intersectsMesh=function(e,t){var r=U.Matrix[0];return e.getWorldMatrix().invertToRef(r),this._tmpRay?i.TransformToRef(this,r,this._tmpRay):this._tmpRay=i.Transform(this,r),e.intersects(this._tmpRay,t)},i.prototype.intersectsMeshes=function(e,t,r){r?r.length=0:r=[];for(var n=0;n<e.length;n++){var a=this.intersectsMesh(e[n],t);a.hit&&r.push(a)}return r.sort(this._comparePickingInfo),r},i.prototype._comparePickingInfo=function(e,t){return e.distance<t.distance?-1:e.distance>t.distance?1:0},i.prototype.intersectionSegment=function(e,t,r){var n=this.origin,a=U.Vector3[0],s=U.Vector3[1],o=U.Vector3[2],l=U.Vector3[3];t.subtractToRef(e,a),this.direction.scaleToRef(i._Rayl,o),n.addToRef(o,s),e.subtractToRef(n,l);var u=m.Dot(a,a),f=m.Dot(a,o),h=m.Dot(o,o),c=m.Dot(a,l),d=m.Dot(o,l),p=u*h-f*f,_,g=p,v,y=p;p<i._Smallnum?(_=0,g=1,v=d,y=h):(_=f*d-h*c,v=u*d-f*c,_<0?(_=0,v=d,y=h):_>g&&(_=g,v=d+f,y=h)),v<0?(v=0,-c<0?_=0:-c>u?_=g:(_=-c,g=u)):v>y&&(v=y,-c+f<0?_=0:-c+f>u?_=g:(_=-c+f,g=u));var b=Math.abs(_)<i._Smallnum?0:_/g,E=Math.abs(v)<i._Smallnum?0:v/y,A=U.Vector3[4];o.scaleToRef(E,A);var S=U.Vector3[5];a.scaleToRef(b,S),S.addInPlace(l);var T=U.Vector3[6];S.subtractToRef(A,T);var M=E>0&&E<=this.length&&T.lengthSquared()<r*r;return M?S.length():-1},i.prototype.update=function(e,t,r,n,a,s,o,l){if(l===void 0&&(l=!1),l){i._RayDistant||(i._RayDistant=i.Zero()),i._RayDistant.unprojectRayToRef(e,t,r,n,G.IdentityReadOnly,s,o);var u=U.Matrix[0];a.invertToRef(u),i.TransformToRef(i._RayDistant,u,this)}else this.unprojectRayToRef(e,t,r,n,a,s,o);return this},i.Zero=function(){return new i(m.Zero(),m.Zero())},i.CreateNew=function(e,t,r,n,a,s,o){var l=i.Zero();return l.update(e,t,r,n,a,s,o)},i.CreateNewFromTo=function(e,t,r){r===void 0&&(r=G.IdentityReadOnly);var n=t.subtract(e),a=Math.sqrt(n.x*n.x+n.y*n.y+n.z*n.z);return n.normalize(),i.Transform(new i(e,n,a),r)},i.Transform=function(e,t){var r=new i(new m(0,0,0),new m(0,0,0));return i.TransformToRef(e,t,r),r},i.TransformToRef=function(e,t,r){m.TransformCoordinatesToRef(e.origin,t,r.origin),m.TransformNormalToRef(e.direction,t,r.direction),r.length=e.length;var n=r.direction,a=n.length();if(!(a===0||a===1)){var s=1/a;n.x*=s,n.y*=s,n.z*=s,r.length*=a}},i.prototype.unprojectRayToRef=function(e,t,r,n,a,s,o){var l,u=U.Matrix[0];a.multiplyToRef(s,u),u.multiplyToRef(o,u),u.invert();var f=U.Vector3[0];f.x=e/r*2-1,f.y=-(t/n*2-1),f.z=!((l=ye.LastCreatedEngine)===null||l===void 0)&&l.isNDCHalfZRange?0:-1;var h=U.Vector3[1].copyFromFloats(f.x,f.y,1-1e-8),c=U.Vector3[2],d=U.Vector3[3];m._UnprojectFromInvertedMatrixToRef(f,u,c),m._UnprojectFromInvertedMatrixToRef(h,u,d),this.origin.copyFrom(c),d.subtractToRef(c,this.direction),this.direction.normalize()},i._TmpVector3=je.BuildArray(6,m.Zero),i._RayDistant=i.Zero(),i._Smallnum=1e-8,i._Rayl=1e9,i}();Re.prototype.createPickingRay=function(i,e,t,r,n){n===void 0&&(n=!1);var a=At.Zero();return this.createPickingRayToRef(i,e,t,a,r,n),a};Re.prototype.createPickingRayToRef=function(i,e,t,r,n,a,s){a===void 0&&(a=!1),s===void 0&&(s=!1);var o=this.getEngine();if(!n){if(!this.activeCamera)return this;n=this.activeCamera}var l=n.viewport,u=l.toGlobal(o.getRenderWidth(),o.getRenderHeight());return i=i/o.getHardwareScalingLevel()-u.x,e=e/o.getHardwareScalingLevel()-(o.getRenderHeight()-u.y-u.height),r.update(i,e,u.width,u.height,t||G.IdentityReadOnly,a?G.IdentityReadOnly:n.getViewMatrix(),n.getProjectionMatrix(),s),this};Re.prototype.createPickingRayInCameraSpace=function(i,e,t){var r=At.Zero();return this.createPickingRayInCameraSpaceToRef(i,e,r,t),r};Re.prototype.createPickingRayInCameraSpaceToRef=function(i,e,t,r){if(!Et)return this;var n=this.getEngine();if(!r){if(!this.activeCamera)throw new Error("Active camera not set");r=this.activeCamera}var a=r.viewport,s=a.toGlobal(n.getRenderWidth(),n.getRenderHeight()),o=G.Identity();return i=i/n.getHardwareScalingLevel()-s.x,e=e/n.getHardwareScalingLevel()-(n.getRenderHeight()-s.y-s.height),t.update(i,e,s.width,s.height,o,o,r.getProjectionMatrix()),this};Re.prototype._internalPickForMesh=function(i,e,t,r,n,a,s,o){var l=e(r,t.enableDistantPicking),u=t.intersects(l,n,s,a,r,o);return!u||!u.hit||!n&&i!=null&&u.distance>=i.distance?null:u};Re.prototype._internalPick=function(i,e,t,r,n){if(!Et)return null;for(var a=null,s=0;s<this.meshes.length;s++){var o=this.meshes[s];if(e){if(!e(o))continue}else if(!o.isEnabled()||!o.isVisible||!o.isPickable)continue;var l=o.getWorldMatrix();if(o.hasThinInstances&&o.thinInstanceEnablePicking){var u=this._internalPickForMesh(a,i,o,l,!0,!0,n);if(u){if(r)return u;for(var f=U.Matrix[1],h=o.thinInstanceGetWorldMatrices(),c=0;c<h.length;c++){var d=h[c];d.multiplyToRef(l,f);var p=this._internalPickForMesh(a,i,o,f,t,r,n,!0);if(p&&(a=p,a.thinInstanceIndex=c,t))return a}}}else{var u=this._internalPickForMesh(a,i,o,l,t,r,n);if(u&&(a=u,t))return a}}return a||new Et};Re.prototype._internalMultiPick=function(i,e,t){if(!Et)return null;for(var r=new Array,n=0;n<this.meshes.length;n++){var a=this.meshes[n];if(e){if(!e(a))continue}else if(!a.isEnabled()||!a.isVisible||!a.isPickable)continue;var s=a.getWorldMatrix();if(a.hasThinInstances&&a.thinInstanceEnablePicking){var o=this._internalPickForMesh(null,i,a,s,!0,!0,t);if(o)for(var l=U.Matrix[1],u=a.thinInstanceGetWorldMatrices(),f=0;f<u.length;f++){var h=u[f];h.multiplyToRef(s,l);var c=this._internalPickForMesh(null,i,a,l,!1,!1,t,!0);c&&(c.thinInstanceIndex=f,r.push(c))}}else{var o=this._internalPickForMesh(null,i,a,s,!1,!1,t);o&&r.push(o)}}return r};Re.prototype.pickWithBoundingInfo=function(i,e,t,r,n){var a=this;if(!Et)return null;var s=this._internalPick(function(o){return a._tempPickingRay||(a._tempPickingRay=At.Zero()),a.createPickingRayToRef(i,e,o,a._tempPickingRay,n||null),a._tempPickingRay},t,r,!0);return s&&(s.ray=this.createPickingRay(i,e,G.Identity(),n||null)),s};Re.prototype.pick=function(i,e,t,r,n,a,s){var o=this;if(!Et)return null;var l=this._internalPick(function(u,f){return o._tempPickingRay||(o._tempPickingRay=At.Zero()),o.createPickingRayToRef(i,e,u,o._tempPickingRay,n||null,!1,f),o._tempPickingRay},t,r,!1,a);return l&&(l.ray=this.createPickingRay(i,e,G.Identity(),n||null)),l};Re.prototype.pickWithRay=function(i,e,t,r){var n=this,a=this._internalPick(function(s){return n._pickWithRayInverseMatrix||(n._pickWithRayInverseMatrix=G.Identity()),s.invertToRef(n._pickWithRayInverseMatrix),n._cachedRayForTransform||(n._cachedRayForTransform=At.Zero()),At.TransformToRef(i,n._pickWithRayInverseMatrix,n._cachedRayForTransform),n._cachedRayForTransform},e,t,!1,r);return a&&(a.ray=i),a};Re.prototype.multiPick=function(i,e,t,r,n){var a=this;return this._internalMultiPick(function(s){return a.createPickingRay(i,e,s,r||null)},t,n)};Re.prototype.multiPickWithRay=function(i,e,t){var r=this;return this._internalMultiPick(function(n){return r._pickWithRayInverseMatrix||(r._pickWithRayInverseMatrix=G.Identity()),n.invertToRef(r._pickWithRayInverseMatrix),r._cachedRayForTransform||(r._cachedRayForTransform=At.Zero()),At.TransformToRef(i,r._pickWithRayInverseMatrix,r._cachedRayForTransform),r._cachedRayForTransform},e,t)};Ne.prototype.getForwardRay=function(i,e,t){return i===void 0&&(i=100),this.getForwardRayToRef(new At(m.Zero(),m.Zero(),i),i,e,t)};Ne.prototype.getForwardRayToRef=function(i,e,t,r){return e===void 0&&(e=100),t||(t=this.getWorldMatrix()),i.length=e,r?i.origin.copyFrom(r):i.origin.copyFrom(this.position),U.Vector3[2].set(0,0,this._scene.useRightHandedSystem?-1:1),m.TransformNormalToRef(U.Vector3[2],t,U.Vector3[3]),m.NormalizeToRef(U.Vector3[3],i.direction),i};var cr=function(){function i(){}return i._RemoveAndStorePivotPoint=function(e){e&&i._PivotCached===0&&(e.getPivotPointToRef(i._OldPivotPoint),i._PivotPostMultiplyPivotMatrix=e._postMultiplyPivotMatrix,i._OldPivotPoint.equalsToFloats(0,0,0)||(e.setPivotMatrix(G.IdentityReadOnly),i._OldPivotPoint.subtractToRef(e.getPivotPoint(),i._PivotTranslation),i._PivotTmpVector.copyFromFloats(1,1,1),i._PivotTmpVector.subtractInPlace(e.scaling),i._PivotTmpVector.multiplyInPlace(i._PivotTranslation),e.position.addInPlace(i._PivotTmpVector))),i._PivotCached++},i._RestorePivotPoint=function(e){e&&!i._OldPivotPoint.equalsToFloats(0,0,0)&&i._PivotCached===1&&(e.setPivotPoint(i._OldPivotPoint),e._postMultiplyPivotMatrix=i._PivotPostMultiplyPivotMatrix,i._PivotTmpVector.copyFromFloats(1,1,1),i._PivotTmpVector.subtractInPlace(e.scaling),i._PivotTmpVector.multiplyInPlace(i._PivotTranslation),e.position.subtractInPlace(i._PivotTmpVector)),this._PivotCached--},i._PivotCached=0,i._OldPivotPoint=new m,i._PivotTranslation=new m,i._PivotTmpVector=new m,i._PivotPostMultiplyPivotMatrix=!1,i}(),_h=function(){function i(e){this._useAlternatePickedPointAboveMaxDragAngleDragSpeed=-1.1,this.maxDragAngle=0,this._useAlternatePickedPointAboveMaxDragAngle=!1,this.currentDraggingPointerId=-1,this.dragging=!1,this.dragDeltaRatio=.2,this.updateDragPlane=!0,this._debugMode=!1,this._moving=!1,this.onDragObservable=new X,this.onDragStartObservable=new X,this.onDragEndObservable=new X,this.onEnabledObservable=new X,this.moveAttached=!0,this._enabled=!0,this.startAndReleaseDragOnPointerEvents=!0,this.detachCameraControls=!0,this.useObjectOrientationForDragging=!0,this.validateDrag=function(r){return!0},this._tmpVector=new m(0,0,0),this._alternatePickedPoint=new m(0,0,0),this._worldDragAxis=new m(0,0,0),this._targetPosition=new m(0,0,0),this._attachedToElement=!1,this._startDragRay=new At(new m,new m),this._lastPointerRay={},this._dragDelta=new m,this._pointA=new m(0,0,0),this._pointC=new m(0,0,0),this._localAxis=new m(0,0,0),this._lookAt=new m(0,0,0),this._options=e||{};var t=0;if(this._options.dragAxis&&t++,this._options.dragPlaneNormal&&t++,t>1)throw"Multiple drag modes specified in dragBehavior options. Only one expected"}return Object.defineProperty(i.prototype,"currentDraggingPointerID",{get:function(){return this.currentDraggingPointerId},set:function(e){this.currentDraggingPointerId=e},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"enabled",{get:function(){return this._enabled},set:function(e){e!=this._enabled&&this.onEnabledObservable.notifyObservers(e),this._enabled=e},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"options",{get:function(){return this._options},set:function(e){this._options=e},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"name",{get:function(){return"PointerDrag"},enumerable:!1,configurable:!0}),i.prototype.init=function(){},i.prototype.attach=function(e,t){var r=this;this._scene=e.getScene(),e.isNearGrabbable=!0,this.attachedNode=e,i._PlaneScene||(this._debugMode?i._PlaneScene=this._scene:(i._PlaneScene=new Re(this._scene.getEngine(),{virtual:!0}),i._PlaneScene.detachControl(),this._scene.onDisposeObservable.addOnce(function(){i._PlaneScene.dispose(),i._PlaneScene=null}))),this._dragPlane=li("pointerDragPlane",{size:this._debugMode?1:1e4,updatable:!1,sideOrientation:O.DOUBLESIDE},i._PlaneScene),this.lastDragPosition=new m(0,0,0);var n=t||function(a){return r.attachedNode==a||a.isDescendantOf(r.attachedNode)};this._pointerObserver=this._scene.onPointerObservable.add(function(a){if(!r.enabled){r._attachedToElement&&r.releaseDrag();return}if(a.type==fe.POINTERDOWN)r.startAndReleaseDragOnPointerEvents&&!r.dragging&&a.pickInfo&&a.pickInfo.hit&&a.pickInfo.pickedMesh&&a.pickInfo.pickedPoint&&a.pickInfo.ray&&n(a.pickInfo.pickedMesh)&&r._startDrag(a.event.pointerId,a.pickInfo.ray,a.pickInfo.pickedPoint);else if(a.type==fe.POINTERUP)r.startAndReleaseDragOnPointerEvents&&r.currentDraggingPointerId==a.event.pointerId&&r.releaseDrag();else if(a.type==fe.POINTERMOVE){var s=a.event.pointerId;if(r.currentDraggingPointerId===i._AnyMouseId&&s!==i._AnyMouseId){var o=a.event,l=o.pointerType==="mouse"||!r._scene.getEngine().hostInformation.isMobile&&o instanceof MouseEvent;l&&(r._lastPointerRay[r.currentDraggingPointerId]&&(r._lastPointerRay[s]=r._lastPointerRay[r.currentDraggingPointerId],delete r._lastPointerRay[r.currentDraggingPointerId]),r.currentDraggingPointerId=s)}r._lastPointerRay[s]||(r._lastPointerRay[s]=new At(new m,new m)),a.pickInfo&&a.pickInfo.ray&&(r._lastPointerRay[s].origin.copyFrom(a.pickInfo.ray.origin),r._lastPointerRay[s].direction.copyFrom(a.pickInfo.ray.direction),r.currentDraggingPointerId==s&&r.dragging&&r._moveDrag(a.pickInfo.ray))}}),this._beforeRenderObserver=this._scene.onBeforeRenderObservable.add(function(){if(r._moving&&r.moveAttached){var a=!1;cr._RemoveAndStorePivotPoint(r.attachedNode),r._targetPosition.subtractToRef(r.attachedNode.absolutePosition,r._tmpVector),r._tmpVector.scaleInPlace(r.dragDeltaRatio),r.attachedNode.getAbsolutePosition().addToRef(r._tmpVector,r._tmpVector),r.validateDrag(r._tmpVector)&&(r.attachedNode.setAbsolutePosition(r._tmpVector),a=!0),cr._RestorePivotPoint(r.attachedNode),a&&r.attachedNode.computeWorldMatrix()}})},i.prototype.releaseDrag=function(){if(this.dragging&&(this.dragging=!1,this.onDragEndObservable.notifyObservers({dragPlanePoint:this.lastDragPosition,pointerId:this.currentDraggingPointerId})),this.currentDraggingPointerId=-1,this._moving=!1,this.detachCameraControls&&this._attachedToElement&&this._scene.activeCamera&&!this._scene.activeCamera.leftCamera){if(this._scene.activeCamera.getClassName()==="ArcRotateCamera"){var e=this._scene.activeCamera;e.attachControl(e.inputs?e.inputs.noPreventDefault:!0,e._useCtrlForPanning,e._panningMouseButton)}else this._scene.activeCamera.attachControl(this._scene.activeCamera.inputs?this._scene.activeCamera.inputs.noPreventDefault:!0);this._attachedToElement=!1}},i.prototype.startDrag=function(e,t,r){e===void 0&&(e=i._AnyMouseId),this._startDrag(e,t,r);var n=this._lastPointerRay[e];e===i._AnyMouseId&&(n=this._lastPointerRay[Object.keys(this._lastPointerRay)[0]]),n&&this._moveDrag(n)},i.prototype._startDrag=function(e,t,r){if(!(!this._scene.activeCamera||this.dragging||!this.attachedNode)){cr._RemoveAndStorePivotPoint(this.attachedNode),t?(this._startDragRay.direction.copyFrom(t.direction),this._startDragRay.origin.copyFrom(t.origin)):(this._startDragRay.origin.copyFrom(this._scene.activeCamera.position),this.attachedNode.getWorldMatrix().getTranslationToRef(this._tmpVector),this._tmpVector.subtractToRef(this._scene.activeCamera.position,this._startDragRay.direction)),this._updateDragPlanePosition(this._startDragRay,r||this._tmpVector);var n=this._pickWithRayOnDragPlane(this._startDragRay);n&&(this.dragging=!0,this.currentDraggingPointerId=e,this.lastDragPosition.copyFrom(n),this.onDragStartObservable.notifyObservers({dragPlanePoint:n,pointerId:this.currentDraggingPointerId}),this._targetPosition.copyFrom(this.attachedNode.getAbsolutePosition()),this.detachCameraControls&&this._scene.activeCamera&&this._scene.activeCamera.inputs&&!this._scene.activeCamera.leftCamera&&(this._scene.activeCamera.inputs.attachedToElement?(this._scene.activeCamera.detachControl(),this._attachedToElement=!0):this._attachedToElement=!1)),cr._RestorePivotPoint(this.attachedNode)}},i.prototype._moveDrag=function(e){this._moving=!0;var t=this._pickWithRayOnDragPlane(e);if(t){cr._RemoveAndStorePivotPoint(this.attachedNode),this.updateDragPlane&&this._updateDragPlanePosition(e,t);var r=0;this._options.dragAxis?(this.useObjectOrientationForDragging?m.TransformCoordinatesToRef(this._options.dragAxis,this.attachedNode.getWorldMatrix().getRotationMatrix(),this._worldDragAxis):this._worldDragAxis.copyFrom(this._options.dragAxis),t.subtractToRef(this.lastDragPosition,this._tmpVector),r=m.Dot(this._tmpVector,this._worldDragAxis),this._worldDragAxis.scaleToRef(r,this._dragDelta)):(r=this._dragDelta.length(),t.subtractToRef(this.lastDragPosition,this._dragDelta)),this._targetPosition.addInPlace(this._dragDelta),this.onDragObservable.notifyObservers({dragDistance:r,delta:this._dragDelta,dragPlanePoint:t,dragPlaneNormal:this._dragPlane.forward,pointerId:this.currentDraggingPointerId}),this.lastDragPosition.copyFrom(t),cr._RestorePivotPoint(this.attachedNode)}},i.prototype._pickWithRayOnDragPlane=function(e){var t=this;if(!e)return null;var r=Math.acos(m.Dot(this._dragPlane.forward,e.direction));if(r>Math.PI/2&&(r=Math.PI-r),this.maxDragAngle>0&&r>this.maxDragAngle)if(this._useAlternatePickedPointAboveMaxDragAngle){this._tmpVector.copyFrom(e.direction),this.attachedNode.absolutePosition.subtractToRef(e.origin,this._alternatePickedPoint),this._alternatePickedPoint.normalize(),this._alternatePickedPoint.scaleInPlace(this._useAlternatePickedPointAboveMaxDragAngleDragSpeed*m.Dot(this._alternatePickedPoint,this._tmpVector)),this._tmpVector.addInPlace(this._alternatePickedPoint);var n=m.Dot(this._dragPlane.forward,this._tmpVector);return this._dragPlane.forward.scaleToRef(-n,this._alternatePickedPoint),this._alternatePickedPoint.addInPlace(this._tmpVector),this._alternatePickedPoint.addInPlace(this.attachedNode.absolutePosition),this._alternatePickedPoint}else return null;var a=i._PlaneScene.pickWithRay(e,function(s){return s==t._dragPlane});return a&&a.hit&&a.pickedMesh&&a.pickedPoint?a.pickedPoint:null},i.prototype._updateDragPlanePosition=function(e,t){this._pointA.copyFrom(t),this._options.dragAxis?(this.useObjectOrientationForDragging?m.TransformCoordinatesToRef(this._options.dragAxis,this.attachedNode.getWorldMatrix().getRotationMatrix(),this._localAxis):this._localAxis.copyFrom(this._options.dragAxis),e.origin.subtractToRef(this._pointA,this._pointC),this._pointC.normalize(),Math.abs(m.Dot(this._localAxis,this._pointC))>.999?Math.abs(m.Dot(m.UpReadOnly,this._pointC))>.999?this._lookAt.copyFrom(m.Right()):this._lookAt.copyFrom(m.UpReadOnly):(m.CrossToRef(this._localAxis,this._pointC,this._lookAt),m.CrossToRef(this._localAxis,this._lookAt,this._lookAt),this._lookAt.normalize()),this._dragPlane.position.copyFrom(this._pointA),this._pointA.addToRef(this._lookAt,this._lookAt),this._dragPlane.lookAt(this._lookAt)):this._options.dragPlaneNormal?(this.useObjectOrientationForDragging?m.TransformCoordinatesToRef(this._options.dragPlaneNormal,this.attachedNode.getWorldMatrix().getRotationMatrix(),this._localAxis):this._localAxis.copyFrom(this._options.dragPlaneNormal),this._dragPlane.position.copyFrom(this._pointA),this._pointA.addToRef(this._localAxis,this._lookAt),this._dragPlane.lookAt(this._lookAt)):(this._dragPlane.position.copyFrom(this._pointA),this._dragPlane.lookAt(e.origin)),this._dragPlane.position.copyFrom(this.attachedNode.getAbsolutePosition()),this._dragPlane.computeWorldMatrix(!0)},i.prototype.detach=function(){this.attachedNode&&(this.attachedNode.isNearGrabbable=!1),this._pointerObserver&&this._scene.onPointerObservable.remove(this._pointerObserver),this._beforeRenderObserver&&this._scene.onBeforeRenderObservable.remove(this._beforeRenderObserver),this._dragPlane&&this._dragPlane.dispose(),this.releaseDrag()},i._AnyMouseId=-2,i}();ct.AddNodeConstructor("Light_Type_3",function(i,e){return function(){return new _n(i,m.Zero(),e)}});var _n=function(i){$(e,i);function e(t,r,n){var a=i.call(this,t,n)||this;return a.groundColor=new me(0,0,0),a.direction=r||m.Up(),a}return e.prototype._buildUniformLayout=function(){this._uniformBuffer.addUniform("vLightData",4),this._uniformBuffer.addUniform("vLightDiffuse",4),this._uniformBuffer.addUniform("vLightSpecular",4),this._uniformBuffer.addUniform("vLightGround",3),this._uniformBuffer.addUniform("shadowsInfo",3),this._uniformBuffer.addUniform("depthValues",2),this._uniformBuffer.create()},e.prototype.getClassName=function(){return"HemisphericLight"},e.prototype.setDirectionToTarget=function(t){return this.direction=m.Normalize(t.subtract(m.Zero())),this.direction},e.prototype.getShadowGenerator=function(){return null},e.prototype.transferToEffect=function(t,r){var n=m.Normalize(this.direction);return this._uniformBuffer.updateFloat4("vLightData",n.x,n.y,n.z,0,r),this._uniformBuffer.updateColor3("vLightGround",this.groundColor.scale(this.intensity),r),this},e.prototype.transferToNodeMaterialEffect=function(t,r){var n=m.Normalize(this.direction);return t.setFloat3(r,n.x,n.y,n.z),this},e.prototype.computeWorldMatrix=function(){return this._worldMatrix||(this._worldMatrix=G.Identity()),this._worldMatrix},e.prototype.getTypeID=function(){return gt.LIGHTTYPEID_HEMISPHERICLIGHT},e.prototype.prepareLightSpecificDefines=function(t,r){t["HEMILIGHT"+r]=!0},C([wt()],e.prototype,"groundColor",void 0),C([xt()],e.prototype,"direction",void 0),e}(gt),ks=function(){function i(e,t){t===void 0&&(t=!0);var r=this;this.originalScene=e,this._pointerCaptures={},this._lastPointerEvents={},this._sharedGizmoLight=null,this._renderCamera=null,this.pickUtilitySceneFirst=!0,this.shouldRender=!0,this.onlyCheckPointerDownEvents=!0,this.processAllEvents=!1,this.pickingEnabled=!0,this.onPointerOutObservable=new X,this.utilityLayerScene=new Re(e.getEngine(),{virtual:!0}),this.utilityLayerScene.useRightHandedSystem=e.useRightHandedSystem,this.utilityLayerScene._allowPostProcessClearColor=!1,this.utilityLayerScene.postProcessesEnabled=!1,this.utilityLayerScene.detachControl(),t&&(this._originalPointerObserver=e.onPrePointerObservable.add(function(n){if(!!r.utilityLayerScene.activeCamera&&!!r.pickingEnabled&&!(!r.processAllEvents&&n.type!==fe.POINTERMOVE&&n.type!==fe.POINTERUP&&n.type!==fe.POINTERDOWN&&n.type!==fe.POINTERDOUBLETAP)){r.utilityLayerScene.pointerX=e.pointerX,r.utilityLayerScene.pointerY=e.pointerY;var a=n.event;if(e.isPointerCaptured(a.pointerId)){r._pointerCaptures[a.pointerId]=!1;return}var s=function(f){var h=null;if(n.nearInteractionPickingInfo)n.nearInteractionPickingInfo.pickedMesh.getScene()==f?h=n.nearInteractionPickingInfo:h=new Et;else{var c=null;r._renderCamera&&(c=f._activeCamera,f._activeCamera=r._renderCamera,n.ray=null),h=n.ray?f.pickWithRay(n.ray):f.pick(e.pointerX,e.pointerY),c&&(f._activeCamera=c)}return h},o=s(r.utilityLayerScene);if(!n.ray&&o&&(n.ray=o.ray),r.utilityLayerScene.onPrePointerObservable.notifyObservers(n),r.onlyCheckPointerDownEvents&&n.type!=fe.POINTERDOWN){n.skipOnPointerObservable||r.utilityLayerScene.onPointerObservable.notifyObservers(new Yt(n.type,n.event,o),n.type),n.type===fe.POINTERUP&&r._pointerCaptures[a.pointerId]&&(r._pointerCaptures[a.pointerId]=!1);return}if(r.utilityLayerScene.autoClearDepthAndStencil||r.pickUtilitySceneFirst)o&&o.hit&&(n.skipOnPointerObservable||r.utilityLayerScene.onPointerObservable.notifyObservers(new Yt(n.type,n.event,o),n.type),n.skipOnPointerObservable=!0);else{var l=s(e),u=n.event;l&&o&&(o.distance===0&&l.pickedMesh?r.mainSceneTrackerPredicate&&r.mainSceneTrackerPredicate(l.pickedMesh)?(r._notifyObservers(n,l,u),n.skipOnPointerObservable=!0):n.type===fe.POINTERDOWN?r._pointerCaptures[u.pointerId]=!0:(n.type===fe.POINTERMOVE||n.type===fe.POINTERUP)&&(r._lastPointerEvents[u.pointerId]&&(r.onPointerOutObservable.notifyObservers(u.pointerId),delete r._lastPointerEvents[u.pointerId]),r._notifyObservers(n,l,u)):!r._pointerCaptures[u.pointerId]&&(o.distance<l.distance||l.distance===0)?(r._notifyObservers(n,o,u),n.skipOnPointerObservable||(n.skipOnPointerObservable=o.distance>0)):!r._pointerCaptures[u.pointerId]&&o.distance>l.distance&&(r.mainSceneTrackerPredicate&&r.mainSceneTrackerPredicate(l.pickedMesh)?(r._notifyObservers(n,l,u),n.skipOnPointerObservable=!0):(n.type===fe.POINTERMOVE||n.type===fe.POINTERUP)&&(r._lastPointerEvents[u.pointerId]&&(r.onPointerOutObservable.notifyObservers(u.pointerId),delete r._lastPointerEvents[u.pointerId]),r._notifyObservers(n,o,u))),n.type===fe.POINTERUP&&r._pointerCaptures[u.pointerId]&&(r._pointerCaptures[u.pointerId]=!1))}}}),this._originalPointerObserver&&e.onPrePointerObservable.makeObserverTopPriority(this._originalPointerObserver)),this.utilityLayerScene.autoClear=!1,this._afterRenderObserver=this.originalScene.onAfterCameraRenderObservable.add(function(n){r.shouldRender&&n==r.getRenderCamera()&&(n.outputRenderTarget&&n.isRigCamera&&r.originalScene.getEngine().clear(null,!1,!0,!1),r.render())}),this._sceneDisposeObserver=this.originalScene.onDisposeObservable.add(function(){r.dispose()}),this._updateCamera()}return i.prototype.getRenderCamera=function(e){if(this._renderCamera)return this._renderCamera;var t=void 0;return this.originalScene.activeCameras&&this.originalScene.activeCameras.length>1?t=this.originalScene.activeCameras[this.originalScene.activeCameras.length-1]:t=this.originalScene.activeCamera,e&&t&&t.isRigCamera?t.rigParent:t},i.prototype.setRenderCamera=function(e){this._renderCamera=e},i.prototype._getSharedGizmoLight=function(){return this._sharedGizmoLight||(this._sharedGizmoLight=new _n("shared gizmo light",new m(0,1,0),this.utilityLayerScene),this._sharedGizmoLight.intensity=2,this._sharedGizmoLight.groundColor=me.Gray()),this._sharedGizmoLight},Object.defineProperty(i,"DefaultUtilityLayer",{get:function(){return i._DefaultUtilityLayer==null?i._CreateDefaultUtilityLayerFromScene(ye.LastCreatedScene):i._DefaultUtilityLayer},enumerable:!1,configurable:!0}),i._CreateDefaultUtilityLayerFromScene=function(e){return i._DefaultUtilityLayer=new i(e),i._DefaultUtilityLayer.originalScene.onDisposeObservable.addOnce(function(){i._DefaultUtilityLayer=null}),i._DefaultUtilityLayer},Object.defineProperty(i,"DefaultKeepDepthUtilityLayer",{get:function(){return i._DefaultKeepDepthUtilityLayer==null&&(i._DefaultKeepDepthUtilityLayer=new i(ye.LastCreatedScene),i._DefaultKeepDepthUtilityLayer.utilityLayerScene.autoClearDepthAndStencil=!1,i._DefaultKeepDepthUtilityLayer.originalScene.onDisposeObservable.addOnce(function(){i._DefaultKeepDepthUtilityLayer=null})),i._DefaultKeepDepthUtilityLayer},enumerable:!1,configurable:!0}),i.prototype._notifyObservers=function(e,t,r){e.skipOnPointerObservable||(this.utilityLayerScene.onPointerObservable.notifyObservers(new Yt(e.type,e.event,t),e.type),this._lastPointerEvents[r.pointerId]=!0)},i.prototype.render=function(){if(this._updateCamera(),this.utilityLayerScene.activeCamera){var e=this.utilityLayerScene.activeCamera.getScene(),t=this.utilityLayerScene.activeCamera;t._scene=this.utilityLayerScene,t.leftCamera&&(t.leftCamera._scene=this.utilityLayerScene),t.rightCamera&&(t.rightCamera._scene=this.utilityLayerScene),this.utilityLayerScene.render(!1),t._scene=e,t.leftCamera&&(t.leftCamera._scene=e),t.rightCamera&&(t.rightCamera._scene=e)}},i.prototype.dispose=function(){this.onPointerOutObservable.clear(),this._afterRenderObserver&&this.originalScene.onAfterCameraRenderObservable.remove(this._afterRenderObserver),this._sceneDisposeObserver&&this.originalScene.onDisposeObservable.remove(this._sceneDisposeObserver),this._originalPointerObserver&&this.originalScene.onPrePointerObservable.remove(this._originalPointerObserver),this.utilityLayerScene.dispose()},i.prototype._updateCamera=function(){this.utilityLayerScene.cameraToUseForPointers=this.getRenderCamera(),this.utilityLayerScene.activeCamera=this.getRenderCamera()},i._DefaultUtilityLayer=null,i._DefaultKeepDepthUtilityLayer=null,i}(),vh=function(){function i(e){e===void 0&&(e=ks.DefaultUtilityLayer);var t=this;this.gizmoLayer=e,this._attachedMesh=null,this._attachedNode=null,this._customRotationQuaternion=null,this._scaleRatio=1,this._isHovered=!1,this._customMeshSet=!1,this._updateGizmoRotationToMatchAttachedMesh=!0,this.updateGizmoPositionToMatchAttachedMesh=!0,this.updateScale=!0,this._interactionsEnabled=!0,this._tempQuaternion=new de(0,0,0,1),this._tempVector=new m,this._tempVector2=new m,this._tempMatrix1=new G,this._tempMatrix2=new G,this._rightHandtoLeftHandMatrix=G.RotationY(Math.PI),this._rootMesh=new O("gizmoRootNode",e.utilityLayerScene),this._rootMesh.rotationQuaternion=de.Identity(),this._beforeRenderObserver=this.gizmoLayer.utilityLayerScene.onBeforeRenderObservable.add(function(){t._update()})}return Object.defineProperty(i.prototype,"scaleRatio",{get:function(){return this._scaleRatio},set:function(e){this._scaleRatio=e},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"isHovered",{get:function(){return this._isHovered},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"attachedMesh",{get:function(){return this._attachedMesh},set:function(e){this._attachedMesh=e,e&&(this._attachedNode=e),this._rootMesh.setEnabled(!!e),this._attachedNodeChanged(e)},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"attachedNode",{get:function(){return this._attachedNode},set:function(e){this._attachedNode=e,this._attachedMesh=null,this._rootMesh.setEnabled(!!e),this._attachedNodeChanged(e)},enumerable:!1,configurable:!0}),i.prototype.setCustomMesh=function(e){if(e.getScene()!=this.gizmoLayer.utilityLayerScene)throw"When setting a custom mesh on a gizmo, the custom meshes scene must be the same as the gizmos (eg. gizmo.gizmoLayer.utilityLayerScene)";this._rootMesh.getChildMeshes().forEach(function(t){t.dispose()}),e.parent=this._rootMesh,this._customMeshSet=!0},Object.defineProperty(i.prototype,"updateGizmoRotationToMatchAttachedMesh",{get:function(){return this._updateGizmoRotationToMatchAttachedMesh},set:function(e){this._updateGizmoRotationToMatchAttachedMesh=e},enumerable:!1,configurable:!0}),i.prototype._attachedNodeChanged=function(e){},Object.defineProperty(i.prototype,"customRotationQuaternion",{get:function(){return this._customRotationQuaternion},set:function(e){this._customRotationQuaternion=e},enumerable:!1,configurable:!0}),i.prototype._update=function(){if(this.attachedNode){var e=this.attachedNode;if(this.attachedMesh&&(e=this.attachedMesh||this.attachedNode),this.updateGizmoPositionToMatchAttachedMesh){var t=e.getWorldMatrix().getRow(3),r=t?t.toVector3():new m(0,0,0);this._rootMesh.position.copyFrom(r)}if(this.updateGizmoRotationToMatchAttachedMesh?e.getWorldMatrix().decompose(void 0,this._rootMesh.rotationQuaternion):this._customRotationQuaternion?this._rootMesh.rotationQuaternion.copyFrom(this._customRotationQuaternion):this._rootMesh.rotationQuaternion.set(0,0,0,1),this.updateScale){var n=this.gizmoLayer.utilityLayerScene.activeCamera,a=n.globalPosition;n.devicePosition&&(a=n.devicePosition),this._rootMesh.position.subtractToRef(a,this._tempVector);var s=this._tempVector.length()*this.scaleRatio;this._rootMesh.scaling.set(s,s,s),e._getWorldMatrixDeterminant()<0&&(this._rootMesh.scaling.y*=-1)}else this._rootMesh.scaling.setAll(this.scaleRatio)}},i.prototype._handlePivot=function(){var e=this._attachedNode;e.isUsingPivotMatrix&&e.isUsingPivotMatrix()&&e.position&&e.getWorldMatrix().setTranslation(e.position)},i.prototype._matrixChanged=function(){if(!!this._attachedNode)if(this._attachedNode._isCamera){var e=this._attachedNode,t=void 0,r=void 0;if(e.parent){var n=this._tempMatrix2;e.parent._worldMatrix.invertToRef(n),this._attachedNode._worldMatrix.multiplyToRef(n,this._tempMatrix1),t=this._tempMatrix1}else t=this._attachedNode._worldMatrix;e.getScene().useRightHandedSystem?(this._rightHandtoLeftHandMatrix.multiplyToRef(t,this._tempMatrix2),r=this._tempMatrix2):r=t,r.decompose(this._tempVector2,this._tempQuaternion,this._tempVector);var a=this._attachedNode.getClassName()==="FreeCamera"||this._attachedNode.getClassName()==="FlyCamera"||this._attachedNode.getClassName()==="ArcFollowCamera"||this._attachedNode.getClassName()==="TargetCamera"||this._attachedNode.getClassName()==="TouchCamera"||this._attachedNode.getClassName()==="UniversalCamera";if(a){var s=this._attachedNode;s.rotation=this._tempQuaternion.toEulerAngles(),s.rotationQuaternion&&(s.rotationQuaternion.copyFrom(this._tempQuaternion),s.rotationQuaternion.normalize())}e.position.copyFrom(this._tempVector)}else if(this._attachedNode._isMesh||this._attachedNode.getClassName()==="AbstractMesh"||this._attachedNode.getClassName()==="TransformNode"||this._attachedNode.getClassName()==="InstancedMesh"){var o=this._attachedNode;if(o.parent){var n=this._tempMatrix1,l=this._tempMatrix2;o.parent.getWorldMatrix().invertToRef(n),this._attachedNode.getWorldMatrix().multiplyToRef(n,l),l.decompose(o.scaling,this._tempQuaternion,o.position)}else this._attachedNode._worldMatrix.decompose(o.scaling,this._tempQuaternion,o.position);o.billboardMode||(o.rotationQuaternion?(o.rotationQuaternion.copyFrom(this._tempQuaternion),o.rotationQuaternion.normalize()):o.rotation=this._tempQuaternion.toEulerAngles())}else if(this._attachedNode.getClassName()==="Bone"){var u=this._attachedNode,f=u.getParent();if(f){var h=this._tempMatrix1,c=this._tempMatrix2;f.getWorldMatrix().invertToRef(h),u.getWorldMatrix().multiplyToRef(h,c);var d=u.getLocalMatrix();d.copyFrom(c)}else{var d=u.getLocalMatrix();d.copyFrom(u.getWorldMatrix())}u.markAsDirty()}else{var p=this._attachedNode;if(p.getTypeID){var _=p.getTypeID();if(_===gt.LIGHTTYPEID_DIRECTIONALLIGHT||_===gt.LIGHTTYPEID_SPOTLIGHT||_===gt.LIGHTTYPEID_POINTLIGHT){var g=p.parent;if(g){var h=this._tempMatrix1,v=this._tempMatrix2;g.getWorldMatrix().invertToRef(h),p.getWorldMatrix().multiplyToRef(h,v),v.decompose(void 0,this._tempQuaternion,this._tempVector)}else this._attachedNode._worldMatrix.decompose(void 0,this._tempQuaternion,this._tempVector);p.position=new m(this._tempVector.x,this._tempVector.y,this._tempVector.z),p.direction=new m(p.direction.x,p.direction.y,p.direction.z)}}}},i.prototype._setGizmoMeshMaterial=function(e,t){e&&e.forEach(function(r){r.material=t,r.color&&(r.color=t.diffuseColor)})},i.GizmoAxisPointerObserver=function(e,t){var r=!1,n=e.utilityLayerScene.onPointerObservable.add(function(a){var s,o;if(a.pickInfo){if(a.type===fe.POINTERMOVE){if(r)return;t.forEach(function(u){var f,h;if(u.colliderMeshes&&u.gizmoMeshes){var c=((f=u.colliderMeshes)===null||f===void 0?void 0:f.indexOf((h=a==null?void 0:a.pickInfo)===null||h===void 0?void 0:h.pickedMesh))!=-1,d=u.dragBehavior.enabled?c||u.active?u.hoverMaterial:u.material:u.disableMaterial;u.gizmoMeshes.forEach(function(p){p.material=d,p.color&&(p.color=d.diffuseColor)})}})}if(a.type===fe.POINTERDOWN&&t.has((s=a.pickInfo.pickedMesh)===null||s===void 0?void 0:s.parent)){r=!0;var l=t.get((o=a.pickInfo.pickedMesh)===null||o===void 0?void 0:o.parent);l.active=!0,t.forEach(function(u){var f,h,c=((f=u.colliderMeshes)===null||f===void 0?void 0:f.indexOf((h=a==null?void 0:a.pickInfo)===null||h===void 0?void 0:h.pickedMesh))!=-1,d=(c||u.active)&&u.dragBehavior.enabled?u.hoverMaterial:u.disableMaterial;u.gizmoMeshes.forEach(function(p){p.material=d,p.color&&(p.color=d.diffuseColor)})})}a.type===fe.POINTERUP&&t.forEach(function(u){u.active=!1,r=!1,u.gizmoMeshes.forEach(function(f){f.material=u.dragBehavior.enabled?u.material:u.disableMaterial,f.color&&(f.color=u.material.diffuseColor)})})}});return n},i.prototype.dispose=function(){this._rootMesh.dispose(),this._beforeRenderObserver&&this.gizmoLayer.utilityLayerScene.onBeforeRenderObservable.remove(this._beforeRenderObserver)},i}(),dr=function(i){$(e,i);function e(t,r,n,a,s){r===void 0&&(r=me.Gray()),n===void 0&&(n=ks.DefaultUtilityLayer),a===void 0&&(a=null),s===void 0&&(s=1);var o=this,l;o=i.call(this,n)||this,o._pointerObserver=null,o.snapDistance=0,o.onSnapObservable=new X,o._isEnabled=!0,o._parent=null,o._dragging=!1,o._parent=a,o._coloredMaterial=new $t("",n.utilityLayerScene),o._coloredMaterial.diffuseColor=r,o._coloredMaterial.specularColor=r.subtract(new me(.1,.1,.1)),o._hoverMaterial=new $t("",n.utilityLayerScene),o._hoverMaterial.diffuseColor=me.Yellow(),o._disableMaterial=new $t("",n.utilityLayerScene),o._disableMaterial.diffuseColor=me.Gray(),o._disableMaterial.alpha=.4;var u=e._CreateArrow(n.utilityLayerScene,o._coloredMaterial,s),f=e._CreateArrow(n.utilityLayerScene,o._coloredMaterial,s+4,!0);o._gizmoMesh=new O("",n.utilityLayerScene),o._gizmoMesh.addChild(u),o._gizmoMesh.addChild(f),o._gizmoMesh.lookAt(o._rootMesh.position.add(t)),o._gizmoMesh.scaling.scaleInPlace(1/3),o._gizmoMesh.parent=o._rootMesh;var h=0,c=new m,d=new m,p={snapDistance:0};o.dragBehavior=new _h({dragAxis:t}),o.dragBehavior.moveAttached=!1,o._rootMesh.addBehavior(o.dragBehavior),o.dragBehavior.onDragObservable.add(function(v){if(o.attachedNode){o._handlePivot();var y=!1;if(o.snapDistance==0)o.attachedNode.getWorldMatrix().getTranslationToRef(d),d.addInPlace(v.delta),o.dragBehavior.validateDrag(d)&&(o.attachedNode.position&&o.attachedNode.position.addInPlaceFromFloats(v.delta.x,v.delta.y,v.delta.z),o.attachedNode.getWorldMatrix().addTranslationFromFloats(v.delta.x,v.delta.y,v.delta.z),o.attachedNode.updateCache(),y=!0);else if(h+=v.dragDistance,Math.abs(h)>o.snapDistance){var b=Math.floor(Math.abs(h)/o.snapDistance);h=h%o.snapDistance,v.delta.normalizeToRef(c),c.scaleInPlace(o.snapDistance*b),o.attachedNode.getWorldMatrix().getTranslationToRef(d),d.addInPlace(c),o.dragBehavior.validateDrag(d)&&(o.attachedNode.getWorldMatrix().addTranslationFromFloats(c.x,c.y,c.z),o.attachedNode.updateCache(),p.snapDistance=o.snapDistance*b,o.onSnapObservable.notifyObservers(p),y=!0)}y&&o._matrixChanged()}}),o.dragBehavior.onDragStartObservable.add(function(){o._dragging=!0}),o.dragBehavior.onDragEndObservable.add(function(){o._dragging=!1});var _=n._getSharedGizmoLight();_.includedOnlyMeshes=_.includedOnlyMeshes.concat(o._rootMesh.getChildMeshes(!1));var g={gizmoMeshes:u.getChildMeshes(),colliderMeshes:f.getChildMeshes(),material:o._coloredMaterial,hoverMaterial:o._hoverMaterial,disableMaterial:o._disableMaterial,active:!1,dragBehavior:o.dragBehavior};return(l=o._parent)===null||l===void 0||l.addToAxisCache(f,g),o._pointerObserver=n.utilityLayerScene.onPointerObservable.add(function(v){var y;if(!o._customMeshSet&&(o._isHovered=g.colliderMeshes.indexOf((y=v==null?void 0:v.pickInfo)===null||y===void 0?void 0:y.pickedMesh)!=-1,!o._parent)){var b=o.dragBehavior.enabled?o._isHovered||o._dragging?o._hoverMaterial:o._coloredMaterial:o._disableMaterial;o._setGizmoMeshMaterial(g.gizmoMeshes,b)}}),o.dragBehavior.onEnabledObservable.add(function(v){o._setGizmoMeshMaterial(g.gizmoMeshes,v?g.material:g.disableMaterial)}),o}return e._CreateArrow=function(t,r,n,a){n===void 0&&(n=1),a===void 0&&(a=!1);var s=new ht("arrow",t),o=ri("cylinder",{diameterTop:0,height:.075,diameterBottom:.0375*(1+(n-1)/4),tessellation:96},t),l=ri("cylinder",{diameterTop:.005*n,height:.275,diameterBottom:.005*n,tessellation:96},t);return o.parent=s,o.material=r,o.rotation.x=Math.PI/2,o.position.z+=.3,l.parent=s,l.material=r,l.position.z+=.275/2,l.rotation.x=Math.PI/2,a&&(l.visibility=0,o.visibility=0),s},e._CreateArrowInstance=function(t,r){for(var n=new ht("arrow",t),a=0,s=r.getChildMeshes();a<s.length;a++){var o=s[a],l=o.createInstance(o.name);l.parent=n}return n},e.prototype._attachedNodeChanged=function(t){this.dragBehavior&&(this.dragBehavior.enabled=!!t)},Object.defineProperty(e.prototype,"isEnabled",{get:function(){return this._isEnabled},set:function(t){this._isEnabled=t,t?this._parent&&(this.attachedMesh=this._parent.attachedMesh,this.attachedNode=this._parent.attachedNode):(this.attachedMesh=null,this.attachedNode=null)},enumerable:!1,configurable:!0}),e.prototype.dispose=function(){this.onSnapObservable.clear(),this.gizmoLayer.utilityLayerScene.onPointerObservable.remove(this._pointerObserver),this.dragBehavior.detach(),this._gizmoMesh&&this._gizmoMesh.dispose(),[this._coloredMaterial,this._hoverMaterial,this._disableMaterial].forEach(function(t){t&&t.dispose()}),i.prototype.dispose.call(this)},e}(vh),gh=function(){function i(e,t,r,n,a,s,o){if(t===void 0&&(t=1),r===void 0&&(r=2),o===void 0&&(o=1),this._scaleLinesFactor=4,this._instanced=!1,this.scene=null,this.scaleLines=1,e=e||ye.LastCreatedScene,!!e){if(this.scaleLines=t,!n){var l=new $t("",e);l.disableLighting=!0,l.emissiveColor=me.Red().scale(.5),n=dr._CreateArrow(e,l,o)}if(!a){var u=new $t("",e);u.disableLighting=!0,u.emissiveColor=me.Green().scale(.5),a=dr._CreateArrow(e,u,o)}if(!s){var f=new $t("",e);f.disableLighting=!0,f.emissiveColor=me.Blue().scale(.5),s=dr._CreateArrow(e,f,o)}this._xAxis=n,this._xAxis.scaling.setAll(this.scaleLines*this._scaleLinesFactor),this._yAxis=a,this._yAxis.scaling.setAll(this.scaleLines*this._scaleLinesFactor),this._zAxis=s,this._zAxis.scaling.setAll(this.scaleLines*this._scaleLinesFactor),r!=null&&(i._SetRenderingGroupId(this._xAxis,r),i._SetRenderingGroupId(this._yAxis,r),i._SetRenderingGroupId(this._zAxis,r)),this.scene=e,this.update(new m,m.Right(),m.Up(),m.Forward())}}return Object.defineProperty(i.prototype,"xAxis",{get:function(){return this._xAxis},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"yAxis",{get:function(){return this._yAxis},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"zAxis",{get:function(){return this._zAxis},enumerable:!1,configurable:!0}),i.prototype.update=function(e,t,r,n){this._xAxis.position.copyFrom(e),this._xAxis.setDirection(t),this._xAxis.scaling.setAll(this.scaleLines*this._scaleLinesFactor),this._yAxis.position.copyFrom(e),this._yAxis.setDirection(r),this._yAxis.scaling.setAll(this.scaleLines*this._scaleLinesFactor),this._zAxis.position.copyFrom(e),this._zAxis.setDirection(n),this._zAxis.scaling.setAll(this.scaleLines*this._scaleLinesFactor)},i.prototype.createInstance=function(){var e=dr._CreateArrowInstance(this.scene,this._xAxis),t=dr._CreateArrowInstance(this.scene,this._yAxis),r=dr._CreateArrowInstance(this.scene,this._zAxis),n=new i(this.scene,this.scaleLines,null,e,t,r);return n._instanced=!0,n},i.prototype.dispose=function(){this._xAxis&&this._xAxis.dispose(!1,!this._instanced),this._yAxis&&this._yAxis.dispose(!1,!this._instanced),this._zAxis&&this._zAxis.dispose(!1,!this._instanced),this.scene=null},i._SetRenderingGroupId=function(e,t){e.getChildMeshes().forEach(function(r){r.renderingGroupId=t})},i}(),jt;(function(i){i[i.Clean=0]="Clean",i[i.Stop=1]="Stop",i[i.Sync=2]="Sync",i[i.NoSync=3]="NoSync"})(jt||(jt={}));var Cr=function(){function i(){}return Object.defineProperty(i,"ForceFullSceneLoadingForIncremental",{get:function(){return Mt.ForceFullSceneLoadingForIncremental},set:function(e){Mt.ForceFullSceneLoadingForIncremental=e},enumerable:!1,configurable:!0}),Object.defineProperty(i,"ShowLoadingScreen",{get:function(){return Mt.ShowLoadingScreen},set:function(e){Mt.ShowLoadingScreen=e},enumerable:!1,configurable:!0}),Object.defineProperty(i,"loggingLevel",{get:function(){return Mt.loggingLevel},set:function(e){Mt.loggingLevel=e},enumerable:!1,configurable:!0}),Object.defineProperty(i,"CleanBoneMatrixWeights",{get:function(){return Mt.CleanBoneMatrixWeights},set:function(e){Mt.CleanBoneMatrixWeights=e},enumerable:!1,configurable:!0}),i.GetDefaultPlugin=function(){return i._RegisteredPlugins[".babylon"]},i._GetPluginForExtension=function(e){var t=i._RegisteredPlugins[e];return t||(Y.Warn("Unable to find a plugin to load "+e+" files. Trying to use .babylon default plugin. To load from a specific filetype (eg. gltf) see: https://doc.babylonjs.com/how_to/load_from_any_file_type"),i.GetDefaultPlugin())},i._GetPluginForDirectLoad=function(e){for(var t in i._RegisteredPlugins){var r=i._RegisteredPlugins[t].plugin;if(r.canDirectLoad&&r.canDirectLoad(e))return i._RegisteredPlugins[t]}return i.GetDefaultPlugin()},i._GetPluginForFilename=function(e){var t=e.indexOf("?");t!==-1&&(e=e.substring(0,t));var r=e.lastIndexOf("."),n=e.substring(r,e.length).toLowerCase();return i._GetPluginForExtension(n)},i._GetDirectLoad=function(e){return e.substr(0,5)==="data:"?e.substr(5):null},i._FormatErrorMessage=function(e,t,r){var n="Unable to load from "+e.url;return t?n+=": ".concat(t):r&&(n+=": ".concat(r)),n},i._LoadData=function(e,t,r,n,a,s,o){var l=i._GetDirectLoad(e.url),u=o?i._GetPluginForExtension(o):l?i._GetPluginForDirectLoad(e.url):i._GetPluginForFilename(e.url),f;if(u.plugin.createPlugin!==void 0?f=u.plugin.createPlugin():f=u.plugin,!f)throw"The loader plugin corresponding to the file type you are trying to load has not been found. If using es6, please import the plugin you wish to use before.";if(i.OnPluginActivatedObservable.notifyObservers(f),l&&(f.canDirectLoad&&f.canDirectLoad(e.url)||!ni(e.url))){if(f.directLoad){var h=f.directLoad(t,l);h.then?h.then(function(M){r(f,M)}).catch(function(M){a("Error in directLoad of _loadData: "+M,M)}):r(f,h)}else r(f,l);return f}var c=u.isBinary,d=function(M,D){if(t.isDisposed){a("Scene has been disposed");return}r(f,M,D)},p=null,_=!1,g=f.onDisposeObservable;g&&g.add(function(){_=!0,p&&(p.abort(),p=null),s()});var v=function(){if(!_){var M=function(x,P){a(x==null?void 0:x.statusText,P)},D=e.file||e.url;p=f.loadFile?f.loadFile(t,D,d,n,c,M):t._loadFile(D,d,n,!0,c,M)}},y=t.getEngine(),b=y.enableOfflineSupport;if(b){for(var E=!1,A=0,S=t.disableOfflineSupportExceptionRules;A<S.length;A++){var T=S[A];if(T.test(e.url)){E=!0;break}}b=!E}return b&&De.OfflineProviderFactory?t.offlineProvider=De.OfflineProviderFactory(e.url,v,y.disableManifestCheck):v(),f},i._GetFileInfo=function(e,t){var r,n,a=null;if(!t)r=e,n=te.GetFilename(e),e=te.GetFolderPath(e);else if(t.name){var s=t;r="file:".concat(s.name),n=s.name,a=s}else if(typeof t=="string"&&vt(t,"data:"))r=t,n="";else{var o=t;if(o.substr(0,1)==="/")return te.Error("Wrong sceneFilename parameter"),null;r=e+o,n=o}return{url:r,rootUrl:e,name:n,file:a}},i.GetPluginForExtension=function(e){return i._GetPluginForExtension(e).plugin},i.IsPluginForExtensionAvailable=function(e){return!!i._RegisteredPlugins[e]},i.RegisterPlugin=function(e){if(typeof e.extensions=="string"){var t=e.extensions;i._RegisteredPlugins[t.toLowerCase()]={plugin:e,isBinary:!1}}else{var r=e.extensions;Object.keys(r).forEach(function(n){i._RegisteredPlugins[n.toLowerCase()]={plugin:e,isBinary:r[n].isBinary}})}},i.ImportMesh=function(e,t,r,n,a,s,o,l){if(r===void 0&&(r=""),n===void 0&&(n=ye.LastCreatedScene),a===void 0&&(a=null),s===void 0&&(s=null),o===void 0&&(o=null),l===void 0&&(l=null),!n)return Y.Error("No scene available to import mesh to"),null;var u=i._GetFileInfo(t,r);if(!u)return null;var f={};n._addPendingData(f);var h=function(){n._removePendingData(f)},c=function(_,g){var v=i._FormatErrorMessage(u,_,g);o?o(n,v,new or(v,sr.SceneLoaderError,g)):Y.Error(v),h()},d=s?function(_){try{s(_)}catch(g){c("Error in onProgress callback: "+g,g)}}:void 0,p=function(_,g,v,y,b,E,A){if(n.importedMeshesFiles.push(u.url),a)try{a(_,g,v,y,b,E,A)}catch(S){c("Error in onSuccess callback: "+S,S)}n._removePendingData(f)};return i._LoadData(u,n,function(_,g,v){if(_.rewriteRootURL&&(u.rootUrl=_.rewriteRootURL(u.rootUrl,v)),_.importMesh){var y=_,b=new Array,E=new Array,A=new Array;if(!y.importMesh(e,n,g,u.rootUrl,b,E,A,c))return;n.loadingPluginName=_.name,p(b,E,A,[],[],[],[])}else{var S=_;S.importMeshAsync(e,n,g,u.rootUrl,d,u.name).then(function(T){n.loadingPluginName=_.name,p(T.meshes,T.particleSystems,T.skeletons,T.animationGroups,T.transformNodes,T.geometries,T.lights)}).catch(function(T){c(T.message,T)})}},d,c,h,l)},i.ImportMeshAsync=function(e,t,r,n,a,s){return r===void 0&&(r=""),n===void 0&&(n=ye.LastCreatedScene),a===void 0&&(a=null),s===void 0&&(s=null),new Promise(function(o,l){i.ImportMesh(e,t,r,n,function(u,f,h,c,d,p,_){o({meshes:u,particleSystems:f,skeletons:h,animationGroups:c,transformNodes:d,geometries:p,lights:_})},a,function(u,f,h){l(h||new Error(f))},s)})},i.Load=function(e,t,r,n,a,s,o){return t===void 0&&(t=""),r===void 0&&(r=ye.LastCreatedEngine),n===void 0&&(n=null),a===void 0&&(a=null),s===void 0&&(s=null),o===void 0&&(o=null),r?i.Append(e,t,new Re(r),n,a,s,o):(te.Error("No engine available"),null)},i.LoadAsync=function(e,t,r,n,a){return t===void 0&&(t=""),r===void 0&&(r=ye.LastCreatedEngine),n===void 0&&(n=null),a===void 0&&(a=null),new Promise(function(s,o){i.Load(e,t,r,function(l){s(l)},n,function(l,u,f){o(f||new Error(u))},a)})},i.Append=function(e,t,r,n,a,s,o){var l=this;if(t===void 0&&(t=""),r===void 0&&(r=ye.LastCreatedScene),n===void 0&&(n=null),a===void 0&&(a=null),s===void 0&&(s=null),o===void 0&&(o=null),!r)return Y.Error("No scene available to append to"),null;var u=i._GetFileInfo(e,t);if(!u)return null;i.ShowLoadingScreen&&!this._ShowingLoadingScreen&&(this._ShowingLoadingScreen=!0,r.getEngine().displayLoadingUI(),r.executeWhenReady(function(){r.getEngine().hideLoadingUI(),l._ShowingLoadingScreen=!1}));var f={};r._addPendingData(f);var h=function(){r._removePendingData(f)},c=function(_,g){var v=i._FormatErrorMessage(u,_,g);s?s(r,v,new or(v,sr.SceneLoaderError,g)):Y.Error(v),h()},d=a?function(_){try{a(_)}catch(g){c("Error in onProgress callback",g)}}:void 0,p=function(){if(n)try{n(r)}catch(_){c("Error in onSuccess callback",_)}r._removePendingData(f)};return i._LoadData(u,r,function(_,g){if(_.load){var v=_;if(!v.load(r,g,u.rootUrl,c))return;r.loadingPluginName=_.name,p()}else{var y=_;y.loadAsync(r,g,u.rootUrl,d,u.name).then(function(){r.loadingPluginName=_.name,p()}).catch(function(b){c(b.message,b)})}},d,c,h,o)},i.AppendAsync=function(e,t,r,n,a){return t===void 0&&(t=""),r===void 0&&(r=ye.LastCreatedScene),n===void 0&&(n=null),a===void 0&&(a=null),new Promise(function(s,o){i.Append(e,t,r,function(l){s(l)},n,function(l,u,f){o(f||new Error(u))},a)})},i.LoadAssetContainer=function(e,t,r,n,a,s,o){if(t===void 0&&(t=""),r===void 0&&(r=ye.LastCreatedScene),n===void 0&&(n=null),a===void 0&&(a=null),s===void 0&&(s=null),o===void 0&&(o=null),!r)return Y.Error("No scene available to load asset container to"),null;var l=i._GetFileInfo(e,t);if(!l)return null;var u={};r._addPendingData(u);var f=function(){r._removePendingData(u)},h=function(p,_){var g=i._FormatErrorMessage(l,p,_);s?s(r,g,new or(g,sr.SceneLoaderError,_)):Y.Error(g),f()},c=a?function(p){try{a(p)}catch(_){h("Error in onProgress callback",_)}}:void 0,d=function(p){if(n)try{n(p)}catch(_){h("Error in onSuccess callback",_)}r._removePendingData(u)};return i._LoadData(l,r,function(p,_){if(p.loadAssetContainer){var g=p,v=g.loadAssetContainer(r,_,l.rootUrl,h);if(!v)return;r.loadingPluginName=p.name,d(v)}else if(p.loadAssetContainerAsync){var y=p;y.loadAssetContainerAsync(r,_,l.rootUrl,c,l.name).then(function(b){r.loadingPluginName=p.name,d(b)}).catch(function(b){h(b.message,b)})}else h("LoadAssetContainer is not supported by this plugin. Plugin did not provide a loadAssetContainer or loadAssetContainerAsync method.")},c,h,f,o)},i.LoadAssetContainerAsync=function(e,t,r,n,a){return t===void 0&&(t=""),r===void 0&&(r=ye.LastCreatedScene),n===void 0&&(n=null),a===void 0&&(a=null),new Promise(function(s,o){i.LoadAssetContainer(e,t,r,function(l){s(l)},n,function(l,u,f){o(f||new Error(u))},a)})},i.ImportAnimations=function(e,t,r,n,a,s,o,l,u,f){if(t===void 0&&(t=""),r===void 0&&(r=ye.LastCreatedScene),n===void 0&&(n=!0),a===void 0&&(a=jt.Clean),s===void 0&&(s=null),o===void 0&&(o=null),l===void 0&&(l=null),u===void 0&&(u=null),f===void 0&&(f=null),!r){Y.Error("No scene available to load animations to");return}if(n){for(var h=0,c=r.animatables;h<c.length;h++){var d=c[h];d.reset()}r.stopAllAnimations(),r.animationGroups.slice().forEach(function(v){v.dispose()});var p=r.getNodes();p.forEach(function(v){v.animations&&(v.animations=[])})}else switch(a){case jt.Clean:r.animationGroups.slice().forEach(function(v){v.dispose()});break;case jt.Stop:r.animationGroups.forEach(function(v){v.stop()});break;case jt.Sync:r.animationGroups.forEach(function(v){v.reset(),v.restart()});break;case jt.NoSync:break;default:Y.Error("Unknown animation group loading mode value '"+a+"'");return}var _=r.animatables.length,g=function(v){v.mergeAnimationsTo(r,r.animatables.slice(_),s),v.dispose(),r.onAnimationFileImportedObservable.notifyObservers(r),o&&o(r)};this.LoadAssetContainer(e,t,r,g,l,u,f)},i.ImportAnimationsAsync=function(e,t,r,n,a,s,o,l,u,f){return t===void 0&&(t=""),r===void 0&&(r=ye.LastCreatedScene),n===void 0&&(n=!0),a===void 0&&(a=jt.Clean),s===void 0&&(s=null),l===void 0&&(l=null),f===void 0&&(f=null),new Promise(function(h,c){i.ImportAnimations(e,t,r,n,a,s,function(d){h(d)},l,function(d,p,_){c(_||new Error(p))},f)})},i.NO_LOGGING=0,i.MINIMAL_LOGGING=1,i.SUMMARY_LOGGING=2,i.DETAILED_LOGGING=3,i.OnPluginActivatedObservable=new X,i._RegisteredPlugins={},i._ShowingLoadingScreen=!1,i}();ge.prototype._createDepthStencilCubeTexture=function(i,e,t){var r=new at(this,Ie.DepthStencil);if(r.isCube=!0,this.webGLVersion===1)return Y.Error("Depth cube texture is not supported by WebGL 1."),r;var n=Ue({bilinearFiltering:!1,comparisonFunction:0,generateStencil:!1},e),a=this._gl;this._bindTextureDirectly(a.TEXTURE_CUBE_MAP,r,!0),this._setupDepthStencilTexture(r,i,n.generateStencil,n.bilinearFiltering,n.comparisonFunction),t._depthStencilTexture=r,t._depthStencilTextureWithStencil=n.generateStencil;for(var s=0;s<6;s++)n.generateStencil?a.texImage2D(a.TEXTURE_CUBE_MAP_POSITIVE_X+s,0,a.DEPTH24_STENCIL8,i,i,0,a.DEPTH_STENCIL,a.UNSIGNED_INT_24_8,null):a.texImage2D(a.TEXTURE_CUBE_MAP_POSITIVE_X+s,0,a.DEPTH_COMPONENT24,i,i,0,a.DEPTH_COMPONENT,a.UNSIGNED_INT,null);return this._bindTextureDirectly(a.TEXTURE_CUBE_MAP,null),this._internalTexturesCache.push(r),r};ge.prototype._partialLoadFile=function(i,e,t,r,n){n===void 0&&(n=null);var a=function(o){t[e]=o,t._internalCount++,t._internalCount===6&&r(t)},s=function(o,l){n&&o&&n(o.status+" "+o.statusText,l)};this._loadFile(i,a,void 0,void 0,!0,s)};ge.prototype._cascadeLoadFiles=function(i,e,t,r){r===void 0&&(r=null);var n=[];n._internalCount=0;for(var a=0;a<6;a++)this._partialLoadFile(t[a],a,n,e,r)};ge.prototype._cascadeLoadImgs=function(i,e,t,r,n,a){n===void 0&&(n=null);var s=[];s._internalCount=0;for(var o=0;o<6;o++)this._partialLoadImg(r[o],o,s,i,e,t,n,a)};ge.prototype._partialLoadImg=function(i,e,t,r,n,a,s,o){s===void 0&&(s=null);var l=Zi(),u=function(h){t[e]=h,t._internalCount++,r&&r._removePendingData(l),t._internalCount===6&&a&&a(n,t)},f=function(h,c){r&&r._removePendingData(l),s&&s(h,c)};Vr(i,u,f,r?r.offlineProvider:null,o),r&&r._addPendingData(l)};ge.prototype._setCubeMapTextureParams=function(i,e,t){var r=this._gl;r.texParameteri(r.TEXTURE_CUBE_MAP,r.TEXTURE_MAG_FILTER,r.LINEAR),r.texParameteri(r.TEXTURE_CUBE_MAP,r.TEXTURE_MIN_FILTER,e?r.LINEAR_MIPMAP_LINEAR:r.LINEAR),r.texParameteri(r.TEXTURE_CUBE_MAP,r.TEXTURE_WRAP_S,r.CLAMP_TO_EDGE),r.texParameteri(r.TEXTURE_CUBE_MAP,r.TEXTURE_WRAP_T,r.CLAMP_TO_EDGE),i.samplingMode=e?3:2,e&&this.getCaps().textureMaxLevel&&t!==void 0&&t>0&&(r.texParameteri(r.TEXTURE_CUBE_MAP,r.TEXTURE_MAX_LEVEL,t),i._maxLodLevel=t),this._bindTextureDirectly(r.TEXTURE_CUBE_MAP,null)};ge.prototype.createCubeTextureBase=function(i,e,t,r,n,a,s,o,l,u,f,h,c,d,p){var _=this;n===void 0&&(n=null),a===void 0&&(a=null),o===void 0&&(o=null),l===void 0&&(l=!1),u===void 0&&(u=0),f===void 0&&(f=0),h===void 0&&(h=null),c===void 0&&(c=null),d===void 0&&(d=null),p===void 0&&(p=!1);var g=h||new at(this,Ie.Cube);g.isCube=!0,g.url=i,g.generateMipMaps=!r,g._lodGenerationScale=u,g._lodGenerationOffset=f,g._useSRGBBuffer=!!p&&this._caps.supportSRGBBuffers&&(this.webGLVersion>1||this.isWebGPU||!!r),this._doNotHandleContextLost||(g._extension=o,g._files=t);var v=i;this._transformTextureUrl&&!h&&(i=this._transformTextureUrl(i));for(var y=i.lastIndexOf("."),b=o||(y>-1?i.substring(y).toLowerCase():""),E=null,A=0,S=ge._TextureLoaders;A<S.length;A++){var T=S[A];if(T.canLoad(b)){E=T;break}}var M=function(x,P){i===v?a&&x&&a(x.status+" "+x.statusText,P):(Y.Warn("Failed to load ".concat(i,", falling back to the ").concat(v)),_.createCubeTextureBase(v,e,t,!!r,n,a,s,o,l,u,f,g,c,d,p))};if(E){var D=function(x){c&&c(g,x),E.loadCubeData(x,g,l,n,a)};t&&t.length===6?E.supportCascades?this._cascadeLoadFiles(e,function(x){return D(x.map(function(P){return new Uint8Array(P)}))},t,a):a?a("Textures type does not support cascades."):Y.Warn("Texture loader does not support cascades."):this._loadFile(i,function(x){return D(new Uint8Array(x))},void 0,void 0,!0,M)}else{if(!t)throw new Error("Cannot load cubemap because files were not defined");this._cascadeLoadImgs(e,g,function(x,P){d&&d(x,P)},t,a)}return this._internalTexturesCache.push(g),g};ge.prototype.createCubeTexture=function(i,e,t,r,n,a,s,o,l,u,f,h,c,d){var p=this;n===void 0&&(n=null),a===void 0&&(a=null),o===void 0&&(o=null),l===void 0&&(l=!1),u===void 0&&(u=0),f===void 0&&(f=0),h===void 0&&(h=null),d===void 0&&(d=!1);var _=this._gl;return this.createCubeTextureBase(i,e,t,!!r,n,a,s,o,l,u,f,h,function(g){return p._bindTextureDirectly(_.TEXTURE_CUBE_MAP,g,!0)},function(g,v){var y=p.needPOTTextures?ge.GetExponentOfTwo(v[0].width,p._caps.maxCubemapTextureSize):v[0].width,b=y,E=[_.TEXTURE_CUBE_MAP_POSITIVE_X,_.TEXTURE_CUBE_MAP_POSITIVE_Y,_.TEXTURE_CUBE_MAP_POSITIVE_Z,_.TEXTURE_CUBE_MAP_NEGATIVE_X,_.TEXTURE_CUBE_MAP_NEGATIVE_Y,_.TEXTURE_CUBE_MAP_NEGATIVE_Z];p._bindTextureDirectly(_.TEXTURE_CUBE_MAP,g,!0),p._unpackFlipY(!1);var A=s?p._getInternalFormat(s,g._useSRGBBuffer):g._useSRGBBuffer?_.SRGB8_ALPHA8:_.RGBA,S=s?p._getInternalFormat(s):_.RGBA;g._useSRGBBuffer&&p.webGLVersion===1&&(S=A);for(var T=0;T<E.length;T++)if(v[T].width!==y||v[T].height!==b){if(p._prepareWorkingCanvas(),!p._workingCanvas||!p._workingContext){Y.Warn("Cannot create canvas to resize texture.");return}p._workingCanvas.width=y,p._workingCanvas.height=b,p._workingContext.drawImage(v[T],0,0,v[T].width,v[T].height,0,0,y,b),_.texImage2D(E[T],0,A,S,_.UNSIGNED_BYTE,p._workingCanvas)}else _.texImage2D(E[T],0,A,S,_.UNSIGNED_BYTE,v[T]);r||_.generateMipmap(_.TEXTURE_CUBE_MAP),p._setCubeMapTextureParams(g,!r),g.width=y,g.height=b,g.isReady=!0,s&&(g.format=s),g.onLoadedObservable.notifyObservers(g),g.onLoadedObservable.clear(),n&&n()},!!d)};var Lr=function(i){$(e,i);function e(t,r,n,a,s,o,l,u,f,h,c,d,p,_,g){n===void 0&&(n=null),a===void 0&&(a=!1),s===void 0&&(s=null),o===void 0&&(o=null),l===void 0&&(l=null),u===void 0&&(u=5),f===void 0&&(f=!1),h===void 0&&(h=null),c===void 0&&(c=!1),d===void 0&&(d=.8),p===void 0&&(p=0);var v=this,y;return v=i.call(this,r)||this,v._lodScale=.8,v._lodOffset=0,v.onLoadObservable=new X,v.boundingBoxPosition=m.Zero(),v._rotationY=0,v._files=null,v._forcedExtension=null,v._extensions=null,v.name=t,v.url=t,v._noMipmap=a,v.hasAlpha=!1,v._format=u,v.isCube=!0,v._textureMatrix=G.Identity(),v._createPolynomials=c,v.coordinatesMode=re.CUBIC_MODE,v._extensions=n,v._files=s,v._forcedExtension=h,v._loaderOptions=_,v._useSRGBBuffer=g,v._lodScale=d,v._lodOffset=p,!t&&!s||v.updateURL(t,h,o,f,l,n,(y=v.getScene())===null||y===void 0?void 0:y.useDelayedTextureLoading,s),v}return Object.defineProperty(e.prototype,"boundingBoxSize",{get:function(){return this._boundingBoxSize},set:function(t){if(!(this._boundingBoxSize&&this._boundingBoxSize.equals(t))){this._boundingBoxSize=t;var r=this.getScene();r&&r.markAllMaterialsAsDirty(1)}},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"rotationY",{get:function(){return this._rotationY},set:function(t){this._rotationY=t,this.setReflectionTextureMatrix(G.RotationY(this._rotationY))},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"noMipmap",{get:function(){return this._noMipmap},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"forcedExtension",{get:function(){return this._forcedExtension},enumerable:!1,configurable:!0}),e.CreateFromImages=function(t,r,n){var a="";return t.forEach(function(s){return a+=s}),new e(a,r,null,n,t)},e.CreateFromPrefilteredData=function(t,r,n,a){n===void 0&&(n=null),a===void 0&&(a=!0);var s=r.useDelayedTextureLoading;r.useDelayedTextureLoading=!1;var o=new e(t,r,null,!1,null,null,null,void 0,!0,n,a);return r.useDelayedTextureLoading=s,o},e.prototype.getClassName=function(){return"CubeTexture"},e.prototype.updateURL=function(t,r,n,a,s,o,l,u){n===void 0&&(n=null),a===void 0&&(a=!1),s===void 0&&(s=null),o===void 0&&(o=null),l===void 0&&(l=!1),u===void 0&&(u=null),(!this.name||vt(this.name,"data:"))&&(this.name=t),this.url=t;var f=t.lastIndexOf("."),h=r||(f>-1?t.substring(f).toLowerCase():""),c=h.indexOf(".dds")===0,d=h.indexOf(".env")===0;if(d?(this.gammaSpace=!1,this._prefiltered=!1,this.anisotropicFilteringLevel=1):(this._prefiltered=a,a&&(this.gammaSpace=!1,this.anisotropicFilteringLevel=1)),u)this._files=u;else if(!d&&!c&&!o&&(o=["_px.jpg","_py.jpg","_pz.jpg","_nx.jpg","_ny.jpg","_nz.jpg"]),this._files=this._files||[],this._files.length=0,o){for(var p=0;p<o.length;p++)this._files.push(t+o[p]);this._extensions=o}l?(this.delayLoadState=4,this._delayedOnLoad=n,this._delayedOnError=s):this._loadTexture(n,s)},e.prototype.delayLoad=function(t){this.delayLoadState===4&&(t&&(this._forcedExtension=t),this.delayLoadState=1,this._loadTexture(this._delayedOnLoad,this._delayedOnError))},e.prototype.getReflectionTextureMatrix=function(){return this._textureMatrix},e.prototype.setReflectionTextureMatrix=function(t){var r=this,n;t.updateFlag!==this._textureMatrix.updateFlag&&(t.isIdentity()!==this._textureMatrix.isIdentity()&&((n=this.getScene())===null||n===void 0||n.markAllMaterialsAsDirty(1,function(a){return a.getActiveTextures().indexOf(r)!==-1})),this._textureMatrix=t)},e.prototype._loadTexture=function(t,r){var n=this,a;t===void 0&&(t=null),r===void 0&&(r=null);var s=this.getScene(),o=this._texture;this._texture=this._getFromCache(this.url,this._noMipmap,void 0,void 0,this._useSRGBBuffer);var l=function(){var f;n.onLoadObservable.notifyObservers(n),o&&(o.dispose(),(f=n.getScene())===null||f===void 0||f.markAllMaterialsAsDirty(1)),t&&t()},u=function(f,h){n._loadingError=!0,n._errorObject={message:f,exception:h},r&&r(f,h),re.OnTextureLoadErrorObservable.notifyObservers(n)};this._texture?this._texture.isReady?te.SetImmediate(function(){return l()}):this._texture.onLoadedObservable.add(function(){return l()}):(this._prefiltered?this._texture=this._getEngine().createPrefilteredCubeTexture(this.url,s,this._lodScale,this._lodOffset,t,u,this._format,this._forcedExtension,this._createPolynomials):this._texture=this._getEngine().createCubeTexture(this.url,s,this._files,this._noMipmap,t,u,this._format,this._forcedExtension,!1,this._lodScale,this._lodOffset,null,this._loaderOptions,!!this._useSRGBBuffer),(a=this._texture)===null||a===void 0||a.onLoadedObservable.add(function(){return n.onLoadObservable.notifyObservers(n)}))},e.Parse=function(t,r,n){var a=pe.Parse(function(){var u=!1;return t.prefiltered&&(u=t.prefiltered),new e(n+t.name,r,t.extensions,!1,t.files||null,null,null,void 0,u,t.forcedExtension)},t,r);if(t.boundingBoxPosition&&(a.boundingBoxPosition=m.FromArray(t.boundingBoxPosition)),t.boundingBoxSize&&(a.boundingBoxSize=m.FromArray(t.boundingBoxSize)),t.animations)for(var s=0;s<t.animations.length;s++){var o=t.animations[s],l=lt("BABYLON.Animation");l&&a.animations.push(l.Parse(o))}return a},e.prototype.clone=function(){var t=this,r=0,n=pe.Clone(function(){var a=new e(t.url,t.getScene()||t._getEngine(),t._extensions,t._noMipmap,t._files);return r=a.uniqueId,a},this);return n.uniqueId=r,n},C([I()],e.prototype,"url",void 0),C([I("rotationY")],e.prototype,"rotationY",null),C([I("files")],e.prototype,"_files",void 0),C([I("forcedExtension")],e.prototype,"_forcedExtension",void 0),C([I("extensions")],e.prototype,"_extensions",void 0),C([yo("textureMatrix")],e.prototype,"_textureMatrix",void 0),e}(bt);re._CubeTextureParser=Lr.Parse;We("BABYLON.CubeTexture",Lr);var Gs=function(){function i(){}return i.ConvertPanoramaToCubemap=function(e,t,r,n){if(!e)throw"ConvertPanoramaToCubemap: input cannot be null";if(e.length!=t*r*3)throw"ConvertPanoramaToCubemap: input size is wrong";var a=this.CreateCubemapTexture(n,this.FACE_FRONT,e,t,r),s=this.CreateCubemapTexture(n,this.FACE_BACK,e,t,r),o=this.CreateCubemapTexture(n,this.FACE_LEFT,e,t,r),l=this.CreateCubemapTexture(n,this.FACE_RIGHT,e,t,r),u=this.CreateCubemapTexture(n,this.FACE_UP,e,t,r),f=this.CreateCubemapTexture(n,this.FACE_DOWN,e,t,r);return{front:a,back:s,left:o,right:l,up:u,down:f,size:n,type:1,format:4,gammaSpace:!1}},i.CreateCubemapTexture=function(e,t,r,n,a){for(var s=new ArrayBuffer(e*e*4*3),o=new Float32Array(s),l=t[1].subtract(t[0]).scale(1/e),u=t[3].subtract(t[2]).scale(1/e),f=1/e,h=0,c=0;c<e;c++){for(var d=t[0],p=t[2],_=0;_<e;_++){var g=p.subtract(d).scale(h).add(d);g.normalize();var v=this.CalcProjectionSpherical(g,r,n,a);o[c*e*3+_*3+0]=v.r,o[c*e*3+_*3+1]=v.g,o[c*e*3+_*3+2]=v.b,d=d.add(l),p=p.add(u)}h+=f}return o},i.CalcProjectionSpherical=function(e,t,r,n){for(var a=Math.atan2(e.z,e.x),s=Math.acos(e.y);a<-Math.PI;)a+=2*Math.PI;for(;a>Math.PI;)a-=2*Math.PI;var o=a/Math.PI,l=s/Math.PI;o=o*.5+.5;var u=Math.round(o*r);u<0?u=0:u>=r&&(u=r-1);var f=Math.round(l*n);f<0?f=0:f>=n&&(f=n-1);var h=n-f-1,c=t[h*r*3+u*3+0],d=t[h*r*3+u*3+1],p=t[h*r*3+u*3+2];return{r:c,g:d,b:p}},i.FACE_LEFT=[new m(-1,-1,-1),new m(1,-1,-1),new m(-1,1,-1),new m(1,1,-1)],i.FACE_RIGHT=[new m(1,-1,1),new m(-1,-1,1),new m(1,1,1),new m(-1,1,1)],i.FACE_FRONT=[new m(1,-1,-1),new m(1,-1,1),new m(1,1,-1),new m(1,1,1)],i.FACE_BACK=[new m(-1,-1,1),new m(-1,-1,-1),new m(-1,1,1),new m(-1,1,-1)],i.FACE_DOWN=[new m(1,1,-1),new m(1,1,1),new m(-1,1,-1),new m(-1,1,1)],i.FACE_UP=[new m(-1,-1,-1),new m(-1,-1,1),new m(1,-1,-1),new m(1,-1,1)],i}(),Wi=function(){function i(){}return i._Ldexp=function(e,t){return t>1023?e*Math.pow(2,1023)*Math.pow(2,t-1023):t<-1074?e*Math.pow(2,-1074)*Math.pow(2,t+1074):e*Math.pow(2,t)},i._Rgbe2float=function(e,t,r,n,a,s){a>0?(a=this._Ldexp(1,a-(128+8)),e[s+0]=t*a,e[s+1]=r*a,e[s+2]=n*a):(e[s+0]=0,e[s+1]=0,e[s+2]=0)},i._ReadStringLine=function(e,t){for(var r="",n="",a=t;a<e.length-t&&(n=String.fromCharCode(e[a]),n!=`
`);a++)r+=n;return r},i.RGBE_ReadHeader=function(e){var t=0,r=0,n=this._ReadStringLine(e,0);if(n[0]!="#"||n[1]!="?")throw"Bad HDR Format.";var a=!1,s=!1,o=0;do o+=n.length+1,n=this._ReadStringLine(e,o),n=="FORMAT=32-bit_rle_rgbe"?s=!0:n.length==0&&(a=!0);while(!a);if(!s)throw"HDR Bad header format, unsupported FORMAT";o+=n.length+1,n=this._ReadStringLine(e,o);var l=/^-Y (.*) \+X (.*)$/g,u=l.exec(n);if(!u||u.length<3)throw"HDR Bad header format, no size";if(r=parseInt(u[2]),t=parseInt(u[1]),r<8||r>32767)throw"HDR Bad header format, unsupported size";return o+=n.length+1,{height:t,width:r,dataPosition:o}},i.GetCubeMapTextureData=function(e,t){var r=new Uint8Array(e),n=this.RGBE_ReadHeader(r),a=this.RGBE_ReadPixels(r,n),s=Gs.ConvertPanoramaToCubemap(a,n.width,n.height,t);return s},i.RGBE_ReadPixels=function(e,t){return this._RGBEReadPixelsRLE(e,t)},i._RGBEReadPixelsRLE=function(e,t){for(var r=t.height,n=t.width,a,s,o,l,u,f=t.dataPosition,h=0,c=0,d=0,p=new ArrayBuffer(n*4),_=new Uint8Array(p),g=new ArrayBuffer(t.width*t.height*4*3),v=new Float32Array(g);r>0;){if(a=e[f++],s=e[f++],o=e[f++],l=e[f++],a!=2||s!=2||o&128||t.width<8||t.width>32767)return this._RGBEReadPixelsNOTRLE(e,t);if((o<<8|l)!=n)throw"HDR Bad header format, wrong scan line width";for(h=0,d=0;d<4;d++)for(c=(d+1)*n;h<c;)if(a=e[f++],s=e[f++],a>128){if(u=a-128,u==0||u>c-h)throw"HDR Bad Format, bad scanline data (run)";for(;u-- >0;)_[h++]=s}else{if(u=a,u==0||u>c-h)throw"HDR Bad Format, bad scanline data (non-run)";if(_[h++]=s,--u>0)for(var y=0;y<u;y++)_[h++]=e[f++]}for(d=0;d<n;d++)a=_[d],s=_[d+n],o=_[d+2*n],l=_[d+3*n],this._Rgbe2float(v,a,s,o,l,(t.height-r)*n*3+d*3);r--}return v},i._RGBEReadPixelsNOTRLE=function(e,t){for(var r=t.height,n=t.width,a,s,o,l,u,f=t.dataPosition,h=new ArrayBuffer(t.width*t.height*4*3),c=new Float32Array(h);r>0;){for(u=0;u<t.width;u++)a=e[f++],s=e[f++],o=e[f++],l=e[f++],this._Rgbe2float(c,a,s,o,l,(t.height-r)*n*3+u*3);r--}return c},i}(),Rt=[Math.sqrt(1/(4*Math.PI)),-Math.sqrt(3/(4*Math.PI)),Math.sqrt(3/(4*Math.PI)),-Math.sqrt(3/(4*Math.PI)),Math.sqrt(15/(4*Math.PI)),-Math.sqrt(15/(4*Math.PI)),Math.sqrt(5/(16*Math.PI)),-Math.sqrt(15/(4*Math.PI)),Math.sqrt(15/(16*Math.PI))],mh=[function(){return 1},function(i){return i.y},function(i){return i.z},function(i){return i.x},function(i){return i.x*i.y},function(i){return i.y*i.z},function(i){return 3*i.z*i.z-1},function(i){return i.x*i.z},function(i){return i.x*i.x-i.y*i.y}],Ot=function(i,e){return Rt[i]*mh[i](e)},It=[Math.PI,2*Math.PI/3,2*Math.PI/3,2*Math.PI/3,Math.PI/4,Math.PI/4,Math.PI/4,Math.PI/4,Math.PI/4],zs=function(){function i(){this.preScaled=!1,this.l00=m.Zero(),this.l1_1=m.Zero(),this.l10=m.Zero(),this.l11=m.Zero(),this.l2_2=m.Zero(),this.l2_1=m.Zero(),this.l20=m.Zero(),this.l21=m.Zero(),this.l22=m.Zero()}return i.prototype.addLight=function(e,t,r){U.Vector3[0].set(t.r,t.g,t.b);var n=U.Vector3[0],a=U.Vector3[1];n.scaleToRef(r,a),a.scaleToRef(Ot(0,e),U.Vector3[2]),this.l00.addInPlace(U.Vector3[2]),a.scaleToRef(Ot(1,e),U.Vector3[2]),this.l1_1.addInPlace(U.Vector3[2]),a.scaleToRef(Ot(2,e),U.Vector3[2]),this.l10.addInPlace(U.Vector3[2]),a.scaleToRef(Ot(3,e),U.Vector3[2]),this.l11.addInPlace(U.Vector3[2]),a.scaleToRef(Ot(4,e),U.Vector3[2]),this.l2_2.addInPlace(U.Vector3[2]),a.scaleToRef(Ot(5,e),U.Vector3[2]),this.l2_1.addInPlace(U.Vector3[2]),a.scaleToRef(Ot(6,e),U.Vector3[2]),this.l20.addInPlace(U.Vector3[2]),a.scaleToRef(Ot(7,e),U.Vector3[2]),this.l21.addInPlace(U.Vector3[2]),a.scaleToRef(Ot(8,e),U.Vector3[2]),this.l22.addInPlace(U.Vector3[2])},i.prototype.scaleInPlace=function(e){this.l00.scaleInPlace(e),this.l1_1.scaleInPlace(e),this.l10.scaleInPlace(e),this.l11.scaleInPlace(e),this.l2_2.scaleInPlace(e),this.l2_1.scaleInPlace(e),this.l20.scaleInPlace(e),this.l21.scaleInPlace(e),this.l22.scaleInPlace(e)},i.prototype.convertIncidentRadianceToIrradiance=function(){this.l00.scaleInPlace(It[0]),this.l1_1.scaleInPlace(It[1]),this.l10.scaleInPlace(It[2]),this.l11.scaleInPlace(It[3]),this.l2_2.scaleInPlace(It[4]),this.l2_1.scaleInPlace(It[5]),this.l20.scaleInPlace(It[6]),this.l21.scaleInPlace(It[7]),this.l22.scaleInPlace(It[8])},i.prototype.convertIrradianceToLambertianRadiance=function(){this.scaleInPlace(1/Math.PI)},i.prototype.preScaleForRendering=function(){this.preScaled=!0,this.l00.scaleInPlace(Rt[0]),this.l1_1.scaleInPlace(Rt[1]),this.l10.scaleInPlace(Rt[2]),this.l11.scaleInPlace(Rt[3]),this.l2_2.scaleInPlace(Rt[4]),this.l2_1.scaleInPlace(Rt[5]),this.l20.scaleInPlace(Rt[6]),this.l21.scaleInPlace(Rt[7]),this.l22.scaleInPlace(Rt[8])},i.prototype.updateFromArray=function(e){return m.FromArrayToRef(e[0],0,this.l00),m.FromArrayToRef(e[1],0,this.l1_1),m.FromArrayToRef(e[2],0,this.l10),m.FromArrayToRef(e[3],0,this.l11),m.FromArrayToRef(e[4],0,this.l2_2),m.FromArrayToRef(e[5],0,this.l2_1),m.FromArrayToRef(e[6],0,this.l20),m.FromArrayToRef(e[7],0,this.l21),m.FromArrayToRef(e[8],0,this.l22),this},i.prototype.updateFromFloatsArray=function(e){return m.FromFloatsToRef(e[0],e[1],e[2],this.l00),m.FromFloatsToRef(e[3],e[4],e[5],this.l1_1),m.FromFloatsToRef(e[6],e[7],e[8],this.l10),m.FromFloatsToRef(e[9],e[10],e[11],this.l11),m.FromFloatsToRef(e[12],e[13],e[14],this.l2_2),m.FromFloatsToRef(e[15],e[16],e[17],this.l2_1),m.FromFloatsToRef(e[18],e[19],e[20],this.l20),m.FromFloatsToRef(e[21],e[22],e[23],this.l21),m.FromFloatsToRef(e[24],e[25],e[26],this.l22),this},i.FromArray=function(e){var t=new i;return t.updateFromArray(e)},i.FromPolynomial=function(e){var t=new i;return t.l00=e.xx.scale(.376127).add(e.yy.scale(.376127)).add(e.zz.scale(.376126)),t.l1_1=e.y.scale(.977204),t.l10=e.z.scale(.977204),t.l11=e.x.scale(.977204),t.l2_2=e.xy.scale(1.16538),t.l2_1=e.yz.scale(1.16538),t.l20=e.zz.scale(1.34567).subtract(e.xx.scale(.672834)).subtract(e.yy.scale(.672834)),t.l21=e.zx.scale(1.16538),t.l22=e.xx.scale(1.16538).subtract(e.yy.scale(1.16538)),t.l1_1.scaleInPlace(-1),t.l11.scaleInPlace(-1),t.l2_1.scaleInPlace(-1),t.l21.scaleInPlace(-1),t.scaleInPlace(Math.PI),t},i}(),ui=function(){function i(){this.x=m.Zero(),this.y=m.Zero(),this.z=m.Zero(),this.xx=m.Zero(),this.yy=m.Zero(),this.zz=m.Zero(),this.xy=m.Zero(),this.yz=m.Zero(),this.zx=m.Zero()}return Object.defineProperty(i.prototype,"preScaledHarmonics",{get:function(){return this._harmonics||(this._harmonics=zs.FromPolynomial(this)),this._harmonics.preScaled||this._harmonics.preScaleForRendering(),this._harmonics},enumerable:!1,configurable:!0}),i.prototype.addAmbient=function(e){U.Vector3[0].copyFromFloats(e.r,e.g,e.b);var t=U.Vector3[0];this.xx.addInPlace(t),this.yy.addInPlace(t),this.zz.addInPlace(t)},i.prototype.scaleInPlace=function(e){this.x.scaleInPlace(e),this.y.scaleInPlace(e),this.z.scaleInPlace(e),this.xx.scaleInPlace(e),this.yy.scaleInPlace(e),this.zz.scaleInPlace(e),this.yz.scaleInPlace(e),this.zx.scaleInPlace(e),this.xy.scaleInPlace(e)},i.prototype.updateFromHarmonics=function(e){return this._harmonics=e,this.x.copyFrom(e.l11),this.x.scaleInPlace(1.02333).scaleInPlace(-1),this.y.copyFrom(e.l1_1),this.y.scaleInPlace(1.02333).scaleInPlace(-1),this.z.copyFrom(e.l10),this.z.scaleInPlace(1.02333),this.xx.copyFrom(e.l00),U.Vector3[0].copyFrom(e.l20).scaleInPlace(.247708),U.Vector3[1].copyFrom(e.l22).scaleInPlace(.429043),this.xx.scaleInPlace(.886277).subtractInPlace(U.Vector3[0]).addInPlace(U.Vector3[1]),this.yy.copyFrom(e.l00),this.yy.scaleInPlace(.886277).subtractInPlace(U.Vector3[0]).subtractInPlace(U.Vector3[1]),this.zz.copyFrom(e.l00),U.Vector3[0].copyFrom(e.l20).scaleInPlace(.495417),this.zz.scaleInPlace(.886277).addInPlace(U.Vector3[0]),this.yz.copyFrom(e.l2_1),this.yz.scaleInPlace(.858086).scaleInPlace(-1),this.zx.copyFrom(e.l21),this.zx.scaleInPlace(.858086).scaleInPlace(-1),this.xy.copyFrom(e.l2_2),this.xy.scaleInPlace(.858086),this.scaleInPlace(1/Math.PI),this},i.FromHarmonics=function(e){var t=new i;return t.updateFromHarmonics(e)},i.FromArray=function(e){var t=new i;return m.FromArrayToRef(e[0],0,t.x),m.FromArrayToRef(e[1],0,t.y),m.FromArrayToRef(e[2],0,t.z),m.FromArrayToRef(e[3],0,t.xx),m.FromArrayToRef(e[4],0,t.yy),m.FromArrayToRef(e[5],0,t.zz),m.FromArrayToRef(e[6],0,t.yz),m.FromArrayToRef(e[7],0,t.zx),m.FromArrayToRef(e[8],0,t.xy),t},i}(),pr=function(){function i(e,t,r,n){this.name=e,this.worldAxisForNormal=t,this.worldAxisForFileX=r,this.worldAxisForFileY=n}return i}(),vn=function(){function i(){}return i.ConvertCubeMapTextureToSphericalPolynomial=function(e){var t=this,r;if(!e.isCube)return null;(r=e.getScene())===null||r===void 0||r.getEngine().flushFramebuffer();var n=e.getSize().width,a=e.readPixels(0,void 0,void 0,!1),s=e.readPixels(1,void 0,void 0,!1),o,l;e.isRenderTarget?(o=e.readPixels(3,void 0,void 0,!1),l=e.readPixels(2,void 0,void 0,!1)):(o=e.readPixels(2,void 0,void 0,!1),l=e.readPixels(3,void 0,void 0,!1));var u=e.readPixels(4,void 0,void 0,!1),f=e.readPixels(5,void 0,void 0,!1),h=e.gammaSpace,c=5,d=0;return(e.textureType==1||e.textureType==2)&&(d=1),new Promise(function(p){Promise.all([s,a,o,l,u,f]).then(function(_){var g=_[0],v=_[1],y=_[2],b=_[3],E=_[4],A=_[5],S={size:n,right:v,left:g,up:y,down:b,front:E,back:A,format:c,type:d,gammaSpace:h};p(t.ConvertCubeMapToSphericalPolynomial(S))})})},i._AreaElement=function(e,t){return Math.atan2(e*t,Math.sqrt(e*e+t*t+1))},i.ConvertCubeMapToSphericalPolynomial=function(e){for(var t=new zs,r=0,n=2/e.size,a=n,s=.5*n,o=s-1,l=0;l<6;l++)for(var u=this._FileFaces[l],f=e[u.name],h=o,c=e.format===5?4:3,d=0;d<e.size;d++){for(var p=o,_=0;_<e.size;_++){var g=u.worldAxisForFileX.scale(p).add(u.worldAxisForFileY.scale(h)).add(u.worldAxisForNormal);g.normalize();var v=this._AreaElement(p-s,h-s)-this._AreaElement(p-s,h+s)-this._AreaElement(p+s,h-s)+this._AreaElement(p+s,h+s),y=f[d*e.size*c+_*c+0],b=f[d*e.size*c+_*c+1],E=f[d*e.size*c+_*c+2];isNaN(y)&&(y=0),isNaN(b)&&(b=0),isNaN(E)&&(E=0),e.type===0&&(y/=255,b/=255,E/=255),e.gammaSpace&&(y=Math.pow(K.Clamp(y),Nt),b=Math.pow(K.Clamp(b),Nt),E=Math.pow(K.Clamp(E),Nt));var A=4096;y=K.Clamp(y,0,A),b=K.Clamp(b,0,A),E=K.Clamp(E,0,A);var S=new me(y,b,E);t.addLight(g,S,v),r+=v,p+=n}h+=a}var T=4*Math.PI,M=6,D=T*M/6,x=D/r;return t.scaleInPlace(x),t.convertIncidentRadianceToIrradiance(),t.convertIrradianceToLambertianRadiance(),ui.FromHarmonics(t)},i._FileFaces=[new pr("right",new m(1,0,0),new m(0,0,-1),new m(0,-1,0)),new pr("left",new m(-1,0,0),new m(0,0,1),new m(0,-1,0)),new pr("up",new m(0,1,0),new m(1,0,0),new m(0,0,1)),new pr("down",new m(0,-1,0),new m(1,0,0),new m(0,0,-1)),new pr("front",new m(0,0,1),new m(1,0,0),new m(0,-1,0)),new pr("back",new m(0,0,-1),new m(-1,0,0),new m(0,-1,0))],i}(),yh="postprocessVertexShader",bh=`attribute vec2 position;
uniform vec2 scale;
varying vec2 vUV;
const vec2 madd=vec2(0.5,0.5);
#define CUSTOM_VERTEX_DEFINITIONS
void main(void) {
#define CUSTOM_VERTEX_MAIN_BEGIN
vUV=(position*madd+madd)*scale;
gl_Position=vec4(position,0.0,1.0);
#define CUSTOM_VERTEX_MAIN_END
}`;q.ShadersStore[yh]=bh;var Th=function(){function i(e,t){var r;t===void 0&&(t=i._DefaultOptions);var n=this;this._engine=e,this._fullscreenViewport=new Va(0,0,1,1),t=Ue(Ue({},i._DefaultOptions),t),this._vertexBuffers=(r={},r[R.PositionKind]=new R(e,t.positions,R.PositionKind,!1,!1,2),r),this._indexBuffer=e.createIndexBuffer(t.indices),this._onContextRestoredObserver=e.onContextRestoredObservable.add(function(){n._indexBuffer=e.createIndexBuffer(t.indices);for(var a in n._vertexBuffers){var s=n._vertexBuffers[a];s._rebuild()}})}return i.prototype.setViewport=function(e){e===void 0&&(e=this._fullscreenViewport),this._engine.setViewport(e)},i.prototype.bindBuffers=function(e){this._engine.bindBuffers(this._vertexBuffers,this._indexBuffer,e)},i.prototype.applyEffectWrapper=function(e){this._engine.depthCullingState.depthTest=!1,this._engine.stencilState.stencilTest=!1,this._engine.enableEffect(e._drawWrapper),this.bindBuffers(e.effect),e.onApplyObservable.notifyObservers({})},i.prototype.restoreStates=function(){this._engine.depthCullingState.depthTest=!0,this._engine.stencilState.stencilTest=!0},i.prototype.draw=function(){this._engine.drawElementsType(0,0,6)},i.prototype._isRenderTargetTexture=function(e){return e.renderTarget!==void 0},i.prototype.render=function(e,t){if(t===void 0&&(t=null),!!e.effect.isReady()){this.setViewport();var r=t===null?null:this._isRenderTargetTexture(t)?t.renderTarget:t;r&&this._engine.bindFramebuffer(r),this.applyEffectWrapper(e),this.draw(),r&&this._engine.unBindFramebuffer(r),this.restoreStates()}},i.prototype.dispose=function(){var e=this._vertexBuffers[R.PositionKind];e&&(e.dispose(),delete this._vertexBuffers[R.PositionKind]),this._indexBuffer&&this._engine._releaseBuffer(this._indexBuffer),this._onContextRestoredObserver&&(this._engine.onContextRestoredObservable.remove(this._onContextRestoredObserver),this._onContextRestoredObserver=null)},i._DefaultOptions={positions:[1,1,-1,1,-1,-1,1,-1],indices:[0,1,2,0,2,3]},i}(),Eh=function(){function i(e){var t=this;this.onApplyObservable=new X;var r,n=e.uniformNames||[];e.vertexShader?r={fragmentSource:e.fragmentShader,vertexSource:e.vertexShader,spectorName:e.name||"effectWrapper"}:(n.push("scale"),r={fragmentSource:e.fragmentShader,vertex:"postprocess",spectorName:e.name||"effectWrapper"},this.onApplyObservable.add(function(){t.effect.setFloat2("scale",1,1)}));var a=e.defines?e.defines.join(`
`):"";this._drawWrapper=new Bt(e.engine),e.useShaderStore?(r.fragment=r.fragmentSource,r.vertex||(r.vertex=r.vertexSource),delete r.fragmentSource,delete r.vertexSource,this.effect=e.engine.createEffect(r,e.attributeNames||["position"],n,e.samplerNames,a,void 0,e.onCompiled,void 0,void 0,e.shaderLanguage)):(this.effect=new Kt(r,e.attributeNames||["position"],n,e.samplerNames,e.engine,a,void 0,e.onCompiled,void 0,void 0,void 0,e.shaderLanguage),this._onContextRestoredObserver=e.engine.onContextRestoredObservable.add(function(){t.effect._pipelineContext=null,t.effect._wasPreviouslyReady=!1,t.effect._prepareEffect()}))}return Object.defineProperty(i.prototype,"effect",{get:function(){return this._drawWrapper.effect},set:function(e){this._drawWrapper.effect=e},enumerable:!1,configurable:!0}),i.prototype.dispose=function(){this._onContextRestoredObserver&&(this.effect.getEngine().onContextRestoredObservable.remove(this._onContextRestoredObserver),this._onContextRestoredObserver=null),this.effect.dispose()},i}(),Ah="hdrFilteringVertexShader",Sh=`attribute vec2 position;
varying vec3 direction;
uniform vec3 up;
uniform vec3 right;
uniform vec3 front;
#define CUSTOM_VERTEX_DEFINITIONS
void main(void) {
#define CUSTOM_VERTEX_MAIN_BEGIN
mat3 view=mat3(up,right,front);
direction=view*vec3(position,1.0);
gl_Position=vec4(position,0.0,1.0);
#define CUSTOM_VERTEX_MAIN_END
}`;q.ShadersStore[Ah]=Sh;var Rh="importanceSampling",Ph=`vec3 hemisphereCosSample(vec2 u) {
float phi=2.*PI*u.x;
float cosTheta2=1.-u.y;
float cosTheta=sqrt(cosTheta2);
float sinTheta=sqrt(1.-cosTheta2);
return vec3(sinTheta*cos(phi),sinTheta*sin(phi),cosTheta);
}
vec3 hemisphereImportanceSampleDggx(vec2 u,float a) {
float phi=2.*PI*u.x;
float cosTheta2=(1.-u.y)/(1.+(a+1.)*((a-1.)*u.y));
float cosTheta=sqrt(cosTheta2);
float sinTheta=sqrt(1.-cosTheta2);
return vec3(sinTheta*cos(phi),sinTheta*sin(phi),cosTheta);
}
vec3 hemisphereImportanceSampleDCharlie(vec2 u,float a) { 
float phi=2.*PI*u.x;
float sinTheta=pow(u.y,a/(2.*a+1.));
float cosTheta=sqrt(1.-sinTheta*sinTheta);
return vec3(sinTheta*cos(phi),sinTheta*sin(phi),cosTheta);
}`;q.IncludesShadersStore[Rh]=Ph;var Mh="pbrBRDFFunctions",Ch=`#define FRESNEL_MAXIMUM_ON_ROUGH 0.25
#ifdef MS_BRDF_ENERGY_CONSERVATION
vec3 getEnergyConservationFactor(const vec3 specularEnvironmentR0,const vec3 environmentBrdf) {
return 1.0+specularEnvironmentR0*(1.0/environmentBrdf.y-1.0);
}
#endif
#ifdef ENVIRONMENTBRDF
vec3 getBRDFLookup(float NdotV,float perceptualRoughness) {
vec2 UV=vec2(NdotV,perceptualRoughness);
vec4 brdfLookup=texture2D(environmentBrdfSampler,UV);
#ifdef ENVIRONMENTBRDF_RGBD
brdfLookup.rgb=fromRGBD(brdfLookup.rgba);
#endif
return brdfLookup.rgb;
}
vec3 getReflectanceFromBRDFLookup(const vec3 specularEnvironmentR0,const vec3 specularEnvironmentR90,const vec3 environmentBrdf) {
#ifdef BRDF_V_HEIGHT_CORRELATED
vec3 reflectance=(specularEnvironmentR90-specularEnvironmentR0)*environmentBrdf.x+specularEnvironmentR0*environmentBrdf.y;
#else
vec3 reflectance=specularEnvironmentR0*environmentBrdf.x+specularEnvironmentR90*environmentBrdf.y;
#endif
return reflectance;
}
vec3 getReflectanceFromBRDFLookup(const vec3 specularEnvironmentR0,const vec3 environmentBrdf) {
#ifdef BRDF_V_HEIGHT_CORRELATED
vec3 reflectance=mix(environmentBrdf.xxx,environmentBrdf.yyy,specularEnvironmentR0);
#else
vec3 reflectance=specularEnvironmentR0*environmentBrdf.x+environmentBrdf.y;
#endif
return reflectance;
}
#endif
/* NOT USED
#if defined(SHEEN) && defined(SHEEN_SOFTER)
float getBRDFLookupCharlieSheen(float NdotV,float perceptualRoughness)
{
float c=1.0-NdotV;
float c3=c*c*c;
return 0.65584461*c3+1.0/(4.16526551+exp(-7.97291361*perceptualRoughness+6.33516894));
}
#endif
*/
#if !defined(ENVIRONMENTBRDF) || defined(REFLECTIONMAP_SKYBOX) || defined(ALPHAFRESNEL)
vec3 getReflectanceFromAnalyticalBRDFLookup_Jones(float VdotN,vec3 reflectance0,vec3 reflectance90,float smoothness)
{
float weight=mix(FRESNEL_MAXIMUM_ON_ROUGH,1.0,smoothness);
return reflectance0+weight*(reflectance90-reflectance0)*pow5(saturate(1.0-VdotN));
}
#endif
#if defined(SHEEN) && defined(ENVIRONMENTBRDF)
/**
* The sheen BRDF not containing F can be easily stored in the blue channel of the BRDF texture.
* The blue channel contains DCharlie*VAshikhmin*NdotL as a lokkup table
*/
vec3 getSheenReflectanceFromBRDFLookup(const vec3 reflectance0,const vec3 environmentBrdf) {
vec3 sheenEnvironmentReflectance=reflectance0*environmentBrdf.b;
return sheenEnvironmentReflectance;
}
#endif
vec3 fresnelSchlickGGX(float VdotH,vec3 reflectance0,vec3 reflectance90)
{
return reflectance0+(reflectance90-reflectance0)*pow5(1.0-VdotH);
}
float fresnelSchlickGGX(float VdotH,float reflectance0,float reflectance90)
{
return reflectance0+(reflectance90-reflectance0)*pow5(1.0-VdotH);
}
#ifdef CLEARCOAT
vec3 getR0RemappedForClearCoat(vec3 f0) {
#ifdef CLEARCOAT_DEFAULTIOR
#ifdef MOBILE
return saturate(f0*(f0*0.526868+0.529324)-0.0482256);
#else
return saturate(f0*(f0*(0.941892-0.263008*f0)+0.346479)-0.0285998);
#endif
#else
vec3 s=sqrt(f0);
vec3 t=(vClearCoatRefractionParams.z+vClearCoatRefractionParams.w*s)/(vClearCoatRefractionParams.w+vClearCoatRefractionParams.z*s);
return t*t;
#endif
}
#endif
float normalDistributionFunction_TrowbridgeReitzGGX(float NdotH,float alphaG)
{
float a2=square(alphaG);
float d=NdotH*NdotH*(a2-1.0)+1.0;
return a2/(PI*d*d);
}
#ifdef SHEEN
float normalDistributionFunction_CharlieSheen(float NdotH,float alphaG)
{
float invR=1./alphaG;
float cos2h=NdotH*NdotH;
float sin2h=1.-cos2h;
return (2.+invR)*pow(sin2h,invR*.5)/(2.*PI);
}
#endif
#ifdef ANISOTROPIC
float normalDistributionFunction_BurleyGGX_Anisotropic(float NdotH,float TdotH,float BdotH,const vec2 alphaTB) {
float a2=alphaTB.x*alphaTB.y;
vec3 v=vec3(alphaTB.y*TdotH,alphaTB.x *BdotH,a2*NdotH);
float v2=dot(v,v);
float w2=a2/v2;
return a2*w2*w2*RECIPROCAL_PI;
}
#endif
#ifdef BRDF_V_HEIGHT_CORRELATED
float smithVisibility_GGXCorrelated(float NdotL,float NdotV,float alphaG) {
#ifdef MOBILE
float GGXV=NdotL*(NdotV*(1.0-alphaG)+alphaG);
float GGXL=NdotV*(NdotL*(1.0-alphaG)+alphaG);
return 0.5/(GGXV+GGXL);
#else
float a2=alphaG*alphaG;
float GGXV=NdotL*sqrt(NdotV*(NdotV-a2*NdotV)+a2);
float GGXL=NdotV*sqrt(NdotL*(NdotL-a2*NdotL)+a2);
return 0.5/(GGXV+GGXL);
#endif
}
#else
float smithVisibilityG1_TrowbridgeReitzGGXFast(float dot,float alphaG)
{
#ifdef MOBILE
return 1.0/(dot+alphaG+(1.0-alphaG)*dot ));
#else
float alphaSquared=alphaG*alphaG;
return 1.0/(dot+sqrt(alphaSquared+(1.0-alphaSquared)*dot*dot));
#endif
}
float smithVisibility_TrowbridgeReitzGGXFast(float NdotL,float NdotV,float alphaG)
{
float visibility=smithVisibilityG1_TrowbridgeReitzGGXFast(NdotL,alphaG)*smithVisibilityG1_TrowbridgeReitzGGXFast(NdotV,alphaG);
return visibility;
}
#endif
#ifdef ANISOTROPIC
float smithVisibility_GGXCorrelated_Anisotropic(float NdotL,float NdotV,float TdotV,float BdotV,float TdotL,float BdotL,const vec2 alphaTB) {
float lambdaV=NdotL*length(vec3(alphaTB.x*TdotV,alphaTB.y*BdotV,NdotV));
float lambdaL=NdotV*length(vec3(alphaTB.x*TdotL,alphaTB.y*BdotL,NdotL));
float v=0.5/(lambdaV+lambdaL);
return v;
}
#endif
#ifdef CLEARCOAT
float visibility_Kelemen(float VdotH) {
return 0.25/(VdotH*VdotH); 
}
#endif
#ifdef SHEEN
float visibility_Ashikhmin(float NdotL,float NdotV)
{
return 1./(4.*(NdotL+NdotV-NdotL*NdotV));
}
/* NOT USED
#ifdef SHEEN_SOFTER
float l(float x,float alphaG)
{
float oneMinusAlphaSq=(1.0-alphaG)*(1.0-alphaG);
float a=mix(21.5473,25.3245,oneMinusAlphaSq);
float b=mix(3.82987,3.32435,oneMinusAlphaSq);
float c=mix(0.19823,0.16801,oneMinusAlphaSq);
float d=mix(-1.97760,-1.27393,oneMinusAlphaSq);
float e=mix(-4.32054,-4.85967,oneMinusAlphaSq);
return a/(1.0+b*pow(x,c))+d*x+e;
}
float lambdaSheen(float cosTheta,float alphaG)
{
return abs(cosTheta)<0.5 ? exp(l(cosTheta,alphaG)) : exp(2.0*l(0.5,alphaG)-l(1.0-cosTheta,alphaG));
}
float visibility_CharlieSheen(float NdotL,float NdotV,float alphaG)
{
float G=1.0/(1.0+lambdaSheen(NdotV,alphaG)+lambdaSheen(NdotL,alphaG));
return G/(4.0*NdotV*NdotL);
}
#endif
*/
#endif
float diffuseBRDF_Burley(float NdotL,float NdotV,float VdotH,float roughness) {
float diffuseFresnelNV=pow5(saturateEps(1.0-NdotL));
float diffuseFresnelNL=pow5(saturateEps(1.0-NdotV));
float diffuseFresnel90=0.5+2.0*VdotH*VdotH*roughness;
float fresnel =
(1.0+(diffuseFresnel90-1.0)*diffuseFresnelNL) *
(1.0+(diffuseFresnel90-1.0)*diffuseFresnelNV);
return fresnel/PI;
}
#ifdef SS_TRANSLUCENCY
vec3 transmittanceBRDF_Burley(const vec3 tintColor,const vec3 diffusionDistance,float thickness) {
vec3 S=1./maxEps(diffusionDistance);
vec3 temp=exp((-0.333333333*thickness)*S);
return tintColor.rgb*0.25*(temp*temp*temp+3.0*temp);
}
float computeWrappedDiffuseNdotL(float NdotL,float w) {
float t=1.0+w;
float invt2=1.0/square(t);
return saturate((NdotL+w)*invt2);
}
#endif
`;q.IncludesShadersStore[Mh]=Ch;var xh="hdrFilteringFunctions",Dh=`#ifdef NUM_SAMPLES
#if NUM_SAMPLES>0
#if defined(WEBGL2) || defined(WEBGPU)
float radicalInverse_VdC(uint bits) 
{
bits=(bits<<16u) | (bits>>16u);
bits=((bits & 0x55555555u)<<1u) | ((bits & 0xAAAAAAAAu)>>1u);
bits=((bits & 0x33333333u)<<2u) | ((bits & 0xCCCCCCCCu)>>2u);
bits=((bits & 0x0F0F0F0Fu)<<4u) | ((bits & 0xF0F0F0F0u)>>4u);
bits=((bits & 0x00FF00FFu)<<8u) | ((bits & 0xFF00FF00u)>>8u);
return float(bits)*2.3283064365386963e-10; 
}
vec2 hammersley(uint i,uint N)
{
return vec2(float(i)/float(N),radicalInverse_VdC(i));
}
#else
float vanDerCorpus(int n,int base)
{
float invBase=1.0/float(base);
float denom =1.0;
float result =0.0;
for(int i=0; i<32; ++i)
{
if(n>0)
{
denom =mod(float(n),2.0);
result+=denom*invBase;
invBase=invBase/2.0;
n =int(float(n)/2.0);
}
}
return result;
}
vec2 hammersley(int i,int N)
{
return vec2(float(i)/float(N),vanDerCorpus(i,2));
}
#endif
float log4(float x) {
return log2(x)/2.;
}
const float NUM_SAMPLES_FLOAT=float(NUM_SAMPLES);
const float NUM_SAMPLES_FLOAT_INVERSED=1./NUM_SAMPLES_FLOAT;
const float K=4.;
#define inline
vec3 irradiance(samplerCube inputTexture,vec3 inputN,vec2 filteringInfo)
{
vec3 n=normalize(inputN);
vec3 result=vec3(0.0);
vec3 tangent=abs(n.z)<0.999 ? vec3(0.,0.,1.) : vec3(1.,0.,0.);
tangent=normalize(cross(tangent,n));
vec3 bitangent=cross(n,tangent);
mat3 tbn=mat3(tangent,bitangent,n);
float maxLevel=filteringInfo.y;
float dim0=filteringInfo.x;
float omegaP=(4.*PI)/(6.*dim0*dim0);
#if defined(WEBGL2) || defined(WEBGPU)
for(uint i=0u; i<NUM_SAMPLES; ++i)
#else
for(int i=0; i<NUM_SAMPLES; ++i)
#endif
{
vec2 Xi=hammersley(i,NUM_SAMPLES);
vec3 Ls=hemisphereCosSample(Xi);
Ls=normalize(Ls);
vec3 Ns=vec3(0.,0.,1.);
float NoL=dot(Ns,Ls);
if (NoL>0.) {
float pdf_inversed=PI/NoL;
float omegaS=NUM_SAMPLES_FLOAT_INVERSED*pdf_inversed;
float l=log4(omegaS)-log4(omegaP)+log4(K);
float mipLevel=clamp(l,0.0,maxLevel);
vec3 c=textureCubeLodEXT(inputTexture,tbn*Ls,mipLevel).rgb;
#ifdef GAMMA_INPUT
c=toLinearSpace(c);
#endif
result+=c;
}
}
result=result*NUM_SAMPLES_FLOAT_INVERSED;
return result;
}
#define inline
vec3 radiance(float alphaG,samplerCube inputTexture,vec3 inputN,vec2 filteringInfo)
{
vec3 n=normalize(inputN);
if (alphaG==0.) {
vec3 c=textureCube(inputTexture,n).rgb;
#ifdef GAMMA_INPUT
c=toLinearSpace(c);
#endif
return c;
} else {
vec3 result=vec3(0.);
vec3 tangent=abs(n.z)<0.999 ? vec3(0.,0.,1.) : vec3(1.,0.,0.);
tangent=normalize(cross(tangent,n));
vec3 bitangent=cross(n,tangent);
mat3 tbn=mat3(tangent,bitangent,n);
float maxLevel=filteringInfo.y;
float dim0=filteringInfo.x;
float omegaP=(4.*PI)/(6.*dim0*dim0);
float weight=0.;
#if defined(WEBGL2) || defined(WEBGPU)
for(uint i=0u; i<NUM_SAMPLES; ++i)
#else
for(int i=0; i<NUM_SAMPLES; ++i)
#endif
{
vec2 Xi=hammersley(i,NUM_SAMPLES);
vec3 H=hemisphereImportanceSampleDggx(Xi,alphaG);
float NoV=1.;
float NoH=H.z;
float NoH2=H.z*H.z;
float NoL=2.*NoH2-1.;
vec3 L=vec3(2.*NoH*H.x,2.*NoH*H.y,NoL);
L=normalize(L);
if (NoL>0.) {
float pdf_inversed=4./normalDistributionFunction_TrowbridgeReitzGGX(NoH,alphaG);
float omegaS=NUM_SAMPLES_FLOAT_INVERSED*pdf_inversed;
float l=log4(omegaS)-log4(omegaP)+log4(K);
float mipLevel=clamp(float(l),0.0,maxLevel);
weight+=NoL;
vec3 c=textureCubeLodEXT(inputTexture,tbn*L,mipLevel).rgb;
#ifdef GAMMA_INPUT
c=toLinearSpace(c);
#endif
result+=c*NoL;
}
}
result=result/weight;
return result;
}
}
#endif
#endif
`;q.IncludesShadersStore[xh]=Dh;var Oh="hdrFilteringPixelShader",Ih=`#include<helperFunctions>
#include<importanceSampling>
#include<pbrBRDFFunctions>
#include<hdrFilteringFunctions>
uniform float alphaG;
uniform samplerCube inputTexture;
uniform vec2 vFilteringInfo;
uniform float hdrScale;
varying vec3 direction;
void main() {
vec3 color=radiance(alphaG,inputTexture,direction,vFilteringInfo);
gl_FragColor=vec4(color*hdrScale,1.0);
}`;q.ShadersStore[Oh]=Ih;var Fh=function(){function i(e,t){t===void 0&&(t={}),this._lodGenerationOffset=0,this._lodGenerationScale=.8,this.quality=4096,this.hdrScale=1,this._engine=e,this.hdrScale=t.hdrScale||this.hdrScale,this.quality=t.quality||this.quality}return i.prototype._createRenderTarget=function(e){var t=0;this._engine.getCaps().textureHalfFloatRender?t=2:this._engine.getCaps().textureFloatRender&&(t=1);var r=this._engine.createRenderTargetCubeTexture(e,{format:5,type:t,createMipMaps:!0,generateMipMaps:!1,generateDepthBuffer:!1,generateStencilBuffer:!1,samplingMode:1});return this._engine.updateTextureWrappingMode(r.texture,0,0,0),this._engine.updateTextureSamplingMode(3,r.texture,!0),r},i.prototype._prefilterInternal=function(e){var t=e.getSize().width,r=K.ILog2(t)+1,n=this._effectWrapper.effect,a=this._createRenderTarget(t);this._effectRenderer.setViewport();var s=e.getInternalTexture();s&&this._engine.updateTextureSamplingMode(3,s,!0),this._effectRenderer.applyEffectWrapper(this._effectWrapper);var o=[[new m(0,0,-1),new m(0,-1,0),new m(1,0,0)],[new m(0,0,1),new m(0,-1,0),new m(-1,0,0)],[new m(1,0,0),new m(0,0,1),new m(0,1,0)],[new m(1,0,0),new m(0,0,-1),new m(0,-1,0)],[new m(1,0,0),new m(0,-1,0),new m(0,0,1)],[new m(-1,0,0),new m(0,-1,0),new m(0,0,-1)]];n.setFloat("hdrScale",this.hdrScale),n.setFloat2("vFilteringInfo",e.getSize().width,r),n.setTexture("inputTexture",e);for(var l=0;l<6;l++){n.setVector3("up",o[l][0]),n.setVector3("right",o[l][1]),n.setVector3("front",o[l][2]);for(var u=0;u<r;u++){this._engine.bindFramebuffer(a,l,void 0,void 0,!0,u),this._effectRenderer.applyEffectWrapper(this._effectWrapper);var f=Math.pow(2,(u-this._lodGenerationOffset)/this._lodGenerationScale)/t;u===0&&(f=0),n.setFloat("alphaG",f),this._effectRenderer.draw()}}return this._effectRenderer.restoreStates(),this._engine.restoreDefaultFramebuffer(),this._engine._releaseTexture(e._texture),a._swapAndDie(e._texture),e._prefiltered=!0,e},i.prototype._createEffect=function(e,t){var r=[];e.gammaSpace&&r.push("#define GAMMA_INPUT"),r.push("#define NUM_SAMPLES "+this.quality+"u");var n=new Eh({engine:this._engine,name:"hdrFiltering",vertexShader:"hdrFiltering",fragmentShader:"hdrFiltering",samplerNames:["inputTexture"],uniformNames:["vSampleDirections","vWeights","up","right","front","vFilteringInfo","hdrScale","alphaG"],useShaderStore:!0,defines:r,onCompiled:t});return n},i.prototype.isReady=function(e){return e.isReady()&&this._effectWrapper.effect.isReady()},i.prototype.prefilter=function(e,t){var r=this;return t===void 0&&(t=null),this._engine._features.allowTexturePrefiltering?new Promise(function(n){r._effectRenderer=new Th(r._engine),r._effectWrapper=r._createEffect(e),r._effectWrapper.effect.executeWhenCompiled(function(){r._prefilterInternal(e),r._effectRenderer.dispose(),r._effectWrapper.dispose(),n(),t&&t()})}):(Y.Warn("HDR prefiltering is not available in WebGL 1., you can use real time filtering instead."),Promise.reject("HDR prefiltering is not available in WebGL 1., you can use real time filtering instead."))},i}(),wh=function(){function i(e,t,r,n){this._textures=null,this._attachments=null,this._generateStencilBuffer=!1,this._generateDepthBuffer=!1,this._depthStencilTextureWithStencil=!1,this._isMulti=e,this._isCube=t,this._size=r,this._engine=n,this._depthStencilTexture=null}return Object.defineProperty(i.prototype,"depthStencilTexture",{get:function(){return this._depthStencilTexture},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"depthStencilTextureWithStencil",{get:function(){return this._depthStencilTextureWithStencil},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"isCube",{get:function(){return this._isCube},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"isMulti",{get:function(){return this._isMulti},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"is2DArray",{get:function(){return this.layers>0},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"size",{get:function(){return this.width},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"width",{get:function(){return this._size.width||this._size},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"height",{get:function(){return this._size.height||this._size},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"layers",{get:function(){return this._size.layers||0},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"texture",{get:function(){var e,t;return(t=(e=this._textures)===null||e===void 0?void 0:e[0])!==null&&t!==void 0?t:null},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"textures",{get:function(){return this._textures},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"samples",{get:function(){var e,t;return(t=(e=this.texture)===null||e===void 0?void 0:e.samples)!==null&&t!==void 0?t:1},enumerable:!1,configurable:!0}),i.prototype.setSamples=function(e,t,r){return t===void 0&&(t=!0),r===void 0&&(r=!1),this.samples===e&&!r?e:this._isMulti?this._engine.updateMultipleRenderTargetTextureSampleCount(this,e,t):this._engine.updateRenderTargetTextureSampleCount(this,e)},i.prototype.setTextures=function(e){Array.isArray(e)?this._textures=e:e?this._textures=[e]:this._textures=null},i.prototype.setTexture=function(e,t,r){t===void 0&&(t=0),r===void 0&&(r=!0),this._textures||(this._textures=[]),this._textures[t]&&r&&this._textures[t].dispose(),this._textures[t]=e},i.prototype.createDepthStencilTexture=function(e,t,r,n,a){var s;return e===void 0&&(e=0),t===void 0&&(t=!0),r===void 0&&(r=!1),n===void 0&&(n=1),a===void 0&&(a=14),(s=this._depthStencilTexture)===null||s===void 0||s.dispose(),this._depthStencilTextureWithStencil=r,this._depthStencilTexture=this._engine.createDepthStencilTexture(this._size,{bilinearFiltering:t,comparisonFunction:e,generateStencil:r,isCube:this._isCube,samples:n,depthTextureFormat:a},this),this._depthStencilTexture},i.prototype._shareDepth=function(e){this._depthStencilTexture&&(e._depthStencilTexture&&e._depthStencilTexture.dispose(),e._depthStencilTexture=this._depthStencilTexture,this._depthStencilTexture.incrementReferences())},i.prototype._swapAndDie=function(e){this.texture&&this.texture._swapAndDie(e),this._textures=null,this.dispose(!0)},i.prototype._cloneRenderTargetWrapper=function(){var e,t,r,n,a,s,o=null;if(this._isMulti){var l=this.textures;if(l&&l.length>0){var u=!1,f=l.length,h=l[l.length-1]._source;(h===Ie.Depth||h===Ie.DepthStencil)&&(u=!0,f--);for(var c=[],d=[],p=0;p<f;++p){var _=l[p];c.push(_.samplingMode),d.push(_.type)}var g={samplingModes:c,generateMipMaps:l[0].generateMipMaps,generateDepthBuffer:this._generateDepthBuffer,generateStencilBuffer:this._generateStencilBuffer,generateDepthTexture:u,types:d,textureCount:f},v={width:this.width,height:this.height};o=this._engine.createMultipleRenderTarget(v,g)}}else{var y={};if(y.generateDepthBuffer=this._generateDepthBuffer,y.generateMipMaps=(t=(e=this.texture)===null||e===void 0?void 0:e.generateMipMaps)!==null&&t!==void 0?t:!1,y.generateStencilBuffer=this._generateStencilBuffer,y.samplingMode=(r=this.texture)===null||r===void 0?void 0:r.samplingMode,y.type=(n=this.texture)===null||n===void 0?void 0:n.type,y.format=(a=this.texture)===null||a===void 0?void 0:a.format,this.isCube)o=this._engine.createRenderTargetCubeTexture(this.width,y);else{var v={width:this.width,height:this.height,layers:this.is2DArray?(s=this.texture)===null||s===void 0?void 0:s.depth:void 0};o=this._engine.createRenderTargetTexture(v,y)}o.texture.isReady=!0}return o},i.prototype._swapRenderTargetWrapper=function(e){if(this._textures&&e._textures)for(var t=0;t<this._textures.length;++t)this._textures[t]._swapAndDie(e._textures[t],!1),e._textures[t].isReady=!0;this._depthStencilTexture&&e._depthStencilTexture&&(this._depthStencilTexture._swapAndDie(e._depthStencilTexture),e._depthStencilTexture.isReady=!0),this._textures=null,this._depthStencilTexture=null},i.prototype._rebuild=function(){var e=this._cloneRenderTargetWrapper();if(!!e){if(this._depthStencilTexture){var t=this._depthStencilTexture.samplingMode,r=t===2||t===3||t===11;e.createDepthStencilTexture(this._depthStencilTexture._comparisonFunction,r,this._depthStencilTextureWithStencil,this._depthStencilTexture.samples)}this.samples>1&&e.setSamples(this.samples),e._swapRenderTargetWrapper(this),e.dispose()}},i.prototype.releaseTextures=function(){var e,t;if(this._textures)for(var r=0;(t=r<((e=this._textures)===null||e===void 0?void 0:e.length))!==null&&t!==void 0&&t;++r)this._textures[r].dispose();this._textures=null},i.prototype.dispose=function(e){var t;e===void 0&&(e=!1),e||((t=this._depthStencilTexture)===null||t===void 0||t.dispose(),this._depthStencilTexture=null,this.releaseTextures()),this._engine._releaseRenderTargetWrapper(this)},i}(),Lh=function(i){$(e,i);function e(t,r,n,a,s){var o=i.call(this,t,r,n,a)||this;return o._framebuffer=null,o._depthStencilBuffer=null,o._MSAAFramebuffer=null,o._colorTextureArray=null,o._depthStencilTextureArray=null,o._context=s,o}return e.prototype._cloneRenderTargetWrapper=function(){var t=null;return this._colorTextureArray&&this._depthStencilTextureArray?(t=this._engine.createMultiviewRenderTargetTexture(this.width,this.height),t.texture.isReady=!0):t=i.prototype._cloneRenderTargetWrapper.call(this),t},e.prototype._swapRenderTargetWrapper=function(t){i.prototype._swapRenderTargetWrapper.call(this,t),t._framebuffer=this._framebuffer,t._depthStencilBuffer=this._depthStencilBuffer,t._MSAAFramebuffer=this._MSAAFramebuffer,t._colorTextureArray=this._colorTextureArray,t._depthStencilTextureArray=this._depthStencilTextureArray,this._framebuffer=this._depthStencilBuffer=this._MSAAFramebuffer=this._colorTextureArray=this._depthStencilTextureArray=null},e.prototype._shareDepth=function(t){i.prototype._shareDepth.call(this,t);var r=this._context,n=this._depthStencilBuffer,a=t._framebuffer;t._depthStencilBuffer&&r.deleteRenderbuffer(t._depthStencilBuffer),t._depthStencilBuffer=this._depthStencilBuffer,this._engine._bindUnboundFramebuffer(a),r.framebufferRenderbuffer(r.FRAMEBUFFER,r.DEPTH_ATTACHMENT,r.RENDERBUFFER,n),this._engine._bindUnboundFramebuffer(null)},e.prototype._bindTextureRenderTarget=function(t,r,n,a){if(r===void 0&&(r=0),n===void 0&&(n=-1),a===void 0&&(a=0),!!t._hardwareTexture){var s=this._context,o=this._framebuffer,l=this._engine._currentFramebuffer;this._engine._bindUnboundFramebuffer(o);var u=s[this._engine.webGLVersion>1?"COLOR_ATTACHMENT"+r:"COLOR_ATTACHMENT"+r+"_WEBGL"],f=n!==-1?s.TEXTURE_CUBE_MAP_POSITIVE_X+n:s.TEXTURE_2D;s.framebufferTexture2D(s.FRAMEBUFFER,u,f,t._hardwareTexture.underlyingResource,a),this._engine._bindUnboundFramebuffer(l)}},e.prototype.setTexture=function(t,r,n){r===void 0&&(r=0),n===void 0&&(n=!0),i.prototype.setTexture.call(this,t,r,n),this._bindTextureRenderTarget(t,r)},e.prototype.dispose=function(t){t===void 0&&(t=!1);var r=this._context;t||(this._colorTextureArray&&(this._context.deleteTexture(this._colorTextureArray),this._colorTextureArray=null),this._depthStencilTextureArray&&(this._context.deleteTexture(this._depthStencilTextureArray),this._depthStencilTextureArray=null)),this._framebuffer&&(r.deleteFramebuffer(this._framebuffer),this._framebuffer=null),this._depthStencilBuffer&&(r.deleteRenderbuffer(this._depthStencilBuffer),this._depthStencilBuffer=null),this._MSAAFramebuffer&&(r.deleteFramebuffer(this._MSAAFramebuffer),this._MSAAFramebuffer=null),i.prototype.dispose.call(this,t)},e}(wh);ge.prototype._createHardwareRenderTargetWrapper=function(i,e,t){var r=new Lh(i,e,t,this,this._gl);return this._renderTargetWrapperCache.push(r),r};ge.prototype.createRenderTargetTexture=function(i,e){var t=this._createHardwareRenderTargetWrapper(!1,!1,i),r={};e!==void 0&&typeof e=="object"?(r.generateDepthBuffer=!!e.generateDepthBuffer,r.generateStencilBuffer=!!e.generateStencilBuffer):(r.generateDepthBuffer=!0,r.generateStencilBuffer=!1);var n=this._createInternalTexture(i,e,!0,Ie.RenderTarget),a=i.width||i,s=i.height||i,o=this._currentFramebuffer,l=this._gl,u=l.createFramebuffer();return this._bindUnboundFramebuffer(u),t._depthStencilBuffer=this._setupFramebufferDepthAttachments(!!r.generateStencilBuffer,r.generateDepthBuffer,a,s),n.is2DArray||l.framebufferTexture2D(l.FRAMEBUFFER,l.COLOR_ATTACHMENT0,l.TEXTURE_2D,n._hardwareTexture.underlyingResource,0),this._bindUnboundFramebuffer(o),t._framebuffer=u,t._generateDepthBuffer=r.generateDepthBuffer,t._generateStencilBuffer=!!r.generateStencilBuffer,t.setTextures(n),t};ge.prototype.createDepthStencilTexture=function(i,e,t){if(e.isCube){var r=i.width||i;return this._createDepthStencilCubeTexture(r,e,t)}else return this._createDepthStencilTexture(i,e,t)};ge.prototype._createDepthStencilTexture=function(i,e,t){var r=this._gl,n=i.layers||0,a=n!==0?r.TEXTURE_2D_ARRAY:r.TEXTURE_2D,s=new at(this,Ie.DepthStencil);if(!this._caps.depthTextureExtension)return Y.Error("Depth texture is not supported by your browser or hardware."),s;var o=Ue({bilinearFiltering:!1,comparisonFunction:0,generateStencil:!1},e);this._bindTextureDirectly(a,s,!0),this._setupDepthStencilTexture(s,i,o.generateStencil,o.comparisonFunction===0?!1:o.bilinearFiltering,o.comparisonFunction),s.format=o.generateStencil?13:16,t._depthStencilTexture=s,t._depthStencilTextureWithStencil=o.generateStencil;var l=o.generateStencil?r.UNSIGNED_INT_24_8:r.UNSIGNED_INT,u=o.generateStencil?r.DEPTH_STENCIL:r.DEPTH_COMPONENT,f=u;return this.webGLVersion>1&&(f=o.generateStencil?r.DEPTH24_STENCIL8:r.DEPTH_COMPONENT24),s.is2DArray?r.texImage3D(a,0,f,s.width,s.height,n,0,u,l,null):r.texImage2D(a,0,f,s.width,s.height,0,u,l,null),this._bindTextureDirectly(a,null),this._internalTexturesCache.push(s),s};ge.prototype.updateRenderTargetTextureSampleCount=function(i,e){if(this.webGLVersion<2||!i||!i.texture)return 1;if(i.samples===e)return e;var t=this._gl;e=Math.min(e,this.getCaps().maxMSAASamples),i._depthStencilBuffer&&(t.deleteRenderbuffer(i._depthStencilBuffer),i._depthStencilBuffer=null),i._MSAAFramebuffer&&(t.deleteFramebuffer(i._MSAAFramebuffer),i._MSAAFramebuffer=null);var r=i.texture._hardwareTexture;if(r._MSAARenderBuffer&&(t.deleteRenderbuffer(r._MSAARenderBuffer),r._MSAARenderBuffer=null),e>1&&t.renderbufferStorageMultisample){var n=t.createFramebuffer();if(!n)throw new Error("Unable to create multi sampled framebuffer");i._MSAAFramebuffer=n,this._bindUnboundFramebuffer(i._MSAAFramebuffer);var a=this._createRenderBuffer(i.texture.width,i.texture.height,e,-1,this._getRGBAMultiSampleBufferFormat(i.texture.type),t.COLOR_ATTACHMENT0,!1);if(!a)throw new Error("Unable to create multi sampled framebuffer");r._MSAARenderBuffer=a}else this._bindUnboundFramebuffer(i._framebuffer);return i.texture.samples=e,i._depthStencilBuffer=this._setupFramebufferDepthAttachments(i._generateStencilBuffer,i._generateDepthBuffer,i.texture.width,i.texture.height,e),this._bindUnboundFramebuffer(null),e};ge.prototype.createRenderTargetCubeTexture=function(i,e){var t=this._createHardwareRenderTargetWrapper(!1,!0,i),r=Ue({generateMipMaps:!0,generateDepthBuffer:!0,generateStencilBuffer:!1,type:0,samplingMode:3,format:5},e);r.generateStencilBuffer=r.generateDepthBuffer&&r.generateStencilBuffer,(r.type===1&&!this._caps.textureFloatLinearFiltering||r.type===2&&!this._caps.textureHalfFloatLinearFiltering)&&(r.samplingMode=1);var n=this._gl,a=new at(this,Ie.RenderTarget);this._bindTextureDirectly(n.TEXTURE_CUBE_MAP,a,!0);var s=this._getSamplingParameters(r.samplingMode,r.generateMipMaps);r.type===1&&!this._caps.textureFloat&&(r.type=0,Y.Warn("Float textures are not supported. Cube render target forced to TEXTURETYPE_UNESIGNED_BYTE type")),n.texParameteri(n.TEXTURE_CUBE_MAP,n.TEXTURE_MAG_FILTER,s.mag),n.texParameteri(n.TEXTURE_CUBE_MAP,n.TEXTURE_MIN_FILTER,s.min),n.texParameteri(n.TEXTURE_CUBE_MAP,n.TEXTURE_WRAP_S,n.CLAMP_TO_EDGE),n.texParameteri(n.TEXTURE_CUBE_MAP,n.TEXTURE_WRAP_T,n.CLAMP_TO_EDGE);for(var o=0;o<6;o++)n.texImage2D(n.TEXTURE_CUBE_MAP_POSITIVE_X+o,0,this._getRGBABufferInternalSizedFormat(r.type,r.format),i,i,0,this._getInternalFormat(r.format),this._getWebGLTextureType(r.type),null);var l=n.createFramebuffer();return this._bindUnboundFramebuffer(l),t._depthStencilBuffer=this._setupFramebufferDepthAttachments(r.generateStencilBuffer,r.generateDepthBuffer,i,i),r.generateMipMaps&&n.generateMipmap(n.TEXTURE_CUBE_MAP),this._bindTextureDirectly(n.TEXTURE_CUBE_MAP,null),this._bindUnboundFramebuffer(null),t._framebuffer=l,t._generateDepthBuffer=r.generateDepthBuffer,t._generateStencilBuffer=r.generateStencilBuffer,a.width=i,a.height=i,a.isReady=!0,a.isCube=!0,a.samples=1,a.generateMipMaps=r.generateMipMaps,a.samplingMode=r.samplingMode,a.type=r.type,a.format=r.format,this._internalTexturesCache.push(a),t.setTextures(a),t};var ur=function(i){$(e,i);function e(t,r,n,a,s,o,l,u,f,h,c,d,p,_,g){s===void 0&&(s=!0),o===void 0&&(o=0),l===void 0&&(l=!1),u===void 0&&(u=re.TRILINEAR_SAMPLINGMODE),f===void 0&&(f=!0),h===void 0&&(h=!1),c===void 0&&(c=!1),d===void 0&&(d=5),p===void 0&&(p=!1);var v=this,y;if(v=i.call(this,null,n,!a,void 0,u,void 0,void 0,void 0,void 0,d)||this,v.renderParticles=!0,v.renderSprites=!1,v.ignoreCameraViewport=!1,v.onBeforeBindObservable=new X,v.onAfterUnbindObservable=new X,v.onBeforeRenderObservable=new X,v.onAfterRenderObservable=new X,v.onClearObservable=new X,v.onResizeObservable=new X,v._cleared=!1,v.skipInitialClear=!1,v._currentRefreshId=-1,v._refreshRate=1,v._samples=1,v._canRescale=!0,v._renderTarget=null,v.boundingBoxPosition=m.Zero(),n=v.getScene(),!n)return v;var b=v.getScene().getEngine();return v._coordinatesMode=re.PROJECTION_MODE,v.renderList=new Array,v.name=t,v.isRenderTarget=!0,v._initialSizeParameter=r,v._renderPassIds=[],v._isCubeData=l,v._processSizeParameter(r),v.renderPassId=v._renderPassIds[0],v._resizeObserver=b.onResizeObservable.add(function(){}),v._generateMipMaps=!!a,v._doNotChangeAspectRatio=s,v._renderingManager=new Jr(n),v._renderingManager._useSceneAutoClearSetup=!0,c||(v._renderTargetOptions={generateMipMaps:a,type:o,format:(y=v._format)!==null&&y!==void 0?y:void 0,samplingMode:v.samplingMode,generateDepthBuffer:f,generateStencilBuffer:h,samples:_,creationFlags:g},v.samplingMode===re.NEAREST_SAMPLINGMODE&&(v.wrapU=re.CLAMP_ADDRESSMODE,v.wrapV=re.CLAMP_ADDRESSMODE),p||(l?(v._renderTarget=n.getEngine().createRenderTargetCubeTexture(v.getRenderSize(),v._renderTargetOptions),v.coordinatesMode=re.INVCUBIC_MODE,v._textureMatrix=G.Identity()):v._renderTarget=n.getEngine().createRenderTargetTexture(v._size,v._renderTargetOptions),v._texture=v._renderTarget.texture,_!==void 0&&(v.samples=_))),v}return Object.defineProperty(e.prototype,"renderList",{get:function(){return this._renderList},set:function(t){this._renderList=t,this._renderList&&this._hookArray(this._renderList)},enumerable:!1,configurable:!0}),e.prototype._hookArray=function(t){var r=this,n=t.push;t.push=function(){for(var s,o=[],l=0;l<arguments.length;l++)o[l]=arguments[l];var u=t.length===0,f=n.apply(t,o);return u&&((s=r.getScene())===null||s===void 0||s.meshes.forEach(function(h){h._markSubMeshesAsLightDirty()})),f};var a=t.splice;t.splice=function(s,o){var l,u=a.apply(t,[s,o]);return t.length===0&&((l=r.getScene())===null||l===void 0||l.meshes.forEach(function(f){f._markSubMeshesAsLightDirty()})),u}},Object.defineProperty(e.prototype,"postProcesses",{get:function(){return this._postProcesses},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"_prePassEnabled",{get:function(){return!!this._prePassRenderTarget&&this._prePassRenderTarget.enabled},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"onAfterUnbind",{set:function(t){this._onAfterUnbindObserver&&this.onAfterUnbindObservable.remove(this._onAfterUnbindObserver),this._onAfterUnbindObserver=this.onAfterUnbindObservable.add(t)},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"onBeforeRender",{set:function(t){this._onBeforeRenderObserver&&this.onBeforeRenderObservable.remove(this._onBeforeRenderObserver),this._onBeforeRenderObserver=this.onBeforeRenderObservable.add(t)},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"onAfterRender",{set:function(t){this._onAfterRenderObserver&&this.onAfterRenderObservable.remove(this._onAfterRenderObserver),this._onAfterRenderObserver=this.onAfterRenderObservable.add(t)},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"onClear",{set:function(t){this._onClearObserver&&this.onClearObservable.remove(this._onClearObserver),this._onClearObserver=this.onClearObservable.add(t)},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"renderPassIds",{get:function(){return this._renderPassIds},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"currentRefreshId",{get:function(){return this._currentRefreshId},enumerable:!1,configurable:!0}),e.prototype.setMaterialForRendering=function(t,r){var n;Array.isArray(t)?n=t:n=[t];for(var a=0;a<n.length;++a)for(var s=0;s<this._renderPassIds.length;++s)n[a].setMaterialForRenderPass(this._renderPassIds[s],r!==void 0?Array.isArray(r)?r[s]:r:void 0)},Object.defineProperty(e.prototype,"renderTargetOptions",{get:function(){return this._renderTargetOptions},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"renderTarget",{get:function(){return this._renderTarget},enumerable:!1,configurable:!0}),e.prototype._onRatioRescale=function(){this._sizeRatio&&this.resize(this._initialSizeParameter)},Object.defineProperty(e.prototype,"boundingBoxSize",{get:function(){return this._boundingBoxSize},set:function(t){if(!(this._boundingBoxSize&&this._boundingBoxSize.equals(t))){this._boundingBoxSize=t;var r=this.getScene();r&&r.markAllMaterialsAsDirty(1)}},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"depthStencilTexture",{get:function(){var t,r;return(r=(t=this._renderTarget)===null||t===void 0?void 0:t._depthStencilTexture)!==null&&r!==void 0?r:null},enumerable:!1,configurable:!0}),e.prototype.createDepthStencilTexture=function(t,r,n,a,s){var o;t===void 0&&(t=0),r===void 0&&(r=!0),n===void 0&&(n=!1),a===void 0&&(a=1),s===void 0&&(s=14),(o=this._renderTarget)===null||o===void 0||o.createDepthStencilTexture(t,r,n,a,s)},e.prototype._releaseRenderPassId=function(){if(this._scene)for(var t=this._scene.getEngine(),r=0;r<this._renderPassIds.length;++r)t.releaseRenderPassId(this._renderPassIds[r]);this._renderPassIds=[]},e.prototype._createRenderPassId=function(){this._releaseRenderPassId();for(var t=this._scene.getEngine(),r=this._isCubeData?6:this.getRenderLayers()||1,n=0;n<r;++n)this._renderPassIds[n]=t.createRenderPassId("RenderTargetTexture - ".concat(this.name,"#").concat(n))},e.prototype._processSizeParameter=function(t){if(t.ratio){this._sizeRatio=t.ratio;var r=this._getEngine();this._size={width:this._bestReflectionRenderTargetDimension(r.getRenderWidth(),this._sizeRatio),height:this._bestReflectionRenderTargetDimension(r.getRenderHeight(),this._sizeRatio)}}else this._size=t;this._createRenderPassId()},Object.defineProperty(e.prototype,"samples",{get:function(){var t,r;return(r=(t=this._renderTarget)===null||t===void 0?void 0:t.samples)!==null&&r!==void 0?r:this._samples},set:function(t){this._renderTarget&&(this._samples=this._renderTarget.setSamples(t))},enumerable:!1,configurable:!0}),e.prototype.resetRefreshCounter=function(){this._currentRefreshId=-1},Object.defineProperty(e.prototype,"refreshRate",{get:function(){return this._refreshRate},set:function(t){this._refreshRate=t,this.resetRefreshCounter()},enumerable:!1,configurable:!0}),e.prototype.addPostProcess=function(t){if(!this._postProcessManager){var r=this.getScene();if(!r)return;this._postProcessManager=new $r(r),this._postProcesses=new Array}this._postProcesses.push(t),this._postProcesses[0].autoClear=!1},e.prototype.clearPostProcesses=function(t){if(t===void 0&&(t=!1),!!this._postProcesses){if(t)for(var r=0,n=this._postProcesses;r<n.length;r++){var a=n[r];a.dispose()}this._postProcesses=[]}},e.prototype.removePostProcess=function(t){if(!!this._postProcesses){var r=this._postProcesses.indexOf(t);r!==-1&&(this._postProcesses.splice(r,1),this._postProcesses.length>0&&(this._postProcesses[0].autoClear=!1))}},e.prototype._shouldRender=function(){return this._currentRefreshId===-1?(this._currentRefreshId=1,!0):this.refreshRate===this._currentRefreshId?(this._currentRefreshId=1,!0):(this._currentRefreshId++,!1)},e.prototype.getRenderSize=function(){return this.getRenderWidth()},e.prototype.getRenderWidth=function(){return this._size.width?this._size.width:this._size},e.prototype.getRenderHeight=function(){return this._size.width?this._size.height:this._size},e.prototype.getRenderLayers=function(){var t=this._size.layers;return t||0},e.prototype.disableRescaling=function(){this._canRescale=!1},Object.defineProperty(e.prototype,"canRescale",{get:function(){return this._canRescale},enumerable:!1,configurable:!0}),e.prototype.scale=function(t){var r=Math.max(1,this.getRenderSize()*t);this.resize(r)},e.prototype.getReflectionTextureMatrix=function(){return this.isCube?this._textureMatrix:i.prototype.getReflectionTextureMatrix.call(this)},e.prototype.resize=function(t){var r,n=this.isCube;(r=this._renderTarget)===null||r===void 0||r.dispose(),this._renderTarget=null;var a=this.getScene();!a||(this._processSizeParameter(t),n?this._renderTarget=a.getEngine().createRenderTargetCubeTexture(this.getRenderSize(),this._renderTargetOptions):this._renderTarget=a.getEngine().createRenderTargetTexture(this._size,this._renderTargetOptions),this._texture=this._renderTarget.texture,this._renderTargetOptions.samples!==void 0&&(this.samples=this._renderTargetOptions.samples),this.onResizeObservable.hasObservers()&&this.onResizeObservable.notifyObservers(this))},e.prototype.render=function(t,r){t===void 0&&(t=!1),r===void 0&&(r=!1),this._render(t,r)},e.prototype.isReadyForRendering=function(){return this._render(!1,!1,!0)},e.prototype._render=function(t,r,n){var a;t===void 0&&(t=!1),r===void 0&&(r=!1),n===void 0&&(n=!1);var s=this.getScene();if(!s)return n;var o=s.getEngine();if(this.useCameraPostProcesses!==void 0&&(t=this.useCameraPostProcesses),this._waitingRenderList){this.renderList=[];for(var l=0;l<this._waitingRenderList.length;l++){var u=this._waitingRenderList[l],f=s.getMeshById(u);f&&this.renderList.push(f)}this._waitingRenderList=void 0}if(this.renderListPredicate){this.renderList?this.renderList.length=0:this.renderList=[];var h=this.getScene();if(!h)return n;for(var c=h.meshes,l=0;l<c.length;l++){var f=c[l];this.renderListPredicate(f)&&this.renderList.push(f)}}var d=o.currentRenderPassId;this.onBeforeBindObservable.notifyObservers(this);var p=(a=this.activeCamera)!==null&&a!==void 0?a:s.activeCamera;p&&(p!==s.activeCamera&&s.setTransformMatrix(p.getViewMatrix(),p.getProjectionMatrix(!0)),o.setViewport(p.viewport,this.getRenderWidth(),this.getRenderHeight())),this._defaultRenderListPrepared=!1;var _=n;if(n){s.getViewMatrix()||s.updateTransformMatrix();for(var y=this.is2DArray?this.getRenderLayers():this.isCube?6:1,g=0;g<y&&_;g++){var b=null,E=this.renderList?this.renderList:s.getActiveMeshes().data,A=this.renderList?this.renderList.length:s.getActiveMeshes().length;o.currentRenderPassId=this._renderPassIds[g],this.onBeforeRenderObservable.notifyObservers(g),this.getCustomRenderList&&(b=this.getCustomRenderList(g,E,A)),b||(b=E),this._doNotChangeAspectRatio||s.updateTransformMatrix(!0);for(var S=0;S<b.length&&_;++S){var f=b[S];if(!(!f.isEnabled()||f.isBlocked||!f.isVisible||!f.subMeshes)){if(this.customIsReadyFunction){if(!this.customIsReadyFunction(f,this.refreshRate)){_=!1;break}}else if(!f.isReady(!0)){_=!1;break}}}this.onAfterRenderObservable.notifyObservers(g)}}else if(this.is2DArray)for(var g=0;g<this.getRenderLayers();g++)this._renderToTarget(0,t,r,g,p),s.incrementRenderId(),s.resetCachedMaterial();else if(this.isCube)for(var v=0;v<6;v++)this._renderToTarget(v,t,r,void 0,p),s.incrementRenderId(),s.resetCachedMaterial();else this._renderToTarget(0,t,r,void 0,p);return this.onAfterUnbindObservable.notifyObservers(this),o.currentRenderPassId=d,s.activeCamera&&((s.getEngine().scenes.length>1||this.activeCamera&&this.activeCamera!==s.activeCamera)&&s.setTransformMatrix(s.activeCamera.getViewMatrix(),s.activeCamera.getProjectionMatrix(!0)),o.setViewport(s.activeCamera.viewport)),s.resetCachedMaterial(),_},e.prototype._bestReflectionRenderTargetDimension=function(t,r){var n=128,a=t*r,s=De.NearestPOT(a+n*n/(n+a));return Math.min(De.FloorPOT(t),s)},e.prototype._prepareRenderingManager=function(t,r,n,a){var s=this.getScene();if(!!s){this._renderingManager.reset();for(var o=s.getRenderId(),l=0;l<r;l++){var u=t[l];if(u&&!u.isBlocked){if(this.customIsReadyFunction){if(!this.customIsReadyFunction(u,this.refreshRate)){this.resetRefreshCounter();continue}}else if(!u.isReady(this.refreshRate===0)){this.resetRefreshCounter();continue}if(!u._internalAbstractMeshDataInfo._currentLODIsUpToDate&&s.activeCamera&&(u._internalAbstractMeshDataInfo._currentLOD=s.customLODSelector?s.customLODSelector(u,this.activeCamera||s.activeCamera):u.getLOD(this.activeCamera||s.activeCamera),u._internalAbstractMeshDataInfo._currentLODIsUpToDate=!0),!u._internalAbstractMeshDataInfo._currentLOD)continue;var f=u._internalAbstractMeshDataInfo._currentLOD;f._preActivateForIntermediateRendering(o);var h=void 0;if(a&&n?h=(u.layerMask&n.layerMask)===0:h=!1,u.isEnabled()&&u.isVisible&&u.subMeshes&&!h&&(f!==u&&f._activate(o,!0),u._activate(o,!0)&&u.subMeshes.length)){u.isAnInstance?u._internalAbstractMeshDataInfo._actAsRegularMesh&&(f=u):f._internalAbstractMeshDataInfo._onlyForInstancesIntermediate=!1,f._internalAbstractMeshDataInfo._isActiveIntermediate=!0;for(var c=0;c<f.subMeshes.length;c++){var d=f.subMeshes[c];this._renderingManager.dispatch(d,f)}}}}for(var p=0;p<s.particleSystems.length;p++){var _=s.particleSystems[p],g=_.emitter;!_.isStarted()||!g||!g.position||!g.isEnabled()||t.indexOf(g)>=0&&this._renderingManager.dispatchParticles(_)}}},e.prototype._bindFrameBuffer=function(t,r){t===void 0&&(t=0),r===void 0&&(r=0);var n=this.getScene();if(!!n){var a=n.getEngine();this._renderTarget&&a.bindFramebuffer(this._renderTarget,this.isCube?t:void 0,void 0,void 0,this.ignoreCameraViewport,0,r)}},e.prototype._unbindFrameBuffer=function(t,r){var n=this;!this._renderTarget||t.unBindFramebuffer(this._renderTarget,this.isCube,function(){n.onAfterRenderObservable.notifyObservers(r)})},e.prototype._prepareFrame=function(t,r,n,a){this._postProcessManager?this._prePassEnabled||this._postProcessManager._prepareFrame(this._texture,this._postProcesses):(!a||!t.postProcessManager._prepareFrame(this._texture))&&this._bindFrameBuffer(r,n)},e.prototype._renderToTarget=function(t,r,n,a,s){var o,l,u,f;a===void 0&&(a=0),s===void 0&&(s=null);var h=this.getScene();if(!!h){var c=h.getEngine();if(!!this._texture){(o=c._debugPushGroup)===null||o===void 0||o.call(c,"render to face #".concat(t," layer #").concat(a),1),this._prepareFrame(h,t,a,r),this.is2DArray?(c.currentRenderPassId=this._renderPassIds[a],this.onBeforeRenderObservable.notifyObservers(a)):(c.currentRenderPassId=this._renderPassIds[t],this.onBeforeRenderObservable.notifyObservers(t));var d=c.snapshotRendering&&c.snapshotRenderingMode===1;if(d)this.onClearObservable.hasObservers()?this.onClearObservable.notifyObservers(c):this.skipInitialClear||c.clear(this.clearColor||h.clearColor,!0,!0,!0);else{var p=null,_=this.renderList?this.renderList:h.getActiveMeshes().data,g=this.renderList?this.renderList.length:h.getActiveMeshes().length;this.getCustomRenderList&&(p=this.getCustomRenderList(this.is2DArray?a:t,_,g)),p?this._prepareRenderingManager(p,p.length,s,!1):(this._defaultRenderListPrepared||(this._prepareRenderingManager(_,g,s,!this.renderList),this._defaultRenderListPrepared=!0),p=_);for(var v=0,y=h._beforeRenderTargetClearStage;v<y.length;v++){var b=y[v];b.action(this,t,a)}this.onClearObservable.hasObservers()?this.onClearObservable.notifyObservers(c):this.skipInitialClear||c.clear(this.clearColor||h.clearColor,!0,!0,!0),this._doNotChangeAspectRatio||h.updateTransformMatrix(!0);for(var E=0,A=h._beforeRenderTargetDrawStage;E<A.length;E++){var b=A[E];b.action(this,t,a)}this._renderingManager.render(this.customRenderFunction,p,this.renderParticles,this.renderSprites);for(var S=0,T=h._afterRenderTargetDrawStage;S<T.length;S++){var b=T[S];b.action(this,t,a)}var M=this._texture.generateMipMaps;this._texture.generateMipMaps=!1,this._postProcessManager?this._postProcessManager._finalizeFrame(!1,(l=this._renderTarget)!==null&&l!==void 0?l:void 0,t,this._postProcesses,this.ignoreCameraViewport):r&&h.postProcessManager._finalizeFrame(!1,(u=this._renderTarget)!==null&&u!==void 0?u:void 0,t),this._texture.generateMipMaps=M,this._doNotChangeAspectRatio||h.updateTransformMatrix(!0),n&&te.DumpFramebuffer(this.getRenderWidth(),this.getRenderHeight(),c)}this._unbindFrameBuffer(c,t),this.isCube&&t===5&&c.generateMipMapsForCubemap(this._texture),(f=c._debugPopGroup)===null||f===void 0||f.call(c,1)}}},e.prototype.setRenderingOrder=function(t,r,n,a){r===void 0&&(r=null),n===void 0&&(n=null),a===void 0&&(a=null),this._renderingManager.setRenderingOrder(t,r,n,a)},e.prototype.setRenderingAutoClearDepthStencil=function(t,r){this._renderingManager.setRenderingAutoClearDepthStencil(t,r),this._renderingManager._useSceneAutoClearSetup=!1},e.prototype.clone=function(){var t=this.getSize(),r=new e(this.name,t,this.getScene(),this._renderTargetOptions.generateMipMaps,this._doNotChangeAspectRatio,this._renderTargetOptions.type,this.isCube,this._renderTargetOptions.samplingMode,this._renderTargetOptions.generateDepthBuffer,this._renderTargetOptions.generateStencilBuffer,void 0,this._renderTargetOptions.format,void 0,this._renderTargetOptions.samples);return r.hasAlpha=this.hasAlpha,r.level=this.level,r.coordinatesMode=this.coordinatesMode,this.renderList&&(r.renderList=this.renderList.slice(0)),r},e.prototype.serialize=function(){if(!this.name)return null;var t=i.prototype.serialize.call(this);if(t.renderTargetSize=this.getRenderSize(),t.renderList=[],this.renderList)for(var r=0;r<this.renderList.length;r++)t.renderList.push(this.renderList[r].id);return t},e.prototype.disposeFramebufferObjects=function(){var t;(t=this._renderTarget)===null||t===void 0||t.dispose(!0)},e.prototype.releaseInternalTexture=function(){var t;(t=this._renderTarget)===null||t===void 0||t.releaseTextures(),this._texture=null},e.prototype.dispose=function(){var t;this.onResizeObservable.clear(),this.onClearObservable.clear(),this.onAfterRenderObservable.clear(),this.onAfterUnbindObservable.clear(),this.onBeforeBindObservable.clear(),this.onBeforeRenderObservable.clear(),this._postProcessManager&&(this._postProcessManager.dispose(),this._postProcessManager=null),this._prePassRenderTarget&&this._prePassRenderTarget.dispose(),this._releaseRenderPassId(),this.clearPostProcesses(!0),this._resizeObserver&&(this.getScene().getEngine().onResizeObservable.remove(this._resizeObserver),this._resizeObserver=null),this.renderList=null;var r=this.getScene();if(!!r){var n=r.customRenderTargets.indexOf(this);n>=0&&r.customRenderTargets.splice(n,1);for(var a=0,s=r.cameras;a<s.length;a++){var o=s[a];n=o.customRenderTargets.indexOf(this),n>=0&&o.customRenderTargets.splice(n,1)}(t=this._renderTarget)===null||t===void 0||t.dispose(),this._renderTarget=null,this._texture=null,i.prototype.dispose.call(this)}},e.prototype._rebuild=function(){this.refreshRate===e.REFRESHRATE_RENDER_ONCE&&(this.refreshRate=e.REFRESHRATE_RENDER_ONCE),this._postProcessManager&&this._postProcessManager._rebuild()},e.prototype.freeRenderingGroups=function(){this._renderingManager&&this._renderingManager.freeRenderingGroups()},e.prototype.getViewCount=function(){return 1},e.REFRESHRATE_RENDER_ONCE=0,e.REFRESHRATE_RENDER_ONEVERYFRAME=1,e.REFRESHRATE_RENDER_ONEVERYTWOFRAMES=2,e}(re);re._CreateRenderTargetTexture=function(i,e,t,r,n){return new ur(i,e,t,r)};var St=function(){function i(e,t,r,n,a,s,o,l,u,f,h,c,d,p,_){o===void 0&&(o=1),f===void 0&&(f=null),h===void 0&&(h=0),c===void 0&&(c="postprocess"),p===void 0&&(p=!1),_===void 0&&(_=5),this._parentContainer=null,this.width=-1,this.height=-1,this.nodeMaterialSource=null,this._outputTexture=null,this.autoClear=!0,this.alphaMode=0,this.animations=new Array,this.enablePixelPerfectMode=!1,this.forceFullscreenViewport=!0,this.scaleMode=1,this.alwaysForcePOT=!1,this._samples=1,this.adaptScaleToCurrentViewport=!1,this._reusable=!1,this._renderId=0,this.externalTextureSamplerBinding=!1,this._textures=new Je(2),this._textureCache=[],this._currentRenderTextureInd=0,this._scaleRatio=new se(1,1),this._texelSize=se.Zero(),this.onActivateObservable=new X,this.onSizeChangedObservable=new X,this.onApplyObservable=new X,this.onBeforeRenderObservable=new X,this.onAfterRenderObservable=new X,this.name=e,s!=null?(this._camera=s,this._scene=s.getScene(),s.attachPostProcess(this),this._engine=this._scene.getEngine(),this._scene.postProcesses.push(this),this.uniqueId=this._scene.getUniqueId()):l&&(this._engine=l,this._engine.postProcesses.push(this)),this._options=a,this.renderTargetSamplingMode=o||1,this._reusable=u||!1,this._textureType=h,this._textureFormat=_,this._samplers=n||[],this._samplers.push("textureSampler"),this._fragmentUrl=t,this._vertexUrl=c,this._parameters=r||[],this._parameters.push("scale"),this._indexParameters=d,this._drawWrapper=new Bt(this._engine),p||this.updateEffect(f)}return Object.defineProperty(i.prototype,"samples",{get:function(){return this._samples},set:function(e){var t=this;this._samples=Math.min(e,this._engine.getCaps().maxMSAASamples),this._textures.forEach(function(r){r.samples!==t._samples&&t._engine.updateRenderTargetTextureSampleCount(r,t._samples)})},enumerable:!1,configurable:!0}),i.prototype.getEffectName=function(){return this._fragmentUrl},Object.defineProperty(i.prototype,"onActivate",{set:function(e){this._onActivateObserver&&this.onActivateObservable.remove(this._onActivateObserver),e&&(this._onActivateObserver=this.onActivateObservable.add(e))},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"onSizeChanged",{set:function(e){this._onSizeChangedObserver&&this.onSizeChangedObservable.remove(this._onSizeChangedObserver),this._onSizeChangedObserver=this.onSizeChangedObservable.add(e)},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"onApply",{set:function(e){this._onApplyObserver&&this.onApplyObservable.remove(this._onApplyObserver),this._onApplyObserver=this.onApplyObservable.add(e)},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"onBeforeRender",{set:function(e){this._onBeforeRenderObserver&&this.onBeforeRenderObservable.remove(this._onBeforeRenderObserver),this._onBeforeRenderObserver=this.onBeforeRenderObservable.add(e)},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"onAfterRender",{set:function(e){this._onAfterRenderObserver&&this.onAfterRenderObservable.remove(this._onAfterRenderObserver),this._onAfterRenderObserver=this.onAfterRenderObservable.add(e)},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"inputTexture",{get:function(){return this._textures.data[this._currentRenderTextureInd]},set:function(e){this._forcedOutputTexture=e},enumerable:!1,configurable:!0}),i.prototype.restoreDefaultInputTexture=function(){this._forcedOutputTexture&&(this._forcedOutputTexture=null,this.markTextureDirty())},i.prototype.getCamera=function(){return this._camera},Object.defineProperty(i.prototype,"texelSize",{get:function(){return this._shareOutputWithPostProcess?this._shareOutputWithPostProcess.texelSize:(this._forcedOutputTexture&&this._texelSize.copyFromFloats(1/this._forcedOutputTexture.width,1/this._forcedOutputTexture.height),this._texelSize)},enumerable:!1,configurable:!0}),i.prototype.getClassName=function(){return"PostProcess"},i.prototype.getEngine=function(){return this._engine},i.prototype.getEffect=function(){return this._drawWrapper.effect},i.prototype.shareOutputWith=function(e){return this._disposeTextures(),this._shareOutputWithPostProcess=e,this},i.prototype.useOwnOutput=function(){this._textures.length==0&&(this._textures=new Je(2)),this._shareOutputWithPostProcess=null},i.prototype.updateEffect=function(e,t,r,n,a,s,o,l){e===void 0&&(e=null),t===void 0&&(t=null),r===void 0&&(r=null),this._postProcessDefines=e,this._drawWrapper.effect=this._engine.createEffect({vertex:o!=null?o:this._vertexUrl,fragment:l!=null?l:this._fragmentUrl},["position"],t||this._parameters,r||this._samplers,e!==null?e:"",void 0,a,s,n||this._indexParameters)},i.prototype.isReusable=function(){return this._reusable},i.prototype.markTextureDirty=function(){this.width=-1},i.prototype._createRenderTargetTexture=function(e,t,r){r===void 0&&(r=0);for(var n=0;n<this._textureCache.length;n++)if(this._textureCache[n].texture.width===e.width&&this._textureCache[n].texture.height===e.height&&this._textureCache[n].postProcessChannel===r&&this._textureCache[n].texture._generateDepthBuffer===t.generateDepthBuffer)return this._textureCache[n].texture;var a=this._engine.createRenderTargetTexture(e,t);return this._textureCache.push({texture:a,postProcessChannel:r,lastUsedRenderId:-1}),a},i.prototype._flushTextureCache=function(){for(var e=this._renderId,t=this._textureCache.length-1;t>=0;t--)if(e-this._textureCache[t].lastUsedRenderId>100){for(var r=!1,n=0;n<this._textures.length;n++)if(this._textures.data[n]===this._textureCache[t].texture){r=!0;break}r||(this._textureCache[t].texture.dispose(),this._textureCache.splice(t,1))}},i.prototype._resize=function(e,t,r,n,a){this._textures.length>0&&this._textures.reset(),this.width=e,this.height=t;for(var s=null,o=0;o<r._postProcesses.length;o++)if(r._postProcesses[o]!==null){s=r._postProcesses[o];break}var l={width:this.width,height:this.height},u={generateMipMaps:n,generateDepthBuffer:a||s===this,generateStencilBuffer:(a||s===this)&&this._engine.isStencilEnable,samplingMode:this.renderTargetSamplingMode,type:this._textureType,format:this._textureFormat};this._textures.push(this._createRenderTargetTexture(l,u,0)),this._reusable&&this._textures.push(this._createRenderTargetTexture(l,u,1)),this._texelSize.copyFromFloats(1/this.width,1/this.height),this.onSizeChangedObservable.notifyObservers(this)},i.prototype.activate=function(e,t,r){var n=this,a,s;t===void 0&&(t=null),e=e||this._camera;var o=e.getScene(),l=o.getEngine(),u=l.getCaps().maxTextureSize,f=(t?t.width:this._engine.getRenderWidth(!0))*this._options|0,h=(t?t.height:this._engine.getRenderHeight(!0))*this._options|0,c=e.parent;c&&(c.leftCamera==e||c.rightCamera==e)&&(f/=2);var d=this._options.width||f,p=this._options.height||h,_=this.renderTargetSamplingMode!==7&&this.renderTargetSamplingMode!==1&&this.renderTargetSamplingMode!==2;if(!this._shareOutputWithPostProcess&&!this._forcedOutputTexture){if(this.adaptScaleToCurrentViewport){var g=l.currentViewport;g&&(d*=g.width,p*=g.height)}(_||this.alwaysForcePOT)&&(this._options.width||(d=l.needPOTTextures?De.GetExponentOfTwo(d,u,this.scaleMode):d),this._options.height||(p=l.needPOTTextures?De.GetExponentOfTwo(p,u,this.scaleMode):p)),(this.width!==d||this.height!==p)&&this._resize(d,p,e,_,r),this._textures.forEach(function(E){E.samples!==n.samples&&n._engine.updateRenderTargetTextureSampleCount(E,n.samples)}),this._flushTextureCache(),this._renderId++}var v;if(this._shareOutputWithPostProcess)v=this._shareOutputWithPostProcess.inputTexture;else if(this._forcedOutputTexture)v=this._forcedOutputTexture,this.width=this._forcedOutputTexture.width,this.height=this._forcedOutputTexture.height;else{v=this.inputTexture;for(var y=void 0,b=0;b<this._textureCache.length;b++)if(this._textureCache[b].texture===v){y=this._textureCache[b];break}y&&(y.lastUsedRenderId=this._renderId)}return this.enablePixelPerfectMode?(this._scaleRatio.copyFromFloats(f/d,h/p),this._engine.bindFramebuffer(v,0,f,h,this.forceFullscreenViewport)):(this._scaleRatio.copyFromFloats(1,1),this._engine.bindFramebuffer(v,0,void 0,void 0,this.forceFullscreenViewport)),(s=(a=this._engine)._debugInsertMarker)===null||s===void 0||s.call(a,"post process ".concat(this.name," input")),this.onActivateObservable.notifyObservers(e),this.autoClear&&this.alphaMode===0&&this._engine.clear(this.clearColor?this.clearColor:o.clearColor,o._allowPostProcessClearColor,!0,!0),this._reusable&&(this._currentRenderTextureInd=(this._currentRenderTextureInd+1)%2),v},Object.defineProperty(i.prototype,"isSupported",{get:function(){return this._drawWrapper.effect.isSupported},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"aspectRatio",{get:function(){return this._shareOutputWithPostProcess?this._shareOutputWithPostProcess.aspectRatio:this._forcedOutputTexture?this._forcedOutputTexture.width/this._forcedOutputTexture.height:this.width/this.height},enumerable:!1,configurable:!0}),i.prototype.isReady=function(){var e,t;return(t=(e=this._drawWrapper.effect)===null||e===void 0?void 0:e.isReady())!==null&&t!==void 0?t:!1},i.prototype.apply=function(){var e;if(!(!((e=this._drawWrapper.effect)===null||e===void 0)&&e.isReady()))return null;this._engine.enableEffect(this._drawWrapper),this._engine.setState(!1),this._engine.setDepthBuffer(!1),this._engine.setDepthWrite(!1),this._engine.setAlphaMode(this.alphaMode),this.alphaConstants&&this.getEngine().setAlphaConstants(this.alphaConstants.r,this.alphaConstants.g,this.alphaConstants.b,this.alphaConstants.a);var t;return this._shareOutputWithPostProcess?t=this._shareOutputWithPostProcess.inputTexture:this._forcedOutputTexture?t=this._forcedOutputTexture:t=this.inputTexture,this.externalTextureSamplerBinding||this._drawWrapper.effect._bindTexture("textureSampler",t==null?void 0:t.texture),this._drawWrapper.effect.setVector2("scale",this._scaleRatio),this.onApplyObservable.notifyObservers(this._drawWrapper.effect),this._drawWrapper.effect},i.prototype._disposeTextures=function(){if(this._shareOutputWithPostProcess||this._forcedOutputTexture){this._disposeTextureCache();return}this._disposeTextureCache(),this._textures.dispose()},i.prototype._disposeTextureCache=function(){for(var e=this._textureCache.length-1;e>=0;e--)this._textureCache[e].texture.dispose();this._textureCache.length=0},i.prototype.setPrePassRenderer=function(e){return this._prePassEffectConfiguration?(this._prePassEffectConfiguration=e.addEffectConfiguration(this._prePassEffectConfiguration),this._prePassEffectConfiguration.enabled=!0,!0):!1},i.prototype.dispose=function(e){e=e||this._camera,this._disposeTextures();var t;if(this._scene&&(t=this._scene.postProcesses.indexOf(this),t!==-1&&this._scene.postProcesses.splice(t,1)),this._parentContainer){var r=this._parentContainer.postProcesses.indexOf(this);r>-1&&this._parentContainer.postProcesses.splice(r,1),this._parentContainer=null}if(t=this._engine.postProcesses.indexOf(this),t!==-1&&this._engine.postProcesses.splice(t,1),!!e){if(e.detachPostProcess(this),t=e._postProcesses.indexOf(this),t===0&&e._postProcesses.length>0){var n=this._camera._getFirstPostProcess();n&&n.markTextureDirty()}this.onActivateObservable.clear(),this.onAfterRenderObservable.clear(),this.onApplyObservable.clear(),this.onBeforeRenderObservable.clear(),this.onSizeChangedObservable.clear()}},i.prototype.serialize=function(){var e=pe.Serialize(this),t=this.getCamera()||this._scene&&this._scene.activeCamera;return e.customType="BABYLON."+this.getClassName(),e.cameraId=t?t.id:null,e.reusable=this._reusable,e.textureType=this._textureType,e.fragmentUrl=this._fragmentUrl,e.parameters=this._parameters,e.samplers=this._samplers,e.options=this._options,e.defines=this._postProcessDefines,e.textureFormat=this._textureFormat,e.vertexUrl=this._vertexUrl,e.indexParameters=this._indexParameters,e},i.prototype.clone=function(){var e=this.serialize();e._engine=this._engine,e.cameraId=null;var t=i.Parse(e,this._scene,"");return t?(t.onActivateObservable=this.onActivateObservable.clone(),t.onSizeChangedObservable=this.onSizeChangedObservable.clone(),t.onApplyObservable=this.onApplyObservable.clone(),t.onBeforeRenderObservable=this.onBeforeRenderObservable.clone(),t.onAfterRenderObservable=this.onAfterRenderObservable.clone(),t._prePassEffectConfiguration=this._prePassEffectConfiguration,t):null},i.Parse=function(e,t,r){var n=lt(e.customType);if(!n||!n._Parse)return null;var a=t?t.getCameraById(e.cameraId):null;return n._Parse(e,a,t,r)},i._Parse=function(e,t,r,n){return pe.Parse(function(){return new i(e.name,e.fragmentUrl,e.parameters,e.samplers,e.options,t,e.renderTargetSamplingMode,e._engine,e.reusable,e.defines,e.textureType,e.vertexUrl,e.indexParameters,!1,e.textureFormat)},e,r,n)},C([I()],i.prototype,"uniqueId",void 0),C([I()],i.prototype,"name",void 0),C([I()],i.prototype,"width",void 0),C([I()],i.prototype,"height",void 0),C([I()],i.prototype,"renderTargetSamplingMode",void 0),C([Ca()],i.prototype,"clearColor",void 0),C([I()],i.prototype,"autoClear",void 0),C([I()],i.prototype,"alphaMode",void 0),C([I()],i.prototype,"alphaConstants",void 0),C([I()],i.prototype,"enablePixelPerfectMode",void 0),C([I()],i.prototype,"forceFullscreenViewport",void 0),C([I()],i.prototype,"scaleMode",void 0),C([I()],i.prototype,"alwaysForcePOT",void 0),C([I("samples")],i.prototype,"_samples",void 0),C([I()],i.prototype,"adaptScaleToCurrentViewport",void 0),i}();We("BABYLON.PostProcess",St);var Nh="passPixelShader",Bh=`varying vec2 vUV;
uniform sampler2D textureSampler;
#define CUSTOM_FRAGMENT_DEFINITIONS
void main(void) 
{
gl_FragColor=texture2D(textureSampler,vUV);
}`;q.ShadersStore[Nh]=Bh;var Uh="passCubePixelShader",Vh=`varying vec2 vUV;
uniform samplerCube textureSampler;
#define CUSTOM_FRAGMENT_DEFINITIONS
void main(void) 
{
vec2 uv=vUV*2.0-1.0;
#ifdef POSITIVEX
gl_FragColor=textureCube(textureSampler,vec3(1.001,uv.y,uv.x));
#endif
#ifdef NEGATIVEX
gl_FragColor=textureCube(textureSampler,vec3(-1.001,uv.y,uv.x));
#endif
#ifdef POSITIVEY
gl_FragColor=textureCube(textureSampler,vec3(uv.y,1.001,uv.x));
#endif
#ifdef NEGATIVEY
gl_FragColor=textureCube(textureSampler,vec3(uv.y,-1.001,uv.x));
#endif
#ifdef POSITIVEZ
gl_FragColor=textureCube(textureSampler,vec3(uv,1.001));
#endif
#ifdef NEGATIVEZ
gl_FragColor=textureCube(textureSampler,vec3(uv,-1.001));
#endif
}`;q.ShadersStore[Uh]=Vh;var Ws=function(i){$(e,i);function e(t,r,n,a,s,o,l,u){return n===void 0&&(n=null),l===void 0&&(l=0),u===void 0&&(u=!1),i.call(this,t,"pass",null,null,r,n,a,s,o,void 0,l,void 0,null,u)||this}return e.prototype.getClassName=function(){return"PassPostProcess"},e._Parse=function(t,r,n,a){return pe.Parse(function(){return new e(t.name,t.options,r,t.renderTargetSamplingMode,t._engine,t.reusable)},t,n,a)},e}(St);We("BABYLON.PassPostProcess",Ws);(function(i){$(e,i);function e(t,r,n,a,s,o,l,u){n===void 0&&(n=null),l===void 0&&(l=0),u===void 0&&(u=!1);var f=i.call(this,t,"passCube",null,null,r,n,a,s,o,"#define POSITIVEX",l,void 0,null,u)||this;return f._face=0,f}return Object.defineProperty(e.prototype,"face",{get:function(){return this._face},set:function(t){if(!(t<0||t>5))switch(this._face=t,this._face){case 0:this.updateEffect("#define POSITIVEX");break;case 1:this.updateEffect("#define NEGATIVEX");break;case 2:this.updateEffect("#define POSITIVEY");break;case 3:this.updateEffect("#define NEGATIVEY");break;case 4:this.updateEffect("#define POSITIVEZ");break;case 5:this.updateEffect("#define NEGATIVEZ");break}},enumerable:!1,configurable:!0}),e.prototype.getClassName=function(){return"PassCubePostProcess"},e._Parse=function(t,r,n,a){return pe.Parse(function(){return new e(t.name,t.options,r,t.renderTargetSamplingMode,t._engine,t.reusable)},t,n,a)},e})(St);De._RescalePostProcessFactory=function(i){return new Ws("rescale",1,null,2,i,!1,0)};function kh(i,e,t,r,n,a){var s=e.getEngine();return e.isReady=!1,n=n!=null?n:e.samplingMode,r=r!=null?r:e.type,a=a!=null?a:e.format,r===-1&&(r=0),new Promise(function(o){var l=new St("postprocess",i,null,null,1,null,n,s,!1,void 0,r,void 0,null,!1,a);l.externalTextureSamplerBinding=!0;var u=s.createRenderTargetTexture({width:e.width,height:e.height},{generateDepthBuffer:!1,generateMipMaps:!1,generateStencilBuffer:!1,samplingMode:n,type:r,format:a});l.getEffect().executeWhenCompiled(function(){l.onApply=function(f){f._bindTexture("textureSampler",e),f.setFloat2("scale",1,1)},t.postProcessManager.directRender([l],u,!0),s.restoreDefaultFramebuffer(),s._releaseTexture(e),l&&l.dispose(),u._swapAndDie(e),e.type=r,e.format=5,e.isReady=!0,o(e)})})}var Wr,Zn;function Ft(i){Wr||(Wr=new Float32Array(1),Zn=new Int32Array(Wr.buffer)),Wr[0]=i;var e=Zn[0],t=e>>16&32768,r=e>>12&2047,n=e>>23&255;return n<103?t:n>142?(t|=31744,t|=(n==255?0:1)&&e&8388607,t):n<113?(r|=2048,t|=(r>>114-n)+(r>>113-n&1),t):(t|=n-112<<10|r>>1,t+=r&1,t)}function Wt(i){var e=(i&32768)>>15,t=(i&31744)>>10,r=i&1023;return t===0?(e?-1:1)*Math.pow(2,-14)*(r/Math.pow(2,10)):t==31?r?NaN:(e?-1:1)*(1/0):(e?-1:1)*Math.pow(2,t-15)*(1+r/Math.pow(2,10))}ge.prototype.updateRawTexture=function(i,e,t,r,n,a){if(n===void 0&&(n=null),a===void 0&&(a=0),!!i){var s=this._getRGBABufferInternalSizedFormat(a,t),o=this._getInternalFormat(t),l=this._getWebGLTextureType(a);this._bindTextureDirectly(this._gl.TEXTURE_2D,i,!0),this._unpackFlipY(r===void 0?!0:!!r),this._doNotHandleContextLost||(i._bufferView=e,i.format=t,i.type=a,i.invertY=r,i._compression=n),i.width%4!==0&&this._gl.pixelStorei(this._gl.UNPACK_ALIGNMENT,1),n&&e?this._gl.compressedTexImage2D(this._gl.TEXTURE_2D,0,this.getCaps().s3tc[n],i.width,i.height,0,e):this._gl.texImage2D(this._gl.TEXTURE_2D,0,s,i.width,i.height,0,o,l,e),i.generateMipMaps&&this._gl.generateMipmap(this._gl.TEXTURE_2D),this._bindTextureDirectly(this._gl.TEXTURE_2D,null),i.isReady=!0}};ge.prototype.createRawTexture=function(i,e,t,r,n,a,s,o,l,u){o===void 0&&(o=null),l===void 0&&(l=0);var f=new at(this,Ie.Raw);f.baseWidth=e,f.baseHeight=t,f.width=e,f.height=t,f.format=r,f.generateMipMaps=n,f.samplingMode=s,f.invertY=a,f._compression=o,f.type=l,this._doNotHandleContextLost||(f._bufferView=i),this.updateRawTexture(f,i,r,a,o,l),this._bindTextureDirectly(this._gl.TEXTURE_2D,f,!0);var h=this._getSamplingParameters(s,n);return this._gl.texParameteri(this._gl.TEXTURE_2D,this._gl.TEXTURE_MAG_FILTER,h.mag),this._gl.texParameteri(this._gl.TEXTURE_2D,this._gl.TEXTURE_MIN_FILTER,h.min),n&&this._gl.generateMipmap(this._gl.TEXTURE_2D),this._bindTextureDirectly(this._gl.TEXTURE_2D,null),this._internalTexturesCache.push(f),f};ge.prototype.createRawCubeTexture=function(i,e,t,r,n,a,s,o){o===void 0&&(o=null);var l=this._gl,u=new at(this,Ie.CubeRaw);u.isCube=!0,u.format=t,u.type=r,this._doNotHandleContextLost||(u._bufferViewArray=i);var f=this._getWebGLTextureType(r),h=this._getInternalFormat(t);h===l.RGB&&(h=l.RGBA),f===l.FLOAT&&!this._caps.textureFloatLinearFiltering?(n=!1,s=1,Y.Warn("Float texture filtering is not supported. Mipmap generation and sampling mode are forced to false and TEXTURE_NEAREST_SAMPLINGMODE, respectively.")):f===this._gl.HALF_FLOAT_OES&&!this._caps.textureHalfFloatLinearFiltering?(n=!1,s=1,Y.Warn("Half float texture filtering is not supported. Mipmap generation and sampling mode are forced to false and TEXTURE_NEAREST_SAMPLINGMODE, respectively.")):f===l.FLOAT&&!this._caps.textureFloatRender?(n=!1,Y.Warn("Render to float textures is not supported. Mipmap generation forced to false.")):f===l.HALF_FLOAT&&!this._caps.colorBufferFloat&&(n=!1,Y.Warn("Render to half float textures is not supported. Mipmap generation forced to false."));var c=e,d=c;u.width=c,u.height=d;var p=!this.needPOTTextures||te.IsExponentOfTwo(u.width)&&te.IsExponentOfTwo(u.height);p||(n=!1),i&&this.updateRawCubeTexture(u,i,t,r,a,o),this._bindTextureDirectly(this._gl.TEXTURE_CUBE_MAP,u,!0),i&&n&&this._gl.generateMipmap(this._gl.TEXTURE_CUBE_MAP);var _=this._getSamplingParameters(s,n);return l.texParameteri(l.TEXTURE_CUBE_MAP,l.TEXTURE_MAG_FILTER,_.mag),l.texParameteri(l.TEXTURE_CUBE_MAP,l.TEXTURE_MIN_FILTER,_.min),l.texParameteri(l.TEXTURE_CUBE_MAP,l.TEXTURE_WRAP_S,l.CLAMP_TO_EDGE),l.texParameteri(l.TEXTURE_CUBE_MAP,l.TEXTURE_WRAP_T,l.CLAMP_TO_EDGE),this._bindTextureDirectly(l.TEXTURE_CUBE_MAP,null),u.generateMipMaps=n,u.samplingMode=s,u};ge.prototype.updateRawCubeTexture=function(i,e,t,r,n,a,s){a===void 0&&(a=null),s===void 0&&(s=0),i._bufferViewArray=e,i.format=t,i.type=r,i.invertY=n,i._compression=a;var o=this._gl,l=this._getWebGLTextureType(r),u=this._getInternalFormat(t),f=this._getRGBABufferInternalSizedFormat(r),h=!1;u===o.RGB&&(u=o.RGBA,h=!0),this._bindTextureDirectly(o.TEXTURE_CUBE_MAP,i,!0),this._unpackFlipY(n===void 0?!0:!!n),i.width%4!==0&&o.pixelStorei(o.UNPACK_ALIGNMENT,1);for(var c=0;c<6;c++){var d=e[c];a?o.compressedTexImage2D(o.TEXTURE_CUBE_MAP_POSITIVE_X+c,s,this.getCaps().s3tc[a],i.width,i.height,0,d):(h&&(d=Hs(d,i.width,i.height,r)),o.texImage2D(o.TEXTURE_CUBE_MAP_POSITIVE_X+c,s,f,i.width,i.height,0,u,l,d))}var p=!this.needPOTTextures||te.IsExponentOfTwo(i.width)&&te.IsExponentOfTwo(i.height);p&&i.generateMipMaps&&s===0&&this._gl.generateMipmap(this._gl.TEXTURE_CUBE_MAP),this._bindTextureDirectly(this._gl.TEXTURE_CUBE_MAP,null),i.isReady=!0};ge.prototype.createRawCubeTextureFromUrl=function(i,e,t,r,n,a,s,o,l,u,f,h){var c=this;l===void 0&&(l=null),u===void 0&&(u=null),f===void 0&&(f=3),h===void 0&&(h=!1);var d=this._gl,p=this.createRawCubeTexture(null,t,r,n,!a,h,f,null);e==null||e._addPendingData(p),p.url=i,this._internalTexturesCache.push(p);var _=function(v,y){e==null||e._removePendingData(p),u&&v&&u(v.status+" "+v.statusText,y)},g=function(v){var y=p.width,b=s(v);if(!!b){if(o){var E=c._getWebGLTextureType(n),A=c._getInternalFormat(r),S=c._getRGBABufferInternalSizedFormat(n),T=!1;A===d.RGB&&(A=d.RGBA,T=!0),c._bindTextureDirectly(d.TEXTURE_CUBE_MAP,p,!0),c._unpackFlipY(!1);for(var M=o(b),D=0;D<M.length;D++)for(var x=y>>D,P=0;P<6;P++){var w=M[D][P];T&&(w=Hs(w,x,x,n)),d.texImage2D(P,D,S,x,x,0,A,E,w)}c._bindTextureDirectly(d.TEXTURE_CUBE_MAP,null)}else c.updateRawCubeTexture(p,b,r,n,h);p.isReady=!0,e==null||e._removePendingData(p),l&&l()}};return this._loadFile(i,function(v){g(v)},void 0,e==null?void 0:e.offlineProvider,!0,_),p};function Hs(i,e,t,r){var n,a=1;r===1?n=new Float32Array(e*t*4):r===2?(n=new Uint16Array(e*t*4),a=15360):r===7?n=new Uint32Array(e*t*4):n=new Uint8Array(e*t*4);for(var s=0;s<e;s++)for(var o=0;o<t;o++){var l=(o*e+s)*3,u=(o*e+s)*4;n[u+0]=i[l+0],n[u+1]=i[l+1],n[u+2]=i[l+2],n[u+3]=a}return n}function Xs(i){return function(e,t,r,n,a,s,o,l,u,f){u===void 0&&(u=null),f===void 0&&(f=0);var h=i?this._gl.TEXTURE_3D:this._gl.TEXTURE_2D_ARRAY,c=i?Ie.Raw3D:Ie.Raw2DArray,d=new at(this,c);d.baseWidth=t,d.baseHeight=r,d.baseDepth=n,d.width=t,d.height=r,d.depth=n,d.format=a,d.type=f,d.generateMipMaps=s,d.samplingMode=l,i?d.is3D=!0:d.is2DArray=!0,this._doNotHandleContextLost||(d._bufferView=e),i?this.updateRawTexture3D(d,e,a,o,u,f):this.updateRawTexture2DArray(d,e,a,o,u,f),this._bindTextureDirectly(h,d,!0);var p=this._getSamplingParameters(l,s);return this._gl.texParameteri(h,this._gl.TEXTURE_MAG_FILTER,p.mag),this._gl.texParameteri(h,this._gl.TEXTURE_MIN_FILTER,p.min),s&&this._gl.generateMipmap(h),this._bindTextureDirectly(h,null),this._internalTexturesCache.push(d),d}}ge.prototype.createRawTexture2DArray=Xs(!1);ge.prototype.createRawTexture3D=Xs(!0);function js(i){return function(e,t,r,n,a,s){a===void 0&&(a=null),s===void 0&&(s=0);var o=i?this._gl.TEXTURE_3D:this._gl.TEXTURE_2D_ARRAY,l=this._getWebGLTextureType(s),u=this._getInternalFormat(r),f=this._getRGBABufferInternalSizedFormat(s,r);this._bindTextureDirectly(o,e,!0),this._unpackFlipY(n===void 0?!0:!!n),this._doNotHandleContextLost||(e._bufferView=t,e.format=r,e.invertY=n,e._compression=a),e.width%4!==0&&this._gl.pixelStorei(this._gl.UNPACK_ALIGNMENT,1),a&&t?this._gl.compressedTexImage3D(o,0,this.getCaps().s3tc[a],e.width,e.height,e.depth,0,t):this._gl.texImage3D(o,0,f,e.width,e.height,e.depth,0,u,l,t),e.generateMipMaps&&this._gl.generateMipmap(o),this._bindTextureDirectly(o,null),e.isReady=!0}}ge.prototype.updateRawTexture2DArray=js(!1);ge.prototype.updateRawTexture3D=js(!0);bt.prototype.forceSphericalPolynomialsRecompute=function(){this._texture&&(this._texture._sphericalPolynomial=null,this._texture._sphericalPolynomialPromise=null,this._texture._sphericalPolynomialComputed=!1)};Object.defineProperty(bt.prototype,"sphericalPolynomial",{get:function(){var i=this;if(this._texture){if(this._texture._sphericalPolynomial||this._texture._sphericalPolynomialComputed)return this._texture._sphericalPolynomial;if(this._texture.isReady)return this._texture._sphericalPolynomialPromise||(this._texture._sphericalPolynomialPromise=vn.ConvertCubeMapTextureToSphericalPolynomial(this),this._texture._sphericalPolynomialPromise===null?this._texture._sphericalPolynomialComputed=!0:this._texture._sphericalPolynomialPromise.then(function(e){i._texture._sphericalPolynomial=e,i._texture._sphericalPolynomialComputed=!0})),null}return null},set:function(i){this._texture&&(this._texture._sphericalPolynomial=i)},enumerable:!0,configurable:!0});var Ks=function(i){$(e,i);function e(t,r,n,a,s,o,l,u,f){a===void 0&&(a=!1),s===void 0&&(s=!0),o===void 0&&(o=!1),l===void 0&&(l=!1),u===void 0&&(u=null),f===void 0&&(f=null);var h=this,c;return h=i.call(this,r)||this,h._generateHarmonics=!0,h._onError=null,h._isBlocking=!0,h._rotationY=0,h.boundingBoxPosition=m.Zero(),h.onLoadObservable=new X,t&&(h._coordinatesMode=re.CUBIC_MODE,h.name=t,h.url=t,h.hasAlpha=!1,h.isCube=!0,h._textureMatrix=G.Identity(),h._prefilterOnLoad=l,h._onLoad=function(){h.onLoadObservable.notifyObservers(h),u&&u()},h._onError=f,h.gammaSpace=o,h._noMipmap=a,h._size=n,h._generateHarmonics=s,h._texture=h._getFromCache(t,h._noMipmap),h._texture?h._texture.isReady?te.SetImmediate(function(){return h._onLoad()}):h._texture.onLoadedObservable.add(h._onLoad):!((c=h.getScene())===null||c===void 0)&&c.useDelayedTextureLoading?h.delayLoadState=4:h._loadTexture()),h}return Object.defineProperty(e.prototype,"isBlocking",{get:function(){return this._isBlocking},set:function(t){this._isBlocking=t},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"rotationY",{get:function(){return this._rotationY},set:function(t){this._rotationY=t,this.setReflectionTextureMatrix(G.RotationY(this._rotationY))},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"boundingBoxSize",{get:function(){return this._boundingBoxSize},set:function(t){if(!(this._boundingBoxSize&&this._boundingBoxSize.equals(t))){this._boundingBoxSize=t;var r=this.getScene();r&&r.markAllMaterialsAsDirty(1)}},enumerable:!1,configurable:!0}),e.prototype.getClassName=function(){return"HDRCubeTexture"},e.prototype._loadTexture=function(){var t=this,r=this._getEngine(),n=r.getCaps(),a=0;n.textureFloat&&n.textureFloatLinearFiltering?a=1:n.textureHalfFloat&&n.textureHalfFloatLinearFiltering&&(a=2);var s=function(u){t.lodGenerationOffset=0,t.lodGenerationScale=.8;var f=Wi.GetCubeMapTextureData(u,t._size);if(t._generateHarmonics){var h=vn.ConvertCubeMapToSphericalPolynomial(f);t.sphericalPolynomial=h}for(var c=[],d=null,p=null,_=0;_<6;_++){a===2?p=new Uint16Array(t._size*t._size*3):a===0&&(d=new Uint8Array(t._size*t._size*3));var g=f[e._FacesMapping[_]];if(t.gammaSpace||p||d){for(var v=0;v<t._size*t._size;v++)if(t.gammaSpace&&(g[v*3+0]=Math.pow(g[v*3+0],Lt),g[v*3+1]=Math.pow(g[v*3+1],Lt),g[v*3+2]=Math.pow(g[v*3+2],Lt)),p&&(p[v*3+0]=Ft(g[v*3+0]),p[v*3+1]=Ft(g[v*3+1]),p[v*3+2]=Ft(g[v*3+2])),d){var y=Math.max(g[v*3+0]*255,0),b=Math.max(g[v*3+1]*255,0),E=Math.max(g[v*3+2]*255,0),A=Math.max(Math.max(y,b),E);if(A>255){var S=255/A;y*=S,b*=S,E*=S}d[v*3+0]=y,d[v*3+1]=b,d[v*3+2]=E}}p?c.push(p):d?c.push(d):c.push(g)}return c};if(r._features.allowTexturePrefiltering&&this._prefilterOnLoad){var o=this._onLoad,l=new Fh(r);this._onLoad=function(){l.prefilter(t,o)}}this._texture=r.createRawCubeTextureFromUrl(this.url,this.getScene(),this._size,4,a,this._noMipmap,s,null,this._onLoad,this._onError)},e.prototype.clone=function(){var t=new e(this.url,this.getScene()||this._getEngine(),this._size,this._noMipmap,this._generateHarmonics,this.gammaSpace);return t.level=this.level,t.wrapU=this.wrapU,t.wrapV=this.wrapV,t.coordinatesIndex=this.coordinatesIndex,t.coordinatesMode=this.coordinatesMode,t},e.prototype.delayLoad=function(){this.delayLoadState===4&&(this.delayLoadState=1,this._texture=this._getFromCache(this.url,this._noMipmap),this._texture||this._loadTexture())},e.prototype.getReflectionTextureMatrix=function(){return this._textureMatrix},e.prototype.setReflectionTextureMatrix=function(t){var r=this,n;this._textureMatrix=t,t.updateFlag!==this._textureMatrix.updateFlag&&t.isIdentity()!==this._textureMatrix.isIdentity()&&((n=this.getScene())===null||n===void 0||n.markAllMaterialsAsDirty(1,function(a){return a.getActiveTextures().indexOf(r)!==-1}))},e.prototype.dispose=function(){this.onLoadObservable.clear(),i.prototype.dispose.call(this)},e.Parse=function(t,r,n){var a=null;return t.name&&!t.isRenderTarget&&(a=new e(n+t.name,r,t.size,t.noMipmap,t.generateHarmonics,t.useInGammaSpace),a.name=t.name,a.hasAlpha=t.hasAlpha,a.level=t.level,a.coordinatesMode=t.coordinatesMode,a.isBlocking=t.isBlocking),a&&(t.boundingBoxPosition&&(a.boundingBoxPosition=m.FromArray(t.boundingBoxPosition)),t.boundingBoxSize&&(a.boundingBoxSize=m.FromArray(t.boundingBoxSize)),t.rotationY&&(a.rotationY=t.rotationY)),a},e.prototype.serialize=function(){if(!this.name)return null;var t={};return t.name=this.name,t.hasAlpha=this.hasAlpha,t.isCube=!0,t.level=this.level,t.size=this._size,t.coordinatesMode=this.coordinatesMode,t.useInGammaSpace=this.gammaSpace,t.generateHarmonics=this._generateHarmonics,t.customType="BABYLON.HDRCubeTexture",t.noMipmap=this._noMipmap,t.isBlocking=this._isBlocking,t.rotationY=this._rotationY,t},e._FacesMapping=["right","left","up","down","front","back"],e}(bt);We("BABYLON.HDRCubeTexture",Ks);var Gh=function(i){$(e,i);function e(t,r,n,a,s,o,l){a===void 0&&(a=!1),s===void 0&&(s=!0),o===void 0&&(o=null),l===void 0&&(l=null);var u=i.call(this,r)||this;if(u._onLoad=null,u._onError=null,!t)throw new Error("Image url is not set");return u._coordinatesMode=re.CUBIC_MODE,u.name=t,u.url=t,u._size=n,u._noMipmap=a,u.gammaSpace=s,u._onLoad=o,u._onError=l,u.hasAlpha=!1,u.isCube=!0,u._texture=u._getFromCache(t,u._noMipmap),u._texture?o&&(u._texture.isReady?te.SetImmediate(function(){return o()}):u._texture.onLoadedObservable.add(o)):r.useDelayedTextureLoading?u.delayLoadState=4:u._loadImage(u._loadTexture.bind(u),u._onError),u}return e.prototype._loadImage=function(t,r){var n=this,a=document.createElement("canvas");Vr(this.url,function(s){n._width=s.width,n._height=s.height,a.width=n._width,a.height=n._height;var o=a.getContext("2d");o.drawImage(s,0,0);var l=o.getImageData(0,0,s.width,s.height);n._buffer=l.data.buffer,a.remove(),t()},function(s,o){r&&r("".concat(n.getClassName()," could not be loaded"),o)},null)},e.prototype._loadTexture=function(){var t=this,r=this.getScene(),n=function(){for(var a=t._getFloat32ArrayFromArrayBuffer(t._buffer),s=Gs.ConvertPanoramaToCubemap(a,t._width,t._height,t._size),o=[],l=0;l<6;l++){var u=s[e._FacesMapping[l]];o.push(u)}return o};!r||(this._texture=r.getEngine().createRawCubeTextureFromUrl(this.url,r,this._size,4,r.getEngine().getCaps().textureFloat?1:7,this._noMipmap,n,null,this._onLoad,this._onError))},e.prototype._getFloat32ArrayFromArrayBuffer=function(t){for(var r=new DataView(t),n=new Float32Array(t.byteLength*3/4),a=0,s=0;s<t.byteLength;s++)(s+1)%4!==0&&(n[a++]=r.getUint8(s)/255);return n},e.prototype.getClassName=function(){return"EquiRectangularCubeTexture"},e.prototype.clone=function(){var t=this.getScene();if(!t)return this;var r=new e(this.url,t,this._size,this._noMipmap,this.gammaSpace);return r.level=this.level,r.wrapU=this.wrapU,r.wrapV=this.wrapV,r.coordinatesIndex=this.coordinatesIndex,r.coordinatesMode=this.coordinatesMode,r},e._FacesMapping=["right","left","up","down","front","back"],e}(bt),nr;(function(i){i[i.INIT=0]="INIT",i[i.RUNNING=1]="RUNNING",i[i.DONE=2]="DONE",i[i.ERROR=3]="ERROR"})(nr||(nr={}));var Vt=function(){function i(e){this.name=e,this._isCompleted=!1,this._taskState=nr.INIT}return Object.defineProperty(i.prototype,"isCompleted",{get:function(){return this._isCompleted},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"taskState",{get:function(){return this._taskState},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"errorObject",{get:function(){return this._errorObject},enumerable:!1,configurable:!0}),i.prototype._setErrorObject=function(e,t){this._errorObject||(this._errorObject={message:e,exception:t})},i.prototype.run=function(e,t,r){var n=this;this._taskState=nr.RUNNING,this.runTask(e,function(){n._onDoneCallback(t,r)},function(a,s){n._onErrorCallback(r,a,s)})},i.prototype.runTask=function(e,t,r){throw new Error("runTask is not implemented")},i.prototype.reset=function(){this._taskState=nr.INIT},i.prototype._onErrorCallback=function(e,t,r){this._taskState=nr.ERROR,this._errorObject={message:t,exception:r},this.onError&&this.onError(this,t,r),e()},i.prototype._onDoneCallback=function(e,t){try{this._taskState=nr.DONE,this._isCompleted=!0,this.onSuccess&&this.onSuccess(this),e()}catch(r){this._onErrorCallback(t,"Task is done, error executing success callback(s)",r)}},i}();(function(i){$(e,i);function e(t,r,n,a){var s=i.call(this,t)||this;return s.name=t,s.meshesNames=r,s.rootUrl=n,s.sceneFilename=a,s}return e.prototype.runTask=function(t,r,n){var a=this;Cr.LoadAssetContainer(this.rootUrl,this.sceneFilename,t,function(s){a.loadedContainer=s,a.loadedMeshes=s.meshes,a.loadedParticleSystems=s.particleSystems,a.loadedSkeletons=s.skeletons,a.loadedAnimationGroups=s.animationGroups,r()},null,function(s,o,l){n(o,l)})},e})(Vt);(function(i){$(e,i);function e(t,r,n,a){var s=i.call(this,t)||this;return s.name=t,s.meshesNames=r,s.rootUrl=n,s.sceneFilename=a,s}return e.prototype.runTask=function(t,r,n){var a=this;Cr.ImportMesh(this.meshesNames,this.rootUrl,this.sceneFilename,t,function(s,o,l,u){a.loadedMeshes=s,a.loadedParticleSystems=o,a.loadedSkeletons=l,a.loadedAnimationGroups=u,r()},null,function(s,o,l){n(o,l)})},e})(Vt);(function(i){$(e,i);function e(t,r){var n=i.call(this,t)||this;return n.name=t,n.url=r,n}return e.prototype.runTask=function(t,r,n){var a=this;t._loadFile(this.url,function(s){a.text=s,r()},void 0,!1,!1,function(s,o){s&&n(s.status+" "+s.statusText,o)})},e})(Vt);(function(i){$(e,i);function e(t,r){var n=i.call(this,t)||this;return n.name=t,n.url=r,n}return e.prototype.runTask=function(t,r,n){var a=this;t._loadFile(this.url,function(s){a.data=s,r()},void 0,!0,!0,function(s,o){s&&n(s.status+" "+s.statusText,o)})},e})(Vt);(function(i){$(e,i);function e(t,r){var n=i.call(this,t)||this;return n.name=t,n.url=r,n}return e.prototype.runTask=function(t,r,n){var a=this,s=new Image;te.SetCorsBehavior(this.url,s),s.onload=function(){a.image=s,r()},s.onerror=function(o){n("Error loading image",o)},s.src=this.url},e})(Vt);(function(i){$(e,i);function e(t,r,n,a,s){a===void 0&&(a=!0),s===void 0&&(s=re.TRILINEAR_SAMPLINGMODE);var o=i.call(this,t)||this;return o.name=t,o.url=r,o.noMipmap=n,o.invertY=a,o.samplingMode=s,o}return e.prototype.runTask=function(t,r,n){var a=function(){r()},s=function(o,l){n(o,l)};this.texture=new re(this.url,t,this.noMipmap,this.invertY,this.samplingMode,a,s)},e})(Vt);(function(i){$(e,i);function e(t,r,n,a,s,o){var l=i.call(this,t)||this;return l.name=t,l.url=r,l.extensions=n,l.noMipmap=a,l.files=s,l.prefiltered=o,l}return e.prototype.runTask=function(t,r,n){var a=function(){r()},s=function(o,l){n(o,l)};this.texture=new Lr(this.url,t,this.extensions,this.noMipmap,this.files,a,s,void 0,this.prefiltered)},e})(Vt);(function(i){$(e,i);function e(t,r,n,a,s,o,l){a===void 0&&(a=!1),s===void 0&&(s=!0),o===void 0&&(o=!1),l===void 0&&(l=!1);var u=i.call(this,t)||this;return u.name=t,u.url=r,u.size=n,u.noMipmap=a,u.generateHarmonics=s,u.gammaSpace=o,u.reserved=l,u}return e.prototype.runTask=function(t,r,n){var a=function(){r()},s=function(o,l){n(o,l)};this.texture=new Ks(this.url,t,this.size,this.noMipmap,this.generateHarmonics,this.gammaSpace,this.reserved,a,s)},e})(Vt);(function(i){$(e,i);function e(t,r,n,a,s){a===void 0&&(a=!1),s===void 0&&(s=!0);var o=i.call(this,t)||this;return o.name=t,o.url=r,o.size=n,o.noMipmap=a,o.gammaSpace=s,o}return e.prototype.runTask=function(t,r,n){var a=function(){r()},s=function(o,l){n(o,l)};this.texture=new Gh(this.url,t,this.size,this.noMipmap,this.gammaSpace,a,s)},e})(Vt);var xr;(function(i){i[i.cTFETC1=0]="cTFETC1",i[i.cTFBC1=1]="cTFBC1",i[i.cTFBC4=2]="cTFBC4",i[i.cTFPVRTC1_4_OPAQUE_ONLY=3]="cTFPVRTC1_4_OPAQUE_ONLY",i[i.cTFBC7_M6_OPAQUE_ONLY=4]="cTFBC7_M6_OPAQUE_ONLY",i[i.cTFETC2=5]="cTFETC2",i[i.cTFBC3=6]="cTFBC3",i[i.cTFBC5=7]="cTFBC5"})(xr||(xr={}));var er={JSModuleURL:"https://preview.babylonjs.com/basisTranscoder/basis_transcoder.js",WasmModuleURL:"https://preview.babylonjs.com/basisTranscoder/basis_transcoder.wasm"},zh=function(i,e){var t;switch(i){case xr.cTFETC1:t=36196;break;case xr.cTFBC1:t=33776;break;case xr.cTFBC4:t=33779;break}if(t===void 0)throw"The chosen Basis transcoder format is not currently supported";return t},bi=null,Ct=null,Wh=0,Hh=!1,Xh=function(){return bi||(bi=new Promise(function(i,e){Ct?i(Ct):te.LoadFileAsync(er.WasmModuleURL).then(function(t){var r=URL.createObjectURL(new Blob(["(".concat(jh,")()")],{type:"application/javascript"}));Ct=new Worker(r);var n=function(a){a.data.action==="init"?(Ct.removeEventListener("message",n),i(Ct)):a.data.action==="error"&&e(a.data.error||"error initializing worker")};Ct.addEventListener("message",n),Ct.postMessage({action:"init",url:er.JSModuleURL,wasmBinary:t})}).catch(e)})),bi},Hi=function(i,e){var t=i instanceof ArrayBuffer?new Uint8Array(i):i;return new Promise(function(r,n){Xh().then(function(){var a=Wh++,s=function(l){l.data.action==="transcode"&&l.data.id===a&&(Ct.removeEventListener("message",s),l.data.success?r(l.data):n("Transcode is not supported on this device"))};Ct.addEventListener("message",s);var o=new Uint8Array(t.byteLength);o.set(new Uint8Array(t.buffer,t.byteOffset,t.byteLength)),Ct.postMessage({action:"transcode",id:a,imageData:o,config:e,ignoreSupportedFormats:Hh},[o.buffer])},function(a){n(a)})})},Xi=function(i,e){for(var t=i.getEngine(),r=function(a){var s=e.fileInfo.images[a].levels[0];if(i._invertVScale=i.invertY,e.format===-1)if(i.type=10,i.format=4,t._features.basisNeedsPOT&&(K.Log2(s.width)%1!==0||K.Log2(s.height)%1!==0)){var o=new at(t,Ie.Temp);i._invertVScale=i.invertY,o.type=10,o.format=4,o.width=s.width+3&-4,o.height=s.height+3&-4,t._bindTextureDirectly(t._gl.TEXTURE_2D,o,!0),t._uploadDataToTextureDirectly(o,s.transcodedPixels,a,0,4,!0),t._rescaleTexture(o,i,t.scenes[0],t._getInternalFormat(4),function(){t._releaseTexture(o),t._bindTextureDirectly(t._gl.TEXTURE_2D,i,!0)})}else i._invertVScale=!i.invertY,i.width=s.width+3&-4,i.height=s.height+3&-4,t._uploadDataToTextureDirectly(i,s.transcodedPixels,a,0,4,!0);else i.width=s.width,i.height=s.height,i.generateMipMaps=e.fileInfo.images[a].levels.length>1,e.fileInfo.images[a].levels.forEach(function(l,u){t._uploadCompressedDataToTextureDirectly(i,gn.GetInternalFormatFromBasisFormat(e.format,t),l.width,l.height,l.transcodedPixels,a,u)}),t._features.basisNeedsPOT&&(K.Log2(i.width)%1!==0||K.Log2(i.height)%1!==0)&&(te.Warn("Loaded .basis texture width and height are not a power of two. Texture wrapping will be set to Texture.CLAMP_ADDRESSMODE as other modes are not supported with non power of two dimensions in webGL 1."),i._cachedWrapU=re.CLAMP_ADDRESSMODE,i._cachedWrapV=re.CLAMP_ADDRESSMODE)},n=0;n<e.fileInfo.images.length;n++)r(n)},gn={JSModuleURL:er.JSModuleURL,WasmModuleURL:er.WasmModuleURL,GetInternalFormatFromBasisFormat:zh,TranscodeAsync:Hi,LoadTextureFromTranscodeResult:Xi};function jh(){var i={cTFETC1:0,cTFBC1:1,cTFBC4:2,cTFPVRTC1_4_OPAQUE_ONLY:3,cTFBC7_M6_OPAQUE_ONLY:4,cTFETC2:5,cTFBC3:6,cTFBC5:7},e=null;onmessage=function(s){if(s.data.action==="init"){if(!e){Module={wasmBinary:s.data.wasmBinary};try{importScripts(s.data.url)}catch(A){postMessage({action:"error",error:A})}e=new Promise(function(A){Module.onRuntimeInitialized=function(){Module.initializeBasis(),A()}})}e.then(function(){postMessage({action:"init"})})}else if(s.data.action==="transcode"){var o=s.data.config,l=s.data.imageData,u=new Module.BasisFile(l),f=r(u),h=s.data.ignoreSupportedFormats?null:t(s.data.config,f),c=!1;h===null&&(c=!0,h=f.hasAlpha?i.cTFBC3:i.cTFBC1);var d=!0;u.startTranscoding()||(d=!1);for(var p=[],_=0;_<f.images.length&&d;_++){var g=f.images[_];if(o.loadSingleImage===void 0||o.loadSingleImage===_){var v=g.levels.length;o.loadMipmapLevels===!1&&(v=1);for(var y=0;y<v;y++){var b=g.levels[y],E=n(u,_,y,h,c);if(!E){d=!1;break}b.transcodedPixels=E,p.push(b.transcodedPixels.buffer)}}}u.close(),u.delete(),c&&(h=-1),d?postMessage({action:"transcode",success:d,id:s.data.id,fileInfo:f,format:h},p):postMessage({action:"transcode",success:d,id:s.data.id})}};function t(s,o){var l=null;return s.supportedCompressionFormats&&(s.supportedCompressionFormats.etc1?l=i.cTFETC1:s.supportedCompressionFormats.s3tc?l=o.hasAlpha?i.cTFBC3:i.cTFBC1:s.supportedCompressionFormats.pvrtc||s.supportedCompressionFormats.etc2&&(l=i.cTFETC2)),l}function r(s){for(var o=s.getHasAlpha(),l=s.getNumImages(),u=[],f=0;f<l;f++){for(var h={levels:[]},c=s.getNumLevels(f),d=0;d<c;d++){var p={width:s.getImageWidth(f,d),height:s.getImageHeight(f,d)};h.levels.push(p)}u.push(h)}var _={hasAlpha:o,images:u};return _}function n(s,o,l,u,f){var h=s.getImageTranscodedSizeInBytes(o,l,u),c=new Uint8Array(h);if(!s.transcodeImage(c,o,l,u,1,0))return null;if(f){var d=s.getImageWidth(o,l)+3&-4,p=s.getImageHeight(o,l)+3&-4;c=a(c,0,d,p)}return c}function a(s,o,l,u){for(var f=new Uint16Array(4),h=new Uint16Array(l*u),c=l/4,d=u/4,p=0;p<d;p++)for(var _=0;_<c;_++){var g=o+8*(p*c+_);f[0]=s[g]|s[g+1]<<8,f[1]=s[g+2]|s[g+3]<<8,f[2]=(2*(f[0]&31)+1*(f[1]&31))/3|(2*(f[0]&2016)+1*(f[1]&2016))/3&2016|(2*(f[0]&63488)+1*(f[1]&63488))/3&63488,f[3]=(2*(f[1]&31)+1*(f[0]&31))/3|(2*(f[1]&2016)+1*(f[0]&2016))/3&2016|(2*(f[1]&63488)+1*(f[0]&63488))/3&63488;for(var v=0;v<4;v++){var y=s[g+4+v],b=(p*4+v)*l+_*4;h[b++]=f[y&3],h[b++]=f[y>>2&3],h[b++]=f[y>>4&3],h[b++]=f[y>>6&3]}}return h}}Object.defineProperty(gn,"JSModuleURL",{get:function(){return er.JSModuleURL},set:function(i){er.JSModuleURL=i}});Object.defineProperty(gn,"WasmModuleURL",{get:function(){return er.WasmModuleURL},set:function(i){er.WasmModuleURL=i}});var Kh=542327876,Qn=131072,$n=512,Jn=4,ea=64,ta=131072;function fi(i){return i.charCodeAt(0)+(i.charCodeAt(1)<<8)+(i.charCodeAt(2)<<16)+(i.charCodeAt(3)<<24)}function Yh(i){return String.fromCharCode(i&255,i>>8&255,i>>16&255,i>>24&255)}var ra=fi("DXT1"),ia=fi("DXT3"),na=fi("DXT5"),Ti=fi("DX10"),aa=113,sa=116,oa=2,la=10,qh=88,Ei=31,Zh=0,Qh=1,ua=2,fa=3,Ai=4,ha=7,Si=20,ca=21,$h=22,Jh=23,ec=24,tc=25,rc=26,ic=28,nc=32,ir=function(){function i(){}return i.GetDDSInfo=function(e){var t=new Int32Array(e.buffer,e.byteOffset,Ei),r=new Int32Array(e.buffer,e.byteOffset,Ei+4),n=1;t[ua]&Qn&&(n=Math.max(1,t[ha]));var a=t[ca],s=a===Ti?r[nc]:0,o=0;switch(a){case aa:o=2;break;case sa:o=1;break;case Ti:if(s===la){o=2;break}if(s===oa){o=1;break}}return{width:t[Ai],height:t[fa],mipmapCount:n,isFourCC:(t[Si]&Jn)===Jn,isRGB:(t[Si]&ea)===ea,isLuminance:(t[Si]&ta)===ta,isCube:(t[ic]&$n)===$n,isCompressed:a===ra||a===ia||a===na,dxgiFormat:s,textureType:o}},i._GetHalfFloatAsFloatRGBAArrayBuffer=function(e,t,r,n,a,s){for(var o=new Float32Array(n),l=new Uint16Array(a,r),u=0,f=0;f<t;f++)for(var h=0;h<e;h++){var c=(h+f*e)*4;o[u]=Wt(l[c]),o[u+1]=Wt(l[c+1]),o[u+2]=Wt(l[c+2]),i.StoreLODInAlphaChannel?o[u+3]=s:o[u+3]=Wt(l[c+3]),u+=4}return o},i._GetHalfFloatRGBAArrayBuffer=function(e,t,r,n,a,s){if(i.StoreLODInAlphaChannel){for(var o=new Uint16Array(n),l=new Uint16Array(a,r),u=0,f=0;f<t;f++)for(var h=0;h<e;h++){var c=(h+f*e)*4;o[u]=l[c],o[u+1]=l[c+1],o[u+2]=l[c+2],o[u+3]=Ft(s),u+=4}return o}return new Uint16Array(a,r,n)},i._GetFloatRGBAArrayBuffer=function(e,t,r,n,a,s){if(i.StoreLODInAlphaChannel){for(var o=new Float32Array(n),l=new Float32Array(a,r),u=0,f=0;f<t;f++)for(var h=0;h<e;h++){var c=(h+f*e)*4;o[u]=l[c],o[u+1]=l[c+1],o[u+2]=l[c+2],o[u+3]=s,u+=4}return o}return new Float32Array(a,r,n)},i._GetFloatAsHalfFloatRGBAArrayBuffer=function(e,t,r,n,a,s){for(var o=new Uint16Array(n),l=new Float32Array(a,r),u=0,f=0;f<t;f++)for(var h=0;h<e;h++)o[u]=Ft(l[u]),o[u+1]=Ft(l[u+1]),o[u+2]=Ft(l[u+2]),i.StoreLODInAlphaChannel?o[u+3]=Ft(s):o[u+3]=Ft(l[u+3]),u+=4;return o},i._GetFloatAsUIntRGBAArrayBuffer=function(e,t,r,n,a,s){for(var o=new Uint8Array(n),l=new Float32Array(a,r),u=0,f=0;f<t;f++)for(var h=0;h<e;h++){var c=(h+f*e)*4;o[u]=K.Clamp(l[c])*255,o[u+1]=K.Clamp(l[c+1])*255,o[u+2]=K.Clamp(l[c+2])*255,i.StoreLODInAlphaChannel?o[u+3]=s:o[u+3]=K.Clamp(l[c+3])*255,u+=4}return o},i._GetHalfFloatAsUIntRGBAArrayBuffer=function(e,t,r,n,a,s){for(var o=new Uint8Array(n),l=new Uint16Array(a,r),u=0,f=0;f<t;f++)for(var h=0;h<e;h++){var c=(h+f*e)*4;o[u]=K.Clamp(Wt(l[c]))*255,o[u+1]=K.Clamp(Wt(l[c+1]))*255,o[u+2]=K.Clamp(Wt(l[c+2]))*255,i.StoreLODInAlphaChannel?o[u+3]=s:o[u+3]=K.Clamp(Wt(l[c+3]))*255,u+=4}return o},i._GetRGBAArrayBuffer=function(e,t,r,n,a,s,o,l,u){for(var f=new Uint8Array(n),h=new Uint8Array(a,r),c=0,d=0;d<t;d++)for(var p=0;p<e;p++){var _=(p+d*e)*4;f[c]=h[_+s],f[c+1]=h[_+o],f[c+2]=h[_+l],f[c+3]=h[_+u],c+=4}return f},i._ExtractLongWordOrder=function(e){return e===0||e===255||e===-16777216?0:1+i._ExtractLongWordOrder(e>>8)},i._GetRGBArrayBuffer=function(e,t,r,n,a,s,o,l){for(var u=new Uint8Array(n),f=new Uint8Array(a,r),h=0,c=0;c<t;c++)for(var d=0;d<e;d++){var p=(d+c*e)*3;u[h]=f[p+s],u[h+1]=f[p+o],u[h+2]=f[p+l],h+=3}return u},i._GetLuminanceArrayBuffer=function(e,t,r,n,a){for(var s=new Uint8Array(n),o=new Uint8Array(a,r),l=0,u=0;u<t;u++)for(var f=0;f<e;f++){var h=f+u*e;s[l]=o[h],l++}return s},i.UploadDDSLevels=function(e,t,r,n,a,s,o,l,u){o===void 0&&(o=-1),u===void 0&&(u=!0);var f=null;n.sphericalPolynomial&&(f=new Array);var h=!!e.getCaps().s3tc;t.generateMipMaps=a;var c=new Int32Array(r.buffer,r.byteOffset,Ei),d,p,_,g=0,v,y,b,E,A=0,S=1;if(c[Zh]!==Kh){Y.Error("Invalid magic number in DDS header");return}if(!n.isFourCC&&!n.isRGB&&!n.isLuminance){Y.Error("Unsupported format, must contain a FourCC, RGB or LUMINANCE code");return}if(n.isCompressed&&!h){Y.Error("Compressed textures are not supported on this platform.");return}var T=c[$h];v=c[Qh]+4;var M=!1;if(n.isFourCC)switch(d=c[ca],d){case ra:S=8,A=33777;break;case ia:S=16,A=33778;break;case na:S=16,A=33779;break;case aa:M=!0,T=64;break;case sa:M=!0,T=128;break;case Ti:{v+=5*4;var D=!1;switch(n.dxgiFormat){case la:M=!0,T=64,D=!0;break;case oa:M=!0,T=128,D=!0;break;case qh:n.isRGB=!0,n.isFourCC=!1,T=32,D=!0;break}if(D)break}default:console.error("Unsupported FourCC code:",Yh(d));return}var x=i._ExtractLongWordOrder(c[Jh]),P=i._ExtractLongWordOrder(c[ec]),w=i._ExtractLongWordOrder(c[tc]),k=i._ExtractLongWordOrder(c[rc]);M&&(A=e._getRGBABufferInternalSizedFormat(n.textureType)),b=1,c[ua]&Qn&&a!==!1&&(b=Math.max(1,c[ha]));for(var B=l||0,L=e.getCaps(),H=B;H<s;H++){for(p=c[Ai],_=c[fa],E=0;E<b;++E){if(o===-1||o===E){var W=o===-1?E:0;if(!n.isCompressed&&n.isFourCC){t.format=5,g=p*_*4;var F=null;if(e._badOS||e._badDesktopOS||!L.textureHalfFloat&&!L.textureFloat)T===128?(F=i._GetFloatAsUIntRGBAArrayBuffer(p,_,r.byteOffset+v,g,r.buffer,W),f&&W==0&&f.push(i._GetFloatRGBAArrayBuffer(p,_,r.byteOffset+v,g,r.buffer,W))):T===64&&(F=i._GetHalfFloatAsUIntRGBAArrayBuffer(p,_,r.byteOffset+v,g,r.buffer,W),f&&W==0&&f.push(i._GetHalfFloatAsFloatRGBAArrayBuffer(p,_,r.byteOffset+v,g,r.buffer,W))),t.type=0;else{var V=L.textureFloat&&(u&&L.textureFloatLinearFiltering||!u),z=L.textureHalfFloat&&(u&&L.textureHalfFloatLinearFiltering||!u),N=(T===128||T===64&&!z)&&V?1:(T===64||T===128&&!V)&&z?2:0,Q=void 0,Z=null;switch(T){case 128:{switch(N){case 1:Q=i._GetFloatRGBAArrayBuffer,Z=null;break;case 2:Q=i._GetFloatAsHalfFloatRGBAArrayBuffer,Z=i._GetFloatRGBAArrayBuffer;break;case 0:Q=i._GetFloatAsUIntRGBAArrayBuffer,Z=i._GetFloatRGBAArrayBuffer;break}break}default:{switch(N){case 1:Q=i._GetHalfFloatAsFloatRGBAArrayBuffer,Z=null;break;case 2:Q=i._GetHalfFloatRGBAArrayBuffer,Z=i._GetHalfFloatAsFloatRGBAArrayBuffer;break;case 0:Q=i._GetHalfFloatAsUIntRGBAArrayBuffer,Z=i._GetHalfFloatAsFloatRGBAArrayBuffer;break}break}}t.type=N,F=Q(p,_,r.byteOffset+v,g,r.buffer,W),f&&W==0&&f.push(Z?Z(p,_,r.byteOffset+v,g,r.buffer,W):F)}F&&e._uploadDataToTextureDirectly(t,F,H,W)}else if(n.isRGB)t.type=0,T===24?(t.format=4,g=p*_*3,y=i._GetRGBArrayBuffer(p,_,r.byteOffset+v,g,r.buffer,x,P,w),e._uploadDataToTextureDirectly(t,y,H,W)):(t.format=5,g=p*_*4,y=i._GetRGBAArrayBuffer(p,_,r.byteOffset+v,g,r.buffer,x,P,w,k),e._uploadDataToTextureDirectly(t,y,H,W));else if(n.isLuminance){var ee=e._getUnpackAlignement(),ne=p,Te=Math.floor((p+ee-1)/ee)*ee;g=Te*(_-1)+ne,y=i._GetLuminanceArrayBuffer(p,_,r.byteOffset+v,g,r.buffer),t.format=1,t.type=0,e._uploadDataToTextureDirectly(t,y,H,W)}else g=Math.max(4,p)/4*Math.max(4,_)/4*S,y=new Uint8Array(r.buffer,r.byteOffset+v,g),t.type=0,e._uploadCompressedDataToTextureDirectly(t,A,p,_,y,H,W)}v+=T?p*_*(T/8):g,p*=.5,_*=.5,p=Math.max(1,p),_=Math.max(1,_)}if(l!==void 0)break}f&&f.length>0?n.sphericalPolynomial=vn.ConvertCubeMapToSphericalPolynomial({size:c[Ai],right:f[0],left:f[1],up:f[2],down:f[3],front:f[4],back:f[5],format:5,type:1,gammaSpace:!1}):n.sphericalPolynomial=void 0},i.StoreLODInAlphaChannel=!1,i}();ge.prototype.createPrefilteredCubeTexture=function(i,e,t,r,n,a,s,o,l){var u=this;n===void 0&&(n=null),a===void 0&&(a=null),o===void 0&&(o=null),l===void 0&&(l=!0);var f=function(h){if(!h){n&&n(null);return}var c=h.texture;if(l?h.info.sphericalPolynomial&&(c._sphericalPolynomial=h.info.sphericalPolynomial):c._sphericalPolynomial=new ui,c._source=Ie.CubePrefiltered,u.getCaps().textureLOD){n&&n(c);return}var d=3,p=u._gl,_=h.width;if(!!_){for(var g=[],v=0;v<d;v++){var y=v/(d-1),b=1-y,E=r,A=K.Log2(_)*t+r,S=E+(A-E)*b,T=Math.round(Math.min(Math.max(S,0),A)),M=new at(u,Ie.Temp);if(M.type=c.type,M.format=c.format,M.width=Math.pow(2,Math.max(K.Log2(_)-T,0)),M.height=M.width,M.isCube=!0,M._cachedWrapU=0,M._cachedWrapV=0,u._bindTextureDirectly(p.TEXTURE_CUBE_MAP,M,!0),M.samplingMode=2,p.texParameteri(p.TEXTURE_CUBE_MAP,p.TEXTURE_MAG_FILTER,p.LINEAR),p.texParameteri(p.TEXTURE_CUBE_MAP,p.TEXTURE_MIN_FILTER,p.LINEAR),p.texParameteri(p.TEXTURE_CUBE_MAP,p.TEXTURE_WRAP_S,p.CLAMP_TO_EDGE),p.texParameteri(p.TEXTURE_CUBE_MAP,p.TEXTURE_WRAP_T,p.CLAMP_TO_EDGE),h.isDDS){var D=h.info,x=h.data;u._unpackFlipY(D.isCompressed),ir.UploadDDSLevels(u,M,x,D,!0,6,T)}else Y.Warn("DDS is the only prefiltered cube map supported so far.");u._bindTextureDirectly(p.TEXTURE_CUBE_MAP,null);var P=new bt(e);P.isCube=!0,P._texture=M,M.isReady=!0,g.push(P)}c._lodTextureHigh=g[2],c._lodTextureMid=g[1],c._lodTextureLow=g[0],n&&n(c)}};return this.createCubeTexture(i,e,null,!1,f,a,s,o,l,t,r)};var Cp=function(){function i(){var e=this;this.promise=new Promise(function(t,r){e._resolve=t,e._reject=r})}return Object.defineProperty(i.prototype,"resolve",{get:function(){return this._resolve},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"reject",{get:function(){return this._reject},enumerable:!1,configurable:!0}),i}(),ac="rgbdDecodePixelShader",sc=`varying vec2 vUV;
uniform sampler2D textureSampler;
#include<helperFunctions>
#define CUSTOM_FRAGMENT_DEFINITIONS
void main(void) 
{
gl_FragColor=vec4(fromRGBD(texture2D(textureSampler,vUV)),1.0);
}`;q.ShadersStore[ac]=sc;var xp=function(){function i(){}return i.ExpandRGBDTexture=function(e){var t=e._texture;if(!(!t||!e.isRGBD)){var r=t.getEngine(),n=r.getCaps(),a=t.isReady,s=!1;n.textureHalfFloatRender&&n.textureHalfFloatLinearFiltering?(s=!0,t.type=2):n.textureFloatRender&&n.textureFloatLinearFiltering&&(s=!0,t.type=1),s&&(t.isReady=!1,t._isRGBD=!1,t.invertY=!1);var o=function(){if(s){var l=new St("rgbdDecode","rgbdDecode",null,null,1,null,3,r,!1,void 0,t.type,void 0,null,!1);l.externalTextureSamplerBinding=!0;var u=r.createRenderTargetTexture(t.width,{generateDepthBuffer:!1,generateMipMaps:!1,generateStencilBuffer:!1,samplingMode:t.samplingMode,type:t.type,format:5});l.getEffect().executeWhenCompiled(function(){l.onApply=function(f){f._bindTexture("textureSampler",t),f.setFloat2("scale",1,1)},e.getScene().postProcessManager.directRender([l],u,!0),r.restoreDefaultFramebuffer(),r._releaseTexture(t),l&&l.dispose(),u._swapAndDie(t),t.isReady=!0})}};a?o():e.onLoadObservable.addOnce(o)}},i.EncodeTextureToRGBD=function(e,t,r){return r===void 0&&(r=0),kh("rgbdEncode",e,t,r,1,5)},i}(),oc="rgbdEncodePixelShader",lc=`varying vec2 vUV;
uniform sampler2D textureSampler;
#include<helperFunctions>
#define CUSTOM_FRAGMENT_DEFINITIONS
void main(void) 
{
gl_FragColor=toRGBD(texture2D(textureSampler,vUV).rgb);
}`;q.ShadersStore[oc]=lc;var Ys="image/png",da=2,pa=[134,22,135,150,246,214,150,54];function uc(i){for(var e=new DataView(i.buffer,i.byteOffset,i.byteLength),t=0,r=0;r<pa.length;r++)if(e.getUint8(t++)!==pa[r])return Y.Error("Not a babylon environment map"),null;for(var n="",a=0;a=e.getUint8(t++);)n+=String.fromCharCode(a);var s=JSON.parse(n);return s=hi(s),s.specular&&(s.specular.specularDataPosition=t,s.specular.lodGenerationScale=s.specular.lodGenerationScale||.8),s}function hi(i){if(i.version>da)throw new Error('Unsupported babylon environment map version "'.concat(i.version,'". Latest supported version is "').concat(da,'".'));return i.version===2||(i=Ue(Ue({},i),{version:2,imageType:Ys})),i}function fc(i,e){e=hi(e);var t=e.specular,r=K.Log2(e.width);if(r=Math.round(r)+1,t.mipmaps.length!==6*r)throw new Error('Unsupported specular mipmaps number "'.concat(t.mipmaps.length,'"'));for(var n=new Array(r),a=0;a<r;a++){n[a]=new Array(6);for(var s=0;s<6;s++){var o=t.mipmaps[a*6+s];n[a][s]=new Uint8Array(i.buffer,i.byteOffset+t.specularDataPosition+o.position,o.length)}}return n}function hc(i,e,t){t=hi(t);var r=t.specular;if(!r)return Promise.resolve();i._lodGenerationScale=r.lodGenerationScale;var n=fc(e,t);return ji(i,n,t.imageType)}function _a(i,e,t,r,n,a,s,o,l,u,f){return new Promise(function(h,c){if(t){var d=e.createTexture(null,!0,!0,null,1,null,function(_){c(_)},i);r.getEffect().executeWhenCompiled(function(){r.externalTextureSamplerBinding=!0,r.onApply=function(_){_._bindTexture("textureSampler",d),_.setFloat2("scale",1,e._features.needsInvertingBitmap&&i instanceof ImageBitmap?-1:1)},e.scenes.length&&(e.scenes[0].postProcessManager.directRender([r],u,!0,a,s),e.restoreDefaultFramebuffer(),d.dispose(),URL.revokeObjectURL(n),h())})}else{if(e._uploadImageToTexture(f,i,a,s),o){var p=l[s];p&&e._uploadImageToTexture(p._texture,i,a,0)}h()}})}function ji(i,e,t){if(t===void 0&&(t=Ys),!te.IsExponentOfTwo(i.width))throw new Error("Texture size must be a power of two");var r=K.ILog2(i.width)+1,n=i.getEngine(),a=!1,s=!1,o=null,l=null,u=null,f=n.getCaps();if(i.format=5,i.type=0,i.generateMipMaps=!0,i._cachedAnisotropicFilteringLevel=null,n.updateTextureSamplingMode(3,i),f.textureLOD?n._features.supportRenderAndCopyToLodForFloatTextures?f.textureHalfFloatRender&&f.textureHalfFloatLinearFiltering?(a=!0,i.type=2):f.textureFloatRender&&f.textureFloatLinearFiltering&&(a=!0,i.type=1):a=!1:(a=!1,s=!0,u={}),a)o=new St("rgbdDecode","rgbdDecode",null,null,1,null,3,n,!1,void 0,i.type,void 0,null,!1),i._isRGBD=!1,i.invertY=!1,l=n.createRenderTargetCubeTexture(i.width,{generateDepthBuffer:!1,generateMipMaps:!0,generateStencilBuffer:!1,samplingMode:3,type:i.type,format:5});else if(i._isRGBD=!0,i.invertY=!0,s)for(var h=3,c=i._lodGenerationScale,d=i._lodGenerationOffset,p=0;p<h;p++){var _=p/(h-1),g=1-_,v=d,y=(r-1)*c+d,b=v+(y-v)*g,E=Math.round(Math.min(Math.max(b,0),y)),A=new at(n,Ie.Temp);A.isCube=!0,A.invertY=!0,A.generateMipMaps=!1,n.updateTextureSamplingMode(2,A);var S=new bt(null);switch(S.isCube=!0,S._texture=A,u[E]=S,p){case 0:i._lodTextureLow=S;break;case 1:i._lodTextureMid=S;break;case 2:i._lodTextureHigh=S;break}}for(var T=[],M=function(k){for(var B=function(H){var W=e[k][H],F=new Blob([W],{type:t}),V=URL.createObjectURL(F),z=void 0;if(typeof Image=="undefined"||n._features.forceBitmapOverHTMLImageElement)z=n.createImageBitmap(F,{premultiplyAlpha:"none"}).then(function(Q){return _a(Q,n,a,o,V,H,k,s,u,l,i)});else{var N=new Image;N.src=V,z=new Promise(function(Q,Z){N.onload=function(){_a(N,n,a,o,V,H,k,s,u,l,i).then(function(){return Q()}).catch(function(ee){Z(ee)})},N.onerror=function(ee){Z(ee)}})}T.push(z)},L=0;L<6;L++)B(L)},p=0;p<e.length;p++)M(p);if(e.length<r){var D=void 0,x=Math.pow(2,r-1-e.length),P=x*x*4;switch(i.type){case 0:{D=new Uint8Array(P);break}case 2:{D=new Uint16Array(P);break}case 1:{D=new Float32Array(P);break}}for(var p=e.length;p<r;p++)for(var w=0;w<6;w++)n._uploadArrayBufferViewToTexture(i,D,w,p)}return Promise.all(T).then(function(){l&&(n._releaseTexture(i),l._swapAndDie(i)),o&&o.dispose(),s&&(i._lodTextureHigh&&i._lodTextureHigh._texture&&(i._lodTextureHigh._texture.isReady=!0),i._lodTextureMid&&i._lodTextureMid._texture&&(i._lodTextureMid._texture.isReady=!0),i._lodTextureLow&&i._lodTextureLow._texture&&(i._lodTextureLow._texture.isReady=!0))})}function cc(i,e){e=hi(e);var t=e.irradiance;if(!!t){var r=new ui;m.FromArrayToRef(t.x,0,r.x),m.FromArrayToRef(t.y,0,r.y),m.FromArrayToRef(t.z,0,r.z),m.FromArrayToRef(t.xx,0,r.xx),m.FromArrayToRef(t.yy,0,r.yy),m.FromArrayToRef(t.zz,0,r.zz),m.FromArrayToRef(t.yz,0,r.yz),m.FromArrayToRef(t.zx,0,r.zx),m.FromArrayToRef(t.xy,0,r.xy),i._sphericalPolynomial=r}}function Dp(i,e,t,r,n){var a=i.getEngine().createRawCubeTexture(null,i.width,i.format,i.type,i.generateMipMaps,i.invertY,i.samplingMode,i._compression),s=ji(a,e).then(function(){return i});return i.onRebuildCallback=function(o){return{proxy:s,isReady:!0,isAsync:!0}},i._source=Ie.CubeRawRGBD,i._bufferViewArrayArray=e,i._lodGenerationScale=r,i._lodGenerationOffset=n,i._sphericalPolynomial=t,ji(i,e).then(function(){return i.isReady=!0,i})}(function(){function i(e,t,r,n,a,s,o,l,u){var f=this;this.onProcessFileCallback=function(){return!0},this.loadAsync=function(h,c){return Cr.LoadAsync("file:",h,f._engine,c)},this._engine=e,this._currentScene=t,this._sceneLoadedCallback=r,this._progressCallback=n,this._additionalRenderLoopLogicCallback=a,this._textureLoadingCallback=s,this._startingProcessingFilesCallback=o,this._onReloadCallback=l,this._errorCallback=u}return Object.defineProperty(i,"FilesToLoad",{get:function(){return Rr.FilesToLoad},enumerable:!1,configurable:!0}),i.prototype.monitorElementForDragNDrop=function(e){var t=this;e&&(this._elementToMonitor=e,this._dragEnterHandler=function(r){t._drag(r)},this._dragOverHandler=function(r){t._drag(r)},this._dropHandler=function(r){t._drop(r)},this._elementToMonitor.addEventListener("dragenter",this._dragEnterHandler,!1),this._elementToMonitor.addEventListener("dragover",this._dragOverHandler,!1),this._elementToMonitor.addEventListener("drop",this._dropHandler,!1))},Object.defineProperty(i.prototype,"filesToLoad",{get:function(){return this._filesToLoad},enumerable:!1,configurable:!0}),i.prototype.dispose=function(){!this._elementToMonitor||(this._elementToMonitor.removeEventListener("dragenter",this._dragEnterHandler),this._elementToMonitor.removeEventListener("dragover",this._dragOverHandler),this._elementToMonitor.removeEventListener("drop",this._dropHandler))},i.prototype._renderFunction=function(){if(this._additionalRenderLoopLogicCallback&&this._additionalRenderLoopLogicCallback(),this._currentScene){if(this._textureLoadingCallback){var e=this._currentScene.getWaitingItemsCount();e>0&&this._textureLoadingCallback(e)}this._currentScene.render()}},i.prototype._drag=function(e){e.stopPropagation(),e.preventDefault()},i.prototype._drop=function(e){e.stopPropagation(),e.preventDefault(),this.loadFiles(e)},i.prototype._traverseFolder=function(e,t,r,n){var a=this,s=e.createReader(),o=e.fullPath.replace(/^\//,"").replace(/(.+?)\/?$/,"$1/");s.readEntries(function(l){r.count+=l.length;for(var u=0,f=l;u<f.length;u++){var h=f[u];h.isFile?h.file(function(c){c.correctName=o+c.name,t.push(c),--r.count===0&&n()}):h.isDirectory&&a._traverseFolder(h,t,r,n)}--r.count===0&&n()})},i.prototype._processFiles=function(e){for(var t=this,r=0;r<e.length;r++){var n=e[r].correctName.toLowerCase(),a=n.split(".").pop();!this.onProcessFileCallback(e[r],n,a,function(s){return t._sceneFileToLoad=s})||(Cr.IsPluginForExtensionAvailable("."+a)&&(this._sceneFileToLoad=e[r]),i.FilesToLoad[n]=e[r])}},i.prototype.loadFiles=function(e){var t=this;if(e&&e.dataTransfer&&e.dataTransfer.files&&(this._filesToLoad=e.dataTransfer.files),e&&e.target&&e.target.files&&(this._filesToLoad=e.target.files),!(!this._filesToLoad||this._filesToLoad.length===0)&&(this._startingProcessingFilesCallback&&this._startingProcessingFilesCallback(this._filesToLoad),this._filesToLoad&&this._filesToLoad.length>0)){for(var r=new Array,n=[],a=e.dataTransfer?e.dataTransfer.items:null,s=0;s<this._filesToLoad.length;s++){var o=this._filesToLoad[s],l=o.name.toLowerCase(),u=void 0;if(o.correctName=l,a){var f=a[s];f.getAsEntry?u=f.getAsEntry():f.webkitGetAsEntry&&(u=f.webkitGetAsEntry())}u&&u.isDirectory?n.push(u):r.push(o)}if(n.length===0)this._processFiles(r),this._processReload();else for(var h={count:n.length},c=0,d=n;c<d.length;c++){var p=d[c];this._traverseFolder(p,r,h,function(){t._processFiles(r),h.count===0&&t._processReload()})}}},i.prototype._processReload=function(){this._onReloadCallback?this._onReloadCallback(this._sceneFileToLoad):this.reload()},i.prototype.reload=function(){var e=this;this._sceneFileToLoad?(this._currentScene&&(Y.errorsCount>0&&Y.ClearLogCache(),this._engine.stopRenderLoop()),Cr.ShowLoadingScreen=!1,this._engine.displayLoadingUI(),this.loadAsync(this._sceneFileToLoad,this._progressCallback).then(function(t){e._currentScene&&e._currentScene.dispose(),e._currentScene=t,e._sceneLoadedCallback&&e._sceneLoadedCallback(e._sceneFileToLoad,e._currentScene),e._currentScene.executeWhenReady(function(){e._engine.hideLoadingUI(),e._engine.runRenderLoop(function(){e._renderFunction()})})}).catch(function(t){e._engine.hideLoadingUI(),e._errorCallback&&e._errorCallback(e._sceneFileToLoad,e._currentScene,t.message)})):Y.Error("Please provide a valid .babylon file.")},i})();var Ri=function(){function i(e,t){if(this.data=e,this.isInvalid=!1,!i.IsValid(e)){this.isInvalid=!0,Y.Error("texture missing KTX identifier");return}var r=Uint32Array.BYTES_PER_ELEMENT,n=new DataView(this.data.buffer,this.data.byteOffset+12,13*r),a=n.getUint32(0,!0),s=a===67305985;if(this.glType=n.getUint32(1*r,s),this.glTypeSize=n.getUint32(2*r,s),this.glFormat=n.getUint32(3*r,s),this.glInternalFormat=n.getUint32(4*r,s),this.glBaseInternalFormat=n.getUint32(5*r,s),this.pixelWidth=n.getUint32(6*r,s),this.pixelHeight=n.getUint32(7*r,s),this.pixelDepth=n.getUint32(8*r,s),this.numberOfArrayElements=n.getUint32(9*r,s),this.numberOfFaces=n.getUint32(10*r,s),this.numberOfMipmapLevels=n.getUint32(11*r,s),this.bytesOfKeyValueData=n.getUint32(12*r,s),this.glType!==0){Y.Error("only compressed formats currently supported");return}else this.numberOfMipmapLevels=Math.max(1,this.numberOfMipmapLevels);if(this.pixelHeight===0||this.pixelDepth!==0){Y.Error("only 2D textures currently supported");return}if(this.numberOfArrayElements!==0){Y.Error("texture arrays not currently supported");return}if(this.numberOfFaces!==t){Y.Error("number of faces expected"+t+", but found "+this.numberOfFaces);return}this.loadType=i.COMPRESSED_2D}return i.prototype.uploadLevels=function(e,t){switch(this.loadType){case i.COMPRESSED_2D:this._upload2DCompressedLevels(e,t);break}},i.prototype._upload2DCompressedLevels=function(e,t){for(var r=i.HEADER_LEN+this.bytesOfKeyValueData,n=this.pixelWidth,a=this.pixelHeight,s=t?this.numberOfMipmapLevels:1,o=0;o<s;o++){var l=new Int32Array(this.data.buffer,this.data.byteOffset+r,1)[0];r+=4;for(var u=0;u<this.numberOfFaces;u++){var f=new Uint8Array(this.data.buffer,this.data.byteOffset+r,l),h=e.getEngine();h._uploadCompressedDataToTextureDirectly(e,this.glInternalFormat,n,a,f,u,o),r+=l,r+=3-(l+3)%4}n=Math.max(1,n*.5),a=Math.max(1,a*.5)}},i.IsValid=function(e){if(e.byteLength>=12){var t=new Uint8Array(e.buffer,e.byteOffset,12);if(t[0]===171&&t[1]===75&&t[2]===84&&t[3]===88&&t[4]===32&&t[5]===49&&t[6]===49&&t[7]===187&&t[8]===13&&t[9]===10&&t[10]===26&&t[11]===10)return!0}return!1},i.HEADER_LEN=12+13*4,i.COMPRESSED_2D=0,i.COMPRESSED_3D=1,i.TEX_2D=2,i.TEX_3D=3,i}(),kt=function(){function i(e){e===void 0&&(e=0),this.priority=e}return i.prototype.getDescription=function(){return""},i.prototype.apply=function(e,t){return!0},i}(),Pi=function(i){$(e,i);function e(t,r,n){t===void 0&&(t=0),r===void 0&&(r=1024),n===void 0&&(n=.5);var a=i.call(this,t)||this;return a.priority=t,a.maximumSize=r,a.step=n,a}return e.prototype.getDescription=function(){return"Reducing render target texture size to "+this.maximumSize},e.prototype.apply=function(t,r){for(var n=!0,a=0;a<t.textures.length;a++){var s=t.textures[a];if(!(!s.canRescale||s.getContext)){var o=s.getSize(),l=Math.max(o.width,o.height);l>this.maximumSize&&(s.scale(this.step),n=!1)}}return n},e}(kt),va=function(i){$(e,i);function e(t,r,n){t===void 0&&(t=0),r===void 0&&(r=2),n===void 0&&(n=.25);var a=i.call(this,t)||this;return a.priority=t,a.maximumScale=r,a.step=n,a._currentScale=-1,a._directionOffset=1,a}return e.prototype.getDescription=function(){return"Setting hardware scaling level to "+this._currentScale},e.prototype.apply=function(t,r){return this._currentScale===-1&&(this._currentScale=t.getEngine().getHardwareScalingLevel(),this._currentScale>this.maximumScale&&(this._directionOffset=-1)),this._currentScale+=this._directionOffset*this.step,t.getEngine().setHardwareScalingLevel(this._currentScale),this._directionOffset===1?this._currentScale>=this.maximumScale:this._currentScale<=this.maximumScale},e}(kt),Mi=function(i){$(e,i);function e(){return i!==null&&i.apply(this,arguments)||this}return e.prototype.getDescription=function(){return"Turning shadows on/off"},e.prototype.apply=function(t,r){return t.shadowsEnabled=r.isInImprovementMode,!0},e}(kt),Ci=function(i){$(e,i);function e(){return i!==null&&i.apply(this,arguments)||this}return e.prototype.getDescription=function(){return"Turning post-processes on/off"},e.prototype.apply=function(t,r){return t.postProcessesEnabled=r.isInImprovementMode,!0},e}(kt),xi=function(i){$(e,i);function e(){return i!==null&&i.apply(this,arguments)||this}return e.prototype.getDescription=function(){return"Turning lens flares on/off"},e.prototype.apply=function(t,r){return t.lensFlaresEnabled=r.isInImprovementMode,!0},e}(kt),dc=function(i){$(e,i);function e(){return i!==null&&i.apply(this,arguments)||this}return e.prototype.getDescription=function(){return this.onGetDescription?this.onGetDescription():"Running user defined callback"},e.prototype.apply=function(t,r){return this.onApply?this.onApply(t,r):!0},e}(kt),Di=function(i){$(e,i);function e(){return i!==null&&i.apply(this,arguments)||this}return e.prototype.getDescription=function(){return"Turning particles on/off"},e.prototype.apply=function(t,r){return t.particlesEnabled=r.isInImprovementMode,!0},e}(kt),ga=function(i){$(e,i);function e(){return i!==null&&i.apply(this,arguments)||this}return e.prototype.getDescription=function(){return"Turning render targets off"},e.prototype.apply=function(t,r){return t.renderTargetsEnabled=r.isInImprovementMode,!0},e}(kt),Oi=function(i){$(e,i);function e(){var t=i!==null&&i.apply(this,arguments)||this;return t._canBeMerged=function(r){if(!(r instanceof O))return!1;var n=r;return!(n.isDisposed()||!n.isVisible||!n.isEnabled()||n.instances.length>0||n.skeleton||n.hasLODLevels)},t}return Object.defineProperty(e,"UpdateSelectionTree",{get:function(){return e._UpdateSelectionTree},set:function(t){e._UpdateSelectionTree=t},enumerable:!1,configurable:!0}),e.prototype.getDescription=function(){return"Merging similar meshes together"},e.prototype.apply=function(t,r,n){for(var a=t.meshes.slice(0),s=a.length,o=0;o<s;o++){var l=new Array,u=a[o];if(!!this._canBeMerged(u)){l.push(u);for(var f=o+1;f<s;f++){var h=a[f];!this._canBeMerged(h)||h.material===u.material&&h.checkCollisions===u.checkCollisions&&(l.push(h),s--,a.splice(f,1),f--)}l.length<2||O.MergeMeshes(l,void 0,!0)}}var c=t;return c.createOrUpdateSelectionOctree&&(n!=null?n&&c.createOrUpdateSelectionOctree():e.UpdateSelectionTree&&c.createOrUpdateSelectionOctree()),!0},e._UpdateSelectionTree=!1,e}(kt),ma=function(){function i(e,t){e===void 0&&(e=60),t===void 0&&(t=2e3),this.targetFrameRate=e,this.trackerDuration=t,this.optimizations=new Array}return i.prototype.addOptimization=function(e){return this.optimizations.push(e),this},i.prototype.addCustomOptimization=function(e,t,r){r===void 0&&(r=0);var n=new dc(r);return n.onApply=e,n.onGetDescription=t,this.optimizations.push(n),this},i.LowDegradationAllowed=function(e){var t=new i(e),r=0;return t.addOptimization(new Oi(r)),t.addOptimization(new Mi(r)),t.addOptimization(new xi(r)),r++,t.addOptimization(new Ci(r)),t.addOptimization(new Di(r)),r++,t.addOptimization(new Pi(r,1024)),t},i.ModerateDegradationAllowed=function(e){var t=new i(e),r=0;return t.addOptimization(new Oi(r)),t.addOptimization(new Mi(r)),t.addOptimization(new xi(r)),r++,t.addOptimization(new Ci(r)),t.addOptimization(new Di(r)),r++,t.addOptimization(new Pi(r,512)),r++,t.addOptimization(new ga(r)),r++,t.addOptimization(new va(r,2)),t},i.HighDegradationAllowed=function(e){var t=new i(e),r=0;return t.addOptimization(new Oi(r)),t.addOptimization(new Mi(r)),t.addOptimization(new xi(r)),r++,t.addOptimization(new Ci(r)),t.addOptimization(new Di(r)),r++,t.addOptimization(new Pi(r,256)),r++,t.addOptimization(new ga(r)),r++,t.addOptimization(new va(r,4)),t},i}();(function(){function i(e,t,r,n){r===void 0&&(r=!0),n===void 0&&(n=!1);var a=this;if(this._isRunning=!1,this._currentPriorityLevel=0,this._targetFrameRate=60,this._trackerDuration=2e3,this._currentFrameRate=0,this._improvementMode=!1,this.onSuccessObservable=new X,this.onNewOptimizationAppliedObservable=new X,this.onFailureObservable=new X,t?this._options=t:this._options=new ma,this._options.targetFrameRate&&(this._targetFrameRate=this._options.targetFrameRate),this._options.trackerDuration&&(this._trackerDuration=this._options.trackerDuration),r)for(var s=0,o=0,l=this._options.optimizations;o<l.length;o++){var u=l[o];u.priority=s++}this._improvementMode=n,this._scene=e||ye.LastCreatedScene,this._sceneDisposeObserver=this._scene.onDisposeObservable.add(function(){a._sceneDisposeObserver=null,a.dispose()})}return Object.defineProperty(i.prototype,"isInImprovementMode",{get:function(){return this._improvementMode},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"currentPriorityLevel",{get:function(){return this._currentPriorityLevel},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"currentFrameRate",{get:function(){return this._currentFrameRate},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"targetFrameRate",{get:function(){return this._targetFrameRate},set:function(e){this._targetFrameRate=e},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"trackerDuration",{get:function(){return this._trackerDuration},set:function(e){this._trackerDuration=e},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"optimizations",{get:function(){return this._options.optimizations},enumerable:!1,configurable:!0}),i.prototype.stop=function(){this._isRunning=!1},i.prototype.reset=function(){this._currentPriorityLevel=0},i.prototype.start=function(){var e=this;this._isRunning||(this._isRunning=!0,this._scene.executeWhenReady(function(){setTimeout(function(){e._checkCurrentState()},e._trackerDuration)}))},i.prototype._checkCurrentState=function(){var e=this;if(!!this._isRunning){var t=this._scene,r=this._options;if(this._currentFrameRate=Math.round(t.getEngine().getFps()),this._improvementMode&&this._currentFrameRate<=this._targetFrameRate||!this._improvementMode&&this._currentFrameRate>=this._targetFrameRate){this._isRunning=!1,this.onSuccessObservable.notifyObservers(this);return}for(var n=!0,a=!0,s=0;s<r.optimizations.length;s++){var o=r.optimizations[s];o.priority===this._currentPriorityLevel&&(a=!1,n=n&&o.apply(t,this),this.onNewOptimizationAppliedObservable.notifyObservers(o))}if(a){this._isRunning=!1,this.onFailureObservable.notifyObservers(this);return}n&&this._currentPriorityLevel++,t.executeWhenReady(function(){setTimeout(function(){e._checkCurrentState()},e._trackerDuration)})}},i.prototype.dispose=function(){this.stop(),this.onSuccessObservable.clear(),this.onFailureObservable.clear(),this.onNewOptimizationAppliedObservable.clear(),this._sceneDisposeObserver&&this._scene.onDisposeObservable.remove(this._sceneDisposeObserver)},i.OptimizeAsync=function(e,t,r,n){var a=new i(e,t||ma.ModerateDegradationAllowed(),!1);return r&&a.onSuccessObservable.add(function(){r()}),n&&a.onFailureObservable.add(function(){n()}),a.start(),a},i})();var pc=1,_c=2,vc=3,gc=9,mc=10,yc=11,bc=48,Tc=4,Ec=0,Ac=1,Sc=2,Rc=3;function mn(i){var e=0,t={id_length:i[e++],colormap_type:i[e++],image_type:i[e++],colormap_index:i[e++]|i[e++]<<8,colormap_length:i[e++]|i[e++]<<8,colormap_size:i[e++],origin:[i[e++]|i[e++]<<8,i[e++]|i[e++]<<8],width:i[e++]|i[e++]<<8,height:i[e++]|i[e++]<<8,pixel_size:i[e++],flags:i[e++]};return t}function qs(i,e){if(e.length<19){Y.Error("Unable to load TGA file - Not enough data to contain header");return}var t=18,r=mn(e);if(r.id_length+t>e.length){Y.Error("Unable to load TGA file - Not enough data");return}t+=r.id_length;var n=!1,a=!1,s=!1;switch(r.image_type){case gc:n=!0;case pc:a=!0;break;case mc:n=!0;case _c:break;case yc:n=!0;case vc:s=!0;break}var o,l=r.pixel_size>>3,u=r.width*r.height*l,f;if(a&&(f=e.subarray(t,t+=r.colormap_length*(r.colormap_size>>3))),n){o=new Uint8Array(u);for(var h=void 0,c=void 0,d=void 0,p=0,_=new Uint8Array(l);t<u&&p<u;)if(h=e[t++],c=(h&127)+1,h&128){for(d=0;d<l;++d)_[d]=e[t++];for(d=0;d<c;++d)o.set(_,p+d*l);p+=l*c}else{for(c*=l,d=0;d<c;++d)o[p+d]=e[t++];p+=c}}else o=e.subarray(t,t+=a?r.width*r.height:u);var g,v,y,b,E,A;switch((r.flags&bc)>>Tc){default:case Sc:g=0,y=1,A=r.width,v=0,b=1,E=r.height;break;case Ec:g=0,y=1,A=r.width,v=r.height-1,b=-1,E=-1;break;case Rc:g=r.width-1,y=-1,A=-1,v=0,b=1,E=r.height;break;case Ac:g=r.width-1,y=-1,A=-1,v=r.height-1,b=-1,E=-1;break}var S="_getImageData"+(s?"Grey":"")+r.pixel_size+"bits",T=Ic[S](r,f,o,v,b,E,g,y,A),M=i.getEngine();M._uploadDataToTextureDirectly(i,T)}function Pc(i,e,t,r,n,a,s,o,l){var u=t,f=e,h=i.width,c=i.height,d,p=0,_,g,v=new Uint8Array(h*c*4);for(g=r;g!==a;g+=n)for(_=s;_!==l;_+=o,p++)d=u[p],v[(_+h*g)*4+3]=255,v[(_+h*g)*4+2]=f[d*3+0],v[(_+h*g)*4+1]=f[d*3+1],v[(_+h*g)*4+0]=f[d*3+2];return v}function Mc(i,e,t,r,n,a,s,o,l){var u=t,f=i.width,h=i.height,c,d=0,p,_,g=new Uint8Array(f*h*4);for(_=r;_!==a;_+=n)for(p=s;p!==l;p+=o,d+=2){c=u[d+0]+(u[d+1]<<8);var v=((c&31744)>>10)*255/31|0,y=((c&992)>>5)*255/31|0,b=(c&31)*255/31|0;g[(p+f*_)*4+0]=v,g[(p+f*_)*4+1]=y,g[(p+f*_)*4+2]=b,g[(p+f*_)*4+3]=c&32768?0:255}return g}function Cc(i,e,t,r,n,a,s,o,l){var u=t,f=i.width,h=i.height,c=0,d,p,_=new Uint8Array(f*h*4);for(p=r;p!==a;p+=n)for(d=s;d!==l;d+=o,c+=3)_[(d+f*p)*4+3]=255,_[(d+f*p)*4+2]=u[c+0],_[(d+f*p)*4+1]=u[c+1],_[(d+f*p)*4+0]=u[c+2];return _}function xc(i,e,t,r,n,a,s,o,l){var u=t,f=i.width,h=i.height,c=0,d,p,_=new Uint8Array(f*h*4);for(p=r;p!==a;p+=n)for(d=s;d!==l;d+=o,c+=4)_[(d+f*p)*4+2]=u[c+0],_[(d+f*p)*4+1]=u[c+1],_[(d+f*p)*4+0]=u[c+2],_[(d+f*p)*4+3]=u[c+3];return _}function Dc(i,e,t,r,n,a,s,o,l){var u=t,f=i.width,h=i.height,c,d=0,p,_,g=new Uint8Array(f*h*4);for(_=r;_!==a;_+=n)for(p=s;p!==l;p+=o,d++)c=u[d],g[(p+f*_)*4+0]=c,g[(p+f*_)*4+1]=c,g[(p+f*_)*4+2]=c,g[(p+f*_)*4+3]=255;return g}function Oc(i,e,t,r,n,a,s,o,l){var u=t,f=i.width,h=i.height,c=0,d,p,_=new Uint8Array(f*h*4);for(p=r;p!==a;p+=n)for(d=s;d!==l;d+=o,c+=2)_[(d+f*p)*4+0]=u[c+0],_[(d+f*p)*4+1]=u[c+0],_[(d+f*p)*4+2]=u[c+0],_[(d+f*p)*4+3]=u[c+1];return _}var Ic={GetTGAHeader:mn,UploadContent:qs,_getImageData8bits:Pc,_getImageData16bits:Mc,_getImageData24bits:Cc,_getImageData32bits:xc,_getImageDataGrey8bits:Dc,_getImageDataGrey16bits:Oc};(function(){function i(e,t){if(t===void 0&&(t={}),!i.IsSupported(e))throw"Your browser does not support recording so far.";var r=e.getRenderingCanvas();if(!r)throw"The babylon engine must have a canvas to be recorded";this._canvas=r,this._canvas.isRecording=!1,this._options=Ue(Ue({},i._DefaultOptions),t);var n=this._canvas.captureStream(this._options.fps);if(this._options.audioTracks)for(var a=0,s=this._options.audioTracks;a<s.length;a++){var o=s[a];n.addTrack(o)}this._mediaRecorder=new MediaRecorder(n,{mimeType:this._options.mimeType}),this._mediaRecorder.ondataavailable=this._handleDataAvailable.bind(this),this._mediaRecorder.onerror=this._handleError.bind(this),this._mediaRecorder.onstop=this._handleStop.bind(this)}return i.IsSupported=function(e){var t=e.getRenderingCanvas();return!!t&&typeof t.captureStream=="function"},Object.defineProperty(i.prototype,"isRecording",{get:function(){return!!this._canvas&&this._canvas.isRecording},enumerable:!1,configurable:!0}),i.prototype.stopRecording=function(){!this._canvas||!this._mediaRecorder||!this.isRecording||(this._canvas.isRecording=!1,this._mediaRecorder.stop())},i.prototype.startRecording=function(e,t){var r=this;if(e===void 0&&(e="babylonjs.webm"),t===void 0&&(t=7),!this._canvas||!this._mediaRecorder)throw"Recorder has already been disposed";if(this.isRecording)throw"Recording already in progress";return t>0&&setTimeout(function(){r.stopRecording()},t*1e3),this._fileName=e,this._recordedChunks=[],this._resolve=null,this._reject=null,this._canvas.isRecording=!0,this._mediaRecorder.start(this._options.recordChunckSize),new Promise(function(n,a){r._resolve=n,r._reject=a})},i.prototype.dispose=function(){this._canvas=null,this._mediaRecorder=null,this._recordedChunks=[],this._fileName=null,this._resolve=null,this._reject=null},i.prototype._handleDataAvailable=function(e){e.data.size>0&&this._recordedChunks.push(e.data)},i.prototype._handleError=function(e){if(this.stopRecording(),this._reject)this._reject(e.error);else throw new e.error},i.prototype._handleStop=function(){this.stopRecording();var e=new Blob(this._recordedChunks);this._resolve&&this._resolve(e),window.URL.createObjectURL(e),this._fileName&&te.Download(e,this._fileName)},i._DefaultOptions={mimeType:"video/webm",fps:25,recordChunckSize:3e3},i})();var Ye;(function(i){i[i.X=0]="X",i[i.Y=1]="Y",i[i.Z=2]="Z"})(Ye||(Ye={}));(function(){function i(e,t){var r=this,n=Ue(Ue({},i._GetDefaultOptions()),t);if(e?this._leftJoystick=!0:this._leftJoystick=!1,i._GlobalJoystickIndex++,this._axisTargetedByLeftAndRight=Ye.X,this._axisTargetedByUpAndDown=Ye.Y,this.reverseLeftRight=!1,this.reverseUpDown=!1,this._touches=new Ni,this.deltaPosition=m.Zero(),this._joystickSensibility=25,this._inversedSensibility=1/(this._joystickSensibility/1e3),this._onResize=function(){i._VJCanvasWidth=window.innerWidth,i._VJCanvasHeight=window.innerHeight,i.Canvas&&(i.Canvas.width=i._VJCanvasWidth,i.Canvas.height=i._VJCanvasHeight),i._HalfWidth=i._VJCanvasWidth/2},!i.Canvas){window.addEventListener("resize",this._onResize,!1),i.Canvas=document.createElement("canvas"),i._VJCanvasWidth=window.innerWidth,i._VJCanvasHeight=window.innerHeight,i.Canvas.width=window.innerWidth,i.Canvas.height=window.innerHeight,i.Canvas.style.width="100%",i.Canvas.style.height="100%",i.Canvas.style.position="absolute",i.Canvas.style.backgroundColor="transparent",i.Canvas.style.top="0px",i.Canvas.style.left="0px",i.Canvas.style.zIndex="5",i.Canvas.style.msTouchAction="none",i.Canvas.style.touchAction="none",i.Canvas.setAttribute("touch-action","none");var a=i.Canvas.getContext("2d");if(!a)throw new Error("Unable to create canvas for virtual joystick");i._VJCanvasContext=a,i._VJCanvasContext.strokeStyle="#ffffff",i._VJCanvasContext.lineWidth=2,document.body.appendChild(i.Canvas)}i._HalfWidth=i.Canvas.width/2,this.pressed=!1,this.limitToContainer=n.limitToContainer,this._joystickColor=n.color,this.containerSize=n.containerSize,this.puckSize=n.puckSize,n.position&&this.setPosition(n.position.x,n.position.y),n.puckImage&&this.setPuckImage(n.puckImage),n.containerImage&&this.setContainerImage(n.containerImage),n.alwaysVisible&&i._AlwaysVisibleSticks++,this.alwaysVisible=n.alwaysVisible,this._joystickPointerId=-1,this._joystickPointerPos=new se(0,0),this._joystickPreviousPointerPos=new se(0,0),this._joystickPointerStartPos=new se(0,0),this._deltaJoystickVector=new se(0,0),this._onPointerDownHandlerRef=function(s){r._onPointerDown(s)},this._onPointerMoveHandlerRef=function(s){r._onPointerMove(s)},this._onPointerUpHandlerRef=function(s){r._onPointerUp(s)},i.Canvas.addEventListener("pointerdown",this._onPointerDownHandlerRef,!1),i.Canvas.addEventListener("pointermove",this._onPointerMoveHandlerRef,!1),i.Canvas.addEventListener("pointerup",this._onPointerUpHandlerRef,!1),i.Canvas.addEventListener("pointerout",this._onPointerUpHandlerRef,!1),i.Canvas.addEventListener("contextmenu",function(s){s.preventDefault()},!1),requestAnimationFrame(function(){r._drawVirtualJoystick()})}return i._GetDefaultOptions=function(){return{puckSize:40,containerSize:60,color:"cyan",puckImage:void 0,containerImage:void 0,position:void 0,alwaysVisible:!1,limitToContainer:!1}},i.prototype.setJoystickSensibility=function(e){this._joystickSensibility=e,this._inversedSensibility=1/(this._joystickSensibility/1e3)},i.prototype._onPointerDown=function(e){var t;e.preventDefault(),this._leftJoystick===!0?t=e.clientX<i._HalfWidth:t=e.clientX>i._HalfWidth,t&&this._joystickPointerId<0?(this._joystickPointerId=e.pointerId,this._joystickPosition?(this._joystickPointerStartPos=this._joystickPosition.clone(),this._joystickPointerPos=this._joystickPosition.clone(),this._joystickPreviousPointerPos=this._joystickPosition.clone(),this._onPointerMove(e)):(this._joystickPointerStartPos.x=e.clientX,this._joystickPointerStartPos.y=e.clientY,this._joystickPointerPos=this._joystickPointerStartPos.clone(),this._joystickPreviousPointerPos=this._joystickPointerStartPos.clone()),this._deltaJoystickVector.x=0,this._deltaJoystickVector.y=0,this.pressed=!0,this._touches.add(e.pointerId.toString(),e)):i._GlobalJoystickIndex<2&&this._action&&(this._action(),this._touches.add(e.pointerId.toString(),{x:e.clientX,y:e.clientY,prevX:e.clientX,prevY:e.clientY}))},i.prototype._onPointerMove=function(e){if(this._joystickPointerId==e.pointerId){if(this.limitToContainer){var t=new se(e.clientX-this._joystickPointerStartPos.x,e.clientY-this._joystickPointerStartPos.y),r=t.length();r>this.containerSize&&t.scaleInPlace(this.containerSize/r),this._joystickPointerPos.x=this._joystickPointerStartPos.x+t.x,this._joystickPointerPos.y=this._joystickPointerStartPos.y+t.y}else this._joystickPointerPos.x=e.clientX,this._joystickPointerPos.y=e.clientY;this._deltaJoystickVector=this._joystickPointerPos.clone(),this._deltaJoystickVector=this._deltaJoystickVector.subtract(this._joystickPointerStartPos),0<i._AlwaysVisibleSticks&&(this._leftJoystick?this._joystickPointerPos.x=Math.min(i._HalfWidth,this._joystickPointerPos.x):this._joystickPointerPos.x=Math.max(i._HalfWidth,this._joystickPointerPos.x));var n=this.reverseLeftRight?-1:1,a=n*this._deltaJoystickVector.x/this._inversedSensibility;switch(this._axisTargetedByLeftAndRight){case Ye.X:this.deltaPosition.x=Math.min(1,Math.max(-1,a));break;case Ye.Y:this.deltaPosition.y=Math.min(1,Math.max(-1,a));break;case Ye.Z:this.deltaPosition.z=Math.min(1,Math.max(-1,a));break}var s=this.reverseUpDown?1:-1,o=s*this._deltaJoystickVector.y/this._inversedSensibility;switch(this._axisTargetedByUpAndDown){case Ye.X:this.deltaPosition.x=Math.min(1,Math.max(-1,o));break;case Ye.Y:this.deltaPosition.y=Math.min(1,Math.max(-1,o));break;case Ye.Z:this.deltaPosition.z=Math.min(1,Math.max(-1,o));break}}else{var l=this._touches.get(e.pointerId.toString());l&&(l.x=e.clientX,l.y=e.clientY)}},i.prototype._onPointerUp=function(e){if(this._joystickPointerId==e.pointerId)this._clearPreviousDraw(),this._joystickPointerId=-1,this.pressed=!1;else{var t=this._touches.get(e.pointerId.toString());t&&i._VJCanvasContext.clearRect(t.prevX-44,t.prevY-44,88,88)}this._deltaJoystickVector.x=0,this._deltaJoystickVector.y=0,this._touches.remove(e.pointerId.toString())},i.prototype.setJoystickColor=function(e){this._joystickColor=e},Object.defineProperty(i.prototype,"containerSize",{get:function(){return this._joystickContainerSize},set:function(e){this._joystickContainerSize=e,this._clearContainerSize=~~(this._joystickContainerSize*2.1),this._clearContainerSizeOffset=~~(this._clearContainerSize/2)},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"puckSize",{get:function(){return this._joystickPuckSize},set:function(e){this._joystickPuckSize=e,this._clearPuckSize=~~(this._joystickPuckSize*2.1),this._clearPuckSizeOffset=~~(this._clearPuckSize/2)},enumerable:!1,configurable:!0}),i.prototype.clearPosition=function(){this.alwaysVisible=!1,this._joystickPosition=null},Object.defineProperty(i.prototype,"alwaysVisible",{get:function(){return this._alwaysVisible},set:function(e){this._alwaysVisible!==e&&(e&&this._joystickPosition?(i._AlwaysVisibleSticks++,this._alwaysVisible=!0):(i._AlwaysVisibleSticks--,this._alwaysVisible=!1))},enumerable:!1,configurable:!0}),i.prototype.setPosition=function(e,t){this._joystickPointerStartPos&&this._clearPreviousDraw(),this._joystickPosition=new se(e,t)},i.prototype.setActionOnTouch=function(e){this._action=e},i.prototype.setAxisForLeftRight=function(e){switch(e){case Ye.X:case Ye.Y:case Ye.Z:this._axisTargetedByLeftAndRight=e;break;default:this._axisTargetedByLeftAndRight=Ye.X;break}},i.prototype.setAxisForUpDown=function(e){switch(e){case Ye.X:case Ye.Y:case Ye.Z:this._axisTargetedByUpAndDown=e;break;default:this._axisTargetedByUpAndDown=Ye.Y;break}},i.prototype._clearPreviousDraw=function(){var e=this._joystickPosition||this._joystickPointerStartPos;i._VJCanvasContext.clearRect(e.x-this._clearContainerSizeOffset,e.y-this._clearContainerSizeOffset,this._clearContainerSize,this._clearContainerSize),i._VJCanvasContext.clearRect(this._joystickPreviousPointerPos.x-this._clearPuckSizeOffset,this._joystickPreviousPointerPos.y-this._clearPuckSizeOffset,this._clearPuckSize,this._clearPuckSize)},i.prototype.setContainerImage=function(e){var t=this,r=new Image;r.src=e,r.onload=function(){return t._containerImage=r}},i.prototype.setPuckImage=function(e){var t=this,r=new Image;r.src=e,r.onload=function(){return t._puckImage=r}},i.prototype._drawContainer=function(){var e=this._joystickPosition||this._joystickPointerStartPos;this._clearPreviousDraw(),this._containerImage?i._VJCanvasContext.drawImage(this._containerImage,e.x-this.containerSize,e.y-this.containerSize,this.containerSize*2,this.containerSize*2):(i._VJCanvasContext.beginPath(),i._VJCanvasContext.strokeStyle=this._joystickColor,i._VJCanvasContext.lineWidth=2,i._VJCanvasContext.arc(e.x,e.y,this.containerSize,0,Math.PI*2,!0),i._VJCanvasContext.stroke(),i._VJCanvasContext.closePath(),i._VJCanvasContext.beginPath(),i._VJCanvasContext.lineWidth=6,i._VJCanvasContext.strokeStyle=this._joystickColor,i._VJCanvasContext.arc(e.x,e.y,this.puckSize,0,Math.PI*2,!0),i._VJCanvasContext.stroke(),i._VJCanvasContext.closePath())},i.prototype._drawPuck=function(){this._puckImage?i._VJCanvasContext.drawImage(this._puckImage,this._joystickPointerPos.x-this.puckSize,this._joystickPointerPos.y-this.puckSize,this.puckSize*2,this.puckSize*2):(i._VJCanvasContext.beginPath(),i._VJCanvasContext.strokeStyle=this._joystickColor,i._VJCanvasContext.lineWidth=2,i._VJCanvasContext.arc(this._joystickPointerPos.x,this._joystickPointerPos.y,this.puckSize,0,Math.PI*2,!0),i._VJCanvasContext.stroke(),i._VJCanvasContext.closePath())},i.prototype._drawVirtualJoystick=function(){var e=this;this.alwaysVisible&&this._drawContainer(),this.pressed&&this._touches.forEach(function(t,r){r.pointerId===e._joystickPointerId?(e.alwaysVisible||e._drawContainer(),e._drawPuck(),e._joystickPreviousPointerPos=e._joystickPointerPos.clone()):(i._VJCanvasContext.clearRect(r.prevX-44,r.prevY-44,88,88),i._VJCanvasContext.beginPath(),i._VJCanvasContext.fillStyle="white",i._VJCanvasContext.beginPath(),i._VJCanvasContext.strokeStyle="red",i._VJCanvasContext.lineWidth=6,i._VJCanvasContext.arc(r.x,r.y,40,0,Math.PI*2,!0),i._VJCanvasContext.stroke(),i._VJCanvasContext.closePath(),r.prevX=r.x,r.prevY=r.y)}),requestAnimationFrame(function(){e._drawVirtualJoystick()})},i.prototype.releaseCanvas=function(){i.Canvas&&(i.Canvas.removeEventListener("pointerdown",this._onPointerDownHandlerRef),i.Canvas.removeEventListener("pointermove",this._onPointerMoveHandlerRef),i.Canvas.removeEventListener("pointerup",this._onPointerUpHandlerRef),i.Canvas.removeEventListener("pointerout",this._onPointerUpHandlerRef),window.removeEventListener("resize",this._onResize),document.body.removeChild(i.Canvas),i.Canvas=null)},i._GlobalJoystickIndex=0,i._AlwaysVisibleSticks=0,i})();var Fc=function(){function i(e){this._pendingActions=new Array,this._workerInfos=e.map(function(t){return{workerPromise:Promise.resolve(t),idle:!0}})}return i.prototype.dispose=function(){for(var e=0,t=this._workerInfos;e<t.length;e++){var r=t[e];r.workerPromise.then(function(n){n.terminate()})}this._workerInfos.length=0,this._pendingActions.length=0},i.prototype.push=function(e){this._executeOnIdleWorker(e)||this._pendingActions.push(e)},i.prototype._executeOnIdleWorker=function(e){for(var t=0,r=this._workerInfos;t<r.length;t++){var n=r[t];if(n.idle)return this._execute(n,e),!0}return!1},i.prototype._execute=function(e,t){var r=this;e.idle=!1,e.workerPromise.then(function(n){t(n,function(){var a=r._pendingActions.shift();a?r._execute(e,a):e.idle=!0})})},i}(),wc=function(i){$(e,i);function e(t,r,n){n===void 0&&(n=e.DefaultOptions);var a=i.call(this,[])||this;return a._maxWorkers=t,a._createWorkerAsync=r,a._options=n,a}return e.prototype.push=function(t){if(!this._executeOnIdleWorker(t))if(this._workerInfos.length<this._maxWorkers){var r={workerPromise:this._createWorkerAsync(),idle:!1};this._workerInfos.push(r),this._execute(r,t)}else this._pendingActions.push(t)},e.prototype._execute=function(t,r){var n=this;t.timeoutId&&(clearTimeout(t.timeoutId),delete t.timeoutId),i.prototype._execute.call(this,t,function(a,s){r(a,function(){s(),t.idle&&(t.timeoutId=setTimeout(function(){t.workerPromise.then(function(l){l.terminate()});var o=n._workerInfos.indexOf(t);o!==-1&&n._workerInfos.splice(o,1)},n._options.idleTimeElapsedBeforeRelease))})})},e.DefaultOptions={idleTimeElapsedBeforeRelease:1e3},e}(Fc),Lc="fxaaPixelShader",Nc=`uniform sampler2D textureSampler;
uniform vec2 texelSize;
varying vec2 vUV;
varying vec2 sampleCoordS;
varying vec2 sampleCoordE;
varying vec2 sampleCoordN;
varying vec2 sampleCoordW;
varying vec2 sampleCoordNW;
varying vec2 sampleCoordSE;
varying vec2 sampleCoordNE;
varying vec2 sampleCoordSW;
const float fxaaQualitySubpix=1.0;
const float fxaaQualityEdgeThreshold=0.166;
const float fxaaQualityEdgeThresholdMin=0.0833;
const vec3 kLumaCoefficients=vec3(0.2126,0.7152,0.0722);
#define FxaaLuma(rgba) dot(rgba.rgb,kLumaCoefficients)
void main(){
vec2 posM;
posM.x=vUV.x;
posM.y=vUV.y;
vec4 rgbyM=texture2D(textureSampler,vUV,0.0);
float lumaM=FxaaLuma(rgbyM);
float lumaS=FxaaLuma(texture2D(textureSampler,sampleCoordS,0.0));
float lumaE=FxaaLuma(texture2D(textureSampler,sampleCoordE,0.0));
float lumaN=FxaaLuma(texture2D(textureSampler,sampleCoordN,0.0));
float lumaW=FxaaLuma(texture2D(textureSampler,sampleCoordW,0.0));
float maxSM=max(lumaS,lumaM);
float minSM=min(lumaS,lumaM);
float maxESM=max(lumaE,maxSM);
float minESM=min(lumaE,minSM);
float maxWN=max(lumaN,lumaW);
float minWN=min(lumaN,lumaW);
float rangeMax=max(maxWN,maxESM);
float rangeMin=min(minWN,minESM);
float rangeMaxScaled=rangeMax*fxaaQualityEdgeThreshold;
float range=rangeMax-rangeMin;
float rangeMaxClamped=max(fxaaQualityEdgeThresholdMin,rangeMaxScaled);
#ifndef MALI
if(range<rangeMaxClamped) 
{
gl_FragColor=rgbyM;
return;
}
#endif
float lumaNW=FxaaLuma(texture2D(textureSampler,sampleCoordNW,0.0));
float lumaSE=FxaaLuma(texture2D(textureSampler,sampleCoordSE,0.0));
float lumaNE=FxaaLuma(texture2D(textureSampler,sampleCoordNE,0.0));
float lumaSW=FxaaLuma(texture2D(textureSampler,sampleCoordSW,0.0));
float lumaNS=lumaN+lumaS;
float lumaWE=lumaW+lumaE;
float subpixRcpRange=1.0/range;
float subpixNSWE=lumaNS+lumaWE;
float edgeHorz1=(-2.0*lumaM)+lumaNS;
float edgeVert1=(-2.0*lumaM)+lumaWE;
float lumaNESE=lumaNE+lumaSE;
float lumaNWNE=lumaNW+lumaNE;
float edgeHorz2=(-2.0*lumaE)+lumaNESE;
float edgeVert2=(-2.0*lumaN)+lumaNWNE;
float lumaNWSW=lumaNW+lumaSW;
float lumaSWSE=lumaSW+lumaSE;
float edgeHorz4=(abs(edgeHorz1)*2.0)+abs(edgeHorz2);
float edgeVert4=(abs(edgeVert1)*2.0)+abs(edgeVert2);
float edgeHorz3=(-2.0*lumaW)+lumaNWSW;
float edgeVert3=(-2.0*lumaS)+lumaSWSE;
float edgeHorz=abs(edgeHorz3)+edgeHorz4;
float edgeVert=abs(edgeVert3)+edgeVert4;
float subpixNWSWNESE=lumaNWSW+lumaNESE;
float lengthSign=texelSize.x;
bool horzSpan=edgeHorz>=edgeVert;
float subpixA=subpixNSWE*2.0+subpixNWSWNESE;
if (!horzSpan)
{
lumaN=lumaW;
}
if (!horzSpan) 
{
lumaS=lumaE;
}
if (horzSpan) 
{
lengthSign=texelSize.y;
}
float subpixB=(subpixA*(1.0/12.0))-lumaM;
float gradientN=lumaN-lumaM;
float gradientS=lumaS-lumaM;
float lumaNN=lumaN+lumaM;
float lumaSS=lumaS+lumaM;
bool pairN=abs(gradientN)>=abs(gradientS);
float gradient=max(abs(gradientN),abs(gradientS));
if (pairN)
{
lengthSign=-lengthSign;
}
float subpixC=clamp(abs(subpixB)*subpixRcpRange,0.0,1.0);
vec2 posB;
posB.x=posM.x;
posB.y=posM.y;
vec2 offNP;
offNP.x=(!horzSpan) ? 0.0 : texelSize.x;
offNP.y=(horzSpan) ? 0.0 : texelSize.y;
if (!horzSpan) 
{
posB.x+=lengthSign*0.5;
}
if (horzSpan)
{
posB.y+=lengthSign*0.5;
}
vec2 posN;
posN.x=posB.x-offNP.x*1.5;
posN.y=posB.y-offNP.y*1.5;
vec2 posP;
posP.x=posB.x+offNP.x*1.5;
posP.y=posB.y+offNP.y*1.5;
float subpixD=((-2.0)*subpixC)+3.0;
float lumaEndN=FxaaLuma(texture2D(textureSampler,posN,0.0));
float subpixE=subpixC*subpixC;
float lumaEndP=FxaaLuma(texture2D(textureSampler,posP,0.0));
if (!pairN) 
{
lumaNN=lumaSS;
}
float gradientScaled=gradient*1.0/4.0;
float lumaMM=lumaM-lumaNN*0.5;
float subpixF=subpixD*subpixE;
bool lumaMLTZero=lumaMM<0.0;
lumaEndN-=lumaNN*0.5;
lumaEndP-=lumaNN*0.5;
bool doneN=abs(lumaEndN)>=gradientScaled;
bool doneP=abs(lumaEndP)>=gradientScaled;
if (!doneN) 
{
posN.x-=offNP.x*3.0;
}
if (!doneN) 
{
posN.y-=offNP.y*3.0;
}
bool doneNP=(!doneN) || (!doneP);
if (!doneP) 
{
posP.x+=offNP.x*3.0;
}
if (!doneP)
{
posP.y+=offNP.y*3.0;
}
if (doneNP)
{
if (!doneN) lumaEndN=FxaaLuma(texture2D(textureSampler,posN.xy,0.0));
if (!doneP) lumaEndP=FxaaLuma(texture2D(textureSampler,posP.xy,0.0));
if (!doneN) lumaEndN=lumaEndN-lumaNN*0.5;
if (!doneP) lumaEndP=lumaEndP-lumaNN*0.5;
doneN=abs(lumaEndN)>=gradientScaled;
doneP=abs(lumaEndP)>=gradientScaled;
if (!doneN) posN.x-=offNP.x*12.0;
if (!doneN) posN.y-=offNP.y*12.0;
doneNP=(!doneN) || (!doneP);
if (!doneP) posP.x+=offNP.x*12.0;
if (!doneP) posP.y+=offNP.y*12.0;
}
float dstN=posM.x-posN.x;
float dstP=posP.x-posM.x;
if (!horzSpan)
{
dstN=posM.y-posN.y;
}
if (!horzSpan) 
{
dstP=posP.y-posM.y;
}
bool goodSpanN=(lumaEndN<0.0) != lumaMLTZero;
float spanLength=(dstP+dstN);
bool goodSpanP=(lumaEndP<0.0) != lumaMLTZero;
float spanLengthRcp=1.0/spanLength;
bool directionN=dstN<dstP;
float dst=min(dstN,dstP);
bool goodSpan=directionN ? goodSpanN : goodSpanP;
float subpixG=subpixF*subpixF;
float pixelOffset=(dst*(-spanLengthRcp))+0.5;
float subpixH=subpixG*fxaaQualitySubpix;
float pixelOffsetGood=goodSpan ? pixelOffset : 0.0;
float pixelOffsetSubpix=max(pixelOffsetGood,subpixH);
if (!horzSpan)
{
posM.x+=pixelOffsetSubpix*lengthSign;
}
if (horzSpan)
{
posM.y+=pixelOffsetSubpix*lengthSign;
}
#ifdef MALI
if(range<rangeMaxClamped) 
{
gl_FragColor=rgbyM;
}
else
{
gl_FragColor=texture2D(textureSampler,posM,0.0);
}
#else
gl_FragColor=texture2D(textureSampler,posM,0.0);
#endif
}`;q.ShadersStore[Lc]=Nc;var Bc="fxaaVertexShader",Uc=`attribute vec2 position;
uniform vec2 texelSize;
varying vec2 vUV;
varying vec2 sampleCoordS;
varying vec2 sampleCoordE;
varying vec2 sampleCoordN;
varying vec2 sampleCoordW;
varying vec2 sampleCoordNW;
varying vec2 sampleCoordSE;
varying vec2 sampleCoordNE;
varying vec2 sampleCoordSW;
const vec2 madd=vec2(0.5,0.5);
#define CUSTOM_VERTEX_DEFINITIONS
void main(void) {
#define CUSTOM_VERTEX_MAIN_BEGIN
vUV=(position*madd+madd);
sampleCoordS=vUV+vec2( 0.0,1.0)*texelSize;
sampleCoordE=vUV+vec2( 1.0,0.0)*texelSize;
sampleCoordN=vUV+vec2( 0.0,-1.0)*texelSize;
sampleCoordW=vUV+vec2(-1.0,0.0)*texelSize;
sampleCoordNW=vUV+vec2(-1.0,-1.0)*texelSize;
sampleCoordSE=vUV+vec2( 1.0,1.0)*texelSize;
sampleCoordNE=vUV+vec2( 1.0,-1.0)*texelSize;
sampleCoordSW=vUV+vec2(-1.0,1.0)*texelSize;
gl_Position=vec4(position,0.0,1.0);
#define CUSTOM_VERTEX_MAIN_END
}`;q.ShadersStore[Bc]=Uc;var Zs=function(i){$(e,i);function e(t,r,n,a,s,o,l){n===void 0&&(n=null),l===void 0&&(l=0);var u=i.call(this,t,"fxaa",["texelSize"],null,r,n,a||re.BILINEAR_SAMPLINGMODE,s,o,null,l,"fxaa",void 0,!0)||this,f=u._getDefines();return u.updateEffect(f),u.onApplyObservable.add(function(h){var c=u.texelSize;h.setFloat2("texelSize",c.x,c.y)}),u}return e.prototype.getClassName=function(){return"FxaaPostProcess"},e.prototype._getDefines=function(){var t=this.getEngine();if(!t)return null;var r=t.getGlInfo();return r&&r.renderer&&r.renderer.toLowerCase().indexOf("mali")>-1?`#define MALI 1
`:null},e._Parse=function(t,r,n,a){return pe.Parse(function(){return new e(t.name,t.options,r,t.renderTargetSamplingMode,n.getEngine(),t.reusable)},t,n,a)},e}(St);We("BABYLON.FxaaPostProcess",Zs);function Qs(i,e,t,r,n,a){n===void 0&&(n="image/png"),a===void 0&&(a=!1);var s=Js(i,e,t),o=s.height,l=s.width;if(!(o&&l)){Y.Error("Invalid 'size' parameter !");return}te._ScreenshotCanvas||(te._ScreenshotCanvas=document.createElement("canvas")),te._ScreenshotCanvas.width=l,te._ScreenshotCanvas.height=o;var u=te._ScreenshotCanvas.getContext("2d"),f=i.getRenderWidth()/i.getRenderHeight(),h=l,c=h/f;c>o&&(c=o,h=c*f);var d=Math.max(0,l-h)/2,p=Math.max(0,o-c)/2;i.onEndFrameObservable.addOnce(function(){var _=i.getRenderingCanvas();u&&_&&u.drawImage(_,d,p,h,c),a?(te.EncodeScreenshotCanvasData(void 0,n),r&&r("")):te.EncodeScreenshotCanvasData(r,n)})}function Vc(i,e,t,r){return r===void 0&&(r="image/png"),new Promise(function(n,a){Qs(i,e,t,function(s){typeof s!="undefined"?n(s):a(new Error("Data is undefined"))},r)})}function $s(i,e,t,r,n,a,s,o,l,u){n===void 0&&(n="image/png"),a===void 0&&(a=1),s===void 0&&(s=!1),l===void 0&&(l=!1),u===void 0&&(u=!1);var f=Js(i,e,t),h=f.height,c=f.width,d={width:c,height:h};if(!(h&&c)){Y.Error("Invalid 'size' parameter !");return}var p=e.getScene(),_=null,g=p.activeCameras;p.activeCameras=null,p.activeCamera!==e&&(_=p.activeCamera,p.activeCamera=e),p.render();var v=new ur("screenShot",d,p,!1,!1,0,!1,re.NEAREST_SAMPLINGMODE,void 0,u,void 0,void 0,void 0,a);v.renderList=null,v.samples=a,v.renderSprites=l,i.onEndFrameObservable.addOnce(function(){v.readPixels(void 0,void 0,void 0,!1).then(function(E){te.DumpData(c,h,E,r,n,o,!0),v.dispose()})});var y=function(){p.incrementRenderId(),p.resetCachedMaterial(),v.render(!0),p.incrementRenderId(),p.resetCachedMaterial(),_&&(p.activeCamera=_),p.activeCameras=g,e.getProjectionMatrix(!0),p.render()};if(s){var b=new Zs("antialiasing",1,p.activeCamera);v.addPostProcess(b),b.getEffect().isReady()?y():b.getEffect().onCompiled=function(){y()}}else y()}function kc(i,e,t,r,n,a,s,o){return r===void 0&&(r="image/png"),n===void 0&&(n=1),a===void 0&&(a=!1),o===void 0&&(o=!1),new Promise(function(l,u){$s(i,e,t,function(f){typeof f!="undefined"?l(f):u(new Error("Data is undefined"))},r,n,a,s,o)})}function Js(i,e,t){var r=0,n=0;if(typeof t=="object"){var a=t.precision?Math.abs(t.precision):1;t.width&&t.height?(r=t.height*a,n=t.width*a):t.width&&!t.height?(n=t.width*a,r=Math.round(n/i.getAspectRatio(e))):t.height&&!t.width?(r=t.height*a,n=Math.round(r*i.getAspectRatio(e))):(n=Math.round(i.getRenderWidth()*a),r=Math.round(n/i.getAspectRatio(e)))}else isNaN(t)||(r=t,n=t);return n&&(n=Math.floor(n)),r&&(r=Math.floor(r)),{height:r|0,width:n|0}}var Gc=function(){te.CreateScreenshot=Qs,te.CreateScreenshotAsync=Vc,te.CreateScreenshotUsingRenderTarget=$s,te.CreateScreenshotUsingRenderTargetAsync=kc};Gc();var ya;(function(i){i[i.Checkbox=0]="Checkbox",i[i.Slider=1]="Slider",i[i.Vector3=2]="Vector3",i[i.Quaternion=3]="Quaternion",i[i.Color3=4]="Color3",i[i.String=5]="String",i[i.Button=6]="Button",i[i.Options=7]="Options",i[i.Tab=8]="Tab"})(ya||(ya={}));var zc=function(){function i(e,t,r){this.gradient=e,this.color1=t,this.color2=r}return i.prototype.getColorToRef=function(e){if(!this.color2){e.copyFrom(this.color1);return}ce.LerpToRef(this.color1,this.color2,Math.random(),e)},i}(),Wc=function(){function i(e,t){this.gradient=e,this.color=t}return i}(),Hc=function(){function i(e,t,r){this.gradient=e,this.factor1=t,this.factor2=r}return i.prototype.getFactor=function(){return this.factor2===void 0||this.factor2===this.factor1?this.factor1:this.factor1+(this.factor2-this.factor1)*Math.random()},i}(),_t=function(){function i(){}return i.GetCurrentGradient=function(e,t,r){if(t[0].gradient>e){r(t[0],t[0],1);return}for(var n=0;n<t.length-1;n++){var a=t[n],s=t[n+1];if(e>=a.gradient&&e<=s.gradient){var o=(e-a.gradient)/(s.gradient-a.gradient);r(a,s,o);return}}var l=t.length-1;r(t[l],t[l],1)},i}(),Op=function(){function i(e){this.byteOffset=0,this.buffer=e}return i.prototype.loadAsync=function(e){var t=this;return this.buffer.readAsync(this.byteOffset,e).then(function(r){t._dataView=new DataView(r.buffer,r.byteOffset,r.byteLength),t._dataByteOffset=0})},i.prototype.readUint32=function(){var e=this._dataView.getUint32(this._dataByteOffset,!0);return this._dataByteOffset+=4,this.byteOffset+=4,e},i.prototype.readUint8Array=function(e){var t=new Uint8Array(this._dataView.buffer,this._dataView.byteOffset+this._dataByteOffset,e);return this._dataByteOffset+=e,this.byteOffset+=e,t},i.prototype.readString=function(e){return Ia(this.readUint8Array(e))},i.prototype.skipBytes=function(e){this._dataByteOffset+=e,this.byteOffset+=e},i}(),Xc="minmaxReduxPixelShader",jc=`varying vec2 vUV;
uniform sampler2D textureSampler;
#if defined(INITIAL)
uniform sampler2D sourceTexture;
uniform vec2 texSize;
void main(void)
{
ivec2 coord=ivec2(vUV*(texSize-1.0));
float f1=texelFetch(sourceTexture,coord,0).r;
float f2=texelFetch(sourceTexture,coord+ivec2(1,0),0).r;
float f3=texelFetch(sourceTexture,coord+ivec2(1,1),0).r;
float f4=texelFetch(sourceTexture,coord+ivec2(0,1),0).r;
float minz=min(min(min(f1,f2),f3),f4);
#ifdef DEPTH_REDUX
float maxz=max(max(max(sign(1.0-f1)*f1,sign(1.0-f2)*f2),sign(1.0-f3)*f3),sign(1.0-f4)*f4);
#else
float maxz=max(max(max(f1,f2),f3),f4);
#endif
glFragColor=vec4(minz,maxz,0.,0.);
}
#elif defined(MAIN)
uniform vec2 texSize;
void main(void)
{
ivec2 coord=ivec2(vUV*(texSize-1.0));
vec2 f1=texelFetch(textureSampler,coord,0).rg;
vec2 f2=texelFetch(textureSampler,coord+ivec2(1,0),0).rg;
vec2 f3=texelFetch(textureSampler,coord+ivec2(1,1),0).rg;
vec2 f4=texelFetch(textureSampler,coord+ivec2(0,1),0).rg;
float minz=min(min(min(f1.x,f2.x),f3.x),f4.x);
float maxz=max(max(max(f1.y,f2.y),f3.y),f4.y);
glFragColor=vec4(minz,maxz,0.,0.);
}
#elif defined(ONEBEFORELAST)
uniform ivec2 texSize;
void main(void)
{
ivec2 coord=ivec2(vUV*vec2(texSize-1));
vec2 f1=texelFetch(textureSampler,coord % texSize,0).rg;
vec2 f2=texelFetch(textureSampler,(coord+ivec2(1,0)) % texSize,0).rg;
vec2 f3=texelFetch(textureSampler,(coord+ivec2(1,1)) % texSize,0).rg;
vec2 f4=texelFetch(textureSampler,(coord+ivec2(0,1)) % texSize,0).rg;
float minz=min(f1.x,f2.x);
float maxz=max(f1.y,f2.y);
glFragColor=vec4(minz,maxz,0.,0.);
}
#elif defined(LAST)
void main(void)
{
glFragColor=vec4(0.);
if (true) { 
discard;
}
}
#endif
`;q.ShadersStore[Xc]=jc;var Kc=function(){function i(e){var t=this;this.onAfterReductionPerformed=new X,this._forceFullscreenViewport=!0,this._activated=!1,this._camera=e,this._postProcessManager=new $r(e.getScene()),this._onContextRestoredObserver=e.getEngine().onContextRestoredObservable.add(function(){t._postProcessManager._rebuild()})}return Object.defineProperty(i.prototype,"sourceTexture",{get:function(){return this._sourceTexture},enumerable:!1,configurable:!0}),i.prototype.setSourceTexture=function(e,t,r,n){var a=this;if(r===void 0&&(r=2),n===void 0&&(n=!0),e!==this._sourceTexture){this.dispose(!1),this._sourceTexture=e,this._reductionSteps=[],this._forceFullscreenViewport=n;var s=this._camera.getScene(),o=new St("Initial reduction phase","minmaxRedux",["texSize"],["sourceTexture"],1,null,1,s.getEngine(),!1,"#define INITIAL"+(t?`
#define DEPTH_REDUX`:""),r,void 0,void 0,void 0,7);o.autoClear=!1,o.forceFullscreenViewport=n;var l=this._sourceTexture.getRenderWidth(),u=this._sourceTexture.getRenderHeight();o.onApply=function(d,p){return function(_){_.setTexture("sourceTexture",a._sourceTexture),_.setFloat2("texSize",d,p)}}(l,u),this._reductionSteps.push(o);for(var f=1;l>1||u>1;){l=Math.max(Math.round(l/2),1),u=Math.max(Math.round(u/2),1);var h=new St("Reduction phase "+f,"minmaxRedux",["texSize"],null,{width:l,height:u},null,1,s.getEngine(),!1,"#define "+(l==1&&u==1?"LAST":l==1||u==1?"ONEBEFORELAST":"MAIN"),r,void 0,void 0,void 0,7);if(h.autoClear=!1,h.forceFullscreenViewport=n,h.onApply=function(d,p){return function(_){d==1||p==1?_.setInt2("texSize",d,p):_.setFloat2("texSize",d,p)}}(l,u),this._reductionSteps.push(h),f++,l==1&&u==1){var c=function(d,p,_){var g=new Float32Array(4*d*p),v={min:0,max:0};return function(){s.getEngine()._readTexturePixels(_.inputTexture.texture,d,p,-1,0,g,!1),v.min=g[0],v.max=g[1],a.onAfterReductionPerformed.notifyObservers(v)}};h.onAfterRenderObservable.add(c(l,u,h))}}}},Object.defineProperty(i.prototype,"refreshRate",{get:function(){return this._sourceTexture?this._sourceTexture.refreshRate:-1},set:function(e){this._sourceTexture&&(this._sourceTexture.refreshRate=e)},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"activated",{get:function(){return this._activated},enumerable:!1,configurable:!0}),i.prototype.activate=function(){var e=this;this._onAfterUnbindObserver||!this._sourceTexture||(this._onAfterUnbindObserver=this._sourceTexture.onAfterUnbindObservable.add(function(){var t,r,n=e._camera.getScene().getEngine();(t=n._debugPushGroup)===null||t===void 0||t.call(n,"min max reduction",1),e._reductionSteps[0].activate(e._camera),e._postProcessManager.directRender(e._reductionSteps,e._reductionSteps[0].inputTexture,e._forceFullscreenViewport),n.unBindFramebuffer(e._reductionSteps[0].inputTexture,!1),(r=n._debugPopGroup)===null||r===void 0||r.call(n,1)}),this._activated=!0)},i.prototype.deactivate=function(){!this._onAfterUnbindObserver||!this._sourceTexture||(this._sourceTexture.onAfterUnbindObservable.remove(this._onAfterUnbindObserver),this._onAfterUnbindObserver=null,this._activated=!1)},i.prototype.dispose=function(e){if(e===void 0&&(e=!0),e&&(this.onAfterReductionPerformed.clear(),this._onContextRestoredObserver&&(this._camera.getEngine().onContextRestoredObservable.remove(this._onContextRestoredObserver),this._onContextRestoredObserver=null)),this.deactivate(),this._reductionSteps){for(var t=0;t<this._reductionSteps.length;++t)this._reductionSteps[t].dispose();this._reductionSteps=null}this._postProcessManager&&e&&this._postProcessManager.dispose(),this._sourceTexture=null},i}(),Yc="packingFunctions",qc=`vec4 pack(float depth)
{
const vec4 bit_shift=vec4(255.0*255.0*255.0,255.0*255.0,255.0,1.0);
const vec4 bit_mask=vec4(0.0,1.0/255.0,1.0/255.0,1.0/255.0);
vec4 res=fract(depth*bit_shift);
res-=res.xxyz*bit_mask;
return res;
}
float unpack(vec4 color)
{
const vec4 bit_shift=vec4(1.0/(255.0*255.0*255.0),1.0/(255.0*255.0),1.0/255.0,1.0);
return dot(color,bit_shift);
}`;q.IncludesShadersStore[Yc]=qc;var Zc="depthPixelShader",Qc=`#ifdef ALPHATEST
varying vec2 vUV;
uniform sampler2D diffuseSampler;
#endif
varying float vDepthMetric;
#ifdef PACKED
#include<packingFunctions>
#endif
#define CUSTOM_FRAGMENT_DEFINITIONS
void main(void)
{
#ifdef ALPHATEST
if (texture2D(diffuseSampler,vUV).a<0.4)
discard;
#endif
#ifdef NONLINEARDEPTH
#ifdef PACKED
gl_FragColor=pack(gl_FragCoord.z);
#else
gl_FragColor=vec4(gl_FragCoord.z,0.0,0.0,0.0);
#endif
#else
#ifdef PACKED
gl_FragColor=pack(vDepthMetric);
#else
gl_FragColor=vec4(vDepthMetric,0.0,0.0,1.0);
#endif
#endif
}`;q.ShadersStore[Zc]=Qc;var $c="depthVertexShader",Jc=`attribute vec3 position;
#include<bonesDeclaration>
#include<bakedVertexAnimationDeclaration>
#include<morphTargetsVertexGlobalDeclaration>
#include<morphTargetsVertexDeclaration>[0..maxSimultaneousMorphTargets]
#include<instancesDeclaration>
uniform mat4 viewProjection;
uniform vec2 depthValues;
#if defined(ALPHATEST) || defined(NEED_UV)
varying vec2 vUV;
uniform mat4 diffuseMatrix;
#ifdef UV1
attribute vec2 uv;
#endif
#ifdef UV2
attribute vec2 uv2;
#endif
#endif
varying float vDepthMetric;
#define CUSTOM_VERTEX_DEFINITIONS
void main(void)
{
vec3 positionUpdated=position;
#ifdef UV1
vec2 uvUpdated=uv;
#endif
#include<morphTargetsVertexGlobal>
#include<morphTargetsVertex>[0..maxSimultaneousMorphTargets]
#include<instancesVertex>
#include<bonesVertex>
#include<bakedVertexAnimation>
gl_Position=viewProjection*finalWorld*vec4(positionUpdated,1.0);
#ifdef USE_REVERSE_DEPTHBUFFER
vDepthMetric=((-gl_Position.z+depthValues.x)/(depthValues.y));
#else
vDepthMetric=((gl_Position.z+depthValues.x)/(depthValues.y));
#endif
#if defined(ALPHATEST) || defined(BASIC_RENDER)
#ifdef UV1
vUV=vec2(diffuseMatrix*vec4(uvUpdated,1.0,0.0));
#endif
#ifdef UV2
vUV=vec2(diffuseMatrix*vec4(uv2,1.0,0.0));
#endif
#endif
}
`;q.ShadersStore[$c]=Jc;var ed=function(){function i(e,t,r,n,a){t===void 0&&(t=1),r===void 0&&(r=null),n===void 0&&(n=!1),a===void 0&&(a=re.TRILINEAR_SAMPLINGMODE);var s=this;this.enabled=!0,this.forceDepthWriteTransparentMeshes=!1,this.useOnlyInActiveCamera=!1,this._scene=e,this._storeNonLinearDepth=n,this.isPacked=t===0,this.isPacked?this._clearColor=new ce(1,1,1,1):this._clearColor=new ce(1,0,0,1),i._SceneComponentInitialization(this._scene);var o=e.getEngine();this._camera=r,a!==re.NEAREST_SAMPLINGMODE&&(t===1&&!o._caps.textureFloatLinearFiltering&&(a=re.NEAREST_SAMPLINGMODE),t===2&&!o._caps.textureHalfFloatLinearFiltering&&(a=re.NEAREST_SAMPLINGMODE));var l=this.isPacked||!o._features.supportExtendedTextureFormats?5:6;this._depthMap=new ur("DepthRenderer",{width:o.getRenderWidth(),height:o.getRenderHeight()},this._scene,!1,!0,t,!1,a,void 0,void 0,void 0,l),this._depthMap.wrapU=re.CLAMP_ADDRESSMODE,this._depthMap.wrapV=re.CLAMP_ADDRESSMODE,this._depthMap.refreshRate=1,this._depthMap.renderParticles=!1,this._depthMap.renderList=null,this._depthMap.activeCamera=this._camera,this._depthMap.ignoreCameraViewport=!0,this._depthMap.useCameraPostProcesses=!1,this._depthMap.onClearObservable.add(function(f){f.clear(s._clearColor,!0,!0,!0)}),this._depthMap.onBeforeBindObservable.add(function(){var f;(f=o._debugPushGroup)===null||f===void 0||f.call(o,"depth renderer",1)}),this._depthMap.onAfterUnbindObservable.add(function(){var f;(f=o._debugPopGroup)===null||f===void 0||f.call(o,1)}),this._depthMap.customIsReadyFunction=function(f,h){if(!f.isReady(!1))return!1;if(h===0&&f.subMeshes)for(var c=0;c<f.subMeshes.length;++c){var d=f.subMeshes[c],p=d.getRenderingMesh(),_=p._getInstancesRenderList(d._id,!!d.getReplacementMesh()),g=o.getCaps().instancedArrays&&(_.visibleInstances[d._id]!==null&&_.visibleInstances[d._id]!==void 0||p.hasThinInstances);if(!s.isReady(d,g))return!1}return!0};var u=function(f){var h,c,d=f.getRenderingMesh(),p=f.getEffectiveMesh(),_=s._scene,g=_.getEngine(),v=f.getMaterial();if(p._internalAbstractMeshDataInfo._isActiveIntermediate=!1,!(!v||p.infiniteDistance||v.disableDepthWrite||f.verticesCount===0||f._renderId===_.getRenderId())){var y=p._getWorldMatrixDeterminant()<0,b=(h=d.overrideMaterialSideOrientation)!==null&&h!==void 0?h:v.sideOrientation;y&&(b=b===0?1:0);var E=b===0;g.setState(v.backFaceCulling,0,!1,E,v.cullBackFaces);var A=d._getInstancesRenderList(f._id,!!f.getReplacementMesh());if(!A.mustReturn){var S=g.getCaps().instancedArrays&&(A.visibleInstances[f._id]!==null&&A.visibleInstances[f._id]!==void 0||d.hasThinInstances),T=s._camera||_.activeCamera;if(s.isReady(f,S)&&T){f._renderId=_.getRenderId();var M=(c=p._internalAbstractMeshDataInfo._materialForRenderPass)===null||c===void 0?void 0:c[g.currentRenderPassId],D=f._getDrawWrapper();!D&&M&&(D=M._getDrawWrapper());var x=T.mode===Ne.ORTHOGRAPHIC_CAMERA;if(!D)return;var P=D.effect;g.enableEffect(D),S||d._bind(f,P,v.fillMode),M?M.bindForSubMesh(p.getWorldMatrix(),p,f):(P.setMatrix("viewProjection",_.getTransformMatrix()),P.setMatrix("world",p.getWorldMatrix()));var w=void 0,k=void 0;if(x?(w=!g.useReverseDepthBuffer&&g.isNDCHalfZRange?0:1,k=g.useReverseDepthBuffer&&g.isNDCHalfZRange?0:1):(w=g.useReverseDepthBuffer&&g.isNDCHalfZRange?T.minZ:g.isNDCHalfZRange?0:T.minZ,k=g.useReverseDepthBuffer&&g.isNDCHalfZRange?0:T.maxZ),P.setFloat2("depthValues",w,w+k),!M){if(v&&v.needAlphaTesting()){var B=v.getAlphaTestTexture();B&&(P.setTexture("diffuseSampler",B),P.setMatrix("diffuseMatrix",B.getTextureMatrix()))}if(d.useBones&&d.computeBonesUsingShaders&&d.skeleton){var L=d.skeleton;if(L.isUsingTextureForMatrices){var H=L.getTransformMatrixTexture(d);if(!H)return;P.setTexture("boneSampler",H),P.setFloat("boneTextureWidth",4*(L.bones.length+1))}else P.setMatrices("mBones",L.getTransformMatrices(d))}le.BindMorphTargetParameters(d,P),d.morphTargetManager&&d.morphTargetManager.isUsingTextureForTargets&&d.morphTargetManager._bind(P)}d._processRendering(p,f,P,v.fillMode,A,S,function(W,F){return P.setMatrix("world",F)})}}}};this._depthMap.customRenderFunction=function(f,h,c,d){var p;if(d.length)for(p=0;p<d.length;p++)u(d.data[p]);for(p=0;p<f.length;p++)u(f.data[p]);for(p=0;p<h.length;p++)u(h.data[p]);if(s.forceDepthWriteTransparentMeshes)for(p=0;p<c.length;p++)u(c.data[p]);else for(p=0;p<c.length;p++)c.data[p].getEffectiveMesh()._internalAbstractMeshDataInfo._isActiveIntermediate=!1}}return i.prototype.setMaterialForRendering=function(e,t){this._depthMap.setMaterialForRendering(e,t)},i.prototype.isReady=function(e,t){var r,n=this._scene.getEngine(),a=e.getMesh(),s=(r=a._internalAbstractMeshDataInfo._materialForRenderPass)===null||r===void 0?void 0:r[n.currentRenderPassId];if(s)return s.isReadyForSubMesh(a,e,t);var o=e.getMaterial();if(!o||o.disableDepthWrite)return!1;var l=[],u=[R.PositionKind];if(o&&o.needAlphaTesting()&&o.getAlphaTestTexture()&&(l.push("#define ALPHATEST"),a.isVerticesDataPresent(R.UVKind)&&(u.push(R.UVKind),l.push("#define UV1")),a.isVerticesDataPresent(R.UV2Kind)&&(u.push(R.UV2Kind),l.push("#define UV2"))),a.useBones&&a.computeBonesUsingShaders){u.push(R.MatricesIndicesKind),u.push(R.MatricesWeightsKind),a.numBoneInfluencers>4&&(u.push(R.MatricesIndicesExtraKind),u.push(R.MatricesWeightsExtraKind)),l.push("#define NUM_BONE_INFLUENCERS "+a.numBoneInfluencers),l.push("#define BonesPerMesh "+(a.skeleton?a.skeleton.bones.length+1:0));var f=e.getRenderingMesh().skeleton;f!=null&&f.isUsingTextureForMatrices&&l.push("#define BONETEXTURE")}else l.push("#define NUM_BONE_INFLUENCERS 0");var h=a.morphTargetManager,c=0;h&&h.numInfluencers>0&&(c=h.numInfluencers,l.push("#define MORPHTARGETS"),l.push("#define NUM_MORPH_INFLUENCERS "+c),h.isUsingTextureForTargets&&l.push("#define MORPHTARGETS_TEXTURE"),le.PrepareAttributesForMorphTargetsInfluencers(u,a,c)),t&&(l.push("#define INSTANCES"),le.PushAttributesForInstances(u),e.getRenderingMesh().hasThinInstances&&l.push("#define THIN_INSTANCES")),this._storeNonLinearDepth&&l.push("#define NONLINEARDEPTH"),this.isPacked&&l.push("#define PACKED");var d=e._getDrawWrapper(void 0,!0),p=d.defines,_=l.join(`
`);return p!==_&&d.setEffect(n.createEffect("depth",u,["world","mBones","boneTextureWidth","viewProjection","diffuseMatrix","depthValues","morphTargetInfluences","morphTargetTextureInfo","morphTargetTextureIndices"],["diffuseSampler","morphTargets","boneSampler"],_,void 0,void 0,void 0,{maxSimultaneousMorphTargets:c}),_),d.effect.isReady()},i.prototype.getDepthMap=function(){return this._depthMap},i.prototype.dispose=function(){var e=[];for(var t in this._scene._depthRenderer){var r=this._scene._depthRenderer[t];r===this&&e.push(t)}if(e.length>0){this._depthMap.dispose();for(var n=0,a=e;n<a.length;n++){var t=a[n];delete this._scene._depthRenderer[t]}}},i._SceneComponentInitialization=function(e){throw he("DepthRendererSceneComponent")},i}();(function(i){$(e,i);function e(t){return i.call(this,t)||this}return Object.defineProperty(e.prototype,"depthRenderer",{get:function(){return this._depthRenderer},enumerable:!1,configurable:!0}),e.prototype.setDepthRenderer=function(t,r,n){t===void 0&&(t=null),r===void 0&&(r=2),n===void 0&&(n=!0);var a=this._camera.getScene();this._depthRenderer&&(delete a._depthRenderer[this._depthRendererId],this._depthRenderer.dispose(),this._depthRenderer=null),t===null&&(a._depthRenderer||(a._depthRenderer={}),t=this._depthRenderer=new ed(a,r,this._camera,!1,1),t.enabled=!1,this._depthRendererId="minmax"+this._camera.id,a._depthRenderer[this._depthRendererId]=t),i.prototype.setSourceTexture.call(this,t.getDepthMap(),!0,r,n)},e.prototype.setSourceTexture=function(t,r,n,a){n===void 0&&(n=2),a===void 0&&(a=!0),i.prototype.setSourceTexture.call(this,t,r,n,a)},e.prototype.activate=function(){this._depthRenderer&&(this._depthRenderer.enabled=!0),i.prototype.activate.call(this)},e.prototype.deactivate=function(){i.prototype.deactivate.call(this),this._depthRenderer&&(this._depthRenderer.enabled=!1)},e.prototype.dispose=function(t){if(t===void 0&&(t=!0),i.prototype.dispose.call(this,t),this._depthRenderer&&t){var r=this._depthRenderer.getDepthMap().getScene();r&&delete r._depthRenderer[this._depthRendererId],this._depthRenderer.dispose(),this._depthRenderer=null}},e})(Kc);(function(){function i(){}return i._GetStorage=function(){try{return localStorage.setItem("test",""),localStorage.removeItem("test"),localStorage}catch{var e={};return{getItem:function(r){var n=e[r];return n===void 0?null:n},setItem:function(r,n){e[r]=n}}}},i.ReadString=function(e,t){var r=this._Storage.getItem(e);return r!==null?r:t},i.WriteString=function(e,t){this._Storage.setItem(e,t)},i.ReadBoolean=function(e,t){var r=this._Storage.getItem(e);return r!==null?r==="true":t},i.WriteBoolean=function(e,t){this._Storage.setItem(e,t?"true":"false")},i.ReadNumber=function(e,t){var r=this._Storage.getItem(e);return r!==null?parseFloat(r):t},i.WriteNumber=function(e,t){this._Storage.setItem(e,t.toString())},i._Storage=i._GetStorage(),i})();var ba=function(i){$(e,i);function e(t,r,n,a,s,o,l){n===void 0&&(n=null),a===void 0&&(a=null),s===void 0&&(s=null),o===void 0&&(o=null),l===void 0&&(l=null);var u=i.call(this,t,r.getScene())||this;return u.name=t,u.children=new Array,u.animations=new Array,u._index=null,u._absoluteTransform=new G,u._invertedAbsoluteTransform=new G,u._scalingDeterminant=1,u._worldTransform=new G,u._needToDecompose=!0,u._needToCompose=!1,u._linkedTransformNode=null,u._waitingTransformNodeId=null,u._skeleton=r,u._localMatrix=a?a.clone():G.Identity(),u._restPose=s||u._localMatrix.clone(),u._baseMatrix=o||u._localMatrix.clone(),u._index=l,r.bones.push(u),u.setParent(n,!1),(o||a)&&u._updateDifferenceMatrix(),u}return Object.defineProperty(e.prototype,"_matrix",{get:function(){return this._compose(),this._localMatrix},set:function(t){this._needToCompose=!1,t.updateFlag!==this._localMatrix.updateFlag&&(this._localMatrix.copyFrom(t),this._markAsDirtyAndDecompose())},enumerable:!1,configurable:!0}),e.prototype.getClassName=function(){return"Bone"},e.prototype.getSkeleton=function(){return this._skeleton},Object.defineProperty(e.prototype,"parent",{get:function(){return this._parentNode},set:function(t){this.setParent(t)},enumerable:!1,configurable:!0}),e.prototype.getParent=function(){return this.parent},e.prototype.getChildren=function(){return this.children},e.prototype.getIndex=function(){return this._index===null?this.getSkeleton().bones.indexOf(this):this._index},e.prototype.setParent=function(t,r){if(r===void 0&&(r=!0),this.parent!==t){if(this.parent){var n=this.parent.children.indexOf(this);n!==-1&&this.parent.children.splice(n,1)}this._parentNode=t,this.parent&&this.parent.children.push(this),r&&this._updateDifferenceMatrix(),this.markAsDirty()}},e.prototype.getLocalMatrix=function(){return this._compose(),this._localMatrix},e.prototype.getBaseMatrix=function(){return this._baseMatrix},e.prototype.getRestPose=function(){return this._restPose},e.prototype.setRestPose=function(t){this._restPose.copyFrom(t)},e.prototype.getBindPose=function(){return this._baseMatrix},e.prototype.setBindPose=function(t){this.updateMatrix(t)},e.prototype.getWorldMatrix=function(){return this._worldTransform},e.prototype.returnToRest=function(){var t;if(this._linkedTransformNode){var r=U.Vector3[0],n=U.Quaternion[0],a=U.Vector3[1];this.getRestPose().decompose(r,n,a),this._linkedTransformNode.position.copyFrom(a),this._linkedTransformNode.rotationQuaternion=(t=this._linkedTransformNode.rotationQuaternion)!==null&&t!==void 0?t:de.Identity(),this._linkedTransformNode.rotationQuaternion.copyFrom(n),this._linkedTransformNode.scaling.copyFrom(r)}else this._matrix=this._restPose},e.prototype.getInvertedAbsoluteTransform=function(){return this._invertedAbsoluteTransform},e.prototype.getAbsoluteTransform=function(){return this._absoluteTransform},e.prototype.linkTransformNode=function(t){this._linkedTransformNode&&this._skeleton._numBonesWithLinkedTransformNode--,this._linkedTransformNode=t,this._linkedTransformNode&&this._skeleton._numBonesWithLinkedTransformNode++},e.prototype.getTransformNode=function(){return this._linkedTransformNode},Object.defineProperty(e.prototype,"position",{get:function(){return this._decompose(),this._localPosition},set:function(t){this._decompose(),this._localPosition.copyFrom(t),this._markAsDirtyAndCompose()},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"rotation",{get:function(){return this.getRotation()},set:function(t){this.setRotation(t)},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"rotationQuaternion",{get:function(){return this._decompose(),this._localRotation},set:function(t){this.setRotationQuaternion(t)},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"scaling",{get:function(){return this.getScale()},set:function(t){this.setScale(t)},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"animationPropertiesOverride",{get:function(){return this._skeleton.animationPropertiesOverride},enumerable:!1,configurable:!0}),e.prototype._decompose=function(){!this._needToDecompose||(this._needToDecompose=!1,this._localScaling||(this._localScaling=m.Zero(),this._localRotation=de.Zero(),this._localPosition=m.Zero()),this._localMatrix.decompose(this._localScaling,this._localRotation,this._localPosition))},e.prototype._compose=function(){if(!!this._needToCompose){if(!this._localScaling){this._needToCompose=!1;return}this._needToCompose=!1,G.ComposeToRef(this._localScaling,this._localRotation,this._localPosition,this._localMatrix)}},e.prototype.updateMatrix=function(t,r,n){r===void 0&&(r=!0),n===void 0&&(n=!0),this._baseMatrix.copyFrom(t),r&&this._updateDifferenceMatrix(),n?this._matrix=t:this.markAsDirty()},e.prototype._updateDifferenceMatrix=function(t,r){if(r===void 0&&(r=!0),t||(t=this._baseMatrix),this.parent?t.multiplyToRef(this.parent._absoluteTransform,this._absoluteTransform):this._absoluteTransform.copyFrom(t),this._absoluteTransform.invertToRef(this._invertedAbsoluteTransform),r)for(var n=0;n<this.children.length;n++)this.children[n]._updateDifferenceMatrix();this._scalingDeterminant=this._absoluteTransform.determinant()<0?-1:1},e.prototype.markAsDirty=function(){return this._currentRenderId++,this._childUpdateId++,this._skeleton._markAsDirty(),this},e.prototype._markAsDirtyAndCompose=function(){this.markAsDirty(),this._needToCompose=!0},e.prototype._markAsDirtyAndDecompose=function(){this.markAsDirty(),this._needToDecompose=!0},e.prototype.translate=function(t,r,n){r===void 0&&(r=Ce.LOCAL);var a=this.getLocalMatrix();if(r==Ce.LOCAL)a.addAtIndex(12,t.x),a.addAtIndex(13,t.y),a.addAtIndex(14,t.z);else{var s=null;n&&(s=n.getWorldMatrix()),this._skeleton.computeAbsoluteTransforms();var o=e._TmpMats[0],l=e._TmpVecs[0];this.parent?n&&s?(o.copyFrom(this.parent.getAbsoluteTransform()),o.multiplyToRef(s,o)):o.copyFrom(this.parent.getAbsoluteTransform()):G.IdentityToRef(o),o.setTranslationFromFloats(0,0,0),o.invert(),m.TransformCoordinatesToRef(t,o,l),a.addAtIndex(12,l.x),a.addAtIndex(13,l.y),a.addAtIndex(14,l.z)}this._markAsDirtyAndDecompose()},e.prototype.setPosition=function(t,r,n){r===void 0&&(r=Ce.LOCAL);var a=this.getLocalMatrix();if(r==Ce.LOCAL)a.setTranslationFromFloats(t.x,t.y,t.z);else{var s=null;n&&(s=n.getWorldMatrix()),this._skeleton.computeAbsoluteTransforms();var o=e._TmpMats[0],l=e._TmpVecs[0];this.parent?(n&&s?(o.copyFrom(this.parent.getAbsoluteTransform()),o.multiplyToRef(s,o)):o.copyFrom(this.parent.getAbsoluteTransform()),o.invert()):G.IdentityToRef(o),m.TransformCoordinatesToRef(t,o,l),a.setTranslationFromFloats(l.x,l.y,l.z)}this._markAsDirtyAndDecompose()},e.prototype.setAbsolutePosition=function(t,r){this.setPosition(t,Ce.WORLD,r)},e.prototype.scale=function(t,r,n,a){a===void 0&&(a=!1);var s=this.getLocalMatrix(),o=e._TmpMats[0];G.ScalingToRef(t,r,n,o),o.multiplyToRef(s,s),o.invert();for(var l=0,u=this.children;l<u.length;l++){var f=u[l],h=f.getLocalMatrix();h.multiplyToRef(o,h),h.multiplyAtIndex(12,t),h.multiplyAtIndex(13,r),h.multiplyAtIndex(14,n),f._markAsDirtyAndDecompose()}if(this._markAsDirtyAndDecompose(),a)for(var c=0,d=this.children;c<d.length;c++){var f=d[c];f.scale(t,r,n,a)}},e.prototype.setScale=function(t){this._decompose(),this._localScaling.copyFrom(t),this._markAsDirtyAndCompose()},e.prototype.getScale=function(){return this._decompose(),this._localScaling},e.prototype.getScaleToRef=function(t){this._decompose(),t.copyFrom(this._localScaling)},e.prototype.setYawPitchRoll=function(t,r,n,a,s){if(a===void 0&&(a=Ce.LOCAL),a===Ce.LOCAL){var o=e._TmpQuat;de.RotationYawPitchRollToRef(t,r,n,o),this.setRotationQuaternion(o,a,s);return}var l=e._TmpMats[0];if(!!this._getNegativeRotationToRef(l,s)){var u=e._TmpMats[1];G.RotationYawPitchRollToRef(t,r,n,u),l.multiplyToRef(u,u),this._rotateWithMatrix(u,a,s)}},e.prototype.rotate=function(t,r,n,a){n===void 0&&(n=Ce.LOCAL);var s=e._TmpMats[0];s.setTranslationFromFloats(0,0,0),G.RotationAxisToRef(t,r,s),this._rotateWithMatrix(s,n,a)},e.prototype.setAxisAngle=function(t,r,n,a){if(n===void 0&&(n=Ce.LOCAL),n===Ce.LOCAL){var s=e._TmpQuat;de.RotationAxisToRef(t,r,s),this.setRotationQuaternion(s,n,a);return}var o=e._TmpMats[0];if(!!this._getNegativeRotationToRef(o,a)){var l=e._TmpMats[1];G.RotationAxisToRef(t,r,l),o.multiplyToRef(l,l),this._rotateWithMatrix(l,n,a)}},e.prototype.setRotation=function(t,r,n){r===void 0&&(r=Ce.LOCAL),this.setYawPitchRoll(t.y,t.x,t.z,r,n)},e.prototype.setRotationQuaternion=function(t,r,n){if(r===void 0&&(r=Ce.LOCAL),r===Ce.LOCAL){this._decompose(),this._localRotation.copyFrom(t),this._markAsDirtyAndCompose();return}var a=e._TmpMats[0];if(!!this._getNegativeRotationToRef(a,n)){var s=e._TmpMats[1];G.FromQuaternionToRef(t,s),a.multiplyToRef(s,s),this._rotateWithMatrix(s,r,n)}},e.prototype.setRotationMatrix=function(t,r,n){if(r===void 0&&(r=Ce.LOCAL),r===Ce.LOCAL){var a=e._TmpQuat;de.FromRotationMatrixToRef(t,a),this.setRotationQuaternion(a,r,n);return}var s=e._TmpMats[0];if(!!this._getNegativeRotationToRef(s,n)){var o=e._TmpMats[1];o.copyFrom(t),s.multiplyToRef(t,o),this._rotateWithMatrix(o,r,n)}},e.prototype._rotateWithMatrix=function(t,r,n){r===void 0&&(r=Ce.LOCAL);var a=this.getLocalMatrix(),s=a.m[12],o=a.m[13],l=a.m[14],u=this.getParent(),f=e._TmpMats[3],h=e._TmpMats[4];u&&r==Ce.WORLD?(n?(f.copyFrom(n.getWorldMatrix()),u.getAbsoluteTransform().multiplyToRef(f,f)):f.copyFrom(u.getAbsoluteTransform()),h.copyFrom(f),h.invert(),a.multiplyToRef(f,a),a.multiplyToRef(t,a),a.multiplyToRef(h,a)):r==Ce.WORLD&&n?(f.copyFrom(n.getWorldMatrix()),h.copyFrom(f),h.invert(),a.multiplyToRef(f,a),a.multiplyToRef(t,a),a.multiplyToRef(h,a)):a.multiplyToRef(t,a),a.setTranslationFromFloats(s,o,l),this.computeAbsoluteTransforms(),this._markAsDirtyAndDecompose()},e.prototype._getNegativeRotationToRef=function(t,r){var n=e._TmpMats[2];return t.copyFrom(this.getAbsoluteTransform()),r?(t.multiplyToRef(r.getWorldMatrix(),t),G.ScalingToRef(r.scaling.x,r.scaling.y,r.scaling.z,n)):G.IdentityToRef(n),t.invert(),isNaN(t.m[0])?!1:(n.multiplyAtIndex(0,this._scalingDeterminant),t.multiplyToRef(n,t),!0)},e.prototype.getPosition=function(t,r){t===void 0&&(t=Ce.LOCAL),r===void 0&&(r=null);var n=m.Zero();return this.getPositionToRef(t,r,n),n},e.prototype.getPositionToRef=function(t,r,n){if(t===void 0&&(t=Ce.LOCAL),t==Ce.LOCAL){var a=this.getLocalMatrix();n.x=a.m[12],n.y=a.m[13],n.z=a.m[14]}else{var s=null;r&&(s=r.getWorldMatrix()),this._skeleton.computeAbsoluteTransforms();var o=e._TmpMats[0];r&&s?(o.copyFrom(this.getAbsoluteTransform()),o.multiplyToRef(s,o)):o=this.getAbsoluteTransform(),n.x=o.m[12],n.y=o.m[13],n.z=o.m[14]}},e.prototype.getAbsolutePosition=function(t){t===void 0&&(t=null);var r=m.Zero();return this.getPositionToRef(Ce.WORLD,t,r),r},e.prototype.getAbsolutePositionToRef=function(t,r){this.getPositionToRef(Ce.WORLD,t,r)},e.prototype.computeAbsoluteTransforms=function(){if(this._compose(),this.parent)this._localMatrix.multiplyToRef(this.parent._absoluteTransform,this._absoluteTransform);else{this._absoluteTransform.copyFrom(this._localMatrix);var t=this._skeleton.getPoseMatrix();t&&this._absoluteTransform.multiplyToRef(t,this._absoluteTransform)}for(var r=this.children,n=r.length,a=0;a<n;a++)r[a].computeAbsoluteTransforms()},e.prototype.getDirection=function(t,r){r===void 0&&(r=null);var n=m.Zero();return this.getDirectionToRef(t,r,n),n},e.prototype.getDirectionToRef=function(t,r,n){r===void 0&&(r=null);var a=null;r&&(a=r.getWorldMatrix()),this._skeleton.computeAbsoluteTransforms();var s=e._TmpMats[0];s.copyFrom(this.getAbsoluteTransform()),r&&a&&s.multiplyToRef(a,s),m.TransformNormalToRef(t,s,n),n.normalize()},e.prototype.getRotation=function(t,r){t===void 0&&(t=Ce.LOCAL),r===void 0&&(r=null);var n=m.Zero();return this.getRotationToRef(t,r,n),n},e.prototype.getRotationToRef=function(t,r,n){t===void 0&&(t=Ce.LOCAL),r===void 0&&(r=null);var a=e._TmpQuat;this.getRotationQuaternionToRef(t,r,a),a.toEulerAnglesToRef(n)},e.prototype.getRotationQuaternion=function(t,r){t===void 0&&(t=Ce.LOCAL),r===void 0&&(r=null);var n=de.Identity();return this.getRotationQuaternionToRef(t,r,n),n},e.prototype.getRotationQuaternionToRef=function(t,r,n){if(t===void 0&&(t=Ce.LOCAL),r===void 0&&(r=null),t==Ce.LOCAL)this._decompose(),n.copyFrom(this._localRotation);else{var a=e._TmpMats[0],s=this.getAbsoluteTransform();r?s.multiplyToRef(r.getWorldMatrix(),a):a.copyFrom(s),a.multiplyAtIndex(0,this._scalingDeterminant),a.multiplyAtIndex(1,this._scalingDeterminant),a.multiplyAtIndex(2,this._scalingDeterminant),a.decompose(void 0,n,void 0)}},e.prototype.getRotationMatrix=function(t,r){t===void 0&&(t=Ce.LOCAL);var n=G.Identity();return this.getRotationMatrixToRef(t,r,n),n},e.prototype.getRotationMatrixToRef=function(t,r,n){if(t===void 0&&(t=Ce.LOCAL),t==Ce.LOCAL)this.getLocalMatrix().getRotationMatrixToRef(n);else{var a=e._TmpMats[0],s=this.getAbsoluteTransform();r?s.multiplyToRef(r.getWorldMatrix(),a):a.copyFrom(s),a.multiplyAtIndex(0,this._scalingDeterminant),a.multiplyAtIndex(1,this._scalingDeterminant),a.multiplyAtIndex(2,this._scalingDeterminant),a.getRotationMatrixToRef(n)}},e.prototype.getAbsolutePositionFromLocal=function(t,r){r===void 0&&(r=null);var n=m.Zero();return this.getAbsolutePositionFromLocalToRef(t,r,n),n},e.prototype.getAbsolutePositionFromLocalToRef=function(t,r,n){r===void 0&&(r=null);var a=null;r&&(a=r.getWorldMatrix()),this._skeleton.computeAbsoluteTransforms();var s=e._TmpMats[0];r&&a?(s.copyFrom(this.getAbsoluteTransform()),s.multiplyToRef(a,s)):s=this.getAbsoluteTransform(),m.TransformCoordinatesToRef(t,s,n)},e.prototype.getLocalPositionFromAbsolute=function(t,r){r===void 0&&(r=null);var n=m.Zero();return this.getLocalPositionFromAbsoluteToRef(t,r,n),n},e.prototype.getLocalPositionFromAbsoluteToRef=function(t,r,n){r===void 0&&(r=null);var a=null;r&&(a=r.getWorldMatrix()),this._skeleton.computeAbsoluteTransforms();var s=e._TmpMats[0];s.copyFrom(this.getAbsoluteTransform()),r&&a&&s.multiplyToRef(a,s),s.invert(),m.TransformCoordinatesToRef(t,s,n)},e.prototype.setCurrentPoseAsRest=function(){this.setRestPose(this.getLocalMatrix())},e._TmpVecs=je.BuildArray(2,m.Zero),e._TmpQuat=de.Identity(),e._TmpMats=je.BuildArray(5,G.Identity),e}(ct),Ki=function(i){$(e,i);function e(t,r,n,a,s,o,l,u,f,h){o===void 0&&(o=!0),l===void 0&&(l=!1),u===void 0&&(u=3),f===void 0&&(f=0);var c=i.call(this,null,s,!o,l,void 0,void 0,void 0,void 0,void 0,void 0,void 0,void 0,h)||this;return c.format=a,c._engine&&(!c._engine._caps.textureFloatLinearFiltering&&f===1&&(u=1),!c._engine._caps.textureHalfFloatLinearFiltering&&f===2&&(u=1),c._texture=c._engine.createRawTexture(t,r,n,a,o,l,u,null,f,h!=null?h:0),c.wrapU=re.CLAMP_ADDRESSMODE,c.wrapV=re.CLAMP_ADDRESSMODE),c}return e.prototype.update=function(t){this._getEngine().updateRawTexture(this._texture,t,this._texture.format,this._texture.invertY,null,this._texture.type)},e.CreateLuminanceTexture=function(t,r,n,a,s,o,l){return s===void 0&&(s=!0),o===void 0&&(o=!1),l===void 0&&(l=3),new e(t,r,n,1,a,s,o,l)},e.CreateLuminanceAlphaTexture=function(t,r,n,a,s,o,l){return s===void 0&&(s=!0),o===void 0&&(o=!1),l===void 0&&(l=3),new e(t,r,n,2,a,s,o,l)},e.CreateAlphaTexture=function(t,r,n,a,s,o,l){return s===void 0&&(s=!0),o===void 0&&(o=!1),l===void 0&&(l=3),new e(t,r,n,0,a,s,o,l)},e.CreateRGBTexture=function(t,r,n,a,s,o,l,u){return s===void 0&&(s=!0),o===void 0&&(o=!1),l===void 0&&(l=3),u===void 0&&(u=0),new e(t,r,n,4,a,s,o,l,u)},e.CreateRGBATexture=function(t,r,n,a,s,o,l,u){return s===void 0&&(s=!0),o===void 0&&(o=!1),l===void 0&&(l=3),u===void 0&&(u=0),new e(t,r,n,5,a,s,o,l,u)},e.CreateRGBAStorageTexture=function(t,r,n,a,s,o,l,u){return s===void 0&&(s=!0),o===void 0&&(o=!1),l===void 0&&(l=3),u===void 0&&(u=0),new e(t,r,n,5,a,s,o,l,u,1)},e.CreateRTexture=function(t,r,n,a,s,o,l,u){return s===void 0&&(s=!0),o===void 0&&(o=!1),l===void 0&&(l=re.TRILINEAR_SAMPLINGMODE),u===void 0&&(u=1),new e(t,r,n,6,a,s,o,l,u)},e.CreateRStorageTexture=function(t,r,n,a,s,o,l,u){return s===void 0&&(s=!0),o===void 0&&(o=!1),l===void 0&&(l=re.TRILINEAR_SAMPLINGMODE),u===void 0&&(u=1),new e(t,r,n,6,a,s,o,l,u,1)},e}(re),Ip=function(){function i(e,t,r){this.name=e,this.id=t,this.bones=new Array,this.needInitialSkinMatrix=!1,this._isDirty=!0,this._meshesWithPoseMatrix=new Array,this._identity=G.Identity(),this._ranges={},this._lastAbsoluteTransformsUpdateId=-1,this._canUseTextureForBones=!1,this._uniqueId=0,this._numBonesWithLinkedTransformNode=0,this._hasWaitingData=null,this._parentContainer=null,this.doNotSerialize=!1,this._useTextureToStoreBoneMatrices=!0,this._animationPropertiesOverride=null,this.onBeforeComputeObservable=new X,this.bones=[],this._scene=r||ye.LastCreatedScene,this._uniqueId=this._scene.getUniqueId(),this._scene.addSkeleton(this),this._isDirty=!0;var n=this._scene.getEngine().getCaps();this._canUseTextureForBones=n.textureFloat&&n.maxVertexTextureImageUnits>0}return Object.defineProperty(i.prototype,"useTextureToStoreBoneMatrices",{get:function(){return this._useTextureToStoreBoneMatrices},set:function(e){this._useTextureToStoreBoneMatrices=e,this._markAsDirty()},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"animationPropertiesOverride",{get:function(){return this._animationPropertiesOverride?this._animationPropertiesOverride:this._scene.animationPropertiesOverride},set:function(e){this._animationPropertiesOverride=e},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"isUsingTextureForMatrices",{get:function(){return this.useTextureToStoreBoneMatrices&&this._canUseTextureForBones},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"uniqueId",{get:function(){return this._uniqueId},enumerable:!1,configurable:!0}),i.prototype.getClassName=function(){return"Skeleton"},i.prototype.getChildren=function(){return this.bones.filter(function(e){return!e.getParent()})},i.prototype.getTransformMatrices=function(e){return this.needInitialSkinMatrix?(e._bonesTransformMatrices||this.prepare(),e._bonesTransformMatrices):(this._transformMatrices||this.prepare(),this._transformMatrices)},i.prototype.getTransformMatrixTexture=function(e){return this.needInitialSkinMatrix&&e._transformMatrixTexture?e._transformMatrixTexture:this._transformMatrixTexture},i.prototype.getScene=function(){return this._scene},i.prototype.toString=function(e){var t="Name: ".concat(this.name,", nBones: ").concat(this.bones.length);if(t+=", nAnimationRanges: ".concat(this._ranges?Object.keys(this._ranges).length:"none"),e){t+=", Ranges: {";var r=!0;for(var n in this._ranges)r&&(t+=", ",r=!1),t+=n;t+="}"}return t},i.prototype.getBoneIndexByName=function(e){for(var t=0,r=this.bones.length;t<r;t++)if(this.bones[t].name===e)return t;return-1},i.prototype.createAnimationRange=function(e,t,r){if(!this._ranges[e]){this._ranges[e]=new ii(e,t,r);for(var n=0,a=this.bones.length;n<a;n++)this.bones[n].animations[0]&&this.bones[n].animations[0].createRange(e,t,r)}},i.prototype.deleteAnimationRange=function(e,t){t===void 0&&(t=!0);for(var r=0,n=this.bones.length;r<n;r++)this.bones[r].animations[0]&&this.bones[r].animations[0].deleteRange(e,t);this._ranges[e]=null},i.prototype.getAnimationRange=function(e){return this._ranges[e]||null},i.prototype.getAnimationRanges=function(){var e=[],t;for(t in this._ranges)e.push(this._ranges[t]);return e},i.prototype.copyAnimationRange=function(e,t,r){if(r===void 0&&(r=!1),this._ranges[t]||!e.getAnimationRange(t))return!1;var n=!0,a=this._getHighestAnimationFrame()+1,s={},o=e.bones,l,u;for(u=0,l=o.length;u<l;u++)s[o[u].name]=o[u];this.bones.length!==o.length&&(Y.Warn("copyAnimationRange: this rig has ".concat(this.bones.length," bones, while source as ").concat(o.length)),n=!1);var f=r&&this.dimensionsAtRest&&e.dimensionsAtRest?this.dimensionsAtRest.divide(e.dimensionsAtRest):null;for(u=0,l=this.bones.length;u<l;u++){var h=this.bones[u].name,c=s[h];c?n=n&&this.bones[u].copyAnimationRange(c,t,a,r,f):(Y.Warn("copyAnimationRange: not same rig, missing source bone "+h),n=!1)}var d=e.getAnimationRange(t);return d&&(this._ranges[t]=new ii(t,d.from+a,d.to+a)),n},i.prototype.returnToRest=function(){for(var e=0,t=this.bones;e<t.length;e++){var r=t[e];r._index!==-1&&r.returnToRest()}},i.prototype._getHighestAnimationFrame=function(){for(var e=0,t=0,r=this.bones.length;t<r;t++)if(this.bones[t].animations[0]){var n=this.bones[t].animations[0].getHighestFrame();e<n&&(e=n)}return e},i.prototype.beginAnimation=function(e,t,r,n){var a=this.getAnimationRange(e);return a?this._scene.beginAnimation(this,a.from,a.to,t,r,n):null},i.MakeAnimationAdditive=function(e,t,r){t===void 0&&(t=0);var n=e.getAnimationRange(r);if(!n)return null;for(var a=e._scene.getAllAnimatablesByTarget(e),s=null,o=0;o<a.length;o++){var l=a[o];if(l.fromFrame===(n==null?void 0:n.from)&&l.toFrame===(n==null?void 0:n.to)){s=l;break}}for(var u=e.getAnimatables(),o=0;o<u.length;o++){var f=u[o],h=f.animations;if(!!h)for(var c=0;c<h.length;c++)rt.MakeAnimationAdditive(h[c],t,r)}return s&&(s.isAdditive=!0),e},i.prototype._markAsDirty=function(){this._isDirty=!0},i.prototype._registerMeshWithPoseMatrix=function(e){this._meshesWithPoseMatrix.push(e)},i.prototype._unregisterMeshWithPoseMatrix=function(e){var t=this._meshesWithPoseMatrix.indexOf(e);t>-1&&this._meshesWithPoseMatrix.splice(t,1)},i.prototype._computeTransformMatrices=function(e,t){this.onBeforeComputeObservable.notifyObservers(this);for(var r=0;r<this.bones.length;r++){var n=this.bones[r];n._childUpdateId++;var a=n.getParent();if(a?n.getLocalMatrix().multiplyToRef(a.getWorldMatrix(),n.getWorldMatrix()):t?n.getLocalMatrix().multiplyToRef(t,n.getWorldMatrix()):n.getWorldMatrix().copyFrom(n.getLocalMatrix()),n._index!==-1){var s=n._index===null?r:n._index;n.getInvertedAbsoluteTransform().multiplyToArray(n.getWorldMatrix(),e,s*16)}}this._identity.copyToArray(e,this.bones.length*16)},i.prototype.prepare=function(){if(this._numBonesWithLinkedTransformNode>0)for(var e=0,t=this.bones;e<t.length;e++){var r=t[e];r._linkedTransformNode&&(r._linkedTransformNode.computeWorldMatrix(),r._matrix=r._linkedTransformNode._localMatrix)}if(this.needInitialSkinMatrix)for(var n=0,a=this._meshesWithPoseMatrix;n<a.length;n++){var s=a[n],o=s.getPoseMatrix(),l=this._isDirty;if((!s._bonesTransformMatrices||s._bonesTransformMatrices.length!==16*(this.bones.length+1))&&(s._bonesTransformMatrices=new Float32Array(16*(this.bones.length+1)),l=!0),!!l){if(this._synchronizedWithMesh!==s){this._synchronizedWithMesh=s;for(var u=0,f=this.bones;u<f.length;u++){var r=f[u];if(!r.getParent()){var h=r.getBaseMatrix();h.multiplyToRef(o,U.Matrix[1]),r._updateDifferenceMatrix(U.Matrix[1])}}if(this.isUsingTextureForMatrices){var c=(this.bones.length+1)*4;(!s._transformMatrixTexture||s._transformMatrixTexture.getSize().width!==c)&&(s._transformMatrixTexture&&s._transformMatrixTexture.dispose(),s._transformMatrixTexture=Ki.CreateRGBATexture(s._bonesTransformMatrices,(this.bones.length+1)*4,1,this._scene,!1,!1,1,1))}}this._computeTransformMatrices(s._bonesTransformMatrices,o),this.isUsingTextureForMatrices&&s._transformMatrixTexture&&s._transformMatrixTexture.update(s._bonesTransformMatrices)}}else{if(!this._isDirty)return;(!this._transformMatrices||this._transformMatrices.length!==16*(this.bones.length+1))&&(this._transformMatrices=new Float32Array(16*(this.bones.length+1)),this.isUsingTextureForMatrices&&(this._transformMatrixTexture&&this._transformMatrixTexture.dispose(),this._transformMatrixTexture=Ki.CreateRGBATexture(this._transformMatrices,(this.bones.length+1)*4,1,this._scene,!1,!1,1,1))),this._computeTransformMatrices(this._transformMatrices,null),this.isUsingTextureForMatrices&&this._transformMatrixTexture&&this._transformMatrixTexture.update(this._transformMatrices)}this._isDirty=!1},i.prototype.getAnimatables=function(){if(!this._animatables||this._animatables.length!==this.bones.length){this._animatables=[];for(var e=0;e<this.bones.length;e++)this._animatables.push(this.bones[e])}return this._animatables},i.prototype.clone=function(e,t){var r=new i(e,t||e,this._scene);r.needInitialSkinMatrix=this.needInitialSkinMatrix;for(var n=0;n<this.bones.length;n++){var a=this.bones[n],s=null,o=a.getParent();if(o){var l=this.bones.indexOf(o);s=r.bones[l]}var u=new ba(a.name,r,s,a.getBaseMatrix().clone(),a.getRestPose().clone());u._index=a._index,a._linkedTransformNode&&u.linkTransformNode(a._linkedTransformNode),dt.DeepCopy(a.animations,u.animations)}if(this._ranges){r._ranges={};for(var f in this._ranges){var h=this._ranges[f];h&&(r._ranges[f]=h.clone())}}return this._isDirty=!0,r},i.prototype.enableBlending=function(e){e===void 0&&(e=.01),this.bones.forEach(function(t){t.animations.forEach(function(r){r.enableBlending=!0,r.blendingSpeed=e})})},i.prototype.dispose=function(){if(this._meshesWithPoseMatrix=[],this.getScene().stopAnimation(this),this.getScene().removeSkeleton(this),this._parentContainer){var e=this._parentContainer.skeletons.indexOf(this);e>-1&&this._parentContainer.skeletons.splice(e,1),this._parentContainer=null}this._transformMatrixTexture&&(this._transformMatrixTexture.dispose(),this._transformMatrixTexture=null)},i.prototype.serialize=function(){var e,t={};t.name=this.name,t.id=this.id,this.dimensionsAtRest&&(t.dimensionsAtRest=this.dimensionsAtRest.asArray()),t.bones=[],t.needInitialSkinMatrix=this.needInitialSkinMatrix;for(var r=0;r<this.bones.length;r++){var n=this.bones[r],a=n.getParent(),s={parentBoneIndex:a?this.bones.indexOf(a):-1,index:n.getIndex(),name:n.name,id:n.id,matrix:n.getBaseMatrix().toArray(),rest:n.getRestPose().toArray(),linkedTransformNodeId:(e=n.getTransformNode())===null||e===void 0?void 0:e.id};t.bones.push(s),n.length&&(s.length=n.length),n.metadata&&(s.metadata=n.metadata),n.animations&&n.animations.length>0&&(s.animation=n.animations[0].serialize()),t.ranges=[];for(var o in this._ranges){var l=this._ranges[o];if(!!l){var u={};u.name=o,u.from=l.from,u.to=l.to,t.ranges.push(u)}}}return t},i.Parse=function(e,t){var r=new i(e.name,e.id,t);e.dimensionsAtRest&&(r.dimensionsAtRest=m.FromArray(e.dimensionsAtRest)),r.needInitialSkinMatrix=e.needInitialSkinMatrix;var n;for(n=0;n<e.bones.length;n++){var a=e.bones[n],s=e.bones[n].index,o=null;a.parentBoneIndex>-1&&(o=r.bones[a.parentBoneIndex]);var l=a.rest?G.FromArray(a.rest):null,u=new ba(a.name,r,o,G.FromArray(a.matrix),l,null,s);a.id!==void 0&&a.id!==null&&(u.id=a.id),a.length&&(u.length=a.length),a.metadata&&(u.metadata=a.metadata),a.animation&&u.animations.push(rt.Parse(a.animation)),a.linkedTransformNodeId!==void 0&&a.linkedTransformNodeId!==null&&(r._hasWaitingData=!0,u._waitingTransformNodeId=a.linkedTransformNodeId)}if(e.ranges)for(n=0;n<e.ranges.length;n++){var f=e.ranges[n];r.createAnimationRange(f.name,f.from,f.to)}return r},i.prototype.computeAbsoluteTransforms=function(e){e===void 0&&(e=!1);var t=this._scene.getRenderId();(this._lastAbsoluteTransformsUpdateId!=t||e)&&(this.bones[0].computeAbsoluteTransforms(),this._lastAbsoluteTransformsUpdateId=t)},i.prototype.getPoseMatrix=function(){var e=null;return this._meshesWithPoseMatrix.length>0&&(e=this._meshesWithPoseMatrix[0].getPoseMatrix()),e},i.prototype.sortBones=function(){for(var e=new Array,t=new Array(this.bones.length),r=0;r<this.bones.length;r++)this._sortBones(r,e,t);this.bones=e},i.prototype._sortBones=function(e,t,r){if(!r[e]){r[e]=!0;var n=this.bones[e];n._index===void 0&&(n._index=e);var a=n.getParent();a&&this._sortBones(this.bones.indexOf(a),t,r),t.push(n)}},i.prototype.setCurrentPoseAsRest=function(){this.bones.forEach(function(e){e.setCurrentPoseAsRest()})},i}(),Kr=function(){function i(){this.direction1=new m(0,1,0),this.direction2=new m(0,1,0),this.minEmitBox=new m(-.5,-.5,-.5),this.maxEmitBox=new m(.5,.5,.5)}return i.prototype.startDirectionFunction=function(e,t,r,n){var a=K.RandomRange(this.direction1.x,this.direction2.x),s=K.RandomRange(this.direction1.y,this.direction2.y),o=K.RandomRange(this.direction1.z,this.direction2.z);if(n){t.x=a,t.y=s,t.z=o;return}m.TransformNormalFromFloatsToRef(a,s,o,e,t)},i.prototype.startPositionFunction=function(e,t,r,n){var a=K.RandomRange(this.minEmitBox.x,this.maxEmitBox.x),s=K.RandomRange(this.minEmitBox.y,this.maxEmitBox.y),o=K.RandomRange(this.minEmitBox.z,this.maxEmitBox.z);if(n){t.x=a,t.y=s,t.z=o;return}m.TransformCoordinatesFromFloatsToRef(a,s,o,e,t)},i.prototype.clone=function(){var e=new i;return dt.DeepCopy(this,e),e},i.prototype.applyToShader=function(e){e.setVector3("direction1",this.direction1),e.setVector3("direction2",this.direction2),e.setVector3("minEmitBox",this.minEmitBox),e.setVector3("maxEmitBox",this.maxEmitBox)},i.prototype.buildUniformLayout=function(e){e.addUniform("direction1",3),e.addUniform("direction2",3),e.addUniform("minEmitBox",3),e.addUniform("maxEmitBox",3)},i.prototype.getEffectDefines=function(){return"#define BOXEMITTER"},i.prototype.getClassName=function(){return"BoxParticleEmitter"},i.prototype.serialize=function(){var e={};return e.type=this.getClassName(),e.direction1=this.direction1.asArray(),e.direction2=this.direction2.asArray(),e.minEmitBox=this.minEmitBox.asArray(),e.maxEmitBox=this.maxEmitBox.asArray(),e},i.prototype.parse=function(e){m.FromArrayToRef(e.direction1,0,this.direction1),m.FromArrayToRef(e.direction2,0,this.direction2),m.FromArrayToRef(e.minEmitBox,0,this.minEmitBox),m.FromArrayToRef(e.maxEmitBox,0,this.maxEmitBox)},i}(),eo=function(){function i(e,t,r){e===void 0&&(e=1),t===void 0&&(t=Math.PI),r===void 0&&(r=0),this.directionRandomizer=r,this.radiusRange=1,this.heightRange=1,this.emitFromSpawnPointOnly=!1,this.angle=t,this.radius=e}return Object.defineProperty(i.prototype,"radius",{get:function(){return this._radius},set:function(e){this._radius=e,this._buildHeight()},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"angle",{get:function(){return this._angle},set:function(e){this._angle=e,this._buildHeight()},enumerable:!1,configurable:!0}),i.prototype._buildHeight=function(){this._angle!==0?this._height=this._radius/Math.tan(this._angle/2):this._height=1},i.prototype.startDirectionFunction=function(e,t,r,n){n?U.Vector3[0].copyFrom(r._localPosition).normalize():r.position.subtractToRef(e.getTranslation(),U.Vector3[0]).normalize();var a=K.RandomRange(0,this.directionRandomizer),s=K.RandomRange(0,this.directionRandomizer),o=K.RandomRange(0,this.directionRandomizer);t.x=U.Vector3[0].x+a,t.y=U.Vector3[0].y+s,t.z=U.Vector3[0].z+o,t.normalize()},i.prototype.startPositionFunction=function(e,t,r,n){var a=K.RandomRange(0,Math.PI*2),s;this.emitFromSpawnPointOnly?s=1e-4:(s=K.RandomRange(0,this.heightRange),s=1-s*s);var o=this._radius-K.RandomRange(0,this._radius*this.radiusRange);o=o*s;var l=o*Math.sin(a),u=o*Math.cos(a),f=s*this._height;if(n){t.x=l,t.y=f,t.z=u;return}m.TransformCoordinatesFromFloatsToRef(l,f,u,e,t)},i.prototype.clone=function(){var e=new i(this._radius,this._angle,this.directionRandomizer);return dt.DeepCopy(this,e),e},i.prototype.applyToShader=function(e){e.setFloat2("radius",this._radius,this.radiusRange),e.setFloat("coneAngle",this._angle),e.setFloat2("height",this._height,this.heightRange),e.setFloat("directionRandomizer",this.directionRandomizer)},i.prototype.buildUniformLayout=function(e){e.addUniform("radius",2),e.addUniform("coneAngle",1),e.addUniform("height",2),e.addUniform("directionRandomizer",1)},i.prototype.getEffectDefines=function(){var e="#define CONEEMITTER";return this.emitFromSpawnPointOnly&&(e+=`
#define CONEEMITTERSPAWNPOINT`),e},i.prototype.getClassName=function(){return"ConeParticleEmitter"},i.prototype.serialize=function(){var e={};return e.type=this.getClassName(),e.radius=this._radius,e.angle=this._angle,e.directionRandomizer=this.directionRandomizer,e.radiusRange=this.radiusRange,e.heightRange=this.heightRange,e.emitFromSpawnPointOnly=this.emitFromSpawnPointOnly,e},i.prototype.parse=function(e){this.radius=e.radius,this.angle=e.angle,this.directionRandomizer=e.directionRandomizer,this.radiusRange=e.radiusRange!==void 0?e.radiusRange:1,this.heightRange=e.radiusRange!==void 0?e.heightRange:1,this.emitFromSpawnPointOnly=e.emitFromSpawnPointOnly!==void 0?e.emitFromSpawnPointOnly:!1},i}(),yn=function(){function i(e,t,r,n){e===void 0&&(e=1),t===void 0&&(t=1),r===void 0&&(r=1),n===void 0&&(n=0),this.radius=e,this.height=t,this.radiusRange=r,this.directionRandomizer=n,this._tempVector=m.Zero()}return i.prototype.startDirectionFunction=function(e,t,r,n,a){r.position.subtractToRef(e.getTranslation(),this._tempVector),this._tempVector.normalize(),m.TransformNormalToRef(this._tempVector,a,this._tempVector);var s=K.RandomRange(-this.directionRandomizer/2,this.directionRandomizer/2),o=Math.atan2(this._tempVector.x,this._tempVector.z);if(o+=K.RandomRange(-Math.PI/2,Math.PI/2)*this.directionRandomizer,this._tempVector.y=s,this._tempVector.x=Math.sin(o),this._tempVector.z=Math.cos(o),this._tempVector.normalize(),n){t.copyFrom(this._tempVector);return}m.TransformNormalFromFloatsToRef(this._tempVector.x,this._tempVector.y,this._tempVector.z,e,t)},i.prototype.startPositionFunction=function(e,t,r,n){var a=K.RandomRange(-this.height/2,this.height/2),s=K.RandomRange(0,2*Math.PI),o=K.RandomRange((1-this.radiusRange)*(1-this.radiusRange),1),l=Math.sqrt(o)*this.radius,u=l*Math.cos(s),f=l*Math.sin(s);if(n){t.copyFromFloats(u,a,f);return}m.TransformCoordinatesFromFloatsToRef(u,a,f,e,t)},i.prototype.clone=function(){var e=new i(this.radius,this.directionRandomizer);return dt.DeepCopy(this,e),e},i.prototype.applyToShader=function(e){e.setFloat("radius",this.radius),e.setFloat("height",this.height),e.setFloat("radiusRange",this.radiusRange),e.setFloat("directionRandomizer",this.directionRandomizer)},i.prototype.buildUniformLayout=function(e){e.addUniform("radius",1),e.addUniform("height",1),e.addUniform("radiusRange",1),e.addUniform("directionRandomizer",1)},i.prototype.getEffectDefines=function(){return"#define CYLINDEREMITTER"},i.prototype.getClassName=function(){return"CylinderParticleEmitter"},i.prototype.serialize=function(){var e={};return e.type=this.getClassName(),e.radius=this.radius,e.height=this.height,e.radiusRange=this.radiusRange,e.directionRandomizer=this.directionRandomizer,e},i.prototype.parse=function(e){this.radius=e.radius,this.height=e.height,this.radiusRange=e.radiusRange,this.directionRandomizer=e.directionRandomizer},i}(),to=function(i){$(e,i);function e(t,r,n,a,s){t===void 0&&(t=1),r===void 0&&(r=1),n===void 0&&(n=1),a===void 0&&(a=new m(0,1,0)),s===void 0&&(s=new m(0,1,0));var o=i.call(this,t,r,n)||this;return o.direction1=a,o.direction2=s,o}return e.prototype.startDirectionFunction=function(t,r){var n=K.RandomRange(this.direction1.x,this.direction2.x),a=K.RandomRange(this.direction1.y,this.direction2.y),s=K.RandomRange(this.direction1.z,this.direction2.z);m.TransformNormalFromFloatsToRef(n,a,s,t,r)},e.prototype.clone=function(){var t=new e(this.radius,this.height,this.radiusRange,this.direction1,this.direction2);return dt.DeepCopy(this,t),t},e.prototype.applyToShader=function(t){t.setFloat("radius",this.radius),t.setFloat("height",this.height),t.setFloat("radiusRange",this.radiusRange),t.setVector3("direction1",this.direction1),t.setVector3("direction2",this.direction2)},e.prototype.buildUniformLayout=function(t){t.addUniform("radius",1),t.addUniform("height",1),t.addUniform("radiusRange",1),t.addUniform("direction1",3),t.addUniform("direction2",3)},e.prototype.getEffectDefines=function(){return`#define CYLINDEREMITTER
#define DIRECTEDCYLINDEREMITTER`},e.prototype.getClassName=function(){return"CylinderDirectedParticleEmitter"},e.prototype.serialize=function(){var t=i.prototype.serialize.call(this);return t.direction1=this.direction1.asArray(),t.direction2=this.direction2.asArray(),t},e.prototype.parse=function(t){i.prototype.parse.call(this,t),this.direction1.copyFrom(t.direction1),this.direction2.copyFrom(t.direction2)},e}(yn),ro=function(){function i(e,t,r){e===void 0&&(e=1),t===void 0&&(t=1),r===void 0&&(r=0),this.radius=e,this.radiusRange=t,this.directionRandomizer=r}return i.prototype.startDirectionFunction=function(e,t,r,n){var a=r.position.subtract(e.getTranslation()).normalize(),s=K.RandomRange(0,this.directionRandomizer),o=K.RandomRange(0,this.directionRandomizer),l=K.RandomRange(0,this.directionRandomizer);if(a.x+=s,a.y+=o,a.z+=l,a.normalize(),n){t.copyFrom(a);return}m.TransformNormalFromFloatsToRef(a.x,a.y,a.z,e,t)},i.prototype.startPositionFunction=function(e,t,r,n){var a=this.radius-K.RandomRange(0,this.radius*this.radiusRange),s=K.RandomRange(0,1),o=K.RandomRange(0,2*Math.PI),l=Math.acos(2*s-1),u=a*Math.cos(o)*Math.sin(l),f=a*Math.cos(l),h=a*Math.sin(o)*Math.sin(l);if(n){t.copyFromFloats(u,Math.abs(f),h);return}m.TransformCoordinatesFromFloatsToRef(u,Math.abs(f),h,e,t)},i.prototype.clone=function(){var e=new i(this.radius,this.directionRandomizer);return dt.DeepCopy(this,e),e},i.prototype.applyToShader=function(e){e.setFloat("radius",this.radius),e.setFloat("radiusRange",this.radiusRange),e.setFloat("directionRandomizer",this.directionRandomizer)},i.prototype.buildUniformLayout=function(e){e.addUniform("radius",1),e.addUniform("radiusRange",1),e.addUniform("directionRandomizer",1)},i.prototype.getEffectDefines=function(){return"#define HEMISPHERICEMITTER"},i.prototype.getClassName=function(){return"HemisphericParticleEmitter"},i.prototype.serialize=function(){var e={};return e.type=this.getClassName(),e.radius=this.radius,e.radiusRange=this.radiusRange,e.directionRandomizer=this.directionRandomizer,e},i.prototype.parse=function(e){this.radius=e.radius,this.radiusRange=e.radiusRange,this.directionRandomizer=e.directionRandomizer},i}(),io=function(){function i(){this.direction1=new m(0,1,0),this.direction2=new m(0,1,0)}return i.prototype.startDirectionFunction=function(e,t,r,n){var a=K.RandomRange(this.direction1.x,this.direction2.x),s=K.RandomRange(this.direction1.y,this.direction2.y),o=K.RandomRange(this.direction1.z,this.direction2.z);if(n){t.copyFromFloats(a,s,o);return}m.TransformNormalFromFloatsToRef(a,s,o,e,t)},i.prototype.startPositionFunction=function(e,t,r,n){if(n){t.copyFromFloats(0,0,0);return}m.TransformCoordinatesFromFloatsToRef(0,0,0,e,t)},i.prototype.clone=function(){var e=new i;return dt.DeepCopy(this,e),e},i.prototype.applyToShader=function(e){e.setVector3("direction1",this.direction1),e.setVector3("direction2",this.direction2)},i.prototype.buildUniformLayout=function(e){e.addUniform("direction1",3),e.addUniform("direction2",3)},i.prototype.getEffectDefines=function(){return"#define POINTEMITTER"},i.prototype.getClassName=function(){return"PointParticleEmitter"},i.prototype.serialize=function(){var e={};return e.type=this.getClassName(),e.direction1=this.direction1.asArray(),e.direction2=this.direction2.asArray(),e},i.prototype.parse=function(e){m.FromArrayToRef(e.direction1,0,this.direction1),m.FromArrayToRef(e.direction2,0,this.direction2)},i}(),bn=function(){function i(e,t,r){e===void 0&&(e=1),t===void 0&&(t=1),r===void 0&&(r=0),this.radius=e,this.radiusRange=t,this.directionRandomizer=r}return i.prototype.startDirectionFunction=function(e,t,r,n){var a=r.position.subtract(e.getTranslation()).normalize(),s=K.RandomRange(0,this.directionRandomizer),o=K.RandomRange(0,this.directionRandomizer),l=K.RandomRange(0,this.directionRandomizer);if(a.x+=s,a.y+=o,a.z+=l,a.normalize(),n){t.copyFrom(a);return}m.TransformNormalFromFloatsToRef(a.x,a.y,a.z,e,t)},i.prototype.startPositionFunction=function(e,t,r,n){var a=this.radius-K.RandomRange(0,this.radius*this.radiusRange),s=K.RandomRange(0,1),o=K.RandomRange(0,2*Math.PI),l=Math.acos(2*s-1),u=a*Math.cos(o)*Math.sin(l),f=a*Math.cos(l),h=a*Math.sin(o)*Math.sin(l);if(n){t.copyFromFloats(u,f,h);return}m.TransformCoordinatesFromFloatsToRef(u,f,h,e,t)},i.prototype.clone=function(){var e=new i(this.radius,this.directionRandomizer);return dt.DeepCopy(this,e),e},i.prototype.applyToShader=function(e){e.setFloat("radius",this.radius),e.setFloat("radiusRange",this.radiusRange),e.setFloat("directionRandomizer",this.directionRandomizer)},i.prototype.buildUniformLayout=function(e){e.addUniform("radius",1),e.addUniform("radiusRange",1),e.addUniform("directionRandomizer",1)},i.prototype.getEffectDefines=function(){return"#define SPHEREEMITTER"},i.prototype.getClassName=function(){return"SphereParticleEmitter"},i.prototype.serialize=function(){var e={};return e.type=this.getClassName(),e.radius=this.radius,e.radiusRange=this.radiusRange,e.directionRandomizer=this.directionRandomizer,e},i.prototype.parse=function(e){this.radius=e.radius,this.radiusRange=e.radiusRange,this.directionRandomizer=e.directionRandomizer},i}(),no=function(i){$(e,i);function e(t,r,n){t===void 0&&(t=1),r===void 0&&(r=new m(0,1,0)),n===void 0&&(n=new m(0,1,0));var a=i.call(this,t)||this;return a.direction1=r,a.direction2=n,a}return e.prototype.startDirectionFunction=function(t,r){var n=K.RandomRange(this.direction1.x,this.direction2.x),a=K.RandomRange(this.direction1.y,this.direction2.y),s=K.RandomRange(this.direction1.z,this.direction2.z);m.TransformNormalFromFloatsToRef(n,a,s,t,r)},e.prototype.clone=function(){var t=new e(this.radius,this.direction1,this.direction2);return dt.DeepCopy(this,t),t},e.prototype.applyToShader=function(t){t.setFloat("radius",this.radius),t.setFloat("radiusRange",this.radiusRange),t.setVector3("direction1",this.direction1),t.setVector3("direction2",this.direction2)},e.prototype.buildUniformLayout=function(t){t.addUniform("radius",1),t.addUniform("radiusRange",1),t.addUniform("direction1",3),t.addUniform("direction2",3)},e.prototype.getEffectDefines=function(){return`#define SPHEREEMITTER
#define DIRECTEDSPHEREEMITTER`},e.prototype.getClassName=function(){return"SphereDirectedParticleEmitter"},e.prototype.serialize=function(){var t=i.prototype.serialize.call(this);return t.direction1=this.direction1.asArray(),t.direction2=this.direction2.asArray(),t},e.prototype.parse=function(t){i.prototype.parse.call(this,t),this.direction1.copyFrom(t.direction1),this.direction2.copyFrom(t.direction2)},e}(bn),td=function(){function i(e){e===void 0&&(e=null),this._indices=null,this._positions=null,this._normals=null,this._storedNormal=m.Zero(),this._mesh=null,this.direction1=new m(0,1,0),this.direction2=new m(0,1,0),this.useMeshNormalsForDirection=!0,this.mesh=e}return Object.defineProperty(i.prototype,"mesh",{get:function(){return this._mesh},set:function(e){this._mesh!==e&&(this._mesh=e,e?(this._indices=e.getIndices(),this._positions=e.getVerticesData(R.PositionKind),this._normals=e.getVerticesData(R.NormalKind)):(this._indices=null,this._positions=null,this._normals=null))},enumerable:!1,configurable:!0}),i.prototype.startDirectionFunction=function(e,t,r,n){if(this.useMeshNormalsForDirection&&this._normals){m.TransformNormalToRef(this._storedNormal,e,t);return}var a=K.RandomRange(this.direction1.x,this.direction2.x),s=K.RandomRange(this.direction1.y,this.direction2.y),o=K.RandomRange(this.direction1.z,this.direction2.z);if(n){t.copyFromFloats(a,s,o);return}m.TransformNormalFromFloatsToRef(a,s,o,e,t)},i.prototype.startPositionFunction=function(e,t,r,n){if(!(!this._indices||!this._positions)){var a=3*Math.random()*(this._indices.length/3)|0,s=Math.random(),o=Math.random()*(1-s),l=1-s-o,u=this._indices[a],f=this._indices[a+1],h=this._indices[a+2],c=U.Vector3[0],d=U.Vector3[1],p=U.Vector3[2],_=U.Vector3[3];m.FromArrayToRef(this._positions,u*3,c),m.FromArrayToRef(this._positions,f*3,d),m.FromArrayToRef(this._positions,h*3,p),_.x=s*c.x+o*d.x+l*p.x,_.y=s*c.y+o*d.y+l*p.y,_.z=s*c.z+o*d.z+l*p.z,n?t.copyFromFloats(_.x,_.y,_.z):m.TransformCoordinatesFromFloatsToRef(_.x,_.y,_.z,e,t),this.useMeshNormalsForDirection&&this._normals&&(m.FromArrayToRef(this._normals,u*3,c),m.FromArrayToRef(this._normals,f*3,d),m.FromArrayToRef(this._normals,h*3,p),this._storedNormal.x=s*c.x+o*d.x+l*p.x,this._storedNormal.y=s*c.y+o*d.y+l*p.y,this._storedNormal.z=s*c.z+o*d.z+l*p.z)}},i.prototype.clone=function(){var e=new i(this.mesh);return dt.DeepCopy(this,e),e},i.prototype.applyToShader=function(e){e.setVector3("direction1",this.direction1),e.setVector3("direction2",this.direction2)},i.prototype.buildUniformLayout=function(e){e.addUniform("direction1",3),e.addUniform("direction2",3)},i.prototype.getEffectDefines=function(){return""},i.prototype.getClassName=function(){return"MeshParticleEmitter"},i.prototype.serialize=function(){var e,t={};return t.type=this.getClassName(),t.direction1=this.direction1.asArray(),t.direction2=this.direction2.asArray(),t.meshId=(e=this.mesh)===null||e===void 0?void 0:e.id,t.useMeshNormalsForDirection=this.useMeshNormalsForDirection,t},i.prototype.parse=function(e,t){m.FromArrayToRef(e.direction1,0,this.direction1),m.FromArrayToRef(e.direction2,0,this.direction2),e.meshId&&t&&(this.mesh=t.getLastMeshById(e.meshId)),this.useMeshNormalsForDirection=e.useMeshNormalsForDirection},i}(),rd=function(){function i(e){this.animations=[],this.renderingGroupId=0,this.emitter=m.Zero(),this.emitRate=10,this.manualEmitCount=-1,this.updateSpeed=.01,this.targetStopDuration=0,this.disposeOnStop=!1,this.minEmitPower=1,this.maxEmitPower=1,this.minLifeTime=1,this.maxLifeTime=1,this.minSize=1,this.maxSize=1,this.minScaleX=1,this.maxScaleX=1,this.minScaleY=1,this.maxScaleY=1,this.minInitialRotation=0,this.maxInitialRotation=0,this.minAngularSpeed=0,this.maxAngularSpeed=0,this.layerMask=268435455,this.customShader=null,this.preventAutoStart=!1,this._rootUrl="",this.noiseStrength=new m(10,10,10),this.onAnimationEnd=null,this.blendMode=i.BLENDMODE_ONEONE,this.forceDepthWrite=!1,this.preWarmCycles=0,this.preWarmStepOffset=1,this.spriteCellChangeSpeed=1,this.startSpriteCellID=0,this.endSpriteCellID=0,this.spriteCellWidth=0,this.spriteCellHeight=0,this.spriteCellLoop=!0,this.spriteRandomStartCell=!1,this.translationPivot=new se(0,0),this.beginAnimationOnStart=!1,this.beginAnimationFrom=0,this.beginAnimationTo=60,this.beginAnimationLoop=!1,this.worldOffset=new m(0,0,0),this.gravity=m.Zero(),this._colorGradients=null,this._sizeGradients=null,this._lifeTimeGradients=null,this._angularSpeedGradients=null,this._velocityGradients=null,this._limitVelocityGradients=null,this._dragGradients=null,this._emitRateGradients=null,this._startSizeGradients=null,this._rampGradients=null,this._colorRemapGradients=null,this._alphaRemapGradients=null,this.startDelay=0,this.limitVelocityDamping=.4,this.color1=new ce(1,1,1,1),this.color2=new ce(1,1,1,1),this.colorDead=new ce(0,0,0,1),this.textureMask=new ce(1,1,1,1),this._isSubEmitter=!1,this._billboardMode=7,this._isBillboardBased=!0,this._imageProcessingConfigurationDefines=new Jo,this.id=e,this.name=e}return Object.defineProperty(i.prototype,"noiseTexture",{get:function(){return this._noiseTexture},set:function(e){this._noiseTexture!==e&&(this._noiseTexture=e,this._reset())},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"isAnimationSheetEnabled",{get:function(){return this._isAnimationSheetEnabled},set:function(e){this._isAnimationSheetEnabled!=e&&(this._isAnimationSheetEnabled=e,this._reset())},enumerable:!1,configurable:!0}),i.prototype.getScene=function(){return this._scene},i.prototype._hasTargetStopDurationDependantGradient=function(){return this._startSizeGradients&&this._startSizeGradients.length>0||this._emitRateGradients&&this._emitRateGradients.length>0||this._lifeTimeGradients&&this._lifeTimeGradients.length>0},i.prototype.getDragGradients=function(){return this._dragGradients},i.prototype.getLimitVelocityGradients=function(){return this._limitVelocityGradients},i.prototype.getColorGradients=function(){return this._colorGradients},i.prototype.getSizeGradients=function(){return this._sizeGradients},i.prototype.getColorRemapGradients=function(){return this._colorRemapGradients},i.prototype.getAlphaRemapGradients=function(){return this._alphaRemapGradients},i.prototype.getLifeTimeGradients=function(){return this._lifeTimeGradients},i.prototype.getAngularSpeedGradients=function(){return this._angularSpeedGradients},i.prototype.getVelocityGradients=function(){return this._velocityGradients},i.prototype.getStartSizeGradients=function(){return this._startSizeGradients},i.prototype.getEmitRateGradients=function(){return this._emitRateGradients},Object.defineProperty(i.prototype,"direction1",{get:function(){return this.particleEmitterType.direction1?this.particleEmitterType.direction1:m.Zero()},set:function(e){this.particleEmitterType.direction1&&(this.particleEmitterType.direction1=e)},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"direction2",{get:function(){return this.particleEmitterType.direction2?this.particleEmitterType.direction2:m.Zero()},set:function(e){this.particleEmitterType.direction2&&(this.particleEmitterType.direction2=e)},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"minEmitBox",{get:function(){return this.particleEmitterType.minEmitBox?this.particleEmitterType.minEmitBox:m.Zero()},set:function(e){this.particleEmitterType.minEmitBox&&(this.particleEmitterType.minEmitBox=e)},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"maxEmitBox",{get:function(){return this.particleEmitterType.maxEmitBox?this.particleEmitterType.maxEmitBox:m.Zero()},set:function(e){this.particleEmitterType.maxEmitBox&&(this.particleEmitterType.maxEmitBox=e)},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"billboardMode",{get:function(){return this._billboardMode},set:function(e){this._billboardMode!==e&&(this._billboardMode=e,this._reset())},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"isBillboardBased",{get:function(){return this._isBillboardBased},set:function(e){this._isBillboardBased!==e&&(this._isBillboardBased=e,this._reset())},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"imageProcessingConfiguration",{get:function(){return this._imageProcessingConfiguration},set:function(e){this._attachImageProcessingConfiguration(e)},enumerable:!1,configurable:!0}),i.prototype._attachImageProcessingConfiguration=function(e){e!==this._imageProcessingConfiguration&&(!e&&this._scene?this._imageProcessingConfiguration=this._scene.imageProcessingConfiguration:this._imageProcessingConfiguration=e)},i.prototype._reset=function(){},i.prototype._removeGradientAndTexture=function(e,t,r){if(!t)return this;for(var n=0,a=0,s=t;a<s.length;a++){var o=s[a];if(o.gradient===e){t.splice(n,1);break}n++}return r&&r.dispose(),this},i.prototype.createPointEmitter=function(e,t){var r=new io;return r.direction1=e,r.direction2=t,this.particleEmitterType=r,r},i.prototype.createHemisphericEmitter=function(e,t){e===void 0&&(e=1),t===void 0&&(t=1);var r=new ro(e,t);return this.particleEmitterType=r,r},i.prototype.createSphereEmitter=function(e,t){e===void 0&&(e=1),t===void 0&&(t=1);var r=new bn(e,t);return this.particleEmitterType=r,r},i.prototype.createDirectedSphereEmitter=function(e,t,r){e===void 0&&(e=1),t===void 0&&(t=new m(0,1,0)),r===void 0&&(r=new m(0,1,0));var n=new no(e,t,r);return this.particleEmitterType=n,n},i.prototype.createCylinderEmitter=function(e,t,r,n){e===void 0&&(e=1),t===void 0&&(t=1),r===void 0&&(r=1),n===void 0&&(n=0);var a=new yn(e,t,r,n);return this.particleEmitterType=a,a},i.prototype.createDirectedCylinderEmitter=function(e,t,r,n,a){e===void 0&&(e=1),t===void 0&&(t=1),r===void 0&&(r=1),n===void 0&&(n=new m(0,1,0)),a===void 0&&(a=new m(0,1,0));var s=new to(e,t,r,n,a);return this.particleEmitterType=s,s},i.prototype.createConeEmitter=function(e,t){e===void 0&&(e=1),t===void 0&&(t=Math.PI/4);var r=new eo(e,t);return this.particleEmitterType=r,r},i.prototype.createBoxEmitter=function(e,t,r,n){var a=new Kr;return this.particleEmitterType=a,this.direction1=e,this.direction2=t,this.minEmitBox=r,this.maxEmitBox=n,a},i.BLENDMODE_ONEONE=0,i.BLENDMODE_STANDARD=1,i.BLENDMODE_ADD=2,i.BLENDMODE_MULTIPLY=3,i.BLENDMODE_MULTIPLYADD=4,i}(),id=function(){function i(e){this.particleSystem=e,this.position=m.Zero(),this.direction=m.Zero(),this.color=new ce(0,0,0,0),this.colorStep=new ce(0,0,0,0),this.lifeTime=1,this.age=0,this.size=0,this.scale=new se(1,1),this.angle=0,this.angularSpeed=0,this.cellIndex=0,this._attachedSubEmitters=null,this._currentColor1=new ce(0,0,0,0),this._currentColor2=new ce(0,0,0,0),this._currentSize1=0,this._currentSize2=0,this._currentAngularSpeed1=0,this._currentAngularSpeed2=0,this._currentVelocity1=0,this._currentVelocity2=0,this._currentLimitVelocity1=0,this._currentLimitVelocity2=0,this._currentDrag1=0,this._currentDrag2=0,this.id=i._Count++,this.particleSystem.isAnimationSheetEnabled&&this._updateCellInfoFromSystem()}return i.prototype._updateCellInfoFromSystem=function(){this.cellIndex=this.particleSystem.startSpriteCellID},i.prototype.updateCellIndex=function(){var e=this.age,t=this.particleSystem.spriteCellChangeSpeed;this.particleSystem.spriteRandomStartCell&&(this._randomCellOffset===void 0&&(this._randomCellOffset=Math.random()*this.lifeTime),t===0?(t=1,e=this._randomCellOffset):e+=this._randomCellOffset);var r=this._initialEndSpriteCellID-this._initialStartSpriteCellID,n;this._initialSpriteCellLoop?n=K.Clamp(e*t%this.lifeTime/this.lifeTime):n=K.Clamp(e*t/this.lifeTime),this.cellIndex=this._initialStartSpriteCellID+n*r|0},i.prototype._inheritParticleInfoToSubEmitter=function(e){if(e.particleSystem.emitter.position){var t=e.particleSystem.emitter;if(t.position.copyFrom(this.position),e.inheritDirection){var r=U.Vector3[0];this.direction.normalizeToRef(r),t.setDirection(r,0,Math.PI/2)}}else{var n=e.particleSystem.emitter;n.copyFrom(this.position)}this.direction.scaleToRef(e.inheritedVelocityAmount/2,U.Vector3[0]),e.particleSystem._inheritedVelocityOffset.copyFrom(U.Vector3[0])},i.prototype._inheritParticleInfoToSubEmitters=function(){var e=this;this._attachedSubEmitters&&this._attachedSubEmitters.length>0&&this._attachedSubEmitters.forEach(function(t){e._inheritParticleInfoToSubEmitter(t)})},i.prototype._reset=function(){this.age=0,this.id=i._Count++,this._currentColorGradient=null,this._currentSizeGradient=null,this._currentAngularSpeedGradient=null,this._currentVelocityGradient=null,this._currentLimitVelocityGradient=null,this._currentDragGradient=null,this.cellIndex=this.particleSystem.startSpriteCellID,this._randomCellOffset=void 0},i.prototype.copyTo=function(e){e.position.copyFrom(this.position),this._initialDirection?e._initialDirection?e._initialDirection.copyFrom(this._initialDirection):e._initialDirection=this._initialDirection.clone():e._initialDirection=null,e.direction.copyFrom(this.direction),this._localPosition&&(e._localPosition?e._localPosition.copyFrom(this._localPosition):e._localPosition=this._localPosition.clone()),e.color.copyFrom(this.color),e.colorStep.copyFrom(this.colorStep),e.lifeTime=this.lifeTime,e.age=this.age,e._randomCellOffset=this._randomCellOffset,e.size=this.size,e.scale.copyFrom(this.scale),e.angle=this.angle,e.angularSpeed=this.angularSpeed,e.particleSystem=this.particleSystem,e.cellIndex=this.cellIndex,e.id=this.id,e._attachedSubEmitters=this._attachedSubEmitters,this._currentColorGradient&&(e._currentColorGradient=this._currentColorGradient,e._currentColor1.copyFrom(this._currentColor1),e._currentColor2.copyFrom(this._currentColor2)),this._currentSizeGradient&&(e._currentSizeGradient=this._currentSizeGradient,e._currentSize1=this._currentSize1,e._currentSize2=this._currentSize2),this._currentAngularSpeedGradient&&(e._currentAngularSpeedGradient=this._currentAngularSpeedGradient,e._currentAngularSpeed1=this._currentAngularSpeed1,e._currentAngularSpeed2=this._currentAngularSpeed2),this._currentVelocityGradient&&(e._currentVelocityGradient=this._currentVelocityGradient,e._currentVelocity1=this._currentVelocity1,e._currentVelocity2=this._currentVelocity2),this._currentLimitVelocityGradient&&(e._currentLimitVelocityGradient=this._currentLimitVelocityGradient,e._currentLimitVelocity1=this._currentLimitVelocity1,e._currentLimitVelocity2=this._currentLimitVelocity2),this._currentDragGradient&&(e._currentDragGradient=this._currentDragGradient,e._currentDrag1=this._currentDrag1,e._currentDrag2=this._currentDrag2),this.particleSystem.isAnimationSheetEnabled&&(e._initialStartSpriteCellID=this._initialStartSpriteCellID,e._initialEndSpriteCellID=this._initialEndSpriteCellID,e._initialSpriteCellLoop=this._initialSpriteCellLoop),this.particleSystem.useRampGradients&&(e.remapData&&this.remapData?e.remapData.copyFrom(this.remapData):e.remapData=new Ke(0,0,0,0)),this._randomNoiseCoordinates1&&(e._randomNoiseCoordinates1?(e._randomNoiseCoordinates1.copyFrom(this._randomNoiseCoordinates1),e._randomNoiseCoordinates2.copyFrom(this._randomNoiseCoordinates2)):(e._randomNoiseCoordinates1=this._randomNoiseCoordinates1.clone(),e._randomNoiseCoordinates2=this._randomNoiseCoordinates2.clone()))},i._Count=0,i}(),Nr;(function(i){i[i.ATTACHED=0]="ATTACHED",i[i.END=1]="END"})(Nr||(Nr={}));var Yr=function(){function i(e){if(this.particleSystem=e,this.type=Nr.END,this.inheritDirection=!1,this.inheritedVelocityAmount=0,!e.emitter||!e.emitter.dispose){var t=lt("BABYLON.AbstractMesh");e.emitter=new t("SubemitterSystemEmitter",e.getScene()),e._disposeEmitterOnDispose=!0}}return i.prototype.clone=function(){var e=this.particleSystem.emitter;if(!e)e=new m;else if(e instanceof m)e=e.clone();else if(e.getClassName().indexOf("Mesh")!==-1){var t=lt("BABYLON.Mesh");e=new t("",e.getScene()),e.isVisible=!1}var r=new i(this.particleSystem.clone(this.particleSystem.name,e));return r.particleSystem.name+="Clone",r.type=this.type,r.inheritDirection=this.inheritDirection,r.inheritedVelocityAmount=this.inheritedVelocityAmount,r.particleSystem._disposeEmitterOnDispose=!0,r.particleSystem.disposeOnStop=!0,r},i.prototype.serialize=function(e){e===void 0&&(e=!1);var t={};return t.type=this.type,t.inheritDirection=this.inheritDirection,t.inheritedVelocityAmount=this.inheritedVelocityAmount,t.particleSystem=this.particleSystem.serialize(e),t},i._ParseParticleSystem=function(e,t,r,n){throw he("ParseParticle")},i.Parse=function(e,t,r){var n=e.particleSystem,a=new i(i._ParseParticleSystem(n,t,r,!0));return a.type=e.type,a.inheritDirection=e.inheritDirection,a.inheritedVelocityAmount=e.inheritedVelocityAmount,a.particleSystem._isSubEmitter=!0,a},i.prototype.dispose=function(){this.particleSystem.dispose()},i}(),nd="particlesPixelShader",ad=`varying vec2 vUV;
varying vec4 vColor;
uniform vec4 textureMask;
uniform sampler2D diffuseSampler;
#include<clipPlaneFragmentDeclaration>
#include<imageProcessingDeclaration>
#include<helperFunctions>
#include<imageProcessingFunctions>
#ifdef RAMPGRADIENT
varying vec4 remapRanges;
uniform sampler2D rampSampler;
#endif
#define CUSTOM_FRAGMENT_DEFINITIONS
void main(void) {
#define CUSTOM_FRAGMENT_MAIN_BEGIN
#include<clipPlaneFragment>
vec4 textureColor=texture2D(diffuseSampler,vUV);
vec4 baseColor=(textureColor*textureMask+(vec4(1.,1.,1.,1.)-textureMask))*vColor;
#ifdef RAMPGRADIENT
float alpha=baseColor.a;
float remappedColorIndex=clamp((alpha-remapRanges.x)/remapRanges.y,0.0,1.0);
vec4 rampColor=texture2D(rampSampler,vec2(1.0-remappedColorIndex,0.));
baseColor.rgb*=rampColor.rgb;
float finalAlpha=baseColor.a;
baseColor.a=clamp((alpha*rampColor.a-remapRanges.z)/remapRanges.w,0.0,1.0);
#endif
#ifdef BLENDMULTIPLYMODE
float sourceAlpha=vColor.a*textureColor.a;
baseColor.rgb=baseColor.rgb*sourceAlpha+vec3(1.0)*(1.0-sourceAlpha);
#endif
#ifdef IMAGEPROCESSINGPOSTPROCESS
baseColor.rgb=toLinearSpace(baseColor.rgb);
#else
#ifdef IMAGEPROCESSING
baseColor.rgb=toLinearSpace(baseColor.rgb);
baseColor=applyImageProcessing(baseColor);
#endif
#endif
gl_FragColor=baseColor;
#define CUSTOM_FRAGMENT_MAIN_END
}`;q.ShadersStore[nd]=ad;var sd="particlesVertexShader",od=`attribute vec3 position;
attribute vec4 color;
attribute float angle;
attribute vec2 size;
#ifdef ANIMATESHEET
attribute float cellIndex;
#endif
#ifndef BILLBOARD
attribute vec3 direction;
#endif
#ifdef BILLBOARDSTRETCHED
attribute vec3 direction;
#endif
#ifdef RAMPGRADIENT
attribute vec4 remapData;
#endif
attribute vec2 offset;
uniform mat4 view;
uniform mat4 projection;
uniform vec2 translationPivot;
#ifdef ANIMATESHEET
uniform vec3 particlesInfos; 
#endif
varying vec2 vUV;
varying vec4 vColor;
varying vec3 vPositionW;
#ifdef RAMPGRADIENT
varying vec4 remapRanges;
#endif
#if defined(BILLBOARD) && !defined(BILLBOARDY) && !defined(BILLBOARDSTRETCHED)
uniform mat4 invView;
#endif
#include<clipPlaneVertexDeclaration>
#ifdef BILLBOARD
uniform vec3 eyePosition;
#endif
vec3 rotate(vec3 yaxis,vec3 rotatedCorner) {
vec3 xaxis=normalize(cross(vec3(0.,1.0,0.),yaxis));
vec3 zaxis=normalize(cross(yaxis,xaxis));
vec3 row0=vec3(xaxis.x,xaxis.y,xaxis.z);
vec3 row1=vec3(yaxis.x,yaxis.y,yaxis.z);
vec3 row2=vec3(zaxis.x,zaxis.y,zaxis.z);
mat3 rotMatrix= mat3(row0,row1,row2);
vec3 alignedCorner=rotMatrix*rotatedCorner;
return position+alignedCorner;
}
#ifdef BILLBOARDSTRETCHED
vec3 rotateAlign(vec3 toCamera,vec3 rotatedCorner) {
vec3 normalizedToCamera=normalize(toCamera);
vec3 normalizedCrossDirToCamera=normalize(cross(normalize(direction),normalizedToCamera));
vec3 crossProduct=normalize(cross(normalizedToCamera,normalizedCrossDirToCamera));
vec3 row0=vec3(normalizedCrossDirToCamera.x,normalizedCrossDirToCamera.y,normalizedCrossDirToCamera.z);
vec3 row1=vec3(crossProduct.x,crossProduct.y,crossProduct.z);
vec3 row2=vec3(normalizedToCamera.x,normalizedToCamera.y,normalizedToCamera.z);
mat3 rotMatrix= mat3(row0,row1,row2);
vec3 alignedCorner=rotMatrix*rotatedCorner;
return position+alignedCorner;
}
#endif
#define CUSTOM_VERTEX_DEFINITIONS
void main(void) {
#define CUSTOM_VERTEX_MAIN_BEGIN
vec2 cornerPos;
cornerPos=(vec2(offset.x-0.5,offset.y -0.5)-translationPivot)*size+translationPivot;
#ifdef BILLBOARD
vec3 rotatedCorner;
#ifdef BILLBOARDY
rotatedCorner.x=cornerPos.x*cos(angle)-cornerPos.y*sin(angle);
rotatedCorner.z=cornerPos.x*sin(angle)+cornerPos.y*cos(angle);
rotatedCorner.y=0.;
vec3 yaxis=position-eyePosition;
yaxis.y=0.;
vPositionW=rotate(normalize(yaxis),rotatedCorner);
vec3 viewPos=(view*vec4(vPositionW,1.0)).xyz;
#elif defined(BILLBOARDSTRETCHED)
rotatedCorner.x=cornerPos.x*cos(angle)-cornerPos.y*sin(angle);
rotatedCorner.y=cornerPos.x*sin(angle)+cornerPos.y*cos(angle);
rotatedCorner.z=0.;
vec3 toCamera=position-eyePosition;
vPositionW=rotateAlign(toCamera,rotatedCorner);
vec3 viewPos=(view*vec4(vPositionW,1.0)).xyz;
#else
rotatedCorner.x=cornerPos.x*cos(angle)-cornerPos.y*sin(angle);
rotatedCorner.y=cornerPos.x*sin(angle)+cornerPos.y*cos(angle);
rotatedCorner.z=0.;
vec3 viewPos=(view*vec4(position,1.0)).xyz+rotatedCorner;
vPositionW=(invView*vec4(viewPos,1)).xyz;
#endif
#ifdef RAMPGRADIENT
remapRanges=remapData;
#endif
gl_Position=projection*vec4(viewPos,1.0);
#else
vec3 rotatedCorner;
rotatedCorner.x=cornerPos.x*cos(angle)-cornerPos.y*sin(angle);
rotatedCorner.z=cornerPos.x*sin(angle)+cornerPos.y*cos(angle);
rotatedCorner.y=0.;
vec3 yaxis=normalize(direction);
vPositionW=rotate(yaxis,rotatedCorner);
gl_Position=projection*view*vec4(vPositionW,1.0);
#endif
vColor=color;
#ifdef ANIMATESHEET
float rowOffset=floor(cellIndex*particlesInfos.z);
float columnOffset=cellIndex-rowOffset/particlesInfos.z;
vec2 uvScale=particlesInfos.xy;
vec2 uvOffset=vec2(offset.x ,1.0-offset.y);
vUV=(uvOffset+vec2(columnOffset,rowOffset))*uvScale;
#else
vUV=offset;
#endif
#if defined(CLIPPLANE) || defined(CLIPPLANE2) || defined(CLIPPLANE3) || defined(CLIPPLANE4) || defined(CLIPPLANE5) || defined(CLIPPLANE6)
vec4 worldPos=vec4(vPositionW,1.0);
#endif
#include<clipPlaneVertex>
#define CUSTOM_VERTEX_MAIN_END
}`;q.ShadersStore[sd]=od;var ld=function(i){$(e,i);function e(t,r,n,a,s,o){a===void 0&&(a=null),s===void 0&&(s=!1),o===void 0&&(o=.01);var l=i.call(this,t)||this;l._emitterInverseWorldMatrix=G.Identity(),l._inheritedVelocityOffset=new m,l.onDisposeObservable=new X,l.onStoppedObservable=new X,l._particles=new Array,l._stockParticles=new Array,l._newPartsExcess=0,l._vertexBuffers={},l._scaledColorStep=new ce(0,0,0,0),l._colorDiff=new ce(0,0,0,0),l._scaledDirection=m.Zero(),l._scaledGravity=m.Zero(),l._currentRenderId=-1,l._useInstancing=!1,l._started=!1,l._stopped=!1,l._actualFrame=0,l._currentEmitRate1=0,l._currentEmitRate2=0,l._currentStartSize1=0,l._currentStartSize2=0,l._rawTextureWidth=256,l._useRampGradients=!1,l._disposeEmitterOnDispose=!1,l.isLocal=!1,l._onBeforeDrawParticlesObservable=null,l.recycleParticle=function(f){var h=l._particles.pop();h!==f&&h.copyTo(f),l._stockParticles.push(h)},l._createParticle=function(){var f;if(l._stockParticles.length!==0?(f=l._stockParticles.pop(),f._reset()):f=new id(l),l._subEmitters&&l._subEmitters.length>0){var h=l._subEmitters[Math.floor(Math.random()*l._subEmitters.length)];f._attachedSubEmitters=[],h.forEach(function(c){if(c.type===Nr.ATTACHED){var d=c.clone();f._attachedSubEmitters.push(d),d.particleSystem.start()}})}return f},l._emitFromParticle=function(f){if(!(!l._subEmitters||l._subEmitters.length===0)){var h=Math.floor(Math.random()*l._subEmitters.length);l._subEmitters[h].forEach(function(c){if(c.type===Nr.END){var d=c.clone();f._inheritParticleInfoToSubEmitter(d),d.particleSystem._rootParticleSystem=l,l.activeSubSystems.push(d.particleSystem),d.particleSystem.start()}})}},l._capacity=r,l._epsilon=o,l._isAnimationSheetEnabled=s,!n||n.getClassName()==="Scene"?(l._scene=n||ye.LastCreatedScene,l._engine=l._scene.getEngine(),l.uniqueId=l._scene.getUniqueId(),l._scene.particleSystems.push(l)):(l._engine=n,l.defaultProjectionMatrix=G.PerspectiveFovLH(.8,1,.1,100,l._engine.isNDCHalfZRange)),l._engine.getCaps().vertexArrayObject&&(l._vertexArrayObject=null),l._attachImageProcessingConfiguration(null),l._customWrappers={0:new Bt(l._engine)},l._customWrappers[0].effect=a,l._drawWrappers=[],l._useInstancing=l._engine.getCaps().instancedArrays,l._createIndexBuffer(),l._createVertexBuffers(),l.particleEmitterType=new Kr;var u=null;return l.updateFunction=function(f){var h,c=null;l.noiseTexture&&(c=l.noiseTexture.getSize(),(h=l.noiseTexture.getContent())===null||h===void 0||h.then(function(g){u=g}));for(var d=function(g){var v=f[g],y=l._scaledUpdateSpeed,b=v.age;if(v.age+=y,v.age>v.lifeTime){var E=v.age-b,A=v.lifeTime-b;y=A*y/E,v.age=v.lifeTime}var S=v.age/v.lifeTime;l._colorGradients&&l._colorGradients.length>0?_t.GetCurrentGradient(S,l._colorGradients,function(k,B,L){k!==v._currentColorGradient&&(v._currentColor1.copyFrom(v._currentColor2),B.getColorToRef(v._currentColor2),v._currentColorGradient=k),ce.LerpToRef(v._currentColor1,v._currentColor2,L,v.color)}):(v.colorStep.scaleToRef(y,l._scaledColorStep),v.color.addInPlace(l._scaledColorStep),v.color.a<0&&(v.color.a=0)),l._angularSpeedGradients&&l._angularSpeedGradients.length>0&&_t.GetCurrentGradient(S,l._angularSpeedGradients,function(k,B,L){k!==v._currentAngularSpeedGradient&&(v._currentAngularSpeed1=v._currentAngularSpeed2,v._currentAngularSpeed2=B.getFactor(),v._currentAngularSpeedGradient=k),v.angularSpeed=K.Lerp(v._currentAngularSpeed1,v._currentAngularSpeed2,L)}),v.angle+=v.angularSpeed*y;var T=y;if(l._velocityGradients&&l._velocityGradients.length>0&&_t.GetCurrentGradient(S,l._velocityGradients,function(k,B,L){k!==v._currentVelocityGradient&&(v._currentVelocity1=v._currentVelocity2,v._currentVelocity2=B.getFactor(),v._currentVelocityGradient=k),T*=K.Lerp(v._currentVelocity1,v._currentVelocity2,L)}),v.direction.scaleToRef(T,l._scaledDirection),l._limitVelocityGradients&&l._limitVelocityGradients.length>0&&_t.GetCurrentGradient(S,l._limitVelocityGradients,function(k,B,L){k!==v._currentLimitVelocityGradient&&(v._currentLimitVelocity1=v._currentLimitVelocity2,v._currentLimitVelocity2=B.getFactor(),v._currentLimitVelocityGradient=k);var H=K.Lerp(v._currentLimitVelocity1,v._currentLimitVelocity2,L),W=v.direction.length();W>H&&v.direction.scaleInPlace(l.limitVelocityDamping)}),l._dragGradients&&l._dragGradients.length>0&&_t.GetCurrentGradient(S,l._dragGradients,function(k,B,L){k!==v._currentDragGradient&&(v._currentDrag1=v._currentDrag2,v._currentDrag2=B.getFactor(),v._currentDragGradient=k);var H=K.Lerp(v._currentDrag1,v._currentDrag2,L);l._scaledDirection.scaleInPlace(1-H)}),l.isLocal&&v._localPosition?(v._localPosition.addInPlace(l._scaledDirection),m.TransformCoordinatesToRef(v._localPosition,l._emitterWorldMatrix,v.position)):v.position.addInPlace(l._scaledDirection),u&&c&&v._randomNoiseCoordinates1){var M=l._fetchR(v._randomNoiseCoordinates1.x,v._randomNoiseCoordinates1.y,c.width,c.height,u),D=l._fetchR(v._randomNoiseCoordinates1.z,v._randomNoiseCoordinates2.x,c.width,c.height,u),x=l._fetchR(v._randomNoiseCoordinates2.y,v._randomNoiseCoordinates2.z,c.width,c.height,u),P=U.Vector3[0],w=U.Vector3[1];P.copyFromFloats((2*M-1)*l.noiseStrength.x,(2*D-1)*l.noiseStrength.y,(2*x-1)*l.noiseStrength.z),P.scaleToRef(y,w),v.direction.addInPlace(w)}if(l.gravity.scaleToRef(y,l._scaledGravity),v.direction.addInPlace(l._scaledGravity),l._sizeGradients&&l._sizeGradients.length>0&&_t.GetCurrentGradient(S,l._sizeGradients,function(k,B,L){k!==v._currentSizeGradient&&(v._currentSize1=v._currentSize2,v._currentSize2=B.getFactor(),v._currentSizeGradient=k),v.size=K.Lerp(v._currentSize1,v._currentSize2,L)}),l._useRampGradients&&(l._colorRemapGradients&&l._colorRemapGradients.length>0&&_t.GetCurrentGradient(S,l._colorRemapGradients,function(k,B,L){var H=K.Lerp(k.factor1,B.factor1,L),W=K.Lerp(k.factor2,B.factor2,L);v.remapData.x=H,v.remapData.y=W-H}),l._alphaRemapGradients&&l._alphaRemapGradients.length>0&&_t.GetCurrentGradient(S,l._alphaRemapGradients,function(k,B,L){var H=K.Lerp(k.factor1,B.factor1,L),W=K.Lerp(k.factor2,B.factor2,L);v.remapData.z=H,v.remapData.w=W-H})),l._isAnimationSheetEnabled&&v.updateCellIndex(),v._inheritParticleInfoToSubEmitters(),v.age>=v.lifeTime)return l._emitFromParticle(v),v._attachedSubEmitters&&(v._attachedSubEmitters.forEach(function(k){k.particleSystem.disposeOnStop=!0,k.particleSystem.stop()}),v._attachedSubEmitters=null),l.recycleParticle(v),g--,p=g,"continue";p=g},p,_=0;_<f.length;_++)d(_),_=p},l}return Object.defineProperty(e.prototype,"onDispose",{set:function(t){this._onDisposeObserver&&this.onDisposeObservable.remove(this._onDisposeObserver),this._onDisposeObserver=this.onDisposeObservable.add(t)},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"useRampGradients",{get:function(){return this._useRampGradients},set:function(t){this._useRampGradients!==t&&(this._useRampGradients=t,this._resetEffect())},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"particles",{get:function(){return this._particles},enumerable:!1,configurable:!0}),e.prototype.getActiveCount=function(){return this._particles.length},e.prototype.getClassName=function(){return"ParticleSystem"},e.prototype.isStopping=function(){return this._stopped&&this.isAlive()},e.prototype.getCustomEffect=function(t){var r,n;return t===void 0&&(t=0),(n=(r=this._customWrappers[t])===null||r===void 0?void 0:r.effect)!==null&&n!==void 0?n:this._customWrappers[0].effect},e.prototype._getCustomDrawWrapper=function(t){var r;return t===void 0&&(t=0),(r=this._customWrappers[t])!==null&&r!==void 0?r:this._customWrappers[0]},e.prototype.setCustomEffect=function(t,r){r===void 0&&(r=0),this._customWrappers[r]=new Bt(this._engine),this._customWrappers[r].effect=t,this._customWrappers[r].drawContext&&(this._customWrappers[r].drawContext.useInstancing=this._useInstancing)},Object.defineProperty(e.prototype,"onBeforeDrawParticlesObservable",{get:function(){return this._onBeforeDrawParticlesObservable||(this._onBeforeDrawParticlesObservable=new X),this._onBeforeDrawParticlesObservable},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"vertexShaderName",{get:function(){return"particles"},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"vertexBuffers",{get:function(){return this._vertexBuffers},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"indexBuffer",{get:function(){return this._indexBuffer},enumerable:!1,configurable:!0}),e.prototype._addFactorGradient=function(t,r,n,a){var s=new Hc(r,n,a);t.push(s),t.sort(function(o,l){return o.gradient<l.gradient?-1:o.gradient>l.gradient?1:0})},e.prototype._removeFactorGradient=function(t,r){if(!!t)for(var n=0,a=0,s=t;a<s.length;a++){var o=s[a];if(o.gradient===r){t.splice(n,1);break}n++}},e.prototype.addLifeTimeGradient=function(t,r,n){return this._lifeTimeGradients||(this._lifeTimeGradients=[]),this._addFactorGradient(this._lifeTimeGradients,t,r,n),this},e.prototype.removeLifeTimeGradient=function(t){return this._removeFactorGradient(this._lifeTimeGradients,t),this},e.prototype.addSizeGradient=function(t,r,n){return this._sizeGradients||(this._sizeGradients=[]),this._addFactorGradient(this._sizeGradients,t,r,n),this},e.prototype.removeSizeGradient=function(t){return this._removeFactorGradient(this._sizeGradients,t),this},e.prototype.addColorRemapGradient=function(t,r,n){return this._colorRemapGradients||(this._colorRemapGradients=[]),this._addFactorGradient(this._colorRemapGradients,t,r,n),this},e.prototype.removeColorRemapGradient=function(t){return this._removeFactorGradient(this._colorRemapGradients,t),this},e.prototype.addAlphaRemapGradient=function(t,r,n){return this._alphaRemapGradients||(this._alphaRemapGradients=[]),this._addFactorGradient(this._alphaRemapGradients,t,r,n),this},e.prototype.removeAlphaRemapGradient=function(t){return this._removeFactorGradient(this._alphaRemapGradients,t),this},e.prototype.addAngularSpeedGradient=function(t,r,n){return this._angularSpeedGradients||(this._angularSpeedGradients=[]),this._addFactorGradient(this._angularSpeedGradients,t,r,n),this},e.prototype.removeAngularSpeedGradient=function(t){return this._removeFactorGradient(this._angularSpeedGradients,t),this},e.prototype.addVelocityGradient=function(t,r,n){return this._velocityGradients||(this._velocityGradients=[]),this._addFactorGradient(this._velocityGradients,t,r,n),this},e.prototype.removeVelocityGradient=function(t){return this._removeFactorGradient(this._velocityGradients,t),this},e.prototype.addLimitVelocityGradient=function(t,r,n){return this._limitVelocityGradients||(this._limitVelocityGradients=[]),this._addFactorGradient(this._limitVelocityGradients,t,r,n),this},e.prototype.removeLimitVelocityGradient=function(t){return this._removeFactorGradient(this._limitVelocityGradients,t),this},e.prototype.addDragGradient=function(t,r,n){return this._dragGradients||(this._dragGradients=[]),this._addFactorGradient(this._dragGradients,t,r,n),this},e.prototype.removeDragGradient=function(t){return this._removeFactorGradient(this._dragGradients,t),this},e.prototype.addEmitRateGradient=function(t,r,n){return this._emitRateGradients||(this._emitRateGradients=[]),this._addFactorGradient(this._emitRateGradients,t,r,n),this},e.prototype.removeEmitRateGradient=function(t){return this._removeFactorGradient(this._emitRateGradients,t),this},e.prototype.addStartSizeGradient=function(t,r,n){return this._startSizeGradients||(this._startSizeGradients=[]),this._addFactorGradient(this._startSizeGradients,t,r,n),this},e.prototype.removeStartSizeGradient=function(t){return this._removeFactorGradient(this._startSizeGradients,t),this},e.prototype._createRampGradientTexture=function(){if(!(!this._rampGradients||!this._rampGradients.length||this._rampGradientsTexture||!this._scene)){for(var t=new Uint8Array(this._rawTextureWidth*4),r=Ar.Color3[0],n=function(o){var l=o/a._rawTextureWidth;_t.GetCurrentGradient(l,a._rampGradients,function(u,f,h){me.LerpToRef(u.color,f.color,h,r),t[o*4]=r.r*255,t[o*4+1]=r.g*255,t[o*4+2]=r.b*255,t[o*4+3]=255})},a=this,s=0;s<this._rawTextureWidth;s++)n(s);this._rampGradientsTexture=Ki.CreateRGBATexture(t,this._rawTextureWidth,1,this._scene,!1,!1,1)}},e.prototype.getRampGradients=function(){return this._rampGradients},e.prototype.forceRefreshGradients=function(){this._syncRampGradientTexture()},e.prototype._syncRampGradientTexture=function(){!this._rampGradients||(this._rampGradients.sort(function(t,r){return t.gradient<r.gradient?-1:t.gradient>r.gradient?1:0}),this._rampGradientsTexture&&(this._rampGradientsTexture.dispose(),this._rampGradientsTexture=null),this._createRampGradientTexture())},e.prototype.addRampGradient=function(t,r){this._rampGradients||(this._rampGradients=[]);var n=new Wc(t,r);return this._rampGradients.push(n),this._syncRampGradientTexture(),this},e.prototype.removeRampGradient=function(t){return this._removeGradientAndTexture(t,this._rampGradients,this._rampGradientsTexture),this._rampGradientsTexture=null,this._rampGradients&&this._rampGradients.length>0&&this._createRampGradientTexture(),this},e.prototype.addColorGradient=function(t,r,n){this._colorGradients||(this._colorGradients=[]);var a=new zc(t,r,n);return this._colorGradients.push(a),this._colorGradients.sort(function(s,o){return s.gradient<o.gradient?-1:s.gradient>o.gradient?1:0}),this},e.prototype.removeColorGradient=function(t){if(!this._colorGradients)return this;for(var r=0,n=0,a=this._colorGradients;n<a.length;n++){var s=a[n];if(s.gradient===t){this._colorGradients.splice(r,1);break}r++}return this},e.prototype.resetDrawCache=function(){for(var t=0,r=this._drawWrappers;t<r.length;t++){var n=r[t];if(n)for(var a=0,s=n;a<s.length;a++){var o=s[a];o==null||o.dispose()}}this._drawWrappers=[]},e.prototype._fetchR=function(t,r,n,a,s){t=Math.abs(t)*.5+.5,r=Math.abs(r)*.5+.5;var o=t*n%n|0,l=r*a%a|0,u=(o+l*n)*4;return s[u]/255},e.prototype._reset=function(){this._resetEffect()},e.prototype._resetEffect=function(){this._vertexBuffer&&(this._vertexBuffer.dispose(),this._vertexBuffer=null),this._spriteBuffer&&(this._spriteBuffer.dispose(),this._spriteBuffer=null),this._vertexArrayObject&&(this._engine.releaseVertexArrayObject(this._vertexArrayObject),this._vertexArrayObject=null),this._createVertexBuffers()},e.prototype._createVertexBuffers=function(){this._vertexBufferSize=this._useInstancing?10:12,this._isAnimationSheetEnabled&&(this._vertexBufferSize+=1),(!this._isBillboardBased||this.billboardMode===e.BILLBOARDMODE_STRETCHED)&&(this._vertexBufferSize+=3),this._useRampGradients&&(this._vertexBufferSize+=4);var t=this._engine,r=this._vertexBufferSize*(this._useInstancing?1:4);this._vertexData=new Float32Array(this._capacity*r),this._vertexBuffer=new mr(t,this._vertexData,!0,r);var n=0,a=this._vertexBuffer.createVertexBuffer(R.PositionKind,n,3,this._vertexBufferSize,this._useInstancing);this._vertexBuffers[R.PositionKind]=a,n+=3;var s=this._vertexBuffer.createVertexBuffer(R.ColorKind,n,4,this._vertexBufferSize,this._useInstancing);this._vertexBuffers[R.ColorKind]=s,n+=4;var o=this._vertexBuffer.createVertexBuffer("angle",n,1,this._vertexBufferSize,this._useInstancing);this._vertexBuffers.angle=o,n+=1;var l=this._vertexBuffer.createVertexBuffer("size",n,2,this._vertexBufferSize,this._useInstancing);if(this._vertexBuffers.size=l,n+=2,this._isAnimationSheetEnabled){var u=this._vertexBuffer.createVertexBuffer("cellIndex",n,1,this._vertexBufferSize,this._useInstancing);this._vertexBuffers.cellIndex=u,n+=1}if(!this._isBillboardBased||this.billboardMode===e.BILLBOARDMODE_STRETCHED){var f=this._vertexBuffer.createVertexBuffer("direction",n,3,this._vertexBufferSize,this._useInstancing);this._vertexBuffers.direction=f,n+=3}if(this._useRampGradients){var h=this._vertexBuffer.createVertexBuffer("remapData",n,4,this._vertexBufferSize,this._useInstancing);this._vertexBuffers.remapData=h,n+=4}var c;if(this._useInstancing){var d=new Float32Array([0,0,1,0,0,1,1,1]);this._spriteBuffer=new mr(t,d,!1,2),c=this._spriteBuffer.createVertexBuffer("offset",0,2)}else c=this._vertexBuffer.createVertexBuffer("offset",n,2,this._vertexBufferSize,this._useInstancing),n+=2;this._vertexBuffers.offset=c,this.resetDrawCache()},e.prototype._createIndexBuffer=function(){if(!this._useInstancing){for(var t=[],r=0,n=0;n<this._capacity;n++)t.push(r),t.push(r+1),t.push(r+2),t.push(r),t.push(r+2),t.push(r+3),r+=4;this._indexBuffer=this._engine.createIndexBuffer(t)}},e.prototype.getCapacity=function(){return this._capacity},e.prototype.isAlive=function(){return this._alive},e.prototype.isStarted=function(){return this._started},e.prototype._prepareSubEmitterInternalArray=function(){var t=this;this._subEmitters=new Array,this.subEmitters&&this.subEmitters.forEach(function(r){r instanceof e?t._subEmitters.push([new Yr(r)]):r instanceof Yr?t._subEmitters.push([r]):r instanceof Array&&t._subEmitters.push(r)})},e.prototype.start=function(t){var r=this,n;if(t===void 0&&(t=this.startDelay),!this.targetStopDuration&&this._hasTargetStopDurationDependantGradient())throw"Particle system started with a targetStopDuration dependant gradient (eg. startSizeGradients) but no targetStopDuration set";if(t){setTimeout(function(){r.start(0)},t);return}if(this._prepareSubEmitterInternalArray(),this._started=!0,this._stopped=!1,this._actualFrame=0,this._subEmitters&&this._subEmitters.length!=0&&(this.activeSubSystems=new Array),this._emitRateGradients&&(this._emitRateGradients.length>0&&(this._currentEmitRateGradient=this._emitRateGradients[0],this._currentEmitRate1=this._currentEmitRateGradient.getFactor(),this._currentEmitRate2=this._currentEmitRate1),this._emitRateGradients.length>1&&(this._currentEmitRate2=this._emitRateGradients[1].getFactor())),this._startSizeGradients&&(this._startSizeGradients.length>0&&(this._currentStartSizeGradient=this._startSizeGradients[0],this._currentStartSize1=this._currentStartSizeGradient.getFactor(),this._currentStartSize2=this._currentStartSize1),this._startSizeGradients.length>1&&(this._currentStartSize2=this._startSizeGradients[1].getFactor())),this.preWarmCycles){((n=this.emitter)===null||n===void 0?void 0:n.getClassName().indexOf("Mesh"))!==-1&&this.emitter.computeWorldMatrix(!0);var a=this.noiseTexture;if(a&&a.onGeneratedObservable)a.onGeneratedObservable.addOnce(function(){setTimeout(function(){for(var o=0;o<r.preWarmCycles;o++)r.animate(!0),a.render()})});else for(var s=0;s<this.preWarmCycles;s++)this.animate(!0)}this.beginAnimationOnStart&&this.animations&&this.animations.length>0&&this._scene&&this._scene.beginAnimation(this,this.beginAnimationFrom,this.beginAnimationTo,this.beginAnimationLoop)},e.prototype.stop=function(t){t===void 0&&(t=!0),!this._stopped&&(this.onStoppedObservable.notifyObservers(this),this._stopped=!0,t&&this._stopSubEmitters())},e.prototype.reset=function(){this._stockParticles=[],this._particles=[]},e.prototype._appendParticleVertex=function(t,r,n,a){var s=t*this._vertexBufferSize;if(this._vertexData[s++]=r.position.x+this.worldOffset.x,this._vertexData[s++]=r.position.y+this.worldOffset.y,this._vertexData[s++]=r.position.z+this.worldOffset.z,this._vertexData[s++]=r.color.r,this._vertexData[s++]=r.color.g,this._vertexData[s++]=r.color.b,this._vertexData[s++]=r.color.a,this._vertexData[s++]=r.angle,this._vertexData[s++]=r.scale.x*r.size,this._vertexData[s++]=r.scale.y*r.size,this._isAnimationSheetEnabled&&(this._vertexData[s++]=r.cellIndex),this._isBillboardBased)this.billboardMode===e.BILLBOARDMODE_STRETCHED&&(this._vertexData[s++]=r.direction.x,this._vertexData[s++]=r.direction.y,this._vertexData[s++]=r.direction.z);else if(r._initialDirection){var o=r._initialDirection;this.isLocal&&(m.TransformNormalToRef(o,this._emitterWorldMatrix,U.Vector3[0]),o=U.Vector3[0]),o.x===0&&o.z===0&&(o.x=.001),this._vertexData[s++]=o.x,this._vertexData[s++]=o.y,this._vertexData[s++]=o.z}else{var l=r.direction;this.isLocal&&(m.TransformNormalToRef(l,this._emitterWorldMatrix,U.Vector3[0]),l=U.Vector3[0]),l.x===0&&l.z===0&&(l.x=.001),this._vertexData[s++]=l.x,this._vertexData[s++]=l.y,this._vertexData[s++]=l.z}this._useRampGradients&&r.remapData&&(this._vertexData[s++]=r.remapData.x,this._vertexData[s++]=r.remapData.y,this._vertexData[s++]=r.remapData.z,this._vertexData[s++]=r.remapData.w),this._useInstancing||(this._isAnimationSheetEnabled&&(n===0?n=this._epsilon:n===1&&(n=1-this._epsilon),a===0?a=this._epsilon:a===1&&(a=1-this._epsilon)),this._vertexData[s++]=n,this._vertexData[s++]=a)},e.prototype._stopSubEmitters=function(){!this.activeSubSystems||(this.activeSubSystems.forEach(function(t){t.stop(!0)}),this.activeSubSystems=new Array)},e.prototype._removeFromRoot=function(){if(!!this._rootParticleSystem){var t=this._rootParticleSystem.activeSubSystems.indexOf(this);t!==-1&&this._rootParticleSystem.activeSubSystems.splice(t,1),this._rootParticleSystem=null}},e.prototype._update=function(t){var r=this;if(this._alive=this._particles.length>0,this.emitter.position){var n=this.emitter;this._emitterWorldMatrix=n.getWorldMatrix()}else{var a=this.emitter;this._emitterWorldMatrix=G.Translation(a.x,a.y,a.z)}this._emitterWorldMatrix.invertToRef(this._emitterInverseWorldMatrix),this.updateFunction(this._particles);for(var s,o=function(h){if(l._particles.length===l._capacity)return"break";if(s=l._createParticle(),l._particles.push(s),l.targetStopDuration&&l._lifeTimeGradients&&l._lifeTimeGradients.length>0){var c=K.Clamp(l._actualFrame/l.targetStopDuration);_t.GetCurrentGradient(c,l._lifeTimeGradients,function(g,v){var y=g,b=v,E=y.getFactor(),A=b.getFactor(),S=(c-y.gradient)/(b.gradient-y.gradient);s.lifeTime=K.Lerp(E,A,S)})}else s.lifeTime=K.RandomRange(l.minLifeTime,l.maxLifeTime);var d=K.RandomRange(l.minEmitPower,l.maxEmitPower);if(l.startPositionFunction?l.startPositionFunction(l._emitterWorldMatrix,s.position,s,l.isLocal):l.particleEmitterType.startPositionFunction(l._emitterWorldMatrix,s.position,s,l.isLocal),l.isLocal&&(s._localPosition?s._localPosition.copyFrom(s.position):s._localPosition=s.position.clone(),m.TransformCoordinatesToRef(s._localPosition,l._emitterWorldMatrix,s.position)),l.startDirectionFunction?l.startDirectionFunction(l._emitterWorldMatrix,s.direction,s,l.isLocal):l.particleEmitterType.startDirectionFunction(l._emitterWorldMatrix,s.direction,s,l.isLocal,l._emitterInverseWorldMatrix),d===0?s._initialDirection?s._initialDirection.copyFrom(s.direction):s._initialDirection=s.direction.clone():s._initialDirection=null,s.direction.scaleInPlace(d),!l._sizeGradients||l._sizeGradients.length===0?s.size=K.RandomRange(l.minSize,l.maxSize):(s._currentSizeGradient=l._sizeGradients[0],s._currentSize1=s._currentSizeGradient.getFactor(),s.size=s._currentSize1,l._sizeGradients.length>1?s._currentSize2=l._sizeGradients[1].getFactor():s._currentSize2=s._currentSize1),s.scale.copyFromFloats(K.RandomRange(l.minScaleX,l.maxScaleX),K.RandomRange(l.minScaleY,l.maxScaleY)),l._startSizeGradients&&l._startSizeGradients[0]&&l.targetStopDuration){var p=l._actualFrame/l.targetStopDuration;_t.GetCurrentGradient(p,l._startSizeGradients,function(g,v,y){g!==r._currentStartSizeGradient&&(r._currentStartSize1=r._currentStartSize2,r._currentStartSize2=v.getFactor(),r._currentStartSizeGradient=g);var b=K.Lerp(r._currentStartSize1,r._currentStartSize2,y);s.scale.scaleInPlace(b)})}if(!l._angularSpeedGradients||l._angularSpeedGradients.length===0?s.angularSpeed=K.RandomRange(l.minAngularSpeed,l.maxAngularSpeed):(s._currentAngularSpeedGradient=l._angularSpeedGradients[0],s.angularSpeed=s._currentAngularSpeedGradient.getFactor(),s._currentAngularSpeed1=s.angularSpeed,l._angularSpeedGradients.length>1?s._currentAngularSpeed2=l._angularSpeedGradients[1].getFactor():s._currentAngularSpeed2=s._currentAngularSpeed1),s.angle=K.RandomRange(l.minInitialRotation,l.maxInitialRotation),l._velocityGradients&&l._velocityGradients.length>0&&(s._currentVelocityGradient=l._velocityGradients[0],s._currentVelocity1=s._currentVelocityGradient.getFactor(),l._velocityGradients.length>1?s._currentVelocity2=l._velocityGradients[1].getFactor():s._currentVelocity2=s._currentVelocity1),l._limitVelocityGradients&&l._limitVelocityGradients.length>0&&(s._currentLimitVelocityGradient=l._limitVelocityGradients[0],s._currentLimitVelocity1=s._currentLimitVelocityGradient.getFactor(),l._limitVelocityGradients.length>1?s._currentLimitVelocity2=l._limitVelocityGradients[1].getFactor():s._currentLimitVelocity2=s._currentLimitVelocity1),l._dragGradients&&l._dragGradients.length>0&&(s._currentDragGradient=l._dragGradients[0],s._currentDrag1=s._currentDragGradient.getFactor(),l._dragGradients.length>1?s._currentDrag2=l._dragGradients[1].getFactor():s._currentDrag2=s._currentDrag1),!l._colorGradients||l._colorGradients.length===0){var _=K.RandomRange(0,1);ce.LerpToRef(l.color1,l.color2,_,s.color),l.colorDead.subtractToRef(s.color,l._colorDiff),l._colorDiff.scaleToRef(1/s.lifeTime,s.colorStep)}else s._currentColorGradient=l._colorGradients[0],s._currentColorGradient.getColorToRef(s.color),s._currentColor1.copyFrom(s.color),l._colorGradients.length>1?l._colorGradients[1].getColorToRef(s._currentColor2):s._currentColor2.copyFrom(s.color);l._isAnimationSheetEnabled&&(s._initialStartSpriteCellID=l.startSpriteCellID,s._initialEndSpriteCellID=l.endSpriteCellID,s._initialSpriteCellLoop=l.spriteCellLoop),s.direction.addInPlace(l._inheritedVelocityOffset),l._useRampGradients&&(s.remapData=new Ke(0,1,0,1)),l.noiseTexture&&(s._randomNoiseCoordinates1?(s._randomNoiseCoordinates1.copyFromFloats(Math.random(),Math.random(),Math.random()),s._randomNoiseCoordinates2.copyFromFloats(Math.random(),Math.random(),Math.random())):(s._randomNoiseCoordinates1=new m(Math.random(),Math.random(),Math.random()),s._randomNoiseCoordinates2=new m(Math.random(),Math.random(),Math.random()))),s._inheritParticleInfoToSubEmitters()},l=this,u=0;u<t;u++){var f=o();if(f==="break")break}},e._GetAttributeNamesOrOptions=function(t,r,n){t===void 0&&(t=!1),r===void 0&&(r=!1),n===void 0&&(n=!1);var a=[R.PositionKind,R.ColorKind,"angle","offset","size"];return t&&a.push("cellIndex"),r||a.push("direction"),n&&a.push("remapData"),a},e._GetEffectCreationOptions=function(t){t===void 0&&(t=!1);var r=["invView","view","projection","vClipPlane","vClipPlane2","vClipPlane3","vClipPlane4","vClipPlane5","vClipPlane6","textureMask","translationPivot","eyePosition"];return t&&r.push("particlesInfos"),r},e.prototype.fillDefines=function(t,r){if(this._scene&&(this._scene.clipPlane&&t.push("#define CLIPPLANE"),this._scene.clipPlane2&&t.push("#define CLIPPLANE2"),this._scene.clipPlane3&&t.push("#define CLIPPLANE3"),this._scene.clipPlane4&&t.push("#define CLIPPLANE4"),this._scene.clipPlane5&&t.push("#define CLIPPLANE5"),this._scene.clipPlane6&&t.push("#define CLIPPLANE6")),this._isAnimationSheetEnabled&&t.push("#define ANIMATESHEET"),r===e.BLENDMODE_MULTIPLY&&t.push("#define BLENDMULTIPLYMODE"),this._useRampGradients&&t.push("#define RAMPGRADIENT"),this._isBillboardBased)switch(t.push("#define BILLBOARD"),this.billboardMode){case e.BILLBOARDMODE_Y:t.push("#define BILLBOARDY");break;case e.BILLBOARDMODE_STRETCHED:t.push("#define BILLBOARDSTRETCHED");break;case e.BILLBOARDMODE_ALL:t.push("#define BILLBOARDMODE_ALL");break}this._imageProcessingConfiguration&&(this._imageProcessingConfiguration.prepareDefines(this._imageProcessingConfigurationDefines),t.push(this._imageProcessingConfigurationDefines.toString()))},e.prototype.fillUniformsAttributesAndSamplerNames=function(t,r,n){r.push.apply(r,e._GetAttributeNamesOrOptions(this._isAnimationSheetEnabled,this._isBillboardBased&&this.billboardMode!==e.BILLBOARDMODE_STRETCHED,this._useRampGradients)),t.push.apply(t,e._GetEffectCreationOptions(this._isAnimationSheetEnabled)),n.push("diffuseSampler","rampSampler"),this._imageProcessingConfiguration&&(Tt.PrepareUniforms(t,this._imageProcessingConfigurationDefines),Tt.PrepareSamplers(n,this._imageProcessingConfigurationDefines))},e.prototype._getWrapper=function(t){var r=this._getCustomDrawWrapper(t);if(r!=null&&r.effect)return r;var n=[];this.fillDefines(n,t);var a=this._engine._features.supportRenderPasses?this._engine.currentRenderPassId:0,s=this._drawWrappers[a];s||(s=this._drawWrappers[a]=[]);var o=s[t];o||(o=new Bt(this._engine),o.drawContext&&(o.drawContext.useInstancing=this._useInstancing),s[t]=o);var l=n.join(`
`);if(o.defines!==l){var u=[],f=[],h=[];this.fillUniformsAttributesAndSamplerNames(f,u,h),o.setEffect(this._engine.createEffect("particles",u,f,h,l),l)}return o},e.prototype.animate=function(t){var r=this,n;if(t===void 0&&(t=!1),!!this._started){if(!t&&this._scene){if(!this.isReady()||this._currentRenderId===this._scene.getFrameId())return;this._currentRenderId=this._scene.getFrameId()}this._scaledUpdateSpeed=this.updateSpeed*(t?this.preWarmStepOffset:((n=this._scene)===null||n===void 0?void 0:n.getAnimationRatio())||1);var a;if(this.manualEmitCount>-1)a=this.manualEmitCount,this._newPartsExcess=0,this.manualEmitCount=0;else{var s=this.emitRate;if(this._emitRateGradients&&this._emitRateGradients.length>0&&this.targetStopDuration){var o=this._actualFrame/this.targetStopDuration;_t.GetCurrentGradient(o,this._emitRateGradients,function(h,c,d){h!==r._currentEmitRateGradient&&(r._currentEmitRate1=r._currentEmitRate2,r._currentEmitRate2=c.getFactor(),r._currentEmitRateGradient=h),s=K.Lerp(r._currentEmitRate1,r._currentEmitRate2,d)})}a=s*this._scaledUpdateSpeed>>0,this._newPartsExcess+=s*this._scaledUpdateSpeed-a}if(this._newPartsExcess>1&&(a+=this._newPartsExcess>>0,this._newPartsExcess-=this._newPartsExcess>>0),this._alive=!1,this._stopped?a=0:(this._actualFrame+=this._scaledUpdateSpeed,this.targetStopDuration&&this._actualFrame>=this.targetStopDuration&&this.stop()),this._update(a),this._stopped&&(this._alive||(this._started=!1,this.onAnimationEnd&&this.onAnimationEnd(),this.disposeOnStop&&this._scene&&this._scene._toBeDisposed.push(this))),!t){for(var l=0,u=0;u<this._particles.length;u++){var f=this._particles[u];this._appendParticleVertices(l,f),l+=this._useInstancing?1:4}this._vertexBuffer&&this._vertexBuffer.updateDirectly(this._vertexData,0,this._particles.length)}this.manualEmitCount===0&&this.disposeOnStop&&this.stop()}},e.prototype._appendParticleVertices=function(t,r){this._appendParticleVertex(t++,r,0,0),this._useInstancing||(this._appendParticleVertex(t++,r,1,0),this._appendParticleVertex(t++,r,1,1),this._appendParticleVertex(t++,r,0,1))},e.prototype.rebuild=function(){var t,r;this._engine.getCaps().vertexArrayObject&&(this._vertexArrayObject=null),this._createIndexBuffer(),(t=this._spriteBuffer)===null||t===void 0||t._rebuild(),(r=this._vertexBuffer)===null||r===void 0||r._rebuild();for(var n in this._vertexBuffers)this._vertexBuffers[n]._rebuild();this.resetDrawCache()},e.prototype.isReady=function(){if(!this.emitter||this._imageProcessingConfiguration&&!this._imageProcessingConfiguration.isReady()||!this.particleTexture||!this.particleTexture.isReady())return!1;if(this.blendMode!==e.BLENDMODE_MULTIPLYADD){if(!this._getWrapper(this.blendMode).effect.isReady())return!1}else if(!this._getWrapper(e.BLENDMODE_MULTIPLY).effect.isReady()||!this._getWrapper(e.BLENDMODE_ADD).effect.isReady())return!1;return!0},e.prototype._render=function(t){var r,n,a=this._getWrapper(t),s=a.effect,o=this._engine;o.enableEffect(a);var l=(r=this.defaultViewMatrix)!==null&&r!==void 0?r:this._scene.getViewMatrix();if(s.setTexture("diffuseSampler",this.particleTexture),s.setMatrix("view",l),s.setMatrix("projection",(n=this.defaultProjectionMatrix)!==null&&n!==void 0?n:this._scene.getProjectionMatrix()),this._isAnimationSheetEnabled&&this.particleTexture){var u=this.particleTexture.getBaseSize();s.setFloat3("particlesInfos",this.spriteCellWidth/u.width,this.spriteCellHeight/u.height,this.spriteCellWidth/u.width)}if(s.setVector2("translationPivot",this.translationPivot),s.setFloat4("textureMask",this.textureMask.r,this.textureMask.g,this.textureMask.b,this.textureMask.a),this._isBillboardBased&&this._scene){var f=this._scene.activeCamera;s.setVector3("eyePosition",f.globalPosition)}this._rampGradientsTexture&&((!this._rampGradients||!this._rampGradients.length)&&(this._rampGradientsTexture.dispose(),this._rampGradientsTexture=null),s.setTexture("rampSampler",this._rampGradientsTexture));var h=s.defines;switch(this._scene&&(this._scene.clipPlane||this._scene.clipPlane2||this._scene.clipPlane3||this._scene.clipPlane4||this._scene.clipPlane5||this._scene.clipPlane6)&&za.BindClipPlane(s,this._scene),h.indexOf("#define BILLBOARDMODE_ALL")>=0&&(l.invertToRef(U.Matrix[0]),s.setMatrix("invView",U.Matrix[0])),this._vertexArrayObject!==void 0?(this._vertexArrayObject||(this._vertexArrayObject=this._engine.recordVertexArrayObject(this._vertexBuffers,this._indexBuffer,s)),this._engine.bindVertexArrayObject(this._vertexArrayObject,this._indexBuffer)):o.bindBuffers(this._vertexBuffers,this._indexBuffer,s),this._imageProcessingConfiguration&&!this._imageProcessingConfiguration.applyByPostProcess&&this._imageProcessingConfiguration.bind(s),t){case e.BLENDMODE_ADD:o.setAlphaMode(1);break;case e.BLENDMODE_ONEONE:o.setAlphaMode(6);break;case e.BLENDMODE_STANDARD:o.setAlphaMode(2);break;case e.BLENDMODE_MULTIPLY:o.setAlphaMode(4);break}return this._onBeforeDrawParticlesObservable&&this._onBeforeDrawParticlesObservable.notifyObservers(s),this._useInstancing?o.drawArraysType(7,0,4,this._particles.length):o.drawElementsType(0,0,this._particles.length*6),this._particles.length},e.prototype.render=function(){if(!this.isReady()||!this._particles.length)return 0;var t=this._engine;t.setState&&(t.setState(!1),this.forceDepthWrite&&t.setDepthWrite(!0));var r=0;return this.blendMode===e.BLENDMODE_MULTIPLYADD?r=this._render(e.BLENDMODE_MULTIPLY)+this._render(e.BLENDMODE_ADD):r=this._render(this.blendMode),this._engine.unbindInstanceAttributes(),this._engine.setAlphaMode(0),r},e.prototype.dispose=function(t){if(t===void 0&&(t=!0),this.resetDrawCache(),this._vertexBuffer&&(this._vertexBuffer.dispose(),this._vertexBuffer=null),this._spriteBuffer&&(this._spriteBuffer.dispose(),this._spriteBuffer=null),this._indexBuffer&&(this._engine._releaseBuffer(this._indexBuffer),this._indexBuffer=null),this._vertexArrayObject&&(this._engine.releaseVertexArrayObject(this._vertexArrayObject),this._vertexArrayObject=null),t&&this.particleTexture&&(this.particleTexture.dispose(),this.particleTexture=null),t&&this.noiseTexture&&(this.noiseTexture.dispose(),this.noiseTexture=null),this._rampGradientsTexture&&(this._rampGradientsTexture.dispose(),this._rampGradientsTexture=null),this._removeFromRoot(),this.subEmitters&&!this._subEmitters&&this._prepareSubEmitterInternalArray(),this._subEmitters&&this._subEmitters.length){for(var r=0;r<this._subEmitters.length;r++)for(var n=0,a=this._subEmitters[r];n<a.length;n++){var s=a[n];s.dispose()}this._subEmitters=[],this.subEmitters=[]}if(this._disposeEmitterOnDispose&&this.emitter&&this.emitter.dispose&&this.emitter.dispose(!0),this._onBeforeDrawParticlesObservable&&this._onBeforeDrawParticlesObservable.clear(),this._scene){var r=this._scene.particleSystems.indexOf(this);r>-1&&this._scene.particleSystems.splice(r,1),this._scene._activeParticleSystems.dispose()}this.onDisposeObservable.notifyObservers(this),this.onDisposeObservable.clear(),this.onStoppedObservable.clear(),this.reset()},e.prototype.clone=function(t,r){var n=Ue({},this._customWrappers),a=null,s=this._engine;if(s.createEffectForParticles&&this.customShader!=null){a=this.customShader;var o=a.shaderOptions.defines.length>0?a.shaderOptions.defines.join(`
`):"",l=s.createEffectForParticles(a.shaderPath.fragmentElement,a.shaderOptions.uniforms,a.shaderOptions.samplers,o);n[0]?n[0].effect=l:this.setCustomEffect(l,0)}var u=this.serialize(),f=e.Parse(u,this._scene||this._engine,this._rootUrl);return f.name=t,f.customShader=a,f._customWrappers=n,r===void 0&&(r=this.emitter),this.noiseTexture&&(f.noiseTexture=this.noiseTexture.clone()),f.emitter=r,this.preventAutoStart||f.start(),f},e.prototype.serialize=function(t){t===void 0&&(t=!1);var r={};if(e._Serialize(r,this,t),r.textureMask=this.textureMask.asArray(),r.customShader=this.customShader,r.preventAutoStart=this.preventAutoStart,this.subEmitters){r.subEmitters=[],this._subEmitters||this._prepareSubEmitterInternalArray();for(var n=0,a=this._subEmitters;n<a.length;n++){for(var s=a[n],o=[],l=0,u=s;l<u.length;l++){var f=u[l];o.push(f.serialize(t))}r.subEmitters.push(o)}}return r},e._Serialize=function(t,r,n){if(t.name=r.name,t.id=r.id,t.capacity=r.getCapacity(),t.disposeOnStop=r.disposeOnStop,t.manualEmitCount=r.manualEmitCount,r.emitter.position){var a=r.emitter;t.emitterId=a.id}else{var s=r.emitter;t.emitter=s.asArray()}r.particleEmitterType&&(t.particleEmitterType=r.particleEmitterType.serialize()),r.particleTexture&&(n?t.texture=r.particleTexture.serialize():(t.textureName=r.particleTexture.name,t.invertY=!!r.particleTexture._invertY)),t.isLocal=r.isLocal,pe.AppendSerializedAnimations(r,t),t.beginAnimationOnStart=r.beginAnimationOnStart,t.beginAnimationFrom=r.beginAnimationFrom,t.beginAnimationTo=r.beginAnimationTo,t.beginAnimationLoop=r.beginAnimationLoop,t.startDelay=r.startDelay,t.renderingGroupId=r.renderingGroupId,t.isBillboardBased=r.isBillboardBased,t.billboardMode=r.billboardMode,t.minAngularSpeed=r.minAngularSpeed,t.maxAngularSpeed=r.maxAngularSpeed,t.minSize=r.minSize,t.maxSize=r.maxSize,t.minScaleX=r.minScaleX,t.maxScaleX=r.maxScaleX,t.minScaleY=r.minScaleY,t.maxScaleY=r.maxScaleY,t.minEmitPower=r.minEmitPower,t.maxEmitPower=r.maxEmitPower,t.minLifeTime=r.minLifeTime,t.maxLifeTime=r.maxLifeTime,t.emitRate=r.emitRate,t.gravity=r.gravity.asArray(),t.noiseStrength=r.noiseStrength.asArray(),t.color1=r.color1.asArray(),t.color2=r.color2.asArray(),t.colorDead=r.colorDead.asArray(),t.updateSpeed=r.updateSpeed,t.targetStopDuration=r.targetStopDuration,t.blendMode=r.blendMode,t.preWarmCycles=r.preWarmCycles,t.preWarmStepOffset=r.preWarmStepOffset,t.minInitialRotation=r.minInitialRotation,t.maxInitialRotation=r.maxInitialRotation,t.startSpriteCellID=r.startSpriteCellID,t.spriteCellLoop=r.spriteCellLoop,t.endSpriteCellID=r.endSpriteCellID,t.spriteCellChangeSpeed=r.spriteCellChangeSpeed,t.spriteCellWidth=r.spriteCellWidth,t.spriteCellHeight=r.spriteCellHeight,t.spriteRandomStartCell=r.spriteRandomStartCell,t.isAnimationSheetEnabled=r.isAnimationSheetEnabled;var o=r.getColorGradients();if(o){t.colorGradients=[];for(var l=0,u=o;l<u.length;l++){var f=u[l],h={gradient:f.gradient,color1:f.color1.asArray()};f.color2?h.color2=f.color2.asArray():h.color2=f.color1.asArray(),t.colorGradients.push(h)}}var c=r.getRampGradients();if(c){t.rampGradients=[];for(var d=0,p=c;d<p.length;d++){var _=p[d],h={gradient:_.gradient,color:_.color.asArray()};t.rampGradients.push(h)}t.useRampGradients=r.useRampGradients}var g=r.getColorRemapGradients();if(g){t.colorRemapGradients=[];for(var v=0,y=g;v<y.length;v++){var b=y[v],h={gradient:b.gradient,factor1:b.factor1};b.factor2!==void 0?h.factor2=b.factor2:h.factor2=b.factor1,t.colorRemapGradients.push(h)}}var E=r.getAlphaRemapGradients();if(E){t.alphaRemapGradients=[];for(var A=0,S=E;A<S.length;A++){var T=S[A],h={gradient:T.gradient,factor1:T.factor1};T.factor2!==void 0?h.factor2=T.factor2:h.factor2=T.factor1,t.alphaRemapGradients.push(h)}}var M=r.getSizeGradients();if(M){t.sizeGradients=[];for(var D=0,x=M;D<x.length;D++){var P=x[D],h={gradient:P.gradient,factor1:P.factor1};P.factor2!==void 0?h.factor2=P.factor2:h.factor2=P.factor1,t.sizeGradients.push(h)}}var w=r.getAngularSpeedGradients();if(w){t.angularSpeedGradients=[];for(var k=0,B=w;k<B.length;k++){var L=B[k],h={gradient:L.gradient,factor1:L.factor1};L.factor2!==void 0?h.factor2=L.factor2:h.factor2=L.factor1,t.angularSpeedGradients.push(h)}}var H=r.getVelocityGradients();if(H){t.velocityGradients=[];for(var W=0,F=H;W<F.length;W++){var V=F[W],h={gradient:V.gradient,factor1:V.factor1};V.factor2!==void 0?h.factor2=V.factor2:h.factor2=V.factor1,t.velocityGradients.push(h)}}var z=r.getDragGradients();if(z){t.dragGradients=[];for(var N=0,Q=z;N<Q.length;N++){var Z=Q[N],h={gradient:Z.gradient,factor1:Z.factor1};Z.factor2!==void 0?h.factor2=Z.factor2:h.factor2=Z.factor1,t.dragGradients.push(h)}}var ee=r.getEmitRateGradients();if(ee){t.emitRateGradients=[];for(var ne=0,Te=ee;ne<Te.length;ne++){var j=Te[ne],h={gradient:j.gradient,factor1:j.factor1};j.factor2!==void 0?h.factor2=j.factor2:h.factor2=j.factor1,t.emitRateGradients.push(h)}}var oe=r.getStartSizeGradients();if(oe){t.startSizeGradients=[];for(var be=0,Ee=oe;be<Ee.length;be++){var Pe=Ee[be],h={gradient:Pe.gradient,factor1:Pe.factor1};Pe.factor2!==void 0?h.factor2=Pe.factor2:h.factor2=Pe.factor1,t.startSizeGradients.push(h)}}var Fe=r.getLifeTimeGradients();if(Fe){t.lifeTimeGradients=[];for(var Ae=0,xe=Fe;Ae<xe.length;Ae++){var _e=xe[Ae],h={gradient:_e.gradient,factor1:_e.factor1};_e.factor2!==void 0?h.factor2=_e.factor2:h.factor2=_e.factor1,t.lifeTimeGradients.push(h)}}var we=r.getLimitVelocityGradients();if(we){t.limitVelocityGradients=[];for(var Ve=0,st=we;Ve<st.length;Ve++){var pt=st[Ve],h={gradient:pt.gradient,factor1:pt.factor1};pt.factor2!==void 0?h.factor2=pt.factor2:h.factor2=pt.factor1,t.limitVelocityGradients.push(h)}t.limitVelocityDamping=r.limitVelocityDamping}r.noiseTexture&&(t.noiseTexture=r.noiseTexture.serialize())},e._Parse=function(t,r,n,a){var s,o,l,u;n instanceof ge?u=null:u=n;var f=lt("BABYLON.Texture");if(f&&u&&(t.texture?r.particleTexture=f.Parse(t.texture,u,a):t.textureName&&(r.particleTexture=new f(a+t.textureName,u,!1,t.invertY!==void 0?t.invertY:!0),r.particleTexture.name=t.textureName)),!t.emitterId&&t.emitterId!==0&&t.emitter===void 0?r.emitter=m.Zero():t.emitterId&&u?r.emitter=u.getLastMeshById(t.emitterId):r.emitter=m.FromArray(t.emitter),r.isLocal=!!t.isLocal,t.renderingGroupId!==void 0&&(r.renderingGroupId=t.renderingGroupId),t.isBillboardBased!==void 0&&(r.isBillboardBased=t.isBillboardBased),t.billboardMode!==void 0&&(r.billboardMode=t.billboardMode),t.animations){for(var h=0;h<t.animations.length;h++){var c=t.animations[h],d=lt("BABYLON.Animation");d&&r.animations.push(d.Parse(c))}r.beginAnimationOnStart=t.beginAnimationOnStart,r.beginAnimationFrom=t.beginAnimationFrom,r.beginAnimationTo=t.beginAnimationTo,r.beginAnimationLoop=t.beginAnimationLoop}if(t.autoAnimate&&u&&u.beginAnimation(r,t.autoAnimateFrom,t.autoAnimateTo,t.autoAnimateLoop,t.autoAnimateSpeed||1),r.startDelay=t.startDelay|0,r.minAngularSpeed=t.minAngularSpeed,r.maxAngularSpeed=t.maxAngularSpeed,r.minSize=t.minSize,r.maxSize=t.maxSize,t.minScaleX&&(r.minScaleX=t.minScaleX,r.maxScaleX=t.maxScaleX,r.minScaleY=t.minScaleY,r.maxScaleY=t.maxScaleY),t.preWarmCycles!==void 0&&(r.preWarmCycles=t.preWarmCycles,r.preWarmStepOffset=t.preWarmStepOffset),t.minInitialRotation!==void 0&&(r.minInitialRotation=t.minInitialRotation,r.maxInitialRotation=t.maxInitialRotation),r.minLifeTime=t.minLifeTime,r.maxLifeTime=t.maxLifeTime,r.minEmitPower=t.minEmitPower,r.maxEmitPower=t.maxEmitPower,r.emitRate=t.emitRate,r.gravity=m.FromArray(t.gravity),t.noiseStrength&&(r.noiseStrength=m.FromArray(t.noiseStrength)),r.color1=ce.FromArray(t.color1),r.color2=ce.FromArray(t.color2),r.colorDead=ce.FromArray(t.colorDead),r.updateSpeed=t.updateSpeed,r.targetStopDuration=t.targetStopDuration,r.blendMode=t.blendMode,t.colorGradients)for(var p=0,_=t.colorGradients;p<_.length;p++){var g=_[p];r.addColorGradient(g.gradient,ce.FromArray(g.color1),g.color2?ce.FromArray(g.color2):void 0)}if(t.rampGradients){for(var v=0,y=t.rampGradients;v<y.length;v++){var b=y[v];r.addRampGradient(b.gradient,me.FromArray(b.color))}r.useRampGradients=t.useRampGradients}if(t.colorRemapGradients)for(var E=0,A=t.colorRemapGradients;E<A.length;E++){var S=A[E];r.addColorRemapGradient(S.gradient,S.factor1!==void 0?S.factor1:S.factor,S.factor2)}if(t.alphaRemapGradients)for(var T=0,M=t.alphaRemapGradients;T<M.length;T++){var D=M[T];r.addAlphaRemapGradient(D.gradient,D.factor1!==void 0?D.factor1:D.factor,D.factor2)}if(t.sizeGradients)for(var x=0,P=t.sizeGradients;x<P.length;x++){var w=P[x];r.addSizeGradient(w.gradient,w.factor1!==void 0?w.factor1:w.factor,w.factor2)}if(t.angularSpeedGradients)for(var k=0,B=t.angularSpeedGradients;k<B.length;k++){var L=B[k];r.addAngularSpeedGradient(L.gradient,L.factor1!==void 0?L.factor1:L.factor,L.factor2)}if(t.velocityGradients)for(var H=0,W=t.velocityGradients;H<W.length;H++){var F=W[H];r.addVelocityGradient(F.gradient,F.factor1!==void 0?F.factor1:F.factor,F.factor2)}if(t.dragGradients)for(var V=0,z=t.dragGradients;V<z.length;V++){var N=z[V];r.addDragGradient(N.gradient,N.factor1!==void 0?N.factor1:N.factor,N.factor2)}if(t.emitRateGradients)for(var Q=0,Z=t.emitRateGradients;Q<Z.length;Q++){var ee=Z[Q];r.addEmitRateGradient(ee.gradient,ee.factor1!==void 0?ee.factor1:ee.factor,ee.factor2)}if(t.startSizeGradients)for(var ne=0,Te=t.startSizeGradients;ne<Te.length;ne++){var j=Te[ne];r.addStartSizeGradient(j.gradient,j.factor1!==void 0?j.factor1:j.factor,j.factor2)}if(t.lifeTimeGradients)for(var oe=0,be=t.lifeTimeGradients;oe<be.length;oe++){var Ee=be[oe];r.addLifeTimeGradient(Ee.gradient,Ee.factor1!==void 0?Ee.factor1:Ee.factor,Ee.factor2)}if(t.limitVelocityGradients){for(var Pe=0,Fe=t.limitVelocityGradients;Pe<Fe.length;Pe++){var Ae=Fe[Pe];r.addLimitVelocityGradient(Ae.gradient,Ae.factor1!==void 0?Ae.factor1:Ae.factor,Ae.factor2)}r.limitVelocityDamping=t.limitVelocityDamping}if(t.noiseTexture&&u){var xe=lt("BABYLON.ProceduralTexture");r.noiseTexture=xe.Parse(t.noiseTexture,u,a)}var _e;if(t.particleEmitterType){switch(t.particleEmitterType.type){case"SphereParticleEmitter":_e=new bn;break;case"SphereDirectedParticleEmitter":_e=new no;break;case"ConeEmitter":case"ConeParticleEmitter":_e=new eo;break;case"CylinderParticleEmitter":_e=new yn;break;case"CylinderDirectedParticleEmitter":_e=new to;break;case"HemisphericParticleEmitter":_e=new ro;break;case"PointParticleEmitter":_e=new io;break;case"MeshParticleEmitter":_e=new td;break;case"BoxEmitter":case"BoxParticleEmitter":default:_e=new Kr;break}_e.parse(t.particleEmitterType,u)}else _e=new Kr,_e.parse(t,u);r.particleEmitterType=_e,r.startSpriteCellID=t.startSpriteCellID,r.endSpriteCellID=t.endSpriteCellID,r.spriteCellLoop=(s=t.spriteCellLoop)!==null&&s!==void 0?s:!0,r.spriteCellWidth=t.spriteCellWidth,r.spriteCellHeight=t.spriteCellHeight,r.spriteCellChangeSpeed=t.spriteCellChangeSpeed,r.spriteRandomStartCell=t.spriteRandomStartCell,r.disposeOnStop=(o=t.disposeOnStop)!==null&&o!==void 0?o:!1,r.manualEmitCount=(l=t.manualEmitCount)!==null&&l!==void 0?l:-1},e.Parse=function(t,r,n,a,s){a===void 0&&(a=!1);var o=t.name,l=null,u=null,f,h;if(r instanceof ge?f=r:(h=r,f=h.getEngine()),t.customShader&&f.createEffectForParticles){u=t.customShader;var c=u.shaderOptions.defines.length>0?u.shaderOptions.defines.join(`
`):"";l=f.createEffectForParticles(u.shaderPath.fragmentElement,u.shaderOptions.uniforms,u.shaderOptions.samplers,c)}var d=new e(o,s||t.capacity,r,l,t.isAnimationSheetEnabled);if(d.customShader=u,d._rootUrl=n,t.id&&(d.id=t.id),t.subEmitters){d.subEmitters=[];for(var p=0,_=t.subEmitters;p<_.length;p++){for(var g=_[p],v=[],y=0,b=g;y<b.length;y++){var E=b[y];v.push(Yr.Parse(E,r,n))}d.subEmitters.push(v)}}return e._Parse(t,d,r,n),t.textureMask&&(d.textureMask=ce.FromArray(t.textureMask)),t.preventAutoStart&&(d.preventAutoStart=t.preventAutoStart),!a&&!d.preventAutoStart&&d.start(),d},e.BILLBOARDMODE_Y=2,e.BILLBOARDMODE_ALL=7,e.BILLBOARDMODE_STRETCHED=8,e}(rd);Yr._ParseParticleSystem=ld.Parse;var ud=function(){function i(e,t,r){t===void 0&&(t=0),r===void 0&&(r=null),this.name=e,this.animations=new Array,this._positions=null,this._normals=null,this._tangents=null,this._uvs=null,this._uniqueId=0,this.onInfluenceChanged=new X,this._onDataLayoutChanged=new X,this._animationPropertiesOverride=null,this._scene=r||ye.LastCreatedScene,this.influence=t,this._scene&&(this._uniqueId=this._scene.getUniqueId())}return Object.defineProperty(i.prototype,"influence",{get:function(){return this._influence},set:function(e){if(this._influence!==e){var t=this._influence;this._influence=e,this.onInfluenceChanged.hasObservers()&&this.onInfluenceChanged.notifyObservers(t===0||e===0)}},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"animationPropertiesOverride",{get:function(){return!this._animationPropertiesOverride&&this._scene?this._scene.animationPropertiesOverride:this._animationPropertiesOverride},set:function(e){this._animationPropertiesOverride=e},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"uniqueId",{get:function(){return this._uniqueId},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"hasPositions",{get:function(){return!!this._positions},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"hasNormals",{get:function(){return!!this._normals},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"hasTangents",{get:function(){return!!this._tangents},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"hasUVs",{get:function(){return!!this._uvs},enumerable:!1,configurable:!0}),i.prototype.setPositions=function(e){var t=this.hasPositions;this._positions=e,t!==this.hasPositions&&this._onDataLayoutChanged.notifyObservers(void 0)},i.prototype.getPositions=function(){return this._positions},i.prototype.setNormals=function(e){var t=this.hasNormals;this._normals=e,t!==this.hasNormals&&this._onDataLayoutChanged.notifyObservers(void 0)},i.prototype.getNormals=function(){return this._normals},i.prototype.setTangents=function(e){var t=this.hasTangents;this._tangents=e,t!==this.hasTangents&&this._onDataLayoutChanged.notifyObservers(void 0)},i.prototype.getTangents=function(){return this._tangents},i.prototype.setUVs=function(e){var t=this.hasUVs;this._uvs=e,t!==this.hasUVs&&this._onDataLayoutChanged.notifyObservers(void 0)},i.prototype.getUVs=function(){return this._uvs},i.prototype.clone=function(){var e=this,t=pe.Clone(function(){return new i(e.name,e.influence,e._scene)},this);return t._positions=this._positions,t._normals=this._normals,t._tangents=this._tangents,t._uvs=this._uvs,t},i.prototype.serialize=function(){var e={};return e.name=this.name,e.influence=this.influence,e.positions=Array.prototype.slice.call(this.getPositions()),this.id!=null&&(e.id=this.id),this.hasNormals&&(e.normals=Array.prototype.slice.call(this.getNormals())),this.hasTangents&&(e.tangents=Array.prototype.slice.call(this.getTangents())),this.hasUVs&&(e.uvs=Array.prototype.slice.call(this.getUVs())),pe.AppendSerializedAnimations(this,e),e},i.prototype.getClassName=function(){return"MorphTarget"},i.Parse=function(e,t){var r=new i(e.name,e.influence);if(r.setPositions(e.positions),e.id!=null&&(r.id=e.id),e.normals&&r.setNormals(e.normals),e.tangents&&r.setTangents(e.tangents),e.uvs&&r.setUVs(e.uvs),e.animations){for(var n=0;n<e.animations.length;n++){var a=e.animations[n],s=lt("BABYLON.Animation");s&&r.animations.push(s.Parse(a))}e.autoAnimate&&t&&t.beginAnimation(r,e.autoAnimateFrom,e.autoAnimateTo,e.autoAnimateLoop,e.autoAnimateSpeed||1)}return r},i.FromMesh=function(e,t,r){t||(t=e.name);var n=new i(t,r,e.getScene());return n.setPositions(e.getVerticesData(R.PositionKind)),e.isVerticesDataPresent(R.NormalKind)&&n.setNormals(e.getVerticesData(R.NormalKind)),e.isVerticesDataPresent(R.TangentKind)&&n.setTangents(e.getVerticesData(R.TangentKind)),e.isVerticesDataPresent(R.UVKind)&&n.setUVs(e.getVerticesData(R.UVKind)),n},C([I()],i.prototype,"id",void 0),i}(),fd=function(i){$(e,i);function e(t,r,n,a,s,o,l,u,f,h){l===void 0&&(l=!0),u===void 0&&(u=!1),f===void 0&&(f=re.TRILINEAR_SAMPLINGMODE),h===void 0&&(h=0);var c=i.call(this,null,o,!l,u)||this;return c.format=s,c._texture=o.getEngine().createRawTexture2DArray(t,r,n,a,s,l,u,f,null,h),c._depth=a,c.is2DArray=!0,c}return Object.defineProperty(e.prototype,"depth",{get:function(){return this._depth},enumerable:!1,configurable:!0}),e.prototype.update=function(t){!this._texture||this._getEngine().updateRawTexture2DArray(this._texture,t,this._texture.format,this._texture.invertY,null,this._texture.type)},e.CreateRGBATexture=function(t,r,n,a,s,o,l,u,f){return o===void 0&&(o=!0),l===void 0&&(l=!1),u===void 0&&(u=3),f===void 0&&(f=0),new e(t,r,n,a,5,s,o,l,u,f)},e}(re),Fp=function(){function i(e){if(e===void 0&&(e=null),this._targets=new Array,this._targetInfluenceChangedObservers=new Array,this._targetDataLayoutChangedObservers=new Array,this._activeTargets=new Je(16),this._supportsNormals=!1,this._supportsTangents=!1,this._supportsUVs=!1,this._vertexCount=0,this._textureVertexStride=0,this._textureWidth=0,this._textureHeight=1,this._uniqueId=0,this._tempInfluences=new Array,this._canUseTextureForTargets=!1,this._blockCounter=0,this._parentContainer=null,this.optimizeInfluencers=!0,this.enableNormalMorphing=!0,this.enableTangentMorphing=!0,this.enableUVMorphing=!0,this._useTextureToStoreTargets=!0,e||(e=ye.LastCreatedScene),this._scene=e,this._scene){this._scene.morphTargetManagers.push(this),this._uniqueId=this._scene.getUniqueId();var t=this._scene.getEngine().getCaps();this._canUseTextureForTargets=t.canUseGLVertexID&&t.textureFloat&&t.maxVertexTextureImageUnits>0}}return Object.defineProperty(i.prototype,"areUpdatesFrozen",{get:function(){return this._blockCounter>0},set:function(e){e?this._blockCounter++:(this._blockCounter--,this._blockCounter<=0&&(this._blockCounter=0,this._syncActiveTargets(!0)))},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"uniqueId",{get:function(){return this._uniqueId},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"vertexCount",{get:function(){return this._vertexCount},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"supportsNormals",{get:function(){return this._supportsNormals&&this.enableNormalMorphing},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"supportsTangents",{get:function(){return this._supportsTangents&&this.enableTangentMorphing},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"supportsUVs",{get:function(){return this._supportsUVs&&this.enableUVMorphing},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"numTargets",{get:function(){return this._targets.length},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"numInfluencers",{get:function(){return this._activeTargets.length},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"influences",{get:function(){return this._influences},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"useTextureToStoreTargets",{get:function(){return this._useTextureToStoreTargets},set:function(e){this._useTextureToStoreTargets=e},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"isUsingTextureForTargets",{get:function(){return i.EnableTextureStorage&&this.useTextureToStoreTargets&&this._canUseTextureForTargets},enumerable:!1,configurable:!0}),i.prototype.getActiveTarget=function(e){return this._activeTargets.data[e]},i.prototype.getTarget=function(e){return this._targets[e]},i.prototype.addTarget=function(e){var t=this;this._targets.push(e),this._targetInfluenceChangedObservers.push(e.onInfluenceChanged.add(function(r){t._syncActiveTargets(r)})),this._targetDataLayoutChangedObservers.push(e._onDataLayoutChanged.add(function(){t._syncActiveTargets(!0)})),this._syncActiveTargets(!0)},i.prototype.removeTarget=function(e){var t=this._targets.indexOf(e);t>=0&&(this._targets.splice(t,1),e.onInfluenceChanged.remove(this._targetInfluenceChangedObservers.splice(t,1)[0]),e._onDataLayoutChanged.remove(this._targetDataLayoutChangedObservers.splice(t,1)[0]),this._syncActiveTargets(!0))},i.prototype._bind=function(e){e.setFloat3("morphTargetTextureInfo",this._textureVertexStride,this._textureWidth,this._textureHeight),e.setFloatArray("morphTargetTextureIndices",this._morphTargetTextureIndices),e.setTexture("morphTargets",this._targetStoreTexture)},i.prototype.clone=function(){for(var e=new i(this._scene),t=0,r=this._targets;t<r.length;t++){var n=r[t];e.addTarget(n.clone())}return e.enableNormalMorphing=this.enableNormalMorphing,e.enableTangentMorphing=this.enableTangentMorphing,e.enableUVMorphing=this.enableUVMorphing,e},i.prototype.serialize=function(){var e={};e.id=this.uniqueId,e.targets=[];for(var t=0,r=this._targets;t<r.length;t++){var n=r[t];e.targets.push(n.serialize())}return e},i.prototype._syncActiveTargets=function(e){if(!this.areUpdatesFrozen){var t=0;this._activeTargets.reset(),this._supportsNormals=!0,this._supportsTangents=!0,this._supportsUVs=!0,this._vertexCount=0,(!this._morphTargetTextureIndices||this._morphTargetTextureIndices.length!==this._targets.length)&&(this._morphTargetTextureIndices=new Float32Array(this._targets.length));for(var r=-1,n=0,a=this._targets;n<a.length;n++){var s=a[n];if(r++,!(s.influence===0&&this.optimizeInfluencers)){this._activeTargets.push(s),this._morphTargetTextureIndices[t]=r,this._tempInfluences[t++]=s.influence,this._supportsNormals=this._supportsNormals&&s.hasNormals,this._supportsTangents=this._supportsTangents&&s.hasTangents,this._supportsUVs=this._supportsUVs&&s.hasUVs;var o=s.getPositions();if(o){var l=o.length/3;if(this._vertexCount===0)this._vertexCount=l;else if(this._vertexCount!==l){Y.Error("Incompatible target. Targets must all have the same vertices count.");return}}}}(!this._influences||this._influences.length!==t)&&(this._influences=new Float32Array(t));for(var u=0;u<t;u++)this._influences[u]=this._tempInfluences[u];e&&this.synchronize()}},i.prototype.synchronize=function(){if(!(!this._scene||this.areUpdatesFrozen)){if(this.isUsingTextureForTargets&&this._vertexCount){this._textureVertexStride=1,this._supportsNormals&&this._textureVertexStride++,this._supportsTangents&&this._textureVertexStride++,this._supportsUVs&&this._textureVertexStride++,this._textureWidth=this._vertexCount*this._textureVertexStride,this._textureHeight=1;var e=this._scene.getEngine().getCaps().maxTextureSize;this._textureWidth>e&&(this._textureHeight=Math.ceil(this._textureWidth/e),this._textureWidth=e);var t=!0;if(this._targetStoreTexture){var r=this._targetStoreTexture.getSize();r.width===this._textureWidth&&r.height===this._textureHeight&&this._targetStoreTexture.depth===this._targets.length&&(t=!1)}if(t){this._targetStoreTexture&&this._targetStoreTexture.dispose();for(var n=this._targets.length,a=new Float32Array(n*this._textureWidth*this._textureHeight*4),s=0,o=0;o<n;o++){var l=this._targets[o],u=l.getPositions(),f=l.getNormals(),h=l.getUVs(),c=l.getTangents();if(!u){o===0&&Y.Error("Invalid morph target. Target must have positions.");return}s=o*this._textureWidth*this._textureHeight*4;for(var d=0;d<this._vertexCount;d++)a[s]=u[d*3],a[s+1]=u[d*3+1],a[s+2]=u[d*3+2],s+=4,f&&(a[s]=f[d*3],a[s+1]=f[d*3+1],a[s+2]=f[d*3+2],s+=4),h&&(a[s]=h[d*2],a[s+1]=h[d*2+1],s+=4),c&&(a[s]=c[d*3],a[s+1]=c[d*3+1],a[s+2]=c[d*3+2],s+=4)}this._targetStoreTexture=fd.CreateRGBATexture(a,this._textureWidth,this._textureHeight,n,this._scene,!1,!1,1,1)}}for(var p=0,_=this._scene.meshes;p<_.length;p++){var g=_[p];g.morphTargetManager===this&&g._syncGeometryWithMorphTargetManager()}}},i.prototype.dispose=function(){if(this._targetStoreTexture&&this._targetStoreTexture.dispose(),this._targetStoreTexture=null,this._scene&&(this._scene.removeMorphTargetManager(this),this._parentContainer)){var e=this._parentContainer.morphTargetManagers.indexOf(this);e>-1&&this._parentContainer.morphTargetManagers.splice(e,1),this._parentContainer=null}},i.Parse=function(e,t){var r=new i(t);r._uniqueId=e.id;for(var n=0,a=e.targets;n<a.length;n++){var s=a[n];r.addTarget(ud.Parse(s,t))}return r},i.EnableTextureStorage=!0,i}(),hd="kernelBlurVaryingDeclaration",cd="varying vec2 sampleCoord{X};";q.IncludesShadersStore[hd]=cd;var dd="kernelBlurFragment",pd=`#ifdef DOF
factor=sampleCoC(sampleCoord{X}); 
computedWeight=KERNEL_WEIGHT{X}*factor;
sumOfWeights+=computedWeight;
#else
computedWeight=KERNEL_WEIGHT{X};
#endif
#ifdef PACKEDFLOAT
blend+=unpack(texture2D(textureSampler,sampleCoord{X}))*computedWeight;
#else
blend+=texture2D(textureSampler,sampleCoord{X})*computedWeight;
#endif
`;q.IncludesShadersStore[dd]=pd;var _d="kernelBlurFragment2",vd=`#ifdef DOF
factor=sampleCoC(sampleCenter+delta*KERNEL_DEP_OFFSET{X});
computedWeight=KERNEL_DEP_WEIGHT{X}*factor;
sumOfWeights+=computedWeight;
#else
computedWeight=KERNEL_DEP_WEIGHT{X};
#endif
#ifdef PACKEDFLOAT
blend+=unpack(texture2D(textureSampler,sampleCenter+delta*KERNEL_DEP_OFFSET{X}))*computedWeight;
#else
blend+=texture2D(textureSampler,sampleCenter+delta*KERNEL_DEP_OFFSET{X})*computedWeight;
#endif
`;q.IncludesShadersStore[_d]=vd;var gd="kernelBlurPixelShader",md=`uniform sampler2D textureSampler;
uniform vec2 delta;
varying vec2 sampleCenter;
#ifdef DOF
uniform sampler2D circleOfConfusionSampler;
uniform vec2 cameraMinMaxZ;
float sampleDistance(in vec2 offset) {
float depth=texture2D(circleOfConfusionSampler,offset).g; 
return cameraMinMaxZ.x+(cameraMinMaxZ.y-cameraMinMaxZ.x)*depth; 
}
float sampleCoC(in vec2 offset) {
float coc=texture2D(circleOfConfusionSampler,offset).r; 
return coc; 
}
#endif
#include<kernelBlurVaryingDeclaration>[0..varyingCount]
#ifdef PACKEDFLOAT
#include<packingFunctions>
#endif
#define CUSTOM_FRAGMENT_DEFINITIONS
void main(void)
{
float computedWeight=0.0;
#ifdef PACKEDFLOAT 
float blend=0.;
#else
vec4 blend=vec4(0.);
#endif
#ifdef DOF
float sumOfWeights=CENTER_WEIGHT; 
float factor=0.0;
#ifdef PACKEDFLOAT
blend+=unpack(texture2D(textureSampler,sampleCenter))*CENTER_WEIGHT;
#else
blend+=texture2D(textureSampler,sampleCenter)*CENTER_WEIGHT;
#endif
#endif
#include<kernelBlurFragment>[0..varyingCount]
#include<kernelBlurFragment2>[0..depCount]
#ifdef PACKEDFLOAT
gl_FragColor=pack(blend);
#else
gl_FragColor=blend;
#endif
#ifdef DOF
gl_FragColor/=sumOfWeights;
#endif
}`;q.ShadersStore[gd]=md;var yd="kernelBlurVertex",bd="sampleCoord{X}=sampleCenter+delta*KERNEL_OFFSET{X};";q.IncludesShadersStore[yd]=bd;var Td="kernelBlurVertexShader",Ed=`attribute vec2 position;
uniform vec2 delta;
varying vec2 sampleCenter;
#include<kernelBlurVaryingDeclaration>[0..varyingCount]
const vec2 madd=vec2(0.5,0.5);
#define CUSTOM_VERTEX_DEFINITIONS
void main(void) {
#define CUSTOM_VERTEX_MAIN_BEGIN
sampleCenter=(position*madd+madd);
#include<kernelBlurVertex>[0..varyingCount]
gl_Position=vec4(position,0.0,1.0);
#define CUSTOM_VERTEX_MAIN_END
}`;q.ShadersStore[Td]=Ed;var Br=function(i){$(e,i);function e(t,r,n,a,s,o,l,u,f,h,c){o===void 0&&(o=re.BILINEAR_SAMPLINGMODE),f===void 0&&(f=0),h===void 0&&(h=""),c===void 0&&(c=!1);var d=i.call(this,t,"kernelBlur",["delta","direction","cameraMinMaxZ"],["circleOfConfusionSampler"],a,s,o,l,u,null,f,"kernelBlur",{varyingCount:0,depCount:0},!0)||this;return d._blockCompilation=c,d._packedFloat=!1,d._staticDefines="",d._staticDefines=h,d.direction=r,d.onApplyObservable.add(function(p){d._outputTexture?p.setFloat2("delta",1/d._outputTexture.width*d.direction.x,1/d._outputTexture.height*d.direction.y):p.setFloat2("delta",1/d.width*d.direction.x,1/d.height*d.direction.y)}),d.kernel=n,d}return Object.defineProperty(e.prototype,"kernel",{get:function(){return this._idealKernel},set:function(t){this._idealKernel!==t&&(t=Math.max(t,1),this._idealKernel=t,this._kernel=this._nearestBestKernel(t),this._blockCompilation||this._updateParameters())},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"packedFloat",{get:function(){return this._packedFloat},set:function(t){this._packedFloat!==t&&(this._packedFloat=t,this._blockCompilation||this._updateParameters())},enumerable:!1,configurable:!0}),e.prototype.getClassName=function(){return"BlurPostProcess"},e.prototype.updateEffect=function(t,r,n,a,s,o){this._updateParameters(s,o)},e.prototype._updateParameters=function(t,r){for(var n=this._kernel,a=(n-1)/2,s=[],o=[],l=0,u=0;u<n;u++){var f=u/(n-1),h=this._gaussianWeight(f*2-1);s[u]=u-a,o[u]=h,l+=h}for(var u=0;u<o.length;u++)o[u]/=l;for(var c=[],d=[],p=[],u=0;u<=a;u+=2){var _=Math.min(u+1,Math.floor(a)),g=u===_;if(g)p.push({o:s[u],w:o[u]});else{var v=_===a,y=o[u]+o[_]*(v?.5:1),b=s[u]+1/(1+o[u]/o[_]);b===0?(p.push({o:s[u],w:o[u]}),p.push({o:s[u+1],w:o[u+1]})):(p.push({o:b,w:y}),p.push({o:-b,w:y}))}}for(var u=0;u<p.length;u++)d[u]=p[u].o,c[u]=p[u].w;s=d,o=c;var E=this.getEngine().getCaps().maxVaryingVectors,A=Math.max(E,0)-1,S=Math.min(s.length,A),T="";T+=this._staticDefines,this._staticDefines.indexOf("DOF")!=-1&&(T+="#define CENTER_WEIGHT ".concat(this._glslFloat(o[S-1]),`\r
`),S--);for(var u=0;u<S;u++)T+="#define KERNEL_OFFSET".concat(u," ").concat(this._glslFloat(s[u]),`\r
`),T+="#define KERNEL_WEIGHT".concat(u," ").concat(this._glslFloat(o[u]),`\r
`);for(var M=0,u=A;u<s.length;u++)T+="#define KERNEL_DEP_OFFSET".concat(M," ").concat(this._glslFloat(s[u]),`\r
`),T+="#define KERNEL_DEP_WEIGHT".concat(M," ").concat(this._glslFloat(o[u]),`\r
`),M++;this.packedFloat&&(T+="#define PACKEDFLOAT 1"),this._blockCompilation=!1,i.prototype.updateEffect.call(this,T,null,null,{varyingCount:S,depCount:M},t,r)},e.prototype._nearestBestKernel=function(t){for(var r=Math.round(t),n=0,a=[r,r-1,r+1,r-2,r+2];n<a.length;n++){var s=a[n];if(s%2!==0&&Math.floor(s/2)%2===0&&s>0)return Math.max(s,3)}return Math.max(r,3)},e.prototype._gaussianWeight=function(t){var r=.3333333333333333,n=Math.sqrt(2*Math.PI)*r,a=-(t*t/(2*r*r)),s=1/n*Math.exp(a);return s},e.prototype._glslFloat=function(t,r){return r===void 0&&(r=8),t.toFixed(r).replace(/0+$/,"")},e._Parse=function(t,r,n,a){return pe.Parse(function(){return new e(t.name,t.direction,t.kernel,t.options,r,t.renderTargetSamplingMode,n.getEngine(),t.reusable,t.textureType,void 0,!1)},t,n,a)},C([I("kernel")],e.prototype,"_kernel",void 0),C([I("packedFloat")],e.prototype,"_packedFloat",void 0),C([Pa()],e.prototype,"direction",void 0),e}(St);We("BABYLON.BlurPostProcess",Br);var Ad="bayerDitherFunctions",Sd=`float bayerDither2(vec2 _P) {
return mod(2.0*_P.y+_P.x+1.0,4.0);
}
float bayerDither4(vec2 _P) {
vec2 P1=mod(_P,2.0); 
vec2 P2=floor(0.5*mod(_P,4.0)); 
return 4.0*bayerDither2(P1)+bayerDither2(P2);
}
float bayerDither8(vec2 _P) {
vec2 P1=mod(_P,2.0); 
vec2 P2=floor(0.5 *mod(_P,4.0)); 
vec2 P4=floor(0.25*mod(_P,8.0)); 
return 4.0*(4.0*bayerDither2(P1)+bayerDither2(P2))+bayerDither2(P4);
}
`;q.IncludesShadersStore[Ad]=Sd;var Rd="shadowMapFragmentExtraDeclaration",Pd=`#if SM_FLOAT==0
#include<packingFunctions>
#endif
#if SM_SOFTTRANSPARENTSHADOW==1
#include<bayerDitherFunctions>
uniform float softTransparentShadowSM;
#endif
varying float vDepthMetricSM;
#if SM_USEDISTANCE==1
uniform vec3 lightDataSM;
varying vec3 vPositionWSM;
#endif
uniform vec3 biasAndScaleSM;
uniform vec2 depthValuesSM;
#if defined(SM_DEPTHCLAMP) && SM_DEPTHCLAMP==1
varying float zSM;
#endif
`;q.IncludesShadersStore[Rd]=Pd;var Md="shadowMapFragment",Cd=`float depthSM=vDepthMetricSM;
#if defined(SM_DEPTHCLAMP) && SM_DEPTHCLAMP==1
#if SM_USEDISTANCE==1
depthSM=(length(vPositionWSM-lightDataSM)+depthValuesSM.x)/depthValuesSM.y+biasAndScaleSM.x;
#else
#ifdef USE_REVERSE_DEPTHBUFFER
depthSM=(-zSM+depthValuesSM.x)/depthValuesSM.y+biasAndScaleSM.x;
#else
depthSM=(zSM+depthValuesSM.x)/depthValuesSM.y+biasAndScaleSM.x;
#endif
#endif
#ifdef USE_REVERSE_DEPTHBUFFER
gl_FragDepth=clamp(1.0-depthSM,0.0,1.0);
#else
gl_FragDepth=clamp(depthSM,0.0,1.0); 
#endif
#elif SM_USEDISTANCE==1
depthSM=(length(vPositionWSM-lightDataSM)+depthValuesSM.x)/depthValuesSM.y+biasAndScaleSM.x;
#endif
#if SM_ESM==1
depthSM=clamp(exp(-min(87.,biasAndScaleSM.z*depthSM)),0.,1.);
#endif
#if SM_FLOAT==1
gl_FragColor=vec4(depthSM,1.0,1.0,1.0);
#else
gl_FragColor=pack(depthSM);
#endif
return;`;q.IncludesShadersStore[Md]=Cd;var xd="shadowMapPixelShader",Dd=`#include<shadowMapFragmentExtraDeclaration>
#ifdef ALPHATEST
varying vec2 vUV;
uniform sampler2D diffuseSampler;
#endif
#include<clipPlaneFragmentDeclaration>
#define CUSTOM_FRAGMENT_DEFINITIONS
void main(void)
{
#include<clipPlaneFragment>
#ifdef ALPHATEST
float alphaFromAlphaTexture=texture2D(diffuseSampler,vUV).a;
if (alphaFromAlphaTexture<ALPHATESTVALUE)
discard;
#endif
#if SM_SOFTTRANSPARENTSHADOW==1
#ifdef ALPHATEST
if ((bayerDither8(floor(mod(gl_FragCoord.xy,8.0))))/64.0>=softTransparentShadowSM*alphaFromAlphaTexture) discard;
#else
if ((bayerDither8(floor(mod(gl_FragCoord.xy,8.0))))/64.0>=softTransparentShadowSM) discard;
#endif
#endif
#include<shadowMapFragment>
}`;q.ShadersStore[xd]=Dd;var Od="sceneVertexDeclaration",Id=`uniform mat4 viewProjection;
#ifdef MULTIVIEW
uniform mat4 viewProjectionR;
#endif
uniform mat4 view;
uniform mat4 projection;
uniform vec4 vEyePosition;
`;q.IncludesShadersStore[Od]=Id;var Fd="meshVertexDeclaration",wd=`uniform mat4 world;
uniform float visibility;
`;q.IncludesShadersStore[Fd]=wd;var Ld="shadowMapVertexDeclaration",Nd=`#include<sceneVertexDeclaration>
#include<meshVertexDeclaration>
`;q.IncludesShadersStore[Ld]=Nd;var Bd="shadowMapUboDeclaration",Ud=`layout(std140,column_major) uniform;
#include<sceneUboDeclaration>
#include<meshUboDeclaration>
`;q.IncludesShadersStore[Bd]=Ud;var Vd="shadowMapVertexExtraDeclaration",kd=`#if SM_NORMALBIAS==1
uniform vec3 lightDataSM;
#endif
uniform vec3 biasAndScaleSM;
uniform vec2 depthValuesSM;
varying float vDepthMetricSM;
#if SM_USEDISTANCE==1
varying vec3 vPositionWSM;
#endif
#if defined(SM_DEPTHCLAMP) && SM_DEPTHCLAMP==1
varying float zSM;
#endif
`;q.IncludesShadersStore[Vd]=kd;var Gd="shadowMapVertexNormalBias",zd=`#if SM_NORMALBIAS==1
#if SM_DIRECTIONINLIGHTDATA==1
vec3 worldLightDirSM=normalize(-lightDataSM.xyz);
#else
vec3 directionToLightSM=lightDataSM.xyz-worldPos.xyz;
vec3 worldLightDirSM=normalize(directionToLightSM);
#endif
float ndlSM=dot(vNormalW,worldLightDirSM);
float sinNLSM=sqrt(1.0-ndlSM*ndlSM);
float normalBiasSM=biasAndScaleSM.y*sinNLSM;
worldPos.xyz-=vNormalW*normalBiasSM;
#endif
`;q.IncludesShadersStore[Gd]=zd;var Wd="shadowMapVertexMetric",Hd=`#if SM_USEDISTANCE==1
vPositionWSM=worldPos.xyz;
#endif
#if SM_DEPTHTEXTURE==1
#ifdef IS_NDC_HALF_ZRANGE
#define BIASFACTOR 0.5
#else
#define BIASFACTOR 1.0
#endif
#ifdef USE_REVERSE_DEPTHBUFFER
gl_Position.z-=biasAndScaleSM.x*gl_Position.w*BIASFACTOR;
#else
gl_Position.z+=biasAndScaleSM.x*gl_Position.w*BIASFACTOR;
#endif
#endif
#if defined(SM_DEPTHCLAMP) && SM_DEPTHCLAMP==1
zSM=gl_Position.z;
gl_Position.z=0.0;
#elif SM_USEDISTANCE==0
#ifdef USE_REVERSE_DEPTHBUFFER
vDepthMetricSM=(-gl_Position.z+depthValuesSM.x)/depthValuesSM.y+biasAndScaleSM.x;
#else
vDepthMetricSM=(gl_Position.z+depthValuesSM.x)/depthValuesSM.y+biasAndScaleSM.x;
#endif
#endif
`;q.IncludesShadersStore[Wd]=Hd;var Xd="shadowMapVertexShader",jd=`attribute vec3 position;
#ifdef NORMAL
attribute vec3 normal;
#endif
#include<bonesDeclaration>
#include<bakedVertexAnimationDeclaration>
#include<morphTargetsVertexGlobalDeclaration>
#include<morphTargetsVertexDeclaration>[0..maxSimultaneousMorphTargets]
#ifdef INSTANCES
attribute vec4 world0;
attribute vec4 world1;
attribute vec4 world2;
attribute vec4 world3;
#endif
#include<helperFunctions>
#include<__decl__shadowMapVertex>
#ifdef ALPHATEST
varying vec2 vUV;
uniform mat4 diffuseMatrix;
#ifdef UV1
attribute vec2 uv;
#endif
#ifdef UV2
attribute vec2 uv2;
#endif
#endif
#include<shadowMapVertexExtraDeclaration>
#include<clipPlaneVertexDeclaration>
#define CUSTOM_VERTEX_DEFINITIONS
void main(void)
{
vec3 positionUpdated=position;
#ifdef UV1
vec2 uvUpdated=uv;
#endif
#ifdef NORMAL
vec3 normalUpdated=normal;
#endif
#include<morphTargetsVertexGlobal>
#include<morphTargetsVertex>[0..maxSimultaneousMorphTargets]
#include<instancesVertex>
#include<bonesVertex>
#include<bakedVertexAnimation>
vec4 worldPos=finalWorld*vec4(positionUpdated,1.0);
#ifdef NORMAL
mat3 normWorldSM=mat3(finalWorld);
#if defined(INSTANCES) && defined(THIN_INSTANCES)
vec3 vNormalW=normalUpdated/vec3(dot(normWorldSM[0],normWorldSM[0]),dot(normWorldSM[1],normWorldSM[1]),dot(normWorldSM[2],normWorldSM[2]));
vNormalW=normalize(normWorldSM*vNormalW);
#else
#ifdef NONUNIFORMSCALING
normWorldSM=transposeMat3(inverseMat3(normWorldSM));
#endif
vec3 vNormalW=normalize(normWorldSM*normalUpdated);
#endif
#endif
#include<shadowMapVertexNormalBias>
gl_Position=viewProjection*worldPos;
#include<shadowMapVertexMetric>
#ifdef ALPHATEST
#ifdef UV1
vUV=vec2(diffuseMatrix*vec4(uvUpdated,1.0,0.0));
#endif
#ifdef UV2
vUV=vec2(diffuseMatrix*vec4(uv2,1.0,0.0));
#endif
#endif
#include<clipPlaneVertex>
}`;q.ShadersStore[Xd]=jd;var Kd="depthBoxBlurPixelShader",Yd=`varying vec2 vUV;
uniform sampler2D textureSampler;
uniform vec2 screenSize;
#define CUSTOM_FRAGMENT_DEFINITIONS
void main(void)
{
vec4 colorDepth=vec4(0.0);
for (int x=-OFFSET; x<=OFFSET; x++)
for (int y=-OFFSET; y<=OFFSET; y++)
colorDepth+=texture2D(textureSampler,vUV+vec2(x,y)/screenSize);
gl_FragColor=(colorDepth/float((OFFSET*2+1)*(OFFSET*2+1)));
}`;q.ShadersStore[Kd]=Yd;var qd="shadowMapFragmentSoftTransparentShadow",Zd=`#if SM_SOFTTRANSPARENTSHADOW==1
if ((bayerDither8(floor(mod(gl_FragCoord.xy,8.0))))/64.0>=softTransparentShadowSM*alpha) discard;
#endif
`;q.IncludesShadersStore[qd]=Zd;(function(){function i(e,t,r){this.onBeforeShadowMapRenderObservable=new X,this.onAfterShadowMapRenderObservable=new X,this.onBeforeShadowMapRenderMeshObservable=new X,this.onAfterShadowMapRenderMeshObservable=new X,this._bias=5e-5,this._normalBias=0,this._blurBoxOffset=1,this._blurScale=2,this._blurKernel=1,this._useKernelBlur=!1,this._filter=i.FILTER_NONE,this._filteringQuality=i.QUALITY_HIGH,this._contactHardeningLightSizeUVRatio=.1,this._darkness=0,this._transparencyShadow=!1,this.enableSoftTransparentShadow=!1,this.frustumEdgeFalloff=0,this.forceBackFacesOnly=!1,this._lightDirection=m.Zero(),this._viewMatrix=G.Zero(),this._projectionMatrix=G.Zero(),this._transformMatrix=G.Zero(),this._cachedPosition=new m(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),this._cachedDirection=new m(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),this._currentFaceIndex=0,this._currentFaceIndexCache=0,this._defaultTextureMatrix=G.Identity(),this._mapSize=e,this._light=t,this._scene=t.getScene(),t._shadowGenerator=this,this.id=t.id,this._useUBO=this._scene.getEngine().supportsUniformBuffers,this._useUBO&&(this._sceneUBOs=[],this._sceneUBOs.push(this._scene.createSceneUniformBuffer('Scene for Shadow Generator (light "'.concat(this._light.name,'")')))),i._SceneComponentInitialization(this._scene);var n=this._scene.getEngine().getCaps();r?n.textureFloatRender&&n.textureFloatLinearFiltering?this._textureType=1:n.textureHalfFloatRender&&n.textureHalfFloatLinearFiltering?this._textureType=2:this._textureType=0:n.textureHalfFloatRender&&n.textureHalfFloatLinearFiltering?this._textureType=2:n.textureFloatRender&&n.textureFloatLinearFiltering?this._textureType=1:this._textureType=0,this._initializeGenerator(),this._applyFilterValues()}return Object.defineProperty(i.prototype,"bias",{get:function(){return this._bias},set:function(e){this._bias=e},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"normalBias",{get:function(){return this._normalBias},set:function(e){this._normalBias=e},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"blurBoxOffset",{get:function(){return this._blurBoxOffset},set:function(e){this._blurBoxOffset!==e&&(this._blurBoxOffset=e,this._disposeBlurPostProcesses())},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"blurScale",{get:function(){return this._blurScale},set:function(e){this._blurScale!==e&&(this._blurScale=e,this._disposeBlurPostProcesses())},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"blurKernel",{get:function(){return this._blurKernel},set:function(e){this._blurKernel!==e&&(this._blurKernel=e,this._disposeBlurPostProcesses())},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"useKernelBlur",{get:function(){return this._useKernelBlur},set:function(e){this._useKernelBlur!==e&&(this._useKernelBlur=e,this._disposeBlurPostProcesses())},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"depthScale",{get:function(){return this._depthScale!==void 0?this._depthScale:this._light.getDepthScale()},set:function(e){this._depthScale=e},enumerable:!1,configurable:!0}),i.prototype._validateFilter=function(e){return e},Object.defineProperty(i.prototype,"filter",{get:function(){return this._filter},set:function(e){if(e=this._validateFilter(e),this._light.needCube()){if(e===i.FILTER_BLUREXPONENTIALSHADOWMAP){this.useExponentialShadowMap=!0;return}else if(e===i.FILTER_BLURCLOSEEXPONENTIALSHADOWMAP){this.useCloseExponentialShadowMap=!0;return}else if(e===i.FILTER_PCF||e===i.FILTER_PCSS){this.usePoissonSampling=!0;return}}if((e===i.FILTER_PCF||e===i.FILTER_PCSS)&&!this._scene.getEngine()._features.supportShadowSamplers){this.usePoissonSampling=!0;return}this._filter!==e&&(this._filter=e,this._disposeBlurPostProcesses(),this._applyFilterValues(),this._light._markMeshesAsLightDirty())},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"usePoissonSampling",{get:function(){return this.filter===i.FILTER_POISSONSAMPLING},set:function(e){var t=this._validateFilter(i.FILTER_POISSONSAMPLING);!e&&this.filter!==i.FILTER_POISSONSAMPLING||(this.filter=e?t:i.FILTER_NONE)},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"useExponentialShadowMap",{get:function(){return this.filter===i.FILTER_EXPONENTIALSHADOWMAP},set:function(e){var t=this._validateFilter(i.FILTER_EXPONENTIALSHADOWMAP);!e&&this.filter!==i.FILTER_EXPONENTIALSHADOWMAP||(this.filter=e?t:i.FILTER_NONE)},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"useBlurExponentialShadowMap",{get:function(){return this.filter===i.FILTER_BLUREXPONENTIALSHADOWMAP},set:function(e){var t=this._validateFilter(i.FILTER_BLUREXPONENTIALSHADOWMAP);!e&&this.filter!==i.FILTER_BLUREXPONENTIALSHADOWMAP||(this.filter=e?t:i.FILTER_NONE)},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"useCloseExponentialShadowMap",{get:function(){return this.filter===i.FILTER_CLOSEEXPONENTIALSHADOWMAP},set:function(e){var t=this._validateFilter(i.FILTER_CLOSEEXPONENTIALSHADOWMAP);!e&&this.filter!==i.FILTER_CLOSEEXPONENTIALSHADOWMAP||(this.filter=e?t:i.FILTER_NONE)},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"useBlurCloseExponentialShadowMap",{get:function(){return this.filter===i.FILTER_BLURCLOSEEXPONENTIALSHADOWMAP},set:function(e){var t=this._validateFilter(i.FILTER_BLURCLOSEEXPONENTIALSHADOWMAP);!e&&this.filter!==i.FILTER_BLURCLOSEEXPONENTIALSHADOWMAP||(this.filter=e?t:i.FILTER_NONE)},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"usePercentageCloserFiltering",{get:function(){return this.filter===i.FILTER_PCF},set:function(e){var t=this._validateFilter(i.FILTER_PCF);!e&&this.filter!==i.FILTER_PCF||(this.filter=e?t:i.FILTER_NONE)},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"filteringQuality",{get:function(){return this._filteringQuality},set:function(e){this._filteringQuality!==e&&(this._filteringQuality=e,this._disposeBlurPostProcesses(),this._applyFilterValues(),this._light._markMeshesAsLightDirty())},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"useContactHardeningShadow",{get:function(){return this.filter===i.FILTER_PCSS},set:function(e){var t=this._validateFilter(i.FILTER_PCSS);!e&&this.filter!==i.FILTER_PCSS||(this.filter=e?t:i.FILTER_NONE)},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"contactHardeningLightSizeUVRatio",{get:function(){return this._contactHardeningLightSizeUVRatio},set:function(e){this._contactHardeningLightSizeUVRatio=e},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"darkness",{get:function(){return this._darkness},set:function(e){this.setDarkness(e)},enumerable:!1,configurable:!0}),i.prototype.getDarkness=function(){return this._darkness},i.prototype.setDarkness=function(e){return e>=1?this._darkness=1:e<=0?this._darkness=0:this._darkness=e,this},Object.defineProperty(i.prototype,"transparencyShadow",{get:function(){return this._transparencyShadow},set:function(e){this.setTransparencyShadow(e)},enumerable:!1,configurable:!0}),i.prototype.setTransparencyShadow=function(e){return this._transparencyShadow=e,this},i.prototype.getShadowMap=function(){return this._shadowMap},i.prototype.getShadowMapForRendering=function(){return this._shadowMap2?this._shadowMap2:this._shadowMap},i.prototype.getClassName=function(){return i.CLASSNAME},i.prototype.addShadowCaster=function(e,t){if(t===void 0&&(t=!0),!this._shadowMap)return this;if(this._shadowMap.renderList||(this._shadowMap.renderList=[]),this._shadowMap.renderList.indexOf(e)===-1&&this._shadowMap.renderList.push(e),t)for(var r=0,n=e.getChildMeshes();r<n.length;r++){var a=n[r];this._shadowMap.renderList.indexOf(a)===-1&&this._shadowMap.renderList.push(a)}return this},i.prototype.removeShadowCaster=function(e,t){if(t===void 0&&(t=!0),!this._shadowMap||!this._shadowMap.renderList)return this;var r=this._shadowMap.renderList.indexOf(e);if(r!==-1&&this._shadowMap.renderList.splice(r,1),t)for(var n=0,a=e.getChildren();n<a.length;n++){var s=a[n];this.removeShadowCaster(s)}return this},i.prototype.getLight=function(){return this._light},Object.defineProperty(i.prototype,"mapSize",{get:function(){return this._mapSize},set:function(e){this._mapSize=e,this._light._markMeshesAsLightDirty(),this.recreateShadowMap()},enumerable:!1,configurable:!0}),i.prototype._initializeGenerator=function(){this._light._markMeshesAsLightDirty(),this._initializeShadowMap()},i.prototype._createTargetRenderTexture=function(){var e=this._scene.getEngine();e._features.supportDepthStencilTexture?(this._shadowMap=new ur(this._light.name+"_shadowMap",this._mapSize,this._scene,!1,!0,this._textureType,this._light.needCube(),void 0,!1,!1),this._shadowMap.createDepthStencilTexture(e.useReverseDepthBuffer?516:513,!0)):this._shadowMap=new ur(this._light.name+"_shadowMap",this._mapSize,this._scene,!1,!0,this._textureType,this._light.needCube())},i.prototype._initializeShadowMap=function(){var e=this;if(this._createTargetRenderTexture(),this._shadowMap!==null){this._shadowMap.wrapU=re.CLAMP_ADDRESSMODE,this._shadowMap.wrapV=re.CLAMP_ADDRESSMODE,this._shadowMap.anisotropicFilteringLevel=1,this._shadowMap.updateSamplingMode(re.BILINEAR_SAMPLINGMODE),this._shadowMap.renderParticles=!1,this._shadowMap.ignoreCameraViewport=!0,this._storedUniqueId&&(this._shadowMap.uniqueId=this._storedUniqueId),this._shadowMap.customRenderFunction=this._renderForShadowMap.bind(this),this._shadowMap.customIsReadyFunction=function(){return!0};var t=this._scene.getEngine();this._shadowMap.onBeforeBindObservable.add(function(){var s;e._currentSceneUBO=e._scene.getSceneUniformBuffer(),(s=t._debugPushGroup)===null||s===void 0||s.call(t,"shadow map generation for pass id ".concat(t.currentRenderPassId),1)}),this._shadowMap.onBeforeRenderObservable.add(function(s){e._sceneUBOs&&e._scene.setSceneUniformBuffer(e._sceneUBOs[0]),e._currentFaceIndex=s,e._filter===i.FILTER_PCF&&t.setColorWrite(!1),e.getTransformMatrix(),e._scene.setTransformMatrix(e._viewMatrix,e._projectionMatrix),e._useUBO&&(e._scene.getSceneUniformBuffer().unbindEffect(),e._scene.finalizeSceneUbo())}),this._shadowMap.onAfterUnbindObservable.add(function(){var s,o;if(e._sceneUBOs&&e._scene.setSceneUniformBuffer(e._currentSceneUBO),e._scene.updateTransformMatrix(),e._filter===i.FILTER_PCF&&t.setColorWrite(!0),!e.useBlurExponentialShadowMap&&!e.useBlurCloseExponentialShadowMap){(s=t._debugPopGroup)===null||s===void 0||s.call(t,1);return}var l=e.getShadowMapForRendering();l&&(e._scene.postProcessManager.directRender(e._blurPostProcesses,l.renderTarget,!0),t.unBindFramebuffer(l.renderTarget,!0),(o=t._debugPopGroup)===null||o===void 0||o.call(t,1))});var r=new ce(0,0,0,0),n=new ce(1,1,1,1);this._shadowMap.onClearObservable.add(function(s){e._filter===i.FILTER_PCF?s.clear(n,!1,!0,!1):e.useExponentialShadowMap||e.useBlurExponentialShadowMap?s.clear(r,!0,!0,!1):s.clear(n,!0,!0,!1)}),this._shadowMap.onResizeObservable.add(function(s){e._storedUniqueId=e._shadowMap.uniqueId,e._mapSize=s.getRenderSize(),e._light._markMeshesAsLightDirty(),e.recreateShadowMap()});for(var a=Jr.MIN_RENDERINGGROUPS;a<Jr.MAX_RENDERINGGROUPS;a++)this._shadowMap.setRenderingAutoClearDepthStencil(a,!1)}},i.prototype._initializeBlurRTTAndPostProcesses=function(){var e=this,t=this._scene.getEngine(),r=this._mapSize/this.blurScale;(!this.useKernelBlur||this.blurScale!==1)&&(this._shadowMap2=new ur(this._light.name+"_shadowMap2",r,this._scene,!1,!0,this._textureType,void 0,void 0,!1),this._shadowMap2.wrapU=re.CLAMP_ADDRESSMODE,this._shadowMap2.wrapV=re.CLAMP_ADDRESSMODE,this._shadowMap2.updateSamplingMode(re.BILINEAR_SAMPLINGMODE)),this.useKernelBlur?(this._kernelBlurXPostprocess=new Br(this._light.name+"KernelBlurX",new se(1,0),this.blurKernel,1,null,re.BILINEAR_SAMPLINGMODE,t,!1,this._textureType),this._kernelBlurXPostprocess.width=r,this._kernelBlurXPostprocess.height=r,this._kernelBlurXPostprocess.externalTextureSamplerBinding=!0,this._kernelBlurXPostprocess.onApplyObservable.add(function(n){n.setTexture("textureSampler",e._shadowMap)}),this._kernelBlurYPostprocess=new Br(this._light.name+"KernelBlurY",new se(0,1),this.blurKernel,1,null,re.BILINEAR_SAMPLINGMODE,t,!1,this._textureType),this._kernelBlurXPostprocess.autoClear=!1,this._kernelBlurYPostprocess.autoClear=!1,this._textureType===0&&(this._kernelBlurXPostprocess.packedFloat=!0,this._kernelBlurYPostprocess.packedFloat=!0),this._blurPostProcesses=[this._kernelBlurXPostprocess,this._kernelBlurYPostprocess]):(this._boxBlurPostprocess=new St(this._light.name+"DepthBoxBlur","depthBoxBlur",["screenSize","boxOffset"],[],1,null,re.BILINEAR_SAMPLINGMODE,t,!1,"#define OFFSET "+this._blurBoxOffset,this._textureType),this._boxBlurPostprocess.externalTextureSamplerBinding=!0,this._boxBlurPostprocess.onApplyObservable.add(function(n){n.setFloat2("screenSize",r,r),n.setTexture("textureSampler",e._shadowMap)}),this._boxBlurPostprocess.autoClear=!1,this._blurPostProcesses=[this._boxBlurPostprocess])},i.prototype._renderForShadowMap=function(e,t,r,n){var a;if(n.length)for(a=0;a<n.length;a++)this._renderSubMeshForShadowMap(n.data[a]);for(a=0;a<e.length;a++)this._renderSubMeshForShadowMap(e.data[a]);for(a=0;a<t.length;a++)this._renderSubMeshForShadowMap(t.data[a]);if(this._transparencyShadow)for(a=0;a<r.length;a++)this._renderSubMeshForShadowMap(r.data[a],!0);else for(a=0;a<r.length;a++)r.data[a].getEffectiveMesh()._internalAbstractMeshDataInfo._isActiveIntermediate=!1},i.prototype._bindCustomEffectForRenderSubMeshForShadowMap=function(e,t,r){t.setMatrix("viewProjection",this.getTransformMatrix())},i.prototype._renderSubMeshForShadowMap=function(e,t){var r,n;t===void 0&&(t=!1);var a=e.getRenderingMesh(),s=e.getEffectiveMesh(),o=this._scene,l=o.getEngine(),u=e.getMaterial();if(s._internalAbstractMeshDataInfo._isActiveIntermediate=!1,!(!u||e.verticesCount===0||e._renderId===o.getRenderId())){var f=s._getWorldMatrixDeterminant()<0,h=(r=a.overrideMaterialSideOrientation)!==null&&r!==void 0?r:u.sideOrientation;f&&(h=h===0?1:0);var c=h===0;l.setState(u.backFaceCulling,void 0,void 0,c,u.cullBackFaces);var d=a._getInstancesRenderList(e._id,!!e.getReplacementMesh());if(!d.mustReturn){var p=l.getCaps().instancedArrays&&(d.visibleInstances[e._id]!==null&&d.visibleInstances[e._id]!==void 0||a.hasThinInstances);if(!(this.customAllowRendering&&!this.customAllowRendering(e)))if(this.isReady(e,p,t)){e._renderId=o.getRenderId();var _=u.shadowDepthWrapper,g=(n=_==null?void 0:_.getEffect(e,this,l.currentRenderPassId))!==null&&n!==void 0?n:e._getDrawWrapper(),v=Bt.GetEffect(g);if(l.enableEffect(g),p||a._bind(e,v,u.fillMode),this.getTransformMatrix(),v.setFloat3("biasAndScaleSM",this.bias,this.normalBias,this.depthScale),this.getLight().getTypeID()===gt.LIGHTTYPEID_DIRECTIONALLIGHT?v.setVector3("lightDataSM",this._cachedDirection):v.setVector3("lightDataSM",this._cachedPosition),o.activeCamera&&v.setFloat2("depthValuesSM",this.getLight().getDepthMinZ(o.activeCamera),this.getLight().getDepthMinZ(o.activeCamera)+this.getLight().getDepthMaxZ(o.activeCamera)),t&&this.enableSoftTransparentShadow&&v.setFloat("softTransparentShadowSM",s.visibility*u.alpha),_)e._setMainDrawWrapperOverride(g),_.standalone?_.baseMaterial.bindForSubMesh(s.getWorldMatrix(),a,e):u.bindForSubMesh(s.getWorldMatrix(),a,e),e._setMainDrawWrapperOverride(null);else{if(u&&u.needAlphaTesting()){var y=u.getAlphaTestTexture();y&&(v.setTexture("diffuseSampler",y),v.setMatrix("diffuseMatrix",y.getTextureMatrix()||this._defaultTextureMatrix))}if(a.useBones&&a.computeBonesUsingShaders&&a.skeleton){var b=a.skeleton;if(b.isUsingTextureForMatrices){var E=b.getTransformMatrixTexture(a);if(!E)return;v.setTexture("boneSampler",E),v.setFloat("boneTextureWidth",4*(b.bones.length+1))}else v.setMatrices("mBones",b.getTransformMatrices(a))}le.BindMorphTargetParameters(a,v),a.morphTargetManager&&a.morphTargetManager.isUsingTextureForTargets&&a.morphTargetManager._bind(v),le.BindClipPlane(v,o)}!this._useUBO&&!_&&this._bindCustomEffectForRenderSubMeshForShadowMap(e,v,s),le.BindSceneUniformBuffer(v,this._scene.getSceneUniformBuffer()),this._scene.getSceneUniformBuffer().bindUniformBuffer();var A=s.getWorldMatrix();p&&(s.getMeshUniformBuffer().bindToEffect(v,"Mesh"),s.transferToEffect(A)),this.forceBackFacesOnly&&l.setState(!0,0,!1,!0,u.cullBackFaces),this.onBeforeShadowMapRenderMeshObservable.notifyObservers(a),this.onBeforeShadowMapRenderObservable.notifyObservers(v),a._processRendering(s,e,v,u.fillMode,d,p,function(S,T){s!==a&&!S?(a.getMeshUniformBuffer().bindToEffect(v,"Mesh"),a.transferToEffect(T)):(s.getMeshUniformBuffer().bindToEffect(v,"Mesh"),s.transferToEffect(S?T:A))}),this.forceBackFacesOnly&&l.setState(!0,0,!1,!1,u.cullBackFaces),this.onAfterShadowMapRenderObservable.notifyObservers(v),this.onAfterShadowMapRenderMeshObservable.notifyObservers(a)}else this._shadowMap&&this._shadowMap.resetRefreshCounter()}}},i.prototype._applyFilterValues=function(){!this._shadowMap||(this.filter===i.FILTER_NONE||this.filter===i.FILTER_PCSS?this._shadowMap.updateSamplingMode(re.NEAREST_SAMPLINGMODE):this._shadowMap.updateSamplingMode(re.BILINEAR_SAMPLINGMODE))},i.prototype.forceCompilation=function(e,t){var r=this,n=Ue({useInstances:!1},t),a=this.getShadowMap();if(!a){e&&e(this);return}var s=a.renderList;if(!s){e&&e(this);return}for(var o=new Array,l=0,u=s;l<u.length;l++){var f=u[l];o.push.apply(o,f.subMeshes)}if(o.length===0){e&&e(this);return}var h=0,c=function(){var d,p;if(!(!r._scene||!r._scene.getEngine())){for(;r.isReady(o[h],n.useInstances,(p=(d=o[h].getMaterial())===null||d===void 0?void 0:d.needAlphaBlendingForMesh(o[h].getMesh()))!==null&&p!==void 0?p:!1);)if(h++,h>=o.length){e&&e(r);return}setTimeout(c,16)}};c()},i.prototype.forceCompilationAsync=function(e){var t=this;return new Promise(function(r){t.forceCompilation(function(){r()},e)})},i.prototype._isReadyCustomDefines=function(e,t,r){},i.prototype._prepareShadowDefines=function(e,t,r,n){r.push("#define SM_FLOAT "+(this._textureType!==0?"1":"0")),r.push("#define SM_ESM "+(this.useExponentialShadowMap||this.useBlurExponentialShadowMap?"1":"0")),r.push("#define SM_DEPTHTEXTURE "+(this.usePercentageCloserFiltering||this.useContactHardeningShadow?"1":"0"));var a=e.getMesh();return r.push("#define SM_NORMALBIAS "+(this.normalBias&&a.isVerticesDataPresent(R.NormalKind)?"1":"0")),r.push("#define SM_DIRECTIONINLIGHTDATA "+(this.getLight().getTypeID()===gt.LIGHTTYPEID_DIRECTIONALLIGHT?"1":"0")),r.push("#define SM_USEDISTANCE "+(this._light.needCube()?"1":"0")),r.push("#define SM_SOFTTRANSPARENTSHADOW "+(this.enableSoftTransparentShadow&&n?"1":"0")),this._isReadyCustomDefines(r,e,t),r},i.prototype.isReady=function(e,t,r){var n,a=e.getMaterial(),s=a==null?void 0:a.shadowDepthWrapper,o=[];if(this._prepareShadowDefines(e,t,o,r),s){if(!s.isReadyForSubMesh(e,o,this,t,this._scene.getEngine().currentRenderPassId))return!1}else{var l=e._getDrawWrapper(void 0,!0),u=l.effect,f=l.defines,h=[R.PositionKind],c=e.getMesh();if(this.normalBias&&c.isVerticesDataPresent(R.NormalKind)&&(h.push(R.NormalKind),o.push("#define NORMAL"),c.nonUniformScaling&&o.push("#define NONUNIFORMSCALING")),a&&a.needAlphaTesting()){var d=a.getAlphaTestTexture();if(d){if(!d.isReady())return!1;var p=(n=a.alphaCutOff)!==null&&n!==void 0?n:1;o.push("#define ALPHATEST"),o.push("#define ALPHATESTVALUE ".concat(p).concat(p%1===0?".":"")),c.isVerticesDataPresent(R.UVKind)&&(h.push(R.UVKind),o.push("#define UV1")),c.isVerticesDataPresent(R.UV2Kind)&&d.coordinatesIndex===1&&(h.push(R.UV2Kind),o.push("#define UV2"))}}var _=new oi;if(c.useBones&&c.computeBonesUsingShaders&&c.skeleton){h.push(R.MatricesIndicesKind),h.push(R.MatricesWeightsKind),c.numBoneInfluencers>4&&(h.push(R.MatricesIndicesExtraKind),h.push(R.MatricesWeightsExtraKind));var g=c.skeleton;o.push("#define NUM_BONE_INFLUENCERS "+c.numBoneInfluencers),c.numBoneInfluencers>0&&_.addCPUSkinningFallback(0,c),g.isUsingTextureForMatrices?o.push("#define BONETEXTURE"):o.push("#define BonesPerMesh "+(g.bones.length+1))}else o.push("#define NUM_BONE_INFLUENCERS 0");var v=c.morphTargetManager,y=0;v&&v.numInfluencers>0&&(o.push("#define MORPHTARGETS"),y=v.numInfluencers,o.push("#define NUM_MORPH_INFLUENCERS "+y),v.isUsingTextureForTargets&&o.push("#define MORPHTARGETS_TEXTURE"),le.PrepareAttributesForMorphTargetsInfluencers(h,c,y));var b=this._scene;if(b.clipPlane&&o.push("#define CLIPPLANE"),b.clipPlane2&&o.push("#define CLIPPLANE2"),b.clipPlane3&&o.push("#define CLIPPLANE3"),b.clipPlane4&&o.push("#define CLIPPLANE4"),b.clipPlane5&&o.push("#define CLIPPLANE5"),b.clipPlane6&&o.push("#define CLIPPLANE6"),t&&(o.push("#define INSTANCES"),le.PushAttributesForInstances(h),e.getRenderingMesh().hasThinInstances&&o.push("#define THIN_INSTANCES")),this.customShaderOptions&&this.customShaderOptions.defines)for(var E=0,A=this.customShaderOptions.defines;E<A.length;E++){var S=A[E];o.indexOf(S)===-1&&o.push(S)}var T=o.join(`
`);if(f!==T){f=T;var M="shadowMap",D=["world","mBones","viewProjection","diffuseMatrix","lightDataSM","depthValuesSM","biasAndScaleSM","morphTargetInfluences","boneTextureWidth","vClipPlane","vClipPlane2","vClipPlane3","vClipPlane4","vClipPlane5","vClipPlane6","softTransparentShadowSM","morphTargetTextureInfo","morphTargetTextureIndices"],x=["diffuseSampler","boneSampler","morphTargets"],P=["Scene","Mesh"];if(this.customShaderOptions){if(M=this.customShaderOptions.shaderName,this.customShaderOptions.attributes)for(var w=0,k=this.customShaderOptions.attributes;w<k.length;w++){var B=k[w];h.indexOf(B)===-1&&h.push(B)}if(this.customShaderOptions.uniforms)for(var L=0,H=this.customShaderOptions.uniforms;L<H.length;L++){var W=H[L];D.indexOf(W)===-1&&D.push(W)}if(this.customShaderOptions.samplers)for(var F=0,V=this.customShaderOptions.samplers;F<V.length;F++){var z=V[F];x.indexOf(z)===-1&&x.push(z)}}var N=this._scene.getEngine();u=N.createEffect(M,{attributes:h,uniformsNames:D,uniformBuffersNames:P,samplers:x,defines:T,fallbacks:_,onCompiled:null,onError:null,indexParameters:{maxSimultaneousMorphTargets:y}},N),l.setEffect(u,f)}if(!u.isReady())return!1}return(this.useBlurExponentialShadowMap||this.useBlurCloseExponentialShadowMap)&&(!this._blurPostProcesses||!this._blurPostProcesses.length)&&this._initializeBlurRTTAndPostProcesses(),!(this._kernelBlurXPostprocess&&!this._kernelBlurXPostprocess.isReady()||this._kernelBlurYPostprocess&&!this._kernelBlurYPostprocess.isReady()||this._boxBlurPostprocess&&!this._boxBlurPostprocess.isReady())},i.prototype.prepareDefines=function(e,t){var r=this._scene,n=this._light;!r.shadowsEnabled||!n.shadowEnabled||(e["SHADOW"+t]=!0,this.useContactHardeningShadow?(e["SHADOWPCSS"+t]=!0,this._filteringQuality===i.QUALITY_LOW?e["SHADOWLOWQUALITY"+t]=!0:this._filteringQuality===i.QUALITY_MEDIUM&&(e["SHADOWMEDIUMQUALITY"+t]=!0)):this.usePercentageCloserFiltering?(e["SHADOWPCF"+t]=!0,this._filteringQuality===i.QUALITY_LOW?e["SHADOWLOWQUALITY"+t]=!0:this._filteringQuality===i.QUALITY_MEDIUM&&(e["SHADOWMEDIUMQUALITY"+t]=!0)):this.usePoissonSampling?e["SHADOWPOISSON"+t]=!0:this.useExponentialShadowMap||this.useBlurExponentialShadowMap?e["SHADOWESM"+t]=!0:(this.useCloseExponentialShadowMap||this.useBlurCloseExponentialShadowMap)&&(e["SHADOWCLOSEESM"+t]=!0),n.needCube()&&(e["SHADOWCUBE"+t]=!0))},i.prototype.bindShadowLight=function(e,t){var r=this._light,n=this._scene;if(!(!n.shadowsEnabled||!r.shadowEnabled)){var a=n.activeCamera;if(!!a){var s=this.getShadowMap();!s||(r.needCube()||t.setMatrix("lightMatrix"+e,this.getTransformMatrix()),this._filter===i.FILTER_PCF?(t.setDepthStencilTexture("shadowSampler"+e,this.getShadowMapForRendering()),r._uniformBuffer.updateFloat4("shadowsInfo",this.getDarkness(),s.getSize().width,1/s.getSize().width,this.frustumEdgeFalloff,e)):this._filter===i.FILTER_PCSS?(t.setDepthStencilTexture("shadowSampler"+e,this.getShadowMapForRendering()),t.setTexture("depthSampler"+e,this.getShadowMapForRendering()),r._uniformBuffer.updateFloat4("shadowsInfo",this.getDarkness(),1/s.getSize().width,this._contactHardeningLightSizeUVRatio*s.getSize().width,this.frustumEdgeFalloff,e)):(t.setTexture("shadowSampler"+e,this.getShadowMapForRendering()),r._uniformBuffer.updateFloat4("shadowsInfo",this.getDarkness(),this.blurScale/s.getSize().width,this.depthScale,this.frustumEdgeFalloff,e)),r._uniformBuffer.updateFloat2("depthValues",this.getLight().getDepthMinZ(a),this.getLight().getDepthMinZ(a)+this.getLight().getDepthMaxZ(a),e))}}},i.prototype.getTransformMatrix=function(){var e=this._scene;if(this._currentRenderId===e.getRenderId()&&this._currentFaceIndexCache===this._currentFaceIndex)return this._transformMatrix;this._currentRenderId=e.getRenderId(),this._currentFaceIndexCache=this._currentFaceIndex;var t=this._light.position;if(this._light.computeTransformedInformation()&&(t=this._light.transformedPosition),m.NormalizeToRef(this._light.getShadowDirection(this._currentFaceIndex),this._lightDirection),Math.abs(m.Dot(this._lightDirection,m.Up()))===1&&(this._lightDirection.z=1e-13),this._light.needProjectionMatrixCompute()||!this._cachedPosition||!this._cachedDirection||!t.equals(this._cachedPosition)||!this._lightDirection.equals(this._cachedDirection)){this._cachedPosition.copyFrom(t),this._cachedDirection.copyFrom(this._lightDirection),G.LookAtLHToRef(t,t.add(this._lightDirection),m.Up(),this._viewMatrix);var r=this.getShadowMap();if(r){var n=r.renderList;n&&this._light.setShadowProjectionMatrix(this._projectionMatrix,this._viewMatrix,n)}this._viewMatrix.multiplyToRef(this._projectionMatrix,this._transformMatrix)}return this._transformMatrix},i.prototype.recreateShadowMap=function(){var e=this._shadowMap;if(!!e){var t=e.renderList;if(this._disposeRTTandPostProcesses(),this._initializeGenerator(),this.filter=this._filter,this._applyFilterValues(),t){this._shadowMap.renderList||(this._shadowMap.renderList=[]);for(var r=0,n=t;r<n.length;r++){var a=n[r];this._shadowMap.renderList.push(a)}}else this._shadowMap.renderList=null}},i.prototype._disposeBlurPostProcesses=function(){this._shadowMap2&&(this._shadowMap2.dispose(),this._shadowMap2=null),this._boxBlurPostprocess&&(this._boxBlurPostprocess.dispose(),this._boxBlurPostprocess=null),this._kernelBlurXPostprocess&&(this._kernelBlurXPostprocess.dispose(),this._kernelBlurXPostprocess=null),this._kernelBlurYPostprocess&&(this._kernelBlurYPostprocess.dispose(),this._kernelBlurYPostprocess=null),this._blurPostProcesses=[]},i.prototype._disposeRTTandPostProcesses=function(){this._shadowMap&&(this._shadowMap.dispose(),this._shadowMap=null),this._disposeBlurPostProcesses()},i.prototype._disposeSceneUBOs=function(){if(this._sceneUBOs){for(var e=0,t=this._sceneUBOs;e<t.length;e++){var r=t[e];r.dispose()}this._sceneUBOs=[]}},i.prototype.dispose=function(){this._disposeRTTandPostProcesses(),this._disposeSceneUBOs(),this._light&&(this._light._shadowGenerator=null,this._light._markMeshesAsLightDirty()),this.onBeforeShadowMapRenderMeshObservable.clear(),this.onBeforeShadowMapRenderObservable.clear(),this.onAfterShadowMapRenderMeshObservable.clear(),this.onAfterShadowMapRenderObservable.clear()},i.prototype.serialize=function(){var e={},t=this.getShadowMap();if(!t)return e;if(e.className=this.getClassName(),e.lightId=this._light.id,e.id=this.id,e.mapSize=t.getRenderSize(),e.forceBackFacesOnly=this.forceBackFacesOnly,e.darkness=this.getDarkness(),e.transparencyShadow=this._transparencyShadow,e.frustumEdgeFalloff=this.frustumEdgeFalloff,e.bias=this.bias,e.normalBias=this.normalBias,e.usePercentageCloserFiltering=this.usePercentageCloserFiltering,e.useContactHardeningShadow=this.useContactHardeningShadow,e.contactHardeningLightSizeUVRatio=this.contactHardeningLightSizeUVRatio,e.filteringQuality=this.filteringQuality,e.useExponentialShadowMap=this.useExponentialShadowMap,e.useBlurExponentialShadowMap=this.useBlurExponentialShadowMap,e.useCloseExponentialShadowMap=this.useBlurExponentialShadowMap,e.useBlurCloseExponentialShadowMap=this.useBlurExponentialShadowMap,e.usePoissonSampling=this.usePoissonSampling,e.depthScale=this.depthScale,e.blurBoxOffset=this.blurBoxOffset,e.blurKernel=this.blurKernel,e.blurScale=this.blurScale,e.useKernelBlur=this.useKernelBlur,e.renderList=[],t.renderList)for(var r=0;r<t.renderList.length;r++){var n=t.renderList[r];e.renderList.push(n.id)}return e},i.Parse=function(e,t,r){for(var n=t.getLightById(e.lightId),a=r?r(e.mapSize,n):new i(e.mapSize,n),s=a.getShadowMap(),o=0;o<e.renderList.length;o++){var l=t.getMeshesById(e.renderList[o]);l.forEach(function(u){!s||(s.renderList||(s.renderList=[]),s.renderList.push(u))})}return e.id!==void 0&&(a.id=e.id),a.forceBackFacesOnly=!!e.forceBackFacesOnly,e.darkness!==void 0&&a.setDarkness(e.darkness),e.transparencyShadow&&a.setTransparencyShadow(!0),e.frustumEdgeFalloff!==void 0&&(a.frustumEdgeFalloff=e.frustumEdgeFalloff),e.bias!==void 0&&(a.bias=e.bias),e.normalBias!==void 0&&(a.normalBias=e.normalBias),e.usePercentageCloserFiltering?a.usePercentageCloserFiltering=!0:e.useContactHardeningShadow?a.useContactHardeningShadow=!0:e.usePoissonSampling?a.usePoissonSampling=!0:e.useExponentialShadowMap?a.useExponentialShadowMap=!0:e.useBlurExponentialShadowMap?a.useBlurExponentialShadowMap=!0:e.useCloseExponentialShadowMap?a.useCloseExponentialShadowMap=!0:e.useBlurCloseExponentialShadowMap?a.useBlurCloseExponentialShadowMap=!0:e.useVarianceShadowMap?a.useExponentialShadowMap=!0:e.useBlurVarianceShadowMap&&(a.useBlurExponentialShadowMap=!0),e.contactHardeningLightSizeUVRatio!==void 0&&(a.contactHardeningLightSizeUVRatio=e.contactHardeningLightSizeUVRatio),e.filteringQuality!==void 0&&(a.filteringQuality=e.filteringQuality),e.depthScale&&(a.depthScale=e.depthScale),e.blurScale&&(a.blurScale=e.blurScale),e.blurBoxOffset&&(a.blurBoxOffset=e.blurBoxOffset),e.useKernelBlur&&(a.useKernelBlur=e.useKernelBlur),e.blurKernel&&(a.blurKernel=e.blurKernel),a},i.CLASSNAME="ShadowGenerator",i.FILTER_NONE=0,i.FILTER_EXPONENTIALSHADOWMAP=1,i.FILTER_POISSONSAMPLING=2,i.FILTER_BLUREXPONENTIALSHADOWMAP=3,i.FILTER_CLOSEEXPONENTIALSHADOWMAP=4,i.FILTER_BLURCLOSEEXPONENTIALSHADOWMAP=5,i.FILTER_PCF=6,i.FILTER_PCSS=7,i.QUALITY_HIGH=0,i.QUALITY_MEDIUM=1,i.QUALITY_LOW=2,i._SceneComponentInitialization=function(e){throw he("ShadowGeneratorSceneComponent")},i})();var Ta=function(){function i(e,t){t===void 0&&(t=i.DefaultNumWorkers),this._engine=e,i._Initialize(t)}return i.GetDefaultNumWorkers=function(){return typeof navigator!="object"||!navigator.hardwareConcurrency?1:Math.min(Math.floor(navigator.hardwareConcurrency*.5),4)},i._Initialize=function(e){i._WorkerPoolPromise||i._DecoderModulePromise||(e&&typeof Worker=="function"?i._WorkerPoolPromise=new Promise(function(t){var r="(".concat(Qd,")()"),n=URL.createObjectURL(new Blob([r],{type:"application/javascript"}));t(new wc(e,function(){return new Promise(function(a,s){var o=new Worker(n),l=function(f){o.removeEventListener("error",l),o.removeEventListener("message",u),s(f)},u=function(f){f.data.action==="init"&&(o.removeEventListener("error",l),o.removeEventListener("message",u),a(o))};o.addEventListener("error",l),o.addEventListener("message",u),o.postMessage({action:"init",urls:i.URLConfig})})}))}):typeof KTX2DECODER=="undefined"?i._DecoderModulePromise=te.LoadScriptAsync(i.URLConfig.jsDecoderModule).then(function(){KTX2DECODER.MSCTranscoder.UseFromWorkerThread=!1,KTX2DECODER.WASMMemoryManager.LoadBinariesFromCurrentThread=!0;var t=i.URLConfig;return t.wasmUASTCToASTC!==null&&(KTX2DECODER.LiteTranscoder_UASTC_ASTC.WasmModuleURL=t.wasmUASTCToASTC),t.wasmUASTCToBC7!==null&&(KTX2DECODER.LiteTranscoder_UASTC_BC7.WasmModuleURL=t.wasmUASTCToBC7),t.wasmUASTCToRGBA_UNORM!==null&&(KTX2DECODER.LiteTranscoder_UASTC_RGBA_UNORM.WasmModuleURL=t.wasmUASTCToRGBA_UNORM),t.wasmUASTCToRGBA_SRGB!==null&&(KTX2DECODER.LiteTranscoder_UASTC_RGBA_SRGB.WasmModuleURL=t.wasmUASTCToRGBA_SRGB),t.jsMSCTranscoder!==null&&(KTX2DECODER.MSCTranscoder.JSModuleURL=t.jsMSCTranscoder),t.wasmMSCTranscoder!==null&&(KTX2DECODER.MSCTranscoder.WasmModuleURL=t.wasmMSCTranscoder),t.wasmZSTDDecoder!==null&&(KTX2DECODER.ZSTDDecoder.WasmModuleURL=t.wasmZSTDDecoder),new KTX2DECODER.KTX2Decoder}):(KTX2DECODER.MSCTranscoder.UseFromWorkerThread=!1,KTX2DECODER.WASMMemoryManager.LoadBinariesFromCurrentThread=!0,i._DecoderModulePromise=Promise.resolve(new KTX2DECODER.KTX2Decoder)))},i.prototype.uploadAsync=function(e,t,r){var n=this,a=this._engine.getCaps(),s={astc:!!a.astc,bptc:!!a.bptc,s3tc:!!a.s3tc,pvrtc:!!a.pvrtc,etc2:!!a.etc2,etc1:!!a.etc1};if(i._WorkerPoolPromise)return i._WorkerPoolPromise.then(function(o){return new Promise(function(l,u){o.push(function(f,h){var c=function(_){f.removeEventListener("error",c),f.removeEventListener("message",d),u(_),h()},d=function(_){if(_.data.action==="decoded"){if(f.removeEventListener("error",c),f.removeEventListener("message",d),!_.data.success)u({message:_.data.msg});else try{n._createTexture(_.data.decodedData,t,r),l()}catch(g){u({message:g})}h()}};f.addEventListener("error",c),f.addEventListener("message",d);var p=new Uint8Array(e.byteLength);p.set(new Uint8Array(e.buffer,e.byteOffset,e.byteLength)),f.postMessage({action:"decode",data:p,caps:s,options:r},[p.buffer])})})});if(i._DecoderModulePromise)return i._DecoderModulePromise.then(function(o){return new Promise(function(l,u){o.decode(e,a).then(function(f){n._createTexture(f,t),l()}).catch(function(f){u({message:f})})})});throw new Error("KTX2 decoder module is not available")},i.prototype._createTexture=function(e,t,r){var n=3553;if(this._engine._bindTextureDirectly(n,t),r&&(r.transcodedFormat=e.transcodedFormat,r.isInGammaSpace=e.isInGammaSpace,r.hasAlpha=e.hasAlpha,r.transcoderName=e.transcoderName),e.transcodedFormat===32856?(t.type=0,t.format=5):t.format=e.transcodedFormat,t._gammaSpace=e.isInGammaSpace,t.generateMipMaps=e.mipmaps.length>1,e.errors)throw new Error("KTX2 container - could not transcode the data. "+e.errors);for(var a=0;a<e.mipmaps.length;++a){var s=e.mipmaps[a];if(!s||!s.data)throw new Error("KTX2 container - could not transcode one of the image");e.transcodedFormat===32856?(t.width=s.width,t.height=s.height,this._engine._uploadDataToTextureDirectly(t,s.data,0,a,void 0,!0)):this._engine._uploadCompressedDataToTextureDirectly(t,e.transcodedFormat,s.width,s.height,s.data,0,a)}t._extension=".ktx2",t.width=e.mipmaps[0].width,t.height=e.mipmaps[0].height,t.isReady=!0,this._engine._bindTextureDirectly(n,null)},i.IsValid=function(e){if(e.byteLength>=12){var t=new Uint8Array(e.buffer,e.byteOffset,12);if(t[0]===171&&t[1]===75&&t[2]===84&&t[3]===88&&t[4]===32&&t[5]===50&&t[6]===48&&t[7]===187&&t[8]===13&&t[9]===10&&t[10]===26&&t[11]===10)return!0}return!1},i.URLConfig={jsDecoderModule:"https://preview.babylonjs.com/babylon.ktx2Decoder.js",wasmUASTCToASTC:null,wasmUASTCToBC7:null,wasmUASTCToRGBA_UNORM:null,wasmUASTCToRGBA_SRGB:null,jsMSCTranscoder:null,wasmMSCTranscoder:null,wasmZSTDDecoder:null},i.DefaultNumWorkers=i.GetDefaultNumWorkers(),i}();function Qd(){var i;onmessage=function(e){if(!!e.data)switch(e.data.action){case"init":{var t=e.data.urls;importScripts(t.jsDecoderModule),t.wasmUASTCToASTC!==null&&(KTX2DECODER.LiteTranscoder_UASTC_ASTC.WasmModuleURL=t.wasmUASTCToASTC),t.wasmUASTCToBC7!==null&&(KTX2DECODER.LiteTranscoder_UASTC_BC7.WasmModuleURL=t.wasmUASTCToBC7),t.wasmUASTCToRGBA_UNORM!==null&&(KTX2DECODER.LiteTranscoder_UASTC_RGBA_UNORM.WasmModuleURL=t.wasmUASTCToRGBA_UNORM),t.wasmUASTCToRGBA_SRGB!==null&&(KTX2DECODER.LiteTranscoder_UASTC_RGBA_SRGB.WasmModuleURL=t.wasmUASTCToRGBA_SRGB),t.jsMSCTranscoder!==null&&(KTX2DECODER.MSCTranscoder.JSModuleURL=t.jsMSCTranscoder),t.wasmMSCTranscoder!==null&&(KTX2DECODER.MSCTranscoder.WasmModuleURL=t.wasmMSCTranscoder),t.wasmZSTDDecoder!==null&&(KTX2DECODER.ZSTDDecoder.WasmModuleURL=t.wasmZSTDDecoder),i=new KTX2DECODER.KTX2Decoder,postMessage({action:"init"});break}case"decode":i.decode(e.data.data,e.data.caps,e.data.options).then(function(r){for(var n=[],a=0;a<r.mipmaps.length;++a){var s=r.mipmaps[a];s&&s.data&&n.push(s.data.buffer)}postMessage({action:"decoded",success:!0,decodedData:r},n)}).catch(function(r){postMessage({action:"decoded",success:!1,msg:r})});break}}}var Ea;(function(i){var e=function(){function r(n,a,s,o){a===void 0&&(a=null),s===void 0&&(s=null),o===void 0&&(o=null),a=a!=null?a:function(){return 1},s=s!=null?s:function(){return 1},o=o!=null?o:function(h,c){return h===c?0:1},this._characterToIdx=new Map,this._insertionCosts=new Array(n.length),this._deletionCosts=new Array(n.length),this._substitutionCosts=new Array(n.length);for(var l,u=0;u<n.length;++u){l=n[u],this._characterToIdx.set(l,u),this._insertionCosts[u]=a(l),this._deletionCosts[u]=s(l),this._substitutionCosts[u]=new Array(n.length);for(var f=u;f<n.length;++f)this._substitutionCosts[u][f]=o(l,n[f])}}return r.prototype.serialize=function(){var n={},a=new Array(this._characterToIdx.size);return this._characterToIdx.forEach(function(s,o){a[s]=o}),n.characters=a,n.insertionCosts=this._insertionCosts,n.deletionCosts=this._deletionCosts,n.substitutionCosts=this._substitutionCosts,JSON.stringify(n)},r.Deserialize=function(n){var a=JSON.parse(n),s=new r(a.characters);return s._insertionCosts=a.insertionCosts,s._deletionCosts=a.deletionCosts,s._substitutionCosts=a.substitutionCosts,s},r.prototype.getCharacterIdx=function(n){return this._characterToIdx.get(n)},r.prototype.getInsertionCost=function(n){return this._insertionCosts[n]},r.prototype.getDeletionCost=function(n){return this._deletionCosts[n]},r.prototype.getSubstitutionCost=function(n,a){var s=Math.min(n,a),o=Math.max(n,a);return this._substitutionCosts[s][o]},r}();i.Alphabet=e;var t=function(){function r(n,a){var s=this;if(n.length>r._MAX_SEQUENCE_LENGTH)throw new Error("Sequences longer than "+r._MAX_SEQUENCE_LENGTH+" not supported.");this._alphabet=a,this._characters=n.map(function(o){return s._alphabet.getCharacterIdx(o)})}return r.prototype.serialize=function(){return JSON.stringify(this._characters)},r.Deserialize=function(n,a){var s=new r([],a);return s._characters=JSON.parse(n),s},r.prototype.distance=function(n){return r._Distance(this,n)},r._Distance=function(n,a){var s=n._alphabet;if(s!==a._alphabet)throw new Error("Cannot Levenshtein compare Sequences built from different alphabets.");var o=n._characters,l=a._characters,u=o.length,f=l.length,h=r._CostMatrix;h[0][0]=0;for(var c=0;c<u;++c)h[c+1][0]=h[c][0]+s.getInsertionCost(o[c]);for(var c=0;c<f;++c)h[0][c+1]=h[0][c]+s.getInsertionCost(l[c]);for(var d=0;d<u;++d)for(var p=0;p<f;++p)r._InsertionCost=h[d+1][p]+s.getInsertionCost(l[p]),r._DeletionCost=h[d][p+1]+s.getDeletionCost(o[d]),r._SubstitutionCost=h[d][p]+s.getSubstitutionCost(o[d],l[p]),h[d+1][p+1]=Math.min(r._InsertionCost,r._DeletionCost,r._SubstitutionCost);return h[u][f]},r._MAX_SEQUENCE_LENGTH=256,r._CostMatrix=ho([],Array(r._MAX_SEQUENCE_LENGTH+1),!0).map(function(){return new Array(r._MAX_SEQUENCE_LENGTH+1)}),r}();i.Sequence=t})(Ea||(Ea={}));(function(){function i(e){e===void 0&&(e=.01),this._points=[],this._segmentLength=e}return i.prototype.serialize=function(){return JSON.stringify(this)},i.Deserialize=function(e){var t=JSON.parse(e),r=new i(t._segmentLength);return r._points=t._points.map(function(n){return new m(n._x,n._y,n._z)}),r},i.prototype.getLength=function(){return this._points.length*this._segmentLength},i.prototype.add=function(e){var t=this,r=this._points.length;if(r===0)this._points.push(e.clone());else for(var n=function(){return t._segmentLength/m.Distance(t._points[r-1],e)},a=n();a<=1;a=n()){var s=this._points[r-1].scale(1-a);e.scaleAndAddToRef(a,s),this._points.push(s),++r}},i.prototype.resampleAtTargetResolution=function(e){var t=new i(this.getLength()/e);return this._points.forEach(function(r){t.add(r)}),t},i.prototype.tokenize=function(e){for(var t=[],r=new m,n=2;n<this._points.length;++n)i._TransformSegmentDirToRef(this._points[n-2],this._points[n-1],this._points[n],r)&&t.push(i._TokenizeSegment(r,e));return t},i._TransformSegmentDirToRef=function(e,t,r,n){var a=.98;return t.subtractToRef(e,i._ForwardDir),i._ForwardDir.normalize(),t.scaleToRef(-1,i._InverseFromVec),i._InverseFromVec.normalize(),Math.abs(m.Dot(i._ForwardDir,i._InverseFromVec))>a?!1:(m.CrossToRef(i._ForwardDir,i._InverseFromVec,i._UpDir),i._UpDir.normalize(),G.LookAtLHToRef(e,t,i._UpDir,i._LookMatrix),r.subtractToRef(t,i._FromToVec),i._FromToVec.normalize(),m.TransformNormalToRef(i._FromToVec,i._LookMatrix,n),!0)},i._TokenizeSegment=function(e,t){i._BestMatch=0,i._Score=m.Dot(e,t[0]),i._BestScore=i._Score;for(var r=1;r<t.length;++r)i._Score=m.Dot(e,t[r]),i._Score>i._BestScore&&(i._BestMatch=r,i._BestScore=i._Score);return i._BestMatch},i._ForwardDir=new m,i._InverseFromVec=new m,i._UpDir=new m,i._FromToVec=new m,i._LookMatrix=new G,i})();var ar;(function(i){i[i.INIT=0]="INIT",i[i.STARTED=1]="STARTED",i[i.ENDED=2]="ENDED"})(ar||(ar={}));function wp(i){var e,t=0,r=Date.now();i.observableParameters=(e=i.observableParameters)!==null&&e!==void 0?e:{};var n=i.contextObservable.add(function(a){var s=Date.now();t=s-r;var o={startTime:r,currentTime:s,deltaTime:t,completeRate:t/i.timeout,payload:a};i.onTick&&i.onTick(o),i.breakCondition&&i.breakCondition()&&(i.contextObservable.remove(n),i.onAborted&&i.onAborted(o)),t>=i.timeout&&(i.contextObservable.remove(n),i.onEnded&&i.onEnded(o))},i.observableParameters.mask,i.observableParameters.insertFirst,i.observableParameters.scope);return n}(function(){function i(e){var t=this,r,n;this.onEachCountObservable=new X,this.onTimerAbortedObservable=new X,this.onTimerEndedObservable=new X,this.onStateChangedObservable=new X,this._observer=null,this._breakOnNextTick=!1,this._tick=function(a){var s=Date.now();t._timer=s-t._startTime;var o={startTime:t._startTime,currentTime:s,deltaTime:t._timer,completeRate:t._timer/t._timeToEnd,payload:a},l=t._breakOnNextTick||t._breakCondition(o);l||t._timer>=t._timeToEnd?t._stop(o,l):t.onEachCountObservable.notifyObservers(o)},this._setState(ar.INIT),this._contextObservable=e.contextObservable,this._observableParameters=(r=e.observableParameters)!==null&&r!==void 0?r:{},this._breakCondition=(n=e.breakCondition)!==null&&n!==void 0?n:function(){return!1},this._timeToEnd=e.timeout,e.onEnded&&this.onTimerEndedObservable.add(e.onEnded),e.onTick&&this.onEachCountObservable.add(e.onTick),e.onAborted&&this.onTimerAbortedObservable.add(e.onAborted)}return Object.defineProperty(i.prototype,"breakCondition",{set:function(e){this._breakCondition=e},enumerable:!1,configurable:!0}),i.prototype.clearObservables=function(){this.onEachCountObservable.clear(),this.onTimerAbortedObservable.clear(),this.onTimerEndedObservable.clear(),this.onStateChangedObservable.clear()},i.prototype.start=function(e){if(e===void 0&&(e=this._timeToEnd),this._state===ar.STARTED)throw new Error("Timer already started. Please stop it before starting again");this._timeToEnd=e,this._startTime=Date.now(),this._timer=0,this._observer=this._contextObservable.add(this._tick,this._observableParameters.mask,this._observableParameters.insertFirst,this._observableParameters.scope),this._setState(ar.STARTED)},i.prototype.stop=function(){this._state===ar.STARTED&&(this._breakOnNextTick=!0)},i.prototype.dispose=function(){this._observer&&this._contextObservable.remove(this._observer),this.clearObservables()},i.prototype._setState=function(e){this._state=e,this.onStateChangedObservable.notifyObservers(this._state)},i.prototype._stop=function(e,t){t===void 0&&(t=!1),this._contextObservable.remove(this._observer),this._setState(ar.ENDED),t?this.onTimerAbortedObservable.notifyObservers(e):this.onTimerEndedObservable.notifyObservers(e)},i})();var $d=1.5,Ht=function(){function i(e){this._view=new Float32Array(e),this._itemLength=0}return Object.defineProperty(i.prototype,"itemLength",{get:function(){return this._itemLength},enumerable:!1,configurable:!0}),i.prototype.at=function(e){return e<0||e>=this._itemLength?NaN:this._view[e]},i.prototype.subarray=function(e,t){return e>=t||e<0?new Float32Array(0):(t>this._itemLength&&(t=this._itemLength),this._view.subarray(e,t))},i.prototype.push=function(e){this._view[this._itemLength]=e,this._itemLength++,this._itemLength>=this._view.length&&this._growArray()},i.prototype._growArray=function(){var e=Math.floor(this._view.length*$d),t=new Float32Array(e);t.set(this._view),this._view=t},i}(),Xt=1800,Jd=24,ep="0",Aa="timestamp",Sa="numPoints",tp=/\r/g,Ii="@",rp=function(){function i(e,t){var r=this;this._scene=e,this._collectDataAtFrame=function(){var n=nt.Now-r._startingTimestamp,a=r.datasets.ids.length,s=r.datasets.startingIndices.itemLength,o=0;if(s>0){var l=r.datasets.startingIndices.at(s-1);o=l+r.datasets.data.at(l+i.NumberOfPointsOffset)+i.SliceDataOffset}if(r.datasets.startingIndices.push(o),r.datasets.data.push(n),r.datasets.data.push(a),r.datasets.ids.forEach(function(h){var c=r._strategies.get(h);!c||r.datasets.data.push(c.getData())}),r.datasetObservable.hasObservers()){for(var u=[n,a],f=0;f<a;f++)u.push(r.datasets.data.at(o+i.SliceDataOffset+f));r.datasetObservable.notifyObservers(u)}},this.datasets={ids:[],data:new Ht(Xt),startingIndices:new Ht(Xt)},this._strategies=new Map,this._datasetMeta=new Map,this._eventRestoreSet=new Set,this._customEventObservable=new X,this.datasetObservable=new X,this.metadataObservable=new X(function(n){return n.callback(r._datasetMeta,new Da(0))}),t&&this.addCollectionStrategies.apply(this,t)}return Object.defineProperty(i,"SliceDataOffset",{get:function(){return 2},enumerable:!1,configurable:!0}),Object.defineProperty(i,"NumberOfPointsOffset",{get:function(){return 1},enumerable:!1,configurable:!0}),i.prototype.registerEvent=function(e,t,r){var n=this,a;if(!(this._strategies.has(e)&&!t)){this._strategies.has(e)&&t&&((a=this._strategies.get(e))===null||a===void 0||a.dispose(),this._strategies.delete(e));var s=function(l){var u=0,f=0,h=l.onAfterRenderObservable.add(function(){f=u,u=0}),c=n._customEventObservable.add(function(d){e===d.name&&(d.value!==void 0?u=d.value:u++)});return{id:e,getData:function(){return f},dispose:function(){l.onAfterRenderObservable.remove(h),n._customEventObservable.remove(c)}}},o={name:e};return this._eventRestoreSet.add(e),this.addCollectionStrategies({strategyCallback:s,category:r}),o}},i.prototype.sendEvent=function(e){this._customEventObservable.notifyObservers(e)},i.prototype._restoreStringEvents=function(){var e=this;this._eventRestoreSet.size!==this._customEventObservable.observers.length&&this._eventRestoreSet.forEach(function(t){e.registerEvent(t,!0)})},i.prototype.addCollectionStrategies=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];for(var r=0,n=e;r<n.length;r++){var a=n[r],s=a.strategyCallback,o=a.category,l=a.hidden,u=s(this._scene);if(this._strategies.has(u.id)){u.dispose();continue}this.datasets.ids.push(u.id),o&&(o=o.replace(new RegExp(Ii,"g"),"")),this._datasetMeta.set(u.id,{color:this._getHexColorFromId(u.id),category:o,hidden:l}),this._strategies.set(u.id,u)}this.metadataObservable.notifyObservers(this._datasetMeta)},i.prototype._getHexColorFromId=function(e){for(var t=0,r=0;r<e.length;r++)t=e.charCodeAt(r)+((t<<5)-t);for(var n="#",r=0;r<Jd;r+=8){var a=t>>r&255;n+=(ep+a.toString(16)).substr(-2)}return n},i.prototype.getCurrentSlice=function(){var e=this,t=nt.Now-this._startingTimestamp,r=this.datasets.ids.length,n=[t,r];this.datasets.ids.forEach(function(a){var s=e._strategies.get(a);!s||e.datasetObservable.hasObservers()&&n.push(s.getData())}),this.datasetObservable.hasObservers()&&this.datasetObservable.notifyObservers(n)},i.prototype.updateMetadata=function(e,t,r){var n=this._datasetMeta.get(e);!n||(n[t]=r,this.metadataObservable.notifyObservers(this._datasetMeta))},i.prototype.clear=function(e){this.datasets.data=new Ht(Xt),this.datasets.ids.length=0,this.datasets.startingIndices=new Ht(Xt),this._datasetMeta.clear(),this._strategies.forEach(function(t){return t.dispose()}),this._strategies.clear(),e||this._eventRestoreSet.clear(),this._hasLoadedData=!1},Object.defineProperty(i.prototype,"hasLoadedData",{get:function(){return this._hasLoadedData},enumerable:!1,configurable:!0}),i.prototype.loadFromFileData=function(e,t){var r=e.replace(tp,"").split(`
`).map(function(T){return T.split(",").filter(function(M){return M.length>0})}).filter(function(T){return T.length>0}),n=0,a=i.NumberOfPointsOffset;if(r.length<2)return!1;var s={ids:[],data:new Ht(Xt),startingIndices:new Ht(Xt)},o=r[0],l=r.slice(1);if(o.length<2||o[n]!==Aa||o[a]!==Sa)return!1;for(var u=new Map,f=i.SliceDataOffset;f<o.length;f++){var h=o[f].split(Ii),c=h[0],d=h[1];s.ids.push(c),u.set(c,d)}for(var p=0,_=0,g=l;_<g.length;_++){var v=g[_];if(v.length<2)return!1;var y=parseFloat(v[n]),b=parseInt(v[a]);if(isNaN(b)||isNaN(y)||(s.data.push(y),s.data.push(b),b+i.SliceDataOffset!==v.length))return!1;for(var f=i.SliceDataOffset;f<v.length;f++){var E=parseFloat(v[f]);if(isNaN(E))return!1;s.data.push(E)}s.startingIndices.push(p),p+=v.length}if(this.datasets.ids=s.ids,this.datasets.data=s.data,this.datasets.startingIndices=s.startingIndices,t||this._datasetMeta.clear(),this._strategies.forEach(function(T){return T.dispose()}),this._strategies.clear(),!t)for(var A=0,S=this.datasets.ids;A<S.length;A++){var c=S[A],d=u.get(c);this._datasetMeta.set(c,{category:d,color:this._getHexColorFromId(c)})}return this.metadataObservable.notifyObservers(this._datasetMeta),this._hasLoadedData=!0,!0},i.prototype.exportDataToCsv=function(){var e="";e+="".concat(Aa,",").concat(Sa);for(var t=0;t<this.datasets.ids.length;t++)if(e+=",".concat(this.datasets.ids[t]),this._datasetMeta){var r=this._datasetMeta.get(this.datasets.ids[t]);r!=null&&r.category&&(e+="".concat(Ii).concat(r.category))}e+=`
`;for(var t=0;t<this.datasets.startingIndices.itemLength;t++){var n=this.datasets.startingIndices.at(t),a=this.datasets.data.at(n),s=this.datasets.data.at(n+i.NumberOfPointsOffset);e+="".concat(a,",").concat(s);for(var o=0;o<s;o++)e+=",".concat(this.datasets.data.at(n+i.SliceDataOffset+o));for(var l=0;l<this.datasets.ids.length-s;l++)e+=",";e+=`
`}var u="".concat(new Date().toISOString(),"-perfdata.csv");te.Download(new Blob([e],{type:"text/csv"}),u)},i.prototype.start=function(e){e?this._startingTimestamp===void 0&&(this._startingTimestamp=nt.Now):(this.datasets.data=new Ht(Xt),this.datasets.startingIndices=new Ht(Xt),this._startingTimestamp=nt.Now),this._scene.onAfterRenderObservable.add(this._collectDataAtFrame),this._restoreStringEvents(),this._isStarted=!0},i.prototype.stop=function(){this._scene.onAfterRenderObservable.removeCallback(this._collectDataAtFrame),this._isStarted=!1},Object.defineProperty(i.prototype,"isStarted",{get:function(){return this._isStarted},enumerable:!1,configurable:!0}),i.prototype.dispose=function(){this._scene.onAfterRenderObservable.removeCallback(this._collectDataAtFrame),this._datasetMeta.clear(),this._strategies.forEach(function(e){e.dispose()}),this.datasetObservable.clear(),this.metadataObservable.clear(),this._isStarted=!1,this.datasets=null},i}();(function(){function i(e){this.engine=e,this._captureGPUFrameTime=!1,this._captureShaderCompilationTime=!1,this._shaderCompilationTime=new $e,this._onBeginFrameObserver=null,this._onEndFrameObserver=null,this._onBeforeShaderCompilationObserver=null,this._onAfterShaderCompilationObserver=null}return Object.defineProperty(i.prototype,"gpuFrameTimeCounter",{get:function(){return this.engine.getGPUFrameTimeCounter()},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"captureGPUFrameTime",{get:function(){return this._captureGPUFrameTime},set:function(e){e!==this._captureGPUFrameTime&&(this._captureGPUFrameTime=e,this.engine.captureGPUFrameTime(e))},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"shaderCompilationTimeCounter",{get:function(){return this._shaderCompilationTime},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"captureShaderCompilationTime",{get:function(){return this._captureShaderCompilationTime},set:function(e){var t=this;e!==this._captureShaderCompilationTime&&(this._captureShaderCompilationTime=e,e?(this._onBeforeShaderCompilationObserver=this.engine.onBeforeShaderCompilationObservable.add(function(){t._shaderCompilationTime.fetchNewFrame(),t._shaderCompilationTime.beginMonitoring()}),this._onAfterShaderCompilationObserver=this.engine.onAfterShaderCompilationObservable.add(function(){t._shaderCompilationTime.endMonitoring()})):(this.engine.onBeforeShaderCompilationObservable.remove(this._onBeforeShaderCompilationObserver),this._onBeforeShaderCompilationObserver=null,this.engine.onAfterShaderCompilationObservable.remove(this._onAfterShaderCompilationObserver),this._onAfterShaderCompilationObserver=null))},enumerable:!1,configurable:!0}),i.prototype.dispose=function(){this.engine.onBeginFrameObservable.remove(this._onBeginFrameObserver),this._onBeginFrameObserver=null,this.engine.onEndFrameObservable.remove(this._onEndFrameObserver),this._onEndFrameObserver=null,this.engine.onBeforeShaderCompilationObservable.remove(this._onBeforeShaderCompilationObserver),this._onBeforeShaderCompilationObserver=null,this.engine.onAfterShaderCompilationObservable.remove(this._onAfterShaderCompilationObserver),this._onAfterShaderCompilationObserver=null,this.engine=null},i})();(function(){function i(e){var t=this;this.scene=e,this._captureActiveMeshesEvaluationTime=!1,this._activeMeshesEvaluationTime=new $e,this._captureRenderTargetsRenderTime=!1,this._renderTargetsRenderTime=new $e,this._captureFrameTime=!1,this._frameTime=new $e,this._captureRenderTime=!1,this._renderTime=new $e,this._captureInterFrameTime=!1,this._interFrameTime=new $e,this._captureParticlesRenderTime=!1,this._particlesRenderTime=new $e,this._captureSpritesRenderTime=!1,this._spritesRenderTime=new $e,this._capturePhysicsTime=!1,this._physicsTime=new $e,this._captureAnimationsTime=!1,this._animationsTime=new $e,this._captureCameraRenderTime=!1,this._cameraRenderTime=new $e,this._onBeforeActiveMeshesEvaluationObserver=null,this._onAfterActiveMeshesEvaluationObserver=null,this._onBeforeRenderTargetsRenderObserver=null,this._onAfterRenderTargetsRenderObserver=null,this._onAfterRenderObserver=null,this._onBeforeDrawPhaseObserver=null,this._onAfterDrawPhaseObserver=null,this._onBeforeAnimationsObserver=null,this._onBeforeParticlesRenderingObserver=null,this._onAfterParticlesRenderingObserver=null,this._onBeforeSpritesRenderingObserver=null,this._onAfterSpritesRenderingObserver=null,this._onBeforePhysicsObserver=null,this._onAfterPhysicsObserver=null,this._onAfterAnimationsObserver=null,this._onBeforeCameraRenderObserver=null,this._onAfterCameraRenderObserver=null,this._onBeforeAnimationsObserver=e.onBeforeAnimationsObservable.add(function(){t._captureActiveMeshesEvaluationTime&&t._activeMeshesEvaluationTime.fetchNewFrame(),t._captureRenderTargetsRenderTime&&t._renderTargetsRenderTime.fetchNewFrame(),t._captureFrameTime&&(te.StartPerformanceCounter("Scene rendering"),t._frameTime.beginMonitoring()),t._captureInterFrameTime&&t._interFrameTime.endMonitoring(),t._captureParticlesRenderTime&&t._particlesRenderTime.fetchNewFrame(),t._captureSpritesRenderTime&&t._spritesRenderTime.fetchNewFrame(),t._captureAnimationsTime&&t._animationsTime.beginMonitoring(),t.scene.getEngine()._drawCalls.fetchNewFrame()}),this._onAfterRenderObserver=e.onAfterRenderObservable.add(function(){t._captureFrameTime&&(te.EndPerformanceCounter("Scene rendering"),t._frameTime.endMonitoring()),t._captureRenderTime&&t._renderTime.endMonitoring(!1),t._captureInterFrameTime&&t._interFrameTime.beginMonitoring()})}return Object.defineProperty(i.prototype,"activeMeshesEvaluationTimeCounter",{get:function(){return this._activeMeshesEvaluationTime},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"captureActiveMeshesEvaluationTime",{get:function(){return this._captureActiveMeshesEvaluationTime},set:function(e){var t=this;e!==this._captureActiveMeshesEvaluationTime&&(this._captureActiveMeshesEvaluationTime=e,e?(this._onBeforeActiveMeshesEvaluationObserver=this.scene.onBeforeActiveMeshesEvaluationObservable.add(function(){te.StartPerformanceCounter("Active meshes evaluation"),t._activeMeshesEvaluationTime.beginMonitoring()}),this._onAfterActiveMeshesEvaluationObserver=this.scene.onAfterActiveMeshesEvaluationObservable.add(function(){te.EndPerformanceCounter("Active meshes evaluation"),t._activeMeshesEvaluationTime.endMonitoring()})):(this.scene.onBeforeActiveMeshesEvaluationObservable.remove(this._onBeforeActiveMeshesEvaluationObserver),this._onBeforeActiveMeshesEvaluationObserver=null,this.scene.onAfterActiveMeshesEvaluationObservable.remove(this._onAfterActiveMeshesEvaluationObserver),this._onAfterActiveMeshesEvaluationObserver=null))},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"renderTargetsRenderTimeCounter",{get:function(){return this._renderTargetsRenderTime},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"captureRenderTargetsRenderTime",{get:function(){return this._captureRenderTargetsRenderTime},set:function(e){var t=this;e!==this._captureRenderTargetsRenderTime&&(this._captureRenderTargetsRenderTime=e,e?(this._onBeforeRenderTargetsRenderObserver=this.scene.onBeforeRenderTargetsRenderObservable.add(function(){te.StartPerformanceCounter("Render targets rendering"),t._renderTargetsRenderTime.beginMonitoring()}),this._onAfterRenderTargetsRenderObserver=this.scene.onAfterRenderTargetsRenderObservable.add(function(){te.EndPerformanceCounter("Render targets rendering"),t._renderTargetsRenderTime.endMonitoring(!1)})):(this.scene.onBeforeRenderTargetsRenderObservable.remove(this._onBeforeRenderTargetsRenderObserver),this._onBeforeRenderTargetsRenderObserver=null,this.scene.onAfterRenderTargetsRenderObservable.remove(this._onAfterRenderTargetsRenderObserver),this._onAfterRenderTargetsRenderObserver=null))},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"particlesRenderTimeCounter",{get:function(){return this._particlesRenderTime},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"captureParticlesRenderTime",{get:function(){return this._captureParticlesRenderTime},set:function(e){var t=this;e!==this._captureParticlesRenderTime&&(this._captureParticlesRenderTime=e,e?(this._onBeforeParticlesRenderingObserver=this.scene.onBeforeParticlesRenderingObservable.add(function(){te.StartPerformanceCounter("Particles"),t._particlesRenderTime.beginMonitoring()}),this._onAfterParticlesRenderingObserver=this.scene.onAfterParticlesRenderingObservable.add(function(){te.EndPerformanceCounter("Particles"),t._particlesRenderTime.endMonitoring(!1)})):(this.scene.onBeforeParticlesRenderingObservable.remove(this._onBeforeParticlesRenderingObserver),this._onBeforeParticlesRenderingObserver=null,this.scene.onAfterParticlesRenderingObservable.remove(this._onAfterParticlesRenderingObserver),this._onAfterParticlesRenderingObserver=null))},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"spritesRenderTimeCounter",{get:function(){return this._spritesRenderTime},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"captureSpritesRenderTime",{get:function(){return this._captureSpritesRenderTime},set:function(e){var t=this;e!==this._captureSpritesRenderTime&&(this._captureSpritesRenderTime=e,this.scene.spriteManagers&&(e?(this._onBeforeSpritesRenderingObserver=this.scene.onBeforeSpritesRenderingObservable.add(function(){te.StartPerformanceCounter("Sprites"),t._spritesRenderTime.beginMonitoring()}),this._onAfterSpritesRenderingObserver=this.scene.onAfterSpritesRenderingObservable.add(function(){te.EndPerformanceCounter("Sprites"),t._spritesRenderTime.endMonitoring(!1)})):(this.scene.onBeforeSpritesRenderingObservable.remove(this._onBeforeSpritesRenderingObserver),this._onBeforeSpritesRenderingObserver=null,this.scene.onAfterSpritesRenderingObservable.remove(this._onAfterSpritesRenderingObserver),this._onAfterSpritesRenderingObserver=null)))},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"physicsTimeCounter",{get:function(){return this._physicsTime},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"capturePhysicsTime",{get:function(){return this._capturePhysicsTime},set:function(e){var t=this;e!==this._capturePhysicsTime&&(!this.scene.onBeforePhysicsObservable||(this._capturePhysicsTime=e,e?(this._onBeforePhysicsObserver=this.scene.onBeforePhysicsObservable.add(function(){te.StartPerformanceCounter("Physics"),t._physicsTime.beginMonitoring()}),this._onAfterPhysicsObserver=this.scene.onAfterPhysicsObservable.add(function(){te.EndPerformanceCounter("Physics"),t._physicsTime.endMonitoring()})):(this.scene.onBeforePhysicsObservable.remove(this._onBeforePhysicsObserver),this._onBeforePhysicsObserver=null,this.scene.onAfterPhysicsObservable.remove(this._onAfterPhysicsObserver),this._onAfterPhysicsObserver=null)))},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"animationsTimeCounter",{get:function(){return this._animationsTime},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"captureAnimationsTime",{get:function(){return this._captureAnimationsTime},set:function(e){var t=this;e!==this._captureAnimationsTime&&(this._captureAnimationsTime=e,e?this._onAfterAnimationsObserver=this.scene.onAfterAnimationsObservable.add(function(){t._animationsTime.endMonitoring()}):(this.scene.onAfterAnimationsObservable.remove(this._onAfterAnimationsObserver),this._onAfterAnimationsObserver=null))},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"frameTimeCounter",{get:function(){return this._frameTime},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"captureFrameTime",{get:function(){return this._captureFrameTime},set:function(e){this._captureFrameTime=e},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"interFrameTimeCounter",{get:function(){return this._interFrameTime},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"captureInterFrameTime",{get:function(){return this._captureInterFrameTime},set:function(e){this._captureInterFrameTime=e},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"renderTimeCounter",{get:function(){return this._renderTime},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"captureRenderTime",{get:function(){return this._captureRenderTime},set:function(e){var t=this;e!==this._captureRenderTime&&(this._captureRenderTime=e,e?(this._onBeforeDrawPhaseObserver=this.scene.onBeforeDrawPhaseObservable.add(function(){t._renderTime.beginMonitoring(),te.StartPerformanceCounter("Main render")}),this._onAfterDrawPhaseObserver=this.scene.onAfterDrawPhaseObservable.add(function(){t._renderTime.endMonitoring(!1),te.EndPerformanceCounter("Main render")})):(this.scene.onBeforeDrawPhaseObservable.remove(this._onBeforeDrawPhaseObserver),this._onBeforeDrawPhaseObserver=null,this.scene.onAfterDrawPhaseObservable.remove(this._onAfterDrawPhaseObserver),this._onAfterDrawPhaseObserver=null))},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"cameraRenderTimeCounter",{get:function(){return this._cameraRenderTime},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"captureCameraRenderTime",{get:function(){return this._captureCameraRenderTime},set:function(e){var t=this;e!==this._captureCameraRenderTime&&(this._captureCameraRenderTime=e,e?(this._onBeforeCameraRenderObserver=this.scene.onBeforeCameraRenderObservable.add(function(r){t._cameraRenderTime.beginMonitoring(),te.StartPerformanceCounter("Rendering camera ".concat(r.name))}),this._onAfterCameraRenderObserver=this.scene.onAfterCameraRenderObservable.add(function(r){t._cameraRenderTime.endMonitoring(!1),te.EndPerformanceCounter("Rendering camera ".concat(r.name))})):(this.scene.onBeforeCameraRenderObservable.remove(this._onBeforeCameraRenderObserver),this._onBeforeCameraRenderObserver=null,this.scene.onAfterCameraRenderObservable.remove(this._onAfterCameraRenderObserver),this._onAfterCameraRenderObserver=null))},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"drawCallsCounter",{get:function(){return this.scene.getEngine()._drawCalls},enumerable:!1,configurable:!0}),i.prototype.dispose=function(){this.scene.onAfterRenderObservable.remove(this._onAfterRenderObserver),this._onAfterRenderObserver=null,this.scene.onBeforeActiveMeshesEvaluationObservable.remove(this._onBeforeActiveMeshesEvaluationObserver),this._onBeforeActiveMeshesEvaluationObserver=null,this.scene.onAfterActiveMeshesEvaluationObservable.remove(this._onAfterActiveMeshesEvaluationObserver),this._onAfterActiveMeshesEvaluationObserver=null,this.scene.onBeforeRenderTargetsRenderObservable.remove(this._onBeforeRenderTargetsRenderObserver),this._onBeforeRenderTargetsRenderObserver=null,this.scene.onAfterRenderTargetsRenderObservable.remove(this._onAfterRenderTargetsRenderObserver),this._onAfterRenderTargetsRenderObserver=null,this.scene.onBeforeAnimationsObservable.remove(this._onBeforeAnimationsObserver),this._onBeforeAnimationsObserver=null,this.scene.onBeforeParticlesRenderingObservable.remove(this._onBeforeParticlesRenderingObserver),this._onBeforeParticlesRenderingObserver=null,this.scene.onAfterParticlesRenderingObservable.remove(this._onAfterParticlesRenderingObserver),this._onAfterParticlesRenderingObserver=null,this._onBeforeSpritesRenderingObserver&&(this.scene.onBeforeSpritesRenderingObservable.remove(this._onBeforeSpritesRenderingObserver),this._onBeforeSpritesRenderingObserver=null),this._onAfterSpritesRenderingObserver&&(this.scene.onAfterSpritesRenderingObservable.remove(this._onAfterSpritesRenderingObserver),this._onAfterSpritesRenderingObserver=null),this.scene.onBeforeDrawPhaseObservable.remove(this._onBeforeDrawPhaseObserver),this._onBeforeDrawPhaseObserver=null,this.scene.onAfterDrawPhaseObservable.remove(this._onAfterDrawPhaseObserver),this._onAfterDrawPhaseObserver=null,this._onBeforePhysicsObserver&&(this.scene.onBeforePhysicsObservable.remove(this._onBeforePhysicsObserver),this._onBeforePhysicsObserver=null),this._onAfterPhysicsObserver&&(this.scene.onAfterPhysicsObservable.remove(this._onAfterPhysicsObserver),this._onAfterPhysicsObserver=null),this.scene.onAfterAnimationsObservable.remove(this._onAfterAnimationsObserver),this._onAfterAnimationsObserver=null,this.scene.onBeforeCameraRenderObservable.remove(this._onBeforeCameraRenderObserver),this._onBeforeCameraRenderObserver=null,this.scene.onAfterCameraRenderObservable.remove(this._onAfterCameraRenderObserver),this._onAfterCameraRenderObserver=null,this.scene=null},i})();Re.prototype.getPerfCollector=function(){return this._perfCollector||(this._perfCollector=new rp(this)),this._perfCollector};function ip(i){var e=new Array,t=new Array,r=new Array,n=i.add(function(){for(var s=e.length,o=0;o<s;o++)ti(e.shift(),t.shift(),r.shift())}),a=function(s,o,l){e.push(s),t.push(o),r.push(l)};return{scheduler:a,dispose:function(){i.remove(n)}}}X.prototype.runCoroutineAsync=function(i){if(!this._coroutineScheduler){var e=ip(this);this._coroutineScheduler=e.scheduler,this._coroutineSchedulerDispose=e.dispose}return ja(i,this._coroutineScheduler)};X.prototype.cancelAllCoroutines=function(){this._coroutineSchedulerDispose&&this._coroutineSchedulerDispose(),this._coroutineScheduler=void 0,this._coroutineSchedulerDispose=void 0};class np{constructor(e,t){ft(this,"engine");ft(this,"scene");ft(this,"onResizeHandle",this.onResize.bind(this));var r;this.canvas=e,this.window=t,this.engine=new De(e,!0,{},!0),this.scene=new Re(this.engine),this.scene.clearColor=ce.FromColor3(me.Black()),(r=this.window)==null||r.addEventListener("resize",this.onResizeHandle)}init(){const e=new pn("Camera",te.ToRadians(-75),te.ToRadians(85),3,new m(0,1,0),this.scene);e.wheelPrecision=25,e.attachControl(!0);const t=new _n("light1",new m(0,6,0),this.scene);t.intensity=.7,new gh(this.scene,1),this.engine.runRenderLoop(()=>{var r;(r=this.scene)==null||r.render()})}dispose(){var e;(e=this.window)==null||e.removeEventListener("resize",this.onResizeHandle)}onResize(){this.engine.resize(!0)}}var ao=function(i){$(e,i);function e(t,r,n,a,s,o,l){s===void 0&&(s=0),o===void 0&&(o=re.BILINEAR_SAMPLINGMODE),l===void 0&&(l=!0);var u=i.call(this,t,r,n,a,!0,s,!1,o,l)||this;if(u.mirrorPlane=new yr(0,1,0,1),u._transformMatrix=G.Zero(),u._mirrorMatrix=G.Zero(),u._adaptiveBlurKernel=0,u._blurKernelX=0,u._blurKernelY=0,u._blurRatio=1,n=u.getScene(),!n)return u;u.ignoreCameraViewport=!0,u._updateGammaSpace(),u._imageProcessingConfigChangeObserver=n.imageProcessingConfiguration.onUpdateParameters.add(function(){u._updateGammaSpace()});var f=n.getEngine();f.supportsUniformBuffers&&(u._sceneUBO=n.createSceneUniformBuffer('Scene for Mirror Texture (name "'.concat(t,'")'))),u.onBeforeBindObservable.add(function(){var c;(c=f._debugPushGroup)===null||c===void 0||c.call(f,"mirror generation for ".concat(t),1)}),u.onAfterUnbindObservable.add(function(){var c;(c=f._debugPopGroup)===null||c===void 0||c.call(f,1)});var h;return u.onBeforeRenderObservable.add(function(){u._sceneUBO&&(u._currentSceneUBO=n.getSceneUniformBuffer(),n.setSceneUniformBuffer(u._sceneUBO),n.getSceneUniformBuffer().unbindEffect()),G.ReflectionToRef(u.mirrorPlane,u._mirrorMatrix),u._mirrorMatrix.multiplyToRef(n.getViewMatrix(),u._transformMatrix),n.setTransformMatrix(u._transformMatrix,n.getProjectionMatrix()),h=n.clipPlane,n.clipPlane=u.mirrorPlane,n.getEngine().cullBackFaces=!1,n._mirroredCameraPosition=m.TransformCoordinates(n.activeCamera.globalPosition,u._mirrorMatrix)}),u.onAfterRenderObservable.add(function(){u._sceneUBO&&n.setSceneUniformBuffer(u._currentSceneUBO),n.updateTransformMatrix(),n.getEngine().cullBackFaces=null,n._mirroredCameraPosition=null,n.clipPlane=h}),u}return Object.defineProperty(e.prototype,"blurRatio",{get:function(){return this._blurRatio},set:function(t){this._blurRatio!==t&&(this._blurRatio=t,this._preparePostProcesses())},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"adaptiveBlurKernel",{set:function(t){this._adaptiveBlurKernel=t,this._autoComputeBlurKernel()},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"blurKernel",{set:function(t){this.blurKernelX=t,this.blurKernelY=t},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"blurKernelX",{get:function(){return this._blurKernelX},set:function(t){this._blurKernelX!==t&&(this._blurKernelX=t,this._preparePostProcesses())},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"blurKernelY",{get:function(){return this._blurKernelY},set:function(t){this._blurKernelY!==t&&(this._blurKernelY=t,this._preparePostProcesses())},enumerable:!1,configurable:!0}),e.prototype._autoComputeBlurKernel=function(){var t=this.getScene().getEngine(),r=this.getRenderWidth()/t.getRenderWidth(),n=this.getRenderHeight()/t.getRenderHeight();this.blurKernelX=this._adaptiveBlurKernel*r,this.blurKernelY=this._adaptiveBlurKernel*n},e.prototype._onRatioRescale=function(){this._sizeRatio&&(this.resize(this._initialSizeParameter),this._adaptiveBlurKernel||this._preparePostProcesses()),this._adaptiveBlurKernel&&this._autoComputeBlurKernel()},e.prototype._updateGammaSpace=function(){var t=this.getScene();!t||(this.gammaSpace=!t.imageProcessingConfiguration.isEnabled||!t.imageProcessingConfiguration.applyByPostProcess)},e.prototype._preparePostProcesses=function(){if(this.clearPostProcesses(!0),this._blurKernelX&&this._blurKernelY){var t=this.getScene().getEngine(),r=t.getCaps().textureFloatRender&&t.getCaps().textureFloatLinearFiltering?1:2;this._blurX=new Br("horizontal blur",new se(1,0),this._blurKernelX,this._blurRatio,null,re.BILINEAR_SAMPLINGMODE,t,!1,r),this._blurX.autoClear=!1,this._blurRatio===1&&this.samples<2&&this._texture?this._blurX.inputTexture=this._renderTarget:this._blurX.alwaysForcePOT=!0,this._blurY=new Br("vertical blur",new se(0,1),this._blurKernelY,this._blurRatio,null,re.BILINEAR_SAMPLINGMODE,t,!1,r),this._blurY.autoClear=!1,this._blurY.alwaysForcePOT=this._blurRatio!==1,this.addPostProcess(this._blurX),this.addPostProcess(this._blurY)}else this._blurY&&(this.removePostProcess(this._blurY),this._blurY.dispose(),this._blurY=null),this._blurX&&(this.removePostProcess(this._blurX),this._blurX.dispose(),this._blurX=null)},e.prototype.clone=function(){var t=this.getScene();if(!t)return this;var r=this.getSize(),n=new e(this.name,r.width,t,this._renderTargetOptions.generateMipMaps,this._renderTargetOptions.type,this._renderTargetOptions.samplingMode,this._renderTargetOptions.generateDepthBuffer);return n.hasAlpha=this.hasAlpha,n.level=this.level,n.mirrorPlane=this.mirrorPlane.clone(),this.renderList&&(n.renderList=this.renderList.slice(0)),n},e.prototype.serialize=function(){if(!this.name)return null;var t=i.prototype.serialize.call(this);return t.mirrorPlane=this.mirrorPlane.asArray(),t},e.prototype.dispose=function(){var t;i.prototype.dispose.call(this);var r=this.getScene();r&&r.imageProcessingConfiguration.onUpdateParameters.remove(this._imageProcessingConfigChangeObserver),(t=this._sceneUBO)===null||t===void 0||t.dispose()},e}(ur);re._CreateMirror=function(i,e,t,r){return new ao(i,e,t,r)};var ap="backgroundFragmentDeclaration",sp=`uniform vec4 vEyePosition;
uniform vec4 vPrimaryColor;
#ifdef USEHIGHLIGHTANDSHADOWCOLORS
uniform vec4 vPrimaryColorShadow;
#endif
uniform float shadowLevel;
uniform float alpha;
#ifdef DIFFUSE
uniform vec2 vDiffuseInfos;
#endif
#ifdef REFLECTION
uniform vec2 vReflectionInfos;
uniform mat4 reflectionMatrix;
uniform vec3 vReflectionMicrosurfaceInfos;
#endif
#if defined(REFLECTIONFRESNEL) || defined(OPACITYFRESNEL)
uniform vec3 vBackgroundCenter;
#endif
#ifdef REFLECTIONFRESNEL
uniform vec4 vReflectionControl;
#endif
#if defined(REFLECTIONMAP_SPHERICAL) || defined(REFLECTIONMAP_PROJECTION) || defined(REFRACTION)
uniform mat4 view;
#endif
`;q.IncludesShadersStore[ap]=sp;var op="backgroundUboDeclaration",lp=`layout(std140,column_major) uniform;
uniform Material
{
uniform vec4 vPrimaryColor;
uniform vec4 vPrimaryColorShadow;
uniform vec2 vDiffuseInfos;
uniform vec2 vReflectionInfos;
uniform mat4 diffuseMatrix;
uniform mat4 reflectionMatrix;
uniform vec3 vReflectionMicrosurfaceInfos;
uniform float fFovMultiplier;
uniform float pointSize;
uniform float shadowLevel;
uniform float alpha;
#if defined(REFLECTIONFRESNEL) || defined(OPACITYFRESNEL)
uniform vec3 vBackgroundCenter;
#endif
#ifdef REFLECTIONFRESNEL
uniform vec4 vReflectionControl;
#endif
};
#include<sceneUboDeclaration>
`;q.IncludesShadersStore[op]=lp;var up="backgroundPixelShader",fp=`#ifdef TEXTURELODSUPPORT
#extension GL_EXT_shader_texture_lod : enable
#endif
precision highp float;
#include<__decl__backgroundFragment>
#include<helperFunctions>
#define RECIPROCAL_PI2 0.15915494
varying vec3 vPositionW;
#ifdef MAINUV1
varying vec2 vMainUV1;
#endif 
#ifdef MAINUV2 
varying vec2 vMainUV2; 
#endif 
#ifdef NORMAL
varying vec3 vNormalW;
#endif
#ifdef DIFFUSE
#if DIFFUSEDIRECTUV==1
#define vDiffuseUV vMainUV1
#elif DIFFUSEDIRECTUV==2
#define vDiffuseUV vMainUV2
#else
varying vec2 vDiffuseUV;
#endif
uniform sampler2D diffuseSampler;
#endif
#ifdef REFLECTION
#ifdef REFLECTIONMAP_3D
#define sampleReflection(s,c) textureCube(s,c)
uniform samplerCube reflectionSampler;
#ifdef TEXTURELODSUPPORT
#define sampleReflectionLod(s,c,l) textureCubeLodEXT(s,c,l)
#else
uniform samplerCube reflectionSamplerLow;
uniform samplerCube reflectionSamplerHigh;
#endif
#else
#define sampleReflection(s,c) texture2D(s,c)
uniform sampler2D reflectionSampler;
#ifdef TEXTURELODSUPPORT
#define sampleReflectionLod(s,c,l) texture2DLodEXT(s,c,l)
#else
uniform samplerCube reflectionSamplerLow;
uniform samplerCube reflectionSamplerHigh;
#endif
#endif
#ifdef REFLECTIONMAP_SKYBOX
varying vec3 vPositionUVW;
#else
#if defined(REFLECTIONMAP_EQUIRECTANGULAR_FIXED) || defined(REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED)
varying vec3 vDirectionW;
#endif
#endif
#include<reflectionFunction>
#endif
#ifndef FROMLINEARSPACE
#define FROMLINEARSPACE;
#endif
#ifndef SHADOWONLY
#define SHADOWONLY;
#endif
#include<imageProcessingDeclaration>
#include<__decl__lightFragment>[0..maxSimultaneousLights]
#include<lightsFragmentFunctions>
#include<shadowsFragmentFunctions>
#include<imageProcessingFunctions>
#include<clipPlaneFragmentDeclaration>
#include<fogFragmentDeclaration>
#ifdef REFLECTIONFRESNEL
#define FRESNEL_MAXIMUM_ON_ROUGH 0.25
vec3 fresnelSchlickEnvironmentGGX(float VdotN,vec3 reflectance0,vec3 reflectance90,float smoothness)
{
float weight=mix(FRESNEL_MAXIMUM_ON_ROUGH,1.0,smoothness);
return reflectance0+weight*(reflectance90-reflectance0)*pow5(saturate(1.0-VdotN));
}
#endif
#define CUSTOM_FRAGMENT_DEFINITIONS
void main(void) {
#define CUSTOM_FRAGMENT_MAIN_BEGIN
#include<clipPlaneFragment>
vec3 viewDirectionW=normalize(vEyePosition.xyz-vPositionW);
#ifdef NORMAL
vec3 normalW=normalize(vNormalW);
#else
vec3 normalW=vec3(0.0,1.0,0.0);
#endif
float shadow=1.;
float globalShadow=0.;
float shadowLightCount=0.;
#include<lightFragment>[0..maxSimultaneousLights]
#ifdef SHADOWINUSE
globalShadow/=shadowLightCount;
#else
globalShadow=1.0;
#endif
#ifndef BACKMAT_SHADOWONLY
vec4 reflectionColor=vec4(1.,1.,1.,1.);
#ifdef REFLECTION
vec3 reflectionVector=computeReflectionCoords(vec4(vPositionW,1.0),normalW);
#ifdef REFLECTIONMAP_OPPOSITEZ
reflectionVector.z*=-1.0;
#endif
#ifdef REFLECTIONMAP_3D
vec3 reflectionCoords=reflectionVector;
#else
vec2 reflectionCoords=reflectionVector.xy;
#ifdef REFLECTIONMAP_PROJECTION
reflectionCoords/=reflectionVector.z;
#endif
reflectionCoords.y=1.0-reflectionCoords.y;
#endif
#ifdef REFLECTIONBLUR
float reflectionLOD=vReflectionInfos.y;
#ifdef TEXTURELODSUPPORT
reflectionLOD=reflectionLOD*log2(vReflectionMicrosurfaceInfos.x)*vReflectionMicrosurfaceInfos.y+vReflectionMicrosurfaceInfos.z;
reflectionColor=sampleReflectionLod(reflectionSampler,reflectionCoords,reflectionLOD);
#else
float lodReflectionNormalized=saturate(reflectionLOD);
float lodReflectionNormalizedDoubled=lodReflectionNormalized*2.0;
vec4 reflectionSpecularMid=sampleReflection(reflectionSampler,reflectionCoords);
if(lodReflectionNormalizedDoubled<1.0){
reflectionColor=mix(
sampleReflection(reflectionSamplerHigh,reflectionCoords),
reflectionSpecularMid,
lodReflectionNormalizedDoubled
);
} else {
reflectionColor=mix(
reflectionSpecularMid,
sampleReflection(reflectionSamplerLow,reflectionCoords),
lodReflectionNormalizedDoubled-1.0
);
}
#endif
#else
vec4 reflectionSample=sampleReflection(reflectionSampler,reflectionCoords);
reflectionColor=reflectionSample;
#endif
#ifdef RGBDREFLECTION
reflectionColor.rgb=fromRGBD(reflectionColor);
#endif
#ifdef GAMMAREFLECTION
reflectionColor.rgb=toLinearSpace(reflectionColor.rgb);
#endif
#ifdef REFLECTIONBGR
reflectionColor.rgb=reflectionColor.bgr;
#endif
reflectionColor.rgb*=vReflectionInfos.x;
#endif
vec3 diffuseColor=vec3(1.,1.,1.);
float finalAlpha=alpha;
#ifdef DIFFUSE
vec4 diffuseMap=texture2D(diffuseSampler,vDiffuseUV);
#ifdef GAMMADIFFUSE
diffuseMap.rgb=toLinearSpace(diffuseMap.rgb);
#endif
diffuseMap.rgb*=vDiffuseInfos.y;
#ifdef DIFFUSEHASALPHA
finalAlpha*=diffuseMap.a;
#endif
diffuseColor=diffuseMap.rgb;
#endif
#ifdef REFLECTIONFRESNEL
vec3 colorBase=diffuseColor;
#else
vec3 colorBase=reflectionColor.rgb*diffuseColor;
#endif
colorBase=max(colorBase,0.0);
#ifdef USERGBCOLOR
vec3 finalColor=colorBase;
#else
#ifdef USEHIGHLIGHTANDSHADOWCOLORS
vec3 mainColor=mix(vPrimaryColorShadow.rgb,vPrimaryColor.rgb,colorBase);
#else
vec3 mainColor=vPrimaryColor.rgb;
#endif
vec3 finalColor=colorBase*mainColor;
#endif
#ifdef REFLECTIONFRESNEL
vec3 reflectionAmount=vReflectionControl.xxx;
vec3 reflectionReflectance0=vReflectionControl.yyy;
vec3 reflectionReflectance90=vReflectionControl.zzz;
float VdotN=dot(normalize(vEyePosition.xyz),normalW);
vec3 planarReflectionFresnel=fresnelSchlickEnvironmentGGX(saturate(VdotN),reflectionReflectance0,reflectionReflectance90,1.0);
reflectionAmount*=planarReflectionFresnel;
#ifdef REFLECTIONFALLOFF
float reflectionDistanceFalloff=1.0-saturate(length(vPositionW.xyz-vBackgroundCenter)*vReflectionControl.w);
reflectionDistanceFalloff*=reflectionDistanceFalloff;
reflectionAmount*=reflectionDistanceFalloff;
#endif
finalColor=mix(finalColor,reflectionColor.rgb,saturate(reflectionAmount));
#endif
#ifdef OPACITYFRESNEL
float viewAngleToFloor=dot(normalW,normalize(vEyePosition.xyz-vBackgroundCenter));
const float startAngle=0.1;
float fadeFactor=saturate(viewAngleToFloor/startAngle);
finalAlpha*=fadeFactor*fadeFactor;
#endif
#ifdef SHADOWINUSE
finalColor=mix(finalColor*shadowLevel,finalColor,globalShadow);
#endif
vec4 color=vec4(finalColor,finalAlpha);
#else
vec4 color=vec4(vPrimaryColor.rgb,(1.0-clamp(globalShadow,0.,1.))*alpha);
#endif
#include<fogFragment>
#ifdef IMAGEPROCESSINGPOSTPROCESS
#if !defined(SKIPFINALCOLORCLAMP)
color.rgb=clamp(color.rgb,0.,30.0);
#endif
#else
color=applyImageProcessing(color);
#endif
#ifdef PREMULTIPLYALPHA
color.rgb*=color.a;
#endif
#ifdef NOISE
color.rgb+=dither(vPositionW.xy,0.5);
color=max(color,0.0);
#endif
gl_FragColor=color;
#define CUSTOM_FRAGMENT_MAIN_END
}
`;q.ShadersStore[up]=fp;var hp="backgroundVertexDeclaration",cp=`uniform mat4 view;
uniform mat4 viewProjection;
uniform float shadowLevel;
#ifdef DIFFUSE
uniform mat4 diffuseMatrix;
uniform vec2 vDiffuseInfos;
#endif
#ifdef REFLECTION
uniform vec2 vReflectionInfos;
uniform mat4 reflectionMatrix;
uniform vec3 vReflectionMicrosurfaceInfos;
uniform float fFovMultiplier;
#endif
#ifdef POINTSIZE
uniform float pointSize;
#endif
`;q.IncludesShadersStore[hp]=cp;var dp="backgroundVertexShader",pp=`precision highp float;
#include<__decl__backgroundVertex>
#include<helperFunctions>
attribute vec3 position;
#ifdef NORMAL
attribute vec3 normal;
#endif
#include<bonesDeclaration>
#include<bakedVertexAnimationDeclaration>
#include<instancesDeclaration>
varying vec3 vPositionW;
#ifdef NORMAL
varying vec3 vNormalW;
#endif
#ifdef UV1
attribute vec2 uv;
#endif
#ifdef UV2
attribute vec2 uv2;
#endif
#ifdef MAINUV1
varying vec2 vMainUV1;
#endif
#ifdef MAINUV2
varying vec2 vMainUV2;
#endif
#if defined(DIFFUSE) && DIFFUSEDIRECTUV==0
varying vec2 vDiffuseUV;
#endif
#include<clipPlaneVertexDeclaration>
#include<fogVertexDeclaration>
#include<__decl__lightVxFragment>[0..maxSimultaneousLights]
#ifdef REFLECTIONMAP_SKYBOX
varying vec3 vPositionUVW;
#endif
#if defined(REFLECTIONMAP_EQUIRECTANGULAR_FIXED) || defined(REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED)
varying vec3 vDirectionW;
#endif
#define CUSTOM_VERTEX_DEFINITIONS
void main(void) {
#define CUSTOM_VERTEX_MAIN_BEGIN
#ifdef REFLECTIONMAP_SKYBOX
vPositionUVW=position;
#endif
#include<instancesVertex>
#include<bonesVertex>
#include<bakedVertexAnimation>
#ifdef MULTIVIEW
if (gl_ViewID_OVR==0u) {
gl_Position=viewProjection*finalWorld*vec4(position,1.0);
} else {
gl_Position=viewProjectionR*finalWorld*vec4(position,1.0);
}
#else
gl_Position=viewProjection*finalWorld*vec4(position,1.0);
#endif
vec4 worldPos=finalWorld*vec4(position,1.0);
vPositionW=vec3(worldPos);
#ifdef NORMAL
mat3 normalWorld=mat3(finalWorld);
#ifdef NONUNIFORMSCALING
normalWorld=transposeMat3(inverseMat3(normalWorld));
#endif
vNormalW=normalize(normalWorld*normal);
#endif
#if defined(REFLECTIONMAP_EQUIRECTANGULAR_FIXED) || defined(REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED)
vDirectionW=normalize(vec3(finalWorld*vec4(position,0.0)));
#ifdef EQUIRECTANGULAR_RELFECTION_FOV
mat3 screenToWorld=inverseMat3(mat3(finalWorld*viewProjection));
vec3 segment=mix(vDirectionW,screenToWorld*vec3(0.0,0.0,1.0),abs(fFovMultiplier-1.0));
if (fFovMultiplier<=1.0) {
vDirectionW=normalize(segment);
} else {
vDirectionW=normalize(vDirectionW+(vDirectionW-segment));
}
#endif
#endif
#ifndef UV1
vec2 uv=vec2(0.,0.);
#endif
#ifndef UV2
vec2 uv2=vec2(0.,0.);
#endif
#ifdef MAINUV1
vMainUV1=uv;
#endif
#ifdef MAINUV2
vMainUV2=uv2;
#endif
#if defined(DIFFUSE) && DIFFUSEDIRECTUV==0
if (vDiffuseInfos.x==0.)
{
vDiffuseUV=vec2(diffuseMatrix*vec4(uv,1.0,0.0));
}
else
{
vDiffuseUV=vec2(diffuseMatrix*vec4(uv2,1.0,0.0));
}
#endif
#include<clipPlaneVertex>
#include<fogVertex>
#include<shadowsVertex>[0..maxSimultaneousLights]
#ifdef VERTEXCOLOR
vColor=color;
#endif
#if defined(POINTSIZE) && !defined(WEBGPU)
gl_PointSize=pointSize;
#endif
#define CUSTOM_VERTEX_MAIN_END
}
`;q.ShadersStore[dp]=pp;var _p=function(i){$(e,i);function e(){var t=i.call(this)||this;return t.DIFFUSE=!1,t.DIFFUSEDIRECTUV=0,t.GAMMADIFFUSE=!1,t.DIFFUSEHASALPHA=!1,t.OPACITYFRESNEL=!1,t.REFLECTIONBLUR=!1,t.REFLECTIONFRESNEL=!1,t.REFLECTIONFALLOFF=!1,t.TEXTURELODSUPPORT=!1,t.PREMULTIPLYALPHA=!1,t.USERGBCOLOR=!1,t.USEHIGHLIGHTANDSHADOWCOLORS=!1,t.BACKMAT_SHADOWONLY=!1,t.NOISE=!1,t.REFLECTIONBGR=!1,t.IMAGEPROCESSING=!1,t.VIGNETTE=!1,t.VIGNETTEBLENDMODEMULTIPLY=!1,t.VIGNETTEBLENDMODEOPAQUE=!1,t.TONEMAPPING=!1,t.TONEMAPPING_ACES=!1,t.CONTRAST=!1,t.COLORCURVES=!1,t.COLORGRADING=!1,t.COLORGRADING3D=!1,t.SAMPLER3DGREENDEPTH=!1,t.SAMPLER3DBGRMAP=!1,t.IMAGEPROCESSINGPOSTPROCESS=!1,t.SKIPFINALCOLORCLAMP=!1,t.EXPOSURE=!1,t.MULTIVIEW=!1,t.REFLECTION=!1,t.REFLECTIONMAP_3D=!1,t.REFLECTIONMAP_SPHERICAL=!1,t.REFLECTIONMAP_PLANAR=!1,t.REFLECTIONMAP_CUBIC=!1,t.REFLECTIONMAP_PROJECTION=!1,t.REFLECTIONMAP_SKYBOX=!1,t.REFLECTIONMAP_EXPLICIT=!1,t.REFLECTIONMAP_EQUIRECTANGULAR=!1,t.REFLECTIONMAP_EQUIRECTANGULAR_FIXED=!1,t.REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED=!1,t.INVERTCUBICMAP=!1,t.REFLECTIONMAP_OPPOSITEZ=!1,t.LODINREFLECTIONALPHA=!1,t.GAMMAREFLECTION=!1,t.RGBDREFLECTION=!1,t.EQUIRECTANGULAR_RELFECTION_FOV=!1,t.MAINUV1=!1,t.MAINUV2=!1,t.UV1=!1,t.UV2=!1,t.CLIPPLANE=!1,t.CLIPPLANE2=!1,t.CLIPPLANE3=!1,t.CLIPPLANE4=!1,t.CLIPPLANE5=!1,t.CLIPPLANE6=!1,t.POINTSIZE=!1,t.FOG=!1,t.NORMAL=!1,t.NUM_BONE_INFLUENCERS=0,t.BonesPerMesh=0,t.INSTANCES=!1,t.SHADOWFLOAT=!1,t.LOGARITHMICDEPTH=!1,t.NONUNIFORMSCALING=!1,t.ALPHATEST=!1,t.rebuild(),t}return e}(ai),Yi=function(i){$(e,i);function e(t,r){var n=i.call(this,t,r)||this;return n.primaryColor=me.White(),n._primaryColorShadowLevel=0,n._primaryColorHighlightLevel=0,n.reflectionTexture=null,n.reflectionBlur=0,n.diffuseTexture=null,n._shadowLights=null,n.shadowLights=null,n.shadowLevel=0,n.sceneCenter=m.Zero(),n.opacityFresnel=!0,n.reflectionFresnel=!1,n.reflectionFalloffDistance=0,n.reflectionAmount=1,n.reflectionReflectance0=.05,n.reflectionReflectance90=.5,n.useRGBColor=!0,n.enableNoise=!1,n._fovMultiplier=1,n.useEquirectangularFOV=!1,n._maxSimultaneousLights=4,n.maxSimultaneousLights=4,n._shadowOnly=!1,n.shadowOnly=!1,n._imageProcessingObserver=null,n.switchToBGR=!1,n._renderTargets=new Je(16),n._reflectionControls=Ke.Zero(),n._white=me.White(),n._primaryShadowColor=me.Black(),n._primaryHighlightColor=me.Black(),n._attachImageProcessingConfiguration(null),n.getRenderTargetTextures=function(){return n._renderTargets.reset(),n._diffuseTexture&&n._diffuseTexture.isRenderTarget&&n._renderTargets.push(n._diffuseTexture),n._reflectionTexture&&n._reflectionTexture.isRenderTarget&&n._renderTargets.push(n._reflectionTexture),n._renderTargets},n}return Object.defineProperty(e.prototype,"_perceptualColor",{get:function(){return this.__perceptualColor},set:function(t){this.__perceptualColor=t,this._computePrimaryColorFromPerceptualColor(),this._markAllSubMeshesAsLightsDirty()},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"primaryColorShadowLevel",{get:function(){return this._primaryColorShadowLevel},set:function(t){this._primaryColorShadowLevel=t,this._computePrimaryColors(),this._markAllSubMeshesAsLightsDirty()},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"primaryColorHighlightLevel",{get:function(){return this._primaryColorHighlightLevel},set:function(t){this._primaryColorHighlightLevel=t,this._computePrimaryColors(),this._markAllSubMeshesAsLightsDirty()},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"reflectionStandardFresnelWeight",{set:function(t){var r=t;r<.5?(r=r*2,this.reflectionReflectance0=e.StandardReflectance0*r,this.reflectionReflectance90=e.StandardReflectance90*r):(r=r*2-1,this.reflectionReflectance0=e.StandardReflectance0+(1-e.StandardReflectance0)*r,this.reflectionReflectance90=e.StandardReflectance90+(1-e.StandardReflectance90)*r)},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"fovMultiplier",{get:function(){return this._fovMultiplier},set:function(t){isNaN(t)&&(t=1),this._fovMultiplier=Math.max(0,Math.min(2,t))},enumerable:!1,configurable:!0}),e.prototype._attachImageProcessingConfiguration=function(t){var r=this;t!==this._imageProcessingConfiguration&&(this._imageProcessingConfiguration&&this._imageProcessingObserver&&this._imageProcessingConfiguration.onUpdateParameters.remove(this._imageProcessingObserver),t?this._imageProcessingConfiguration=t:this._imageProcessingConfiguration=this.getScene().imageProcessingConfiguration,this._imageProcessingConfiguration&&(this._imageProcessingObserver=this._imageProcessingConfiguration.onUpdateParameters.add(function(){r._computePrimaryColorFromPerceptualColor(),r._markAllSubMeshesAsImageProcessingDirty()})))},Object.defineProperty(e.prototype,"imageProcessingConfiguration",{get:function(){return this._imageProcessingConfiguration},set:function(t){this._attachImageProcessingConfiguration(t),this._markAllSubMeshesAsTexturesDirty()},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"cameraColorCurvesEnabled",{get:function(){return this.imageProcessingConfiguration.colorCurvesEnabled},set:function(t){this.imageProcessingConfiguration.colorCurvesEnabled=t},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"cameraColorGradingEnabled",{get:function(){return this.imageProcessingConfiguration.colorGradingEnabled},set:function(t){this.imageProcessingConfiguration.colorGradingEnabled=t},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"cameraToneMappingEnabled",{get:function(){return this._imageProcessingConfiguration.toneMappingEnabled},set:function(t){this._imageProcessingConfiguration.toneMappingEnabled=t},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"cameraExposure",{get:function(){return this._imageProcessingConfiguration.exposure},set:function(t){this._imageProcessingConfiguration.exposure=t},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"cameraContrast",{get:function(){return this._imageProcessingConfiguration.contrast},set:function(t){this._imageProcessingConfiguration.contrast=t},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"cameraColorGradingTexture",{get:function(){return this._imageProcessingConfiguration.colorGradingTexture},set:function(t){this.imageProcessingConfiguration.colorGradingTexture=t},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"cameraColorCurves",{get:function(){return this.imageProcessingConfiguration.colorCurves},set:function(t){this.imageProcessingConfiguration.colorCurves=t},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"hasRenderTargetTextures",{get:function(){return!!(this._diffuseTexture&&this._diffuseTexture.isRenderTarget||this._reflectionTexture&&this._reflectionTexture.isRenderTarget)},enumerable:!1,configurable:!0}),e.prototype.needAlphaTesting=function(){return!0},e.prototype.needAlphaBlending=function(){return this.alpha<1||this._diffuseTexture!=null&&this._diffuseTexture.hasAlpha||this._shadowOnly},e.prototype.isReadyForSubMesh=function(t,r,n){if(n===void 0&&(n=!1),r.effect&&this.isFrozen&&r.effect._wasPreviouslyReady)return!0;r.materialDefines||(r.materialDefines=new _p);var a=this.getScene(),s=r.materialDefines;if(this._isReadyForSubMesh(r))return!0;var o=a.getEngine();if(le.PrepareDefinesForLights(a,t,s,!1,this._maxSimultaneousLights),s._needNormals=!0,le.PrepareDefinesForMultiview(a,s),s._areTexturesDirty){if(s._needUVs=!1,a.texturesEnabled){if(a.getEngine().getCaps().textureLOD&&(s.TEXTURELODSUPPORT=!0),this._diffuseTexture&&Oe.DiffuseTextureEnabled){if(!this._diffuseTexture.isReadyOrNotBlocking())return!1;le.PrepareDefinesForMergedUV(this._diffuseTexture,s,"DIFFUSE"),s.DIFFUSEHASALPHA=this._diffuseTexture.hasAlpha,s.GAMMADIFFUSE=this._diffuseTexture.gammaSpace,s.OPACITYFRESNEL=this._opacityFresnel}else s.DIFFUSE=!1,s.DIFFUSEHASALPHA=!1,s.GAMMADIFFUSE=!1,s.OPACITYFRESNEL=!1;var l=this._reflectionTexture;if(l&&Oe.ReflectionTextureEnabled){if(!l.isReadyOrNotBlocking())return!1;switch(s.REFLECTION=!0,s.GAMMAREFLECTION=l.gammaSpace,s.RGBDREFLECTION=l.isRGBD,s.REFLECTIONBLUR=this._reflectionBlur>0,s.REFLECTIONMAP_OPPOSITEZ=this.getScene().useRightHandedSystem?!l.invertZ:l.invertZ,s.LODINREFLECTIONALPHA=l.lodLevelInAlpha,s.EQUIRECTANGULAR_RELFECTION_FOV=this.useEquirectangularFOV,s.REFLECTIONBGR=this.switchToBGR,l.coordinatesMode===re.INVCUBIC_MODE&&(s.INVERTCUBICMAP=!0),s.REFLECTIONMAP_3D=l.isCube,l.coordinatesMode){case re.EXPLICIT_MODE:s.REFLECTIONMAP_EXPLICIT=!0;break;case re.PLANAR_MODE:s.REFLECTIONMAP_PLANAR=!0;break;case re.PROJECTION_MODE:s.REFLECTIONMAP_PROJECTION=!0;break;case re.SKYBOX_MODE:s.REFLECTIONMAP_SKYBOX=!0;break;case re.SPHERICAL_MODE:s.REFLECTIONMAP_SPHERICAL=!0;break;case re.EQUIRECTANGULAR_MODE:s.REFLECTIONMAP_EQUIRECTANGULAR=!0;break;case re.FIXED_EQUIRECTANGULAR_MODE:s.REFLECTIONMAP_EQUIRECTANGULAR_FIXED=!0;break;case re.FIXED_EQUIRECTANGULAR_MIRRORED_MODE:s.REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED=!0;break;case re.CUBIC_MODE:case re.INVCUBIC_MODE:default:s.REFLECTIONMAP_CUBIC=!0;break}this.reflectionFresnel?(s.REFLECTIONFRESNEL=!0,s.REFLECTIONFALLOFF=this.reflectionFalloffDistance>0,this._reflectionControls.x=this.reflectionAmount,this._reflectionControls.y=this.reflectionReflectance0,this._reflectionControls.z=this.reflectionReflectance90,this._reflectionControls.w=1/this.reflectionFalloffDistance):(s.REFLECTIONFRESNEL=!1,s.REFLECTIONFALLOFF=!1)}else s.REFLECTION=!1,s.REFLECTIONFRESNEL=!1,s.REFLECTIONFALLOFF=!1,s.REFLECTIONBLUR=!1,s.REFLECTIONMAP_3D=!1,s.REFLECTIONMAP_SPHERICAL=!1,s.REFLECTIONMAP_PLANAR=!1,s.REFLECTIONMAP_CUBIC=!1,s.REFLECTIONMAP_PROJECTION=!1,s.REFLECTIONMAP_SKYBOX=!1,s.REFLECTIONMAP_EXPLICIT=!1,s.REFLECTIONMAP_EQUIRECTANGULAR=!1,s.REFLECTIONMAP_EQUIRECTANGULAR_FIXED=!1,s.REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED=!1,s.INVERTCUBICMAP=!1,s.REFLECTIONMAP_OPPOSITEZ=!1,s.LODINREFLECTIONALPHA=!1,s.GAMMAREFLECTION=!1,s.RGBDREFLECTION=!1}s.PREMULTIPLYALPHA=this.alphaMode===7||this.alphaMode===8,s.USERGBCOLOR=this._useRGBColor,s.NOISE=this._enableNoise}if(s._areLightsDirty&&(s.USEHIGHLIGHTANDSHADOWCOLORS=!this._useRGBColor&&(this._primaryColorShadowLevel!==0||this._primaryColorHighlightLevel!==0),s.BACKMAT_SHADOWONLY=this._shadowOnly),s._areImageProcessingDirty&&this._imageProcessingConfiguration){if(!this._imageProcessingConfiguration.isReady())return!1;this._imageProcessingConfiguration.prepareDefines(s)}if(le.PrepareDefinesForMisc(t,a,!1,this.pointsCloud,this.fogEnabled,this._shouldTurnAlphaTestOn(t),s),le.PrepareDefinesForFrameBoundValues(a,o,s,n,null,r.getRenderingMesh().hasThinInstances),le.PrepareDefinesForAttributes(t,s,!1,!0,!1)&&t&&!a.getEngine().getCaps().standardDerivatives&&!t.isVerticesDataPresent(R.NormalKind)&&(t.createNormals(!0),Y.Warn("BackgroundMaterial: Normals have been created for the mesh: "+t.name)),s.isDirty){s.markAsProcessed(),a.resetCachedMaterial();var u=new oi;s.FOG&&u.addFallback(0,"FOG"),s.POINTSIZE&&u.addFallback(1,"POINTSIZE"),s.MULTIVIEW&&u.addFallback(0,"MULTIVIEW"),le.HandleFallbacksForShadows(s,u,this._maxSimultaneousLights);var f=[R.PositionKind];s.NORMAL&&f.push(R.NormalKind),s.UV1&&f.push(R.UVKind),s.UV2&&f.push(R.UV2Kind),le.PrepareAttributesForBones(f,t,s,u),le.PrepareAttributesForInstances(f,s);var h=["world","view","viewProjection","vEyePosition","vLightsType","vFogInfos","vFogColor","pointSize","vClipPlane","vClipPlane2","vClipPlane3","vClipPlane4","vClipPlane5","vClipPlane6","mBones","vPrimaryColor","vPrimaryColorShadow","vReflectionInfos","reflectionMatrix","vReflectionMicrosurfaceInfos","fFovMultiplier","shadowLevel","alpha","vBackgroundCenter","vReflectionControl","vDiffuseInfos","diffuseMatrix"],c=["diffuseSampler","reflectionSampler","reflectionSamplerLow","reflectionSamplerHigh"],d=["Material","Scene"];Tt&&(Tt.PrepareUniforms(h,s),Tt.PrepareSamplers(c,s)),le.PrepareUniformsAndSamplersList({uniformsNames:h,uniformBuffersNames:d,samplers:c,defines:s,maxSimultaneousLights:this._maxSimultaneousLights});var p=s.toString(),_=a.getEngine().createEffect("background",{attributes:f,uniformsNames:h,uniformBuffersNames:d,samplers:c,defines:p,fallbacks:u,onCompiled:this.onCompiled,onError:this.onError,indexParameters:{maxSimultaneousLights:this._maxSimultaneousLights}},o);r.setEffect(_,s,this._materialContext),this.buildUniformLayout()}return!r.effect||!r.effect.isReady()?!1:(s._renderId=a.getRenderId(),r.effect._wasPreviouslyReady=!0,!0)},e.prototype._computePrimaryColorFromPerceptualColor=function(){!this.__perceptualColor||(this._primaryColor.copyFrom(this.__perceptualColor),this._primaryColor.toLinearSpaceToRef(this._primaryColor),this._imageProcessingConfiguration&&this._primaryColor.scaleToRef(1/this._imageProcessingConfiguration.exposure,this._primaryColor),this._computePrimaryColors())},e.prototype._computePrimaryColors=function(){this._primaryColorShadowLevel===0&&this._primaryColorHighlightLevel===0||(this._primaryColor.scaleToRef(this._primaryColorShadowLevel,this._primaryShadowColor),this._primaryColor.subtractToRef(this._primaryShadowColor,this._primaryShadowColor),this._white.subtractToRef(this._primaryColor,this._primaryHighlightColor),this._primaryHighlightColor.scaleToRef(this._primaryColorHighlightLevel,this._primaryHighlightColor),this._primaryColor.addToRef(this._primaryHighlightColor,this._primaryHighlightColor))},e.prototype.buildUniformLayout=function(){this._uniformBuffer.addUniform("vPrimaryColor",4),this._uniformBuffer.addUniform("vPrimaryColorShadow",4),this._uniformBuffer.addUniform("vDiffuseInfos",2),this._uniformBuffer.addUniform("vReflectionInfos",2),this._uniformBuffer.addUniform("diffuseMatrix",16),this._uniformBuffer.addUniform("reflectionMatrix",16),this._uniformBuffer.addUniform("vReflectionMicrosurfaceInfos",3),this._uniformBuffer.addUniform("fFovMultiplier",1),this._uniformBuffer.addUniform("pointSize",1),this._uniformBuffer.addUniform("shadowLevel",1),this._uniformBuffer.addUniform("alpha",1),this._uniformBuffer.addUniform("vBackgroundCenter",3),this._uniformBuffer.addUniform("vReflectionControl",4),this._uniformBuffer.create()},e.prototype.unbind=function(){this._diffuseTexture&&this._diffuseTexture.isRenderTarget&&this._uniformBuffer.setTexture("diffuseSampler",null),this._reflectionTexture&&this._reflectionTexture.isRenderTarget&&this._uniformBuffer.setTexture("reflectionSampler",null),i.prototype.unbind.call(this)},e.prototype.bindOnlyWorldMatrix=function(t){this._activeEffect.setMatrix("world",t)},e.prototype.bindForSubMesh=function(t,r,n){var a=this.getScene(),s=n.materialDefines;if(!!s){var o=n.effect;if(!!o){this._activeEffect=o,this.bindOnlyWorldMatrix(t),le.BindBonesParameters(r,this._activeEffect);var l=this._mustRebind(a,o,r.visibility);if(l){this._uniformBuffer.bindToEffect(o,"Material"),this.bindViewProjection(o);var u=this._reflectionTexture;(!this._uniformBuffer.useUbo||!this.isFrozen||!this._uniformBuffer.isSync)&&(a.texturesEnabled&&(this._diffuseTexture&&Oe.DiffuseTextureEnabled&&(this._uniformBuffer.updateFloat2("vDiffuseInfos",this._diffuseTexture.coordinatesIndex,this._diffuseTexture.level),le.BindTextureMatrix(this._diffuseTexture,this._uniformBuffer,"diffuse")),u&&Oe.ReflectionTextureEnabled&&(this._uniformBuffer.updateMatrix("reflectionMatrix",u.getReflectionTextureMatrix()),this._uniformBuffer.updateFloat2("vReflectionInfos",u.level,this._reflectionBlur),this._uniformBuffer.updateFloat3("vReflectionMicrosurfaceInfos",u.getSize().width,u.lodGenerationScale,u.lodGenerationOffset))),this.shadowLevel>0&&this._uniformBuffer.updateFloat("shadowLevel",this.shadowLevel),this._uniformBuffer.updateFloat("alpha",this.alpha),this.pointsCloud&&this._uniformBuffer.updateFloat("pointSize",this.pointSize),s.USEHIGHLIGHTANDSHADOWCOLORS?(this._uniformBuffer.updateColor4("vPrimaryColor",this._primaryHighlightColor,1),this._uniformBuffer.updateColor4("vPrimaryColorShadow",this._primaryShadowColor,1)):this._uniformBuffer.updateColor4("vPrimaryColor",this._primaryColor,1)),this._uniformBuffer.updateFloat("fFovMultiplier",this._fovMultiplier),a.texturesEnabled&&(this._diffuseTexture&&Oe.DiffuseTextureEnabled&&this._uniformBuffer.setTexture("diffuseSampler",this._diffuseTexture),u&&Oe.ReflectionTextureEnabled&&(s.REFLECTIONBLUR&&s.TEXTURELODSUPPORT?this._uniformBuffer.setTexture("reflectionSampler",u):s.REFLECTIONBLUR?(this._uniformBuffer.setTexture("reflectionSampler",u._lodTextureMid||u),this._uniformBuffer.setTexture("reflectionSamplerLow",u._lodTextureLow||u),this._uniformBuffer.setTexture("reflectionSamplerHigh",u._lodTextureHigh||u)):this._uniformBuffer.setTexture("reflectionSampler",u),s.REFLECTIONFRESNEL&&(this._uniformBuffer.updateFloat3("vBackgroundCenter",this.sceneCenter.x,this.sceneCenter.y,this.sceneCenter.z),this._uniformBuffer.updateFloat4("vReflectionControl",this._reflectionControls.x,this._reflectionControls.y,this._reflectionControls.z,this._reflectionControls.w)))),le.BindClipPlane(this._activeEffect,a),a.bindEyePosition(o)}else a.getEngine()._features.needToAlwaysBindUniformBuffers&&(this._uniformBuffer.bindToEffect(o,"Material"),this._needToBindSceneUbo=!0);(l||!this.isFrozen)&&(a.lightsEnabled&&le.BindLights(a,r,this._activeEffect,s,this._maxSimultaneousLights),this.bindView(o),le.BindFogParameters(a,r,this._activeEffect,!0),this._imageProcessingConfiguration&&this._imageProcessingConfiguration.bind(this._activeEffect)),this._afterBind(r,this._activeEffect),this._uniformBuffer.update()}}},e.prototype.hasTexture=function(t){return!!(i.prototype.hasTexture.call(this,t)||this._reflectionTexture===t||this._diffuseTexture===t)},e.prototype.dispose=function(t,r){t===void 0&&(t=!1),r===void 0&&(r=!1),r&&(this.diffuseTexture&&this.diffuseTexture.dispose(),this.reflectionTexture&&this.reflectionTexture.dispose()),this._renderTargets.dispose(),this._imageProcessingConfiguration&&this._imageProcessingObserver&&this._imageProcessingConfiguration.onUpdateParameters.remove(this._imageProcessingObserver),i.prototype.dispose.call(this,t)},e.prototype.clone=function(t){var r=this;return pe.Clone(function(){return new e(t,r.getScene())},this)},e.prototype.serialize=function(){var t=pe.Serialize(this);return t.customType="BABYLON.BackgroundMaterial",t},e.prototype.getClassName=function(){return"BackgroundMaterial"},e.Parse=function(t,r,n){return pe.Parse(function(){return new e(t.name,r)},t,r,n)},e.StandardReflectance0=.05,e.StandardReflectance90=.5,C([wt()],e.prototype,"_primaryColor",void 0),C([ve("_markAllSubMeshesAsLightsDirty")],e.prototype,"primaryColor",void 0),C([wt()],e.prototype,"__perceptualColor",void 0),C([I()],e.prototype,"_primaryColorShadowLevel",void 0),C([I()],e.prototype,"_primaryColorHighlightLevel",void 0),C([ve("_markAllSubMeshesAsLightsDirty")],e.prototype,"primaryColorHighlightLevel",null),C([ot()],e.prototype,"_reflectionTexture",void 0),C([ve("_markAllSubMeshesAsTexturesDirty")],e.prototype,"reflectionTexture",void 0),C([I()],e.prototype,"_reflectionBlur",void 0),C([ve("_markAllSubMeshesAsTexturesDirty")],e.prototype,"reflectionBlur",void 0),C([ot()],e.prototype,"_diffuseTexture",void 0),C([ve("_markAllSubMeshesAsTexturesDirty")],e.prototype,"diffuseTexture",void 0),C([ve("_markAllSubMeshesAsTexturesDirty")],e.prototype,"shadowLights",void 0),C([I()],e.prototype,"_shadowLevel",void 0),C([ve("_markAllSubMeshesAsTexturesDirty")],e.prototype,"shadowLevel",void 0),C([xt()],e.prototype,"_sceneCenter",void 0),C([ve("_markAllSubMeshesAsTexturesDirty")],e.prototype,"sceneCenter",void 0),C([I()],e.prototype,"_opacityFresnel",void 0),C([ve("_markAllSubMeshesAsTexturesDirty")],e.prototype,"opacityFresnel",void 0),C([I()],e.prototype,"_reflectionFresnel",void 0),C([ve("_markAllSubMeshesAsTexturesDirty")],e.prototype,"reflectionFresnel",void 0),C([I()],e.prototype,"_reflectionFalloffDistance",void 0),C([ve("_markAllSubMeshesAsTexturesDirty")],e.prototype,"reflectionFalloffDistance",void 0),C([I()],e.prototype,"_reflectionAmount",void 0),C([ve("_markAllSubMeshesAsTexturesDirty")],e.prototype,"reflectionAmount",void 0),C([I()],e.prototype,"_reflectionReflectance0",void 0),C([ve("_markAllSubMeshesAsTexturesDirty")],e.prototype,"reflectionReflectance0",void 0),C([I()],e.prototype,"_reflectionReflectance90",void 0),C([ve("_markAllSubMeshesAsTexturesDirty")],e.prototype,"reflectionReflectance90",void 0),C([I()],e.prototype,"_useRGBColor",void 0),C([ve("_markAllSubMeshesAsTexturesDirty")],e.prototype,"useRGBColor",void 0),C([I()],e.prototype,"_enableNoise",void 0),C([ve("_markAllSubMeshesAsTexturesDirty")],e.prototype,"enableNoise",void 0),C([I()],e.prototype,"_maxSimultaneousLights",void 0),C([ve("_markAllSubMeshesAsTexturesDirty")],e.prototype,"maxSimultaneousLights",void 0),C([I()],e.prototype,"_shadowOnly",void 0),C([ve("_markAllSubMeshesAsLightsDirty")],e.prototype,"shadowOnly",void 0),C([go()],e.prototype,"_imageProcessingConfiguration",void 0),e}(an);We("BABYLON.BackgroundMaterial",Yi);var vp=function(){function i(e,t){var r=this;this._errorHandler=function(n,a){r.onErrorObservable.notifyObservers({message:n,exception:a})},this._options=Ue(Ue({},i._GetDefaultOptions()),e),this._scene=t,this.onErrorObservable=new X,this._setupBackground(),this._setupImageProcessing()}return i._GetDefaultOptions=function(){return{createGround:!0,groundSize:15,groundTexture:this._GroundTextureCDNUrl,groundColor:new me(.2,.2,.3).toLinearSpace().scale(3),groundOpacity:.9,enableGroundShadow:!0,groundShadowLevel:.5,enableGroundMirror:!1,groundMirrorSizeRatio:.3,groundMirrorBlurKernel:64,groundMirrorAmount:1,groundMirrorFresnelWeight:1,groundMirrorFallOffDistance:0,groundMirrorTextureType:0,groundYBias:1e-5,createSkybox:!0,skyboxSize:20,skyboxTexture:this._SkyboxTextureCDNUrl,skyboxColor:new me(.2,.2,.3).toLinearSpace().scale(3),backgroundYRotation:0,sizeAuto:!0,rootPosition:m.Zero(),setupImageProcessing:!0,environmentTexture:this._EnvironmentTextureCDNUrl,cameraExposure:.8,cameraContrast:1.2,toneMappingEnabled:!0}},Object.defineProperty(i.prototype,"rootMesh",{get:function(){return this._rootMesh},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"skybox",{get:function(){return this._skybox},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"skyboxTexture",{get:function(){return this._skyboxTexture},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"skyboxMaterial",{get:function(){return this._skyboxMaterial},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"ground",{get:function(){return this._ground},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"groundTexture",{get:function(){return this._groundTexture},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"groundMirror",{get:function(){return this._groundMirror},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"groundMirrorRenderList",{get:function(){return this._groundMirror?this._groundMirror.renderList:null},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"groundMaterial",{get:function(){return this._groundMaterial},enumerable:!1,configurable:!0}),i.prototype.updateOptions=function(e){var t=Ue(Ue({},this._options),e);this._ground&&!t.createGround&&(this._ground.dispose(),this._ground=null),this._groundMaterial&&!t.createGround&&(this._groundMaterial.dispose(),this._groundMaterial=null),this._groundTexture&&this._options.groundTexture!=t.groundTexture&&(this._groundTexture.dispose(),this._groundTexture=null),this._skybox&&!t.createSkybox&&(this._skybox.dispose(),this._skybox=null),this._skyboxMaterial&&!t.createSkybox&&(this._skyboxMaterial.dispose(),this._skyboxMaterial=null),this._skyboxTexture&&this._options.skyboxTexture!=t.skyboxTexture&&(this._skyboxTexture.dispose(),this._skyboxTexture=null),this._groundMirror&&!t.enableGroundMirror&&(this._groundMirror.dispose(),this._groundMirror=null),this._scene.environmentTexture&&this._options.environmentTexture!=t.environmentTexture&&this._scene.environmentTexture.dispose(),this._options=t,this._setupBackground(),this._setupImageProcessing()},i.prototype.setMainColor=function(e){this.groundMaterial&&(this.groundMaterial.primaryColor=e),this.skyboxMaterial&&(this.skyboxMaterial.primaryColor=e),this.groundMirror&&(this.groundMirror.clearColor=new ce(e.r,e.g,e.b,1))},i.prototype._setupImageProcessing=function(){this._options.setupImageProcessing&&(this._scene.imageProcessingConfiguration.contrast=this._options.cameraContrast,this._scene.imageProcessingConfiguration.exposure=this._options.cameraExposure,this._scene.imageProcessingConfiguration.toneMappingEnabled=this._options.toneMappingEnabled,this._setupEnvironmentTexture())},i.prototype._setupEnvironmentTexture=function(){if(!this._scene.environmentTexture){if(this._options.environmentTexture instanceof bt){this._scene.environmentTexture=this._options.environmentTexture;return}var e=Lr.CreateFromPrefilteredData(this._options.environmentTexture,this._scene);this._scene.environmentTexture=e}},i.prototype._setupBackground=function(){this._rootMesh||(this._rootMesh=new O("BackgroundHelper",this._scene)),this._rootMesh.rotation.y=this._options.backgroundYRotation;var e=this._getSceneSize();this._options.createGround&&(this._setupGround(e),this._setupGroundMaterial(),this._setupGroundDiffuseTexture(),this._options.enableGroundMirror&&this._setupGroundMirrorTexture(e),this._setupMirrorInGroundMaterial()),this._options.createSkybox&&(this._setupSkybox(e),this._setupSkyboxMaterial(),this._setupSkyboxReflectionTexture()),this._rootMesh.position.x=e.rootPosition.x,this._rootMesh.position.z=e.rootPosition.z,this._rootMesh.position.y=e.rootPosition.y},i.prototype._getSceneSize=function(){var e=this,t=this._options.groundSize,r=this._options.skyboxSize,n=this._options.rootPosition;if(!this._scene.meshes||this._scene.meshes.length===1)return{groundSize:t,skyboxSize:r,rootPosition:n};var a=this._scene.getWorldExtends(function(l){return l!==e._ground&&l!==e._rootMesh&&l!==e._skybox}),s=a.max.subtract(a.min);if(this._options.sizeAuto){this._scene.activeCamera instanceof pn&&this._scene.activeCamera.upperRadiusLimit&&(t=this._scene.activeCamera.upperRadiusLimit*2,r=t);var o=s.length();o>t&&(t=o*2,r=t),t*=1.1,r*=1.5,n=a.min.add(s.scale(.5)),n.y=a.min.y-this._options.groundYBias}return{groundSize:t,skyboxSize:r,rootPosition:n}},i.prototype._setupGround=function(e){var t=this;(!this._ground||this._ground.isDisposed())&&(this._ground=li("BackgroundPlane",{size:e.groundSize},this._scene),this._ground.rotation.x=Math.PI/2,this._ground.parent=this._rootMesh,this._ground.onDisposeObservable.add(function(){t._ground=null})),this._ground.receiveShadows=this._options.enableGroundShadow},i.prototype._setupGroundMaterial=function(){this._groundMaterial||(this._groundMaterial=new Yi("BackgroundPlaneMaterial",this._scene)),this._groundMaterial.alpha=this._options.groundOpacity,this._groundMaterial.alphaMode=8,this._groundMaterial.shadowLevel=this._options.groundShadowLevel,this._groundMaterial.primaryColor=this._options.groundColor,this._groundMaterial.useRGBColor=!1,this._groundMaterial.enableNoise=!0,this._ground&&(this._ground.material=this._groundMaterial)},i.prototype._setupGroundDiffuseTexture=function(){if(!!this._groundMaterial&&!this._groundTexture){if(this._options.groundTexture instanceof bt){this._groundMaterial.diffuseTexture=this._options.groundTexture;return}this._groundTexture=new re(this._options.groundTexture,this._scene,void 0,void 0,void 0,void 0,this._errorHandler),this._groundTexture.gammaSpace=!1,this._groundTexture.hasAlpha=!0,this._groundMaterial.diffuseTexture=this._groundTexture}},i.prototype._setupGroundMirrorTexture=function(e){var t=re.CLAMP_ADDRESSMODE;if(!this._groundMirror&&(this._groundMirror=new ao("BackgroundPlaneMirrorTexture",{ratio:this._options.groundMirrorSizeRatio},this._scene,!1,this._options.groundMirrorTextureType,re.BILINEAR_SAMPLINGMODE,!0),this._groundMirror.mirrorPlane=new yr(0,-1,0,e.rootPosition.y),this._groundMirror.anisotropicFilteringLevel=1,this._groundMirror.wrapU=t,this._groundMirror.wrapV=t,this._groundMirror.renderList))for(var r=0;r<this._scene.meshes.length;r++){var n=this._scene.meshes[r];n!==this._ground&&n!==this._skybox&&n!==this._rootMesh&&this._groundMirror.renderList.push(n)}var a=this._options.groundColor.toGammaSpace();this._groundMirror.clearColor=new ce(a.r,a.g,a.b,1),this._groundMirror.adaptiveBlurKernel=this._options.groundMirrorBlurKernel},i.prototype._setupMirrorInGroundMaterial=function(){this._groundMaterial&&(this._groundMaterial.reflectionTexture=this._groundMirror,this._groundMaterial.reflectionFresnel=!0,this._groundMaterial.reflectionAmount=this._options.groundMirrorAmount,this._groundMaterial.reflectionStandardFresnelWeight=this._options.groundMirrorFresnelWeight,this._groundMaterial.reflectionFalloffDistance=this._options.groundMirrorFallOffDistance)},i.prototype._setupSkybox=function(e){var t=this;(!this._skybox||this._skybox.isDisposed())&&(this._skybox=un("BackgroundSkybox",{size:e.skyboxSize,sideOrientation:O.BACKSIDE},this._scene),this._skybox.onDisposeObservable.add(function(){t._skybox=null})),this._skybox.parent=this._rootMesh},i.prototype._setupSkyboxMaterial=function(){!this._skybox||(this._skyboxMaterial||(this._skyboxMaterial=new Yi("BackgroundSkyboxMaterial",this._scene)),this._skyboxMaterial.useRGBColor=!1,this._skyboxMaterial.primaryColor=this._options.skyboxColor,this._skyboxMaterial.enableNoise=!0,this._skybox.material=this._skyboxMaterial)},i.prototype._setupSkyboxReflectionTexture=function(){if(!!this._skyboxMaterial&&!this._skyboxTexture){if(this._options.skyboxTexture instanceof bt){this._skyboxMaterial.reflectionTexture=this._options.skyboxTexture;return}this._skyboxTexture=new Lr(this._options.skyboxTexture,this._scene,void 0,void 0,void 0,void 0,this._errorHandler),this._skyboxTexture.coordinatesMode=re.SKYBOX_MODE,this._skyboxTexture.gammaSpace=!1,this._skyboxMaterial.reflectionTexture=this._skyboxTexture}},i.prototype.dispose=function(){this._groundMaterial&&this._groundMaterial.dispose(!0,!0),this._skyboxMaterial&&this._skyboxMaterial.dispose(!0,!0),this._rootMesh.dispose(!1)},i._GroundTextureCDNUrl="https://assets.babylonjs.com/environments/backgroundGround.png",i._SkyboxTextureCDNUrl="https://assets.babylonjs.com/environments/backgroundSkybox.dds",i._EnvironmentTextureCDNUrl="https://assets.babylonjs.com/environments/environmentSpecular.env",i}(),gp=function(){function i(){this.supportCascades=!0}return i.prototype.canLoad=function(e){return Ut(e,".dds")},i.prototype.loadCubeData=function(e,t,r,n){var a=t.getEngine(),s,o=!1,l=1e3;if(Array.isArray(e))for(var u=0;u<e.length;u++){var f=e[u];s=ir.GetDDSInfo(f),t.width=s.width,t.height=s.height,o=(s.isRGB||s.isLuminance||s.mipmapCount>1)&&t.generateMipMaps,a._unpackFlipY(s.isCompressed),ir.UploadDDSLevels(a,t,f,s,o,6,-1,u),!s.isFourCC&&s.mipmapCount===1?a.generateMipMapsForCubemap(t):l=s.mipmapCount-1}else{var f=e;s=ir.GetDDSInfo(f),t.width=s.width,t.height=s.height,r&&(s.sphericalPolynomial=new ui),o=(s.isRGB||s.isLuminance||s.mipmapCount>1)&&t.generateMipMaps,a._unpackFlipY(s.isCompressed),ir.UploadDDSLevels(a,t,f,s,o,6),!s.isFourCC&&s.mipmapCount===1?a.generateMipMapsForCubemap(t,!1):l=s.mipmapCount-1}a._setCubeMapTextureParams(t,o,l),t.isReady=!0,t.onLoadedObservable.notifyObservers(t),t.onLoadedObservable.clear(),n&&n({isDDS:!0,width:t.width,info:s,data:e,texture:t})},i.prototype.loadData=function(e,t,r){var n=ir.GetDDSInfo(e),a=(n.isRGB||n.isLuminance||n.mipmapCount>1)&&t.generateMipMaps&&n.width>>n.mipmapCount-1===1;r(n.width,n.height,a,n.isFourCC,function(){ir.UploadDDSLevels(t.getEngine(),t,e,n,a,1)})},i}();De._TextureLoaders.push(new gp);var mp=function(){function i(){this.supportCascades=!1}return i.prototype.canLoad=function(e){return Ut(e,".env")},i.prototype.loadCubeData=function(e,t,r,n,a){if(!Array.isArray(e)){var s=uc(e);if(s){t.width=s.width,t.height=s.width;try{cc(t,s),hc(t,e,s).then(function(){t.isReady=!0,t.onLoadedObservable.notifyObservers(t),t.onLoadedObservable.clear(),n&&n()},function(o){a==null||a("Can not upload environment levels",o)})}catch(o){a==null||a("Can not upload environment file",o)}}else a&&a("Can not parse the environment file",null)}},i.prototype.loadData=function(){throw".env not supported in 2d."},i}();De._TextureLoaders.push(new mp);var yp=function(){function i(){this.supportCascades=!1}return i.prototype.canLoad=function(e,t){return Ut(e,".ktx")||Ut(e,".ktx2")||t==="image/ktx"||t==="image/ktx2"},i.prototype.loadCubeData=function(e,t,r,n){if(!Array.isArray(e)){t._invertVScale=!t.invertY;var a=t.getEngine(),s=new Ri(e,6),o=s.numberOfMipmapLevels>1&&t.generateMipMaps;a._unpackFlipY(!0),s.uploadLevels(t,t.generateMipMaps),t.width=s.pixelWidth,t.height=s.pixelHeight,a._setCubeMapTextureParams(t,o,s.numberOfMipmapLevels-1),t.isReady=!0,t.onLoadedObservable.notifyObservers(t),t.onLoadedObservable.clear(),n&&n()}},i.prototype.loadData=function(e,t,r,n){if(Ri.IsValid(e)){t._invertVScale=!t.invertY;var a=new Ri(e,1);r(a.pixelWidth,a.pixelHeight,t.generateMipMaps,!0,function(){a.uploadLevels(t,t.generateMipMaps)},a.isInvalid)}else if(Ta.IsValid(e)){var s=new Ta(t.getEngine());s.uploadAsync(e,t,n).then(function(){r(t.width,t.height,t.generateMipMaps,!0,function(){},!1)},function(o){Y.Warn("Failed to load KTX2 texture data: ".concat(o.message)),r(0,0,!1,!1,function(){},!0)})}else Y.Error("texture missing KTX identifier"),r(0,0,!1,!1,function(){},!0)},i}();De._TextureLoaders.unshift(new yp);var bp=function(){function i(){this.supportCascades=!1}return i.prototype.canLoad=function(e){return Ut(e,".tga")},i.prototype.loadCubeData=function(){throw".env not supported in Cube."},i.prototype.loadData=function(e,t,r){var n=new Uint8Array(e.buffer,e.byteOffset,e.byteLength),a=mn(n);r(a.width,a.height,t.generateMipMaps,!1,function(){qs(t,n)})},i}();De._TextureLoaders.push(new bp);var Tp=function(){function i(){this.supportCascades=!1}return i.prototype.canLoad=function(e){return Ut(e,".hdr")},i.prototype.loadCubeData=function(){throw".env not supported in Cube."},i.prototype.loadData=function(e,t,r){for(var n=new Uint8Array(e.buffer,e.byteOffset,e.byteLength),a=Wi.RGBE_ReadHeader(n),s=Wi.RGBE_ReadPixels(n,a),o=a.width*a.height,l=new Float32Array(o*4),u=0;u<o;u+=1)l[u*4]=s[u*3],l[u*4+1]=s[u*3+1],l[u*4+2]=s[u*3+2],l[u*4+3]=1;r(a.width,a.height,t.generateMipMaps,!1,function(){var f=t.getEngine();t.type=1,t.format=5,t._gammaSpace=!1,f._uploadDataToTextureDirectly(t,l)})},i}();De._TextureLoaders.push(new Tp);var Ep=function(){function i(){this.supportCascades=!1}return i.prototype.canLoad=function(e){return Ut(e,".basis")},i.prototype.loadCubeData=function(e,t,r,n,a){if(!Array.isArray(e)){var s=t.getEngine().getCaps(),o={supportedCompressionFormats:{etc1:!!s.etc1,s3tc:!!s.s3tc,pvrtc:!!s.pvrtc,etc2:!!s.etc2}};Hi(e,o).then(function(l){var u=l.fileInfo.images[0].levels.length>1&&t.generateMipMaps;Xi(t,l),t.getEngine()._setCubeMapTextureParams(t,u),t.isReady=!0,t.onLoadedObservable.notifyObservers(t),t.onLoadedObservable.clear(),n&&n()}).catch(function(l){var u="Failed to transcode Basis file, transcoding may not be supported on this device";te.Warn(u),t.isReady=!0,a&&a(l)})}},i.prototype.loadData=function(e,t,r){var n=t.getEngine().getCaps(),a={supportedCompressionFormats:{etc1:!!n.etc1,s3tc:!!n.s3tc,pvrtc:!!n.pvrtc,etc2:!!n.etc2}};Hi(e,a).then(function(s){var o=s.fileInfo.images[0].levels[0],l=s.fileInfo.images[0].levels.length>1&&t.generateMipMaps;r(o.width,o.height,l,s.format!==-1,function(){Xi(t,s)})}).catch(function(){te.Warn("Failed to transcode Basis file, transcoding may not be supported on this device"),r(0,0,!1,!1,function(){},!0)})},i}();De._TextureLoaders.push(new Ep);class Lp extends np{constructor(e,t){super(e,t);ft(this,"depthKit");ft(this,"envHelper")}init(){super.init(),this.envHelper=new vp({createSkybox:!0,skyboxColor:me.Black()},this.scene);const e="../assets/john/John.txt",t="../assets/john/John2.mp4";this.depthKit=new lu(this.scene,"example1"),this.depthKit.load(e,t).catch(r=>{console.error("Unable to initialize depth kit.",r)})}play(){var e;(e=this.depthKit)==null||e.play()}pause(){var e;(e=this.depthKit)==null||e.pause()}dispose(){var e;(e=this.depthKit)==null||e.dispose(),super.dispose()}}export{lt as $,mu as A,me as B,wr as C,ei as D,Lp as E,Ce as F,ln as G,is as H,at as I,Et as J,Bi as K,Y as L,G as M,ct as N,X as O,fe as P,de as Q,xp as R,Re as S,re as T,ks as U,m as V,wa as W,ri as X,Kt as Y,vt as Z,$ as _,te as a,lr as a$,ol as a0,We as a1,le as a2,ce as a3,Ke as a4,Ar as a5,q as a6,R as a7,He as a8,Bt as a9,sn as aA,Ip as aB,_n as aC,ba as aD,J as aE,ki as aF,zt as aG,Le as aH,ve as aI,hh as aJ,Oe as aK,wt as aL,Pa as aM,K as aN,Qe as aO,mi as aP,Tt as aQ,go as aR,Je as aS,dh as aT,ht as aU,Fp as aV,ud as aW,mr as aX,Cp as aY,ni as aZ,Cn as a_,St as aa,qr as ab,rd as ac,pe as ad,Jt as ae,an as af,ai as ag,oi as ah,qt as ai,Pp as aj,ut as ak,rt as al,Hn as am,As as an,Mp as ao,Rp as ap,fs as aq,wp as ar,$o as as,Op as at,Sp as au,nn as av,or as aw,sr as ax,gt as ay,ot as az,ur as b,zi as b0,Dp as b1,Lr as b2,zs as b3,ui as b4,wc as b5,he as b6,Zr as b7,nt as b8,Ie as c,qi as d,gr as e,C as f,Ga as g,Kn as h,_u as i,se as j,xt as k,pu as l,De as m,Va as n,U as o,Ne as p,Ue as q,ye as r,I as s,At as t,ze as u,On as v,O as w,Cr as x,es as y,$t as z};
